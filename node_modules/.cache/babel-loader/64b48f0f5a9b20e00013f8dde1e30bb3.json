{"remainingRequest":"/home/mengy/develop/iwork/kafo/vue-admin/node_modules/babel-loader/lib/index.js!/home/mengy/develop/iwork/kafo/vue-admin/src/proto/js/cms_pb.js","dependencies":[{"path":"/home/mengy/develop/iwork/kafo/vue-admin/src/proto/js/cms_pb.js","mtime":1631068384916},{"path":"/home/mengy/develop/iwork/kafo/vue-admin/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/home/mengy/develop/iwork/kafo/vue-admin/node_modules/babel-loader/lib/index.js","mtime":315532800000}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:Ly8gc291cmNlOiBjbXMucHJvdG8KCi8qKgogKiBAZmlsZW92ZXJ2aWV3CiAqIEBlbmhhbmNlYWJsZQogKiBAc3VwcHJlc3Mge21pc3NpbmdSZXF1aXJlfSByZXBvcnRzIGVycm9yIG9uIGltcGxpY2l0IHR5cGUgdXNhZ2VzLgogKiBAc3VwcHJlc3Mge21lc3NhZ2VDb252ZW50aW9uc30gSlMgQ29tcGlsZXIgcmVwb3J0cyBhbiBlcnJvciBpZiBhIHZhcmlhYmxlIG9yCiAqICAgICBmaWVsZCBzdGFydHMgd2l0aCAnTVNHXycgYW5kIGlzbid0IGEgdHJhbnNsYXRhYmxlIG1lc3NhZ2UuCiAqIEBwdWJsaWMKICovCi8vIEdFTkVSQVRFRCBDT0RFIC0tIERPIE5PVCBFRElUIQoKLyogZXNsaW50LWRpc2FibGUgKi8KLy8gQHRzLW5vY2hlY2sKdmFyIGpzcGIgPSByZXF1aXJlKCdnb29nbGUtcHJvdG9idWYnKTsKCnZhciBnb29nID0ganNwYjsKdmFyIGdsb2JhbCA9IEZ1bmN0aW9uKCdyZXR1cm4gdGhpcycpKCk7Cgp2YXIgdXNlcnR5cGVfcGIgPSByZXF1aXJlKCcuL3VzZXJ0eXBlX3BiLmpzJyk7Cgpnb29nLm9iamVjdC5leHRlbmQocHJvdG8sIHVzZXJ0eXBlX3BiKTsKCnZhciBhbmNob3J0eXBlX3BiID0gcmVxdWlyZSgnLi9hbmNob3J0eXBlX3BiLmpzJyk7Cgpnb29nLm9iamVjdC5leHRlbmQocHJvdG8sIGFuY2hvcnR5cGVfcGIpOwoKdmFyIGNtc3R5cGVfcGIgPSByZXF1aXJlKCcuL2Ntc3R5cGVfcGIuanMnKTsKCmdvb2cub2JqZWN0LmV4dGVuZChwcm90bywgY21zdHlwZV9wYik7Cmdvb2cuZXhwb3J0U3ltYm9sKCdwcm90by5wYi5jbXMuQWRqdXN0QmFsYW5jZVJlcGx5JywgbnVsbCwgZ2xvYmFsKTsKZ29vZy5leHBvcnRTeW1ib2woJ3Byb3RvLnBiLmNtcy5BZGp1c3RCYWxhbmNlUmVxdWVzdCcsIG51bGwsIGdsb2JhbCk7Cmdvb2cuZXhwb3J0U3ltYm9sKCdwcm90by5wYi5jbXMuQWRtaW5GaWxlQ2h1bmsnLCBudWxsLCBnbG9iYWwpOwpnb29nLmV4cG9ydFN5bWJvbCgncHJvdG8ucGIuY21zLkFkbWluTGlzdFJlcGx5JywgbnVsbCwgZ2xvYmFsKTsKZ29vZy5leHBvcnRTeW1ib2woJ3Byb3RvLnBiLmNtcy5BbmNob3JGdWxsUmVwbHknLCBudWxsLCBnbG9iYWwpOwpnb29nLmV4cG9ydFN5bWJvbCgncHJvdG8ucGIuY21zLkFuY2hvckZ1bGxSZXF1ZXN0JywgbnVsbCwgZ2xvYmFsKTsKZ29vZy5leHBvcnRTeW1ib2woJ3Byb3RvLnBiLmNtcy5BbmNob3JMaXN0UmVwbHknLCBudWxsLCBnbG9iYWwpOwpnb29nLmV4cG9ydFN5bWJvbCgncHJvdG8ucGIuY21zLkFuY2hvckxpc3RSZXF1ZXN0JywgbnVsbCwgZ2xvYmFsKTsKZ29vZy5leHBvcnRTeW1ib2woJ3Byb3RvLnBiLmNtcy5BcHBMaXN0UmVwbHknLCBudWxsLCBnbG9iYWwpOwpnb29nLmV4cG9ydFN5bWJvbCgncHJvdG8ucGIuY21zLkFyZWFMaXN0UmVwbHknLCBudWxsLCBnbG9iYWwpOwpnb29nLmV4cG9ydFN5bWJvbCgncHJvdG8ucGIuY21zLkF1dGhvcml6ZUFuY2hvclJlcXVlc3QnLCBudWxsLCBnbG9iYWwpOwpnb29nLmV4cG9ydFN5bWJvbCgncHJvdG8ucGIuY21zLkF1dG9NZXNzYWdlTGlzdFJlcGx5JywgbnVsbCwgZ2xvYmFsKTsKZ29vZy5leHBvcnRTeW1ib2woJ3Byb3RvLnBiLmNtcy5BdXRvTWVzc2FnZUxpc3RSZXF1ZXN0JywgbnVsbCwgZ2xvYmFsKTsKZ29vZy5leHBvcnRTeW1ib2woJ3Byb3RvLnBiLmNtcy5CbG9ja1JlcXVlc3QnLCBudWxsLCBnbG9iYWwpOwpnb29nLmV4cG9ydFN5bWJvbCgncHJvdG8ucGIuY21zLkNhbGxMaXN0UmVwbHknLCBudWxsLCBnbG9iYWwpOwpnb29nLmV4cG9ydFN5bWJvbCgncHJvdG8ucGIuY21zLkNhbGxMaXN0UmVxdWVzdCcsIG51bGwsIGdsb2JhbCk7Cmdvb2cuZXhwb3J0U3ltYm9sKCdwcm90by5wYi5jbXMuQ2hhdE1lc3NhZ2VMaXN0UmVwbHknLCBudWxsLCBnbG9iYWwpOwpnb29nLmV4cG9ydFN5bWJvbCgncHJvdG8ucGIuY21zLkNoYXRNZXNzYWdlTGlzdFJlcXVlc3QnLCBudWxsLCBnbG9iYWwpOwpnb29nLmV4cG9ydFN5bWJvbCgncHJvdG8ucGIuY21zLkd1aWxkTGlzdFJlcGx5JywgbnVsbCwgZ2xvYmFsKTsKZ29vZy5leHBvcnRTeW1ib2woJ3Byb3RvLnBiLmNtcy5MaXZlTGlzdFJlcGx5JywgbnVsbCwgZ2xvYmFsKTsKZ29vZy5leHBvcnRTeW1ib2woJ3Byb3RvLnBiLmNtcy5MaXZlTGlzdFJlcXVlc3QnLCBudWxsLCBnbG9iYWwpOwpnb29nLmV4cG9ydFN5bWJvbCgncHJvdG8ucGIuY21zLkxvZ2luUmVxdWVzdCcsIG51bGwsIGdsb2JhbCk7Cmdvb2cuZXhwb3J0U3ltYm9sKCdwcm90by5wYi5jbXMuTWlncmF0ZVJlcXVlc3QnLCBudWxsLCBnbG9iYWwpOwpnb29nLmV4cG9ydFN5bWJvbCgncHJvdG8ucGIuY21zLlBheUxpc3RSZXBseScsIG51bGwsIGdsb2JhbCk7Cmdvb2cuZXhwb3J0U3ltYm9sKCdwcm90by5wYi5jbXMuUGF5TGlzdFJlcXVlc3QnLCBudWxsLCBnbG9iYWwpOwpnb29nLmV4cG9ydFN5bWJvbCgncHJvdG8ucGIuY21zLlByb2Nlc3NQcm9maWxlUmVxdWVzdCcsIG51bGwsIGdsb2JhbCk7Cmdvb2cuZXhwb3J0U3ltYm9sKCdwcm90by5wYi5jbXMuUHJvY2Vzc1Zpb2xhdGlvblJlcXVlc3QnLCBudWxsLCBnbG9iYWwpOwpnb29nLmV4cG9ydFN5bWJvbCgncHJvdG8ucGIuY21zLlByb2ZpbGVMaXN0UmVwbHknLCBudWxsLCBnbG9iYWwpOwpnb29nLmV4cG9ydFN5bWJvbCgncHJvdG8ucGIuY21zLlByb2ZpbGVMaXN0UmVxdWVzdCcsIG51bGwsIGdsb2JhbCk7Cmdvb2cuZXhwb3J0U3ltYm9sKCdwcm90by5wYi5jbXMuUm9ib3RMaXN0UmVwbHknLCBudWxsLCBnbG9iYWwpOwpnb29nLmV4cG9ydFN5bWJvbCgncHJvdG8ucGIuY21zLlJvYm90TGlzdFJlcXVlc3QnLCBudWxsLCBnbG9iYWwpOwpnb29nLmV4cG9ydFN5bWJvbCgncHJvdG8ucGIuY21zLlJvYm90TWVzc2FnZUxpc3RSZXBseScsIG51bGwsIGdsb2JhbCk7Cmdvb2cuZXhwb3J0U3ltYm9sKCdwcm90by5wYi5jbXMuUm9ib3RNZXNzYWdlTGlzdFJlcXVlc3QnLCBudWxsLCBnbG9iYWwpOwpnb29nLmV4cG9ydFN5bWJvbCgncHJvdG8ucGIuY21zLlRyYW5zYWN0aW9uTGlzdFJlcGx5JywgbnVsbCwgZ2xvYmFsKTsKZ29vZy5leHBvcnRTeW1ib2woJ3Byb3RvLnBiLmNtcy5UcmFuc2FjdGlvbkxpc3RSZXF1ZXN0JywgbnVsbCwgZ2xvYmFsKTsKZ29vZy5leHBvcnRTeW1ib2woJ3Byb3RvLnBiLmNtcy5VbmJsb2NrUmVxdWVzdCcsIG51bGwsIGdsb2JhbCk7Cmdvb2cuZXhwb3J0U3ltYm9sKCdwcm90by5wYi5jbXMuVXNlckxpc3RSZXBseScsIG51bGwsIGdsb2JhbCk7Cmdvb2cuZXhwb3J0U3ltYm9sKCdwcm90by5wYi5jbXMuVXNlckxpc3RSZXF1ZXN0JywgbnVsbCwgZ2xvYmFsKTsKZ29vZy5leHBvcnRTeW1ib2woJ3Byb3RvLnBiLmNtcy5WaW9sYXRpb25MaXN0UmVwbHknLCBudWxsLCBnbG9iYWwpOwpnb29nLmV4cG9ydFN5bWJvbCgncHJvdG8ucGIuY21zLlZpb2xhdGlvbkxpc3RSZXF1ZXN0JywgbnVsbCwgZ2xvYmFsKTsKLyoqCiAqIEdlbmVyYXRlZCBieSBKc1BiQ29kZUdlbmVyYXRvci4KICogQHBhcmFtIHtBcnJheT19IG9wdF9kYXRhIE9wdGlvbmFsIGluaXRpYWwgZGF0YSBhcnJheSwgdHlwaWNhbGx5IGZyb20gYQogKiBzZXJ2ZXIgcmVzcG9uc2UsIG9yIGNvbnN0cnVjdGVkIGRpcmVjdGx5IGluIEphdmFzY3JpcHQuIFRoZSBhcnJheSBpcyB1c2VkCiAqIGluIHBsYWNlIGFuZCBiZWNvbWVzIHBhcnQgb2YgdGhlIGNvbnN0cnVjdGVkIG9iamVjdC4gSXQgaXMgbm90IGNsb25lZC4KICogSWYgbm8gZGF0YSBpcyBwcm92aWRlZCwgdGhlIGNvbnN0cnVjdGVkIG9iamVjdCB3aWxsIGJlIGVtcHR5LCBidXQgc3RpbGwKICogdmFsaWQuCiAqIEBleHRlbmRzIHtqc3BiLk1lc3NhZ2V9CiAqIEBjb25zdHJ1Y3RvcgogKi8KCnByb3RvLnBiLmNtcy5BcmVhTGlzdFJlcGx5ID0gZnVuY3Rpb24gKG9wdF9kYXRhKSB7CiAganNwYi5NZXNzYWdlLmluaXRpYWxpemUodGhpcywgb3B0X2RhdGEsIDAsIC0xLCBwcm90by5wYi5jbXMuQXJlYUxpc3RSZXBseS5yZXBlYXRlZEZpZWxkc18sIG51bGwpOwp9OwoKZ29vZy5pbmhlcml0cyhwcm90by5wYi5jbXMuQXJlYUxpc3RSZXBseSwganNwYi5NZXNzYWdlKTsKCmlmIChnb29nLkRFQlVHICYmICFDT01QSUxFRCkgewogIC8qKgogICAqIEBwdWJsaWMKICAgKiBAb3ZlcnJpZGUKICAgKi8KICBwcm90by5wYi5jbXMuQXJlYUxpc3RSZXBseS5kaXNwbGF5TmFtZSA9ICdwcm90by5wYi5jbXMuQXJlYUxpc3RSZXBseSc7Cn0KLyoqCiAqIEdlbmVyYXRlZCBieSBKc1BiQ29kZUdlbmVyYXRvci4KICogQHBhcmFtIHtBcnJheT19IG9wdF9kYXRhIE9wdGlvbmFsIGluaXRpYWwgZGF0YSBhcnJheSwgdHlwaWNhbGx5IGZyb20gYQogKiBzZXJ2ZXIgcmVzcG9uc2UsIG9yIGNvbnN0cnVjdGVkIGRpcmVjdGx5IGluIEphdmFzY3JpcHQuIFRoZSBhcnJheSBpcyB1c2VkCiAqIGluIHBsYWNlIGFuZCBiZWNvbWVzIHBhcnQgb2YgdGhlIGNvbnN0cnVjdGVkIG9iamVjdC4gSXQgaXMgbm90IGNsb25lZC4KICogSWYgbm8gZGF0YSBpcyBwcm92aWRlZCwgdGhlIGNvbnN0cnVjdGVkIG9iamVjdCB3aWxsIGJlIGVtcHR5LCBidXQgc3RpbGwKICogdmFsaWQuCiAqIEBleHRlbmRzIHtqc3BiLk1lc3NhZ2V9CiAqIEBjb25zdHJ1Y3RvcgogKi8KCgpwcm90by5wYi5jbXMuTG9naW5SZXF1ZXN0ID0gZnVuY3Rpb24gKG9wdF9kYXRhKSB7CiAganNwYi5NZXNzYWdlLmluaXRpYWxpemUodGhpcywgb3B0X2RhdGEsIDAsIC0xLCBudWxsLCBudWxsKTsKfTsKCmdvb2cuaW5oZXJpdHMocHJvdG8ucGIuY21zLkxvZ2luUmVxdWVzdCwganNwYi5NZXNzYWdlKTsKCmlmIChnb29nLkRFQlVHICYmICFDT01QSUxFRCkgewogIC8qKgogICAqIEBwdWJsaWMKICAgKiBAb3ZlcnJpZGUKICAgKi8KICBwcm90by5wYi5jbXMuTG9naW5SZXF1ZXN0LmRpc3BsYXlOYW1lID0gJ3Byb3RvLnBiLmNtcy5Mb2dpblJlcXVlc3QnOwp9Ci8qKgogKiBHZW5lcmF0ZWQgYnkgSnNQYkNvZGVHZW5lcmF0b3IuCiAqIEBwYXJhbSB7QXJyYXk9fSBvcHRfZGF0YSBPcHRpb25hbCBpbml0aWFsIGRhdGEgYXJyYXksIHR5cGljYWxseSBmcm9tIGEKICogc2VydmVyIHJlc3BvbnNlLCBvciBjb25zdHJ1Y3RlZCBkaXJlY3RseSBpbiBKYXZhc2NyaXB0LiBUaGUgYXJyYXkgaXMgdXNlZAogKiBpbiBwbGFjZSBhbmQgYmVjb21lcyBwYXJ0IG9mIHRoZSBjb25zdHJ1Y3RlZCBvYmplY3QuIEl0IGlzIG5vdCBjbG9uZWQuCiAqIElmIG5vIGRhdGEgaXMgcHJvdmlkZWQsIHRoZSBjb25zdHJ1Y3RlZCBvYmplY3Qgd2lsbCBiZSBlbXB0eSwgYnV0IHN0aWxsCiAqIHZhbGlkLgogKiBAZXh0ZW5kcyB7anNwYi5NZXNzYWdlfQogKiBAY29uc3RydWN0b3IKICovCgoKcHJvdG8ucGIuY21zLkFkbWluTGlzdFJlcGx5ID0gZnVuY3Rpb24gKG9wdF9kYXRhKSB7CiAganNwYi5NZXNzYWdlLmluaXRpYWxpemUodGhpcywgb3B0X2RhdGEsIDAsIC0xLCBwcm90by5wYi5jbXMuQWRtaW5MaXN0UmVwbHkucmVwZWF0ZWRGaWVsZHNfLCBudWxsKTsKfTsKCmdvb2cuaW5oZXJpdHMocHJvdG8ucGIuY21zLkFkbWluTGlzdFJlcGx5LCBqc3BiLk1lc3NhZ2UpOwoKaWYgKGdvb2cuREVCVUcgJiYgIUNPTVBJTEVEKSB7CiAgLyoqCiAgICogQHB1YmxpYwogICAqIEBvdmVycmlkZQogICAqLwogIHByb3RvLnBiLmNtcy5BZG1pbkxpc3RSZXBseS5kaXNwbGF5TmFtZSA9ICdwcm90by5wYi5jbXMuQWRtaW5MaXN0UmVwbHknOwp9Ci8qKgogKiBHZW5lcmF0ZWQgYnkgSnNQYkNvZGVHZW5lcmF0b3IuCiAqIEBwYXJhbSB7QXJyYXk9fSBvcHRfZGF0YSBPcHRpb25hbCBpbml0aWFsIGRhdGEgYXJyYXksIHR5cGljYWxseSBmcm9tIGEKICogc2VydmVyIHJlc3BvbnNlLCBvciBjb25zdHJ1Y3RlZCBkaXJlY3RseSBpbiBKYXZhc2NyaXB0LiBUaGUgYXJyYXkgaXMgdXNlZAogKiBpbiBwbGFjZSBhbmQgYmVjb21lcyBwYXJ0IG9mIHRoZSBjb25zdHJ1Y3RlZCBvYmplY3QuIEl0IGlzIG5vdCBjbG9uZWQuCiAqIElmIG5vIGRhdGEgaXMgcHJvdmlkZWQsIHRoZSBjb25zdHJ1Y3RlZCBvYmplY3Qgd2lsbCBiZSBlbXB0eSwgYnV0IHN0aWxsCiAqIHZhbGlkLgogKiBAZXh0ZW5kcyB7anNwYi5NZXNzYWdlfQogKiBAY29uc3RydWN0b3IKICovCgoKcHJvdG8ucGIuY21zLkd1aWxkTGlzdFJlcGx5ID0gZnVuY3Rpb24gKG9wdF9kYXRhKSB7CiAganNwYi5NZXNzYWdlLmluaXRpYWxpemUodGhpcywgb3B0X2RhdGEsIDAsIC0xLCBwcm90by5wYi5jbXMuR3VpbGRMaXN0UmVwbHkucmVwZWF0ZWRGaWVsZHNfLCBudWxsKTsKfTsKCmdvb2cuaW5oZXJpdHMocHJvdG8ucGIuY21zLkd1aWxkTGlzdFJlcGx5LCBqc3BiLk1lc3NhZ2UpOwoKaWYgKGdvb2cuREVCVUcgJiYgIUNPTVBJTEVEKSB7CiAgLyoqCiAgICogQHB1YmxpYwogICAqIEBvdmVycmlkZQogICAqLwogIHByb3RvLnBiLmNtcy5HdWlsZExpc3RSZXBseS5kaXNwbGF5TmFtZSA9ICdwcm90by5wYi5jbXMuR3VpbGRMaXN0UmVwbHknOwp9Ci8qKgogKiBHZW5lcmF0ZWQgYnkgSnNQYkNvZGVHZW5lcmF0b3IuCiAqIEBwYXJhbSB7QXJyYXk9fSBvcHRfZGF0YSBPcHRpb25hbCBpbml0aWFsIGRhdGEgYXJyYXksIHR5cGljYWxseSBmcm9tIGEKICogc2VydmVyIHJlc3BvbnNlLCBvciBjb25zdHJ1Y3RlZCBkaXJlY3RseSBpbiBKYXZhc2NyaXB0LiBUaGUgYXJyYXkgaXMgdXNlZAogKiBpbiBwbGFjZSBhbmQgYmVjb21lcyBwYXJ0IG9mIHRoZSBjb25zdHJ1Y3RlZCBvYmplY3QuIEl0IGlzIG5vdCBjbG9uZWQuCiAqIElmIG5vIGRhdGEgaXMgcHJvdmlkZWQsIHRoZSBjb25zdHJ1Y3RlZCBvYmplY3Qgd2lsbCBiZSBlbXB0eSwgYnV0IHN0aWxsCiAqIHZhbGlkLgogKiBAZXh0ZW5kcyB7anNwYi5NZXNzYWdlfQogKiBAY29uc3RydWN0b3IKICovCgoKcHJvdG8ucGIuY21zLkFwcExpc3RSZXBseSA9IGZ1bmN0aW9uIChvcHRfZGF0YSkgewogIGpzcGIuTWVzc2FnZS5pbml0aWFsaXplKHRoaXMsIG9wdF9kYXRhLCAwLCAtMSwgcHJvdG8ucGIuY21zLkFwcExpc3RSZXBseS5yZXBlYXRlZEZpZWxkc18sIG51bGwpOwp9OwoKZ29vZy5pbmhlcml0cyhwcm90by5wYi5jbXMuQXBwTGlzdFJlcGx5LCBqc3BiLk1lc3NhZ2UpOwoKaWYgKGdvb2cuREVCVUcgJiYgIUNPTVBJTEVEKSB7CiAgLyoqCiAgICogQHB1YmxpYwogICAqIEBvdmVycmlkZQogICAqLwogIHByb3RvLnBiLmNtcy5BcHBMaXN0UmVwbHkuZGlzcGxheU5hbWUgPSAncHJvdG8ucGIuY21zLkFwcExpc3RSZXBseSc7Cn0KLyoqCiAqIEdlbmVyYXRlZCBieSBKc1BiQ29kZUdlbmVyYXRvci4KICogQHBhcmFtIHtBcnJheT19IG9wdF9kYXRhIE9wdGlvbmFsIGluaXRpYWwgZGF0YSBhcnJheSwgdHlwaWNhbGx5IGZyb20gYQogKiBzZXJ2ZXIgcmVzcG9uc2UsIG9yIGNvbnN0cnVjdGVkIGRpcmVjdGx5IGluIEphdmFzY3JpcHQuIFRoZSBhcnJheSBpcyB1c2VkCiAqIGluIHBsYWNlIGFuZCBiZWNvbWVzIHBhcnQgb2YgdGhlIGNvbnN0cnVjdGVkIG9iamVjdC4gSXQgaXMgbm90IGNsb25lZC4KICogSWYgbm8gZGF0YSBpcyBwcm92aWRlZCwgdGhlIGNvbnN0cnVjdGVkIG9iamVjdCB3aWxsIGJlIGVtcHR5LCBidXQgc3RpbGwKICogdmFsaWQuCiAqIEBleHRlbmRzIHtqc3BiLk1lc3NhZ2V9CiAqIEBjb25zdHJ1Y3RvcgogKi8KCgpwcm90by5wYi5jbXMuQW5jaG9yTGlzdFJlcXVlc3QgPSBmdW5jdGlvbiAob3B0X2RhdGEpIHsKICBqc3BiLk1lc3NhZ2UuaW5pdGlhbGl6ZSh0aGlzLCBvcHRfZGF0YSwgMCwgLTEsIG51bGwsIG51bGwpOwp9OwoKZ29vZy5pbmhlcml0cyhwcm90by5wYi5jbXMuQW5jaG9yTGlzdFJlcXVlc3QsIGpzcGIuTWVzc2FnZSk7CgppZiAoZ29vZy5ERUJVRyAmJiAhQ09NUElMRUQpIHsKICAvKioKICAgKiBAcHVibGljCiAgICogQG92ZXJyaWRlCiAgICovCiAgcHJvdG8ucGIuY21zLkFuY2hvckxpc3RSZXF1ZXN0LmRpc3BsYXlOYW1lID0gJ3Byb3RvLnBiLmNtcy5BbmNob3JMaXN0UmVxdWVzdCc7Cn0KLyoqCiAqIEdlbmVyYXRlZCBieSBKc1BiQ29kZUdlbmVyYXRvci4KICogQHBhcmFtIHtBcnJheT19IG9wdF9kYXRhIE9wdGlvbmFsIGluaXRpYWwgZGF0YSBhcnJheSwgdHlwaWNhbGx5IGZyb20gYQogKiBzZXJ2ZXIgcmVzcG9uc2UsIG9yIGNvbnN0cnVjdGVkIGRpcmVjdGx5IGluIEphdmFzY3JpcHQuIFRoZSBhcnJheSBpcyB1c2VkCiAqIGluIHBsYWNlIGFuZCBiZWNvbWVzIHBhcnQgb2YgdGhlIGNvbnN0cnVjdGVkIG9iamVjdC4gSXQgaXMgbm90IGNsb25lZC4KICogSWYgbm8gZGF0YSBpcyBwcm92aWRlZCwgdGhlIGNvbnN0cnVjdGVkIG9iamVjdCB3aWxsIGJlIGVtcHR5LCBidXQgc3RpbGwKICogdmFsaWQuCiAqIEBleHRlbmRzIHtqc3BiLk1lc3NhZ2V9CiAqIEBjb25zdHJ1Y3RvcgogKi8KCgpwcm90by5wYi5jbXMuQW5jaG9yTGlzdFJlcGx5ID0gZnVuY3Rpb24gKG9wdF9kYXRhKSB7CiAganNwYi5NZXNzYWdlLmluaXRpYWxpemUodGhpcywgb3B0X2RhdGEsIDAsIC0xLCBwcm90by5wYi5jbXMuQW5jaG9yTGlzdFJlcGx5LnJlcGVhdGVkRmllbGRzXywgbnVsbCk7Cn07Cgpnb29nLmluaGVyaXRzKHByb3RvLnBiLmNtcy5BbmNob3JMaXN0UmVwbHksIGpzcGIuTWVzc2FnZSk7CgppZiAoZ29vZy5ERUJVRyAmJiAhQ09NUElMRUQpIHsKICAvKioKICAgKiBAcHVibGljCiAgICogQG92ZXJyaWRlCiAgICovCiAgcHJvdG8ucGIuY21zLkFuY2hvckxpc3RSZXBseS5kaXNwbGF5TmFtZSA9ICdwcm90by5wYi5jbXMuQW5jaG9yTGlzdFJlcGx5JzsKfQovKioKICogR2VuZXJhdGVkIGJ5IEpzUGJDb2RlR2VuZXJhdG9yLgogKiBAcGFyYW0ge0FycmF5PX0gb3B0X2RhdGEgT3B0aW9uYWwgaW5pdGlhbCBkYXRhIGFycmF5LCB0eXBpY2FsbHkgZnJvbSBhCiAqIHNlcnZlciByZXNwb25zZSwgb3IgY29uc3RydWN0ZWQgZGlyZWN0bHkgaW4gSmF2YXNjcmlwdC4gVGhlIGFycmF5IGlzIHVzZWQKICogaW4gcGxhY2UgYW5kIGJlY29tZXMgcGFydCBvZiB0aGUgY29uc3RydWN0ZWQgb2JqZWN0LiBJdCBpcyBub3QgY2xvbmVkLgogKiBJZiBubyBkYXRhIGlzIHByb3ZpZGVkLCB0aGUgY29uc3RydWN0ZWQgb2JqZWN0IHdpbGwgYmUgZW1wdHksIGJ1dCBzdGlsbAogKiB2YWxpZC4KICogQGV4dGVuZHMge2pzcGIuTWVzc2FnZX0KICogQGNvbnN0cnVjdG9yCiAqLwoKCnByb3RvLnBiLmNtcy5Vc2VyTGlzdFJlcXVlc3QgPSBmdW5jdGlvbiAob3B0X2RhdGEpIHsKICBqc3BiLk1lc3NhZ2UuaW5pdGlhbGl6ZSh0aGlzLCBvcHRfZGF0YSwgMCwgLTEsIG51bGwsIG51bGwpOwp9OwoKZ29vZy5pbmhlcml0cyhwcm90by5wYi5jbXMuVXNlckxpc3RSZXF1ZXN0LCBqc3BiLk1lc3NhZ2UpOwoKaWYgKGdvb2cuREVCVUcgJiYgIUNPTVBJTEVEKSB7CiAgLyoqCiAgICogQHB1YmxpYwogICAqIEBvdmVycmlkZQogICAqLwogIHByb3RvLnBiLmNtcy5Vc2VyTGlzdFJlcXVlc3QuZGlzcGxheU5hbWUgPSAncHJvdG8ucGIuY21zLlVzZXJMaXN0UmVxdWVzdCc7Cn0KLyoqCiAqIEdlbmVyYXRlZCBieSBKc1BiQ29kZUdlbmVyYXRvci4KICogQHBhcmFtIHtBcnJheT19IG9wdF9kYXRhIE9wdGlvbmFsIGluaXRpYWwgZGF0YSBhcnJheSwgdHlwaWNhbGx5IGZyb20gYQogKiBzZXJ2ZXIgcmVzcG9uc2UsIG9yIGNvbnN0cnVjdGVkIGRpcmVjdGx5IGluIEphdmFzY3JpcHQuIFRoZSBhcnJheSBpcyB1c2VkCiAqIGluIHBsYWNlIGFuZCBiZWNvbWVzIHBhcnQgb2YgdGhlIGNvbnN0cnVjdGVkIG9iamVjdC4gSXQgaXMgbm90IGNsb25lZC4KICogSWYgbm8gZGF0YSBpcyBwcm92aWRlZCwgdGhlIGNvbnN0cnVjdGVkIG9iamVjdCB3aWxsIGJlIGVtcHR5LCBidXQgc3RpbGwKICogdmFsaWQuCiAqIEBleHRlbmRzIHtqc3BiLk1lc3NhZ2V9CiAqIEBjb25zdHJ1Y3RvcgogKi8KCgpwcm90by5wYi5jbXMuVXNlckxpc3RSZXBseSA9IGZ1bmN0aW9uIChvcHRfZGF0YSkgewogIGpzcGIuTWVzc2FnZS5pbml0aWFsaXplKHRoaXMsIG9wdF9kYXRhLCAwLCAtMSwgcHJvdG8ucGIuY21zLlVzZXJMaXN0UmVwbHkucmVwZWF0ZWRGaWVsZHNfLCBudWxsKTsKfTsKCmdvb2cuaW5oZXJpdHMocHJvdG8ucGIuY21zLlVzZXJMaXN0UmVwbHksIGpzcGIuTWVzc2FnZSk7CgppZiAoZ29vZy5ERUJVRyAmJiAhQ09NUElMRUQpIHsKICAvKioKICAgKiBAcHVibGljCiAgICogQG92ZXJyaWRlCiAgICovCiAgcHJvdG8ucGIuY21zLlVzZXJMaXN0UmVwbHkuZGlzcGxheU5hbWUgPSAncHJvdG8ucGIuY21zLlVzZXJMaXN0UmVwbHknOwp9Ci8qKgogKiBHZW5lcmF0ZWQgYnkgSnNQYkNvZGVHZW5lcmF0b3IuCiAqIEBwYXJhbSB7QXJyYXk9fSBvcHRfZGF0YSBPcHRpb25hbCBpbml0aWFsIGRhdGEgYXJyYXksIHR5cGljYWxseSBmcm9tIGEKICogc2VydmVyIHJlc3BvbnNlLCBvciBjb25zdHJ1Y3RlZCBkaXJlY3RseSBpbiBKYXZhc2NyaXB0LiBUaGUgYXJyYXkgaXMgdXNlZAogKiBpbiBwbGFjZSBhbmQgYmVjb21lcyBwYXJ0IG9mIHRoZSBjb25zdHJ1Y3RlZCBvYmplY3QuIEl0IGlzIG5vdCBjbG9uZWQuCiAqIElmIG5vIGRhdGEgaXMgcHJvdmlkZWQsIHRoZSBjb25zdHJ1Y3RlZCBvYmplY3Qgd2lsbCBiZSBlbXB0eSwgYnV0IHN0aWxsCiAqIHZhbGlkLgogKiBAZXh0ZW5kcyB7anNwYi5NZXNzYWdlfQogKiBAY29uc3RydWN0b3IKICovCgoKcHJvdG8ucGIuY21zLkFkanVzdEJhbGFuY2VSZXF1ZXN0ID0gZnVuY3Rpb24gKG9wdF9kYXRhKSB7CiAganNwYi5NZXNzYWdlLmluaXRpYWxpemUodGhpcywgb3B0X2RhdGEsIDAsIC0xLCBudWxsLCBudWxsKTsKfTsKCmdvb2cuaW5oZXJpdHMocHJvdG8ucGIuY21zLkFkanVzdEJhbGFuY2VSZXF1ZXN0LCBqc3BiLk1lc3NhZ2UpOwoKaWYgKGdvb2cuREVCVUcgJiYgIUNPTVBJTEVEKSB7CiAgLyoqCiAgICogQHB1YmxpYwogICAqIEBvdmVycmlkZQogICAqLwogIHByb3RvLnBiLmNtcy5BZGp1c3RCYWxhbmNlUmVxdWVzdC5kaXNwbGF5TmFtZSA9ICdwcm90by5wYi5jbXMuQWRqdXN0QmFsYW5jZVJlcXVlc3QnOwp9Ci8qKgogKiBHZW5lcmF0ZWQgYnkgSnNQYkNvZGVHZW5lcmF0b3IuCiAqIEBwYXJhbSB7QXJyYXk9fSBvcHRfZGF0YSBPcHRpb25hbCBpbml0aWFsIGRhdGEgYXJyYXksIHR5cGljYWxseSBmcm9tIGEKICogc2VydmVyIHJlc3BvbnNlLCBvciBjb25zdHJ1Y3RlZCBkaXJlY3RseSBpbiBKYXZhc2NyaXB0LiBUaGUgYXJyYXkgaXMgdXNlZAogKiBpbiBwbGFjZSBhbmQgYmVjb21lcyBwYXJ0IG9mIHRoZSBjb25zdHJ1Y3RlZCBvYmplY3QuIEl0IGlzIG5vdCBjbG9uZWQuCiAqIElmIG5vIGRhdGEgaXMgcHJvdmlkZWQsIHRoZSBjb25zdHJ1Y3RlZCBvYmplY3Qgd2lsbCBiZSBlbXB0eSwgYnV0IHN0aWxsCiAqIHZhbGlkLgogKiBAZXh0ZW5kcyB7anNwYi5NZXNzYWdlfQogKiBAY29uc3RydWN0b3IKICovCgoKcHJvdG8ucGIuY21zLkFkanVzdEJhbGFuY2VSZXBseSA9IGZ1bmN0aW9uIChvcHRfZGF0YSkgewogIGpzcGIuTWVzc2FnZS5pbml0aWFsaXplKHRoaXMsIG9wdF9kYXRhLCAwLCAtMSwgbnVsbCwgbnVsbCk7Cn07Cgpnb29nLmluaGVyaXRzKHByb3RvLnBiLmNtcy5BZGp1c3RCYWxhbmNlUmVwbHksIGpzcGIuTWVzc2FnZSk7CgppZiAoZ29vZy5ERUJVRyAmJiAhQ09NUElMRUQpIHsKICAvKioKICAgKiBAcHVibGljCiAgICogQG92ZXJyaWRlCiAgICovCiAgcHJvdG8ucGIuY21zLkFkanVzdEJhbGFuY2VSZXBseS5kaXNwbGF5TmFtZSA9ICdwcm90by5wYi5jbXMuQWRqdXN0QmFsYW5jZVJlcGx5JzsKfQovKioKICogR2VuZXJhdGVkIGJ5IEpzUGJDb2RlR2VuZXJhdG9yLgogKiBAcGFyYW0ge0FycmF5PX0gb3B0X2RhdGEgT3B0aW9uYWwgaW5pdGlhbCBkYXRhIGFycmF5LCB0eXBpY2FsbHkgZnJvbSBhCiAqIHNlcnZlciByZXNwb25zZSwgb3IgY29uc3RydWN0ZWQgZGlyZWN0bHkgaW4gSmF2YXNjcmlwdC4gVGhlIGFycmF5IGlzIHVzZWQKICogaW4gcGxhY2UgYW5kIGJlY29tZXMgcGFydCBvZiB0aGUgY29uc3RydWN0ZWQgb2JqZWN0LiBJdCBpcyBub3QgY2xvbmVkLgogKiBJZiBubyBkYXRhIGlzIHByb3ZpZGVkLCB0aGUgY29uc3RydWN0ZWQgb2JqZWN0IHdpbGwgYmUgZW1wdHksIGJ1dCBzdGlsbAogKiB2YWxpZC4KICogQGV4dGVuZHMge2pzcGIuTWVzc2FnZX0KICogQGNvbnN0cnVjdG9yCiAqLwoKCnByb3RvLnBiLmNtcy5CbG9ja1JlcXVlc3QgPSBmdW5jdGlvbiAob3B0X2RhdGEpIHsKICBqc3BiLk1lc3NhZ2UuaW5pdGlhbGl6ZSh0aGlzLCBvcHRfZGF0YSwgMCwgLTEsIG51bGwsIG51bGwpOwp9OwoKZ29vZy5pbmhlcml0cyhwcm90by5wYi5jbXMuQmxvY2tSZXF1ZXN0LCBqc3BiLk1lc3NhZ2UpOwoKaWYgKGdvb2cuREVCVUcgJiYgIUNPTVBJTEVEKSB7CiAgLyoqCiAgICogQHB1YmxpYwogICAqIEBvdmVycmlkZQogICAqLwogIHByb3RvLnBiLmNtcy5CbG9ja1JlcXVlc3QuZGlzcGxheU5hbWUgPSAncHJvdG8ucGIuY21zLkJsb2NrUmVxdWVzdCc7Cn0KLyoqCiAqIEdlbmVyYXRlZCBieSBKc1BiQ29kZUdlbmVyYXRvci4KICogQHBhcmFtIHtBcnJheT19IG9wdF9kYXRhIE9wdGlvbmFsIGluaXRpYWwgZGF0YSBhcnJheSwgdHlwaWNhbGx5IGZyb20gYQogKiBzZXJ2ZXIgcmVzcG9uc2UsIG9yIGNvbnN0cnVjdGVkIGRpcmVjdGx5IGluIEphdmFzY3JpcHQuIFRoZSBhcnJheSBpcyB1c2VkCiAqIGluIHBsYWNlIGFuZCBiZWNvbWVzIHBhcnQgb2YgdGhlIGNvbnN0cnVjdGVkIG9iamVjdC4gSXQgaXMgbm90IGNsb25lZC4KICogSWYgbm8gZGF0YSBpcyBwcm92aWRlZCwgdGhlIGNvbnN0cnVjdGVkIG9iamVjdCB3aWxsIGJlIGVtcHR5LCBidXQgc3RpbGwKICogdmFsaWQuCiAqIEBleHRlbmRzIHtqc3BiLk1lc3NhZ2V9CiAqIEBjb25zdHJ1Y3RvcgogKi8KCgpwcm90by5wYi5jbXMuVW5ibG9ja1JlcXVlc3QgPSBmdW5jdGlvbiAob3B0X2RhdGEpIHsKICBqc3BiLk1lc3NhZ2UuaW5pdGlhbGl6ZSh0aGlzLCBvcHRfZGF0YSwgMCwgLTEsIG51bGwsIG51bGwpOwp9OwoKZ29vZy5pbmhlcml0cyhwcm90by5wYi5jbXMuVW5ibG9ja1JlcXVlc3QsIGpzcGIuTWVzc2FnZSk7CgppZiAoZ29vZy5ERUJVRyAmJiAhQ09NUElMRUQpIHsKICAvKioKICAgKiBAcHVibGljCiAgICogQG92ZXJyaWRlCiAgICovCiAgcHJvdG8ucGIuY21zLlVuYmxvY2tSZXF1ZXN0LmRpc3BsYXlOYW1lID0gJ3Byb3RvLnBiLmNtcy5VbmJsb2NrUmVxdWVzdCc7Cn0KLyoqCiAqIEdlbmVyYXRlZCBieSBKc1BiQ29kZUdlbmVyYXRvci4KICogQHBhcmFtIHtBcnJheT19IG9wdF9kYXRhIE9wdGlvbmFsIGluaXRpYWwgZGF0YSBhcnJheSwgdHlwaWNhbGx5IGZyb20gYQogKiBzZXJ2ZXIgcmVzcG9uc2UsIG9yIGNvbnN0cnVjdGVkIGRpcmVjdGx5IGluIEphdmFzY3JpcHQuIFRoZSBhcnJheSBpcyB1c2VkCiAqIGluIHBsYWNlIGFuZCBiZWNvbWVzIHBhcnQgb2YgdGhlIGNvbnN0cnVjdGVkIG9iamVjdC4gSXQgaXMgbm90IGNsb25lZC4KICogSWYgbm8gZGF0YSBpcyBwcm92aWRlZCwgdGhlIGNvbnN0cnVjdGVkIG9iamVjdCB3aWxsIGJlIGVtcHR5LCBidXQgc3RpbGwKICogdmFsaWQuCiAqIEBleHRlbmRzIHtqc3BiLk1lc3NhZ2V9CiAqIEBjb25zdHJ1Y3RvcgogKi8KCgpwcm90by5wYi5jbXMuTWlncmF0ZVJlcXVlc3QgPSBmdW5jdGlvbiAob3B0X2RhdGEpIHsKICBqc3BiLk1lc3NhZ2UuaW5pdGlhbGl6ZSh0aGlzLCBvcHRfZGF0YSwgMCwgLTEsIG51bGwsIG51bGwpOwp9OwoKZ29vZy5pbmhlcml0cyhwcm90by5wYi5jbXMuTWlncmF0ZVJlcXVlc3QsIGpzcGIuTWVzc2FnZSk7CgppZiAoZ29vZy5ERUJVRyAmJiAhQ09NUElMRUQpIHsKICAvKioKICAgKiBAcHVibGljCiAgICogQG92ZXJyaWRlCiAgICovCiAgcHJvdG8ucGIuY21zLk1pZ3JhdGVSZXF1ZXN0LmRpc3BsYXlOYW1lID0gJ3Byb3RvLnBiLmNtcy5NaWdyYXRlUmVxdWVzdCc7Cn0KLyoqCiAqIEdlbmVyYXRlZCBieSBKc1BiQ29kZUdlbmVyYXRvci4KICogQHBhcmFtIHtBcnJheT19IG9wdF9kYXRhIE9wdGlvbmFsIGluaXRpYWwgZGF0YSBhcnJheSwgdHlwaWNhbGx5IGZyb20gYQogKiBzZXJ2ZXIgcmVzcG9uc2UsIG9yIGNvbnN0cnVjdGVkIGRpcmVjdGx5IGluIEphdmFzY3JpcHQuIFRoZSBhcnJheSBpcyB1c2VkCiAqIGluIHBsYWNlIGFuZCBiZWNvbWVzIHBhcnQgb2YgdGhlIGNvbnN0cnVjdGVkIG9iamVjdC4gSXQgaXMgbm90IGNsb25lZC4KICogSWYgbm8gZGF0YSBpcyBwcm92aWRlZCwgdGhlIGNvbnN0cnVjdGVkIG9iamVjdCB3aWxsIGJlIGVtcHR5LCBidXQgc3RpbGwKICogdmFsaWQuCiAqIEBleHRlbmRzIHtqc3BiLk1lc3NhZ2V9CiAqIEBjb25zdHJ1Y3RvcgogKi8KCgpwcm90by5wYi5jbXMuQXV0aG9yaXplQW5jaG9yUmVxdWVzdCA9IGZ1bmN0aW9uIChvcHRfZGF0YSkgewogIGpzcGIuTWVzc2FnZS5pbml0aWFsaXplKHRoaXMsIG9wdF9kYXRhLCAwLCAtMSwgbnVsbCwgbnVsbCk7Cn07Cgpnb29nLmluaGVyaXRzKHByb3RvLnBiLmNtcy5BdXRob3JpemVBbmNob3JSZXF1ZXN0LCBqc3BiLk1lc3NhZ2UpOwoKaWYgKGdvb2cuREVCVUcgJiYgIUNPTVBJTEVEKSB7CiAgLyoqCiAgICogQHB1YmxpYwogICAqIEBvdmVycmlkZQogICAqLwogIHByb3RvLnBiLmNtcy5BdXRob3JpemVBbmNob3JSZXF1ZXN0LmRpc3BsYXlOYW1lID0gJ3Byb3RvLnBiLmNtcy5BdXRob3JpemVBbmNob3JSZXF1ZXN0JzsKfQovKioKICogR2VuZXJhdGVkIGJ5IEpzUGJDb2RlR2VuZXJhdG9yLgogKiBAcGFyYW0ge0FycmF5PX0gb3B0X2RhdGEgT3B0aW9uYWwgaW5pdGlhbCBkYXRhIGFycmF5LCB0eXBpY2FsbHkgZnJvbSBhCiAqIHNlcnZlciByZXNwb25zZSwgb3IgY29uc3RydWN0ZWQgZGlyZWN0bHkgaW4gSmF2YXNjcmlwdC4gVGhlIGFycmF5IGlzIHVzZWQKICogaW4gcGxhY2UgYW5kIGJlY29tZXMgcGFydCBvZiB0aGUgY29uc3RydWN0ZWQgb2JqZWN0LiBJdCBpcyBub3QgY2xvbmVkLgogKiBJZiBubyBkYXRhIGlzIHByb3ZpZGVkLCB0aGUgY29uc3RydWN0ZWQgb2JqZWN0IHdpbGwgYmUgZW1wdHksIGJ1dCBzdGlsbAogKiB2YWxpZC4KICogQGV4dGVuZHMge2pzcGIuTWVzc2FnZX0KICogQGNvbnN0cnVjdG9yCiAqLwoKCnByb3RvLnBiLmNtcy5BbmNob3JGdWxsUmVxdWVzdCA9IGZ1bmN0aW9uIChvcHRfZGF0YSkgewogIGpzcGIuTWVzc2FnZS5pbml0aWFsaXplKHRoaXMsIG9wdF9kYXRhLCAwLCAtMSwgbnVsbCwgbnVsbCk7Cn07Cgpnb29nLmluaGVyaXRzKHByb3RvLnBiLmNtcy5BbmNob3JGdWxsUmVxdWVzdCwganNwYi5NZXNzYWdlKTsKCmlmIChnb29nLkRFQlVHICYmICFDT01QSUxFRCkgewogIC8qKgogICAqIEBwdWJsaWMKICAgKiBAb3ZlcnJpZGUKICAgKi8KICBwcm90by5wYi5jbXMuQW5jaG9yRnVsbFJlcXVlc3QuZGlzcGxheU5hbWUgPSAncHJvdG8ucGIuY21zLkFuY2hvckZ1bGxSZXF1ZXN0JzsKfQovKioKICogR2VuZXJhdGVkIGJ5IEpzUGJDb2RlR2VuZXJhdG9yLgogKiBAcGFyYW0ge0FycmF5PX0gb3B0X2RhdGEgT3B0aW9uYWwgaW5pdGlhbCBkYXRhIGFycmF5LCB0eXBpY2FsbHkgZnJvbSBhCiAqIHNlcnZlciByZXNwb25zZSwgb3IgY29uc3RydWN0ZWQgZGlyZWN0bHkgaW4gSmF2YXNjcmlwdC4gVGhlIGFycmF5IGlzIHVzZWQKICogaW4gcGxhY2UgYW5kIGJlY29tZXMgcGFydCBvZiB0aGUgY29uc3RydWN0ZWQgb2JqZWN0LiBJdCBpcyBub3QgY2xvbmVkLgogKiBJZiBubyBkYXRhIGlzIHByb3ZpZGVkLCB0aGUgY29uc3RydWN0ZWQgb2JqZWN0IHdpbGwgYmUgZW1wdHksIGJ1dCBzdGlsbAogKiB2YWxpZC4KICogQGV4dGVuZHMge2pzcGIuTWVzc2FnZX0KICogQGNvbnN0cnVjdG9yCiAqLwoKCnByb3RvLnBiLmNtcy5BbmNob3JGdWxsUmVwbHkgPSBmdW5jdGlvbiAob3B0X2RhdGEpIHsKICBqc3BiLk1lc3NhZ2UuaW5pdGlhbGl6ZSh0aGlzLCBvcHRfZGF0YSwgMCwgLTEsIHByb3RvLnBiLmNtcy5BbmNob3JGdWxsUmVwbHkucmVwZWF0ZWRGaWVsZHNfLCBudWxsKTsKfTsKCmdvb2cuaW5oZXJpdHMocHJvdG8ucGIuY21zLkFuY2hvckZ1bGxSZXBseSwganNwYi5NZXNzYWdlKTsKCmlmIChnb29nLkRFQlVHICYmICFDT01QSUxFRCkgewogIC8qKgogICAqIEBwdWJsaWMKICAgKiBAb3ZlcnJpZGUKICAgKi8KICBwcm90by5wYi5jbXMuQW5jaG9yRnVsbFJlcGx5LmRpc3BsYXlOYW1lID0gJ3Byb3RvLnBiLmNtcy5BbmNob3JGdWxsUmVwbHknOwp9Ci8qKgogKiBHZW5lcmF0ZWQgYnkgSnNQYkNvZGVHZW5lcmF0b3IuCiAqIEBwYXJhbSB7QXJyYXk9fSBvcHRfZGF0YSBPcHRpb25hbCBpbml0aWFsIGRhdGEgYXJyYXksIHR5cGljYWxseSBmcm9tIGEKICogc2VydmVyIHJlc3BvbnNlLCBvciBjb25zdHJ1Y3RlZCBkaXJlY3RseSBpbiBKYXZhc2NyaXB0LiBUaGUgYXJyYXkgaXMgdXNlZAogKiBpbiBwbGFjZSBhbmQgYmVjb21lcyBwYXJ0IG9mIHRoZSBjb25zdHJ1Y3RlZCBvYmplY3QuIEl0IGlzIG5vdCBjbG9uZWQuCiAqIElmIG5vIGRhdGEgaXMgcHJvdmlkZWQsIHRoZSBjb25zdHJ1Y3RlZCBvYmplY3Qgd2lsbCBiZSBlbXB0eSwgYnV0IHN0aWxsCiAqIHZhbGlkLgogKiBAZXh0ZW5kcyB7anNwYi5NZXNzYWdlfQogKiBAY29uc3RydWN0b3IKICovCgoKcHJvdG8ucGIuY21zLlByb2ZpbGVMaXN0UmVxdWVzdCA9IGZ1bmN0aW9uIChvcHRfZGF0YSkgewogIGpzcGIuTWVzc2FnZS5pbml0aWFsaXplKHRoaXMsIG9wdF9kYXRhLCAwLCAtMSwgbnVsbCwgbnVsbCk7Cn07Cgpnb29nLmluaGVyaXRzKHByb3RvLnBiLmNtcy5Qcm9maWxlTGlzdFJlcXVlc3QsIGpzcGIuTWVzc2FnZSk7CgppZiAoZ29vZy5ERUJVRyAmJiAhQ09NUElMRUQpIHsKICAvKioKICAgKiBAcHVibGljCiAgICogQG92ZXJyaWRlCiAgICovCiAgcHJvdG8ucGIuY21zLlByb2ZpbGVMaXN0UmVxdWVzdC5kaXNwbGF5TmFtZSA9ICdwcm90by5wYi5jbXMuUHJvZmlsZUxpc3RSZXF1ZXN0JzsKfQovKioKICogR2VuZXJhdGVkIGJ5IEpzUGJDb2RlR2VuZXJhdG9yLgogKiBAcGFyYW0ge0FycmF5PX0gb3B0X2RhdGEgT3B0aW9uYWwgaW5pdGlhbCBkYXRhIGFycmF5LCB0eXBpY2FsbHkgZnJvbSBhCiAqIHNlcnZlciByZXNwb25zZSwgb3IgY29uc3RydWN0ZWQgZGlyZWN0bHkgaW4gSmF2YXNjcmlwdC4gVGhlIGFycmF5IGlzIHVzZWQKICogaW4gcGxhY2UgYW5kIGJlY29tZXMgcGFydCBvZiB0aGUgY29uc3RydWN0ZWQgb2JqZWN0LiBJdCBpcyBub3QgY2xvbmVkLgogKiBJZiBubyBkYXRhIGlzIHByb3ZpZGVkLCB0aGUgY29uc3RydWN0ZWQgb2JqZWN0IHdpbGwgYmUgZW1wdHksIGJ1dCBzdGlsbAogKiB2YWxpZC4KICogQGV4dGVuZHMge2pzcGIuTWVzc2FnZX0KICogQGNvbnN0cnVjdG9yCiAqLwoKCnByb3RvLnBiLmNtcy5Qcm9maWxlTGlzdFJlcGx5ID0gZnVuY3Rpb24gKG9wdF9kYXRhKSB7CiAganNwYi5NZXNzYWdlLmluaXRpYWxpemUodGhpcywgb3B0X2RhdGEsIDAsIC0xLCBwcm90by5wYi5jbXMuUHJvZmlsZUxpc3RSZXBseS5yZXBlYXRlZEZpZWxkc18sIG51bGwpOwp9OwoKZ29vZy5pbmhlcml0cyhwcm90by5wYi5jbXMuUHJvZmlsZUxpc3RSZXBseSwganNwYi5NZXNzYWdlKTsKCmlmIChnb29nLkRFQlVHICYmICFDT01QSUxFRCkgewogIC8qKgogICAqIEBwdWJsaWMKICAgKiBAb3ZlcnJpZGUKICAgKi8KICBwcm90by5wYi5jbXMuUHJvZmlsZUxpc3RSZXBseS5kaXNwbGF5TmFtZSA9ICdwcm90by5wYi5jbXMuUHJvZmlsZUxpc3RSZXBseSc7Cn0KLyoqCiAqIEdlbmVyYXRlZCBieSBKc1BiQ29kZUdlbmVyYXRvci4KICogQHBhcmFtIHtBcnJheT19IG9wdF9kYXRhIE9wdGlvbmFsIGluaXRpYWwgZGF0YSBhcnJheSwgdHlwaWNhbGx5IGZyb20gYQogKiBzZXJ2ZXIgcmVzcG9uc2UsIG9yIGNvbnN0cnVjdGVkIGRpcmVjdGx5IGluIEphdmFzY3JpcHQuIFRoZSBhcnJheSBpcyB1c2VkCiAqIGluIHBsYWNlIGFuZCBiZWNvbWVzIHBhcnQgb2YgdGhlIGNvbnN0cnVjdGVkIG9iamVjdC4gSXQgaXMgbm90IGNsb25lZC4KICogSWYgbm8gZGF0YSBpcyBwcm92aWRlZCwgdGhlIGNvbnN0cnVjdGVkIG9iamVjdCB3aWxsIGJlIGVtcHR5LCBidXQgc3RpbGwKICogdmFsaWQuCiAqIEBleHRlbmRzIHtqc3BiLk1lc3NhZ2V9CiAqIEBjb25zdHJ1Y3RvcgogKi8KCgpwcm90by5wYi5jbXMuUHJvY2Vzc1Byb2ZpbGVSZXF1ZXN0ID0gZnVuY3Rpb24gKG9wdF9kYXRhKSB7CiAganNwYi5NZXNzYWdlLmluaXRpYWxpemUodGhpcywgb3B0X2RhdGEsIDAsIC0xLCBudWxsLCBudWxsKTsKfTsKCmdvb2cuaW5oZXJpdHMocHJvdG8ucGIuY21zLlByb2Nlc3NQcm9maWxlUmVxdWVzdCwganNwYi5NZXNzYWdlKTsKCmlmIChnb29nLkRFQlVHICYmICFDT01QSUxFRCkgewogIC8qKgogICAqIEBwdWJsaWMKICAgKiBAb3ZlcnJpZGUKICAgKi8KICBwcm90by5wYi5jbXMuUHJvY2Vzc1Byb2ZpbGVSZXF1ZXN0LmRpc3BsYXlOYW1lID0gJ3Byb3RvLnBiLmNtcy5Qcm9jZXNzUHJvZmlsZVJlcXVlc3QnOwp9Ci8qKgogKiBHZW5lcmF0ZWQgYnkgSnNQYkNvZGVHZW5lcmF0b3IuCiAqIEBwYXJhbSB7QXJyYXk9fSBvcHRfZGF0YSBPcHRpb25hbCBpbml0aWFsIGRhdGEgYXJyYXksIHR5cGljYWxseSBmcm9tIGEKICogc2VydmVyIHJlc3BvbnNlLCBvciBjb25zdHJ1Y3RlZCBkaXJlY3RseSBpbiBKYXZhc2NyaXB0LiBUaGUgYXJyYXkgaXMgdXNlZAogKiBpbiBwbGFjZSBhbmQgYmVjb21lcyBwYXJ0IG9mIHRoZSBjb25zdHJ1Y3RlZCBvYmplY3QuIEl0IGlzIG5vdCBjbG9uZWQuCiAqIElmIG5vIGRhdGEgaXMgcHJvdmlkZWQsIHRoZSBjb25zdHJ1Y3RlZCBvYmplY3Qgd2lsbCBiZSBlbXB0eSwgYnV0IHN0aWxsCiAqIHZhbGlkLgogKiBAZXh0ZW5kcyB7anNwYi5NZXNzYWdlfQogKiBAY29uc3RydWN0b3IKICovCgoKcHJvdG8ucGIuY21zLlZpb2xhdGlvbkxpc3RSZXF1ZXN0ID0gZnVuY3Rpb24gKG9wdF9kYXRhKSB7CiAganNwYi5NZXNzYWdlLmluaXRpYWxpemUodGhpcywgb3B0X2RhdGEsIDAsIC0xLCBwcm90by5wYi5jbXMuVmlvbGF0aW9uTGlzdFJlcXVlc3QucmVwZWF0ZWRGaWVsZHNfLCBudWxsKTsKfTsKCmdvb2cuaW5oZXJpdHMocHJvdG8ucGIuY21zLlZpb2xhdGlvbkxpc3RSZXF1ZXN0LCBqc3BiLk1lc3NhZ2UpOwoKaWYgKGdvb2cuREVCVUcgJiYgIUNPTVBJTEVEKSB7CiAgLyoqCiAgICogQHB1YmxpYwogICAqIEBvdmVycmlkZQogICAqLwogIHByb3RvLnBiLmNtcy5WaW9sYXRpb25MaXN0UmVxdWVzdC5kaXNwbGF5TmFtZSA9ICdwcm90by5wYi5jbXMuVmlvbGF0aW9uTGlzdFJlcXVlc3QnOwp9Ci8qKgogKiBHZW5lcmF0ZWQgYnkgSnNQYkNvZGVHZW5lcmF0b3IuCiAqIEBwYXJhbSB7QXJyYXk9fSBvcHRfZGF0YSBPcHRpb25hbCBpbml0aWFsIGRhdGEgYXJyYXksIHR5cGljYWxseSBmcm9tIGEKICogc2VydmVyIHJlc3BvbnNlLCBvciBjb25zdHJ1Y3RlZCBkaXJlY3RseSBpbiBKYXZhc2NyaXB0LiBUaGUgYXJyYXkgaXMgdXNlZAogKiBpbiBwbGFjZSBhbmQgYmVjb21lcyBwYXJ0IG9mIHRoZSBjb25zdHJ1Y3RlZCBvYmplY3QuIEl0IGlzIG5vdCBjbG9uZWQuCiAqIElmIG5vIGRhdGEgaXMgcHJvdmlkZWQsIHRoZSBjb25zdHJ1Y3RlZCBvYmplY3Qgd2lsbCBiZSBlbXB0eSwgYnV0IHN0aWxsCiAqIHZhbGlkLgogKiBAZXh0ZW5kcyB7anNwYi5NZXNzYWdlfQogKiBAY29uc3RydWN0b3IKICovCgoKcHJvdG8ucGIuY21zLlZpb2xhdGlvbkxpc3RSZXBseSA9IGZ1bmN0aW9uIChvcHRfZGF0YSkgewogIGpzcGIuTWVzc2FnZS5pbml0aWFsaXplKHRoaXMsIG9wdF9kYXRhLCAwLCAtMSwgcHJvdG8ucGIuY21zLlZpb2xhdGlvbkxpc3RSZXBseS5yZXBlYXRlZEZpZWxkc18sIG51bGwpOwp9OwoKZ29vZy5pbmhlcml0cyhwcm90by5wYi5jbXMuVmlvbGF0aW9uTGlzdFJlcGx5LCBqc3BiLk1lc3NhZ2UpOwoKaWYgKGdvb2cuREVCVUcgJiYgIUNPTVBJTEVEKSB7CiAgLyoqCiAgICogQHB1YmxpYwogICAqIEBvdmVycmlkZQogICAqLwogIHByb3RvLnBiLmNtcy5WaW9sYXRpb25MaXN0UmVwbHkuZGlzcGxheU5hbWUgPSAncHJvdG8ucGIuY21zLlZpb2xhdGlvbkxpc3RSZXBseSc7Cn0KLyoqCiAqIEdlbmVyYXRlZCBieSBKc1BiQ29kZUdlbmVyYXRvci4KICogQHBhcmFtIHtBcnJheT19IG9wdF9kYXRhIE9wdGlvbmFsIGluaXRpYWwgZGF0YSBhcnJheSwgdHlwaWNhbGx5IGZyb20gYQogKiBzZXJ2ZXIgcmVzcG9uc2UsIG9yIGNvbnN0cnVjdGVkIGRpcmVjdGx5IGluIEphdmFzY3JpcHQuIFRoZSBhcnJheSBpcyB1c2VkCiAqIGluIHBsYWNlIGFuZCBiZWNvbWVzIHBhcnQgb2YgdGhlIGNvbnN0cnVjdGVkIG9iamVjdC4gSXQgaXMgbm90IGNsb25lZC4KICogSWYgbm8gZGF0YSBpcyBwcm92aWRlZCwgdGhlIGNvbnN0cnVjdGVkIG9iamVjdCB3aWxsIGJlIGVtcHR5LCBidXQgc3RpbGwKICogdmFsaWQuCiAqIEBleHRlbmRzIHtqc3BiLk1lc3NhZ2V9CiAqIEBjb25zdHJ1Y3RvcgogKi8KCgpwcm90by5wYi5jbXMuUHJvY2Vzc1Zpb2xhdGlvblJlcXVlc3QgPSBmdW5jdGlvbiAob3B0X2RhdGEpIHsKICBqc3BiLk1lc3NhZ2UuaW5pdGlhbGl6ZSh0aGlzLCBvcHRfZGF0YSwgMCwgLTEsIG51bGwsIG51bGwpOwp9OwoKZ29vZy5pbmhlcml0cyhwcm90by5wYi5jbXMuUHJvY2Vzc1Zpb2xhdGlvblJlcXVlc3QsIGpzcGIuTWVzc2FnZSk7CgppZiAoZ29vZy5ERUJVRyAmJiAhQ09NUElMRUQpIHsKICAvKioKICAgKiBAcHVibGljCiAgICogQG92ZXJyaWRlCiAgICovCiAgcHJvdG8ucGIuY21zLlByb2Nlc3NWaW9sYXRpb25SZXF1ZXN0LmRpc3BsYXlOYW1lID0gJ3Byb3RvLnBiLmNtcy5Qcm9jZXNzVmlvbGF0aW9uUmVxdWVzdCc7Cn0KLyoqCiAqIEdlbmVyYXRlZCBieSBKc1BiQ29kZUdlbmVyYXRvci4KICogQHBhcmFtIHtBcnJheT19IG9wdF9kYXRhIE9wdGlvbmFsIGluaXRpYWwgZGF0YSBhcnJheSwgdHlwaWNhbGx5IGZyb20gYQogKiBzZXJ2ZXIgcmVzcG9uc2UsIG9yIGNvbnN0cnVjdGVkIGRpcmVjdGx5IGluIEphdmFzY3JpcHQuIFRoZSBhcnJheSBpcyB1c2VkCiAqIGluIHBsYWNlIGFuZCBiZWNvbWVzIHBhcnQgb2YgdGhlIGNvbnN0cnVjdGVkIG9iamVjdC4gSXQgaXMgbm90IGNsb25lZC4KICogSWYgbm8gZGF0YSBpcyBwcm92aWRlZCwgdGhlIGNvbnN0cnVjdGVkIG9iamVjdCB3aWxsIGJlIGVtcHR5LCBidXQgc3RpbGwKICogdmFsaWQuCiAqIEBleHRlbmRzIHtqc3BiLk1lc3NhZ2V9CiAqIEBjb25zdHJ1Y3RvcgogKi8KCgpwcm90by5wYi5jbXMuTGl2ZUxpc3RSZXF1ZXN0ID0gZnVuY3Rpb24gKG9wdF9kYXRhKSB7CiAganNwYi5NZXNzYWdlLmluaXRpYWxpemUodGhpcywgb3B0X2RhdGEsIDAsIC0xLCBudWxsLCBudWxsKTsKfTsKCmdvb2cuaW5oZXJpdHMocHJvdG8ucGIuY21zLkxpdmVMaXN0UmVxdWVzdCwganNwYi5NZXNzYWdlKTsKCmlmIChnb29nLkRFQlVHICYmICFDT01QSUxFRCkgewogIC8qKgogICAqIEBwdWJsaWMKICAgKiBAb3ZlcnJpZGUKICAgKi8KICBwcm90by5wYi5jbXMuTGl2ZUxpc3RSZXF1ZXN0LmRpc3BsYXlOYW1lID0gJ3Byb3RvLnBiLmNtcy5MaXZlTGlzdFJlcXVlc3QnOwp9Ci8qKgogKiBHZW5lcmF0ZWQgYnkgSnNQYkNvZGVHZW5lcmF0b3IuCiAqIEBwYXJhbSB7QXJyYXk9fSBvcHRfZGF0YSBPcHRpb25hbCBpbml0aWFsIGRhdGEgYXJyYXksIHR5cGljYWxseSBmcm9tIGEKICogc2VydmVyIHJlc3BvbnNlLCBvciBjb25zdHJ1Y3RlZCBkaXJlY3RseSBpbiBKYXZhc2NyaXB0LiBUaGUgYXJyYXkgaXMgdXNlZAogKiBpbiBwbGFjZSBhbmQgYmVjb21lcyBwYXJ0IG9mIHRoZSBjb25zdHJ1Y3RlZCBvYmplY3QuIEl0IGlzIG5vdCBjbG9uZWQuCiAqIElmIG5vIGRhdGEgaXMgcHJvdmlkZWQsIHRoZSBjb25zdHJ1Y3RlZCBvYmplY3Qgd2lsbCBiZSBlbXB0eSwgYnV0IHN0aWxsCiAqIHZhbGlkLgogKiBAZXh0ZW5kcyB7anNwYi5NZXNzYWdlfQogKiBAY29uc3RydWN0b3IKICovCgoKcHJvdG8ucGIuY21zLkxpdmVMaXN0UmVwbHkgPSBmdW5jdGlvbiAob3B0X2RhdGEpIHsKICBqc3BiLk1lc3NhZ2UuaW5pdGlhbGl6ZSh0aGlzLCBvcHRfZGF0YSwgMCwgLTEsIHByb3RvLnBiLmNtcy5MaXZlTGlzdFJlcGx5LnJlcGVhdGVkRmllbGRzXywgbnVsbCk7Cn07Cgpnb29nLmluaGVyaXRzKHByb3RvLnBiLmNtcy5MaXZlTGlzdFJlcGx5LCBqc3BiLk1lc3NhZ2UpOwoKaWYgKGdvb2cuREVCVUcgJiYgIUNPTVBJTEVEKSB7CiAgLyoqCiAgICogQHB1YmxpYwogICAqIEBvdmVycmlkZQogICAqLwogIHByb3RvLnBiLmNtcy5MaXZlTGlzdFJlcGx5LmRpc3BsYXlOYW1lID0gJ3Byb3RvLnBiLmNtcy5MaXZlTGlzdFJlcGx5JzsKfQovKioKICogR2VuZXJhdGVkIGJ5IEpzUGJDb2RlR2VuZXJhdG9yLgogKiBAcGFyYW0ge0FycmF5PX0gb3B0X2RhdGEgT3B0aW9uYWwgaW5pdGlhbCBkYXRhIGFycmF5LCB0eXBpY2FsbHkgZnJvbSBhCiAqIHNlcnZlciByZXNwb25zZSwgb3IgY29uc3RydWN0ZWQgZGlyZWN0bHkgaW4gSmF2YXNjcmlwdC4gVGhlIGFycmF5IGlzIHVzZWQKICogaW4gcGxhY2UgYW5kIGJlY29tZXMgcGFydCBvZiB0aGUgY29uc3RydWN0ZWQgb2JqZWN0LiBJdCBpcyBub3QgY2xvbmVkLgogKiBJZiBubyBkYXRhIGlzIHByb3ZpZGVkLCB0aGUgY29uc3RydWN0ZWQgb2JqZWN0IHdpbGwgYmUgZW1wdHksIGJ1dCBzdGlsbAogKiB2YWxpZC4KICogQGV4dGVuZHMge2pzcGIuTWVzc2FnZX0KICogQGNvbnN0cnVjdG9yCiAqLwoKCnByb3RvLnBiLmNtcy5QYXlMaXN0UmVxdWVzdCA9IGZ1bmN0aW9uIChvcHRfZGF0YSkgewogIGpzcGIuTWVzc2FnZS5pbml0aWFsaXplKHRoaXMsIG9wdF9kYXRhLCAwLCAtMSwgbnVsbCwgbnVsbCk7Cn07Cgpnb29nLmluaGVyaXRzKHByb3RvLnBiLmNtcy5QYXlMaXN0UmVxdWVzdCwganNwYi5NZXNzYWdlKTsKCmlmIChnb29nLkRFQlVHICYmICFDT01QSUxFRCkgewogIC8qKgogICAqIEBwdWJsaWMKICAgKiBAb3ZlcnJpZGUKICAgKi8KICBwcm90by5wYi5jbXMuUGF5TGlzdFJlcXVlc3QuZGlzcGxheU5hbWUgPSAncHJvdG8ucGIuY21zLlBheUxpc3RSZXF1ZXN0JzsKfQovKioKICogR2VuZXJhdGVkIGJ5IEpzUGJDb2RlR2VuZXJhdG9yLgogKiBAcGFyYW0ge0FycmF5PX0gb3B0X2RhdGEgT3B0aW9uYWwgaW5pdGlhbCBkYXRhIGFycmF5LCB0eXBpY2FsbHkgZnJvbSBhCiAqIHNlcnZlciByZXNwb25zZSwgb3IgY29uc3RydWN0ZWQgZGlyZWN0bHkgaW4gSmF2YXNjcmlwdC4gVGhlIGFycmF5IGlzIHVzZWQKICogaW4gcGxhY2UgYW5kIGJlY29tZXMgcGFydCBvZiB0aGUgY29uc3RydWN0ZWQgb2JqZWN0LiBJdCBpcyBub3QgY2xvbmVkLgogKiBJZiBubyBkYXRhIGlzIHByb3ZpZGVkLCB0aGUgY29uc3RydWN0ZWQgb2JqZWN0IHdpbGwgYmUgZW1wdHksIGJ1dCBzdGlsbAogKiB2YWxpZC4KICogQGV4dGVuZHMge2pzcGIuTWVzc2FnZX0KICogQGNvbnN0cnVjdG9yCiAqLwoKCnByb3RvLnBiLmNtcy5QYXlMaXN0UmVwbHkgPSBmdW5jdGlvbiAob3B0X2RhdGEpIHsKICBqc3BiLk1lc3NhZ2UuaW5pdGlhbGl6ZSh0aGlzLCBvcHRfZGF0YSwgMCwgLTEsIHByb3RvLnBiLmNtcy5QYXlMaXN0UmVwbHkucmVwZWF0ZWRGaWVsZHNfLCBudWxsKTsKfTsKCmdvb2cuaW5oZXJpdHMocHJvdG8ucGIuY21zLlBheUxpc3RSZXBseSwganNwYi5NZXNzYWdlKTsKCmlmIChnb29nLkRFQlVHICYmICFDT01QSUxFRCkgewogIC8qKgogICAqIEBwdWJsaWMKICAgKiBAb3ZlcnJpZGUKICAgKi8KICBwcm90by5wYi5jbXMuUGF5TGlzdFJlcGx5LmRpc3BsYXlOYW1lID0gJ3Byb3RvLnBiLmNtcy5QYXlMaXN0UmVwbHknOwp9Ci8qKgogKiBHZW5lcmF0ZWQgYnkgSnNQYkNvZGVHZW5lcmF0b3IuCiAqIEBwYXJhbSB7QXJyYXk9fSBvcHRfZGF0YSBPcHRpb25hbCBpbml0aWFsIGRhdGEgYXJyYXksIHR5cGljYWxseSBmcm9tIGEKICogc2VydmVyIHJlc3BvbnNlLCBvciBjb25zdHJ1Y3RlZCBkaXJlY3RseSBpbiBKYXZhc2NyaXB0LiBUaGUgYXJyYXkgaXMgdXNlZAogKiBpbiBwbGFjZSBhbmQgYmVjb21lcyBwYXJ0IG9mIHRoZSBjb25zdHJ1Y3RlZCBvYmplY3QuIEl0IGlzIG5vdCBjbG9uZWQuCiAqIElmIG5vIGRhdGEgaXMgcHJvdmlkZWQsIHRoZSBjb25zdHJ1Y3RlZCBvYmplY3Qgd2lsbCBiZSBlbXB0eSwgYnV0IHN0aWxsCiAqIHZhbGlkLgogKiBAZXh0ZW5kcyB7anNwYi5NZXNzYWdlfQogKiBAY29uc3RydWN0b3IKICovCgoKcHJvdG8ucGIuY21zLlJvYm90TGlzdFJlcXVlc3QgPSBmdW5jdGlvbiAob3B0X2RhdGEpIHsKICBqc3BiLk1lc3NhZ2UuaW5pdGlhbGl6ZSh0aGlzLCBvcHRfZGF0YSwgMCwgLTEsIG51bGwsIG51bGwpOwp9OwoKZ29vZy5pbmhlcml0cyhwcm90by5wYi5jbXMuUm9ib3RMaXN0UmVxdWVzdCwganNwYi5NZXNzYWdlKTsKCmlmIChnb29nLkRFQlVHICYmICFDT01QSUxFRCkgewogIC8qKgogICAqIEBwdWJsaWMKICAgKiBAb3ZlcnJpZGUKICAgKi8KICBwcm90by5wYi5jbXMuUm9ib3RMaXN0UmVxdWVzdC5kaXNwbGF5TmFtZSA9ICdwcm90by5wYi5jbXMuUm9ib3RMaXN0UmVxdWVzdCc7Cn0KLyoqCiAqIEdlbmVyYXRlZCBieSBKc1BiQ29kZUdlbmVyYXRvci4KICogQHBhcmFtIHtBcnJheT19IG9wdF9kYXRhIE9wdGlvbmFsIGluaXRpYWwgZGF0YSBhcnJheSwgdHlwaWNhbGx5IGZyb20gYQogKiBzZXJ2ZXIgcmVzcG9uc2UsIG9yIGNvbnN0cnVjdGVkIGRpcmVjdGx5IGluIEphdmFzY3JpcHQuIFRoZSBhcnJheSBpcyB1c2VkCiAqIGluIHBsYWNlIGFuZCBiZWNvbWVzIHBhcnQgb2YgdGhlIGNvbnN0cnVjdGVkIG9iamVjdC4gSXQgaXMgbm90IGNsb25lZC4KICogSWYgbm8gZGF0YSBpcyBwcm92aWRlZCwgdGhlIGNvbnN0cnVjdGVkIG9iamVjdCB3aWxsIGJlIGVtcHR5LCBidXQgc3RpbGwKICogdmFsaWQuCiAqIEBleHRlbmRzIHtqc3BiLk1lc3NhZ2V9CiAqIEBjb25zdHJ1Y3RvcgogKi8KCgpwcm90by5wYi5jbXMuUm9ib3RMaXN0UmVwbHkgPSBmdW5jdGlvbiAob3B0X2RhdGEpIHsKICBqc3BiLk1lc3NhZ2UuaW5pdGlhbGl6ZSh0aGlzLCBvcHRfZGF0YSwgMCwgLTEsIHByb3RvLnBiLmNtcy5Sb2JvdExpc3RSZXBseS5yZXBlYXRlZEZpZWxkc18sIG51bGwpOwp9OwoKZ29vZy5pbmhlcml0cyhwcm90by5wYi5jbXMuUm9ib3RMaXN0UmVwbHksIGpzcGIuTWVzc2FnZSk7CgppZiAoZ29vZy5ERUJVRyAmJiAhQ09NUElMRUQpIHsKICAvKioKICAgKiBAcHVibGljCiAgICogQG92ZXJyaWRlCiAgICovCiAgcHJvdG8ucGIuY21zLlJvYm90TGlzdFJlcGx5LmRpc3BsYXlOYW1lID0gJ3Byb3RvLnBiLmNtcy5Sb2JvdExpc3RSZXBseSc7Cn0KLyoqCiAqIEdlbmVyYXRlZCBieSBKc1BiQ29kZUdlbmVyYXRvci4KICogQHBhcmFtIHtBcnJheT19IG9wdF9kYXRhIE9wdGlvbmFsIGluaXRpYWwgZGF0YSBhcnJheSwgdHlwaWNhbGx5IGZyb20gYQogKiBzZXJ2ZXIgcmVzcG9uc2UsIG9yIGNvbnN0cnVjdGVkIGRpcmVjdGx5IGluIEphdmFzY3JpcHQuIFRoZSBhcnJheSBpcyB1c2VkCiAqIGluIHBsYWNlIGFuZCBiZWNvbWVzIHBhcnQgb2YgdGhlIGNvbnN0cnVjdGVkIG9iamVjdC4gSXQgaXMgbm90IGNsb25lZC4KICogSWYgbm8gZGF0YSBpcyBwcm92aWRlZCwgdGhlIGNvbnN0cnVjdGVkIG9iamVjdCB3aWxsIGJlIGVtcHR5LCBidXQgc3RpbGwKICogdmFsaWQuCiAqIEBleHRlbmRzIHtqc3BiLk1lc3NhZ2V9CiAqIEBjb25zdHJ1Y3RvcgogKi8KCgpwcm90by5wYi5jbXMuUm9ib3RNZXNzYWdlTGlzdFJlcXVlc3QgPSBmdW5jdGlvbiAob3B0X2RhdGEpIHsKICBqc3BiLk1lc3NhZ2UuaW5pdGlhbGl6ZSh0aGlzLCBvcHRfZGF0YSwgMCwgLTEsIG51bGwsIG51bGwpOwp9OwoKZ29vZy5pbmhlcml0cyhwcm90by5wYi5jbXMuUm9ib3RNZXNzYWdlTGlzdFJlcXVlc3QsIGpzcGIuTWVzc2FnZSk7CgppZiAoZ29vZy5ERUJVRyAmJiAhQ09NUElMRUQpIHsKICAvKioKICAgKiBAcHVibGljCiAgICogQG92ZXJyaWRlCiAgICovCiAgcHJvdG8ucGIuY21zLlJvYm90TWVzc2FnZUxpc3RSZXF1ZXN0LmRpc3BsYXlOYW1lID0gJ3Byb3RvLnBiLmNtcy5Sb2JvdE1lc3NhZ2VMaXN0UmVxdWVzdCc7Cn0KLyoqCiAqIEdlbmVyYXRlZCBieSBKc1BiQ29kZUdlbmVyYXRvci4KICogQHBhcmFtIHtBcnJheT19IG9wdF9kYXRhIE9wdGlvbmFsIGluaXRpYWwgZGF0YSBhcnJheSwgdHlwaWNhbGx5IGZyb20gYQogKiBzZXJ2ZXIgcmVzcG9uc2UsIG9yIGNvbnN0cnVjdGVkIGRpcmVjdGx5IGluIEphdmFzY3JpcHQuIFRoZSBhcnJheSBpcyB1c2VkCiAqIGluIHBsYWNlIGFuZCBiZWNvbWVzIHBhcnQgb2YgdGhlIGNvbnN0cnVjdGVkIG9iamVjdC4gSXQgaXMgbm90IGNsb25lZC4KICogSWYgbm8gZGF0YSBpcyBwcm92aWRlZCwgdGhlIGNvbnN0cnVjdGVkIG9iamVjdCB3aWxsIGJlIGVtcHR5LCBidXQgc3RpbGwKICogdmFsaWQuCiAqIEBleHRlbmRzIHtqc3BiLk1lc3NhZ2V9CiAqIEBjb25zdHJ1Y3RvcgogKi8KCgpwcm90by5wYi5jbXMuUm9ib3RNZXNzYWdlTGlzdFJlcGx5ID0gZnVuY3Rpb24gKG9wdF9kYXRhKSB7CiAganNwYi5NZXNzYWdlLmluaXRpYWxpemUodGhpcywgb3B0X2RhdGEsIDAsIC0xLCBwcm90by5wYi5jbXMuUm9ib3RNZXNzYWdlTGlzdFJlcGx5LnJlcGVhdGVkRmllbGRzXywgbnVsbCk7Cn07Cgpnb29nLmluaGVyaXRzKHByb3RvLnBiLmNtcy5Sb2JvdE1lc3NhZ2VMaXN0UmVwbHksIGpzcGIuTWVzc2FnZSk7CgppZiAoZ29vZy5ERUJVRyAmJiAhQ09NUElMRUQpIHsKICAvKioKICAgKiBAcHVibGljCiAgICogQG92ZXJyaWRlCiAgICovCiAgcHJvdG8ucGIuY21zLlJvYm90TWVzc2FnZUxpc3RSZXBseS5kaXNwbGF5TmFtZSA9ICdwcm90by5wYi5jbXMuUm9ib3RNZXNzYWdlTGlzdFJlcGx5JzsKfQovKioKICogR2VuZXJhdGVkIGJ5IEpzUGJDb2RlR2VuZXJhdG9yLgogKiBAcGFyYW0ge0FycmF5PX0gb3B0X2RhdGEgT3B0aW9uYWwgaW5pdGlhbCBkYXRhIGFycmF5LCB0eXBpY2FsbHkgZnJvbSBhCiAqIHNlcnZlciByZXNwb25zZSwgb3IgY29uc3RydWN0ZWQgZGlyZWN0bHkgaW4gSmF2YXNjcmlwdC4gVGhlIGFycmF5IGlzIHVzZWQKICogaW4gcGxhY2UgYW5kIGJlY29tZXMgcGFydCBvZiB0aGUgY29uc3RydWN0ZWQgb2JqZWN0LiBJdCBpcyBub3QgY2xvbmVkLgogKiBJZiBubyBkYXRhIGlzIHByb3ZpZGVkLCB0aGUgY29uc3RydWN0ZWQgb2JqZWN0IHdpbGwgYmUgZW1wdHksIGJ1dCBzdGlsbAogKiB2YWxpZC4KICogQGV4dGVuZHMge2pzcGIuTWVzc2FnZX0KICogQGNvbnN0cnVjdG9yCiAqLwoKCnByb3RvLnBiLmNtcy5BdXRvTWVzc2FnZUxpc3RSZXF1ZXN0ID0gZnVuY3Rpb24gKG9wdF9kYXRhKSB7CiAganNwYi5NZXNzYWdlLmluaXRpYWxpemUodGhpcywgb3B0X2RhdGEsIDAsIC0xLCBudWxsLCBudWxsKTsKfTsKCmdvb2cuaW5oZXJpdHMocHJvdG8ucGIuY21zLkF1dG9NZXNzYWdlTGlzdFJlcXVlc3QsIGpzcGIuTWVzc2FnZSk7CgppZiAoZ29vZy5ERUJVRyAmJiAhQ09NUElMRUQpIHsKICAvKioKICAgKiBAcHVibGljCiAgICogQG92ZXJyaWRlCiAgICovCiAgcHJvdG8ucGIuY21zLkF1dG9NZXNzYWdlTGlzdFJlcXVlc3QuZGlzcGxheU5hbWUgPSAncHJvdG8ucGIuY21zLkF1dG9NZXNzYWdlTGlzdFJlcXVlc3QnOwp9Ci8qKgogKiBHZW5lcmF0ZWQgYnkgSnNQYkNvZGVHZW5lcmF0b3IuCiAqIEBwYXJhbSB7QXJyYXk9fSBvcHRfZGF0YSBPcHRpb25hbCBpbml0aWFsIGRhdGEgYXJyYXksIHR5cGljYWxseSBmcm9tIGEKICogc2VydmVyIHJlc3BvbnNlLCBvciBjb25zdHJ1Y3RlZCBkaXJlY3RseSBpbiBKYXZhc2NyaXB0LiBUaGUgYXJyYXkgaXMgdXNlZAogKiBpbiBwbGFjZSBhbmQgYmVjb21lcyBwYXJ0IG9mIHRoZSBjb25zdHJ1Y3RlZCBvYmplY3QuIEl0IGlzIG5vdCBjbG9uZWQuCiAqIElmIG5vIGRhdGEgaXMgcHJvdmlkZWQsIHRoZSBjb25zdHJ1Y3RlZCBvYmplY3Qgd2lsbCBiZSBlbXB0eSwgYnV0IHN0aWxsCiAqIHZhbGlkLgogKiBAZXh0ZW5kcyB7anNwYi5NZXNzYWdlfQogKiBAY29uc3RydWN0b3IKICovCgoKcHJvdG8ucGIuY21zLkF1dG9NZXNzYWdlTGlzdFJlcGx5ID0gZnVuY3Rpb24gKG9wdF9kYXRhKSB7CiAganNwYi5NZXNzYWdlLmluaXRpYWxpemUodGhpcywgb3B0X2RhdGEsIDAsIC0xLCBwcm90by5wYi5jbXMuQXV0b01lc3NhZ2VMaXN0UmVwbHkucmVwZWF0ZWRGaWVsZHNfLCBudWxsKTsKfTsKCmdvb2cuaW5oZXJpdHMocHJvdG8ucGIuY21zLkF1dG9NZXNzYWdlTGlzdFJlcGx5LCBqc3BiLk1lc3NhZ2UpOwoKaWYgKGdvb2cuREVCVUcgJiYgIUNPTVBJTEVEKSB7CiAgLyoqCiAgICogQHB1YmxpYwogICAqIEBvdmVycmlkZQogICAqLwogIHByb3RvLnBiLmNtcy5BdXRvTWVzc2FnZUxpc3RSZXBseS5kaXNwbGF5TmFtZSA9ICdwcm90by5wYi5jbXMuQXV0b01lc3NhZ2VMaXN0UmVwbHknOwp9Ci8qKgogKiBHZW5lcmF0ZWQgYnkgSnNQYkNvZGVHZW5lcmF0b3IuCiAqIEBwYXJhbSB7QXJyYXk9fSBvcHRfZGF0YSBPcHRpb25hbCBpbml0aWFsIGRhdGEgYXJyYXksIHR5cGljYWxseSBmcm9tIGEKICogc2VydmVyIHJlc3BvbnNlLCBvciBjb25zdHJ1Y3RlZCBkaXJlY3RseSBpbiBKYXZhc2NyaXB0LiBUaGUgYXJyYXkgaXMgdXNlZAogKiBpbiBwbGFjZSBhbmQgYmVjb21lcyBwYXJ0IG9mIHRoZSBjb25zdHJ1Y3RlZCBvYmplY3QuIEl0IGlzIG5vdCBjbG9uZWQuCiAqIElmIG5vIGRhdGEgaXMgcHJvdmlkZWQsIHRoZSBjb25zdHJ1Y3RlZCBvYmplY3Qgd2lsbCBiZSBlbXB0eSwgYnV0IHN0aWxsCiAqIHZhbGlkLgogKiBAZXh0ZW5kcyB7anNwYi5NZXNzYWdlfQogKiBAY29uc3RydWN0b3IKICovCgoKcHJvdG8ucGIuY21zLkNoYXRNZXNzYWdlTGlzdFJlcXVlc3QgPSBmdW5jdGlvbiAob3B0X2RhdGEpIHsKICBqc3BiLk1lc3NhZ2UuaW5pdGlhbGl6ZSh0aGlzLCBvcHRfZGF0YSwgMCwgLTEsIG51bGwsIG51bGwpOwp9OwoKZ29vZy5pbmhlcml0cyhwcm90by5wYi5jbXMuQ2hhdE1lc3NhZ2VMaXN0UmVxdWVzdCwganNwYi5NZXNzYWdlKTsKCmlmIChnb29nLkRFQlVHICYmICFDT01QSUxFRCkgewogIC8qKgogICAqIEBwdWJsaWMKICAgKiBAb3ZlcnJpZGUKICAgKi8KICBwcm90by5wYi5jbXMuQ2hhdE1lc3NhZ2VMaXN0UmVxdWVzdC5kaXNwbGF5TmFtZSA9ICdwcm90by5wYi5jbXMuQ2hhdE1lc3NhZ2VMaXN0UmVxdWVzdCc7Cn0KLyoqCiAqIEdlbmVyYXRlZCBieSBKc1BiQ29kZUdlbmVyYXRvci4KICogQHBhcmFtIHtBcnJheT19IG9wdF9kYXRhIE9wdGlvbmFsIGluaXRpYWwgZGF0YSBhcnJheSwgdHlwaWNhbGx5IGZyb20gYQogKiBzZXJ2ZXIgcmVzcG9uc2UsIG9yIGNvbnN0cnVjdGVkIGRpcmVjdGx5IGluIEphdmFzY3JpcHQuIFRoZSBhcnJheSBpcyB1c2VkCiAqIGluIHBsYWNlIGFuZCBiZWNvbWVzIHBhcnQgb2YgdGhlIGNvbnN0cnVjdGVkIG9iamVjdC4gSXQgaXMgbm90IGNsb25lZC4KICogSWYgbm8gZGF0YSBpcyBwcm92aWRlZCwgdGhlIGNvbnN0cnVjdGVkIG9iamVjdCB3aWxsIGJlIGVtcHR5LCBidXQgc3RpbGwKICogdmFsaWQuCiAqIEBleHRlbmRzIHtqc3BiLk1lc3NhZ2V9CiAqIEBjb25zdHJ1Y3RvcgogKi8KCgpwcm90by5wYi5jbXMuQ2hhdE1lc3NhZ2VMaXN0UmVwbHkgPSBmdW5jdGlvbiAob3B0X2RhdGEpIHsKICBqc3BiLk1lc3NhZ2UuaW5pdGlhbGl6ZSh0aGlzLCBvcHRfZGF0YSwgMCwgLTEsIHByb3RvLnBiLmNtcy5DaGF0TWVzc2FnZUxpc3RSZXBseS5yZXBlYXRlZEZpZWxkc18sIG51bGwpOwp9OwoKZ29vZy5pbmhlcml0cyhwcm90by5wYi5jbXMuQ2hhdE1lc3NhZ2VMaXN0UmVwbHksIGpzcGIuTWVzc2FnZSk7CgppZiAoZ29vZy5ERUJVRyAmJiAhQ09NUElMRUQpIHsKICAvKioKICAgKiBAcHVibGljCiAgICogQG92ZXJyaWRlCiAgICovCiAgcHJvdG8ucGIuY21zLkNoYXRNZXNzYWdlTGlzdFJlcGx5LmRpc3BsYXlOYW1lID0gJ3Byb3RvLnBiLmNtcy5DaGF0TWVzc2FnZUxpc3RSZXBseSc7Cn0KLyoqCiAqIEdlbmVyYXRlZCBieSBKc1BiQ29kZUdlbmVyYXRvci4KICogQHBhcmFtIHtBcnJheT19IG9wdF9kYXRhIE9wdGlvbmFsIGluaXRpYWwgZGF0YSBhcnJheSwgdHlwaWNhbGx5IGZyb20gYQogKiBzZXJ2ZXIgcmVzcG9uc2UsIG9yIGNvbnN0cnVjdGVkIGRpcmVjdGx5IGluIEphdmFzY3JpcHQuIFRoZSBhcnJheSBpcyB1c2VkCiAqIGluIHBsYWNlIGFuZCBiZWNvbWVzIHBhcnQgb2YgdGhlIGNvbnN0cnVjdGVkIG9iamVjdC4gSXQgaXMgbm90IGNsb25lZC4KICogSWYgbm8gZGF0YSBpcyBwcm92aWRlZCwgdGhlIGNvbnN0cnVjdGVkIG9iamVjdCB3aWxsIGJlIGVtcHR5LCBidXQgc3RpbGwKICogdmFsaWQuCiAqIEBleHRlbmRzIHtqc3BiLk1lc3NhZ2V9CiAqIEBjb25zdHJ1Y3RvcgogKi8KCgpwcm90by5wYi5jbXMuQ2FsbExpc3RSZXF1ZXN0ID0gZnVuY3Rpb24gKG9wdF9kYXRhKSB7CiAganNwYi5NZXNzYWdlLmluaXRpYWxpemUodGhpcywgb3B0X2RhdGEsIDAsIC0xLCBudWxsLCBudWxsKTsKfTsKCmdvb2cuaW5oZXJpdHMocHJvdG8ucGIuY21zLkNhbGxMaXN0UmVxdWVzdCwganNwYi5NZXNzYWdlKTsKCmlmIChnb29nLkRFQlVHICYmICFDT01QSUxFRCkgewogIC8qKgogICAqIEBwdWJsaWMKICAgKiBAb3ZlcnJpZGUKICAgKi8KICBwcm90by5wYi5jbXMuQ2FsbExpc3RSZXF1ZXN0LmRpc3BsYXlOYW1lID0gJ3Byb3RvLnBiLmNtcy5DYWxsTGlzdFJlcXVlc3QnOwp9Ci8qKgogKiBHZW5lcmF0ZWQgYnkgSnNQYkNvZGVHZW5lcmF0b3IuCiAqIEBwYXJhbSB7QXJyYXk9fSBvcHRfZGF0YSBPcHRpb25hbCBpbml0aWFsIGRhdGEgYXJyYXksIHR5cGljYWxseSBmcm9tIGEKICogc2VydmVyIHJlc3BvbnNlLCBvciBjb25zdHJ1Y3RlZCBkaXJlY3RseSBpbiBKYXZhc2NyaXB0LiBUaGUgYXJyYXkgaXMgdXNlZAogKiBpbiBwbGFjZSBhbmQgYmVjb21lcyBwYXJ0IG9mIHRoZSBjb25zdHJ1Y3RlZCBvYmplY3QuIEl0IGlzIG5vdCBjbG9uZWQuCiAqIElmIG5vIGRhdGEgaXMgcHJvdmlkZWQsIHRoZSBjb25zdHJ1Y3RlZCBvYmplY3Qgd2lsbCBiZSBlbXB0eSwgYnV0IHN0aWxsCiAqIHZhbGlkLgogKiBAZXh0ZW5kcyB7anNwYi5NZXNzYWdlfQogKiBAY29uc3RydWN0b3IKICovCgoKcHJvdG8ucGIuY21zLkNhbGxMaXN0UmVwbHkgPSBmdW5jdGlvbiAob3B0X2RhdGEpIHsKICBqc3BiLk1lc3NhZ2UuaW5pdGlhbGl6ZSh0aGlzLCBvcHRfZGF0YSwgMCwgLTEsIHByb3RvLnBiLmNtcy5DYWxsTGlzdFJlcGx5LnJlcGVhdGVkRmllbGRzXywgbnVsbCk7Cn07Cgpnb29nLmluaGVyaXRzKHByb3RvLnBiLmNtcy5DYWxsTGlzdFJlcGx5LCBqc3BiLk1lc3NhZ2UpOwoKaWYgKGdvb2cuREVCVUcgJiYgIUNPTVBJTEVEKSB7CiAgLyoqCiAgICogQHB1YmxpYwogICAqIEBvdmVycmlkZQogICAqLwogIHByb3RvLnBiLmNtcy5DYWxsTGlzdFJlcGx5LmRpc3BsYXlOYW1lID0gJ3Byb3RvLnBiLmNtcy5DYWxsTGlzdFJlcGx5JzsKfQovKioKICogR2VuZXJhdGVkIGJ5IEpzUGJDb2RlR2VuZXJhdG9yLgogKiBAcGFyYW0ge0FycmF5PX0gb3B0X2RhdGEgT3B0aW9uYWwgaW5pdGlhbCBkYXRhIGFycmF5LCB0eXBpY2FsbHkgZnJvbSBhCiAqIHNlcnZlciByZXNwb25zZSwgb3IgY29uc3RydWN0ZWQgZGlyZWN0bHkgaW4gSmF2YXNjcmlwdC4gVGhlIGFycmF5IGlzIHVzZWQKICogaW4gcGxhY2UgYW5kIGJlY29tZXMgcGFydCBvZiB0aGUgY29uc3RydWN0ZWQgb2JqZWN0LiBJdCBpcyBub3QgY2xvbmVkLgogKiBJZiBubyBkYXRhIGlzIHByb3ZpZGVkLCB0aGUgY29uc3RydWN0ZWQgb2JqZWN0IHdpbGwgYmUgZW1wdHksIGJ1dCBzdGlsbAogKiB2YWxpZC4KICogQGV4dGVuZHMge2pzcGIuTWVzc2FnZX0KICogQGNvbnN0cnVjdG9yCiAqLwoKCnByb3RvLnBiLmNtcy5UcmFuc2FjdGlvbkxpc3RSZXF1ZXN0ID0gZnVuY3Rpb24gKG9wdF9kYXRhKSB7CiAganNwYi5NZXNzYWdlLmluaXRpYWxpemUodGhpcywgb3B0X2RhdGEsIDAsIC0xLCBudWxsLCBudWxsKTsKfTsKCmdvb2cuaW5oZXJpdHMocHJvdG8ucGIuY21zLlRyYW5zYWN0aW9uTGlzdFJlcXVlc3QsIGpzcGIuTWVzc2FnZSk7CgppZiAoZ29vZy5ERUJVRyAmJiAhQ09NUElMRUQpIHsKICAvKioKICAgKiBAcHVibGljCiAgICogQG92ZXJyaWRlCiAgICovCiAgcHJvdG8ucGIuY21zLlRyYW5zYWN0aW9uTGlzdFJlcXVlc3QuZGlzcGxheU5hbWUgPSAncHJvdG8ucGIuY21zLlRyYW5zYWN0aW9uTGlzdFJlcXVlc3QnOwp9Ci8qKgogKiBHZW5lcmF0ZWQgYnkgSnNQYkNvZGVHZW5lcmF0b3IuCiAqIEBwYXJhbSB7QXJyYXk9fSBvcHRfZGF0YSBPcHRpb25hbCBpbml0aWFsIGRhdGEgYXJyYXksIHR5cGljYWxseSBmcm9tIGEKICogc2VydmVyIHJlc3BvbnNlLCBvciBjb25zdHJ1Y3RlZCBkaXJlY3RseSBpbiBKYXZhc2NyaXB0LiBUaGUgYXJyYXkgaXMgdXNlZAogKiBpbiBwbGFjZSBhbmQgYmVjb21lcyBwYXJ0IG9mIHRoZSBjb25zdHJ1Y3RlZCBvYmplY3QuIEl0IGlzIG5vdCBjbG9uZWQuCiAqIElmIG5vIGRhdGEgaXMgcHJvdmlkZWQsIHRoZSBjb25zdHJ1Y3RlZCBvYmplY3Qgd2lsbCBiZSBlbXB0eSwgYnV0IHN0aWxsCiAqIHZhbGlkLgogKiBAZXh0ZW5kcyB7anNwYi5NZXNzYWdlfQogKiBAY29uc3RydWN0b3IKICovCgoKcHJvdG8ucGIuY21zLlRyYW5zYWN0aW9uTGlzdFJlcGx5ID0gZnVuY3Rpb24gKG9wdF9kYXRhKSB7CiAganNwYi5NZXNzYWdlLmluaXRpYWxpemUodGhpcywgb3B0X2RhdGEsIDAsIC0xLCBwcm90by5wYi5jbXMuVHJhbnNhY3Rpb25MaXN0UmVwbHkucmVwZWF0ZWRGaWVsZHNfLCBudWxsKTsKfTsKCmdvb2cuaW5oZXJpdHMocHJvdG8ucGIuY21zLlRyYW5zYWN0aW9uTGlzdFJlcGx5LCBqc3BiLk1lc3NhZ2UpOwoKaWYgKGdvb2cuREVCVUcgJiYgIUNPTVBJTEVEKSB7CiAgLyoqCiAgICogQHB1YmxpYwogICAqIEBvdmVycmlkZQogICAqLwogIHByb3RvLnBiLmNtcy5UcmFuc2FjdGlvbkxpc3RSZXBseS5kaXNwbGF5TmFtZSA9ICdwcm90by5wYi5jbXMuVHJhbnNhY3Rpb25MaXN0UmVwbHknOwp9Ci8qKgogKiBHZW5lcmF0ZWQgYnkgSnNQYkNvZGVHZW5lcmF0b3IuCiAqIEBwYXJhbSB7QXJyYXk9fSBvcHRfZGF0YSBPcHRpb25hbCBpbml0aWFsIGRhdGEgYXJyYXksIHR5cGljYWxseSBmcm9tIGEKICogc2VydmVyIHJlc3BvbnNlLCBvciBjb25zdHJ1Y3RlZCBkaXJlY3RseSBpbiBKYXZhc2NyaXB0LiBUaGUgYXJyYXkgaXMgdXNlZAogKiBpbiBwbGFjZSBhbmQgYmVjb21lcyBwYXJ0IG9mIHRoZSBjb25zdHJ1Y3RlZCBvYmplY3QuIEl0IGlzIG5vdCBjbG9uZWQuCiAqIElmIG5vIGRhdGEgaXMgcHJvdmlkZWQsIHRoZSBjb25zdHJ1Y3RlZCBvYmplY3Qgd2lsbCBiZSBlbXB0eSwgYnV0IHN0aWxsCiAqIHZhbGlkLgogKiBAZXh0ZW5kcyB7anNwYi5NZXNzYWdlfQogKiBAY29uc3RydWN0b3IKICovCgoKcHJvdG8ucGIuY21zLkFkbWluRmlsZUNodW5rID0gZnVuY3Rpb24gKG9wdF9kYXRhKSB7CiAganNwYi5NZXNzYWdlLmluaXRpYWxpemUodGhpcywgb3B0X2RhdGEsIDAsIC0xLCBudWxsLCBudWxsKTsKfTsKCmdvb2cuaW5oZXJpdHMocHJvdG8ucGIuY21zLkFkbWluRmlsZUNodW5rLCBqc3BiLk1lc3NhZ2UpOwoKaWYgKGdvb2cuREVCVUcgJiYgIUNPTVBJTEVEKSB7CiAgLyoqCiAgICogQHB1YmxpYwogICAqIEBvdmVycmlkZQogICAqLwogIHByb3RvLnBiLmNtcy5BZG1pbkZpbGVDaHVuay5kaXNwbGF5TmFtZSA9ICdwcm90by5wYi5jbXMuQWRtaW5GaWxlQ2h1bmsnOwp9Ci8qKgogKiBMaXN0IG9mIHJlcGVhdGVkIGZpZWxkcyB3aXRoaW4gdGhpcyBtZXNzYWdlIHR5cGUuCiAqIEBwcml2YXRlIHshQXJyYXk8bnVtYmVyPn0KICogQGNvbnN0CiAqLwoKCnByb3RvLnBiLmNtcy5BcmVhTGlzdFJlcGx5LnJlcGVhdGVkRmllbGRzXyA9IFsxXTsKCmlmIChqc3BiLk1lc3NhZ2UuR0VORVJBVEVfVE9fT0JKRUNUKSB7CiAgLyoqCiAgICogQ3JlYXRlcyBhbiBvYmplY3QgcmVwcmVzZW50YXRpb24gb2YgdGhpcyBwcm90by4KICAgKiBGaWVsZCBuYW1lcyB0aGF0IGFyZSByZXNlcnZlZCBpbiBKYXZhU2NyaXB0IGFuZCB3aWxsIGJlIHJlbmFtZWQgdG8gcGJfbmFtZS4KICAgKiBPcHRpb25hbCBmaWVsZHMgdGhhdCBhcmUgbm90IHNldCB3aWxsIGJlIHNldCB0byB1bmRlZmluZWQuCiAgICogVG8gYWNjZXNzIGEgcmVzZXJ2ZWQgZmllbGQgdXNlLCBmb28ucGJfPG5hbWU+LCBlZywgZm9vLnBiX2RlZmF1bHQuCiAgICogRm9yIHRoZSBsaXN0IG9mIHJlc2VydmVkIG5hbWVzIHBsZWFzZSBzZWU6CiAgICogICAgIG5ldC9wcm90bzIvY29tcGlsZXIvanMvaW50ZXJuYWwvZ2VuZXJhdG9yLmNjI2tLZXl3b3JkLgogICAqIEBwYXJhbSB7Ym9vbGVhbj19IG9wdF9pbmNsdWRlSW5zdGFuY2UgRGVwcmVjYXRlZC4gd2hldGhlciB0byBpbmNsdWRlIHRoZQogICAqICAgICBKU1BCIGluc3RhbmNlIGZvciB0cmFuc2l0aW9uYWwgc295IHByb3RvIHN1cHBvcnQ6CiAgICogICAgIGh0dHA6Ly9nb3RvL3NveS1wYXJhbS1taWdyYXRpb24KICAgKiBAcmV0dXJuIHshT2JqZWN0fQogICAqLwogIHByb3RvLnBiLmNtcy5BcmVhTGlzdFJlcGx5LnByb3RvdHlwZS50b09iamVjdCA9IGZ1bmN0aW9uIChvcHRfaW5jbHVkZUluc3RhbmNlKSB7CiAgICByZXR1cm4gcHJvdG8ucGIuY21zLkFyZWFMaXN0UmVwbHkudG9PYmplY3Qob3B0X2luY2x1ZGVJbnN0YW5jZSwgdGhpcyk7CiAgfTsKICAvKioKICAgKiBTdGF0aWMgdmVyc2lvbiBvZiB0aGUge0BzZWUgdG9PYmplY3R9IG1ldGhvZC4KICAgKiBAcGFyYW0ge2Jvb2xlYW58dW5kZWZpbmVkfSBpbmNsdWRlSW5zdGFuY2UgRGVwcmVjYXRlZC4gV2hldGhlciB0byBpbmNsdWRlCiAgICogICAgIHRoZSBKU1BCIGluc3RhbmNlIGZvciB0cmFuc2l0aW9uYWwgc295IHByb3RvIHN1cHBvcnQ6CiAgICogICAgIGh0dHA6Ly9nb3RvL3NveS1wYXJhbS1taWdyYXRpb24KICAgKiBAcGFyYW0geyFwcm90by5wYi5jbXMuQXJlYUxpc3RSZXBseX0gbXNnIFRoZSBtc2cgaW5zdGFuY2UgdG8gdHJhbnNmb3JtLgogICAqIEByZXR1cm4geyFPYmplY3R9CiAgICogQHN1cHByZXNzIHt1bnVzZWRMb2NhbFZhcmlhYmxlc30gZiBpcyBvbmx5IHVzZWQgZm9yIG5lc3RlZCBtZXNzYWdlcwogICAqLwoKCiAgcHJvdG8ucGIuY21zLkFyZWFMaXN0UmVwbHkudG9PYmplY3QgPSBmdW5jdGlvbiAoaW5jbHVkZUluc3RhbmNlLCBtc2cpIHsKICAgIHZhciBmLAogICAgICAgIG9iaiA9IHsKICAgICAgYXJlYXNMaXN0OiBqc3BiLk1lc3NhZ2UudG9PYmplY3RMaXN0KG1zZy5nZXRBcmVhc0xpc3QoKSwgdXNlcnR5cGVfcGIuQXJlYS50b09iamVjdCwgaW5jbHVkZUluc3RhbmNlKQogICAgfTsKCiAgICBpZiAoaW5jbHVkZUluc3RhbmNlKSB7CiAgICAgIG9iai4kanNwYk1lc3NhZ2VJbnN0YW5jZSA9IG1zZzsKICAgIH0KCiAgICByZXR1cm4gb2JqOwogIH07Cn0KLyoqCiAqIERlc2VyaWFsaXplcyBiaW5hcnkgZGF0YSAoaW4gcHJvdG9idWYgd2lyZSBmb3JtYXQpLgogKiBAcGFyYW0ge2pzcGIuQnl0ZVNvdXJjZX0gYnl0ZXMgVGhlIGJ5dGVzIHRvIGRlc2VyaWFsaXplLgogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLkFyZWFMaXN0UmVwbHl9CiAqLwoKCnByb3RvLnBiLmNtcy5BcmVhTGlzdFJlcGx5LmRlc2VyaWFsaXplQmluYXJ5ID0gZnVuY3Rpb24gKGJ5dGVzKSB7CiAgdmFyIHJlYWRlciA9IG5ldyBqc3BiLkJpbmFyeVJlYWRlcihieXRlcyk7CiAgdmFyIG1zZyA9IG5ldyBwcm90by5wYi5jbXMuQXJlYUxpc3RSZXBseSgpOwogIHJldHVybiBwcm90by5wYi5jbXMuQXJlYUxpc3RSZXBseS5kZXNlcmlhbGl6ZUJpbmFyeUZyb21SZWFkZXIobXNnLCByZWFkZXIpOwp9OwovKioKICogRGVzZXJpYWxpemVzIGJpbmFyeSBkYXRhIChpbiBwcm90b2J1ZiB3aXJlIGZvcm1hdCkgZnJvbSB0aGUKICogZ2l2ZW4gcmVhZGVyIGludG8gdGhlIGdpdmVuIG1lc3NhZ2Ugb2JqZWN0LgogKiBAcGFyYW0geyFwcm90by5wYi5jbXMuQXJlYUxpc3RSZXBseX0gbXNnIFRoZSBtZXNzYWdlIG9iamVjdCB0byBkZXNlcmlhbGl6ZSBpbnRvLgogKiBAcGFyYW0geyFqc3BiLkJpbmFyeVJlYWRlcn0gcmVhZGVyIFRoZSBCaW5hcnlSZWFkZXIgdG8gdXNlLgogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLkFyZWFMaXN0UmVwbHl9CiAqLwoKCnByb3RvLnBiLmNtcy5BcmVhTGlzdFJlcGx5LmRlc2VyaWFsaXplQmluYXJ5RnJvbVJlYWRlciA9IGZ1bmN0aW9uIChtc2csIHJlYWRlcikgewogIHdoaWxlIChyZWFkZXIubmV4dEZpZWxkKCkpIHsKICAgIGlmIChyZWFkZXIuaXNFbmRHcm91cCgpKSB7CiAgICAgIGJyZWFrOwogICAgfQoKICAgIHZhciBmaWVsZCA9IHJlYWRlci5nZXRGaWVsZE51bWJlcigpOwoKICAgIHN3aXRjaCAoZmllbGQpIHsKICAgICAgY2FzZSAxOgogICAgICAgIHZhciB2YWx1ZSA9IG5ldyB1c2VydHlwZV9wYi5BcmVhKCk7CiAgICAgICAgcmVhZGVyLnJlYWRNZXNzYWdlKHZhbHVlLCB1c2VydHlwZV9wYi5BcmVhLmRlc2VyaWFsaXplQmluYXJ5RnJvbVJlYWRlcik7CiAgICAgICAgbXNnLmFkZEFyZWFzKHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGRlZmF1bHQ6CiAgICAgICAgcmVhZGVyLnNraXBGaWVsZCgpOwogICAgICAgIGJyZWFrOwogICAgfQogIH0KCiAgcmV0dXJuIG1zZzsKfTsKLyoqCiAqIFNlcmlhbGl6ZXMgdGhlIG1lc3NhZ2UgdG8gYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUgZm9ybWF0KS4KICogQHJldHVybiB7IVVpbnQ4QXJyYXl9CiAqLwoKCnByb3RvLnBiLmNtcy5BcmVhTGlzdFJlcGx5LnByb3RvdHlwZS5zZXJpYWxpemVCaW5hcnkgPSBmdW5jdGlvbiAoKSB7CiAgdmFyIHdyaXRlciA9IG5ldyBqc3BiLkJpbmFyeVdyaXRlcigpOwogIHByb3RvLnBiLmNtcy5BcmVhTGlzdFJlcGx5LnNlcmlhbGl6ZUJpbmFyeVRvV3JpdGVyKHRoaXMsIHdyaXRlcik7CiAgcmV0dXJuIHdyaXRlci5nZXRSZXN1bHRCdWZmZXIoKTsKfTsKLyoqCiAqIFNlcmlhbGl6ZXMgdGhlIGdpdmVuIG1lc3NhZ2UgdG8gYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUKICogZm9ybWF0KSwgd3JpdGluZyB0byB0aGUgZ2l2ZW4gQmluYXJ5V3JpdGVyLgogKiBAcGFyYW0geyFwcm90by5wYi5jbXMuQXJlYUxpc3RSZXBseX0gbWVzc2FnZQogKiBAcGFyYW0geyFqc3BiLkJpbmFyeVdyaXRlcn0gd3JpdGVyCiAqIEBzdXBwcmVzcyB7dW51c2VkTG9jYWxWYXJpYWJsZXN9IGYgaXMgb25seSB1c2VkIGZvciBuZXN0ZWQgbWVzc2FnZXMKICovCgoKcHJvdG8ucGIuY21zLkFyZWFMaXN0UmVwbHkuc2VyaWFsaXplQmluYXJ5VG9Xcml0ZXIgPSBmdW5jdGlvbiAobWVzc2FnZSwgd3JpdGVyKSB7CiAgdmFyIGYgPSB1bmRlZmluZWQ7CiAgZiA9IG1lc3NhZ2UuZ2V0QXJlYXNMaXN0KCk7CgogIGlmIChmLmxlbmd0aCA+IDApIHsKICAgIHdyaXRlci53cml0ZVJlcGVhdGVkTWVzc2FnZSgxLCBmLCB1c2VydHlwZV9wYi5BcmVhLnNlcmlhbGl6ZUJpbmFyeVRvV3JpdGVyKTsKICB9Cn07Ci8qKgogKiByZXBlYXRlZCBwYi5BcmVhIGFyZWFzID0gMTsKICogQHJldHVybiB7IUFycmF5PCFwcm90by5wYi5BcmVhPn0KICovCgoKcHJvdG8ucGIuY21zLkFyZWFMaXN0UmVwbHkucHJvdG90eXBlLmdldEFyZWFzTGlzdCA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldFJlcGVhdGVkV3JhcHBlckZpZWxkKHRoaXMsIHVzZXJ0eXBlX3BiLkFyZWEsIDEpOwp9OwovKioKICogQHBhcmFtIHshQXJyYXk8IXByb3RvLnBiLkFyZWE+fSB2YWx1ZQogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLkFyZWFMaXN0UmVwbHl9IHJldHVybnMgdGhpcwoqLwoKCnByb3RvLnBiLmNtcy5BcmVhTGlzdFJlcGx5LnByb3RvdHlwZS5zZXRBcmVhc0xpc3QgPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFJlcGVhdGVkV3JhcHBlckZpZWxkKHRoaXMsIDEsIHZhbHVlKTsKfTsKLyoqCiAqIEBwYXJhbSB7IXByb3RvLnBiLkFyZWE9fSBvcHRfdmFsdWUKICogQHBhcmFtIHtudW1iZXI9fSBvcHRfaW5kZXgKICogQHJldHVybiB7IXByb3RvLnBiLkFyZWF9CiAqLwoKCnByb3RvLnBiLmNtcy5BcmVhTGlzdFJlcGx5LnByb3RvdHlwZS5hZGRBcmVhcyA9IGZ1bmN0aW9uIChvcHRfdmFsdWUsIG9wdF9pbmRleCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuYWRkVG9SZXBlYXRlZFdyYXBwZXJGaWVsZCh0aGlzLCAxLCBvcHRfdmFsdWUsIHByb3RvLnBiLkFyZWEsIG9wdF9pbmRleCk7Cn07Ci8qKgogKiBDbGVhcnMgdGhlIGxpc3QgbWFraW5nIGl0IGVtcHR5IGJ1dCBub24tbnVsbC4KICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5BcmVhTGlzdFJlcGx5fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLkFyZWFMaXN0UmVwbHkucHJvdG90eXBlLmNsZWFyQXJlYXNMaXN0ID0gZnVuY3Rpb24gKCkgewogIHJldHVybiB0aGlzLnNldEFyZWFzTGlzdChbXSk7Cn07CgppZiAoanNwYi5NZXNzYWdlLkdFTkVSQVRFX1RPX09CSkVDVCkgewogIC8qKgogICAqIENyZWF0ZXMgYW4gb2JqZWN0IHJlcHJlc2VudGF0aW9uIG9mIHRoaXMgcHJvdG8uCiAgICogRmllbGQgbmFtZXMgdGhhdCBhcmUgcmVzZXJ2ZWQgaW4gSmF2YVNjcmlwdCBhbmQgd2lsbCBiZSByZW5hbWVkIHRvIHBiX25hbWUuCiAgICogT3B0aW9uYWwgZmllbGRzIHRoYXQgYXJlIG5vdCBzZXQgd2lsbCBiZSBzZXQgdG8gdW5kZWZpbmVkLgogICAqIFRvIGFjY2VzcyBhIHJlc2VydmVkIGZpZWxkIHVzZSwgZm9vLnBiXzxuYW1lPiwgZWcsIGZvby5wYl9kZWZhdWx0LgogICAqIEZvciB0aGUgbGlzdCBvZiByZXNlcnZlZCBuYW1lcyBwbGVhc2Ugc2VlOgogICAqICAgICBuZXQvcHJvdG8yL2NvbXBpbGVyL2pzL2ludGVybmFsL2dlbmVyYXRvci5jYyNrS2V5d29yZC4KICAgKiBAcGFyYW0ge2Jvb2xlYW49fSBvcHRfaW5jbHVkZUluc3RhbmNlIERlcHJlY2F0ZWQuIHdoZXRoZXIgdG8gaW5jbHVkZSB0aGUKICAgKiAgICAgSlNQQiBpbnN0YW5jZSBmb3IgdHJhbnNpdGlvbmFsIHNveSBwcm90byBzdXBwb3J0OgogICAqICAgICBodHRwOi8vZ290by9zb3ktcGFyYW0tbWlncmF0aW9uCiAgICogQHJldHVybiB7IU9iamVjdH0KICAgKi8KICBwcm90by5wYi5jbXMuTG9naW5SZXF1ZXN0LnByb3RvdHlwZS50b09iamVjdCA9IGZ1bmN0aW9uIChvcHRfaW5jbHVkZUluc3RhbmNlKSB7CiAgICByZXR1cm4gcHJvdG8ucGIuY21zLkxvZ2luUmVxdWVzdC50b09iamVjdChvcHRfaW5jbHVkZUluc3RhbmNlLCB0aGlzKTsKICB9OwogIC8qKgogICAqIFN0YXRpYyB2ZXJzaW9uIG9mIHRoZSB7QHNlZSB0b09iamVjdH0gbWV0aG9kLgogICAqIEBwYXJhbSB7Ym9vbGVhbnx1bmRlZmluZWR9IGluY2x1ZGVJbnN0YW5jZSBEZXByZWNhdGVkLiBXaGV0aGVyIHRvIGluY2x1ZGUKICAgKiAgICAgdGhlIEpTUEIgaW5zdGFuY2UgZm9yIHRyYW5zaXRpb25hbCBzb3kgcHJvdG8gc3VwcG9ydDoKICAgKiAgICAgaHR0cDovL2dvdG8vc295LXBhcmFtLW1pZ3JhdGlvbgogICAqIEBwYXJhbSB7IXByb3RvLnBiLmNtcy5Mb2dpblJlcXVlc3R9IG1zZyBUaGUgbXNnIGluc3RhbmNlIHRvIHRyYW5zZm9ybS4KICAgKiBAcmV0dXJuIHshT2JqZWN0fQogICAqIEBzdXBwcmVzcyB7dW51c2VkTG9jYWxWYXJpYWJsZXN9IGYgaXMgb25seSB1c2VkIGZvciBuZXN0ZWQgbWVzc2FnZXMKICAgKi8KCgogIHByb3RvLnBiLmNtcy5Mb2dpblJlcXVlc3QudG9PYmplY3QgPSBmdW5jdGlvbiAoaW5jbHVkZUluc3RhbmNlLCBtc2cpIHsKICAgIHZhciBmLAogICAgICAgIG9iaiA9IHsKICAgICAgZW1haWw6IGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KG1zZywgMSwgIiIpLAogICAgICBwYXNzd29yZDoganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQobXNnLCAyLCAiIikKICAgIH07CgogICAgaWYgKGluY2x1ZGVJbnN0YW5jZSkgewogICAgICBvYmouJGpzcGJNZXNzYWdlSW5zdGFuY2UgPSBtc2c7CiAgICB9CgogICAgcmV0dXJuIG9iajsKICB9Owp9Ci8qKgogKiBEZXNlcmlhbGl6ZXMgYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUgZm9ybWF0KS4KICogQHBhcmFtIHtqc3BiLkJ5dGVTb3VyY2V9IGJ5dGVzIFRoZSBieXRlcyB0byBkZXNlcmlhbGl6ZS4KICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5Mb2dpblJlcXVlc3R9CiAqLwoKCnByb3RvLnBiLmNtcy5Mb2dpblJlcXVlc3QuZGVzZXJpYWxpemVCaW5hcnkgPSBmdW5jdGlvbiAoYnl0ZXMpIHsKICB2YXIgcmVhZGVyID0gbmV3IGpzcGIuQmluYXJ5UmVhZGVyKGJ5dGVzKTsKICB2YXIgbXNnID0gbmV3IHByb3RvLnBiLmNtcy5Mb2dpblJlcXVlc3QoKTsKICByZXR1cm4gcHJvdG8ucGIuY21zLkxvZ2luUmVxdWVzdC5kZXNlcmlhbGl6ZUJpbmFyeUZyb21SZWFkZXIobXNnLCByZWFkZXIpOwp9OwovKioKICogRGVzZXJpYWxpemVzIGJpbmFyeSBkYXRhIChpbiBwcm90b2J1ZiB3aXJlIGZvcm1hdCkgZnJvbSB0aGUKICogZ2l2ZW4gcmVhZGVyIGludG8gdGhlIGdpdmVuIG1lc3NhZ2Ugb2JqZWN0LgogKiBAcGFyYW0geyFwcm90by5wYi5jbXMuTG9naW5SZXF1ZXN0fSBtc2cgVGhlIG1lc3NhZ2Ugb2JqZWN0IHRvIGRlc2VyaWFsaXplIGludG8uCiAqIEBwYXJhbSB7IWpzcGIuQmluYXJ5UmVhZGVyfSByZWFkZXIgVGhlIEJpbmFyeVJlYWRlciB0byB1c2UuCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuTG9naW5SZXF1ZXN0fQogKi8KCgpwcm90by5wYi5jbXMuTG9naW5SZXF1ZXN0LmRlc2VyaWFsaXplQmluYXJ5RnJvbVJlYWRlciA9IGZ1bmN0aW9uIChtc2csIHJlYWRlcikgewogIHdoaWxlIChyZWFkZXIubmV4dEZpZWxkKCkpIHsKICAgIGlmIChyZWFkZXIuaXNFbmRHcm91cCgpKSB7CiAgICAgIGJyZWFrOwogICAgfQoKICAgIHZhciBmaWVsZCA9IHJlYWRlci5nZXRGaWVsZE51bWJlcigpOwoKICAgIHN3aXRjaCAoZmllbGQpIHsKICAgICAgY2FzZSAxOgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkU3RyaW5nKCk7CiAgICAgICAgbXNnLnNldEVtYWlsKHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgMjoKICAgICAgICB2YXIgdmFsdWUgPSByZWFkZXIucmVhZFN0cmluZygpOwogICAgICAgIG1zZy5zZXRQYXNzd29yZCh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBkZWZhdWx0OgogICAgICAgIHJlYWRlci5za2lwRmllbGQoKTsKICAgICAgICBicmVhazsKICAgIH0KICB9CgogIHJldHVybiBtc2c7Cn07Ci8qKgogKiBTZXJpYWxpemVzIHRoZSBtZXNzYWdlIHRvIGJpbmFyeSBkYXRhIChpbiBwcm90b2J1ZiB3aXJlIGZvcm1hdCkuCiAqIEByZXR1cm4geyFVaW50OEFycmF5fQogKi8KCgpwcm90by5wYi5jbXMuTG9naW5SZXF1ZXN0LnByb3RvdHlwZS5zZXJpYWxpemVCaW5hcnkgPSBmdW5jdGlvbiAoKSB7CiAgdmFyIHdyaXRlciA9IG5ldyBqc3BiLkJpbmFyeVdyaXRlcigpOwogIHByb3RvLnBiLmNtcy5Mb2dpblJlcXVlc3Quc2VyaWFsaXplQmluYXJ5VG9Xcml0ZXIodGhpcywgd3JpdGVyKTsKICByZXR1cm4gd3JpdGVyLmdldFJlc3VsdEJ1ZmZlcigpOwp9OwovKioKICogU2VyaWFsaXplcyB0aGUgZ2l2ZW4gbWVzc2FnZSB0byBiaW5hcnkgZGF0YSAoaW4gcHJvdG9idWYgd2lyZQogKiBmb3JtYXQpLCB3cml0aW5nIHRvIHRoZSBnaXZlbiBCaW5hcnlXcml0ZXIuCiAqIEBwYXJhbSB7IXByb3RvLnBiLmNtcy5Mb2dpblJlcXVlc3R9IG1lc3NhZ2UKICogQHBhcmFtIHshanNwYi5CaW5hcnlXcml0ZXJ9IHdyaXRlcgogKiBAc3VwcHJlc3Mge3VudXNlZExvY2FsVmFyaWFibGVzfSBmIGlzIG9ubHkgdXNlZCBmb3IgbmVzdGVkIG1lc3NhZ2VzCiAqLwoKCnByb3RvLnBiLmNtcy5Mb2dpblJlcXVlc3Quc2VyaWFsaXplQmluYXJ5VG9Xcml0ZXIgPSBmdW5jdGlvbiAobWVzc2FnZSwgd3JpdGVyKSB7CiAgdmFyIGYgPSB1bmRlZmluZWQ7CiAgZiA9IG1lc3NhZ2UuZ2V0RW1haWwoKTsKCiAgaWYgKGYubGVuZ3RoID4gMCkgewogICAgd3JpdGVyLndyaXRlU3RyaW5nKDEsIGYpOwogIH0KCiAgZiA9IG1lc3NhZ2UuZ2V0UGFzc3dvcmQoKTsKCiAgaWYgKGYubGVuZ3RoID4gMCkgewogICAgd3JpdGVyLndyaXRlU3RyaW5nKDIsIGYpOwogIH0KfTsKLyoqCiAqIG9wdGlvbmFsIHN0cmluZyBlbWFpbCA9IDE7CiAqIEByZXR1cm4ge3N0cmluZ30KICovCgoKcHJvdG8ucGIuY21zLkxvZ2luUmVxdWVzdC5wcm90b3R5cGUuZ2V0RW1haWwgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDEsICIiKTsKfTsKLyoqCiAqIEBwYXJhbSB7c3RyaW5nfSB2YWx1ZQogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLkxvZ2luUmVxdWVzdH0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5Mb2dpblJlcXVlc3QucHJvdG90eXBlLnNldEVtYWlsID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRQcm90bzNTdHJpbmdGaWVsZCh0aGlzLCAxLCB2YWx1ZSk7Cn07Ci8qKgogKiBvcHRpb25hbCBzdHJpbmcgcGFzc3dvcmQgPSAyOwogKiBAcmV0dXJuIHtzdHJpbmd9CiAqLwoKCnByb3RvLnBiLmNtcy5Mb2dpblJlcXVlc3QucHJvdG90eXBlLmdldFBhc3N3b3JkID0gZnVuY3Rpb24gKCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdCh0aGlzLCAyLCAiIik7Cn07Ci8qKgogKiBAcGFyYW0ge3N0cmluZ30gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5Mb2dpblJlcXVlc3R9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuTG9naW5SZXF1ZXN0LnByb3RvdHlwZS5zZXRQYXNzd29yZCA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UHJvdG8zU3RyaW5nRmllbGQodGhpcywgMiwgdmFsdWUpOwp9OwovKioKICogTGlzdCBvZiByZXBlYXRlZCBmaWVsZHMgd2l0aGluIHRoaXMgbWVzc2FnZSB0eXBlLgogKiBAcHJpdmF0ZSB7IUFycmF5PG51bWJlcj59CiAqIEBjb25zdAogKi8KCgpwcm90by5wYi5jbXMuQWRtaW5MaXN0UmVwbHkucmVwZWF0ZWRGaWVsZHNfID0gWzFdOwoKaWYgKGpzcGIuTWVzc2FnZS5HRU5FUkFURV9UT19PQkpFQ1QpIHsKICAvKioKICAgKiBDcmVhdGVzIGFuIG9iamVjdCByZXByZXNlbnRhdGlvbiBvZiB0aGlzIHByb3RvLgogICAqIEZpZWxkIG5hbWVzIHRoYXQgYXJlIHJlc2VydmVkIGluIEphdmFTY3JpcHQgYW5kIHdpbGwgYmUgcmVuYW1lZCB0byBwYl9uYW1lLgogICAqIE9wdGlvbmFsIGZpZWxkcyB0aGF0IGFyZSBub3Qgc2V0IHdpbGwgYmUgc2V0IHRvIHVuZGVmaW5lZC4KICAgKiBUbyBhY2Nlc3MgYSByZXNlcnZlZCBmaWVsZCB1c2UsIGZvby5wYl88bmFtZT4sIGVnLCBmb28ucGJfZGVmYXVsdC4KICAgKiBGb3IgdGhlIGxpc3Qgb2YgcmVzZXJ2ZWQgbmFtZXMgcGxlYXNlIHNlZToKICAgKiAgICAgbmV0L3Byb3RvMi9jb21waWxlci9qcy9pbnRlcm5hbC9nZW5lcmF0b3IuY2Mja0tleXdvcmQuCiAgICogQHBhcmFtIHtib29sZWFuPX0gb3B0X2luY2x1ZGVJbnN0YW5jZSBEZXByZWNhdGVkLiB3aGV0aGVyIHRvIGluY2x1ZGUgdGhlCiAgICogICAgIEpTUEIgaW5zdGFuY2UgZm9yIHRyYW5zaXRpb25hbCBzb3kgcHJvdG8gc3VwcG9ydDoKICAgKiAgICAgaHR0cDovL2dvdG8vc295LXBhcmFtLW1pZ3JhdGlvbgogICAqIEByZXR1cm4geyFPYmplY3R9CiAgICovCiAgcHJvdG8ucGIuY21zLkFkbWluTGlzdFJlcGx5LnByb3RvdHlwZS50b09iamVjdCA9IGZ1bmN0aW9uIChvcHRfaW5jbHVkZUluc3RhbmNlKSB7CiAgICByZXR1cm4gcHJvdG8ucGIuY21zLkFkbWluTGlzdFJlcGx5LnRvT2JqZWN0KG9wdF9pbmNsdWRlSW5zdGFuY2UsIHRoaXMpOwogIH07CiAgLyoqCiAgICogU3RhdGljIHZlcnNpb24gb2YgdGhlIHtAc2VlIHRvT2JqZWN0fSBtZXRob2QuCiAgICogQHBhcmFtIHtib29sZWFufHVuZGVmaW5lZH0gaW5jbHVkZUluc3RhbmNlIERlcHJlY2F0ZWQuIFdoZXRoZXIgdG8gaW5jbHVkZQogICAqICAgICB0aGUgSlNQQiBpbnN0YW5jZSBmb3IgdHJhbnNpdGlvbmFsIHNveSBwcm90byBzdXBwb3J0OgogICAqICAgICBodHRwOi8vZ290by9zb3ktcGFyYW0tbWlncmF0aW9uCiAgICogQHBhcmFtIHshcHJvdG8ucGIuY21zLkFkbWluTGlzdFJlcGx5fSBtc2cgVGhlIG1zZyBpbnN0YW5jZSB0byB0cmFuc2Zvcm0uCiAgICogQHJldHVybiB7IU9iamVjdH0KICAgKiBAc3VwcHJlc3Mge3VudXNlZExvY2FsVmFyaWFibGVzfSBmIGlzIG9ubHkgdXNlZCBmb3IgbmVzdGVkIG1lc3NhZ2VzCiAgICovCgoKICBwcm90by5wYi5jbXMuQWRtaW5MaXN0UmVwbHkudG9PYmplY3QgPSBmdW5jdGlvbiAoaW5jbHVkZUluc3RhbmNlLCBtc2cpIHsKICAgIHZhciBmLAogICAgICAgIG9iaiA9IHsKICAgICAgYWRtaW5zTGlzdDoganNwYi5NZXNzYWdlLnRvT2JqZWN0TGlzdChtc2cuZ2V0QWRtaW5zTGlzdCgpLCBjbXN0eXBlX3BiLkFkbWluLnRvT2JqZWN0LCBpbmNsdWRlSW5zdGFuY2UpCiAgICB9OwoKICAgIGlmIChpbmNsdWRlSW5zdGFuY2UpIHsKICAgICAgb2JqLiRqc3BiTWVzc2FnZUluc3RhbmNlID0gbXNnOwogICAgfQoKICAgIHJldHVybiBvYmo7CiAgfTsKfQovKioKICogRGVzZXJpYWxpemVzIGJpbmFyeSBkYXRhIChpbiBwcm90b2J1ZiB3aXJlIGZvcm1hdCkuCiAqIEBwYXJhbSB7anNwYi5CeXRlU291cmNlfSBieXRlcyBUaGUgYnl0ZXMgdG8gZGVzZXJpYWxpemUuCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuQWRtaW5MaXN0UmVwbHl9CiAqLwoKCnByb3RvLnBiLmNtcy5BZG1pbkxpc3RSZXBseS5kZXNlcmlhbGl6ZUJpbmFyeSA9IGZ1bmN0aW9uIChieXRlcykgewogIHZhciByZWFkZXIgPSBuZXcganNwYi5CaW5hcnlSZWFkZXIoYnl0ZXMpOwogIHZhciBtc2cgPSBuZXcgcHJvdG8ucGIuY21zLkFkbWluTGlzdFJlcGx5KCk7CiAgcmV0dXJuIHByb3RvLnBiLmNtcy5BZG1pbkxpc3RSZXBseS5kZXNlcmlhbGl6ZUJpbmFyeUZyb21SZWFkZXIobXNnLCByZWFkZXIpOwp9OwovKioKICogRGVzZXJpYWxpemVzIGJpbmFyeSBkYXRhIChpbiBwcm90b2J1ZiB3aXJlIGZvcm1hdCkgZnJvbSB0aGUKICogZ2l2ZW4gcmVhZGVyIGludG8gdGhlIGdpdmVuIG1lc3NhZ2Ugb2JqZWN0LgogKiBAcGFyYW0geyFwcm90by5wYi5jbXMuQWRtaW5MaXN0UmVwbHl9IG1zZyBUaGUgbWVzc2FnZSBvYmplY3QgdG8gZGVzZXJpYWxpemUgaW50by4KICogQHBhcmFtIHshanNwYi5CaW5hcnlSZWFkZXJ9IHJlYWRlciBUaGUgQmluYXJ5UmVhZGVyIHRvIHVzZS4KICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5BZG1pbkxpc3RSZXBseX0KICovCgoKcHJvdG8ucGIuY21zLkFkbWluTGlzdFJlcGx5LmRlc2VyaWFsaXplQmluYXJ5RnJvbVJlYWRlciA9IGZ1bmN0aW9uIChtc2csIHJlYWRlcikgewogIHdoaWxlIChyZWFkZXIubmV4dEZpZWxkKCkpIHsKICAgIGlmIChyZWFkZXIuaXNFbmRHcm91cCgpKSB7CiAgICAgIGJyZWFrOwogICAgfQoKICAgIHZhciBmaWVsZCA9IHJlYWRlci5nZXRGaWVsZE51bWJlcigpOwoKICAgIHN3aXRjaCAoZmllbGQpIHsKICAgICAgY2FzZSAxOgogICAgICAgIHZhciB2YWx1ZSA9IG5ldyBjbXN0eXBlX3BiLkFkbWluKCk7CiAgICAgICAgcmVhZGVyLnJlYWRNZXNzYWdlKHZhbHVlLCBjbXN0eXBlX3BiLkFkbWluLmRlc2VyaWFsaXplQmluYXJ5RnJvbVJlYWRlcik7CiAgICAgICAgbXNnLmFkZEFkbWlucyh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBkZWZhdWx0OgogICAgICAgIHJlYWRlci5za2lwRmllbGQoKTsKICAgICAgICBicmVhazsKICAgIH0KICB9CgogIHJldHVybiBtc2c7Cn07Ci8qKgogKiBTZXJpYWxpemVzIHRoZSBtZXNzYWdlIHRvIGJpbmFyeSBkYXRhIChpbiBwcm90b2J1ZiB3aXJlIGZvcm1hdCkuCiAqIEByZXR1cm4geyFVaW50OEFycmF5fQogKi8KCgpwcm90by5wYi5jbXMuQWRtaW5MaXN0UmVwbHkucHJvdG90eXBlLnNlcmlhbGl6ZUJpbmFyeSA9IGZ1bmN0aW9uICgpIHsKICB2YXIgd3JpdGVyID0gbmV3IGpzcGIuQmluYXJ5V3JpdGVyKCk7CiAgcHJvdG8ucGIuY21zLkFkbWluTGlzdFJlcGx5LnNlcmlhbGl6ZUJpbmFyeVRvV3JpdGVyKHRoaXMsIHdyaXRlcik7CiAgcmV0dXJuIHdyaXRlci5nZXRSZXN1bHRCdWZmZXIoKTsKfTsKLyoqCiAqIFNlcmlhbGl6ZXMgdGhlIGdpdmVuIG1lc3NhZ2UgdG8gYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUKICogZm9ybWF0KSwgd3JpdGluZyB0byB0aGUgZ2l2ZW4gQmluYXJ5V3JpdGVyLgogKiBAcGFyYW0geyFwcm90by5wYi5jbXMuQWRtaW5MaXN0UmVwbHl9IG1lc3NhZ2UKICogQHBhcmFtIHshanNwYi5CaW5hcnlXcml0ZXJ9IHdyaXRlcgogKiBAc3VwcHJlc3Mge3VudXNlZExvY2FsVmFyaWFibGVzfSBmIGlzIG9ubHkgdXNlZCBmb3IgbmVzdGVkIG1lc3NhZ2VzCiAqLwoKCnByb3RvLnBiLmNtcy5BZG1pbkxpc3RSZXBseS5zZXJpYWxpemVCaW5hcnlUb1dyaXRlciA9IGZ1bmN0aW9uIChtZXNzYWdlLCB3cml0ZXIpIHsKICB2YXIgZiA9IHVuZGVmaW5lZDsKICBmID0gbWVzc2FnZS5nZXRBZG1pbnNMaXN0KCk7CgogIGlmIChmLmxlbmd0aCA+IDApIHsKICAgIHdyaXRlci53cml0ZVJlcGVhdGVkTWVzc2FnZSgxLCBmLCBjbXN0eXBlX3BiLkFkbWluLnNlcmlhbGl6ZUJpbmFyeVRvV3JpdGVyKTsKICB9Cn07Ci8qKgogKiByZXBlYXRlZCBwYi5BZG1pbiBhZG1pbnMgPSAxOwogKiBAcmV0dXJuIHshQXJyYXk8IXByb3RvLnBiLkFkbWluPn0KICovCgoKcHJvdG8ucGIuY21zLkFkbWluTGlzdFJlcGx5LnByb3RvdHlwZS5nZXRBZG1pbnNMaXN0ID0gZnVuY3Rpb24gKCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuZ2V0UmVwZWF0ZWRXcmFwcGVyRmllbGQodGhpcywgY21zdHlwZV9wYi5BZG1pbiwgMSk7Cn07Ci8qKgogKiBAcGFyYW0geyFBcnJheTwhcHJvdG8ucGIuQWRtaW4+fSB2YWx1ZQogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLkFkbWluTGlzdFJlcGx5fSByZXR1cm5zIHRoaXMKKi8KCgpwcm90by5wYi5jbXMuQWRtaW5MaXN0UmVwbHkucHJvdG90eXBlLnNldEFkbWluc0xpc3QgPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFJlcGVhdGVkV3JhcHBlckZpZWxkKHRoaXMsIDEsIHZhbHVlKTsKfTsKLyoqCiAqIEBwYXJhbSB7IXByb3RvLnBiLkFkbWluPX0gb3B0X3ZhbHVlCiAqIEBwYXJhbSB7bnVtYmVyPX0gb3B0X2luZGV4CiAqIEByZXR1cm4geyFwcm90by5wYi5BZG1pbn0KICovCgoKcHJvdG8ucGIuY21zLkFkbWluTGlzdFJlcGx5LnByb3RvdHlwZS5hZGRBZG1pbnMgPSBmdW5jdGlvbiAob3B0X3ZhbHVlLCBvcHRfaW5kZXgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmFkZFRvUmVwZWF0ZWRXcmFwcGVyRmllbGQodGhpcywgMSwgb3B0X3ZhbHVlLCBwcm90by5wYi5BZG1pbiwgb3B0X2luZGV4KTsKfTsKLyoqCiAqIENsZWFycyB0aGUgbGlzdCBtYWtpbmcgaXQgZW1wdHkgYnV0IG5vbi1udWxsLgogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLkFkbWluTGlzdFJlcGx5fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLkFkbWluTGlzdFJlcGx5LnByb3RvdHlwZS5jbGVhckFkbWluc0xpc3QgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIHRoaXMuc2V0QWRtaW5zTGlzdChbXSk7Cn07Ci8qKgogKiBMaXN0IG9mIHJlcGVhdGVkIGZpZWxkcyB3aXRoaW4gdGhpcyBtZXNzYWdlIHR5cGUuCiAqIEBwcml2YXRlIHshQXJyYXk8bnVtYmVyPn0KICogQGNvbnN0CiAqLwoKCnByb3RvLnBiLmNtcy5HdWlsZExpc3RSZXBseS5yZXBlYXRlZEZpZWxkc18gPSBbMV07CgppZiAoanNwYi5NZXNzYWdlLkdFTkVSQVRFX1RPX09CSkVDVCkgewogIC8qKgogICAqIENyZWF0ZXMgYW4gb2JqZWN0IHJlcHJlc2VudGF0aW9uIG9mIHRoaXMgcHJvdG8uCiAgICogRmllbGQgbmFtZXMgdGhhdCBhcmUgcmVzZXJ2ZWQgaW4gSmF2YVNjcmlwdCBhbmQgd2lsbCBiZSByZW5hbWVkIHRvIHBiX25hbWUuCiAgICogT3B0aW9uYWwgZmllbGRzIHRoYXQgYXJlIG5vdCBzZXQgd2lsbCBiZSBzZXQgdG8gdW5kZWZpbmVkLgogICAqIFRvIGFjY2VzcyBhIHJlc2VydmVkIGZpZWxkIHVzZSwgZm9vLnBiXzxuYW1lPiwgZWcsIGZvby5wYl9kZWZhdWx0LgogICAqIEZvciB0aGUgbGlzdCBvZiByZXNlcnZlZCBuYW1lcyBwbGVhc2Ugc2VlOgogICAqICAgICBuZXQvcHJvdG8yL2NvbXBpbGVyL2pzL2ludGVybmFsL2dlbmVyYXRvci5jYyNrS2V5d29yZC4KICAgKiBAcGFyYW0ge2Jvb2xlYW49fSBvcHRfaW5jbHVkZUluc3RhbmNlIERlcHJlY2F0ZWQuIHdoZXRoZXIgdG8gaW5jbHVkZSB0aGUKICAgKiAgICAgSlNQQiBpbnN0YW5jZSBmb3IgdHJhbnNpdGlvbmFsIHNveSBwcm90byBzdXBwb3J0OgogICAqICAgICBodHRwOi8vZ290by9zb3ktcGFyYW0tbWlncmF0aW9uCiAgICogQHJldHVybiB7IU9iamVjdH0KICAgKi8KICBwcm90by5wYi5jbXMuR3VpbGRMaXN0UmVwbHkucHJvdG90eXBlLnRvT2JqZWN0ID0gZnVuY3Rpb24gKG9wdF9pbmNsdWRlSW5zdGFuY2UpIHsKICAgIHJldHVybiBwcm90by5wYi5jbXMuR3VpbGRMaXN0UmVwbHkudG9PYmplY3Qob3B0X2luY2x1ZGVJbnN0YW5jZSwgdGhpcyk7CiAgfTsKICAvKioKICAgKiBTdGF0aWMgdmVyc2lvbiBvZiB0aGUge0BzZWUgdG9PYmplY3R9IG1ldGhvZC4KICAgKiBAcGFyYW0ge2Jvb2xlYW58dW5kZWZpbmVkfSBpbmNsdWRlSW5zdGFuY2UgRGVwcmVjYXRlZC4gV2hldGhlciB0byBpbmNsdWRlCiAgICogICAgIHRoZSBKU1BCIGluc3RhbmNlIGZvciB0cmFuc2l0aW9uYWwgc295IHByb3RvIHN1cHBvcnQ6CiAgICogICAgIGh0dHA6Ly9nb3RvL3NveS1wYXJhbS1taWdyYXRpb24KICAgKiBAcGFyYW0geyFwcm90by5wYi5jbXMuR3VpbGRMaXN0UmVwbHl9IG1zZyBUaGUgbXNnIGluc3RhbmNlIHRvIHRyYW5zZm9ybS4KICAgKiBAcmV0dXJuIHshT2JqZWN0fQogICAqIEBzdXBwcmVzcyB7dW51c2VkTG9jYWxWYXJpYWJsZXN9IGYgaXMgb25seSB1c2VkIGZvciBuZXN0ZWQgbWVzc2FnZXMKICAgKi8KCgogIHByb3RvLnBiLmNtcy5HdWlsZExpc3RSZXBseS50b09iamVjdCA9IGZ1bmN0aW9uIChpbmNsdWRlSW5zdGFuY2UsIG1zZykgewogICAgdmFyIGYsCiAgICAgICAgb2JqID0gewogICAgICBndWlsZHNMaXN0OiBqc3BiLk1lc3NhZ2UudG9PYmplY3RMaXN0KG1zZy5nZXRHdWlsZHNMaXN0KCksIGNtc3R5cGVfcGIuR3VpbGQudG9PYmplY3QsIGluY2x1ZGVJbnN0YW5jZSkKICAgIH07CgogICAgaWYgKGluY2x1ZGVJbnN0YW5jZSkgewogICAgICBvYmouJGpzcGJNZXNzYWdlSW5zdGFuY2UgPSBtc2c7CiAgICB9CgogICAgcmV0dXJuIG9iajsKICB9Owp9Ci8qKgogKiBEZXNlcmlhbGl6ZXMgYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUgZm9ybWF0KS4KICogQHBhcmFtIHtqc3BiLkJ5dGVTb3VyY2V9IGJ5dGVzIFRoZSBieXRlcyB0byBkZXNlcmlhbGl6ZS4KICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5HdWlsZExpc3RSZXBseX0KICovCgoKcHJvdG8ucGIuY21zLkd1aWxkTGlzdFJlcGx5LmRlc2VyaWFsaXplQmluYXJ5ID0gZnVuY3Rpb24gKGJ5dGVzKSB7CiAgdmFyIHJlYWRlciA9IG5ldyBqc3BiLkJpbmFyeVJlYWRlcihieXRlcyk7CiAgdmFyIG1zZyA9IG5ldyBwcm90by5wYi5jbXMuR3VpbGRMaXN0UmVwbHkoKTsKICByZXR1cm4gcHJvdG8ucGIuY21zLkd1aWxkTGlzdFJlcGx5LmRlc2VyaWFsaXplQmluYXJ5RnJvbVJlYWRlcihtc2csIHJlYWRlcik7Cn07Ci8qKgogKiBEZXNlcmlhbGl6ZXMgYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUgZm9ybWF0KSBmcm9tIHRoZQogKiBnaXZlbiByZWFkZXIgaW50byB0aGUgZ2l2ZW4gbWVzc2FnZSBvYmplY3QuCiAqIEBwYXJhbSB7IXByb3RvLnBiLmNtcy5HdWlsZExpc3RSZXBseX0gbXNnIFRoZSBtZXNzYWdlIG9iamVjdCB0byBkZXNlcmlhbGl6ZSBpbnRvLgogKiBAcGFyYW0geyFqc3BiLkJpbmFyeVJlYWRlcn0gcmVhZGVyIFRoZSBCaW5hcnlSZWFkZXIgdG8gdXNlLgogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLkd1aWxkTGlzdFJlcGx5fQogKi8KCgpwcm90by5wYi5jbXMuR3VpbGRMaXN0UmVwbHkuZGVzZXJpYWxpemVCaW5hcnlGcm9tUmVhZGVyID0gZnVuY3Rpb24gKG1zZywgcmVhZGVyKSB7CiAgd2hpbGUgKHJlYWRlci5uZXh0RmllbGQoKSkgewogICAgaWYgKHJlYWRlci5pc0VuZEdyb3VwKCkpIHsKICAgICAgYnJlYWs7CiAgICB9CgogICAgdmFyIGZpZWxkID0gcmVhZGVyLmdldEZpZWxkTnVtYmVyKCk7CgogICAgc3dpdGNoIChmaWVsZCkgewogICAgICBjYXNlIDE6CiAgICAgICAgdmFyIHZhbHVlID0gbmV3IGNtc3R5cGVfcGIuR3VpbGQoKTsKICAgICAgICByZWFkZXIucmVhZE1lc3NhZ2UodmFsdWUsIGNtc3R5cGVfcGIuR3VpbGQuZGVzZXJpYWxpemVCaW5hcnlGcm9tUmVhZGVyKTsKICAgICAgICBtc2cuYWRkR3VpbGRzKHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGRlZmF1bHQ6CiAgICAgICAgcmVhZGVyLnNraXBGaWVsZCgpOwogICAgICAgIGJyZWFrOwogICAgfQogIH0KCiAgcmV0dXJuIG1zZzsKfTsKLyoqCiAqIFNlcmlhbGl6ZXMgdGhlIG1lc3NhZ2UgdG8gYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUgZm9ybWF0KS4KICogQHJldHVybiB7IVVpbnQ4QXJyYXl9CiAqLwoKCnByb3RvLnBiLmNtcy5HdWlsZExpc3RSZXBseS5wcm90b3R5cGUuc2VyaWFsaXplQmluYXJ5ID0gZnVuY3Rpb24gKCkgewogIHZhciB3cml0ZXIgPSBuZXcganNwYi5CaW5hcnlXcml0ZXIoKTsKICBwcm90by5wYi5jbXMuR3VpbGRMaXN0UmVwbHkuc2VyaWFsaXplQmluYXJ5VG9Xcml0ZXIodGhpcywgd3JpdGVyKTsKICByZXR1cm4gd3JpdGVyLmdldFJlc3VsdEJ1ZmZlcigpOwp9OwovKioKICogU2VyaWFsaXplcyB0aGUgZ2l2ZW4gbWVzc2FnZSB0byBiaW5hcnkgZGF0YSAoaW4gcHJvdG9idWYgd2lyZQogKiBmb3JtYXQpLCB3cml0aW5nIHRvIHRoZSBnaXZlbiBCaW5hcnlXcml0ZXIuCiAqIEBwYXJhbSB7IXByb3RvLnBiLmNtcy5HdWlsZExpc3RSZXBseX0gbWVzc2FnZQogKiBAcGFyYW0geyFqc3BiLkJpbmFyeVdyaXRlcn0gd3JpdGVyCiAqIEBzdXBwcmVzcyB7dW51c2VkTG9jYWxWYXJpYWJsZXN9IGYgaXMgb25seSB1c2VkIGZvciBuZXN0ZWQgbWVzc2FnZXMKICovCgoKcHJvdG8ucGIuY21zLkd1aWxkTGlzdFJlcGx5LnNlcmlhbGl6ZUJpbmFyeVRvV3JpdGVyID0gZnVuY3Rpb24gKG1lc3NhZ2UsIHdyaXRlcikgewogIHZhciBmID0gdW5kZWZpbmVkOwogIGYgPSBtZXNzYWdlLmdldEd1aWxkc0xpc3QoKTsKCiAgaWYgKGYubGVuZ3RoID4gMCkgewogICAgd3JpdGVyLndyaXRlUmVwZWF0ZWRNZXNzYWdlKDEsIGYsIGNtc3R5cGVfcGIuR3VpbGQuc2VyaWFsaXplQmluYXJ5VG9Xcml0ZXIpOwogIH0KfTsKLyoqCiAqIHJlcGVhdGVkIHBiLkd1aWxkIGd1aWxkcyA9IDE7CiAqIEByZXR1cm4geyFBcnJheTwhcHJvdG8ucGIuR3VpbGQ+fQogKi8KCgpwcm90by5wYi5jbXMuR3VpbGRMaXN0UmVwbHkucHJvdG90eXBlLmdldEd1aWxkc0xpc3QgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRSZXBlYXRlZFdyYXBwZXJGaWVsZCh0aGlzLCBjbXN0eXBlX3BiLkd1aWxkLCAxKTsKfTsKLyoqCiAqIEBwYXJhbSB7IUFycmF5PCFwcm90by5wYi5HdWlsZD59IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuR3VpbGRMaXN0UmVwbHl9IHJldHVybnMgdGhpcwoqLwoKCnByb3RvLnBiLmNtcy5HdWlsZExpc3RSZXBseS5wcm90b3R5cGUuc2V0R3VpbGRzTGlzdCA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UmVwZWF0ZWRXcmFwcGVyRmllbGQodGhpcywgMSwgdmFsdWUpOwp9OwovKioKICogQHBhcmFtIHshcHJvdG8ucGIuR3VpbGQ9fSBvcHRfdmFsdWUKICogQHBhcmFtIHtudW1iZXI9fSBvcHRfaW5kZXgKICogQHJldHVybiB7IXByb3RvLnBiLkd1aWxkfQogKi8KCgpwcm90by5wYi5jbXMuR3VpbGRMaXN0UmVwbHkucHJvdG90eXBlLmFkZEd1aWxkcyA9IGZ1bmN0aW9uIChvcHRfdmFsdWUsIG9wdF9pbmRleCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuYWRkVG9SZXBlYXRlZFdyYXBwZXJGaWVsZCh0aGlzLCAxLCBvcHRfdmFsdWUsIHByb3RvLnBiLkd1aWxkLCBvcHRfaW5kZXgpOwp9OwovKioKICogQ2xlYXJzIHRoZSBsaXN0IG1ha2luZyBpdCBlbXB0eSBidXQgbm9uLW51bGwuCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuR3VpbGRMaXN0UmVwbHl9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuR3VpbGRMaXN0UmVwbHkucHJvdG90eXBlLmNsZWFyR3VpbGRzTGlzdCA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4gdGhpcy5zZXRHdWlsZHNMaXN0KFtdKTsKfTsKLyoqCiAqIExpc3Qgb2YgcmVwZWF0ZWQgZmllbGRzIHdpdGhpbiB0aGlzIG1lc3NhZ2UgdHlwZS4KICogQHByaXZhdGUgeyFBcnJheTxudW1iZXI+fQogKiBAY29uc3QKICovCgoKcHJvdG8ucGIuY21zLkFwcExpc3RSZXBseS5yZXBlYXRlZEZpZWxkc18gPSBbMV07CgppZiAoanNwYi5NZXNzYWdlLkdFTkVSQVRFX1RPX09CSkVDVCkgewogIC8qKgogICAqIENyZWF0ZXMgYW4gb2JqZWN0IHJlcHJlc2VudGF0aW9uIG9mIHRoaXMgcHJvdG8uCiAgICogRmllbGQgbmFtZXMgdGhhdCBhcmUgcmVzZXJ2ZWQgaW4gSmF2YVNjcmlwdCBhbmQgd2lsbCBiZSByZW5hbWVkIHRvIHBiX25hbWUuCiAgICogT3B0aW9uYWwgZmllbGRzIHRoYXQgYXJlIG5vdCBzZXQgd2lsbCBiZSBzZXQgdG8gdW5kZWZpbmVkLgogICAqIFRvIGFjY2VzcyBhIHJlc2VydmVkIGZpZWxkIHVzZSwgZm9vLnBiXzxuYW1lPiwgZWcsIGZvby5wYl9kZWZhdWx0LgogICAqIEZvciB0aGUgbGlzdCBvZiByZXNlcnZlZCBuYW1lcyBwbGVhc2Ugc2VlOgogICAqICAgICBuZXQvcHJvdG8yL2NvbXBpbGVyL2pzL2ludGVybmFsL2dlbmVyYXRvci5jYyNrS2V5d29yZC4KICAgKiBAcGFyYW0ge2Jvb2xlYW49fSBvcHRfaW5jbHVkZUluc3RhbmNlIERlcHJlY2F0ZWQuIHdoZXRoZXIgdG8gaW5jbHVkZSB0aGUKICAgKiAgICAgSlNQQiBpbnN0YW5jZSBmb3IgdHJhbnNpdGlvbmFsIHNveSBwcm90byBzdXBwb3J0OgogICAqICAgICBodHRwOi8vZ290by9zb3ktcGFyYW0tbWlncmF0aW9uCiAgICogQHJldHVybiB7IU9iamVjdH0KICAgKi8KICBwcm90by5wYi5jbXMuQXBwTGlzdFJlcGx5LnByb3RvdHlwZS50b09iamVjdCA9IGZ1bmN0aW9uIChvcHRfaW5jbHVkZUluc3RhbmNlKSB7CiAgICByZXR1cm4gcHJvdG8ucGIuY21zLkFwcExpc3RSZXBseS50b09iamVjdChvcHRfaW5jbHVkZUluc3RhbmNlLCB0aGlzKTsKICB9OwogIC8qKgogICAqIFN0YXRpYyB2ZXJzaW9uIG9mIHRoZSB7QHNlZSB0b09iamVjdH0gbWV0aG9kLgogICAqIEBwYXJhbSB7Ym9vbGVhbnx1bmRlZmluZWR9IGluY2x1ZGVJbnN0YW5jZSBEZXByZWNhdGVkLiBXaGV0aGVyIHRvIGluY2x1ZGUKICAgKiAgICAgdGhlIEpTUEIgaW5zdGFuY2UgZm9yIHRyYW5zaXRpb25hbCBzb3kgcHJvdG8gc3VwcG9ydDoKICAgKiAgICAgaHR0cDovL2dvdG8vc295LXBhcmFtLW1pZ3JhdGlvbgogICAqIEBwYXJhbSB7IXByb3RvLnBiLmNtcy5BcHBMaXN0UmVwbHl9IG1zZyBUaGUgbXNnIGluc3RhbmNlIHRvIHRyYW5zZm9ybS4KICAgKiBAcmV0dXJuIHshT2JqZWN0fQogICAqIEBzdXBwcmVzcyB7dW51c2VkTG9jYWxWYXJpYWJsZXN9IGYgaXMgb25seSB1c2VkIGZvciBuZXN0ZWQgbWVzc2FnZXMKICAgKi8KCgogIHByb3RvLnBiLmNtcy5BcHBMaXN0UmVwbHkudG9PYmplY3QgPSBmdW5jdGlvbiAoaW5jbHVkZUluc3RhbmNlLCBtc2cpIHsKICAgIHZhciBmLAogICAgICAgIG9iaiA9IHsKICAgICAgYXBwc0xpc3Q6IGpzcGIuTWVzc2FnZS50b09iamVjdExpc3QobXNnLmdldEFwcHNMaXN0KCksIGNtc3R5cGVfcGIuQXBwLnRvT2JqZWN0LCBpbmNsdWRlSW5zdGFuY2UpCiAgICB9OwoKICAgIGlmIChpbmNsdWRlSW5zdGFuY2UpIHsKICAgICAgb2JqLiRqc3BiTWVzc2FnZUluc3RhbmNlID0gbXNnOwogICAgfQoKICAgIHJldHVybiBvYmo7CiAgfTsKfQovKioKICogRGVzZXJpYWxpemVzIGJpbmFyeSBkYXRhIChpbiBwcm90b2J1ZiB3aXJlIGZvcm1hdCkuCiAqIEBwYXJhbSB7anNwYi5CeXRlU291cmNlfSBieXRlcyBUaGUgYnl0ZXMgdG8gZGVzZXJpYWxpemUuCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuQXBwTGlzdFJlcGx5fQogKi8KCgpwcm90by5wYi5jbXMuQXBwTGlzdFJlcGx5LmRlc2VyaWFsaXplQmluYXJ5ID0gZnVuY3Rpb24gKGJ5dGVzKSB7CiAgdmFyIHJlYWRlciA9IG5ldyBqc3BiLkJpbmFyeVJlYWRlcihieXRlcyk7CiAgdmFyIG1zZyA9IG5ldyBwcm90by5wYi5jbXMuQXBwTGlzdFJlcGx5KCk7CiAgcmV0dXJuIHByb3RvLnBiLmNtcy5BcHBMaXN0UmVwbHkuZGVzZXJpYWxpemVCaW5hcnlGcm9tUmVhZGVyKG1zZywgcmVhZGVyKTsKfTsKLyoqCiAqIERlc2VyaWFsaXplcyBiaW5hcnkgZGF0YSAoaW4gcHJvdG9idWYgd2lyZSBmb3JtYXQpIGZyb20gdGhlCiAqIGdpdmVuIHJlYWRlciBpbnRvIHRoZSBnaXZlbiBtZXNzYWdlIG9iamVjdC4KICogQHBhcmFtIHshcHJvdG8ucGIuY21zLkFwcExpc3RSZXBseX0gbXNnIFRoZSBtZXNzYWdlIG9iamVjdCB0byBkZXNlcmlhbGl6ZSBpbnRvLgogKiBAcGFyYW0geyFqc3BiLkJpbmFyeVJlYWRlcn0gcmVhZGVyIFRoZSBCaW5hcnlSZWFkZXIgdG8gdXNlLgogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLkFwcExpc3RSZXBseX0KICovCgoKcHJvdG8ucGIuY21zLkFwcExpc3RSZXBseS5kZXNlcmlhbGl6ZUJpbmFyeUZyb21SZWFkZXIgPSBmdW5jdGlvbiAobXNnLCByZWFkZXIpIHsKICB3aGlsZSAocmVhZGVyLm5leHRGaWVsZCgpKSB7CiAgICBpZiAocmVhZGVyLmlzRW5kR3JvdXAoKSkgewogICAgICBicmVhazsKICAgIH0KCiAgICB2YXIgZmllbGQgPSByZWFkZXIuZ2V0RmllbGROdW1iZXIoKTsKCiAgICBzd2l0Y2ggKGZpZWxkKSB7CiAgICAgIGNhc2UgMToKICAgICAgICB2YXIgdmFsdWUgPSBuZXcgY21zdHlwZV9wYi5BcHAoKTsKICAgICAgICByZWFkZXIucmVhZE1lc3NhZ2UodmFsdWUsIGNtc3R5cGVfcGIuQXBwLmRlc2VyaWFsaXplQmluYXJ5RnJvbVJlYWRlcik7CiAgICAgICAgbXNnLmFkZEFwcHModmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgZGVmYXVsdDoKICAgICAgICByZWFkZXIuc2tpcEZpZWxkKCk7CiAgICAgICAgYnJlYWs7CiAgICB9CiAgfQoKICByZXR1cm4gbXNnOwp9OwovKioKICogU2VyaWFsaXplcyB0aGUgbWVzc2FnZSB0byBiaW5hcnkgZGF0YSAoaW4gcHJvdG9idWYgd2lyZSBmb3JtYXQpLgogKiBAcmV0dXJuIHshVWludDhBcnJheX0KICovCgoKcHJvdG8ucGIuY21zLkFwcExpc3RSZXBseS5wcm90b3R5cGUuc2VyaWFsaXplQmluYXJ5ID0gZnVuY3Rpb24gKCkgewogIHZhciB3cml0ZXIgPSBuZXcganNwYi5CaW5hcnlXcml0ZXIoKTsKICBwcm90by5wYi5jbXMuQXBwTGlzdFJlcGx5LnNlcmlhbGl6ZUJpbmFyeVRvV3JpdGVyKHRoaXMsIHdyaXRlcik7CiAgcmV0dXJuIHdyaXRlci5nZXRSZXN1bHRCdWZmZXIoKTsKfTsKLyoqCiAqIFNlcmlhbGl6ZXMgdGhlIGdpdmVuIG1lc3NhZ2UgdG8gYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUKICogZm9ybWF0KSwgd3JpdGluZyB0byB0aGUgZ2l2ZW4gQmluYXJ5V3JpdGVyLgogKiBAcGFyYW0geyFwcm90by5wYi5jbXMuQXBwTGlzdFJlcGx5fSBtZXNzYWdlCiAqIEBwYXJhbSB7IWpzcGIuQmluYXJ5V3JpdGVyfSB3cml0ZXIKICogQHN1cHByZXNzIHt1bnVzZWRMb2NhbFZhcmlhYmxlc30gZiBpcyBvbmx5IHVzZWQgZm9yIG5lc3RlZCBtZXNzYWdlcwogKi8KCgpwcm90by5wYi5jbXMuQXBwTGlzdFJlcGx5LnNlcmlhbGl6ZUJpbmFyeVRvV3JpdGVyID0gZnVuY3Rpb24gKG1lc3NhZ2UsIHdyaXRlcikgewogIHZhciBmID0gdW5kZWZpbmVkOwogIGYgPSBtZXNzYWdlLmdldEFwcHNMaXN0KCk7CgogIGlmIChmLmxlbmd0aCA+IDApIHsKICAgIHdyaXRlci53cml0ZVJlcGVhdGVkTWVzc2FnZSgxLCBmLCBjbXN0eXBlX3BiLkFwcC5zZXJpYWxpemVCaW5hcnlUb1dyaXRlcik7CiAgfQp9OwovKioKICogcmVwZWF0ZWQgcGIuQXBwIGFwcHMgPSAxOwogKiBAcmV0dXJuIHshQXJyYXk8IXByb3RvLnBiLkFwcD59CiAqLwoKCnByb3RvLnBiLmNtcy5BcHBMaXN0UmVwbHkucHJvdG90eXBlLmdldEFwcHNMaXN0ID0gZnVuY3Rpb24gKCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuZ2V0UmVwZWF0ZWRXcmFwcGVyRmllbGQodGhpcywgY21zdHlwZV9wYi5BcHAsIDEpOwp9OwovKioKICogQHBhcmFtIHshQXJyYXk8IXByb3RvLnBiLkFwcD59IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuQXBwTGlzdFJlcGx5fSByZXR1cm5zIHRoaXMKKi8KCgpwcm90by5wYi5jbXMuQXBwTGlzdFJlcGx5LnByb3RvdHlwZS5zZXRBcHBzTGlzdCA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UmVwZWF0ZWRXcmFwcGVyRmllbGQodGhpcywgMSwgdmFsdWUpOwp9OwovKioKICogQHBhcmFtIHshcHJvdG8ucGIuQXBwPX0gb3B0X3ZhbHVlCiAqIEBwYXJhbSB7bnVtYmVyPX0gb3B0X2luZGV4CiAqIEByZXR1cm4geyFwcm90by5wYi5BcHB9CiAqLwoKCnByb3RvLnBiLmNtcy5BcHBMaXN0UmVwbHkucHJvdG90eXBlLmFkZEFwcHMgPSBmdW5jdGlvbiAob3B0X3ZhbHVlLCBvcHRfaW5kZXgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmFkZFRvUmVwZWF0ZWRXcmFwcGVyRmllbGQodGhpcywgMSwgb3B0X3ZhbHVlLCBwcm90by5wYi5BcHAsIG9wdF9pbmRleCk7Cn07Ci8qKgogKiBDbGVhcnMgdGhlIGxpc3QgbWFraW5nIGl0IGVtcHR5IGJ1dCBub24tbnVsbC4KICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5BcHBMaXN0UmVwbHl9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuQXBwTGlzdFJlcGx5LnByb3RvdHlwZS5jbGVhckFwcHNMaXN0ID0gZnVuY3Rpb24gKCkgewogIHJldHVybiB0aGlzLnNldEFwcHNMaXN0KFtdKTsKfTsKCmlmIChqc3BiLk1lc3NhZ2UuR0VORVJBVEVfVE9fT0JKRUNUKSB7CiAgLyoqCiAgICogQ3JlYXRlcyBhbiBvYmplY3QgcmVwcmVzZW50YXRpb24gb2YgdGhpcyBwcm90by4KICAgKiBGaWVsZCBuYW1lcyB0aGF0IGFyZSByZXNlcnZlZCBpbiBKYXZhU2NyaXB0IGFuZCB3aWxsIGJlIHJlbmFtZWQgdG8gcGJfbmFtZS4KICAgKiBPcHRpb25hbCBmaWVsZHMgdGhhdCBhcmUgbm90IHNldCB3aWxsIGJlIHNldCB0byB1bmRlZmluZWQuCiAgICogVG8gYWNjZXNzIGEgcmVzZXJ2ZWQgZmllbGQgdXNlLCBmb28ucGJfPG5hbWU+LCBlZywgZm9vLnBiX2RlZmF1bHQuCiAgICogRm9yIHRoZSBsaXN0IG9mIHJlc2VydmVkIG5hbWVzIHBsZWFzZSBzZWU6CiAgICogICAgIG5ldC9wcm90bzIvY29tcGlsZXIvanMvaW50ZXJuYWwvZ2VuZXJhdG9yLmNjI2tLZXl3b3JkLgogICAqIEBwYXJhbSB7Ym9vbGVhbj19IG9wdF9pbmNsdWRlSW5zdGFuY2UgRGVwcmVjYXRlZC4gd2hldGhlciB0byBpbmNsdWRlIHRoZQogICAqICAgICBKU1BCIGluc3RhbmNlIGZvciB0cmFuc2l0aW9uYWwgc295IHByb3RvIHN1cHBvcnQ6CiAgICogICAgIGh0dHA6Ly9nb3RvL3NveS1wYXJhbS1taWdyYXRpb24KICAgKiBAcmV0dXJuIHshT2JqZWN0fQogICAqLwogIHByb3RvLnBiLmNtcy5BbmNob3JMaXN0UmVxdWVzdC5wcm90b3R5cGUudG9PYmplY3QgPSBmdW5jdGlvbiAob3B0X2luY2x1ZGVJbnN0YW5jZSkgewogICAgcmV0dXJuIHByb3RvLnBiLmNtcy5BbmNob3JMaXN0UmVxdWVzdC50b09iamVjdChvcHRfaW5jbHVkZUluc3RhbmNlLCB0aGlzKTsKICB9OwogIC8qKgogICAqIFN0YXRpYyB2ZXJzaW9uIG9mIHRoZSB7QHNlZSB0b09iamVjdH0gbWV0aG9kLgogICAqIEBwYXJhbSB7Ym9vbGVhbnx1bmRlZmluZWR9IGluY2x1ZGVJbnN0YW5jZSBEZXByZWNhdGVkLiBXaGV0aGVyIHRvIGluY2x1ZGUKICAgKiAgICAgdGhlIEpTUEIgaW5zdGFuY2UgZm9yIHRyYW5zaXRpb25hbCBzb3kgcHJvdG8gc3VwcG9ydDoKICAgKiAgICAgaHR0cDovL2dvdG8vc295LXBhcmFtLW1pZ3JhdGlvbgogICAqIEBwYXJhbSB7IXByb3RvLnBiLmNtcy5BbmNob3JMaXN0UmVxdWVzdH0gbXNnIFRoZSBtc2cgaW5zdGFuY2UgdG8gdHJhbnNmb3JtLgogICAqIEByZXR1cm4geyFPYmplY3R9CiAgICogQHN1cHByZXNzIHt1bnVzZWRMb2NhbFZhcmlhYmxlc30gZiBpcyBvbmx5IHVzZWQgZm9yIG5lc3RlZCBtZXNzYWdlcwogICAqLwoKCiAgcHJvdG8ucGIuY21zLkFuY2hvckxpc3RSZXF1ZXN0LnRvT2JqZWN0ID0gZnVuY3Rpb24gKGluY2x1ZGVJbnN0YW5jZSwgbXNnKSB7CiAgICB2YXIgZiwKICAgICAgICBvYmogPSB7CiAgICAgIHBhZ2VObzoganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQobXNnLCAxLCAwKSwKICAgICAgcGFnZVNpemU6IGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KG1zZywgMiwgMCksCiAgICAgIGFuY2hvcklkOiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdChtc2csIDMsIDApLAogICAgICBhcmVhSWQ6IGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KG1zZywgNCwgMCksCiAgICAgIGd1aWxkSWQ6IGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KG1zZywgNSwgMCksCiAgICAgIGJsb2NrU3RhdHVzOiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdChtc2csIDYsIDApLAogICAgICBvbmxpbmVTdGF0dXM6IGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KG1zZywgNywgMCksCiAgICAgIHJldmlld1N0YXR1czoganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQobXNnLCA4LCAwKSwKICAgICAgY3JlYXRlZFN0YXJ0OiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdChtc2csIDksIDApLAogICAgICBjcmVhdGVkRW5kOiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdChtc2csIDEwLCAwKSwKICAgICAgbWluT2ZmbGluZToganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQobXNnLCAxMSwgMCkKICAgIH07CgogICAgaWYgKGluY2x1ZGVJbnN0YW5jZSkgewogICAgICBvYmouJGpzcGJNZXNzYWdlSW5zdGFuY2UgPSBtc2c7CiAgICB9CgogICAgcmV0dXJuIG9iajsKICB9Owp9Ci8qKgogKiBEZXNlcmlhbGl6ZXMgYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUgZm9ybWF0KS4KICogQHBhcmFtIHtqc3BiLkJ5dGVTb3VyY2V9IGJ5dGVzIFRoZSBieXRlcyB0byBkZXNlcmlhbGl6ZS4KICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5BbmNob3JMaXN0UmVxdWVzdH0KICovCgoKcHJvdG8ucGIuY21zLkFuY2hvckxpc3RSZXF1ZXN0LmRlc2VyaWFsaXplQmluYXJ5ID0gZnVuY3Rpb24gKGJ5dGVzKSB7CiAgdmFyIHJlYWRlciA9IG5ldyBqc3BiLkJpbmFyeVJlYWRlcihieXRlcyk7CiAgdmFyIG1zZyA9IG5ldyBwcm90by5wYi5jbXMuQW5jaG9yTGlzdFJlcXVlc3QoKTsKICByZXR1cm4gcHJvdG8ucGIuY21zLkFuY2hvckxpc3RSZXF1ZXN0LmRlc2VyaWFsaXplQmluYXJ5RnJvbVJlYWRlcihtc2csIHJlYWRlcik7Cn07Ci8qKgogKiBEZXNlcmlhbGl6ZXMgYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUgZm9ybWF0KSBmcm9tIHRoZQogKiBnaXZlbiByZWFkZXIgaW50byB0aGUgZ2l2ZW4gbWVzc2FnZSBvYmplY3QuCiAqIEBwYXJhbSB7IXByb3RvLnBiLmNtcy5BbmNob3JMaXN0UmVxdWVzdH0gbXNnIFRoZSBtZXNzYWdlIG9iamVjdCB0byBkZXNlcmlhbGl6ZSBpbnRvLgogKiBAcGFyYW0geyFqc3BiLkJpbmFyeVJlYWRlcn0gcmVhZGVyIFRoZSBCaW5hcnlSZWFkZXIgdG8gdXNlLgogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLkFuY2hvckxpc3RSZXF1ZXN0fQogKi8KCgpwcm90by5wYi5jbXMuQW5jaG9yTGlzdFJlcXVlc3QuZGVzZXJpYWxpemVCaW5hcnlGcm9tUmVhZGVyID0gZnVuY3Rpb24gKG1zZywgcmVhZGVyKSB7CiAgd2hpbGUgKHJlYWRlci5uZXh0RmllbGQoKSkgewogICAgaWYgKHJlYWRlci5pc0VuZEdyb3VwKCkpIHsKICAgICAgYnJlYWs7CiAgICB9CgogICAgdmFyIGZpZWxkID0gcmVhZGVyLmdldEZpZWxkTnVtYmVyKCk7CgogICAgc3dpdGNoIChmaWVsZCkgewogICAgICBjYXNlIDE6CiAgICAgICAgdmFyIHZhbHVlID0gcmVhZGVyLnJlYWRVaW50MzIoKTsKICAgICAgICBtc2cuc2V0UGFnZU5vKHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgMjoKICAgICAgICB2YXIgdmFsdWUgPSByZWFkZXIucmVhZFVpbnQzMigpOwogICAgICAgIG1zZy5zZXRQYWdlU2l6ZSh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlIDM6CiAgICAgICAgdmFyIHZhbHVlID0gcmVhZGVyLnJlYWRVaW50MzIoKTsKICAgICAgICBtc2cuc2V0QW5jaG9ySWQodmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSA0OgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkVWludDMyKCk7CiAgICAgICAgbXNnLnNldEFyZWFJZCh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlIDU6CiAgICAgICAgdmFyIHZhbHVlID0gcmVhZGVyLnJlYWRVaW50MzIoKTsKICAgICAgICBtc2cuc2V0R3VpbGRJZCh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlIDY6CiAgICAgICAgdmFyIHZhbHVlID0gcmVhZGVyLnJlYWRFbnVtKCk7CiAgICAgICAgbXNnLnNldEJsb2NrU3RhdHVzKHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgNzoKICAgICAgICB2YXIgdmFsdWUgPSByZWFkZXIucmVhZEVudW0oKTsKICAgICAgICBtc2cuc2V0T25saW5lU3RhdHVzKHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgODoKICAgICAgICB2YXIgdmFsdWUgPSByZWFkZXIucmVhZEVudW0oKTsKICAgICAgICBtc2cuc2V0UmV2aWV3U3RhdHVzKHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgOToKICAgICAgICB2YXIgdmFsdWUgPSByZWFkZXIucmVhZFVpbnQzMigpOwogICAgICAgIG1zZy5zZXRDcmVhdGVkU3RhcnQodmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSAxMDoKICAgICAgICB2YXIgdmFsdWUgPSByZWFkZXIucmVhZFVpbnQzMigpOwogICAgICAgIG1zZy5zZXRDcmVhdGVkRW5kKHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgMTE6CiAgICAgICAgdmFyIHZhbHVlID0gcmVhZGVyLnJlYWRVaW50MzIoKTsKICAgICAgICBtc2cuc2V0TWluT2ZmbGluZSh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBkZWZhdWx0OgogICAgICAgIHJlYWRlci5za2lwRmllbGQoKTsKICAgICAgICBicmVhazsKICAgIH0KICB9CgogIHJldHVybiBtc2c7Cn07Ci8qKgogKiBTZXJpYWxpemVzIHRoZSBtZXNzYWdlIHRvIGJpbmFyeSBkYXRhIChpbiBwcm90b2J1ZiB3aXJlIGZvcm1hdCkuCiAqIEByZXR1cm4geyFVaW50OEFycmF5fQogKi8KCgpwcm90by5wYi5jbXMuQW5jaG9yTGlzdFJlcXVlc3QucHJvdG90eXBlLnNlcmlhbGl6ZUJpbmFyeSA9IGZ1bmN0aW9uICgpIHsKICB2YXIgd3JpdGVyID0gbmV3IGpzcGIuQmluYXJ5V3JpdGVyKCk7CiAgcHJvdG8ucGIuY21zLkFuY2hvckxpc3RSZXF1ZXN0LnNlcmlhbGl6ZUJpbmFyeVRvV3JpdGVyKHRoaXMsIHdyaXRlcik7CiAgcmV0dXJuIHdyaXRlci5nZXRSZXN1bHRCdWZmZXIoKTsKfTsKLyoqCiAqIFNlcmlhbGl6ZXMgdGhlIGdpdmVuIG1lc3NhZ2UgdG8gYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUKICogZm9ybWF0KSwgd3JpdGluZyB0byB0aGUgZ2l2ZW4gQmluYXJ5V3JpdGVyLgogKiBAcGFyYW0geyFwcm90by5wYi5jbXMuQW5jaG9yTGlzdFJlcXVlc3R9IG1lc3NhZ2UKICogQHBhcmFtIHshanNwYi5CaW5hcnlXcml0ZXJ9IHdyaXRlcgogKiBAc3VwcHJlc3Mge3VudXNlZExvY2FsVmFyaWFibGVzfSBmIGlzIG9ubHkgdXNlZCBmb3IgbmVzdGVkIG1lc3NhZ2VzCiAqLwoKCnByb3RvLnBiLmNtcy5BbmNob3JMaXN0UmVxdWVzdC5zZXJpYWxpemVCaW5hcnlUb1dyaXRlciA9IGZ1bmN0aW9uIChtZXNzYWdlLCB3cml0ZXIpIHsKICB2YXIgZiA9IHVuZGVmaW5lZDsKICBmID0gbWVzc2FnZS5nZXRQYWdlTm8oKTsKCiAgaWYgKGYgIT09IDApIHsKICAgIHdyaXRlci53cml0ZVVpbnQzMigxLCBmKTsKICB9CgogIGYgPSBtZXNzYWdlLmdldFBhZ2VTaXplKCk7CgogIGlmIChmICE9PSAwKSB7CiAgICB3cml0ZXIud3JpdGVVaW50MzIoMiwgZik7CiAgfQoKICBmID0gbWVzc2FnZS5nZXRBbmNob3JJZCgpOwoKICBpZiAoZiAhPT0gMCkgewogICAgd3JpdGVyLndyaXRlVWludDMyKDMsIGYpOwogIH0KCiAgZiA9IG1lc3NhZ2UuZ2V0QXJlYUlkKCk7CgogIGlmIChmICE9PSAwKSB7CiAgICB3cml0ZXIud3JpdGVVaW50MzIoNCwgZik7CiAgfQoKICBmID0gbWVzc2FnZS5nZXRHdWlsZElkKCk7CgogIGlmIChmICE9PSAwKSB7CiAgICB3cml0ZXIud3JpdGVVaW50MzIoNSwgZik7CiAgfQoKICBmID0gbWVzc2FnZS5nZXRCbG9ja1N0YXR1cygpOwoKICBpZiAoZiAhPT0gMC4wKSB7CiAgICB3cml0ZXIud3JpdGVFbnVtKDYsIGYpOwogIH0KCiAgZiA9IG1lc3NhZ2UuZ2V0T25saW5lU3RhdHVzKCk7CgogIGlmIChmICE9PSAwLjApIHsKICAgIHdyaXRlci53cml0ZUVudW0oNywgZik7CiAgfQoKICBmID0gbWVzc2FnZS5nZXRSZXZpZXdTdGF0dXMoKTsKCiAgaWYgKGYgIT09IDAuMCkgewogICAgd3JpdGVyLndyaXRlRW51bSg4LCBmKTsKICB9CgogIGYgPSBtZXNzYWdlLmdldENyZWF0ZWRTdGFydCgpOwoKICBpZiAoZiAhPT0gMCkgewogICAgd3JpdGVyLndyaXRlVWludDMyKDksIGYpOwogIH0KCiAgZiA9IG1lc3NhZ2UuZ2V0Q3JlYXRlZEVuZCgpOwoKICBpZiAoZiAhPT0gMCkgewogICAgd3JpdGVyLndyaXRlVWludDMyKDEwLCBmKTsKICB9CgogIGYgPSBtZXNzYWdlLmdldE1pbk9mZmxpbmUoKTsKCiAgaWYgKGYgIT09IDApIHsKICAgIHdyaXRlci53cml0ZVVpbnQzMigxMSwgZik7CiAgfQp9OwovKioKICogb3B0aW9uYWwgdWludDMyIHBhZ2Vfbm8gPSAxOwogKiBAcmV0dXJuIHtudW1iZXJ9CiAqLwoKCnByb3RvLnBiLmNtcy5BbmNob3JMaXN0UmVxdWVzdC5wcm90b3R5cGUuZ2V0UGFnZU5vID0gZnVuY3Rpb24gKCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdCh0aGlzLCAxLCAwKTsKfTsKLyoqCiAqIEBwYXJhbSB7bnVtYmVyfSB2YWx1ZQogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLkFuY2hvckxpc3RSZXF1ZXN0fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLkFuY2hvckxpc3RSZXF1ZXN0LnByb3RvdHlwZS5zZXRQYWdlTm8gPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0ludEZpZWxkKHRoaXMsIDEsIHZhbHVlKTsKfTsKLyoqCiAqIG9wdGlvbmFsIHVpbnQzMiBwYWdlX3NpemUgPSAyOwogKiBAcmV0dXJuIHtudW1iZXJ9CiAqLwoKCnByb3RvLnBiLmNtcy5BbmNob3JMaXN0UmVxdWVzdC5wcm90b3R5cGUuZ2V0UGFnZVNpemUgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDIsIDApOwp9OwovKioKICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuQW5jaG9yTGlzdFJlcXVlc3R9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuQW5jaG9yTGlzdFJlcXVlc3QucHJvdG90eXBlLnNldFBhZ2VTaXplID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRQcm90bzNJbnRGaWVsZCh0aGlzLCAyLCB2YWx1ZSk7Cn07Ci8qKgogKiBvcHRpb25hbCB1aW50MzIgYW5jaG9yX2lkID0gMzsKICogQHJldHVybiB7bnVtYmVyfQogKi8KCgpwcm90by5wYi5jbXMuQW5jaG9yTGlzdFJlcXVlc3QucHJvdG90eXBlLmdldEFuY2hvcklkID0gZnVuY3Rpb24gKCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdCh0aGlzLCAzLCAwKTsKfTsKLyoqCiAqIEBwYXJhbSB7bnVtYmVyfSB2YWx1ZQogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLkFuY2hvckxpc3RSZXF1ZXN0fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLkFuY2hvckxpc3RSZXF1ZXN0LnByb3RvdHlwZS5zZXRBbmNob3JJZCA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UHJvdG8zSW50RmllbGQodGhpcywgMywgdmFsdWUpOwp9OwovKioKICogb3B0aW9uYWwgdWludDMyIGFyZWFfaWQgPSA0OwogKiBAcmV0dXJuIHtudW1iZXJ9CiAqLwoKCnByb3RvLnBiLmNtcy5BbmNob3JMaXN0UmVxdWVzdC5wcm90b3R5cGUuZ2V0QXJlYUlkID0gZnVuY3Rpb24gKCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdCh0aGlzLCA0LCAwKTsKfTsKLyoqCiAqIEBwYXJhbSB7bnVtYmVyfSB2YWx1ZQogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLkFuY2hvckxpc3RSZXF1ZXN0fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLkFuY2hvckxpc3RSZXF1ZXN0LnByb3RvdHlwZS5zZXRBcmVhSWQgPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0ludEZpZWxkKHRoaXMsIDQsIHZhbHVlKTsKfTsKLyoqCiAqIG9wdGlvbmFsIHVpbnQzMiBndWlsZF9pZCA9IDU7CiAqIEByZXR1cm4ge251bWJlcn0KICovCgoKcHJvdG8ucGIuY21zLkFuY2hvckxpc3RSZXF1ZXN0LnByb3RvdHlwZS5nZXRHdWlsZElkID0gZnVuY3Rpb24gKCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdCh0aGlzLCA1LCAwKTsKfTsKLyoqCiAqIEBwYXJhbSB7bnVtYmVyfSB2YWx1ZQogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLkFuY2hvckxpc3RSZXF1ZXN0fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLkFuY2hvckxpc3RSZXF1ZXN0LnByb3RvdHlwZS5zZXRHdWlsZElkID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRQcm90bzNJbnRGaWVsZCh0aGlzLCA1LCB2YWx1ZSk7Cn07Ci8qKgogKiBvcHRpb25hbCBwYi5CbG9ja1N0YXR1cyBibG9ja19zdGF0dXMgPSA2OwogKiBAcmV0dXJuIHshcHJvdG8ucGIuQmxvY2tTdGF0dXN9CiAqLwoKCnByb3RvLnBiLmNtcy5BbmNob3JMaXN0UmVxdWVzdC5wcm90b3R5cGUuZ2V0QmxvY2tTdGF0dXMgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDYsIDApOwp9OwovKioKICogQHBhcmFtIHshcHJvdG8ucGIuQmxvY2tTdGF0dXN9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuQW5jaG9yTGlzdFJlcXVlc3R9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuQW5jaG9yTGlzdFJlcXVlc3QucHJvdG90eXBlLnNldEJsb2NrU3RhdHVzID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRQcm90bzNFbnVtRmllbGQodGhpcywgNiwgdmFsdWUpOwp9OwovKioKICogb3B0aW9uYWwgcGIuT25saW5lU3RhdHVzIG9ubGluZV9zdGF0dXMgPSA3OwogKiBAcmV0dXJuIHshcHJvdG8ucGIuT25saW5lU3RhdHVzfQogKi8KCgpwcm90by5wYi5jbXMuQW5jaG9yTGlzdFJlcXVlc3QucHJvdG90eXBlLmdldE9ubGluZVN0YXR1cyA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQodGhpcywgNywgMCk7Cn07Ci8qKgogKiBAcGFyYW0geyFwcm90by5wYi5PbmxpbmVTdGF0dXN9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuQW5jaG9yTGlzdFJlcXVlc3R9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuQW5jaG9yTGlzdFJlcXVlc3QucHJvdG90eXBlLnNldE9ubGluZVN0YXR1cyA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UHJvdG8zRW51bUZpZWxkKHRoaXMsIDcsIHZhbHVlKTsKfTsKLyoqCiAqIG9wdGlvbmFsIHBiLlJldmlld1N0YXR1cyByZXZpZXdfc3RhdHVzID0gODsKICogQHJldHVybiB7IXByb3RvLnBiLlJldmlld1N0YXR1c30KICovCgoKcHJvdG8ucGIuY21zLkFuY2hvckxpc3RSZXF1ZXN0LnByb3RvdHlwZS5nZXRSZXZpZXdTdGF0dXMgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDgsIDApOwp9OwovKioKICogQHBhcmFtIHshcHJvdG8ucGIuUmV2aWV3U3RhdHVzfSB2YWx1ZQogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLkFuY2hvckxpc3RSZXF1ZXN0fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLkFuY2hvckxpc3RSZXF1ZXN0LnByb3RvdHlwZS5zZXRSZXZpZXdTdGF0dXMgPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0VudW1GaWVsZCh0aGlzLCA4LCB2YWx1ZSk7Cn07Ci8qKgogKiBvcHRpb25hbCB1aW50MzIgY3JlYXRlZF9zdGFydCA9IDk7CiAqIEByZXR1cm4ge251bWJlcn0KICovCgoKcHJvdG8ucGIuY21zLkFuY2hvckxpc3RSZXF1ZXN0LnByb3RvdHlwZS5nZXRDcmVhdGVkU3RhcnQgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDksIDApOwp9OwovKioKICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuQW5jaG9yTGlzdFJlcXVlc3R9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuQW5jaG9yTGlzdFJlcXVlc3QucHJvdG90eXBlLnNldENyZWF0ZWRTdGFydCA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UHJvdG8zSW50RmllbGQodGhpcywgOSwgdmFsdWUpOwp9OwovKioKICogb3B0aW9uYWwgdWludDMyIGNyZWF0ZWRfZW5kID0gMTA7CiAqIEByZXR1cm4ge251bWJlcn0KICovCgoKcHJvdG8ucGIuY21zLkFuY2hvckxpc3RSZXF1ZXN0LnByb3RvdHlwZS5nZXRDcmVhdGVkRW5kID0gZnVuY3Rpb24gKCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdCh0aGlzLCAxMCwgMCk7Cn07Ci8qKgogKiBAcGFyYW0ge251bWJlcn0gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5BbmNob3JMaXN0UmVxdWVzdH0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5BbmNob3JMaXN0UmVxdWVzdC5wcm90b3R5cGUuc2V0Q3JlYXRlZEVuZCA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UHJvdG8zSW50RmllbGQodGhpcywgMTAsIHZhbHVlKTsKfTsKLyoqCiAqIG9wdGlvbmFsIHVpbnQzMiBtaW5fb2ZmbGluZSA9IDExOwogKiBAcmV0dXJuIHtudW1iZXJ9CiAqLwoKCnByb3RvLnBiLmNtcy5BbmNob3JMaXN0UmVxdWVzdC5wcm90b3R5cGUuZ2V0TWluT2ZmbGluZSA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQodGhpcywgMTEsIDApOwp9OwovKioKICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuQW5jaG9yTGlzdFJlcXVlc3R9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuQW5jaG9yTGlzdFJlcXVlc3QucHJvdG90eXBlLnNldE1pbk9mZmxpbmUgPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0ludEZpZWxkKHRoaXMsIDExLCB2YWx1ZSk7Cn07Ci8qKgogKiBMaXN0IG9mIHJlcGVhdGVkIGZpZWxkcyB3aXRoaW4gdGhpcyBtZXNzYWdlIHR5cGUuCiAqIEBwcml2YXRlIHshQXJyYXk8bnVtYmVyPn0KICogQGNvbnN0CiAqLwoKCnByb3RvLnBiLmNtcy5BbmNob3JMaXN0UmVwbHkucmVwZWF0ZWRGaWVsZHNfID0gWzFdOwoKaWYgKGpzcGIuTWVzc2FnZS5HRU5FUkFURV9UT19PQkpFQ1QpIHsKICAvKioKICAgKiBDcmVhdGVzIGFuIG9iamVjdCByZXByZXNlbnRhdGlvbiBvZiB0aGlzIHByb3RvLgogICAqIEZpZWxkIG5hbWVzIHRoYXQgYXJlIHJlc2VydmVkIGluIEphdmFTY3JpcHQgYW5kIHdpbGwgYmUgcmVuYW1lZCB0byBwYl9uYW1lLgogICAqIE9wdGlvbmFsIGZpZWxkcyB0aGF0IGFyZSBub3Qgc2V0IHdpbGwgYmUgc2V0IHRvIHVuZGVmaW5lZC4KICAgKiBUbyBhY2Nlc3MgYSByZXNlcnZlZCBmaWVsZCB1c2UsIGZvby5wYl88bmFtZT4sIGVnLCBmb28ucGJfZGVmYXVsdC4KICAgKiBGb3IgdGhlIGxpc3Qgb2YgcmVzZXJ2ZWQgbmFtZXMgcGxlYXNlIHNlZToKICAgKiAgICAgbmV0L3Byb3RvMi9jb21waWxlci9qcy9pbnRlcm5hbC9nZW5lcmF0b3IuY2Mja0tleXdvcmQuCiAgICogQHBhcmFtIHtib29sZWFuPX0gb3B0X2luY2x1ZGVJbnN0YW5jZSBEZXByZWNhdGVkLiB3aGV0aGVyIHRvIGluY2x1ZGUgdGhlCiAgICogICAgIEpTUEIgaW5zdGFuY2UgZm9yIHRyYW5zaXRpb25hbCBzb3kgcHJvdG8gc3VwcG9ydDoKICAgKiAgICAgaHR0cDovL2dvdG8vc295LXBhcmFtLW1pZ3JhdGlvbgogICAqIEByZXR1cm4geyFPYmplY3R9CiAgICovCiAgcHJvdG8ucGIuY21zLkFuY2hvckxpc3RSZXBseS5wcm90b3R5cGUudG9PYmplY3QgPSBmdW5jdGlvbiAob3B0X2luY2x1ZGVJbnN0YW5jZSkgewogICAgcmV0dXJuIHByb3RvLnBiLmNtcy5BbmNob3JMaXN0UmVwbHkudG9PYmplY3Qob3B0X2luY2x1ZGVJbnN0YW5jZSwgdGhpcyk7CiAgfTsKICAvKioKICAgKiBTdGF0aWMgdmVyc2lvbiBvZiB0aGUge0BzZWUgdG9PYmplY3R9IG1ldGhvZC4KICAgKiBAcGFyYW0ge2Jvb2xlYW58dW5kZWZpbmVkfSBpbmNsdWRlSW5zdGFuY2UgRGVwcmVjYXRlZC4gV2hldGhlciB0byBpbmNsdWRlCiAgICogICAgIHRoZSBKU1BCIGluc3RhbmNlIGZvciB0cmFuc2l0aW9uYWwgc295IHByb3RvIHN1cHBvcnQ6CiAgICogICAgIGh0dHA6Ly9nb3RvL3NveS1wYXJhbS1taWdyYXRpb24KICAgKiBAcGFyYW0geyFwcm90by5wYi5jbXMuQW5jaG9yTGlzdFJlcGx5fSBtc2cgVGhlIG1zZyBpbnN0YW5jZSB0byB0cmFuc2Zvcm0uCiAgICogQHJldHVybiB7IU9iamVjdH0KICAgKiBAc3VwcHJlc3Mge3VudXNlZExvY2FsVmFyaWFibGVzfSBmIGlzIG9ubHkgdXNlZCBmb3IgbmVzdGVkIG1lc3NhZ2VzCiAgICovCgoKICBwcm90by5wYi5jbXMuQW5jaG9yTGlzdFJlcGx5LnRvT2JqZWN0ID0gZnVuY3Rpb24gKGluY2x1ZGVJbnN0YW5jZSwgbXNnKSB7CiAgICB2YXIgZiwKICAgICAgICBvYmogPSB7CiAgICAgIGFuY2hvcnNMaXN0OiBqc3BiLk1lc3NhZ2UudG9PYmplY3RMaXN0KG1zZy5nZXRBbmNob3JzTGlzdCgpLCBhbmNob3J0eXBlX3BiLkFuY2hvckJhc2ljLnRvT2JqZWN0LCBpbmNsdWRlSW5zdGFuY2UpLAogICAgICBwYWdlTm86IGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KG1zZywgMiwgMCksCiAgICAgIHBhZ2VTaXplOiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdChtc2csIDMsIDApLAogICAgICB0b3RhbFBhZ2U6IGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KG1zZywgNCwgMCksCiAgICAgIHRvdGFsQ291bnQ6IGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KG1zZywgNSwgMCkKICAgIH07CgogICAgaWYgKGluY2x1ZGVJbnN0YW5jZSkgewogICAgICBvYmouJGpzcGJNZXNzYWdlSW5zdGFuY2UgPSBtc2c7CiAgICB9CgogICAgcmV0dXJuIG9iajsKICB9Owp9Ci8qKgogKiBEZXNlcmlhbGl6ZXMgYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUgZm9ybWF0KS4KICogQHBhcmFtIHtqc3BiLkJ5dGVTb3VyY2V9IGJ5dGVzIFRoZSBieXRlcyB0byBkZXNlcmlhbGl6ZS4KICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5BbmNob3JMaXN0UmVwbHl9CiAqLwoKCnByb3RvLnBiLmNtcy5BbmNob3JMaXN0UmVwbHkuZGVzZXJpYWxpemVCaW5hcnkgPSBmdW5jdGlvbiAoYnl0ZXMpIHsKICB2YXIgcmVhZGVyID0gbmV3IGpzcGIuQmluYXJ5UmVhZGVyKGJ5dGVzKTsKICB2YXIgbXNnID0gbmV3IHByb3RvLnBiLmNtcy5BbmNob3JMaXN0UmVwbHkoKTsKICByZXR1cm4gcHJvdG8ucGIuY21zLkFuY2hvckxpc3RSZXBseS5kZXNlcmlhbGl6ZUJpbmFyeUZyb21SZWFkZXIobXNnLCByZWFkZXIpOwp9OwovKioKICogRGVzZXJpYWxpemVzIGJpbmFyeSBkYXRhIChpbiBwcm90b2J1ZiB3aXJlIGZvcm1hdCkgZnJvbSB0aGUKICogZ2l2ZW4gcmVhZGVyIGludG8gdGhlIGdpdmVuIG1lc3NhZ2Ugb2JqZWN0LgogKiBAcGFyYW0geyFwcm90by5wYi5jbXMuQW5jaG9yTGlzdFJlcGx5fSBtc2cgVGhlIG1lc3NhZ2Ugb2JqZWN0IHRvIGRlc2VyaWFsaXplIGludG8uCiAqIEBwYXJhbSB7IWpzcGIuQmluYXJ5UmVhZGVyfSByZWFkZXIgVGhlIEJpbmFyeVJlYWRlciB0byB1c2UuCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuQW5jaG9yTGlzdFJlcGx5fQogKi8KCgpwcm90by5wYi5jbXMuQW5jaG9yTGlzdFJlcGx5LmRlc2VyaWFsaXplQmluYXJ5RnJvbVJlYWRlciA9IGZ1bmN0aW9uIChtc2csIHJlYWRlcikgewogIHdoaWxlIChyZWFkZXIubmV4dEZpZWxkKCkpIHsKICAgIGlmIChyZWFkZXIuaXNFbmRHcm91cCgpKSB7CiAgICAgIGJyZWFrOwogICAgfQoKICAgIHZhciBmaWVsZCA9IHJlYWRlci5nZXRGaWVsZE51bWJlcigpOwoKICAgIHN3aXRjaCAoZmllbGQpIHsKICAgICAgY2FzZSAxOgogICAgICAgIHZhciB2YWx1ZSA9IG5ldyBhbmNob3J0eXBlX3BiLkFuY2hvckJhc2ljKCk7CiAgICAgICAgcmVhZGVyLnJlYWRNZXNzYWdlKHZhbHVlLCBhbmNob3J0eXBlX3BiLkFuY2hvckJhc2ljLmRlc2VyaWFsaXplQmluYXJ5RnJvbVJlYWRlcik7CiAgICAgICAgbXNnLmFkZEFuY2hvcnModmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSAyOgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkVWludDMyKCk7CiAgICAgICAgbXNnLnNldFBhZ2VObyh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlIDM6CiAgICAgICAgdmFyIHZhbHVlID0gcmVhZGVyLnJlYWRVaW50MzIoKTsKICAgICAgICBtc2cuc2V0UGFnZVNpemUodmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSA0OgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkVWludDMyKCk7CiAgICAgICAgbXNnLnNldFRvdGFsUGFnZSh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlIDU6CiAgICAgICAgdmFyIHZhbHVlID0gcmVhZGVyLnJlYWRVaW50MzIoKTsKICAgICAgICBtc2cuc2V0VG90YWxDb3VudCh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBkZWZhdWx0OgogICAgICAgIHJlYWRlci5za2lwRmllbGQoKTsKICAgICAgICBicmVhazsKICAgIH0KICB9CgogIHJldHVybiBtc2c7Cn07Ci8qKgogKiBTZXJpYWxpemVzIHRoZSBtZXNzYWdlIHRvIGJpbmFyeSBkYXRhIChpbiBwcm90b2J1ZiB3aXJlIGZvcm1hdCkuCiAqIEByZXR1cm4geyFVaW50OEFycmF5fQogKi8KCgpwcm90by5wYi5jbXMuQW5jaG9yTGlzdFJlcGx5LnByb3RvdHlwZS5zZXJpYWxpemVCaW5hcnkgPSBmdW5jdGlvbiAoKSB7CiAgdmFyIHdyaXRlciA9IG5ldyBqc3BiLkJpbmFyeVdyaXRlcigpOwogIHByb3RvLnBiLmNtcy5BbmNob3JMaXN0UmVwbHkuc2VyaWFsaXplQmluYXJ5VG9Xcml0ZXIodGhpcywgd3JpdGVyKTsKICByZXR1cm4gd3JpdGVyLmdldFJlc3VsdEJ1ZmZlcigpOwp9OwovKioKICogU2VyaWFsaXplcyB0aGUgZ2l2ZW4gbWVzc2FnZSB0byBiaW5hcnkgZGF0YSAoaW4gcHJvdG9idWYgd2lyZQogKiBmb3JtYXQpLCB3cml0aW5nIHRvIHRoZSBnaXZlbiBCaW5hcnlXcml0ZXIuCiAqIEBwYXJhbSB7IXByb3RvLnBiLmNtcy5BbmNob3JMaXN0UmVwbHl9IG1lc3NhZ2UKICogQHBhcmFtIHshanNwYi5CaW5hcnlXcml0ZXJ9IHdyaXRlcgogKiBAc3VwcHJlc3Mge3VudXNlZExvY2FsVmFyaWFibGVzfSBmIGlzIG9ubHkgdXNlZCBmb3IgbmVzdGVkIG1lc3NhZ2VzCiAqLwoKCnByb3RvLnBiLmNtcy5BbmNob3JMaXN0UmVwbHkuc2VyaWFsaXplQmluYXJ5VG9Xcml0ZXIgPSBmdW5jdGlvbiAobWVzc2FnZSwgd3JpdGVyKSB7CiAgdmFyIGYgPSB1bmRlZmluZWQ7CiAgZiA9IG1lc3NhZ2UuZ2V0QW5jaG9yc0xpc3QoKTsKCiAgaWYgKGYubGVuZ3RoID4gMCkgewogICAgd3JpdGVyLndyaXRlUmVwZWF0ZWRNZXNzYWdlKDEsIGYsIGFuY2hvcnR5cGVfcGIuQW5jaG9yQmFzaWMuc2VyaWFsaXplQmluYXJ5VG9Xcml0ZXIpOwogIH0KCiAgZiA9IG1lc3NhZ2UuZ2V0UGFnZU5vKCk7CgogIGlmIChmICE9PSAwKSB7CiAgICB3cml0ZXIud3JpdGVVaW50MzIoMiwgZik7CiAgfQoKICBmID0gbWVzc2FnZS5nZXRQYWdlU2l6ZSgpOwoKICBpZiAoZiAhPT0gMCkgewogICAgd3JpdGVyLndyaXRlVWludDMyKDMsIGYpOwogIH0KCiAgZiA9IG1lc3NhZ2UuZ2V0VG90YWxQYWdlKCk7CgogIGlmIChmICE9PSAwKSB7CiAgICB3cml0ZXIud3JpdGVVaW50MzIoNCwgZik7CiAgfQoKICBmID0gbWVzc2FnZS5nZXRUb3RhbENvdW50KCk7CgogIGlmIChmICE9PSAwKSB7CiAgICB3cml0ZXIud3JpdGVVaW50MzIoNSwgZik7CiAgfQp9OwovKioKICogcmVwZWF0ZWQgcGIuQW5jaG9yQmFzaWMgYW5jaG9ycyA9IDE7CiAqIEByZXR1cm4geyFBcnJheTwhcHJvdG8ucGIuQW5jaG9yQmFzaWM+fQogKi8KCgpwcm90by5wYi5jbXMuQW5jaG9yTGlzdFJlcGx5LnByb3RvdHlwZS5nZXRBbmNob3JzTGlzdCA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldFJlcGVhdGVkV3JhcHBlckZpZWxkKHRoaXMsIGFuY2hvcnR5cGVfcGIuQW5jaG9yQmFzaWMsIDEpOwp9OwovKioKICogQHBhcmFtIHshQXJyYXk8IXByb3RvLnBiLkFuY2hvckJhc2ljPn0gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5BbmNob3JMaXN0UmVwbHl9IHJldHVybnMgdGhpcwoqLwoKCnByb3RvLnBiLmNtcy5BbmNob3JMaXN0UmVwbHkucHJvdG90eXBlLnNldEFuY2hvcnNMaXN0ID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRSZXBlYXRlZFdyYXBwZXJGaWVsZCh0aGlzLCAxLCB2YWx1ZSk7Cn07Ci8qKgogKiBAcGFyYW0geyFwcm90by5wYi5BbmNob3JCYXNpYz19IG9wdF92YWx1ZQogKiBAcGFyYW0ge251bWJlcj19IG9wdF9pbmRleAogKiBAcmV0dXJuIHshcHJvdG8ucGIuQW5jaG9yQmFzaWN9CiAqLwoKCnByb3RvLnBiLmNtcy5BbmNob3JMaXN0UmVwbHkucHJvdG90eXBlLmFkZEFuY2hvcnMgPSBmdW5jdGlvbiAob3B0X3ZhbHVlLCBvcHRfaW5kZXgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmFkZFRvUmVwZWF0ZWRXcmFwcGVyRmllbGQodGhpcywgMSwgb3B0X3ZhbHVlLCBwcm90by5wYi5BbmNob3JCYXNpYywgb3B0X2luZGV4KTsKfTsKLyoqCiAqIENsZWFycyB0aGUgbGlzdCBtYWtpbmcgaXQgZW1wdHkgYnV0IG5vbi1udWxsLgogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLkFuY2hvckxpc3RSZXBseX0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5BbmNob3JMaXN0UmVwbHkucHJvdG90eXBlLmNsZWFyQW5jaG9yc0xpc3QgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIHRoaXMuc2V0QW5jaG9yc0xpc3QoW10pOwp9OwovKioKICogb3B0aW9uYWwgdWludDMyIHBhZ2Vfbm8gPSAyOwogKiBAcmV0dXJuIHtudW1iZXJ9CiAqLwoKCnByb3RvLnBiLmNtcy5BbmNob3JMaXN0UmVwbHkucHJvdG90eXBlLmdldFBhZ2VObyA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQodGhpcywgMiwgMCk7Cn07Ci8qKgogKiBAcGFyYW0ge251bWJlcn0gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5BbmNob3JMaXN0UmVwbHl9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuQW5jaG9yTGlzdFJlcGx5LnByb3RvdHlwZS5zZXRQYWdlTm8gPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0ludEZpZWxkKHRoaXMsIDIsIHZhbHVlKTsKfTsKLyoqCiAqIG9wdGlvbmFsIHVpbnQzMiBwYWdlX3NpemUgPSAzOwogKiBAcmV0dXJuIHtudW1iZXJ9CiAqLwoKCnByb3RvLnBiLmNtcy5BbmNob3JMaXN0UmVwbHkucHJvdG90eXBlLmdldFBhZ2VTaXplID0gZnVuY3Rpb24gKCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdCh0aGlzLCAzLCAwKTsKfTsKLyoqCiAqIEBwYXJhbSB7bnVtYmVyfSB2YWx1ZQogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLkFuY2hvckxpc3RSZXBseX0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5BbmNob3JMaXN0UmVwbHkucHJvdG90eXBlLnNldFBhZ2VTaXplID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRQcm90bzNJbnRGaWVsZCh0aGlzLCAzLCB2YWx1ZSk7Cn07Ci8qKgogKiBvcHRpb25hbCB1aW50MzIgdG90YWxfcGFnZSA9IDQ7CiAqIEByZXR1cm4ge251bWJlcn0KICovCgoKcHJvdG8ucGIuY21zLkFuY2hvckxpc3RSZXBseS5wcm90b3R5cGUuZ2V0VG90YWxQYWdlID0gZnVuY3Rpb24gKCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdCh0aGlzLCA0LCAwKTsKfTsKLyoqCiAqIEBwYXJhbSB7bnVtYmVyfSB2YWx1ZQogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLkFuY2hvckxpc3RSZXBseX0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5BbmNob3JMaXN0UmVwbHkucHJvdG90eXBlLnNldFRvdGFsUGFnZSA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UHJvdG8zSW50RmllbGQodGhpcywgNCwgdmFsdWUpOwp9OwovKioKICogb3B0aW9uYWwgdWludDMyIHRvdGFsX2NvdW50ID0gNTsKICogQHJldHVybiB7bnVtYmVyfQogKi8KCgpwcm90by5wYi5jbXMuQW5jaG9yTGlzdFJlcGx5LnByb3RvdHlwZS5nZXRUb3RhbENvdW50ID0gZnVuY3Rpb24gKCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdCh0aGlzLCA1LCAwKTsKfTsKLyoqCiAqIEBwYXJhbSB7bnVtYmVyfSB2YWx1ZQogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLkFuY2hvckxpc3RSZXBseX0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5BbmNob3JMaXN0UmVwbHkucHJvdG90eXBlLnNldFRvdGFsQ291bnQgPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0ludEZpZWxkKHRoaXMsIDUsIHZhbHVlKTsKfTsKCmlmIChqc3BiLk1lc3NhZ2UuR0VORVJBVEVfVE9fT0JKRUNUKSB7CiAgLyoqCiAgICogQ3JlYXRlcyBhbiBvYmplY3QgcmVwcmVzZW50YXRpb24gb2YgdGhpcyBwcm90by4KICAgKiBGaWVsZCBuYW1lcyB0aGF0IGFyZSByZXNlcnZlZCBpbiBKYXZhU2NyaXB0IGFuZCB3aWxsIGJlIHJlbmFtZWQgdG8gcGJfbmFtZS4KICAgKiBPcHRpb25hbCBmaWVsZHMgdGhhdCBhcmUgbm90IHNldCB3aWxsIGJlIHNldCB0byB1bmRlZmluZWQuCiAgICogVG8gYWNjZXNzIGEgcmVzZXJ2ZWQgZmllbGQgdXNlLCBmb28ucGJfPG5hbWU+LCBlZywgZm9vLnBiX2RlZmF1bHQuCiAgICogRm9yIHRoZSBsaXN0IG9mIHJlc2VydmVkIG5hbWVzIHBsZWFzZSBzZWU6CiAgICogICAgIG5ldC9wcm90bzIvY29tcGlsZXIvanMvaW50ZXJuYWwvZ2VuZXJhdG9yLmNjI2tLZXl3b3JkLgogICAqIEBwYXJhbSB7Ym9vbGVhbj19IG9wdF9pbmNsdWRlSW5zdGFuY2UgRGVwcmVjYXRlZC4gd2hldGhlciB0byBpbmNsdWRlIHRoZQogICAqICAgICBKU1BCIGluc3RhbmNlIGZvciB0cmFuc2l0aW9uYWwgc295IHByb3RvIHN1cHBvcnQ6CiAgICogICAgIGh0dHA6Ly9nb3RvL3NveS1wYXJhbS1taWdyYXRpb24KICAgKiBAcmV0dXJuIHshT2JqZWN0fQogICAqLwogIHByb3RvLnBiLmNtcy5Vc2VyTGlzdFJlcXVlc3QucHJvdG90eXBlLnRvT2JqZWN0ID0gZnVuY3Rpb24gKG9wdF9pbmNsdWRlSW5zdGFuY2UpIHsKICAgIHJldHVybiBwcm90by5wYi5jbXMuVXNlckxpc3RSZXF1ZXN0LnRvT2JqZWN0KG9wdF9pbmNsdWRlSW5zdGFuY2UsIHRoaXMpOwogIH07CiAgLyoqCiAgICogU3RhdGljIHZlcnNpb24gb2YgdGhlIHtAc2VlIHRvT2JqZWN0fSBtZXRob2QuCiAgICogQHBhcmFtIHtib29sZWFufHVuZGVmaW5lZH0gaW5jbHVkZUluc3RhbmNlIERlcHJlY2F0ZWQuIFdoZXRoZXIgdG8gaW5jbHVkZQogICAqICAgICB0aGUgSlNQQiBpbnN0YW5jZSBmb3IgdHJhbnNpdGlvbmFsIHNveSBwcm90byBzdXBwb3J0OgogICAqICAgICBodHRwOi8vZ290by9zb3ktcGFyYW0tbWlncmF0aW9uCiAgICogQHBhcmFtIHshcHJvdG8ucGIuY21zLlVzZXJMaXN0UmVxdWVzdH0gbXNnIFRoZSBtc2cgaW5zdGFuY2UgdG8gdHJhbnNmb3JtLgogICAqIEByZXR1cm4geyFPYmplY3R9CiAgICogQHN1cHByZXNzIHt1bnVzZWRMb2NhbFZhcmlhYmxlc30gZiBpcyBvbmx5IHVzZWQgZm9yIG5lc3RlZCBtZXNzYWdlcwogICAqLwoKCiAgcHJvdG8ucGIuY21zLlVzZXJMaXN0UmVxdWVzdC50b09iamVjdCA9IGZ1bmN0aW9uIChpbmNsdWRlSW5zdGFuY2UsIG1zZykgewogICAgdmFyIGYsCiAgICAgICAgb2JqID0gewogICAgICBwYWdlTm86IGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KG1zZywgMSwgMCksCiAgICAgIHBhZ2VTaXplOiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdChtc2csIDIsIDApLAogICAgICB1c2VySWQ6IGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KG1zZywgMywgMCksCiAgICAgIGFyZWFJZDoganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQobXNnLCA0LCAwKSwKICAgICAgbmlja25hbWU6IGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KG1zZywgNSwgIiIpLAogICAgICB2aXBPbmx5OiBqc3BiLk1lc3NhZ2UuZ2V0Qm9vbGVhbkZpZWxkV2l0aERlZmF1bHQobXNnLCA2LCBmYWxzZSksCiAgICAgIGRlcG9zaXRPbmx5OiBqc3BiLk1lc3NhZ2UuZ2V0Qm9vbGVhbkZpZWxkV2l0aERlZmF1bHQobXNnLCA3LCBmYWxzZSksCiAgICAgIG1pbkJhbGFuY2U6IGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KG1zZywgOCwgMCksCiAgICAgIGNyZWF0ZWRTdGFydDoganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQobXNnLCA5LCAwKSwKICAgICAgY3JlYXRlZEVuZDoganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQobXNnLCAxMCwgMCkKICAgIH07CgogICAgaWYgKGluY2x1ZGVJbnN0YW5jZSkgewogICAgICBvYmouJGpzcGJNZXNzYWdlSW5zdGFuY2UgPSBtc2c7CiAgICB9CgogICAgcmV0dXJuIG9iajsKICB9Owp9Ci8qKgogKiBEZXNlcmlhbGl6ZXMgYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUgZm9ybWF0KS4KICogQHBhcmFtIHtqc3BiLkJ5dGVTb3VyY2V9IGJ5dGVzIFRoZSBieXRlcyB0byBkZXNlcmlhbGl6ZS4KICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5Vc2VyTGlzdFJlcXVlc3R9CiAqLwoKCnByb3RvLnBiLmNtcy5Vc2VyTGlzdFJlcXVlc3QuZGVzZXJpYWxpemVCaW5hcnkgPSBmdW5jdGlvbiAoYnl0ZXMpIHsKICB2YXIgcmVhZGVyID0gbmV3IGpzcGIuQmluYXJ5UmVhZGVyKGJ5dGVzKTsKICB2YXIgbXNnID0gbmV3IHByb3RvLnBiLmNtcy5Vc2VyTGlzdFJlcXVlc3QoKTsKICByZXR1cm4gcHJvdG8ucGIuY21zLlVzZXJMaXN0UmVxdWVzdC5kZXNlcmlhbGl6ZUJpbmFyeUZyb21SZWFkZXIobXNnLCByZWFkZXIpOwp9OwovKioKICogRGVzZXJpYWxpemVzIGJpbmFyeSBkYXRhIChpbiBwcm90b2J1ZiB3aXJlIGZvcm1hdCkgZnJvbSB0aGUKICogZ2l2ZW4gcmVhZGVyIGludG8gdGhlIGdpdmVuIG1lc3NhZ2Ugb2JqZWN0LgogKiBAcGFyYW0geyFwcm90by5wYi5jbXMuVXNlckxpc3RSZXF1ZXN0fSBtc2cgVGhlIG1lc3NhZ2Ugb2JqZWN0IHRvIGRlc2VyaWFsaXplIGludG8uCiAqIEBwYXJhbSB7IWpzcGIuQmluYXJ5UmVhZGVyfSByZWFkZXIgVGhlIEJpbmFyeVJlYWRlciB0byB1c2UuCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuVXNlckxpc3RSZXF1ZXN0fQogKi8KCgpwcm90by5wYi5jbXMuVXNlckxpc3RSZXF1ZXN0LmRlc2VyaWFsaXplQmluYXJ5RnJvbVJlYWRlciA9IGZ1bmN0aW9uIChtc2csIHJlYWRlcikgewogIHdoaWxlIChyZWFkZXIubmV4dEZpZWxkKCkpIHsKICAgIGlmIChyZWFkZXIuaXNFbmRHcm91cCgpKSB7CiAgICAgIGJyZWFrOwogICAgfQoKICAgIHZhciBmaWVsZCA9IHJlYWRlci5nZXRGaWVsZE51bWJlcigpOwoKICAgIHN3aXRjaCAoZmllbGQpIHsKICAgICAgY2FzZSAxOgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkVWludDMyKCk7CiAgICAgICAgbXNnLnNldFBhZ2VObyh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlIDI6CiAgICAgICAgdmFyIHZhbHVlID0gcmVhZGVyLnJlYWRVaW50MzIoKTsKICAgICAgICBtc2cuc2V0UGFnZVNpemUodmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSAzOgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkVWludDMyKCk7CiAgICAgICAgbXNnLnNldFVzZXJJZCh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlIDQ6CiAgICAgICAgdmFyIHZhbHVlID0gcmVhZGVyLnJlYWRVaW50MzIoKTsKICAgICAgICBtc2cuc2V0QXJlYUlkKHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgNToKICAgICAgICB2YXIgdmFsdWUgPSByZWFkZXIucmVhZFN0cmluZygpOwogICAgICAgIG1zZy5zZXROaWNrbmFtZSh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlIDY6CiAgICAgICAgdmFyIHZhbHVlID0gcmVhZGVyLnJlYWRCb29sKCk7CiAgICAgICAgbXNnLnNldFZpcE9ubHkodmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSA3OgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkQm9vbCgpOwogICAgICAgIG1zZy5zZXREZXBvc2l0T25seSh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlIDg6CiAgICAgICAgdmFyIHZhbHVlID0gcmVhZGVyLnJlYWRVaW50MzIoKTsKICAgICAgICBtc2cuc2V0TWluQmFsYW5jZSh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlIDk6CiAgICAgICAgdmFyIHZhbHVlID0gcmVhZGVyLnJlYWRVaW50MzIoKTsKICAgICAgICBtc2cuc2V0Q3JlYXRlZFN0YXJ0KHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgMTA6CiAgICAgICAgdmFyIHZhbHVlID0gcmVhZGVyLnJlYWRVaW50MzIoKTsKICAgICAgICBtc2cuc2V0Q3JlYXRlZEVuZCh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBkZWZhdWx0OgogICAgICAgIHJlYWRlci5za2lwRmllbGQoKTsKICAgICAgICBicmVhazsKICAgIH0KICB9CgogIHJldHVybiBtc2c7Cn07Ci8qKgogKiBTZXJpYWxpemVzIHRoZSBtZXNzYWdlIHRvIGJpbmFyeSBkYXRhIChpbiBwcm90b2J1ZiB3aXJlIGZvcm1hdCkuCiAqIEByZXR1cm4geyFVaW50OEFycmF5fQogKi8KCgpwcm90by5wYi5jbXMuVXNlckxpc3RSZXF1ZXN0LnByb3RvdHlwZS5zZXJpYWxpemVCaW5hcnkgPSBmdW5jdGlvbiAoKSB7CiAgdmFyIHdyaXRlciA9IG5ldyBqc3BiLkJpbmFyeVdyaXRlcigpOwogIHByb3RvLnBiLmNtcy5Vc2VyTGlzdFJlcXVlc3Quc2VyaWFsaXplQmluYXJ5VG9Xcml0ZXIodGhpcywgd3JpdGVyKTsKICByZXR1cm4gd3JpdGVyLmdldFJlc3VsdEJ1ZmZlcigpOwp9OwovKioKICogU2VyaWFsaXplcyB0aGUgZ2l2ZW4gbWVzc2FnZSB0byBiaW5hcnkgZGF0YSAoaW4gcHJvdG9idWYgd2lyZQogKiBmb3JtYXQpLCB3cml0aW5nIHRvIHRoZSBnaXZlbiBCaW5hcnlXcml0ZXIuCiAqIEBwYXJhbSB7IXByb3RvLnBiLmNtcy5Vc2VyTGlzdFJlcXVlc3R9IG1lc3NhZ2UKICogQHBhcmFtIHshanNwYi5CaW5hcnlXcml0ZXJ9IHdyaXRlcgogKiBAc3VwcHJlc3Mge3VudXNlZExvY2FsVmFyaWFibGVzfSBmIGlzIG9ubHkgdXNlZCBmb3IgbmVzdGVkIG1lc3NhZ2VzCiAqLwoKCnByb3RvLnBiLmNtcy5Vc2VyTGlzdFJlcXVlc3Quc2VyaWFsaXplQmluYXJ5VG9Xcml0ZXIgPSBmdW5jdGlvbiAobWVzc2FnZSwgd3JpdGVyKSB7CiAgdmFyIGYgPSB1bmRlZmluZWQ7CiAgZiA9IG1lc3NhZ2UuZ2V0UGFnZU5vKCk7CgogIGlmIChmICE9PSAwKSB7CiAgICB3cml0ZXIud3JpdGVVaW50MzIoMSwgZik7CiAgfQoKICBmID0gbWVzc2FnZS5nZXRQYWdlU2l6ZSgpOwoKICBpZiAoZiAhPT0gMCkgewogICAgd3JpdGVyLndyaXRlVWludDMyKDIsIGYpOwogIH0KCiAgZiA9IG1lc3NhZ2UuZ2V0VXNlcklkKCk7CgogIGlmIChmICE9PSAwKSB7CiAgICB3cml0ZXIud3JpdGVVaW50MzIoMywgZik7CiAgfQoKICBmID0gbWVzc2FnZS5nZXRBcmVhSWQoKTsKCiAgaWYgKGYgIT09IDApIHsKICAgIHdyaXRlci53cml0ZVVpbnQzMig0LCBmKTsKICB9CgogIGYgPSBtZXNzYWdlLmdldE5pY2tuYW1lKCk7CgogIGlmIChmLmxlbmd0aCA+IDApIHsKICAgIHdyaXRlci53cml0ZVN0cmluZyg1LCBmKTsKICB9CgogIGYgPSBtZXNzYWdlLmdldFZpcE9ubHkoKTsKCiAgaWYgKGYpIHsKICAgIHdyaXRlci53cml0ZUJvb2woNiwgZik7CiAgfQoKICBmID0gbWVzc2FnZS5nZXREZXBvc2l0T25seSgpOwoKICBpZiAoZikgewogICAgd3JpdGVyLndyaXRlQm9vbCg3LCBmKTsKICB9CgogIGYgPSBtZXNzYWdlLmdldE1pbkJhbGFuY2UoKTsKCiAgaWYgKGYgIT09IDApIHsKICAgIHdyaXRlci53cml0ZVVpbnQzMig4LCBmKTsKICB9CgogIGYgPSBtZXNzYWdlLmdldENyZWF0ZWRTdGFydCgpOwoKICBpZiAoZiAhPT0gMCkgewogICAgd3JpdGVyLndyaXRlVWludDMyKDksIGYpOwogIH0KCiAgZiA9IG1lc3NhZ2UuZ2V0Q3JlYXRlZEVuZCgpOwoKICBpZiAoZiAhPT0gMCkgewogICAgd3JpdGVyLndyaXRlVWludDMyKDEwLCBmKTsKICB9Cn07Ci8qKgogKiBvcHRpb25hbCB1aW50MzIgcGFnZV9ubyA9IDE7CiAqIEByZXR1cm4ge251bWJlcn0KICovCgoKcHJvdG8ucGIuY21zLlVzZXJMaXN0UmVxdWVzdC5wcm90b3R5cGUuZ2V0UGFnZU5vID0gZnVuY3Rpb24gKCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdCh0aGlzLCAxLCAwKTsKfTsKLyoqCiAqIEBwYXJhbSB7bnVtYmVyfSB2YWx1ZQogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLlVzZXJMaXN0UmVxdWVzdH0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5Vc2VyTGlzdFJlcXVlc3QucHJvdG90eXBlLnNldFBhZ2VObyA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UHJvdG8zSW50RmllbGQodGhpcywgMSwgdmFsdWUpOwp9OwovKioKICogb3B0aW9uYWwgdWludDMyIHBhZ2Vfc2l6ZSA9IDI7CiAqIEByZXR1cm4ge251bWJlcn0KICovCgoKcHJvdG8ucGIuY21zLlVzZXJMaXN0UmVxdWVzdC5wcm90b3R5cGUuZ2V0UGFnZVNpemUgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDIsIDApOwp9OwovKioKICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuVXNlckxpc3RSZXF1ZXN0fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLlVzZXJMaXN0UmVxdWVzdC5wcm90b3R5cGUuc2V0UGFnZVNpemUgPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0ludEZpZWxkKHRoaXMsIDIsIHZhbHVlKTsKfTsKLyoqCiAqIG9wdGlvbmFsIHVpbnQzMiB1c2VyX2lkID0gMzsKICogQHJldHVybiB7bnVtYmVyfQogKi8KCgpwcm90by5wYi5jbXMuVXNlckxpc3RSZXF1ZXN0LnByb3RvdHlwZS5nZXRVc2VySWQgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDMsIDApOwp9OwovKioKICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuVXNlckxpc3RSZXF1ZXN0fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLlVzZXJMaXN0UmVxdWVzdC5wcm90b3R5cGUuc2V0VXNlcklkID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRQcm90bzNJbnRGaWVsZCh0aGlzLCAzLCB2YWx1ZSk7Cn07Ci8qKgogKiBvcHRpb25hbCB1aW50MzIgYXJlYV9pZCA9IDQ7CiAqIEByZXR1cm4ge251bWJlcn0KICovCgoKcHJvdG8ucGIuY21zLlVzZXJMaXN0UmVxdWVzdC5wcm90b3R5cGUuZ2V0QXJlYUlkID0gZnVuY3Rpb24gKCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdCh0aGlzLCA0LCAwKTsKfTsKLyoqCiAqIEBwYXJhbSB7bnVtYmVyfSB2YWx1ZQogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLlVzZXJMaXN0UmVxdWVzdH0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5Vc2VyTGlzdFJlcXVlc3QucHJvdG90eXBlLnNldEFyZWFJZCA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UHJvdG8zSW50RmllbGQodGhpcywgNCwgdmFsdWUpOwp9OwovKioKICogb3B0aW9uYWwgc3RyaW5nIG5pY2tuYW1lID0gNTsKICogQHJldHVybiB7c3RyaW5nfQogKi8KCgpwcm90by5wYi5jbXMuVXNlckxpc3RSZXF1ZXN0LnByb3RvdHlwZS5nZXROaWNrbmFtZSA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQodGhpcywgNSwgIiIpOwp9OwovKioKICogQHBhcmFtIHtzdHJpbmd9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuVXNlckxpc3RSZXF1ZXN0fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLlVzZXJMaXN0UmVxdWVzdC5wcm90b3R5cGUuc2V0Tmlja25hbWUgPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM1N0cmluZ0ZpZWxkKHRoaXMsIDUsIHZhbHVlKTsKfTsKLyoqCiAqIG9wdGlvbmFsIGJvb2wgdmlwX29ubHkgPSA2OwogKiBAcmV0dXJuIHtib29sZWFufQogKi8KCgpwcm90by5wYi5jbXMuVXNlckxpc3RSZXF1ZXN0LnByb3RvdHlwZS5nZXRWaXBPbmx5ID0gZnVuY3Rpb24gKCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuZ2V0Qm9vbGVhbkZpZWxkV2l0aERlZmF1bHQodGhpcywgNiwgZmFsc2UpOwp9OwovKioKICogQHBhcmFtIHtib29sZWFufSB2YWx1ZQogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLlVzZXJMaXN0UmVxdWVzdH0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5Vc2VyTGlzdFJlcXVlc3QucHJvdG90eXBlLnNldFZpcE9ubHkgPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0Jvb2xlYW5GaWVsZCh0aGlzLCA2LCB2YWx1ZSk7Cn07Ci8qKgogKiBvcHRpb25hbCBib29sIGRlcG9zaXRfb25seSA9IDc7CiAqIEByZXR1cm4ge2Jvb2xlYW59CiAqLwoKCnByb3RvLnBiLmNtcy5Vc2VyTGlzdFJlcXVlc3QucHJvdG90eXBlLmdldERlcG9zaXRPbmx5ID0gZnVuY3Rpb24gKCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuZ2V0Qm9vbGVhbkZpZWxkV2l0aERlZmF1bHQodGhpcywgNywgZmFsc2UpOwp9OwovKioKICogQHBhcmFtIHtib29sZWFufSB2YWx1ZQogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLlVzZXJMaXN0UmVxdWVzdH0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5Vc2VyTGlzdFJlcXVlc3QucHJvdG90eXBlLnNldERlcG9zaXRPbmx5ID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRQcm90bzNCb29sZWFuRmllbGQodGhpcywgNywgdmFsdWUpOwp9OwovKioKICogb3B0aW9uYWwgdWludDMyIG1pbl9iYWxhbmNlID0gODsKICogQHJldHVybiB7bnVtYmVyfQogKi8KCgpwcm90by5wYi5jbXMuVXNlckxpc3RSZXF1ZXN0LnByb3RvdHlwZS5nZXRNaW5CYWxhbmNlID0gZnVuY3Rpb24gKCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdCh0aGlzLCA4LCAwKTsKfTsKLyoqCiAqIEBwYXJhbSB7bnVtYmVyfSB2YWx1ZQogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLlVzZXJMaXN0UmVxdWVzdH0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5Vc2VyTGlzdFJlcXVlc3QucHJvdG90eXBlLnNldE1pbkJhbGFuY2UgPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0ludEZpZWxkKHRoaXMsIDgsIHZhbHVlKTsKfTsKLyoqCiAqIG9wdGlvbmFsIHVpbnQzMiBjcmVhdGVkX3N0YXJ0ID0gOTsKICogQHJldHVybiB7bnVtYmVyfQogKi8KCgpwcm90by5wYi5jbXMuVXNlckxpc3RSZXF1ZXN0LnByb3RvdHlwZS5nZXRDcmVhdGVkU3RhcnQgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDksIDApOwp9OwovKioKICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuVXNlckxpc3RSZXF1ZXN0fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLlVzZXJMaXN0UmVxdWVzdC5wcm90b3R5cGUuc2V0Q3JlYXRlZFN0YXJ0ID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRQcm90bzNJbnRGaWVsZCh0aGlzLCA5LCB2YWx1ZSk7Cn07Ci8qKgogKiBvcHRpb25hbCB1aW50MzIgY3JlYXRlZF9lbmQgPSAxMDsKICogQHJldHVybiB7bnVtYmVyfQogKi8KCgpwcm90by5wYi5jbXMuVXNlckxpc3RSZXF1ZXN0LnByb3RvdHlwZS5nZXRDcmVhdGVkRW5kID0gZnVuY3Rpb24gKCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdCh0aGlzLCAxMCwgMCk7Cn07Ci8qKgogKiBAcGFyYW0ge251bWJlcn0gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5Vc2VyTGlzdFJlcXVlc3R9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuVXNlckxpc3RSZXF1ZXN0LnByb3RvdHlwZS5zZXRDcmVhdGVkRW5kID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRQcm90bzNJbnRGaWVsZCh0aGlzLCAxMCwgdmFsdWUpOwp9OwovKioKICogTGlzdCBvZiByZXBlYXRlZCBmaWVsZHMgd2l0aGluIHRoaXMgbWVzc2FnZSB0eXBlLgogKiBAcHJpdmF0ZSB7IUFycmF5PG51bWJlcj59CiAqIEBjb25zdAogKi8KCgpwcm90by5wYi5jbXMuVXNlckxpc3RSZXBseS5yZXBlYXRlZEZpZWxkc18gPSBbMV07CgppZiAoanNwYi5NZXNzYWdlLkdFTkVSQVRFX1RPX09CSkVDVCkgewogIC8qKgogICAqIENyZWF0ZXMgYW4gb2JqZWN0IHJlcHJlc2VudGF0aW9uIG9mIHRoaXMgcHJvdG8uCiAgICogRmllbGQgbmFtZXMgdGhhdCBhcmUgcmVzZXJ2ZWQgaW4gSmF2YVNjcmlwdCBhbmQgd2lsbCBiZSByZW5hbWVkIHRvIHBiX25hbWUuCiAgICogT3B0aW9uYWwgZmllbGRzIHRoYXQgYXJlIG5vdCBzZXQgd2lsbCBiZSBzZXQgdG8gdW5kZWZpbmVkLgogICAqIFRvIGFjY2VzcyBhIHJlc2VydmVkIGZpZWxkIHVzZSwgZm9vLnBiXzxuYW1lPiwgZWcsIGZvby5wYl9kZWZhdWx0LgogICAqIEZvciB0aGUgbGlzdCBvZiByZXNlcnZlZCBuYW1lcyBwbGVhc2Ugc2VlOgogICAqICAgICBuZXQvcHJvdG8yL2NvbXBpbGVyL2pzL2ludGVybmFsL2dlbmVyYXRvci5jYyNrS2V5d29yZC4KICAgKiBAcGFyYW0ge2Jvb2xlYW49fSBvcHRfaW5jbHVkZUluc3RhbmNlIERlcHJlY2F0ZWQuIHdoZXRoZXIgdG8gaW5jbHVkZSB0aGUKICAgKiAgICAgSlNQQiBpbnN0YW5jZSBmb3IgdHJhbnNpdGlvbmFsIHNveSBwcm90byBzdXBwb3J0OgogICAqICAgICBodHRwOi8vZ290by9zb3ktcGFyYW0tbWlncmF0aW9uCiAgICogQHJldHVybiB7IU9iamVjdH0KICAgKi8KICBwcm90by5wYi5jbXMuVXNlckxpc3RSZXBseS5wcm90b3R5cGUudG9PYmplY3QgPSBmdW5jdGlvbiAob3B0X2luY2x1ZGVJbnN0YW5jZSkgewogICAgcmV0dXJuIHByb3RvLnBiLmNtcy5Vc2VyTGlzdFJlcGx5LnRvT2JqZWN0KG9wdF9pbmNsdWRlSW5zdGFuY2UsIHRoaXMpOwogIH07CiAgLyoqCiAgICogU3RhdGljIHZlcnNpb24gb2YgdGhlIHtAc2VlIHRvT2JqZWN0fSBtZXRob2QuCiAgICogQHBhcmFtIHtib29sZWFufHVuZGVmaW5lZH0gaW5jbHVkZUluc3RhbmNlIERlcHJlY2F0ZWQuIFdoZXRoZXIgdG8gaW5jbHVkZQogICAqICAgICB0aGUgSlNQQiBpbnN0YW5jZSBmb3IgdHJhbnNpdGlvbmFsIHNveSBwcm90byBzdXBwb3J0OgogICAqICAgICBodHRwOi8vZ290by9zb3ktcGFyYW0tbWlncmF0aW9uCiAgICogQHBhcmFtIHshcHJvdG8ucGIuY21zLlVzZXJMaXN0UmVwbHl9IG1zZyBUaGUgbXNnIGluc3RhbmNlIHRvIHRyYW5zZm9ybS4KICAgKiBAcmV0dXJuIHshT2JqZWN0fQogICAqIEBzdXBwcmVzcyB7dW51c2VkTG9jYWxWYXJpYWJsZXN9IGYgaXMgb25seSB1c2VkIGZvciBuZXN0ZWQgbWVzc2FnZXMKICAgKi8KCgogIHByb3RvLnBiLmNtcy5Vc2VyTGlzdFJlcGx5LnRvT2JqZWN0ID0gZnVuY3Rpb24gKGluY2x1ZGVJbnN0YW5jZSwgbXNnKSB7CiAgICB2YXIgZiwKICAgICAgICBvYmogPSB7CiAgICAgIHVzZXJzTGlzdDoganNwYi5NZXNzYWdlLnRvT2JqZWN0TGlzdChtc2cuZ2V0VXNlcnNMaXN0KCksIHVzZXJ0eXBlX3BiLlVzZXIudG9PYmplY3QsIGluY2x1ZGVJbnN0YW5jZSksCiAgICAgIHBhZ2VObzoganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQobXNnLCAyLCAwKSwKICAgICAgcGFnZVNpemU6IGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KG1zZywgMywgMCksCiAgICAgIHRvdGFsUGFnZToganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQobXNnLCA0LCAwKSwKICAgICAgdG90YWxDb3VudDoganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQobXNnLCA1LCAwKQogICAgfTsKCiAgICBpZiAoaW5jbHVkZUluc3RhbmNlKSB7CiAgICAgIG9iai4kanNwYk1lc3NhZ2VJbnN0YW5jZSA9IG1zZzsKICAgIH0KCiAgICByZXR1cm4gb2JqOwogIH07Cn0KLyoqCiAqIERlc2VyaWFsaXplcyBiaW5hcnkgZGF0YSAoaW4gcHJvdG9idWYgd2lyZSBmb3JtYXQpLgogKiBAcGFyYW0ge2pzcGIuQnl0ZVNvdXJjZX0gYnl0ZXMgVGhlIGJ5dGVzIHRvIGRlc2VyaWFsaXplLgogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLlVzZXJMaXN0UmVwbHl9CiAqLwoKCnByb3RvLnBiLmNtcy5Vc2VyTGlzdFJlcGx5LmRlc2VyaWFsaXplQmluYXJ5ID0gZnVuY3Rpb24gKGJ5dGVzKSB7CiAgdmFyIHJlYWRlciA9IG5ldyBqc3BiLkJpbmFyeVJlYWRlcihieXRlcyk7CiAgdmFyIG1zZyA9IG5ldyBwcm90by5wYi5jbXMuVXNlckxpc3RSZXBseSgpOwogIHJldHVybiBwcm90by5wYi5jbXMuVXNlckxpc3RSZXBseS5kZXNlcmlhbGl6ZUJpbmFyeUZyb21SZWFkZXIobXNnLCByZWFkZXIpOwp9OwovKioKICogRGVzZXJpYWxpemVzIGJpbmFyeSBkYXRhIChpbiBwcm90b2J1ZiB3aXJlIGZvcm1hdCkgZnJvbSB0aGUKICogZ2l2ZW4gcmVhZGVyIGludG8gdGhlIGdpdmVuIG1lc3NhZ2Ugb2JqZWN0LgogKiBAcGFyYW0geyFwcm90by5wYi5jbXMuVXNlckxpc3RSZXBseX0gbXNnIFRoZSBtZXNzYWdlIG9iamVjdCB0byBkZXNlcmlhbGl6ZSBpbnRvLgogKiBAcGFyYW0geyFqc3BiLkJpbmFyeVJlYWRlcn0gcmVhZGVyIFRoZSBCaW5hcnlSZWFkZXIgdG8gdXNlLgogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLlVzZXJMaXN0UmVwbHl9CiAqLwoKCnByb3RvLnBiLmNtcy5Vc2VyTGlzdFJlcGx5LmRlc2VyaWFsaXplQmluYXJ5RnJvbVJlYWRlciA9IGZ1bmN0aW9uIChtc2csIHJlYWRlcikgewogIHdoaWxlIChyZWFkZXIubmV4dEZpZWxkKCkpIHsKICAgIGlmIChyZWFkZXIuaXNFbmRHcm91cCgpKSB7CiAgICAgIGJyZWFrOwogICAgfQoKICAgIHZhciBmaWVsZCA9IHJlYWRlci5nZXRGaWVsZE51bWJlcigpOwoKICAgIHN3aXRjaCAoZmllbGQpIHsKICAgICAgY2FzZSAxOgogICAgICAgIHZhciB2YWx1ZSA9IG5ldyB1c2VydHlwZV9wYi5Vc2VyKCk7CiAgICAgICAgcmVhZGVyLnJlYWRNZXNzYWdlKHZhbHVlLCB1c2VydHlwZV9wYi5Vc2VyLmRlc2VyaWFsaXplQmluYXJ5RnJvbVJlYWRlcik7CiAgICAgICAgbXNnLmFkZFVzZXJzKHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgMjoKICAgICAgICB2YXIgdmFsdWUgPSByZWFkZXIucmVhZFVpbnQzMigpOwogICAgICAgIG1zZy5zZXRQYWdlTm8odmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSAzOgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkVWludDMyKCk7CiAgICAgICAgbXNnLnNldFBhZ2VTaXplKHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgNDoKICAgICAgICB2YXIgdmFsdWUgPSByZWFkZXIucmVhZFVpbnQzMigpOwogICAgICAgIG1zZy5zZXRUb3RhbFBhZ2UodmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSA1OgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkVWludDMyKCk7CiAgICAgICAgbXNnLnNldFRvdGFsQ291bnQodmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgZGVmYXVsdDoKICAgICAgICByZWFkZXIuc2tpcEZpZWxkKCk7CiAgICAgICAgYnJlYWs7CiAgICB9CiAgfQoKICByZXR1cm4gbXNnOwp9OwovKioKICogU2VyaWFsaXplcyB0aGUgbWVzc2FnZSB0byBiaW5hcnkgZGF0YSAoaW4gcHJvdG9idWYgd2lyZSBmb3JtYXQpLgogKiBAcmV0dXJuIHshVWludDhBcnJheX0KICovCgoKcHJvdG8ucGIuY21zLlVzZXJMaXN0UmVwbHkucHJvdG90eXBlLnNlcmlhbGl6ZUJpbmFyeSA9IGZ1bmN0aW9uICgpIHsKICB2YXIgd3JpdGVyID0gbmV3IGpzcGIuQmluYXJ5V3JpdGVyKCk7CiAgcHJvdG8ucGIuY21zLlVzZXJMaXN0UmVwbHkuc2VyaWFsaXplQmluYXJ5VG9Xcml0ZXIodGhpcywgd3JpdGVyKTsKICByZXR1cm4gd3JpdGVyLmdldFJlc3VsdEJ1ZmZlcigpOwp9OwovKioKICogU2VyaWFsaXplcyB0aGUgZ2l2ZW4gbWVzc2FnZSB0byBiaW5hcnkgZGF0YSAoaW4gcHJvdG9idWYgd2lyZQogKiBmb3JtYXQpLCB3cml0aW5nIHRvIHRoZSBnaXZlbiBCaW5hcnlXcml0ZXIuCiAqIEBwYXJhbSB7IXByb3RvLnBiLmNtcy5Vc2VyTGlzdFJlcGx5fSBtZXNzYWdlCiAqIEBwYXJhbSB7IWpzcGIuQmluYXJ5V3JpdGVyfSB3cml0ZXIKICogQHN1cHByZXNzIHt1bnVzZWRMb2NhbFZhcmlhYmxlc30gZiBpcyBvbmx5IHVzZWQgZm9yIG5lc3RlZCBtZXNzYWdlcwogKi8KCgpwcm90by5wYi5jbXMuVXNlckxpc3RSZXBseS5zZXJpYWxpemVCaW5hcnlUb1dyaXRlciA9IGZ1bmN0aW9uIChtZXNzYWdlLCB3cml0ZXIpIHsKICB2YXIgZiA9IHVuZGVmaW5lZDsKICBmID0gbWVzc2FnZS5nZXRVc2Vyc0xpc3QoKTsKCiAgaWYgKGYubGVuZ3RoID4gMCkgewogICAgd3JpdGVyLndyaXRlUmVwZWF0ZWRNZXNzYWdlKDEsIGYsIHVzZXJ0eXBlX3BiLlVzZXIuc2VyaWFsaXplQmluYXJ5VG9Xcml0ZXIpOwogIH0KCiAgZiA9IG1lc3NhZ2UuZ2V0UGFnZU5vKCk7CgogIGlmIChmICE9PSAwKSB7CiAgICB3cml0ZXIud3JpdGVVaW50MzIoMiwgZik7CiAgfQoKICBmID0gbWVzc2FnZS5nZXRQYWdlU2l6ZSgpOwoKICBpZiAoZiAhPT0gMCkgewogICAgd3JpdGVyLndyaXRlVWludDMyKDMsIGYpOwogIH0KCiAgZiA9IG1lc3NhZ2UuZ2V0VG90YWxQYWdlKCk7CgogIGlmIChmICE9PSAwKSB7CiAgICB3cml0ZXIud3JpdGVVaW50MzIoNCwgZik7CiAgfQoKICBmID0gbWVzc2FnZS5nZXRUb3RhbENvdW50KCk7CgogIGlmIChmICE9PSAwKSB7CiAgICB3cml0ZXIud3JpdGVVaW50MzIoNSwgZik7CiAgfQp9OwovKioKICogcmVwZWF0ZWQgcGIuVXNlciB1c2VycyA9IDE7CiAqIEByZXR1cm4geyFBcnJheTwhcHJvdG8ucGIuVXNlcj59CiAqLwoKCnByb3RvLnBiLmNtcy5Vc2VyTGlzdFJlcGx5LnByb3RvdHlwZS5nZXRVc2Vyc0xpc3QgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRSZXBlYXRlZFdyYXBwZXJGaWVsZCh0aGlzLCB1c2VydHlwZV9wYi5Vc2VyLCAxKTsKfTsKLyoqCiAqIEBwYXJhbSB7IUFycmF5PCFwcm90by5wYi5Vc2VyPn0gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5Vc2VyTGlzdFJlcGx5fSByZXR1cm5zIHRoaXMKKi8KCgpwcm90by5wYi5jbXMuVXNlckxpc3RSZXBseS5wcm90b3R5cGUuc2V0VXNlcnNMaXN0ID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRSZXBlYXRlZFdyYXBwZXJGaWVsZCh0aGlzLCAxLCB2YWx1ZSk7Cn07Ci8qKgogKiBAcGFyYW0geyFwcm90by5wYi5Vc2VyPX0gb3B0X3ZhbHVlCiAqIEBwYXJhbSB7bnVtYmVyPX0gb3B0X2luZGV4CiAqIEByZXR1cm4geyFwcm90by5wYi5Vc2VyfQogKi8KCgpwcm90by5wYi5jbXMuVXNlckxpc3RSZXBseS5wcm90b3R5cGUuYWRkVXNlcnMgPSBmdW5jdGlvbiAob3B0X3ZhbHVlLCBvcHRfaW5kZXgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmFkZFRvUmVwZWF0ZWRXcmFwcGVyRmllbGQodGhpcywgMSwgb3B0X3ZhbHVlLCBwcm90by5wYi5Vc2VyLCBvcHRfaW5kZXgpOwp9OwovKioKICogQ2xlYXJzIHRoZSBsaXN0IG1ha2luZyBpdCBlbXB0eSBidXQgbm9uLW51bGwuCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuVXNlckxpc3RSZXBseX0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5Vc2VyTGlzdFJlcGx5LnByb3RvdHlwZS5jbGVhclVzZXJzTGlzdCA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4gdGhpcy5zZXRVc2Vyc0xpc3QoW10pOwp9OwovKioKICogb3B0aW9uYWwgdWludDMyIHBhZ2Vfbm8gPSAyOwogKiBAcmV0dXJuIHtudW1iZXJ9CiAqLwoKCnByb3RvLnBiLmNtcy5Vc2VyTGlzdFJlcGx5LnByb3RvdHlwZS5nZXRQYWdlTm8gPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDIsIDApOwp9OwovKioKICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuVXNlckxpc3RSZXBseX0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5Vc2VyTGlzdFJlcGx5LnByb3RvdHlwZS5zZXRQYWdlTm8gPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0ludEZpZWxkKHRoaXMsIDIsIHZhbHVlKTsKfTsKLyoqCiAqIG9wdGlvbmFsIHVpbnQzMiBwYWdlX3NpemUgPSAzOwogKiBAcmV0dXJuIHtudW1iZXJ9CiAqLwoKCnByb3RvLnBiLmNtcy5Vc2VyTGlzdFJlcGx5LnByb3RvdHlwZS5nZXRQYWdlU2l6ZSA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQodGhpcywgMywgMCk7Cn07Ci8qKgogKiBAcGFyYW0ge251bWJlcn0gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5Vc2VyTGlzdFJlcGx5fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLlVzZXJMaXN0UmVwbHkucHJvdG90eXBlLnNldFBhZ2VTaXplID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRQcm90bzNJbnRGaWVsZCh0aGlzLCAzLCB2YWx1ZSk7Cn07Ci8qKgogKiBvcHRpb25hbCB1aW50MzIgdG90YWxfcGFnZSA9IDQ7CiAqIEByZXR1cm4ge251bWJlcn0KICovCgoKcHJvdG8ucGIuY21zLlVzZXJMaXN0UmVwbHkucHJvdG90eXBlLmdldFRvdGFsUGFnZSA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQodGhpcywgNCwgMCk7Cn07Ci8qKgogKiBAcGFyYW0ge251bWJlcn0gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5Vc2VyTGlzdFJlcGx5fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLlVzZXJMaXN0UmVwbHkucHJvdG90eXBlLnNldFRvdGFsUGFnZSA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UHJvdG8zSW50RmllbGQodGhpcywgNCwgdmFsdWUpOwp9OwovKioKICogb3B0aW9uYWwgdWludDMyIHRvdGFsX2NvdW50ID0gNTsKICogQHJldHVybiB7bnVtYmVyfQogKi8KCgpwcm90by5wYi5jbXMuVXNlckxpc3RSZXBseS5wcm90b3R5cGUuZ2V0VG90YWxDb3VudCA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQodGhpcywgNSwgMCk7Cn07Ci8qKgogKiBAcGFyYW0ge251bWJlcn0gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5Vc2VyTGlzdFJlcGx5fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLlVzZXJMaXN0UmVwbHkucHJvdG90eXBlLnNldFRvdGFsQ291bnQgPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0ludEZpZWxkKHRoaXMsIDUsIHZhbHVlKTsKfTsKCmlmIChqc3BiLk1lc3NhZ2UuR0VORVJBVEVfVE9fT0JKRUNUKSB7CiAgLyoqCiAgICogQ3JlYXRlcyBhbiBvYmplY3QgcmVwcmVzZW50YXRpb24gb2YgdGhpcyBwcm90by4KICAgKiBGaWVsZCBuYW1lcyB0aGF0IGFyZSByZXNlcnZlZCBpbiBKYXZhU2NyaXB0IGFuZCB3aWxsIGJlIHJlbmFtZWQgdG8gcGJfbmFtZS4KICAgKiBPcHRpb25hbCBmaWVsZHMgdGhhdCBhcmUgbm90IHNldCB3aWxsIGJlIHNldCB0byB1bmRlZmluZWQuCiAgICogVG8gYWNjZXNzIGEgcmVzZXJ2ZWQgZmllbGQgdXNlLCBmb28ucGJfPG5hbWU+LCBlZywgZm9vLnBiX2RlZmF1bHQuCiAgICogRm9yIHRoZSBsaXN0IG9mIHJlc2VydmVkIG5hbWVzIHBsZWFzZSBzZWU6CiAgICogICAgIG5ldC9wcm90bzIvY29tcGlsZXIvanMvaW50ZXJuYWwvZ2VuZXJhdG9yLmNjI2tLZXl3b3JkLgogICAqIEBwYXJhbSB7Ym9vbGVhbj19IG9wdF9pbmNsdWRlSW5zdGFuY2UgRGVwcmVjYXRlZC4gd2hldGhlciB0byBpbmNsdWRlIHRoZQogICAqICAgICBKU1BCIGluc3RhbmNlIGZvciB0cmFuc2l0aW9uYWwgc295IHByb3RvIHN1cHBvcnQ6CiAgICogICAgIGh0dHA6Ly9nb3RvL3NveS1wYXJhbS1taWdyYXRpb24KICAgKiBAcmV0dXJuIHshT2JqZWN0fQogICAqLwogIHByb3RvLnBiLmNtcy5BZGp1c3RCYWxhbmNlUmVxdWVzdC5wcm90b3R5cGUudG9PYmplY3QgPSBmdW5jdGlvbiAob3B0X2luY2x1ZGVJbnN0YW5jZSkgewogICAgcmV0dXJuIHByb3RvLnBiLmNtcy5BZGp1c3RCYWxhbmNlUmVxdWVzdC50b09iamVjdChvcHRfaW5jbHVkZUluc3RhbmNlLCB0aGlzKTsKICB9OwogIC8qKgogICAqIFN0YXRpYyB2ZXJzaW9uIG9mIHRoZSB7QHNlZSB0b09iamVjdH0gbWV0aG9kLgogICAqIEBwYXJhbSB7Ym9vbGVhbnx1bmRlZmluZWR9IGluY2x1ZGVJbnN0YW5jZSBEZXByZWNhdGVkLiBXaGV0aGVyIHRvIGluY2x1ZGUKICAgKiAgICAgdGhlIEpTUEIgaW5zdGFuY2UgZm9yIHRyYW5zaXRpb25hbCBzb3kgcHJvdG8gc3VwcG9ydDoKICAgKiAgICAgaHR0cDovL2dvdG8vc295LXBhcmFtLW1pZ3JhdGlvbgogICAqIEBwYXJhbSB7IXByb3RvLnBiLmNtcy5BZGp1c3RCYWxhbmNlUmVxdWVzdH0gbXNnIFRoZSBtc2cgaW5zdGFuY2UgdG8gdHJhbnNmb3JtLgogICAqIEByZXR1cm4geyFPYmplY3R9CiAgICogQHN1cHByZXNzIHt1bnVzZWRMb2NhbFZhcmlhYmxlc30gZiBpcyBvbmx5IHVzZWQgZm9yIG5lc3RlZCBtZXNzYWdlcwogICAqLwoKCiAgcHJvdG8ucGIuY21zLkFkanVzdEJhbGFuY2VSZXF1ZXN0LnRvT2JqZWN0ID0gZnVuY3Rpb24gKGluY2x1ZGVJbnN0YW5jZSwgbXNnKSB7CiAgICB2YXIgZiwKICAgICAgICBvYmogPSB7CiAgICAgIGVudGl0eVR5cGU6IGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KG1zZywgMSwgMCksCiAgICAgIGVudGl0eUlkOiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdChtc2csIDIsIDApLAogICAgICBhbW91bnQ6IGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KG1zZywgMywgMCksCiAgICAgIHNlbmROb3RpZnk6IGpzcGIuTWVzc2FnZS5nZXRCb29sZWFuRmllbGRXaXRoRGVmYXVsdChtc2csIDQsIGZhbHNlKSwKICAgICAgZGVzYzoganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQobXNnLCA1LCAiIikKICAgIH07CgogICAgaWYgKGluY2x1ZGVJbnN0YW5jZSkgewogICAgICBvYmouJGpzcGJNZXNzYWdlSW5zdGFuY2UgPSBtc2c7CiAgICB9CgogICAgcmV0dXJuIG9iajsKICB9Owp9Ci8qKgogKiBEZXNlcmlhbGl6ZXMgYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUgZm9ybWF0KS4KICogQHBhcmFtIHtqc3BiLkJ5dGVTb3VyY2V9IGJ5dGVzIFRoZSBieXRlcyB0byBkZXNlcmlhbGl6ZS4KICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5BZGp1c3RCYWxhbmNlUmVxdWVzdH0KICovCgoKcHJvdG8ucGIuY21zLkFkanVzdEJhbGFuY2VSZXF1ZXN0LmRlc2VyaWFsaXplQmluYXJ5ID0gZnVuY3Rpb24gKGJ5dGVzKSB7CiAgdmFyIHJlYWRlciA9IG5ldyBqc3BiLkJpbmFyeVJlYWRlcihieXRlcyk7CiAgdmFyIG1zZyA9IG5ldyBwcm90by5wYi5jbXMuQWRqdXN0QmFsYW5jZVJlcXVlc3QoKTsKICByZXR1cm4gcHJvdG8ucGIuY21zLkFkanVzdEJhbGFuY2VSZXF1ZXN0LmRlc2VyaWFsaXplQmluYXJ5RnJvbVJlYWRlcihtc2csIHJlYWRlcik7Cn07Ci8qKgogKiBEZXNlcmlhbGl6ZXMgYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUgZm9ybWF0KSBmcm9tIHRoZQogKiBnaXZlbiByZWFkZXIgaW50byB0aGUgZ2l2ZW4gbWVzc2FnZSBvYmplY3QuCiAqIEBwYXJhbSB7IXByb3RvLnBiLmNtcy5BZGp1c3RCYWxhbmNlUmVxdWVzdH0gbXNnIFRoZSBtZXNzYWdlIG9iamVjdCB0byBkZXNlcmlhbGl6ZSBpbnRvLgogKiBAcGFyYW0geyFqc3BiLkJpbmFyeVJlYWRlcn0gcmVhZGVyIFRoZSBCaW5hcnlSZWFkZXIgdG8gdXNlLgogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLkFkanVzdEJhbGFuY2VSZXF1ZXN0fQogKi8KCgpwcm90by5wYi5jbXMuQWRqdXN0QmFsYW5jZVJlcXVlc3QuZGVzZXJpYWxpemVCaW5hcnlGcm9tUmVhZGVyID0gZnVuY3Rpb24gKG1zZywgcmVhZGVyKSB7CiAgd2hpbGUgKHJlYWRlci5uZXh0RmllbGQoKSkgewogICAgaWYgKHJlYWRlci5pc0VuZEdyb3VwKCkpIHsKICAgICAgYnJlYWs7CiAgICB9CgogICAgdmFyIGZpZWxkID0gcmVhZGVyLmdldEZpZWxkTnVtYmVyKCk7CgogICAgc3dpdGNoIChmaWVsZCkgewogICAgICBjYXNlIDE6CiAgICAgICAgdmFyIHZhbHVlID0gcmVhZGVyLnJlYWRFbnVtKCk7CiAgICAgICAgbXNnLnNldEVudGl0eVR5cGUodmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSAyOgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkVWludDMyKCk7CiAgICAgICAgbXNnLnNldEVudGl0eUlkKHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgMzoKICAgICAgICB2YXIgdmFsdWUgPSByZWFkZXIucmVhZEludDMyKCk7CiAgICAgICAgbXNnLnNldEFtb3VudCh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlIDQ6CiAgICAgICAgdmFyIHZhbHVlID0gcmVhZGVyLnJlYWRCb29sKCk7CiAgICAgICAgbXNnLnNldFNlbmROb3RpZnkodmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSA1OgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkU3RyaW5nKCk7CiAgICAgICAgbXNnLnNldERlc2ModmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgZGVmYXVsdDoKICAgICAgICByZWFkZXIuc2tpcEZpZWxkKCk7CiAgICAgICAgYnJlYWs7CiAgICB9CiAgfQoKICByZXR1cm4gbXNnOwp9OwovKioKICogU2VyaWFsaXplcyB0aGUgbWVzc2FnZSB0byBiaW5hcnkgZGF0YSAoaW4gcHJvdG9idWYgd2lyZSBmb3JtYXQpLgogKiBAcmV0dXJuIHshVWludDhBcnJheX0KICovCgoKcHJvdG8ucGIuY21zLkFkanVzdEJhbGFuY2VSZXF1ZXN0LnByb3RvdHlwZS5zZXJpYWxpemVCaW5hcnkgPSBmdW5jdGlvbiAoKSB7CiAgdmFyIHdyaXRlciA9IG5ldyBqc3BiLkJpbmFyeVdyaXRlcigpOwogIHByb3RvLnBiLmNtcy5BZGp1c3RCYWxhbmNlUmVxdWVzdC5zZXJpYWxpemVCaW5hcnlUb1dyaXRlcih0aGlzLCB3cml0ZXIpOwogIHJldHVybiB3cml0ZXIuZ2V0UmVzdWx0QnVmZmVyKCk7Cn07Ci8qKgogKiBTZXJpYWxpemVzIHRoZSBnaXZlbiBtZXNzYWdlIHRvIGJpbmFyeSBkYXRhIChpbiBwcm90b2J1ZiB3aXJlCiAqIGZvcm1hdCksIHdyaXRpbmcgdG8gdGhlIGdpdmVuIEJpbmFyeVdyaXRlci4KICogQHBhcmFtIHshcHJvdG8ucGIuY21zLkFkanVzdEJhbGFuY2VSZXF1ZXN0fSBtZXNzYWdlCiAqIEBwYXJhbSB7IWpzcGIuQmluYXJ5V3JpdGVyfSB3cml0ZXIKICogQHN1cHByZXNzIHt1bnVzZWRMb2NhbFZhcmlhYmxlc30gZiBpcyBvbmx5IHVzZWQgZm9yIG5lc3RlZCBtZXNzYWdlcwogKi8KCgpwcm90by5wYi5jbXMuQWRqdXN0QmFsYW5jZVJlcXVlc3Quc2VyaWFsaXplQmluYXJ5VG9Xcml0ZXIgPSBmdW5jdGlvbiAobWVzc2FnZSwgd3JpdGVyKSB7CiAgdmFyIGYgPSB1bmRlZmluZWQ7CiAgZiA9IG1lc3NhZ2UuZ2V0RW50aXR5VHlwZSgpOwoKICBpZiAoZiAhPT0gMC4wKSB7CiAgICB3cml0ZXIud3JpdGVFbnVtKDEsIGYpOwogIH0KCiAgZiA9IG1lc3NhZ2UuZ2V0RW50aXR5SWQoKTsKCiAgaWYgKGYgIT09IDApIHsKICAgIHdyaXRlci53cml0ZVVpbnQzMigyLCBmKTsKICB9CgogIGYgPSBtZXNzYWdlLmdldEFtb3VudCgpOwoKICBpZiAoZiAhPT0gMCkgewogICAgd3JpdGVyLndyaXRlSW50MzIoMywgZik7CiAgfQoKICBmID0gbWVzc2FnZS5nZXRTZW5kTm90aWZ5KCk7CgogIGlmIChmKSB7CiAgICB3cml0ZXIud3JpdGVCb29sKDQsIGYpOwogIH0KCiAgZiA9IG1lc3NhZ2UuZ2V0RGVzYygpOwoKICBpZiAoZi5sZW5ndGggPiAwKSB7CiAgICB3cml0ZXIud3JpdGVTdHJpbmcoNSwgZik7CiAgfQp9OwovKioKICogb3B0aW9uYWwgcGIuRW50aXR5VHlwZSBlbnRpdHlfdHlwZSA9IDE7CiAqIEByZXR1cm4geyFwcm90by5wYi5FbnRpdHlUeXBlfQogKi8KCgpwcm90by5wYi5jbXMuQWRqdXN0QmFsYW5jZVJlcXVlc3QucHJvdG90eXBlLmdldEVudGl0eVR5cGUgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDEsIDApOwp9OwovKioKICogQHBhcmFtIHshcHJvdG8ucGIuRW50aXR5VHlwZX0gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5BZGp1c3RCYWxhbmNlUmVxdWVzdH0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5BZGp1c3RCYWxhbmNlUmVxdWVzdC5wcm90b3R5cGUuc2V0RW50aXR5VHlwZSA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UHJvdG8zRW51bUZpZWxkKHRoaXMsIDEsIHZhbHVlKTsKfTsKLyoqCiAqIG9wdGlvbmFsIHVpbnQzMiBlbnRpdHlfaWQgPSAyOwogKiBAcmV0dXJuIHtudW1iZXJ9CiAqLwoKCnByb3RvLnBiLmNtcy5BZGp1c3RCYWxhbmNlUmVxdWVzdC5wcm90b3R5cGUuZ2V0RW50aXR5SWQgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDIsIDApOwp9OwovKioKICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuQWRqdXN0QmFsYW5jZVJlcXVlc3R9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuQWRqdXN0QmFsYW5jZVJlcXVlc3QucHJvdG90eXBlLnNldEVudGl0eUlkID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRQcm90bzNJbnRGaWVsZCh0aGlzLCAyLCB2YWx1ZSk7Cn07Ci8qKgogKiBvcHRpb25hbCBpbnQzMiBhbW91bnQgPSAzOwogKiBAcmV0dXJuIHtudW1iZXJ9CiAqLwoKCnByb3RvLnBiLmNtcy5BZGp1c3RCYWxhbmNlUmVxdWVzdC5wcm90b3R5cGUuZ2V0QW1vdW50ID0gZnVuY3Rpb24gKCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdCh0aGlzLCAzLCAwKTsKfTsKLyoqCiAqIEBwYXJhbSB7bnVtYmVyfSB2YWx1ZQogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLkFkanVzdEJhbGFuY2VSZXF1ZXN0fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLkFkanVzdEJhbGFuY2VSZXF1ZXN0LnByb3RvdHlwZS5zZXRBbW91bnQgPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0ludEZpZWxkKHRoaXMsIDMsIHZhbHVlKTsKfTsKLyoqCiAqIG9wdGlvbmFsIGJvb2wgc2VuZF9ub3RpZnkgPSA0OwogKiBAcmV0dXJuIHtib29sZWFufQogKi8KCgpwcm90by5wYi5jbXMuQWRqdXN0QmFsYW5jZVJlcXVlc3QucHJvdG90eXBlLmdldFNlbmROb3RpZnkgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRCb29sZWFuRmllbGRXaXRoRGVmYXVsdCh0aGlzLCA0LCBmYWxzZSk7Cn07Ci8qKgogKiBAcGFyYW0ge2Jvb2xlYW59IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuQWRqdXN0QmFsYW5jZVJlcXVlc3R9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuQWRqdXN0QmFsYW5jZVJlcXVlc3QucHJvdG90eXBlLnNldFNlbmROb3RpZnkgPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0Jvb2xlYW5GaWVsZCh0aGlzLCA0LCB2YWx1ZSk7Cn07Ci8qKgogKiBvcHRpb25hbCBzdHJpbmcgZGVzYyA9IDU7CiAqIEByZXR1cm4ge3N0cmluZ30KICovCgoKcHJvdG8ucGIuY21zLkFkanVzdEJhbGFuY2VSZXF1ZXN0LnByb3RvdHlwZS5nZXREZXNjID0gZnVuY3Rpb24gKCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdCh0aGlzLCA1LCAiIik7Cn07Ci8qKgogKiBAcGFyYW0ge3N0cmluZ30gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5BZGp1c3RCYWxhbmNlUmVxdWVzdH0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5BZGp1c3RCYWxhbmNlUmVxdWVzdC5wcm90b3R5cGUuc2V0RGVzYyA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UHJvdG8zU3RyaW5nRmllbGQodGhpcywgNSwgdmFsdWUpOwp9OwoKaWYgKGpzcGIuTWVzc2FnZS5HRU5FUkFURV9UT19PQkpFQ1QpIHsKICAvKioKICAgKiBDcmVhdGVzIGFuIG9iamVjdCByZXByZXNlbnRhdGlvbiBvZiB0aGlzIHByb3RvLgogICAqIEZpZWxkIG5hbWVzIHRoYXQgYXJlIHJlc2VydmVkIGluIEphdmFTY3JpcHQgYW5kIHdpbGwgYmUgcmVuYW1lZCB0byBwYl9uYW1lLgogICAqIE9wdGlvbmFsIGZpZWxkcyB0aGF0IGFyZSBub3Qgc2V0IHdpbGwgYmUgc2V0IHRvIHVuZGVmaW5lZC4KICAgKiBUbyBhY2Nlc3MgYSByZXNlcnZlZCBmaWVsZCB1c2UsIGZvby5wYl88bmFtZT4sIGVnLCBmb28ucGJfZGVmYXVsdC4KICAgKiBGb3IgdGhlIGxpc3Qgb2YgcmVzZXJ2ZWQgbmFtZXMgcGxlYXNlIHNlZToKICAgKiAgICAgbmV0L3Byb3RvMi9jb21waWxlci9qcy9pbnRlcm5hbC9nZW5lcmF0b3IuY2Mja0tleXdvcmQuCiAgICogQHBhcmFtIHtib29sZWFuPX0gb3B0X2luY2x1ZGVJbnN0YW5jZSBEZXByZWNhdGVkLiB3aGV0aGVyIHRvIGluY2x1ZGUgdGhlCiAgICogICAgIEpTUEIgaW5zdGFuY2UgZm9yIHRyYW5zaXRpb25hbCBzb3kgcHJvdG8gc3VwcG9ydDoKICAgKiAgICAgaHR0cDovL2dvdG8vc295LXBhcmFtLW1pZ3JhdGlvbgogICAqIEByZXR1cm4geyFPYmplY3R9CiAgICovCiAgcHJvdG8ucGIuY21zLkFkanVzdEJhbGFuY2VSZXBseS5wcm90b3R5cGUudG9PYmplY3QgPSBmdW5jdGlvbiAob3B0X2luY2x1ZGVJbnN0YW5jZSkgewogICAgcmV0dXJuIHByb3RvLnBiLmNtcy5BZGp1c3RCYWxhbmNlUmVwbHkudG9PYmplY3Qob3B0X2luY2x1ZGVJbnN0YW5jZSwgdGhpcyk7CiAgfTsKICAvKioKICAgKiBTdGF0aWMgdmVyc2lvbiBvZiB0aGUge0BzZWUgdG9PYmplY3R9IG1ldGhvZC4KICAgKiBAcGFyYW0ge2Jvb2xlYW58dW5kZWZpbmVkfSBpbmNsdWRlSW5zdGFuY2UgRGVwcmVjYXRlZC4gV2hldGhlciB0byBpbmNsdWRlCiAgICogICAgIHRoZSBKU1BCIGluc3RhbmNlIGZvciB0cmFuc2l0aW9uYWwgc295IHByb3RvIHN1cHBvcnQ6CiAgICogICAgIGh0dHA6Ly9nb3RvL3NveS1wYXJhbS1taWdyYXRpb24KICAgKiBAcGFyYW0geyFwcm90by5wYi5jbXMuQWRqdXN0QmFsYW5jZVJlcGx5fSBtc2cgVGhlIG1zZyBpbnN0YW5jZSB0byB0cmFuc2Zvcm0uCiAgICogQHJldHVybiB7IU9iamVjdH0KICAgKiBAc3VwcHJlc3Mge3VudXNlZExvY2FsVmFyaWFibGVzfSBmIGlzIG9ubHkgdXNlZCBmb3IgbmVzdGVkIG1lc3NhZ2VzCiAgICovCgoKICBwcm90by5wYi5jbXMuQWRqdXN0QmFsYW5jZVJlcGx5LnRvT2JqZWN0ID0gZnVuY3Rpb24gKGluY2x1ZGVJbnN0YW5jZSwgbXNnKSB7CiAgICB2YXIgZiwKICAgICAgICBvYmogPSB7CiAgICAgIGJhbGFuY2U6IGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KG1zZywgMSwgMCkKICAgIH07CgogICAgaWYgKGluY2x1ZGVJbnN0YW5jZSkgewogICAgICBvYmouJGpzcGJNZXNzYWdlSW5zdGFuY2UgPSBtc2c7CiAgICB9CgogICAgcmV0dXJuIG9iajsKICB9Owp9Ci8qKgogKiBEZXNlcmlhbGl6ZXMgYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUgZm9ybWF0KS4KICogQHBhcmFtIHtqc3BiLkJ5dGVTb3VyY2V9IGJ5dGVzIFRoZSBieXRlcyB0byBkZXNlcmlhbGl6ZS4KICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5BZGp1c3RCYWxhbmNlUmVwbHl9CiAqLwoKCnByb3RvLnBiLmNtcy5BZGp1c3RCYWxhbmNlUmVwbHkuZGVzZXJpYWxpemVCaW5hcnkgPSBmdW5jdGlvbiAoYnl0ZXMpIHsKICB2YXIgcmVhZGVyID0gbmV3IGpzcGIuQmluYXJ5UmVhZGVyKGJ5dGVzKTsKICB2YXIgbXNnID0gbmV3IHByb3RvLnBiLmNtcy5BZGp1c3RCYWxhbmNlUmVwbHkoKTsKICByZXR1cm4gcHJvdG8ucGIuY21zLkFkanVzdEJhbGFuY2VSZXBseS5kZXNlcmlhbGl6ZUJpbmFyeUZyb21SZWFkZXIobXNnLCByZWFkZXIpOwp9OwovKioKICogRGVzZXJpYWxpemVzIGJpbmFyeSBkYXRhIChpbiBwcm90b2J1ZiB3aXJlIGZvcm1hdCkgZnJvbSB0aGUKICogZ2l2ZW4gcmVhZGVyIGludG8gdGhlIGdpdmVuIG1lc3NhZ2Ugb2JqZWN0LgogKiBAcGFyYW0geyFwcm90by5wYi5jbXMuQWRqdXN0QmFsYW5jZVJlcGx5fSBtc2cgVGhlIG1lc3NhZ2Ugb2JqZWN0IHRvIGRlc2VyaWFsaXplIGludG8uCiAqIEBwYXJhbSB7IWpzcGIuQmluYXJ5UmVhZGVyfSByZWFkZXIgVGhlIEJpbmFyeVJlYWRlciB0byB1c2UuCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuQWRqdXN0QmFsYW5jZVJlcGx5fQogKi8KCgpwcm90by5wYi5jbXMuQWRqdXN0QmFsYW5jZVJlcGx5LmRlc2VyaWFsaXplQmluYXJ5RnJvbVJlYWRlciA9IGZ1bmN0aW9uIChtc2csIHJlYWRlcikgewogIHdoaWxlIChyZWFkZXIubmV4dEZpZWxkKCkpIHsKICAgIGlmIChyZWFkZXIuaXNFbmRHcm91cCgpKSB7CiAgICAgIGJyZWFrOwogICAgfQoKICAgIHZhciBmaWVsZCA9IHJlYWRlci5nZXRGaWVsZE51bWJlcigpOwoKICAgIHN3aXRjaCAoZmllbGQpIHsKICAgICAgY2FzZSAxOgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkVWludDMyKCk7CiAgICAgICAgbXNnLnNldEJhbGFuY2UodmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgZGVmYXVsdDoKICAgICAgICByZWFkZXIuc2tpcEZpZWxkKCk7CiAgICAgICAgYnJlYWs7CiAgICB9CiAgfQoKICByZXR1cm4gbXNnOwp9OwovKioKICogU2VyaWFsaXplcyB0aGUgbWVzc2FnZSB0byBiaW5hcnkgZGF0YSAoaW4gcHJvdG9idWYgd2lyZSBmb3JtYXQpLgogKiBAcmV0dXJuIHshVWludDhBcnJheX0KICovCgoKcHJvdG8ucGIuY21zLkFkanVzdEJhbGFuY2VSZXBseS5wcm90b3R5cGUuc2VyaWFsaXplQmluYXJ5ID0gZnVuY3Rpb24gKCkgewogIHZhciB3cml0ZXIgPSBuZXcganNwYi5CaW5hcnlXcml0ZXIoKTsKICBwcm90by5wYi5jbXMuQWRqdXN0QmFsYW5jZVJlcGx5LnNlcmlhbGl6ZUJpbmFyeVRvV3JpdGVyKHRoaXMsIHdyaXRlcik7CiAgcmV0dXJuIHdyaXRlci5nZXRSZXN1bHRCdWZmZXIoKTsKfTsKLyoqCiAqIFNlcmlhbGl6ZXMgdGhlIGdpdmVuIG1lc3NhZ2UgdG8gYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUKICogZm9ybWF0KSwgd3JpdGluZyB0byB0aGUgZ2l2ZW4gQmluYXJ5V3JpdGVyLgogKiBAcGFyYW0geyFwcm90by5wYi5jbXMuQWRqdXN0QmFsYW5jZVJlcGx5fSBtZXNzYWdlCiAqIEBwYXJhbSB7IWpzcGIuQmluYXJ5V3JpdGVyfSB3cml0ZXIKICogQHN1cHByZXNzIHt1bnVzZWRMb2NhbFZhcmlhYmxlc30gZiBpcyBvbmx5IHVzZWQgZm9yIG5lc3RlZCBtZXNzYWdlcwogKi8KCgpwcm90by5wYi5jbXMuQWRqdXN0QmFsYW5jZVJlcGx5LnNlcmlhbGl6ZUJpbmFyeVRvV3JpdGVyID0gZnVuY3Rpb24gKG1lc3NhZ2UsIHdyaXRlcikgewogIHZhciBmID0gdW5kZWZpbmVkOwogIGYgPSBtZXNzYWdlLmdldEJhbGFuY2UoKTsKCiAgaWYgKGYgIT09IDApIHsKICAgIHdyaXRlci53cml0ZVVpbnQzMigxLCBmKTsKICB9Cn07Ci8qKgogKiBvcHRpb25hbCB1aW50MzIgYmFsYW5jZSA9IDE7CiAqIEByZXR1cm4ge251bWJlcn0KICovCgoKcHJvdG8ucGIuY21zLkFkanVzdEJhbGFuY2VSZXBseS5wcm90b3R5cGUuZ2V0QmFsYW5jZSA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQodGhpcywgMSwgMCk7Cn07Ci8qKgogKiBAcGFyYW0ge251bWJlcn0gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5BZGp1c3RCYWxhbmNlUmVwbHl9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuQWRqdXN0QmFsYW5jZVJlcGx5LnByb3RvdHlwZS5zZXRCYWxhbmNlID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRQcm90bzNJbnRGaWVsZCh0aGlzLCAxLCB2YWx1ZSk7Cn07CgppZiAoanNwYi5NZXNzYWdlLkdFTkVSQVRFX1RPX09CSkVDVCkgewogIC8qKgogICAqIENyZWF0ZXMgYW4gb2JqZWN0IHJlcHJlc2VudGF0aW9uIG9mIHRoaXMgcHJvdG8uCiAgICogRmllbGQgbmFtZXMgdGhhdCBhcmUgcmVzZXJ2ZWQgaW4gSmF2YVNjcmlwdCBhbmQgd2lsbCBiZSByZW5hbWVkIHRvIHBiX25hbWUuCiAgICogT3B0aW9uYWwgZmllbGRzIHRoYXQgYXJlIG5vdCBzZXQgd2lsbCBiZSBzZXQgdG8gdW5kZWZpbmVkLgogICAqIFRvIGFjY2VzcyBhIHJlc2VydmVkIGZpZWxkIHVzZSwgZm9vLnBiXzxuYW1lPiwgZWcsIGZvby5wYl9kZWZhdWx0LgogICAqIEZvciB0aGUgbGlzdCBvZiByZXNlcnZlZCBuYW1lcyBwbGVhc2Ugc2VlOgogICAqICAgICBuZXQvcHJvdG8yL2NvbXBpbGVyL2pzL2ludGVybmFsL2dlbmVyYXRvci5jYyNrS2V5d29yZC4KICAgKiBAcGFyYW0ge2Jvb2xlYW49fSBvcHRfaW5jbHVkZUluc3RhbmNlIERlcHJlY2F0ZWQuIHdoZXRoZXIgdG8gaW5jbHVkZSB0aGUKICAgKiAgICAgSlNQQiBpbnN0YW5jZSBmb3IgdHJhbnNpdGlvbmFsIHNveSBwcm90byBzdXBwb3J0OgogICAqICAgICBodHRwOi8vZ290by9zb3ktcGFyYW0tbWlncmF0aW9uCiAgICogQHJldHVybiB7IU9iamVjdH0KICAgKi8KICBwcm90by5wYi5jbXMuQmxvY2tSZXF1ZXN0LnByb3RvdHlwZS50b09iamVjdCA9IGZ1bmN0aW9uIChvcHRfaW5jbHVkZUluc3RhbmNlKSB7CiAgICByZXR1cm4gcHJvdG8ucGIuY21zLkJsb2NrUmVxdWVzdC50b09iamVjdChvcHRfaW5jbHVkZUluc3RhbmNlLCB0aGlzKTsKICB9OwogIC8qKgogICAqIFN0YXRpYyB2ZXJzaW9uIG9mIHRoZSB7QHNlZSB0b09iamVjdH0gbWV0aG9kLgogICAqIEBwYXJhbSB7Ym9vbGVhbnx1bmRlZmluZWR9IGluY2x1ZGVJbnN0YW5jZSBEZXByZWNhdGVkLiBXaGV0aGVyIHRvIGluY2x1ZGUKICAgKiAgICAgdGhlIEpTUEIgaW5zdGFuY2UgZm9yIHRyYW5zaXRpb25hbCBzb3kgcHJvdG8gc3VwcG9ydDoKICAgKiAgICAgaHR0cDovL2dvdG8vc295LXBhcmFtLW1pZ3JhdGlvbgogICAqIEBwYXJhbSB7IXByb3RvLnBiLmNtcy5CbG9ja1JlcXVlc3R9IG1zZyBUaGUgbXNnIGluc3RhbmNlIHRvIHRyYW5zZm9ybS4KICAgKiBAcmV0dXJuIHshT2JqZWN0fQogICAqIEBzdXBwcmVzcyB7dW51c2VkTG9jYWxWYXJpYWJsZXN9IGYgaXMgb25seSB1c2VkIGZvciBuZXN0ZWQgbWVzc2FnZXMKICAgKi8KCgogIHByb3RvLnBiLmNtcy5CbG9ja1JlcXVlc3QudG9PYmplY3QgPSBmdW5jdGlvbiAoaW5jbHVkZUluc3RhbmNlLCBtc2cpIHsKICAgIHZhciBmLAogICAgICAgIG9iaiA9IHsKICAgICAgZW50aXR5VHlwZToganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQobXNnLCAxLCAwKSwKICAgICAgZW50aXR5SWQ6IGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KG1zZywgMiwgMCksCiAgICAgIGJsb2NrU3RhdHVzOiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdChtc2csIDMsIDApLAogICAgICBkdXJhdGlvbjoganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQobXNnLCA0LCAwKSwKICAgICAgcmVhc29uOiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdChtc2csIDUsICIiKQogICAgfTsKCiAgICBpZiAoaW5jbHVkZUluc3RhbmNlKSB7CiAgICAgIG9iai4kanNwYk1lc3NhZ2VJbnN0YW5jZSA9IG1zZzsKICAgIH0KCiAgICByZXR1cm4gb2JqOwogIH07Cn0KLyoqCiAqIERlc2VyaWFsaXplcyBiaW5hcnkgZGF0YSAoaW4gcHJvdG9idWYgd2lyZSBmb3JtYXQpLgogKiBAcGFyYW0ge2pzcGIuQnl0ZVNvdXJjZX0gYnl0ZXMgVGhlIGJ5dGVzIHRvIGRlc2VyaWFsaXplLgogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLkJsb2NrUmVxdWVzdH0KICovCgoKcHJvdG8ucGIuY21zLkJsb2NrUmVxdWVzdC5kZXNlcmlhbGl6ZUJpbmFyeSA9IGZ1bmN0aW9uIChieXRlcykgewogIHZhciByZWFkZXIgPSBuZXcganNwYi5CaW5hcnlSZWFkZXIoYnl0ZXMpOwogIHZhciBtc2cgPSBuZXcgcHJvdG8ucGIuY21zLkJsb2NrUmVxdWVzdCgpOwogIHJldHVybiBwcm90by5wYi5jbXMuQmxvY2tSZXF1ZXN0LmRlc2VyaWFsaXplQmluYXJ5RnJvbVJlYWRlcihtc2csIHJlYWRlcik7Cn07Ci8qKgogKiBEZXNlcmlhbGl6ZXMgYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUgZm9ybWF0KSBmcm9tIHRoZQogKiBnaXZlbiByZWFkZXIgaW50byB0aGUgZ2l2ZW4gbWVzc2FnZSBvYmplY3QuCiAqIEBwYXJhbSB7IXByb3RvLnBiLmNtcy5CbG9ja1JlcXVlc3R9IG1zZyBUaGUgbWVzc2FnZSBvYmplY3QgdG8gZGVzZXJpYWxpemUgaW50by4KICogQHBhcmFtIHshanNwYi5CaW5hcnlSZWFkZXJ9IHJlYWRlciBUaGUgQmluYXJ5UmVhZGVyIHRvIHVzZS4KICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5CbG9ja1JlcXVlc3R9CiAqLwoKCnByb3RvLnBiLmNtcy5CbG9ja1JlcXVlc3QuZGVzZXJpYWxpemVCaW5hcnlGcm9tUmVhZGVyID0gZnVuY3Rpb24gKG1zZywgcmVhZGVyKSB7CiAgd2hpbGUgKHJlYWRlci5uZXh0RmllbGQoKSkgewogICAgaWYgKHJlYWRlci5pc0VuZEdyb3VwKCkpIHsKICAgICAgYnJlYWs7CiAgICB9CgogICAgdmFyIGZpZWxkID0gcmVhZGVyLmdldEZpZWxkTnVtYmVyKCk7CgogICAgc3dpdGNoIChmaWVsZCkgewogICAgICBjYXNlIDE6CiAgICAgICAgdmFyIHZhbHVlID0gcmVhZGVyLnJlYWRFbnVtKCk7CiAgICAgICAgbXNnLnNldEVudGl0eVR5cGUodmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSAyOgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkVWludDMyKCk7CiAgICAgICAgbXNnLnNldEVudGl0eUlkKHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgMzoKICAgICAgICB2YXIgdmFsdWUgPSByZWFkZXIucmVhZEVudW0oKTsKICAgICAgICBtc2cuc2V0QmxvY2tTdGF0dXModmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSA0OgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkVWludDMyKCk7CiAgICAgICAgbXNnLnNldER1cmF0aW9uKHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgNToKICAgICAgICB2YXIgdmFsdWUgPSByZWFkZXIucmVhZFN0cmluZygpOwogICAgICAgIG1zZy5zZXRSZWFzb24odmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgZGVmYXVsdDoKICAgICAgICByZWFkZXIuc2tpcEZpZWxkKCk7CiAgICAgICAgYnJlYWs7CiAgICB9CiAgfQoKICByZXR1cm4gbXNnOwp9OwovKioKICogU2VyaWFsaXplcyB0aGUgbWVzc2FnZSB0byBiaW5hcnkgZGF0YSAoaW4gcHJvdG9idWYgd2lyZSBmb3JtYXQpLgogKiBAcmV0dXJuIHshVWludDhBcnJheX0KICovCgoKcHJvdG8ucGIuY21zLkJsb2NrUmVxdWVzdC5wcm90b3R5cGUuc2VyaWFsaXplQmluYXJ5ID0gZnVuY3Rpb24gKCkgewogIHZhciB3cml0ZXIgPSBuZXcganNwYi5CaW5hcnlXcml0ZXIoKTsKICBwcm90by5wYi5jbXMuQmxvY2tSZXF1ZXN0LnNlcmlhbGl6ZUJpbmFyeVRvV3JpdGVyKHRoaXMsIHdyaXRlcik7CiAgcmV0dXJuIHdyaXRlci5nZXRSZXN1bHRCdWZmZXIoKTsKfTsKLyoqCiAqIFNlcmlhbGl6ZXMgdGhlIGdpdmVuIG1lc3NhZ2UgdG8gYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUKICogZm9ybWF0KSwgd3JpdGluZyB0byB0aGUgZ2l2ZW4gQmluYXJ5V3JpdGVyLgogKiBAcGFyYW0geyFwcm90by5wYi5jbXMuQmxvY2tSZXF1ZXN0fSBtZXNzYWdlCiAqIEBwYXJhbSB7IWpzcGIuQmluYXJ5V3JpdGVyfSB3cml0ZXIKICogQHN1cHByZXNzIHt1bnVzZWRMb2NhbFZhcmlhYmxlc30gZiBpcyBvbmx5IHVzZWQgZm9yIG5lc3RlZCBtZXNzYWdlcwogKi8KCgpwcm90by5wYi5jbXMuQmxvY2tSZXF1ZXN0LnNlcmlhbGl6ZUJpbmFyeVRvV3JpdGVyID0gZnVuY3Rpb24gKG1lc3NhZ2UsIHdyaXRlcikgewogIHZhciBmID0gdW5kZWZpbmVkOwogIGYgPSBtZXNzYWdlLmdldEVudGl0eVR5cGUoKTsKCiAgaWYgKGYgIT09IDAuMCkgewogICAgd3JpdGVyLndyaXRlRW51bSgxLCBmKTsKICB9CgogIGYgPSBtZXNzYWdlLmdldEVudGl0eUlkKCk7CgogIGlmIChmICE9PSAwKSB7CiAgICB3cml0ZXIud3JpdGVVaW50MzIoMiwgZik7CiAgfQoKICBmID0gbWVzc2FnZS5nZXRCbG9ja1N0YXR1cygpOwoKICBpZiAoZiAhPT0gMC4wKSB7CiAgICB3cml0ZXIud3JpdGVFbnVtKDMsIGYpOwogIH0KCiAgZiA9IG1lc3NhZ2UuZ2V0RHVyYXRpb24oKTsKCiAgaWYgKGYgIT09IDApIHsKICAgIHdyaXRlci53cml0ZVVpbnQzMig0LCBmKTsKICB9CgogIGYgPSBtZXNzYWdlLmdldFJlYXNvbigpOwoKICBpZiAoZi5sZW5ndGggPiAwKSB7CiAgICB3cml0ZXIud3JpdGVTdHJpbmcoNSwgZik7CiAgfQp9OwovKioKICogb3B0aW9uYWwgcGIuRW50aXR5VHlwZSBlbnRpdHlfdHlwZSA9IDE7CiAqIEByZXR1cm4geyFwcm90by5wYi5FbnRpdHlUeXBlfQogKi8KCgpwcm90by5wYi5jbXMuQmxvY2tSZXF1ZXN0LnByb3RvdHlwZS5nZXRFbnRpdHlUeXBlID0gZnVuY3Rpb24gKCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdCh0aGlzLCAxLCAwKTsKfTsKLyoqCiAqIEBwYXJhbSB7IXByb3RvLnBiLkVudGl0eVR5cGV9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuQmxvY2tSZXF1ZXN0fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLkJsb2NrUmVxdWVzdC5wcm90b3R5cGUuc2V0RW50aXR5VHlwZSA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UHJvdG8zRW51bUZpZWxkKHRoaXMsIDEsIHZhbHVlKTsKfTsKLyoqCiAqIG9wdGlvbmFsIHVpbnQzMiBlbnRpdHlfaWQgPSAyOwogKiBAcmV0dXJuIHtudW1iZXJ9CiAqLwoKCnByb3RvLnBiLmNtcy5CbG9ja1JlcXVlc3QucHJvdG90eXBlLmdldEVudGl0eUlkID0gZnVuY3Rpb24gKCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdCh0aGlzLCAyLCAwKTsKfTsKLyoqCiAqIEBwYXJhbSB7bnVtYmVyfSB2YWx1ZQogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLkJsb2NrUmVxdWVzdH0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5CbG9ja1JlcXVlc3QucHJvdG90eXBlLnNldEVudGl0eUlkID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRQcm90bzNJbnRGaWVsZCh0aGlzLCAyLCB2YWx1ZSk7Cn07Ci8qKgogKiBvcHRpb25hbCBwYi5CbG9ja1N0YXR1cyBibG9ja19zdGF0dXMgPSAzOwogKiBAcmV0dXJuIHshcHJvdG8ucGIuQmxvY2tTdGF0dXN9CiAqLwoKCnByb3RvLnBiLmNtcy5CbG9ja1JlcXVlc3QucHJvdG90eXBlLmdldEJsb2NrU3RhdHVzID0gZnVuY3Rpb24gKCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdCh0aGlzLCAzLCAwKTsKfTsKLyoqCiAqIEBwYXJhbSB7IXByb3RvLnBiLkJsb2NrU3RhdHVzfSB2YWx1ZQogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLkJsb2NrUmVxdWVzdH0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5CbG9ja1JlcXVlc3QucHJvdG90eXBlLnNldEJsb2NrU3RhdHVzID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRQcm90bzNFbnVtRmllbGQodGhpcywgMywgdmFsdWUpOwp9OwovKioKICogb3B0aW9uYWwgdWludDMyIGR1cmF0aW9uID0gNDsKICogQHJldHVybiB7bnVtYmVyfQogKi8KCgpwcm90by5wYi5jbXMuQmxvY2tSZXF1ZXN0LnByb3RvdHlwZS5nZXREdXJhdGlvbiA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQodGhpcywgNCwgMCk7Cn07Ci8qKgogKiBAcGFyYW0ge251bWJlcn0gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5CbG9ja1JlcXVlc3R9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuQmxvY2tSZXF1ZXN0LnByb3RvdHlwZS5zZXREdXJhdGlvbiA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UHJvdG8zSW50RmllbGQodGhpcywgNCwgdmFsdWUpOwp9OwovKioKICogb3B0aW9uYWwgc3RyaW5nIHJlYXNvbiA9IDU7CiAqIEByZXR1cm4ge3N0cmluZ30KICovCgoKcHJvdG8ucGIuY21zLkJsb2NrUmVxdWVzdC5wcm90b3R5cGUuZ2V0UmVhc29uID0gZnVuY3Rpb24gKCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdCh0aGlzLCA1LCAiIik7Cn07Ci8qKgogKiBAcGFyYW0ge3N0cmluZ30gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5CbG9ja1JlcXVlc3R9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuQmxvY2tSZXF1ZXN0LnByb3RvdHlwZS5zZXRSZWFzb24gPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM1N0cmluZ0ZpZWxkKHRoaXMsIDUsIHZhbHVlKTsKfTsKCmlmIChqc3BiLk1lc3NhZ2UuR0VORVJBVEVfVE9fT0JKRUNUKSB7CiAgLyoqCiAgICogQ3JlYXRlcyBhbiBvYmplY3QgcmVwcmVzZW50YXRpb24gb2YgdGhpcyBwcm90by4KICAgKiBGaWVsZCBuYW1lcyB0aGF0IGFyZSByZXNlcnZlZCBpbiBKYXZhU2NyaXB0IGFuZCB3aWxsIGJlIHJlbmFtZWQgdG8gcGJfbmFtZS4KICAgKiBPcHRpb25hbCBmaWVsZHMgdGhhdCBhcmUgbm90IHNldCB3aWxsIGJlIHNldCB0byB1bmRlZmluZWQuCiAgICogVG8gYWNjZXNzIGEgcmVzZXJ2ZWQgZmllbGQgdXNlLCBmb28ucGJfPG5hbWU+LCBlZywgZm9vLnBiX2RlZmF1bHQuCiAgICogRm9yIHRoZSBsaXN0IG9mIHJlc2VydmVkIG5hbWVzIHBsZWFzZSBzZWU6CiAgICogICAgIG5ldC9wcm90bzIvY29tcGlsZXIvanMvaW50ZXJuYWwvZ2VuZXJhdG9yLmNjI2tLZXl3b3JkLgogICAqIEBwYXJhbSB7Ym9vbGVhbj19IG9wdF9pbmNsdWRlSW5zdGFuY2UgRGVwcmVjYXRlZC4gd2hldGhlciB0byBpbmNsdWRlIHRoZQogICAqICAgICBKU1BCIGluc3RhbmNlIGZvciB0cmFuc2l0aW9uYWwgc295IHByb3RvIHN1cHBvcnQ6CiAgICogICAgIGh0dHA6Ly9nb3RvL3NveS1wYXJhbS1taWdyYXRpb24KICAgKiBAcmV0dXJuIHshT2JqZWN0fQogICAqLwogIHByb3RvLnBiLmNtcy5VbmJsb2NrUmVxdWVzdC5wcm90b3R5cGUudG9PYmplY3QgPSBmdW5jdGlvbiAob3B0X2luY2x1ZGVJbnN0YW5jZSkgewogICAgcmV0dXJuIHByb3RvLnBiLmNtcy5VbmJsb2NrUmVxdWVzdC50b09iamVjdChvcHRfaW5jbHVkZUluc3RhbmNlLCB0aGlzKTsKICB9OwogIC8qKgogICAqIFN0YXRpYyB2ZXJzaW9uIG9mIHRoZSB7QHNlZSB0b09iamVjdH0gbWV0aG9kLgogICAqIEBwYXJhbSB7Ym9vbGVhbnx1bmRlZmluZWR9IGluY2x1ZGVJbnN0YW5jZSBEZXByZWNhdGVkLiBXaGV0aGVyIHRvIGluY2x1ZGUKICAgKiAgICAgdGhlIEpTUEIgaW5zdGFuY2UgZm9yIHRyYW5zaXRpb25hbCBzb3kgcHJvdG8gc3VwcG9ydDoKICAgKiAgICAgaHR0cDovL2dvdG8vc295LXBhcmFtLW1pZ3JhdGlvbgogICAqIEBwYXJhbSB7IXByb3RvLnBiLmNtcy5VbmJsb2NrUmVxdWVzdH0gbXNnIFRoZSBtc2cgaW5zdGFuY2UgdG8gdHJhbnNmb3JtLgogICAqIEByZXR1cm4geyFPYmplY3R9CiAgICogQHN1cHByZXNzIHt1bnVzZWRMb2NhbFZhcmlhYmxlc30gZiBpcyBvbmx5IHVzZWQgZm9yIG5lc3RlZCBtZXNzYWdlcwogICAqLwoKCiAgcHJvdG8ucGIuY21zLlVuYmxvY2tSZXF1ZXN0LnRvT2JqZWN0ID0gZnVuY3Rpb24gKGluY2x1ZGVJbnN0YW5jZSwgbXNnKSB7CiAgICB2YXIgZiwKICAgICAgICBvYmogPSB7CiAgICAgIGVudGl0eVR5cGU6IGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KG1zZywgMSwgMCksCiAgICAgIGVudGl0eUlkOiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdChtc2csIDIsIDApCiAgICB9OwoKICAgIGlmIChpbmNsdWRlSW5zdGFuY2UpIHsKICAgICAgb2JqLiRqc3BiTWVzc2FnZUluc3RhbmNlID0gbXNnOwogICAgfQoKICAgIHJldHVybiBvYmo7CiAgfTsKfQovKioKICogRGVzZXJpYWxpemVzIGJpbmFyeSBkYXRhIChpbiBwcm90b2J1ZiB3aXJlIGZvcm1hdCkuCiAqIEBwYXJhbSB7anNwYi5CeXRlU291cmNlfSBieXRlcyBUaGUgYnl0ZXMgdG8gZGVzZXJpYWxpemUuCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuVW5ibG9ja1JlcXVlc3R9CiAqLwoKCnByb3RvLnBiLmNtcy5VbmJsb2NrUmVxdWVzdC5kZXNlcmlhbGl6ZUJpbmFyeSA9IGZ1bmN0aW9uIChieXRlcykgewogIHZhciByZWFkZXIgPSBuZXcganNwYi5CaW5hcnlSZWFkZXIoYnl0ZXMpOwogIHZhciBtc2cgPSBuZXcgcHJvdG8ucGIuY21zLlVuYmxvY2tSZXF1ZXN0KCk7CiAgcmV0dXJuIHByb3RvLnBiLmNtcy5VbmJsb2NrUmVxdWVzdC5kZXNlcmlhbGl6ZUJpbmFyeUZyb21SZWFkZXIobXNnLCByZWFkZXIpOwp9OwovKioKICogRGVzZXJpYWxpemVzIGJpbmFyeSBkYXRhIChpbiBwcm90b2J1ZiB3aXJlIGZvcm1hdCkgZnJvbSB0aGUKICogZ2l2ZW4gcmVhZGVyIGludG8gdGhlIGdpdmVuIG1lc3NhZ2Ugb2JqZWN0LgogKiBAcGFyYW0geyFwcm90by5wYi5jbXMuVW5ibG9ja1JlcXVlc3R9IG1zZyBUaGUgbWVzc2FnZSBvYmplY3QgdG8gZGVzZXJpYWxpemUgaW50by4KICogQHBhcmFtIHshanNwYi5CaW5hcnlSZWFkZXJ9IHJlYWRlciBUaGUgQmluYXJ5UmVhZGVyIHRvIHVzZS4KICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5VbmJsb2NrUmVxdWVzdH0KICovCgoKcHJvdG8ucGIuY21zLlVuYmxvY2tSZXF1ZXN0LmRlc2VyaWFsaXplQmluYXJ5RnJvbVJlYWRlciA9IGZ1bmN0aW9uIChtc2csIHJlYWRlcikgewogIHdoaWxlIChyZWFkZXIubmV4dEZpZWxkKCkpIHsKICAgIGlmIChyZWFkZXIuaXNFbmRHcm91cCgpKSB7CiAgICAgIGJyZWFrOwogICAgfQoKICAgIHZhciBmaWVsZCA9IHJlYWRlci5nZXRGaWVsZE51bWJlcigpOwoKICAgIHN3aXRjaCAoZmllbGQpIHsKICAgICAgY2FzZSAxOgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkRW51bSgpOwogICAgICAgIG1zZy5zZXRFbnRpdHlUeXBlKHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgMjoKICAgICAgICB2YXIgdmFsdWUgPSByZWFkZXIucmVhZFVpbnQzMigpOwogICAgICAgIG1zZy5zZXRFbnRpdHlJZCh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBkZWZhdWx0OgogICAgICAgIHJlYWRlci5za2lwRmllbGQoKTsKICAgICAgICBicmVhazsKICAgIH0KICB9CgogIHJldHVybiBtc2c7Cn07Ci8qKgogKiBTZXJpYWxpemVzIHRoZSBtZXNzYWdlIHRvIGJpbmFyeSBkYXRhIChpbiBwcm90b2J1ZiB3aXJlIGZvcm1hdCkuCiAqIEByZXR1cm4geyFVaW50OEFycmF5fQogKi8KCgpwcm90by5wYi5jbXMuVW5ibG9ja1JlcXVlc3QucHJvdG90eXBlLnNlcmlhbGl6ZUJpbmFyeSA9IGZ1bmN0aW9uICgpIHsKICB2YXIgd3JpdGVyID0gbmV3IGpzcGIuQmluYXJ5V3JpdGVyKCk7CiAgcHJvdG8ucGIuY21zLlVuYmxvY2tSZXF1ZXN0LnNlcmlhbGl6ZUJpbmFyeVRvV3JpdGVyKHRoaXMsIHdyaXRlcik7CiAgcmV0dXJuIHdyaXRlci5nZXRSZXN1bHRCdWZmZXIoKTsKfTsKLyoqCiAqIFNlcmlhbGl6ZXMgdGhlIGdpdmVuIG1lc3NhZ2UgdG8gYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUKICogZm9ybWF0KSwgd3JpdGluZyB0byB0aGUgZ2l2ZW4gQmluYXJ5V3JpdGVyLgogKiBAcGFyYW0geyFwcm90by5wYi5jbXMuVW5ibG9ja1JlcXVlc3R9IG1lc3NhZ2UKICogQHBhcmFtIHshanNwYi5CaW5hcnlXcml0ZXJ9IHdyaXRlcgogKiBAc3VwcHJlc3Mge3VudXNlZExvY2FsVmFyaWFibGVzfSBmIGlzIG9ubHkgdXNlZCBmb3IgbmVzdGVkIG1lc3NhZ2VzCiAqLwoKCnByb3RvLnBiLmNtcy5VbmJsb2NrUmVxdWVzdC5zZXJpYWxpemVCaW5hcnlUb1dyaXRlciA9IGZ1bmN0aW9uIChtZXNzYWdlLCB3cml0ZXIpIHsKICB2YXIgZiA9IHVuZGVmaW5lZDsKICBmID0gbWVzc2FnZS5nZXRFbnRpdHlUeXBlKCk7CgogIGlmIChmICE9PSAwLjApIHsKICAgIHdyaXRlci53cml0ZUVudW0oMSwgZik7CiAgfQoKICBmID0gbWVzc2FnZS5nZXRFbnRpdHlJZCgpOwoKICBpZiAoZiAhPT0gMCkgewogICAgd3JpdGVyLndyaXRlVWludDMyKDIsIGYpOwogIH0KfTsKLyoqCiAqIG9wdGlvbmFsIHBiLkVudGl0eVR5cGUgZW50aXR5X3R5cGUgPSAxOwogKiBAcmV0dXJuIHshcHJvdG8ucGIuRW50aXR5VHlwZX0KICovCgoKcHJvdG8ucGIuY21zLlVuYmxvY2tSZXF1ZXN0LnByb3RvdHlwZS5nZXRFbnRpdHlUeXBlID0gZnVuY3Rpb24gKCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdCh0aGlzLCAxLCAwKTsKfTsKLyoqCiAqIEBwYXJhbSB7IXByb3RvLnBiLkVudGl0eVR5cGV9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuVW5ibG9ja1JlcXVlc3R9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuVW5ibG9ja1JlcXVlc3QucHJvdG90eXBlLnNldEVudGl0eVR5cGUgPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0VudW1GaWVsZCh0aGlzLCAxLCB2YWx1ZSk7Cn07Ci8qKgogKiBvcHRpb25hbCB1aW50MzIgZW50aXR5X2lkID0gMjsKICogQHJldHVybiB7bnVtYmVyfQogKi8KCgpwcm90by5wYi5jbXMuVW5ibG9ja1JlcXVlc3QucHJvdG90eXBlLmdldEVudGl0eUlkID0gZnVuY3Rpb24gKCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdCh0aGlzLCAyLCAwKTsKfTsKLyoqCiAqIEBwYXJhbSB7bnVtYmVyfSB2YWx1ZQogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLlVuYmxvY2tSZXF1ZXN0fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLlVuYmxvY2tSZXF1ZXN0LnByb3RvdHlwZS5zZXRFbnRpdHlJZCA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UHJvdG8zSW50RmllbGQodGhpcywgMiwgdmFsdWUpOwp9OwoKaWYgKGpzcGIuTWVzc2FnZS5HRU5FUkFURV9UT19PQkpFQ1QpIHsKICAvKioKICAgKiBDcmVhdGVzIGFuIG9iamVjdCByZXByZXNlbnRhdGlvbiBvZiB0aGlzIHByb3RvLgogICAqIEZpZWxkIG5hbWVzIHRoYXQgYXJlIHJlc2VydmVkIGluIEphdmFTY3JpcHQgYW5kIHdpbGwgYmUgcmVuYW1lZCB0byBwYl9uYW1lLgogICAqIE9wdGlvbmFsIGZpZWxkcyB0aGF0IGFyZSBub3Qgc2V0IHdpbGwgYmUgc2V0IHRvIHVuZGVmaW5lZC4KICAgKiBUbyBhY2Nlc3MgYSByZXNlcnZlZCBmaWVsZCB1c2UsIGZvby5wYl88bmFtZT4sIGVnLCBmb28ucGJfZGVmYXVsdC4KICAgKiBGb3IgdGhlIGxpc3Qgb2YgcmVzZXJ2ZWQgbmFtZXMgcGxlYXNlIHNlZToKICAgKiAgICAgbmV0L3Byb3RvMi9jb21waWxlci9qcy9pbnRlcm5hbC9nZW5lcmF0b3IuY2Mja0tleXdvcmQuCiAgICogQHBhcmFtIHtib29sZWFuPX0gb3B0X2luY2x1ZGVJbnN0YW5jZSBEZXByZWNhdGVkLiB3aGV0aGVyIHRvIGluY2x1ZGUgdGhlCiAgICogICAgIEpTUEIgaW5zdGFuY2UgZm9yIHRyYW5zaXRpb25hbCBzb3kgcHJvdG8gc3VwcG9ydDoKICAgKiAgICAgaHR0cDovL2dvdG8vc295LXBhcmFtLW1pZ3JhdGlvbgogICAqIEByZXR1cm4geyFPYmplY3R9CiAgICovCiAgcHJvdG8ucGIuY21zLk1pZ3JhdGVSZXF1ZXN0LnByb3RvdHlwZS50b09iamVjdCA9IGZ1bmN0aW9uIChvcHRfaW5jbHVkZUluc3RhbmNlKSB7CiAgICByZXR1cm4gcHJvdG8ucGIuY21zLk1pZ3JhdGVSZXF1ZXN0LnRvT2JqZWN0KG9wdF9pbmNsdWRlSW5zdGFuY2UsIHRoaXMpOwogIH07CiAgLyoqCiAgICogU3RhdGljIHZlcnNpb24gb2YgdGhlIHtAc2VlIHRvT2JqZWN0fSBtZXRob2QuCiAgICogQHBhcmFtIHtib29sZWFufHVuZGVmaW5lZH0gaW5jbHVkZUluc3RhbmNlIERlcHJlY2F0ZWQuIFdoZXRoZXIgdG8gaW5jbHVkZQogICAqICAgICB0aGUgSlNQQiBpbnN0YW5jZSBmb3IgdHJhbnNpdGlvbmFsIHNveSBwcm90byBzdXBwb3J0OgogICAqICAgICBodHRwOi8vZ290by9zb3ktcGFyYW0tbWlncmF0aW9uCiAgICogQHBhcmFtIHshcHJvdG8ucGIuY21zLk1pZ3JhdGVSZXF1ZXN0fSBtc2cgVGhlIG1zZyBpbnN0YW5jZSB0byB0cmFuc2Zvcm0uCiAgICogQHJldHVybiB7IU9iamVjdH0KICAgKiBAc3VwcHJlc3Mge3VudXNlZExvY2FsVmFyaWFibGVzfSBmIGlzIG9ubHkgdXNlZCBmb3IgbmVzdGVkIG1lc3NhZ2VzCiAgICovCgoKICBwcm90by5wYi5jbXMuTWlncmF0ZVJlcXVlc3QudG9PYmplY3QgPSBmdW5jdGlvbiAoaW5jbHVkZUluc3RhbmNlLCBtc2cpIHsKICAgIHZhciBmLAogICAgICAgIG9iaiA9IHsKICAgICAgZW50aXR5VHlwZToganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQobXNnLCAxLCAwKSwKICAgICAgc3JjSWQ6IGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KG1zZywgMiwgMCksCiAgICAgIGRzdElkOiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdChtc2csIDMsIDApCiAgICB9OwoKICAgIGlmIChpbmNsdWRlSW5zdGFuY2UpIHsKICAgICAgb2JqLiRqc3BiTWVzc2FnZUluc3RhbmNlID0gbXNnOwogICAgfQoKICAgIHJldHVybiBvYmo7CiAgfTsKfQovKioKICogRGVzZXJpYWxpemVzIGJpbmFyeSBkYXRhIChpbiBwcm90b2J1ZiB3aXJlIGZvcm1hdCkuCiAqIEBwYXJhbSB7anNwYi5CeXRlU291cmNlfSBieXRlcyBUaGUgYnl0ZXMgdG8gZGVzZXJpYWxpemUuCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuTWlncmF0ZVJlcXVlc3R9CiAqLwoKCnByb3RvLnBiLmNtcy5NaWdyYXRlUmVxdWVzdC5kZXNlcmlhbGl6ZUJpbmFyeSA9IGZ1bmN0aW9uIChieXRlcykgewogIHZhciByZWFkZXIgPSBuZXcganNwYi5CaW5hcnlSZWFkZXIoYnl0ZXMpOwogIHZhciBtc2cgPSBuZXcgcHJvdG8ucGIuY21zLk1pZ3JhdGVSZXF1ZXN0KCk7CiAgcmV0dXJuIHByb3RvLnBiLmNtcy5NaWdyYXRlUmVxdWVzdC5kZXNlcmlhbGl6ZUJpbmFyeUZyb21SZWFkZXIobXNnLCByZWFkZXIpOwp9OwovKioKICogRGVzZXJpYWxpemVzIGJpbmFyeSBkYXRhIChpbiBwcm90b2J1ZiB3aXJlIGZvcm1hdCkgZnJvbSB0aGUKICogZ2l2ZW4gcmVhZGVyIGludG8gdGhlIGdpdmVuIG1lc3NhZ2Ugb2JqZWN0LgogKiBAcGFyYW0geyFwcm90by5wYi5jbXMuTWlncmF0ZVJlcXVlc3R9IG1zZyBUaGUgbWVzc2FnZSBvYmplY3QgdG8gZGVzZXJpYWxpemUgaW50by4KICogQHBhcmFtIHshanNwYi5CaW5hcnlSZWFkZXJ9IHJlYWRlciBUaGUgQmluYXJ5UmVhZGVyIHRvIHVzZS4KICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5NaWdyYXRlUmVxdWVzdH0KICovCgoKcHJvdG8ucGIuY21zLk1pZ3JhdGVSZXF1ZXN0LmRlc2VyaWFsaXplQmluYXJ5RnJvbVJlYWRlciA9IGZ1bmN0aW9uIChtc2csIHJlYWRlcikgewogIHdoaWxlIChyZWFkZXIubmV4dEZpZWxkKCkpIHsKICAgIGlmIChyZWFkZXIuaXNFbmRHcm91cCgpKSB7CiAgICAgIGJyZWFrOwogICAgfQoKICAgIHZhciBmaWVsZCA9IHJlYWRlci5nZXRGaWVsZE51bWJlcigpOwoKICAgIHN3aXRjaCAoZmllbGQpIHsKICAgICAgY2FzZSAxOgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkRW51bSgpOwogICAgICAgIG1zZy5zZXRFbnRpdHlUeXBlKHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgMjoKICAgICAgICB2YXIgdmFsdWUgPSByZWFkZXIucmVhZFVpbnQzMigpOwogICAgICAgIG1zZy5zZXRTcmNJZCh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlIDM6CiAgICAgICAgdmFyIHZhbHVlID0gcmVhZGVyLnJlYWRVaW50MzIoKTsKICAgICAgICBtc2cuc2V0RHN0SWQodmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgZGVmYXVsdDoKICAgICAgICByZWFkZXIuc2tpcEZpZWxkKCk7CiAgICAgICAgYnJlYWs7CiAgICB9CiAgfQoKICByZXR1cm4gbXNnOwp9OwovKioKICogU2VyaWFsaXplcyB0aGUgbWVzc2FnZSB0byBiaW5hcnkgZGF0YSAoaW4gcHJvdG9idWYgd2lyZSBmb3JtYXQpLgogKiBAcmV0dXJuIHshVWludDhBcnJheX0KICovCgoKcHJvdG8ucGIuY21zLk1pZ3JhdGVSZXF1ZXN0LnByb3RvdHlwZS5zZXJpYWxpemVCaW5hcnkgPSBmdW5jdGlvbiAoKSB7CiAgdmFyIHdyaXRlciA9IG5ldyBqc3BiLkJpbmFyeVdyaXRlcigpOwogIHByb3RvLnBiLmNtcy5NaWdyYXRlUmVxdWVzdC5zZXJpYWxpemVCaW5hcnlUb1dyaXRlcih0aGlzLCB3cml0ZXIpOwogIHJldHVybiB3cml0ZXIuZ2V0UmVzdWx0QnVmZmVyKCk7Cn07Ci8qKgogKiBTZXJpYWxpemVzIHRoZSBnaXZlbiBtZXNzYWdlIHRvIGJpbmFyeSBkYXRhIChpbiBwcm90b2J1ZiB3aXJlCiAqIGZvcm1hdCksIHdyaXRpbmcgdG8gdGhlIGdpdmVuIEJpbmFyeVdyaXRlci4KICogQHBhcmFtIHshcHJvdG8ucGIuY21zLk1pZ3JhdGVSZXF1ZXN0fSBtZXNzYWdlCiAqIEBwYXJhbSB7IWpzcGIuQmluYXJ5V3JpdGVyfSB3cml0ZXIKICogQHN1cHByZXNzIHt1bnVzZWRMb2NhbFZhcmlhYmxlc30gZiBpcyBvbmx5IHVzZWQgZm9yIG5lc3RlZCBtZXNzYWdlcwogKi8KCgpwcm90by5wYi5jbXMuTWlncmF0ZVJlcXVlc3Quc2VyaWFsaXplQmluYXJ5VG9Xcml0ZXIgPSBmdW5jdGlvbiAobWVzc2FnZSwgd3JpdGVyKSB7CiAgdmFyIGYgPSB1bmRlZmluZWQ7CiAgZiA9IG1lc3NhZ2UuZ2V0RW50aXR5VHlwZSgpOwoKICBpZiAoZiAhPT0gMC4wKSB7CiAgICB3cml0ZXIud3JpdGVFbnVtKDEsIGYpOwogIH0KCiAgZiA9IG1lc3NhZ2UuZ2V0U3JjSWQoKTsKCiAgaWYgKGYgIT09IDApIHsKICAgIHdyaXRlci53cml0ZVVpbnQzMigyLCBmKTsKICB9CgogIGYgPSBtZXNzYWdlLmdldERzdElkKCk7CgogIGlmIChmICE9PSAwKSB7CiAgICB3cml0ZXIud3JpdGVVaW50MzIoMywgZik7CiAgfQp9OwovKioKICogb3B0aW9uYWwgcGIuRW50aXR5VHlwZSBlbnRpdHlfdHlwZSA9IDE7CiAqIEByZXR1cm4geyFwcm90by5wYi5FbnRpdHlUeXBlfQogKi8KCgpwcm90by5wYi5jbXMuTWlncmF0ZVJlcXVlc3QucHJvdG90eXBlLmdldEVudGl0eVR5cGUgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDEsIDApOwp9OwovKioKICogQHBhcmFtIHshcHJvdG8ucGIuRW50aXR5VHlwZX0gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5NaWdyYXRlUmVxdWVzdH0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5NaWdyYXRlUmVxdWVzdC5wcm90b3R5cGUuc2V0RW50aXR5VHlwZSA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UHJvdG8zRW51bUZpZWxkKHRoaXMsIDEsIHZhbHVlKTsKfTsKLyoqCiAqIG9wdGlvbmFsIHVpbnQzMiBzcmNfaWQgPSAyOwogKiBAcmV0dXJuIHtudW1iZXJ9CiAqLwoKCnByb3RvLnBiLmNtcy5NaWdyYXRlUmVxdWVzdC5wcm90b3R5cGUuZ2V0U3JjSWQgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDIsIDApOwp9OwovKioKICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuTWlncmF0ZVJlcXVlc3R9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuTWlncmF0ZVJlcXVlc3QucHJvdG90eXBlLnNldFNyY0lkID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRQcm90bzNJbnRGaWVsZCh0aGlzLCAyLCB2YWx1ZSk7Cn07Ci8qKgogKiBvcHRpb25hbCB1aW50MzIgZHN0X2lkID0gMzsKICogQHJldHVybiB7bnVtYmVyfQogKi8KCgpwcm90by5wYi5jbXMuTWlncmF0ZVJlcXVlc3QucHJvdG90eXBlLmdldERzdElkID0gZnVuY3Rpb24gKCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdCh0aGlzLCAzLCAwKTsKfTsKLyoqCiAqIEBwYXJhbSB7bnVtYmVyfSB2YWx1ZQogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLk1pZ3JhdGVSZXF1ZXN0fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLk1pZ3JhdGVSZXF1ZXN0LnByb3RvdHlwZS5zZXREc3RJZCA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UHJvdG8zSW50RmllbGQodGhpcywgMywgdmFsdWUpOwp9OwoKaWYgKGpzcGIuTWVzc2FnZS5HRU5FUkFURV9UT19PQkpFQ1QpIHsKICAvKioKICAgKiBDcmVhdGVzIGFuIG9iamVjdCByZXByZXNlbnRhdGlvbiBvZiB0aGlzIHByb3RvLgogICAqIEZpZWxkIG5hbWVzIHRoYXQgYXJlIHJlc2VydmVkIGluIEphdmFTY3JpcHQgYW5kIHdpbGwgYmUgcmVuYW1lZCB0byBwYl9uYW1lLgogICAqIE9wdGlvbmFsIGZpZWxkcyB0aGF0IGFyZSBub3Qgc2V0IHdpbGwgYmUgc2V0IHRvIHVuZGVmaW5lZC4KICAgKiBUbyBhY2Nlc3MgYSByZXNlcnZlZCBmaWVsZCB1c2UsIGZvby5wYl88bmFtZT4sIGVnLCBmb28ucGJfZGVmYXVsdC4KICAgKiBGb3IgdGhlIGxpc3Qgb2YgcmVzZXJ2ZWQgbmFtZXMgcGxlYXNlIHNlZToKICAgKiAgICAgbmV0L3Byb3RvMi9jb21waWxlci9qcy9pbnRlcm5hbC9nZW5lcmF0b3IuY2Mja0tleXdvcmQuCiAgICogQHBhcmFtIHtib29sZWFuPX0gb3B0X2luY2x1ZGVJbnN0YW5jZSBEZXByZWNhdGVkLiB3aGV0aGVyIHRvIGluY2x1ZGUgdGhlCiAgICogICAgIEpTUEIgaW5zdGFuY2UgZm9yIHRyYW5zaXRpb25hbCBzb3kgcHJvdG8gc3VwcG9ydDoKICAgKiAgICAgaHR0cDovL2dvdG8vc295LXBhcmFtLW1pZ3JhdGlvbgogICAqIEByZXR1cm4geyFPYmplY3R9CiAgICovCiAgcHJvdG8ucGIuY21zLkF1dGhvcml6ZUFuY2hvclJlcXVlc3QucHJvdG90eXBlLnRvT2JqZWN0ID0gZnVuY3Rpb24gKG9wdF9pbmNsdWRlSW5zdGFuY2UpIHsKICAgIHJldHVybiBwcm90by5wYi5jbXMuQXV0aG9yaXplQW5jaG9yUmVxdWVzdC50b09iamVjdChvcHRfaW5jbHVkZUluc3RhbmNlLCB0aGlzKTsKICB9OwogIC8qKgogICAqIFN0YXRpYyB2ZXJzaW9uIG9mIHRoZSB7QHNlZSB0b09iamVjdH0gbWV0aG9kLgogICAqIEBwYXJhbSB7Ym9vbGVhbnx1bmRlZmluZWR9IGluY2x1ZGVJbnN0YW5jZSBEZXByZWNhdGVkLiBXaGV0aGVyIHRvIGluY2x1ZGUKICAgKiAgICAgdGhlIEpTUEIgaW5zdGFuY2UgZm9yIHRyYW5zaXRpb25hbCBzb3kgcHJvdG8gc3VwcG9ydDoKICAgKiAgICAgaHR0cDovL2dvdG8vc295LXBhcmFtLW1pZ3JhdGlvbgogICAqIEBwYXJhbSB7IXByb3RvLnBiLmNtcy5BdXRob3JpemVBbmNob3JSZXF1ZXN0fSBtc2cgVGhlIG1zZyBpbnN0YW5jZSB0byB0cmFuc2Zvcm0uCiAgICogQHJldHVybiB7IU9iamVjdH0KICAgKiBAc3VwcHJlc3Mge3VudXNlZExvY2FsVmFyaWFibGVzfSBmIGlzIG9ubHkgdXNlZCBmb3IgbmVzdGVkIG1lc3NhZ2VzCiAgICovCgoKICBwcm90by5wYi5jbXMuQXV0aG9yaXplQW5jaG9yUmVxdWVzdC50b09iamVjdCA9IGZ1bmN0aW9uIChpbmNsdWRlSW5zdGFuY2UsIG1zZykgewogICAgdmFyIGYsCiAgICAgICAgb2JqID0gewogICAgICBhbmNob3JJZDoganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQobXNnLCAxLCAwKSwKICAgICAgYXJlYUlkOiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdChtc2csIDIsIDApLAogICAgICBndWlsZElkOiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdChtc2csIDMsIDApCiAgICB9OwoKICAgIGlmIChpbmNsdWRlSW5zdGFuY2UpIHsKICAgICAgb2JqLiRqc3BiTWVzc2FnZUluc3RhbmNlID0gbXNnOwogICAgfQoKICAgIHJldHVybiBvYmo7CiAgfTsKfQovKioKICogRGVzZXJpYWxpemVzIGJpbmFyeSBkYXRhIChpbiBwcm90b2J1ZiB3aXJlIGZvcm1hdCkuCiAqIEBwYXJhbSB7anNwYi5CeXRlU291cmNlfSBieXRlcyBUaGUgYnl0ZXMgdG8gZGVzZXJpYWxpemUuCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuQXV0aG9yaXplQW5jaG9yUmVxdWVzdH0KICovCgoKcHJvdG8ucGIuY21zLkF1dGhvcml6ZUFuY2hvclJlcXVlc3QuZGVzZXJpYWxpemVCaW5hcnkgPSBmdW5jdGlvbiAoYnl0ZXMpIHsKICB2YXIgcmVhZGVyID0gbmV3IGpzcGIuQmluYXJ5UmVhZGVyKGJ5dGVzKTsKICB2YXIgbXNnID0gbmV3IHByb3RvLnBiLmNtcy5BdXRob3JpemVBbmNob3JSZXF1ZXN0KCk7CiAgcmV0dXJuIHByb3RvLnBiLmNtcy5BdXRob3JpemVBbmNob3JSZXF1ZXN0LmRlc2VyaWFsaXplQmluYXJ5RnJvbVJlYWRlcihtc2csIHJlYWRlcik7Cn07Ci8qKgogKiBEZXNlcmlhbGl6ZXMgYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUgZm9ybWF0KSBmcm9tIHRoZQogKiBnaXZlbiByZWFkZXIgaW50byB0aGUgZ2l2ZW4gbWVzc2FnZSBvYmplY3QuCiAqIEBwYXJhbSB7IXByb3RvLnBiLmNtcy5BdXRob3JpemVBbmNob3JSZXF1ZXN0fSBtc2cgVGhlIG1lc3NhZ2Ugb2JqZWN0IHRvIGRlc2VyaWFsaXplIGludG8uCiAqIEBwYXJhbSB7IWpzcGIuQmluYXJ5UmVhZGVyfSByZWFkZXIgVGhlIEJpbmFyeVJlYWRlciB0byB1c2UuCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuQXV0aG9yaXplQW5jaG9yUmVxdWVzdH0KICovCgoKcHJvdG8ucGIuY21zLkF1dGhvcml6ZUFuY2hvclJlcXVlc3QuZGVzZXJpYWxpemVCaW5hcnlGcm9tUmVhZGVyID0gZnVuY3Rpb24gKG1zZywgcmVhZGVyKSB7CiAgd2hpbGUgKHJlYWRlci5uZXh0RmllbGQoKSkgewogICAgaWYgKHJlYWRlci5pc0VuZEdyb3VwKCkpIHsKICAgICAgYnJlYWs7CiAgICB9CgogICAgdmFyIGZpZWxkID0gcmVhZGVyLmdldEZpZWxkTnVtYmVyKCk7CgogICAgc3dpdGNoIChmaWVsZCkgewogICAgICBjYXNlIDE6CiAgICAgICAgdmFyIHZhbHVlID0gcmVhZGVyLnJlYWRVaW50MzIoKTsKICAgICAgICBtc2cuc2V0QW5jaG9ySWQodmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSAyOgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkVWludDMyKCk7CiAgICAgICAgbXNnLnNldEFyZWFJZCh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlIDM6CiAgICAgICAgdmFyIHZhbHVlID0gcmVhZGVyLnJlYWRVaW50MzIoKTsKICAgICAgICBtc2cuc2V0R3VpbGRJZCh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBkZWZhdWx0OgogICAgICAgIHJlYWRlci5za2lwRmllbGQoKTsKICAgICAgICBicmVhazsKICAgIH0KICB9CgogIHJldHVybiBtc2c7Cn07Ci8qKgogKiBTZXJpYWxpemVzIHRoZSBtZXNzYWdlIHRvIGJpbmFyeSBkYXRhIChpbiBwcm90b2J1ZiB3aXJlIGZvcm1hdCkuCiAqIEByZXR1cm4geyFVaW50OEFycmF5fQogKi8KCgpwcm90by5wYi5jbXMuQXV0aG9yaXplQW5jaG9yUmVxdWVzdC5wcm90b3R5cGUuc2VyaWFsaXplQmluYXJ5ID0gZnVuY3Rpb24gKCkgewogIHZhciB3cml0ZXIgPSBuZXcganNwYi5CaW5hcnlXcml0ZXIoKTsKICBwcm90by5wYi5jbXMuQXV0aG9yaXplQW5jaG9yUmVxdWVzdC5zZXJpYWxpemVCaW5hcnlUb1dyaXRlcih0aGlzLCB3cml0ZXIpOwogIHJldHVybiB3cml0ZXIuZ2V0UmVzdWx0QnVmZmVyKCk7Cn07Ci8qKgogKiBTZXJpYWxpemVzIHRoZSBnaXZlbiBtZXNzYWdlIHRvIGJpbmFyeSBkYXRhIChpbiBwcm90b2J1ZiB3aXJlCiAqIGZvcm1hdCksIHdyaXRpbmcgdG8gdGhlIGdpdmVuIEJpbmFyeVdyaXRlci4KICogQHBhcmFtIHshcHJvdG8ucGIuY21zLkF1dGhvcml6ZUFuY2hvclJlcXVlc3R9IG1lc3NhZ2UKICogQHBhcmFtIHshanNwYi5CaW5hcnlXcml0ZXJ9IHdyaXRlcgogKiBAc3VwcHJlc3Mge3VudXNlZExvY2FsVmFyaWFibGVzfSBmIGlzIG9ubHkgdXNlZCBmb3IgbmVzdGVkIG1lc3NhZ2VzCiAqLwoKCnByb3RvLnBiLmNtcy5BdXRob3JpemVBbmNob3JSZXF1ZXN0LnNlcmlhbGl6ZUJpbmFyeVRvV3JpdGVyID0gZnVuY3Rpb24gKG1lc3NhZ2UsIHdyaXRlcikgewogIHZhciBmID0gdW5kZWZpbmVkOwogIGYgPSBtZXNzYWdlLmdldEFuY2hvcklkKCk7CgogIGlmIChmICE9PSAwKSB7CiAgICB3cml0ZXIud3JpdGVVaW50MzIoMSwgZik7CiAgfQoKICBmID0gbWVzc2FnZS5nZXRBcmVhSWQoKTsKCiAgaWYgKGYgIT09IDApIHsKICAgIHdyaXRlci53cml0ZVVpbnQzMigyLCBmKTsKICB9CgogIGYgPSBtZXNzYWdlLmdldEd1aWxkSWQoKTsKCiAgaWYgKGYgIT09IDApIHsKICAgIHdyaXRlci53cml0ZVVpbnQzMigzLCBmKTsKICB9Cn07Ci8qKgogKiBvcHRpb25hbCB1aW50MzIgYW5jaG9yX2lkID0gMTsKICogQHJldHVybiB7bnVtYmVyfQogKi8KCgpwcm90by5wYi5jbXMuQXV0aG9yaXplQW5jaG9yUmVxdWVzdC5wcm90b3R5cGUuZ2V0QW5jaG9ySWQgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDEsIDApOwp9OwovKioKICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuQXV0aG9yaXplQW5jaG9yUmVxdWVzdH0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5BdXRob3JpemVBbmNob3JSZXF1ZXN0LnByb3RvdHlwZS5zZXRBbmNob3JJZCA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UHJvdG8zSW50RmllbGQodGhpcywgMSwgdmFsdWUpOwp9OwovKioKICogb3B0aW9uYWwgdWludDMyIGFyZWFfaWQgPSAyOwogKiBAcmV0dXJuIHtudW1iZXJ9CiAqLwoKCnByb3RvLnBiLmNtcy5BdXRob3JpemVBbmNob3JSZXF1ZXN0LnByb3RvdHlwZS5nZXRBcmVhSWQgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDIsIDApOwp9OwovKioKICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuQXV0aG9yaXplQW5jaG9yUmVxdWVzdH0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5BdXRob3JpemVBbmNob3JSZXF1ZXN0LnByb3RvdHlwZS5zZXRBcmVhSWQgPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0ludEZpZWxkKHRoaXMsIDIsIHZhbHVlKTsKfTsKLyoqCiAqIG9wdGlvbmFsIHVpbnQzMiBndWlsZF9pZCA9IDM7CiAqIEByZXR1cm4ge251bWJlcn0KICovCgoKcHJvdG8ucGIuY21zLkF1dGhvcml6ZUFuY2hvclJlcXVlc3QucHJvdG90eXBlLmdldEd1aWxkSWQgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDMsIDApOwp9OwovKioKICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuQXV0aG9yaXplQW5jaG9yUmVxdWVzdH0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5BdXRob3JpemVBbmNob3JSZXF1ZXN0LnByb3RvdHlwZS5zZXRHdWlsZElkID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRQcm90bzNJbnRGaWVsZCh0aGlzLCAzLCB2YWx1ZSk7Cn07CgppZiAoanNwYi5NZXNzYWdlLkdFTkVSQVRFX1RPX09CSkVDVCkgewogIC8qKgogICAqIENyZWF0ZXMgYW4gb2JqZWN0IHJlcHJlc2VudGF0aW9uIG9mIHRoaXMgcHJvdG8uCiAgICogRmllbGQgbmFtZXMgdGhhdCBhcmUgcmVzZXJ2ZWQgaW4gSmF2YVNjcmlwdCBhbmQgd2lsbCBiZSByZW5hbWVkIHRvIHBiX25hbWUuCiAgICogT3B0aW9uYWwgZmllbGRzIHRoYXQgYXJlIG5vdCBzZXQgd2lsbCBiZSBzZXQgdG8gdW5kZWZpbmVkLgogICAqIFRvIGFjY2VzcyBhIHJlc2VydmVkIGZpZWxkIHVzZSwgZm9vLnBiXzxuYW1lPiwgZWcsIGZvby5wYl9kZWZhdWx0LgogICAqIEZvciB0aGUgbGlzdCBvZiByZXNlcnZlZCBuYW1lcyBwbGVhc2Ugc2VlOgogICAqICAgICBuZXQvcHJvdG8yL2NvbXBpbGVyL2pzL2ludGVybmFsL2dlbmVyYXRvci5jYyNrS2V5d29yZC4KICAgKiBAcGFyYW0ge2Jvb2xlYW49fSBvcHRfaW5jbHVkZUluc3RhbmNlIERlcHJlY2F0ZWQuIHdoZXRoZXIgdG8gaW5jbHVkZSB0aGUKICAgKiAgICAgSlNQQiBpbnN0YW5jZSBmb3IgdHJhbnNpdGlvbmFsIHNveSBwcm90byBzdXBwb3J0OgogICAqICAgICBodHRwOi8vZ290by9zb3ktcGFyYW0tbWlncmF0aW9uCiAgICogQHJldHVybiB7IU9iamVjdH0KICAgKi8KICBwcm90by5wYi5jbXMuQW5jaG9yRnVsbFJlcXVlc3QucHJvdG90eXBlLnRvT2JqZWN0ID0gZnVuY3Rpb24gKG9wdF9pbmNsdWRlSW5zdGFuY2UpIHsKICAgIHJldHVybiBwcm90by5wYi5jbXMuQW5jaG9yRnVsbFJlcXVlc3QudG9PYmplY3Qob3B0X2luY2x1ZGVJbnN0YW5jZSwgdGhpcyk7CiAgfTsKICAvKioKICAgKiBTdGF0aWMgdmVyc2lvbiBvZiB0aGUge0BzZWUgdG9PYmplY3R9IG1ldGhvZC4KICAgKiBAcGFyYW0ge2Jvb2xlYW58dW5kZWZpbmVkfSBpbmNsdWRlSW5zdGFuY2UgRGVwcmVjYXRlZC4gV2hldGhlciB0byBpbmNsdWRlCiAgICogICAgIHRoZSBKU1BCIGluc3RhbmNlIGZvciB0cmFuc2l0aW9uYWwgc295IHByb3RvIHN1cHBvcnQ6CiAgICogICAgIGh0dHA6Ly9nb3RvL3NveS1wYXJhbS1taWdyYXRpb24KICAgKiBAcGFyYW0geyFwcm90by5wYi5jbXMuQW5jaG9yRnVsbFJlcXVlc3R9IG1zZyBUaGUgbXNnIGluc3RhbmNlIHRvIHRyYW5zZm9ybS4KICAgKiBAcmV0dXJuIHshT2JqZWN0fQogICAqIEBzdXBwcmVzcyB7dW51c2VkTG9jYWxWYXJpYWJsZXN9IGYgaXMgb25seSB1c2VkIGZvciBuZXN0ZWQgbWVzc2FnZXMKICAgKi8KCgogIHByb3RvLnBiLmNtcy5BbmNob3JGdWxsUmVxdWVzdC50b09iamVjdCA9IGZ1bmN0aW9uIChpbmNsdWRlSW5zdGFuY2UsIG1zZykgewogICAgdmFyIGYsCiAgICAgICAgb2JqID0gewogICAgICBhbmNob3JJZDoganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQobXNnLCAxLCAwKQogICAgfTsKCiAgICBpZiAoaW5jbHVkZUluc3RhbmNlKSB7CiAgICAgIG9iai4kanNwYk1lc3NhZ2VJbnN0YW5jZSA9IG1zZzsKICAgIH0KCiAgICByZXR1cm4gb2JqOwogIH07Cn0KLyoqCiAqIERlc2VyaWFsaXplcyBiaW5hcnkgZGF0YSAoaW4gcHJvdG9idWYgd2lyZSBmb3JtYXQpLgogKiBAcGFyYW0ge2pzcGIuQnl0ZVNvdXJjZX0gYnl0ZXMgVGhlIGJ5dGVzIHRvIGRlc2VyaWFsaXplLgogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLkFuY2hvckZ1bGxSZXF1ZXN0fQogKi8KCgpwcm90by5wYi5jbXMuQW5jaG9yRnVsbFJlcXVlc3QuZGVzZXJpYWxpemVCaW5hcnkgPSBmdW5jdGlvbiAoYnl0ZXMpIHsKICB2YXIgcmVhZGVyID0gbmV3IGpzcGIuQmluYXJ5UmVhZGVyKGJ5dGVzKTsKICB2YXIgbXNnID0gbmV3IHByb3RvLnBiLmNtcy5BbmNob3JGdWxsUmVxdWVzdCgpOwogIHJldHVybiBwcm90by5wYi5jbXMuQW5jaG9yRnVsbFJlcXVlc3QuZGVzZXJpYWxpemVCaW5hcnlGcm9tUmVhZGVyKG1zZywgcmVhZGVyKTsKfTsKLyoqCiAqIERlc2VyaWFsaXplcyBiaW5hcnkgZGF0YSAoaW4gcHJvdG9idWYgd2lyZSBmb3JtYXQpIGZyb20gdGhlCiAqIGdpdmVuIHJlYWRlciBpbnRvIHRoZSBnaXZlbiBtZXNzYWdlIG9iamVjdC4KICogQHBhcmFtIHshcHJvdG8ucGIuY21zLkFuY2hvckZ1bGxSZXF1ZXN0fSBtc2cgVGhlIG1lc3NhZ2Ugb2JqZWN0IHRvIGRlc2VyaWFsaXplIGludG8uCiAqIEBwYXJhbSB7IWpzcGIuQmluYXJ5UmVhZGVyfSByZWFkZXIgVGhlIEJpbmFyeVJlYWRlciB0byB1c2UuCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuQW5jaG9yRnVsbFJlcXVlc3R9CiAqLwoKCnByb3RvLnBiLmNtcy5BbmNob3JGdWxsUmVxdWVzdC5kZXNlcmlhbGl6ZUJpbmFyeUZyb21SZWFkZXIgPSBmdW5jdGlvbiAobXNnLCByZWFkZXIpIHsKICB3aGlsZSAocmVhZGVyLm5leHRGaWVsZCgpKSB7CiAgICBpZiAocmVhZGVyLmlzRW5kR3JvdXAoKSkgewogICAgICBicmVhazsKICAgIH0KCiAgICB2YXIgZmllbGQgPSByZWFkZXIuZ2V0RmllbGROdW1iZXIoKTsKCiAgICBzd2l0Y2ggKGZpZWxkKSB7CiAgICAgIGNhc2UgMToKICAgICAgICB2YXIgdmFsdWUgPSByZWFkZXIucmVhZFVpbnQzMigpOwogICAgICAgIG1zZy5zZXRBbmNob3JJZCh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBkZWZhdWx0OgogICAgICAgIHJlYWRlci5za2lwRmllbGQoKTsKICAgICAgICBicmVhazsKICAgIH0KICB9CgogIHJldHVybiBtc2c7Cn07Ci8qKgogKiBTZXJpYWxpemVzIHRoZSBtZXNzYWdlIHRvIGJpbmFyeSBkYXRhIChpbiBwcm90b2J1ZiB3aXJlIGZvcm1hdCkuCiAqIEByZXR1cm4geyFVaW50OEFycmF5fQogKi8KCgpwcm90by5wYi5jbXMuQW5jaG9yRnVsbFJlcXVlc3QucHJvdG90eXBlLnNlcmlhbGl6ZUJpbmFyeSA9IGZ1bmN0aW9uICgpIHsKICB2YXIgd3JpdGVyID0gbmV3IGpzcGIuQmluYXJ5V3JpdGVyKCk7CiAgcHJvdG8ucGIuY21zLkFuY2hvckZ1bGxSZXF1ZXN0LnNlcmlhbGl6ZUJpbmFyeVRvV3JpdGVyKHRoaXMsIHdyaXRlcik7CiAgcmV0dXJuIHdyaXRlci5nZXRSZXN1bHRCdWZmZXIoKTsKfTsKLyoqCiAqIFNlcmlhbGl6ZXMgdGhlIGdpdmVuIG1lc3NhZ2UgdG8gYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUKICogZm9ybWF0KSwgd3JpdGluZyB0byB0aGUgZ2l2ZW4gQmluYXJ5V3JpdGVyLgogKiBAcGFyYW0geyFwcm90by5wYi5jbXMuQW5jaG9yRnVsbFJlcXVlc3R9IG1lc3NhZ2UKICogQHBhcmFtIHshanNwYi5CaW5hcnlXcml0ZXJ9IHdyaXRlcgogKiBAc3VwcHJlc3Mge3VudXNlZExvY2FsVmFyaWFibGVzfSBmIGlzIG9ubHkgdXNlZCBmb3IgbmVzdGVkIG1lc3NhZ2VzCiAqLwoKCnByb3RvLnBiLmNtcy5BbmNob3JGdWxsUmVxdWVzdC5zZXJpYWxpemVCaW5hcnlUb1dyaXRlciA9IGZ1bmN0aW9uIChtZXNzYWdlLCB3cml0ZXIpIHsKICB2YXIgZiA9IHVuZGVmaW5lZDsKICBmID0gbWVzc2FnZS5nZXRBbmNob3JJZCgpOwoKICBpZiAoZiAhPT0gMCkgewogICAgd3JpdGVyLndyaXRlVWludDMyKDEsIGYpOwogIH0KfTsKLyoqCiAqIG9wdGlvbmFsIHVpbnQzMiBhbmNob3JfaWQgPSAxOwogKiBAcmV0dXJuIHtudW1iZXJ9CiAqLwoKCnByb3RvLnBiLmNtcy5BbmNob3JGdWxsUmVxdWVzdC5wcm90b3R5cGUuZ2V0QW5jaG9ySWQgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDEsIDApOwp9OwovKioKICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuQW5jaG9yRnVsbFJlcXVlc3R9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuQW5jaG9yRnVsbFJlcXVlc3QucHJvdG90eXBlLnNldEFuY2hvcklkID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRQcm90bzNJbnRGaWVsZCh0aGlzLCAxLCB2YWx1ZSk7Cn07Ci8qKgogKiBMaXN0IG9mIHJlcGVhdGVkIGZpZWxkcyB3aXRoaW4gdGhpcyBtZXNzYWdlIHR5cGUuCiAqIEBwcml2YXRlIHshQXJyYXk8bnVtYmVyPn0KICogQGNvbnN0CiAqLwoKCnByb3RvLnBiLmNtcy5BbmNob3JGdWxsUmVwbHkucmVwZWF0ZWRGaWVsZHNfID0gWzJdOwoKaWYgKGpzcGIuTWVzc2FnZS5HRU5FUkFURV9UT19PQkpFQ1QpIHsKICAvKioKICAgKiBDcmVhdGVzIGFuIG9iamVjdCByZXByZXNlbnRhdGlvbiBvZiB0aGlzIHByb3RvLgogICAqIEZpZWxkIG5hbWVzIHRoYXQgYXJlIHJlc2VydmVkIGluIEphdmFTY3JpcHQgYW5kIHdpbGwgYmUgcmVuYW1lZCB0byBwYl9uYW1lLgogICAqIE9wdGlvbmFsIGZpZWxkcyB0aGF0IGFyZSBub3Qgc2V0IHdpbGwgYmUgc2V0IHRvIHVuZGVmaW5lZC4KICAgKiBUbyBhY2Nlc3MgYSByZXNlcnZlZCBmaWVsZCB1c2UsIGZvby5wYl88bmFtZT4sIGVnLCBmb28ucGJfZGVmYXVsdC4KICAgKiBGb3IgdGhlIGxpc3Qgb2YgcmVzZXJ2ZWQgbmFtZXMgcGxlYXNlIHNlZToKICAgKiAgICAgbmV0L3Byb3RvMi9jb21waWxlci9qcy9pbnRlcm5hbC9nZW5lcmF0b3IuY2Mja0tleXdvcmQuCiAgICogQHBhcmFtIHtib29sZWFuPX0gb3B0X2luY2x1ZGVJbnN0YW5jZSBEZXByZWNhdGVkLiB3aGV0aGVyIHRvIGluY2x1ZGUgdGhlCiAgICogICAgIEpTUEIgaW5zdGFuY2UgZm9yIHRyYW5zaXRpb25hbCBzb3kgcHJvdG8gc3VwcG9ydDoKICAgKiAgICAgaHR0cDovL2dvdG8vc295LXBhcmFtLW1pZ3JhdGlvbgogICAqIEByZXR1cm4geyFPYmplY3R9CiAgICovCiAgcHJvdG8ucGIuY21zLkFuY2hvckZ1bGxSZXBseS5wcm90b3R5cGUudG9PYmplY3QgPSBmdW5jdGlvbiAob3B0X2luY2x1ZGVJbnN0YW5jZSkgewogICAgcmV0dXJuIHByb3RvLnBiLmNtcy5BbmNob3JGdWxsUmVwbHkudG9PYmplY3Qob3B0X2luY2x1ZGVJbnN0YW5jZSwgdGhpcyk7CiAgfTsKICAvKioKICAgKiBTdGF0aWMgdmVyc2lvbiBvZiB0aGUge0BzZWUgdG9PYmplY3R9IG1ldGhvZC4KICAgKiBAcGFyYW0ge2Jvb2xlYW58dW5kZWZpbmVkfSBpbmNsdWRlSW5zdGFuY2UgRGVwcmVjYXRlZC4gV2hldGhlciB0byBpbmNsdWRlCiAgICogICAgIHRoZSBKU1BCIGluc3RhbmNlIGZvciB0cmFuc2l0aW9uYWwgc295IHByb3RvIHN1cHBvcnQ6CiAgICogICAgIGh0dHA6Ly9nb3RvL3NveS1wYXJhbS1taWdyYXRpb24KICAgKiBAcGFyYW0geyFwcm90by5wYi5jbXMuQW5jaG9yRnVsbFJlcGx5fSBtc2cgVGhlIG1zZyBpbnN0YW5jZSB0byB0cmFuc2Zvcm0uCiAgICogQHJldHVybiB7IU9iamVjdH0KICAgKiBAc3VwcHJlc3Mge3VudXNlZExvY2FsVmFyaWFibGVzfSBmIGlzIG9ubHkgdXNlZCBmb3IgbmVzdGVkIG1lc3NhZ2VzCiAgICovCgoKICBwcm90by5wYi5jbXMuQW5jaG9yRnVsbFJlcGx5LnRvT2JqZWN0ID0gZnVuY3Rpb24gKGluY2x1ZGVJbnN0YW5jZSwgbXNnKSB7CiAgICB2YXIgZiwKICAgICAgICBvYmogPSB7CiAgICAgIGJhc2ljOiAoZiA9IG1zZy5nZXRCYXNpYygpKSAmJiBhbmNob3J0eXBlX3BiLkFuY2hvckJhc2ljLnRvT2JqZWN0KGluY2x1ZGVJbnN0YW5jZSwgZiksCiAgICAgIHByb2ZpbGVzTGlzdDoganNwYi5NZXNzYWdlLnRvT2JqZWN0TGlzdChtc2cuZ2V0UHJvZmlsZXNMaXN0KCksIGFuY2hvcnR5cGVfcGIuQW5jaG9yUHJvZmlsZS50b09iamVjdCwgaW5jbHVkZUluc3RhbmNlKQogICAgfTsKCiAgICBpZiAoaW5jbHVkZUluc3RhbmNlKSB7CiAgICAgIG9iai4kanNwYk1lc3NhZ2VJbnN0YW5jZSA9IG1zZzsKICAgIH0KCiAgICByZXR1cm4gb2JqOwogIH07Cn0KLyoqCiAqIERlc2VyaWFsaXplcyBiaW5hcnkgZGF0YSAoaW4gcHJvdG9idWYgd2lyZSBmb3JtYXQpLgogKiBAcGFyYW0ge2pzcGIuQnl0ZVNvdXJjZX0gYnl0ZXMgVGhlIGJ5dGVzIHRvIGRlc2VyaWFsaXplLgogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLkFuY2hvckZ1bGxSZXBseX0KICovCgoKcHJvdG8ucGIuY21zLkFuY2hvckZ1bGxSZXBseS5kZXNlcmlhbGl6ZUJpbmFyeSA9IGZ1bmN0aW9uIChieXRlcykgewogIHZhciByZWFkZXIgPSBuZXcganNwYi5CaW5hcnlSZWFkZXIoYnl0ZXMpOwogIHZhciBtc2cgPSBuZXcgcHJvdG8ucGIuY21zLkFuY2hvckZ1bGxSZXBseSgpOwogIHJldHVybiBwcm90by5wYi5jbXMuQW5jaG9yRnVsbFJlcGx5LmRlc2VyaWFsaXplQmluYXJ5RnJvbVJlYWRlcihtc2csIHJlYWRlcik7Cn07Ci8qKgogKiBEZXNlcmlhbGl6ZXMgYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUgZm9ybWF0KSBmcm9tIHRoZQogKiBnaXZlbiByZWFkZXIgaW50byB0aGUgZ2l2ZW4gbWVzc2FnZSBvYmplY3QuCiAqIEBwYXJhbSB7IXByb3RvLnBiLmNtcy5BbmNob3JGdWxsUmVwbHl9IG1zZyBUaGUgbWVzc2FnZSBvYmplY3QgdG8gZGVzZXJpYWxpemUgaW50by4KICogQHBhcmFtIHshanNwYi5CaW5hcnlSZWFkZXJ9IHJlYWRlciBUaGUgQmluYXJ5UmVhZGVyIHRvIHVzZS4KICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5BbmNob3JGdWxsUmVwbHl9CiAqLwoKCnByb3RvLnBiLmNtcy5BbmNob3JGdWxsUmVwbHkuZGVzZXJpYWxpemVCaW5hcnlGcm9tUmVhZGVyID0gZnVuY3Rpb24gKG1zZywgcmVhZGVyKSB7CiAgd2hpbGUgKHJlYWRlci5uZXh0RmllbGQoKSkgewogICAgaWYgKHJlYWRlci5pc0VuZEdyb3VwKCkpIHsKICAgICAgYnJlYWs7CiAgICB9CgogICAgdmFyIGZpZWxkID0gcmVhZGVyLmdldEZpZWxkTnVtYmVyKCk7CgogICAgc3dpdGNoIChmaWVsZCkgewogICAgICBjYXNlIDE6CiAgICAgICAgdmFyIHZhbHVlID0gbmV3IGFuY2hvcnR5cGVfcGIuQW5jaG9yQmFzaWMoKTsKICAgICAgICByZWFkZXIucmVhZE1lc3NhZ2UodmFsdWUsIGFuY2hvcnR5cGVfcGIuQW5jaG9yQmFzaWMuZGVzZXJpYWxpemVCaW5hcnlGcm9tUmVhZGVyKTsKICAgICAgICBtc2cuc2V0QmFzaWModmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSAyOgogICAgICAgIHZhciB2YWx1ZSA9IG5ldyBhbmNob3J0eXBlX3BiLkFuY2hvclByb2ZpbGUoKTsKICAgICAgICByZWFkZXIucmVhZE1lc3NhZ2UodmFsdWUsIGFuY2hvcnR5cGVfcGIuQW5jaG9yUHJvZmlsZS5kZXNlcmlhbGl6ZUJpbmFyeUZyb21SZWFkZXIpOwogICAgICAgIG1zZy5hZGRQcm9maWxlcyh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBkZWZhdWx0OgogICAgICAgIHJlYWRlci5za2lwRmllbGQoKTsKICAgICAgICBicmVhazsKICAgIH0KICB9CgogIHJldHVybiBtc2c7Cn07Ci8qKgogKiBTZXJpYWxpemVzIHRoZSBtZXNzYWdlIHRvIGJpbmFyeSBkYXRhIChpbiBwcm90b2J1ZiB3aXJlIGZvcm1hdCkuCiAqIEByZXR1cm4geyFVaW50OEFycmF5fQogKi8KCgpwcm90by5wYi5jbXMuQW5jaG9yRnVsbFJlcGx5LnByb3RvdHlwZS5zZXJpYWxpemVCaW5hcnkgPSBmdW5jdGlvbiAoKSB7CiAgdmFyIHdyaXRlciA9IG5ldyBqc3BiLkJpbmFyeVdyaXRlcigpOwogIHByb3RvLnBiLmNtcy5BbmNob3JGdWxsUmVwbHkuc2VyaWFsaXplQmluYXJ5VG9Xcml0ZXIodGhpcywgd3JpdGVyKTsKICByZXR1cm4gd3JpdGVyLmdldFJlc3VsdEJ1ZmZlcigpOwp9OwovKioKICogU2VyaWFsaXplcyB0aGUgZ2l2ZW4gbWVzc2FnZSB0byBiaW5hcnkgZGF0YSAoaW4gcHJvdG9idWYgd2lyZQogKiBmb3JtYXQpLCB3cml0aW5nIHRvIHRoZSBnaXZlbiBCaW5hcnlXcml0ZXIuCiAqIEBwYXJhbSB7IXByb3RvLnBiLmNtcy5BbmNob3JGdWxsUmVwbHl9IG1lc3NhZ2UKICogQHBhcmFtIHshanNwYi5CaW5hcnlXcml0ZXJ9IHdyaXRlcgogKiBAc3VwcHJlc3Mge3VudXNlZExvY2FsVmFyaWFibGVzfSBmIGlzIG9ubHkgdXNlZCBmb3IgbmVzdGVkIG1lc3NhZ2VzCiAqLwoKCnByb3RvLnBiLmNtcy5BbmNob3JGdWxsUmVwbHkuc2VyaWFsaXplQmluYXJ5VG9Xcml0ZXIgPSBmdW5jdGlvbiAobWVzc2FnZSwgd3JpdGVyKSB7CiAgdmFyIGYgPSB1bmRlZmluZWQ7CiAgZiA9IG1lc3NhZ2UuZ2V0QmFzaWMoKTsKCiAgaWYgKGYgIT0gbnVsbCkgewogICAgd3JpdGVyLndyaXRlTWVzc2FnZSgxLCBmLCBhbmNob3J0eXBlX3BiLkFuY2hvckJhc2ljLnNlcmlhbGl6ZUJpbmFyeVRvV3JpdGVyKTsKICB9CgogIGYgPSBtZXNzYWdlLmdldFByb2ZpbGVzTGlzdCgpOwoKICBpZiAoZi5sZW5ndGggPiAwKSB7CiAgICB3cml0ZXIud3JpdGVSZXBlYXRlZE1lc3NhZ2UoMiwgZiwgYW5jaG9ydHlwZV9wYi5BbmNob3JQcm9maWxlLnNlcmlhbGl6ZUJpbmFyeVRvV3JpdGVyKTsKICB9Cn07Ci8qKgogKiBvcHRpb25hbCBwYi5BbmNob3JCYXNpYyBiYXNpYyA9IDE7CiAqIEByZXR1cm4gez9wcm90by5wYi5BbmNob3JCYXNpY30KICovCgoKcHJvdG8ucGIuY21zLkFuY2hvckZ1bGxSZXBseS5wcm90b3R5cGUuZ2V0QmFzaWMgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRXcmFwcGVyRmllbGQodGhpcywgYW5jaG9ydHlwZV9wYi5BbmNob3JCYXNpYywgMSk7Cn07Ci8qKgogKiBAcGFyYW0gez9wcm90by5wYi5BbmNob3JCYXNpY3x1bmRlZmluZWR9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuQW5jaG9yRnVsbFJlcGx5fSByZXR1cm5zIHRoaXMKKi8KCgpwcm90by5wYi5jbXMuQW5jaG9yRnVsbFJlcGx5LnByb3RvdHlwZS5zZXRCYXNpYyA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0V3JhcHBlckZpZWxkKHRoaXMsIDEsIHZhbHVlKTsKfTsKLyoqCiAqIENsZWFycyB0aGUgbWVzc2FnZSBmaWVsZCBtYWtpbmcgaXQgdW5kZWZpbmVkLgogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLkFuY2hvckZ1bGxSZXBseX0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5BbmNob3JGdWxsUmVwbHkucHJvdG90eXBlLmNsZWFyQmFzaWMgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIHRoaXMuc2V0QmFzaWModW5kZWZpbmVkKTsKfTsKLyoqCiAqIFJldHVybnMgd2hldGhlciB0aGlzIGZpZWxkIGlzIHNldC4KICogQHJldHVybiB7Ym9vbGVhbn0KICovCgoKcHJvdG8ucGIuY21zLkFuY2hvckZ1bGxSZXBseS5wcm90b3R5cGUuaGFzQmFzaWMgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZCh0aGlzLCAxKSAhPSBudWxsOwp9OwovKioKICogcmVwZWF0ZWQgcGIuQW5jaG9yUHJvZmlsZSBwcm9maWxlcyA9IDI7CiAqIEByZXR1cm4geyFBcnJheTwhcHJvdG8ucGIuQW5jaG9yUHJvZmlsZT59CiAqLwoKCnByb3RvLnBiLmNtcy5BbmNob3JGdWxsUmVwbHkucHJvdG90eXBlLmdldFByb2ZpbGVzTGlzdCA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldFJlcGVhdGVkV3JhcHBlckZpZWxkKHRoaXMsIGFuY2hvcnR5cGVfcGIuQW5jaG9yUHJvZmlsZSwgMik7Cn07Ci8qKgogKiBAcGFyYW0geyFBcnJheTwhcHJvdG8ucGIuQW5jaG9yUHJvZmlsZT59IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuQW5jaG9yRnVsbFJlcGx5fSByZXR1cm5zIHRoaXMKKi8KCgpwcm90by5wYi5jbXMuQW5jaG9yRnVsbFJlcGx5LnByb3RvdHlwZS5zZXRQcm9maWxlc0xpc3QgPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFJlcGVhdGVkV3JhcHBlckZpZWxkKHRoaXMsIDIsIHZhbHVlKTsKfTsKLyoqCiAqIEBwYXJhbSB7IXByb3RvLnBiLkFuY2hvclByb2ZpbGU9fSBvcHRfdmFsdWUKICogQHBhcmFtIHtudW1iZXI9fSBvcHRfaW5kZXgKICogQHJldHVybiB7IXByb3RvLnBiLkFuY2hvclByb2ZpbGV9CiAqLwoKCnByb3RvLnBiLmNtcy5BbmNob3JGdWxsUmVwbHkucHJvdG90eXBlLmFkZFByb2ZpbGVzID0gZnVuY3Rpb24gKG9wdF92YWx1ZSwgb3B0X2luZGV4KSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5hZGRUb1JlcGVhdGVkV3JhcHBlckZpZWxkKHRoaXMsIDIsIG9wdF92YWx1ZSwgcHJvdG8ucGIuQW5jaG9yUHJvZmlsZSwgb3B0X2luZGV4KTsKfTsKLyoqCiAqIENsZWFycyB0aGUgbGlzdCBtYWtpbmcgaXQgZW1wdHkgYnV0IG5vbi1udWxsLgogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLkFuY2hvckZ1bGxSZXBseX0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5BbmNob3JGdWxsUmVwbHkucHJvdG90eXBlLmNsZWFyUHJvZmlsZXNMaXN0ID0gZnVuY3Rpb24gKCkgewogIHJldHVybiB0aGlzLnNldFByb2ZpbGVzTGlzdChbXSk7Cn07CgppZiAoanNwYi5NZXNzYWdlLkdFTkVSQVRFX1RPX09CSkVDVCkgewogIC8qKgogICAqIENyZWF0ZXMgYW4gb2JqZWN0IHJlcHJlc2VudGF0aW9uIG9mIHRoaXMgcHJvdG8uCiAgICogRmllbGQgbmFtZXMgdGhhdCBhcmUgcmVzZXJ2ZWQgaW4gSmF2YVNjcmlwdCBhbmQgd2lsbCBiZSByZW5hbWVkIHRvIHBiX25hbWUuCiAgICogT3B0aW9uYWwgZmllbGRzIHRoYXQgYXJlIG5vdCBzZXQgd2lsbCBiZSBzZXQgdG8gdW5kZWZpbmVkLgogICAqIFRvIGFjY2VzcyBhIHJlc2VydmVkIGZpZWxkIHVzZSwgZm9vLnBiXzxuYW1lPiwgZWcsIGZvby5wYl9kZWZhdWx0LgogICAqIEZvciB0aGUgbGlzdCBvZiByZXNlcnZlZCBuYW1lcyBwbGVhc2Ugc2VlOgogICAqICAgICBuZXQvcHJvdG8yL2NvbXBpbGVyL2pzL2ludGVybmFsL2dlbmVyYXRvci5jYyNrS2V5d29yZC4KICAgKiBAcGFyYW0ge2Jvb2xlYW49fSBvcHRfaW5jbHVkZUluc3RhbmNlIERlcHJlY2F0ZWQuIHdoZXRoZXIgdG8gaW5jbHVkZSB0aGUKICAgKiAgICAgSlNQQiBpbnN0YW5jZSBmb3IgdHJhbnNpdGlvbmFsIHNveSBwcm90byBzdXBwb3J0OgogICAqICAgICBodHRwOi8vZ290by9zb3ktcGFyYW0tbWlncmF0aW9uCiAgICogQHJldHVybiB7IU9iamVjdH0KICAgKi8KICBwcm90by5wYi5jbXMuUHJvZmlsZUxpc3RSZXF1ZXN0LnByb3RvdHlwZS50b09iamVjdCA9IGZ1bmN0aW9uIChvcHRfaW5jbHVkZUluc3RhbmNlKSB7CiAgICByZXR1cm4gcHJvdG8ucGIuY21zLlByb2ZpbGVMaXN0UmVxdWVzdC50b09iamVjdChvcHRfaW5jbHVkZUluc3RhbmNlLCB0aGlzKTsKICB9OwogIC8qKgogICAqIFN0YXRpYyB2ZXJzaW9uIG9mIHRoZSB7QHNlZSB0b09iamVjdH0gbWV0aG9kLgogICAqIEBwYXJhbSB7Ym9vbGVhbnx1bmRlZmluZWR9IGluY2x1ZGVJbnN0YW5jZSBEZXByZWNhdGVkLiBXaGV0aGVyIHRvIGluY2x1ZGUKICAgKiAgICAgdGhlIEpTUEIgaW5zdGFuY2UgZm9yIHRyYW5zaXRpb25hbCBzb3kgcHJvdG8gc3VwcG9ydDoKICAgKiAgICAgaHR0cDovL2dvdG8vc295LXBhcmFtLW1pZ3JhdGlvbgogICAqIEBwYXJhbSB7IXByb3RvLnBiLmNtcy5Qcm9maWxlTGlzdFJlcXVlc3R9IG1zZyBUaGUgbXNnIGluc3RhbmNlIHRvIHRyYW5zZm9ybS4KICAgKiBAcmV0dXJuIHshT2JqZWN0fQogICAqIEBzdXBwcmVzcyB7dW51c2VkTG9jYWxWYXJpYWJsZXN9IGYgaXMgb25seSB1c2VkIGZvciBuZXN0ZWQgbWVzc2FnZXMKICAgKi8KCgogIHByb3RvLnBiLmNtcy5Qcm9maWxlTGlzdFJlcXVlc3QudG9PYmplY3QgPSBmdW5jdGlvbiAoaW5jbHVkZUluc3RhbmNlLCBtc2cpIHsKICAgIHZhciBmLAogICAgICAgIG9iaiA9IHsKICAgICAgcGFnZU5vOiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdChtc2csIDEsIDApLAogICAgICBwYWdlU2l6ZToganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQobXNnLCAyLCAwKSwKICAgICAgYW5jaG9ySWQ6IGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KG1zZywgMywgMCksCiAgICAgIGFyZWFJZDoganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQobXNnLCA0LCAwKSwKICAgICAgc3RhdHVzOiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdChtc2csIDUsIDApCiAgICB9OwoKICAgIGlmIChpbmNsdWRlSW5zdGFuY2UpIHsKICAgICAgb2JqLiRqc3BiTWVzc2FnZUluc3RhbmNlID0gbXNnOwogICAgfQoKICAgIHJldHVybiBvYmo7CiAgfTsKfQovKioKICogRGVzZXJpYWxpemVzIGJpbmFyeSBkYXRhIChpbiBwcm90b2J1ZiB3aXJlIGZvcm1hdCkuCiAqIEBwYXJhbSB7anNwYi5CeXRlU291cmNlfSBieXRlcyBUaGUgYnl0ZXMgdG8gZGVzZXJpYWxpemUuCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuUHJvZmlsZUxpc3RSZXF1ZXN0fQogKi8KCgpwcm90by5wYi5jbXMuUHJvZmlsZUxpc3RSZXF1ZXN0LmRlc2VyaWFsaXplQmluYXJ5ID0gZnVuY3Rpb24gKGJ5dGVzKSB7CiAgdmFyIHJlYWRlciA9IG5ldyBqc3BiLkJpbmFyeVJlYWRlcihieXRlcyk7CiAgdmFyIG1zZyA9IG5ldyBwcm90by5wYi5jbXMuUHJvZmlsZUxpc3RSZXF1ZXN0KCk7CiAgcmV0dXJuIHByb3RvLnBiLmNtcy5Qcm9maWxlTGlzdFJlcXVlc3QuZGVzZXJpYWxpemVCaW5hcnlGcm9tUmVhZGVyKG1zZywgcmVhZGVyKTsKfTsKLyoqCiAqIERlc2VyaWFsaXplcyBiaW5hcnkgZGF0YSAoaW4gcHJvdG9idWYgd2lyZSBmb3JtYXQpIGZyb20gdGhlCiAqIGdpdmVuIHJlYWRlciBpbnRvIHRoZSBnaXZlbiBtZXNzYWdlIG9iamVjdC4KICogQHBhcmFtIHshcHJvdG8ucGIuY21zLlByb2ZpbGVMaXN0UmVxdWVzdH0gbXNnIFRoZSBtZXNzYWdlIG9iamVjdCB0byBkZXNlcmlhbGl6ZSBpbnRvLgogKiBAcGFyYW0geyFqc3BiLkJpbmFyeVJlYWRlcn0gcmVhZGVyIFRoZSBCaW5hcnlSZWFkZXIgdG8gdXNlLgogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLlByb2ZpbGVMaXN0UmVxdWVzdH0KICovCgoKcHJvdG8ucGIuY21zLlByb2ZpbGVMaXN0UmVxdWVzdC5kZXNlcmlhbGl6ZUJpbmFyeUZyb21SZWFkZXIgPSBmdW5jdGlvbiAobXNnLCByZWFkZXIpIHsKICB3aGlsZSAocmVhZGVyLm5leHRGaWVsZCgpKSB7CiAgICBpZiAocmVhZGVyLmlzRW5kR3JvdXAoKSkgewogICAgICBicmVhazsKICAgIH0KCiAgICB2YXIgZmllbGQgPSByZWFkZXIuZ2V0RmllbGROdW1iZXIoKTsKCiAgICBzd2l0Y2ggKGZpZWxkKSB7CiAgICAgIGNhc2UgMToKICAgICAgICB2YXIgdmFsdWUgPSByZWFkZXIucmVhZFVpbnQzMigpOwogICAgICAgIG1zZy5zZXRQYWdlTm8odmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSAyOgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkVWludDMyKCk7CiAgICAgICAgbXNnLnNldFBhZ2VTaXplKHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgMzoKICAgICAgICB2YXIgdmFsdWUgPSByZWFkZXIucmVhZFVpbnQzMigpOwogICAgICAgIG1zZy5zZXRBbmNob3JJZCh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlIDQ6CiAgICAgICAgdmFyIHZhbHVlID0gcmVhZGVyLnJlYWRVaW50MzIoKTsKICAgICAgICBtc2cuc2V0QXJlYUlkKHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgNToKICAgICAgICB2YXIgdmFsdWUgPSByZWFkZXIucmVhZEVudW0oKTsKICAgICAgICBtc2cuc2V0U3RhdHVzKHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGRlZmF1bHQ6CiAgICAgICAgcmVhZGVyLnNraXBGaWVsZCgpOwogICAgICAgIGJyZWFrOwogICAgfQogIH0KCiAgcmV0dXJuIG1zZzsKfTsKLyoqCiAqIFNlcmlhbGl6ZXMgdGhlIG1lc3NhZ2UgdG8gYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUgZm9ybWF0KS4KICogQHJldHVybiB7IVVpbnQ4QXJyYXl9CiAqLwoKCnByb3RvLnBiLmNtcy5Qcm9maWxlTGlzdFJlcXVlc3QucHJvdG90eXBlLnNlcmlhbGl6ZUJpbmFyeSA9IGZ1bmN0aW9uICgpIHsKICB2YXIgd3JpdGVyID0gbmV3IGpzcGIuQmluYXJ5V3JpdGVyKCk7CiAgcHJvdG8ucGIuY21zLlByb2ZpbGVMaXN0UmVxdWVzdC5zZXJpYWxpemVCaW5hcnlUb1dyaXRlcih0aGlzLCB3cml0ZXIpOwogIHJldHVybiB3cml0ZXIuZ2V0UmVzdWx0QnVmZmVyKCk7Cn07Ci8qKgogKiBTZXJpYWxpemVzIHRoZSBnaXZlbiBtZXNzYWdlIHRvIGJpbmFyeSBkYXRhIChpbiBwcm90b2J1ZiB3aXJlCiAqIGZvcm1hdCksIHdyaXRpbmcgdG8gdGhlIGdpdmVuIEJpbmFyeVdyaXRlci4KICogQHBhcmFtIHshcHJvdG8ucGIuY21zLlByb2ZpbGVMaXN0UmVxdWVzdH0gbWVzc2FnZQogKiBAcGFyYW0geyFqc3BiLkJpbmFyeVdyaXRlcn0gd3JpdGVyCiAqIEBzdXBwcmVzcyB7dW51c2VkTG9jYWxWYXJpYWJsZXN9IGYgaXMgb25seSB1c2VkIGZvciBuZXN0ZWQgbWVzc2FnZXMKICovCgoKcHJvdG8ucGIuY21zLlByb2ZpbGVMaXN0UmVxdWVzdC5zZXJpYWxpemVCaW5hcnlUb1dyaXRlciA9IGZ1bmN0aW9uIChtZXNzYWdlLCB3cml0ZXIpIHsKICB2YXIgZiA9IHVuZGVmaW5lZDsKICBmID0gbWVzc2FnZS5nZXRQYWdlTm8oKTsKCiAgaWYgKGYgIT09IDApIHsKICAgIHdyaXRlci53cml0ZVVpbnQzMigxLCBmKTsKICB9CgogIGYgPSBtZXNzYWdlLmdldFBhZ2VTaXplKCk7CgogIGlmIChmICE9PSAwKSB7CiAgICB3cml0ZXIud3JpdGVVaW50MzIoMiwgZik7CiAgfQoKICBmID0gbWVzc2FnZS5nZXRBbmNob3JJZCgpOwoKICBpZiAoZiAhPT0gMCkgewogICAgd3JpdGVyLndyaXRlVWludDMyKDMsIGYpOwogIH0KCiAgZiA9IG1lc3NhZ2UuZ2V0QXJlYUlkKCk7CgogIGlmIChmICE9PSAwKSB7CiAgICB3cml0ZXIud3JpdGVVaW50MzIoNCwgZik7CiAgfQoKICBmID0gbWVzc2FnZS5nZXRTdGF0dXMoKTsKCiAgaWYgKGYgIT09IDAuMCkgewogICAgd3JpdGVyLndyaXRlRW51bSg1LCBmKTsKICB9Cn07Ci8qKgogKiBvcHRpb25hbCB1aW50MzIgcGFnZV9ubyA9IDE7CiAqIEByZXR1cm4ge251bWJlcn0KICovCgoKcHJvdG8ucGIuY21zLlByb2ZpbGVMaXN0UmVxdWVzdC5wcm90b3R5cGUuZ2V0UGFnZU5vID0gZnVuY3Rpb24gKCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdCh0aGlzLCAxLCAwKTsKfTsKLyoqCiAqIEBwYXJhbSB7bnVtYmVyfSB2YWx1ZQogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLlByb2ZpbGVMaXN0UmVxdWVzdH0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5Qcm9maWxlTGlzdFJlcXVlc3QucHJvdG90eXBlLnNldFBhZ2VObyA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UHJvdG8zSW50RmllbGQodGhpcywgMSwgdmFsdWUpOwp9OwovKioKICogb3B0aW9uYWwgdWludDMyIHBhZ2Vfc2l6ZSA9IDI7CiAqIEByZXR1cm4ge251bWJlcn0KICovCgoKcHJvdG8ucGIuY21zLlByb2ZpbGVMaXN0UmVxdWVzdC5wcm90b3R5cGUuZ2V0UGFnZVNpemUgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDIsIDApOwp9OwovKioKICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuUHJvZmlsZUxpc3RSZXF1ZXN0fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLlByb2ZpbGVMaXN0UmVxdWVzdC5wcm90b3R5cGUuc2V0UGFnZVNpemUgPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0ludEZpZWxkKHRoaXMsIDIsIHZhbHVlKTsKfTsKLyoqCiAqIG9wdGlvbmFsIHVpbnQzMiBhbmNob3JfaWQgPSAzOwogKiBAcmV0dXJuIHtudW1iZXJ9CiAqLwoKCnByb3RvLnBiLmNtcy5Qcm9maWxlTGlzdFJlcXVlc3QucHJvdG90eXBlLmdldEFuY2hvcklkID0gZnVuY3Rpb24gKCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdCh0aGlzLCAzLCAwKTsKfTsKLyoqCiAqIEBwYXJhbSB7bnVtYmVyfSB2YWx1ZQogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLlByb2ZpbGVMaXN0UmVxdWVzdH0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5Qcm9maWxlTGlzdFJlcXVlc3QucHJvdG90eXBlLnNldEFuY2hvcklkID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRQcm90bzNJbnRGaWVsZCh0aGlzLCAzLCB2YWx1ZSk7Cn07Ci8qKgogKiBvcHRpb25hbCB1aW50MzIgYXJlYV9pZCA9IDQ7CiAqIEByZXR1cm4ge251bWJlcn0KICovCgoKcHJvdG8ucGIuY21zLlByb2ZpbGVMaXN0UmVxdWVzdC5wcm90b3R5cGUuZ2V0QXJlYUlkID0gZnVuY3Rpb24gKCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdCh0aGlzLCA0LCAwKTsKfTsKLyoqCiAqIEBwYXJhbSB7bnVtYmVyfSB2YWx1ZQogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLlByb2ZpbGVMaXN0UmVxdWVzdH0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5Qcm9maWxlTGlzdFJlcXVlc3QucHJvdG90eXBlLnNldEFyZWFJZCA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UHJvdG8zSW50RmllbGQodGhpcywgNCwgdmFsdWUpOwp9OwovKioKICogb3B0aW9uYWwgcGIuUmV2aWV3U3RhdHVzIHN0YXR1cyA9IDU7CiAqIEByZXR1cm4geyFwcm90by5wYi5SZXZpZXdTdGF0dXN9CiAqLwoKCnByb3RvLnBiLmNtcy5Qcm9maWxlTGlzdFJlcXVlc3QucHJvdG90eXBlLmdldFN0YXR1cyA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQodGhpcywgNSwgMCk7Cn07Ci8qKgogKiBAcGFyYW0geyFwcm90by5wYi5SZXZpZXdTdGF0dXN9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuUHJvZmlsZUxpc3RSZXF1ZXN0fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLlByb2ZpbGVMaXN0UmVxdWVzdC5wcm90b3R5cGUuc2V0U3RhdHVzID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRQcm90bzNFbnVtRmllbGQodGhpcywgNSwgdmFsdWUpOwp9OwovKioKICogTGlzdCBvZiByZXBlYXRlZCBmaWVsZHMgd2l0aGluIHRoaXMgbWVzc2FnZSB0eXBlLgogKiBAcHJpdmF0ZSB7IUFycmF5PG51bWJlcj59CiAqIEBjb25zdAogKi8KCgpwcm90by5wYi5jbXMuUHJvZmlsZUxpc3RSZXBseS5yZXBlYXRlZEZpZWxkc18gPSBbMV07CgppZiAoanNwYi5NZXNzYWdlLkdFTkVSQVRFX1RPX09CSkVDVCkgewogIC8qKgogICAqIENyZWF0ZXMgYW4gb2JqZWN0IHJlcHJlc2VudGF0aW9uIG9mIHRoaXMgcHJvdG8uCiAgICogRmllbGQgbmFtZXMgdGhhdCBhcmUgcmVzZXJ2ZWQgaW4gSmF2YVNjcmlwdCBhbmQgd2lsbCBiZSByZW5hbWVkIHRvIHBiX25hbWUuCiAgICogT3B0aW9uYWwgZmllbGRzIHRoYXQgYXJlIG5vdCBzZXQgd2lsbCBiZSBzZXQgdG8gdW5kZWZpbmVkLgogICAqIFRvIGFjY2VzcyBhIHJlc2VydmVkIGZpZWxkIHVzZSwgZm9vLnBiXzxuYW1lPiwgZWcsIGZvby5wYl9kZWZhdWx0LgogICAqIEZvciB0aGUgbGlzdCBvZiByZXNlcnZlZCBuYW1lcyBwbGVhc2Ugc2VlOgogICAqICAgICBuZXQvcHJvdG8yL2NvbXBpbGVyL2pzL2ludGVybmFsL2dlbmVyYXRvci5jYyNrS2V5d29yZC4KICAgKiBAcGFyYW0ge2Jvb2xlYW49fSBvcHRfaW5jbHVkZUluc3RhbmNlIERlcHJlY2F0ZWQuIHdoZXRoZXIgdG8gaW5jbHVkZSB0aGUKICAgKiAgICAgSlNQQiBpbnN0YW5jZSBmb3IgdHJhbnNpdGlvbmFsIHNveSBwcm90byBzdXBwb3J0OgogICAqICAgICBodHRwOi8vZ290by9zb3ktcGFyYW0tbWlncmF0aW9uCiAgICogQHJldHVybiB7IU9iamVjdH0KICAgKi8KICBwcm90by5wYi5jbXMuUHJvZmlsZUxpc3RSZXBseS5wcm90b3R5cGUudG9PYmplY3QgPSBmdW5jdGlvbiAob3B0X2luY2x1ZGVJbnN0YW5jZSkgewogICAgcmV0dXJuIHByb3RvLnBiLmNtcy5Qcm9maWxlTGlzdFJlcGx5LnRvT2JqZWN0KG9wdF9pbmNsdWRlSW5zdGFuY2UsIHRoaXMpOwogIH07CiAgLyoqCiAgICogU3RhdGljIHZlcnNpb24gb2YgdGhlIHtAc2VlIHRvT2JqZWN0fSBtZXRob2QuCiAgICogQHBhcmFtIHtib29sZWFufHVuZGVmaW5lZH0gaW5jbHVkZUluc3RhbmNlIERlcHJlY2F0ZWQuIFdoZXRoZXIgdG8gaW5jbHVkZQogICAqICAgICB0aGUgSlNQQiBpbnN0YW5jZSBmb3IgdHJhbnNpdGlvbmFsIHNveSBwcm90byBzdXBwb3J0OgogICAqICAgICBodHRwOi8vZ290by9zb3ktcGFyYW0tbWlncmF0aW9uCiAgICogQHBhcmFtIHshcHJvdG8ucGIuY21zLlByb2ZpbGVMaXN0UmVwbHl9IG1zZyBUaGUgbXNnIGluc3RhbmNlIHRvIHRyYW5zZm9ybS4KICAgKiBAcmV0dXJuIHshT2JqZWN0fQogICAqIEBzdXBwcmVzcyB7dW51c2VkTG9jYWxWYXJpYWJsZXN9IGYgaXMgb25seSB1c2VkIGZvciBuZXN0ZWQgbWVzc2FnZXMKICAgKi8KCgogIHByb3RvLnBiLmNtcy5Qcm9maWxlTGlzdFJlcGx5LnRvT2JqZWN0ID0gZnVuY3Rpb24gKGluY2x1ZGVJbnN0YW5jZSwgbXNnKSB7CiAgICB2YXIgZiwKICAgICAgICBvYmogPSB7CiAgICAgIHByb2ZpbGVzTGlzdDoganNwYi5NZXNzYWdlLnRvT2JqZWN0TGlzdChtc2cuZ2V0UHJvZmlsZXNMaXN0KCksIGFuY2hvcnR5cGVfcGIuQW5jaG9yUHJvZmlsZS50b09iamVjdCwgaW5jbHVkZUluc3RhbmNlKSwKICAgICAgcGFnZU5vOiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdChtc2csIDIsIDApLAogICAgICBwYWdlU2l6ZToganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQobXNnLCAzLCAwKSwKICAgICAgdG90YWxQYWdlOiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdChtc2csIDQsIDApLAogICAgICB0b3RhbENvdW50OiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdChtc2csIDUsIDApCiAgICB9OwoKICAgIGlmIChpbmNsdWRlSW5zdGFuY2UpIHsKICAgICAgb2JqLiRqc3BiTWVzc2FnZUluc3RhbmNlID0gbXNnOwogICAgfQoKICAgIHJldHVybiBvYmo7CiAgfTsKfQovKioKICogRGVzZXJpYWxpemVzIGJpbmFyeSBkYXRhIChpbiBwcm90b2J1ZiB3aXJlIGZvcm1hdCkuCiAqIEBwYXJhbSB7anNwYi5CeXRlU291cmNlfSBieXRlcyBUaGUgYnl0ZXMgdG8gZGVzZXJpYWxpemUuCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuUHJvZmlsZUxpc3RSZXBseX0KICovCgoKcHJvdG8ucGIuY21zLlByb2ZpbGVMaXN0UmVwbHkuZGVzZXJpYWxpemVCaW5hcnkgPSBmdW5jdGlvbiAoYnl0ZXMpIHsKICB2YXIgcmVhZGVyID0gbmV3IGpzcGIuQmluYXJ5UmVhZGVyKGJ5dGVzKTsKICB2YXIgbXNnID0gbmV3IHByb3RvLnBiLmNtcy5Qcm9maWxlTGlzdFJlcGx5KCk7CiAgcmV0dXJuIHByb3RvLnBiLmNtcy5Qcm9maWxlTGlzdFJlcGx5LmRlc2VyaWFsaXplQmluYXJ5RnJvbVJlYWRlcihtc2csIHJlYWRlcik7Cn07Ci8qKgogKiBEZXNlcmlhbGl6ZXMgYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUgZm9ybWF0KSBmcm9tIHRoZQogKiBnaXZlbiByZWFkZXIgaW50byB0aGUgZ2l2ZW4gbWVzc2FnZSBvYmplY3QuCiAqIEBwYXJhbSB7IXByb3RvLnBiLmNtcy5Qcm9maWxlTGlzdFJlcGx5fSBtc2cgVGhlIG1lc3NhZ2Ugb2JqZWN0IHRvIGRlc2VyaWFsaXplIGludG8uCiAqIEBwYXJhbSB7IWpzcGIuQmluYXJ5UmVhZGVyfSByZWFkZXIgVGhlIEJpbmFyeVJlYWRlciB0byB1c2UuCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuUHJvZmlsZUxpc3RSZXBseX0KICovCgoKcHJvdG8ucGIuY21zLlByb2ZpbGVMaXN0UmVwbHkuZGVzZXJpYWxpemVCaW5hcnlGcm9tUmVhZGVyID0gZnVuY3Rpb24gKG1zZywgcmVhZGVyKSB7CiAgd2hpbGUgKHJlYWRlci5uZXh0RmllbGQoKSkgewogICAgaWYgKHJlYWRlci5pc0VuZEdyb3VwKCkpIHsKICAgICAgYnJlYWs7CiAgICB9CgogICAgdmFyIGZpZWxkID0gcmVhZGVyLmdldEZpZWxkTnVtYmVyKCk7CgogICAgc3dpdGNoIChmaWVsZCkgewogICAgICBjYXNlIDE6CiAgICAgICAgdmFyIHZhbHVlID0gbmV3IGFuY2hvcnR5cGVfcGIuQW5jaG9yUHJvZmlsZSgpOwogICAgICAgIHJlYWRlci5yZWFkTWVzc2FnZSh2YWx1ZSwgYW5jaG9ydHlwZV9wYi5BbmNob3JQcm9maWxlLmRlc2VyaWFsaXplQmluYXJ5RnJvbVJlYWRlcik7CiAgICAgICAgbXNnLmFkZFByb2ZpbGVzKHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgMjoKICAgICAgICB2YXIgdmFsdWUgPSByZWFkZXIucmVhZFVpbnQzMigpOwogICAgICAgIG1zZy5zZXRQYWdlTm8odmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSAzOgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkVWludDMyKCk7CiAgICAgICAgbXNnLnNldFBhZ2VTaXplKHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgNDoKICAgICAgICB2YXIgdmFsdWUgPSByZWFkZXIucmVhZFVpbnQzMigpOwogICAgICAgIG1zZy5zZXRUb3RhbFBhZ2UodmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSA1OgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkVWludDMyKCk7CiAgICAgICAgbXNnLnNldFRvdGFsQ291bnQodmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgZGVmYXVsdDoKICAgICAgICByZWFkZXIuc2tpcEZpZWxkKCk7CiAgICAgICAgYnJlYWs7CiAgICB9CiAgfQoKICByZXR1cm4gbXNnOwp9OwovKioKICogU2VyaWFsaXplcyB0aGUgbWVzc2FnZSB0byBiaW5hcnkgZGF0YSAoaW4gcHJvdG9idWYgd2lyZSBmb3JtYXQpLgogKiBAcmV0dXJuIHshVWludDhBcnJheX0KICovCgoKcHJvdG8ucGIuY21zLlByb2ZpbGVMaXN0UmVwbHkucHJvdG90eXBlLnNlcmlhbGl6ZUJpbmFyeSA9IGZ1bmN0aW9uICgpIHsKICB2YXIgd3JpdGVyID0gbmV3IGpzcGIuQmluYXJ5V3JpdGVyKCk7CiAgcHJvdG8ucGIuY21zLlByb2ZpbGVMaXN0UmVwbHkuc2VyaWFsaXplQmluYXJ5VG9Xcml0ZXIodGhpcywgd3JpdGVyKTsKICByZXR1cm4gd3JpdGVyLmdldFJlc3VsdEJ1ZmZlcigpOwp9OwovKioKICogU2VyaWFsaXplcyB0aGUgZ2l2ZW4gbWVzc2FnZSB0byBiaW5hcnkgZGF0YSAoaW4gcHJvdG9idWYgd2lyZQogKiBmb3JtYXQpLCB3cml0aW5nIHRvIHRoZSBnaXZlbiBCaW5hcnlXcml0ZXIuCiAqIEBwYXJhbSB7IXByb3RvLnBiLmNtcy5Qcm9maWxlTGlzdFJlcGx5fSBtZXNzYWdlCiAqIEBwYXJhbSB7IWpzcGIuQmluYXJ5V3JpdGVyfSB3cml0ZXIKICogQHN1cHByZXNzIHt1bnVzZWRMb2NhbFZhcmlhYmxlc30gZiBpcyBvbmx5IHVzZWQgZm9yIG5lc3RlZCBtZXNzYWdlcwogKi8KCgpwcm90by5wYi5jbXMuUHJvZmlsZUxpc3RSZXBseS5zZXJpYWxpemVCaW5hcnlUb1dyaXRlciA9IGZ1bmN0aW9uIChtZXNzYWdlLCB3cml0ZXIpIHsKICB2YXIgZiA9IHVuZGVmaW5lZDsKICBmID0gbWVzc2FnZS5nZXRQcm9maWxlc0xpc3QoKTsKCiAgaWYgKGYubGVuZ3RoID4gMCkgewogICAgd3JpdGVyLndyaXRlUmVwZWF0ZWRNZXNzYWdlKDEsIGYsIGFuY2hvcnR5cGVfcGIuQW5jaG9yUHJvZmlsZS5zZXJpYWxpemVCaW5hcnlUb1dyaXRlcik7CiAgfQoKICBmID0gbWVzc2FnZS5nZXRQYWdlTm8oKTsKCiAgaWYgKGYgIT09IDApIHsKICAgIHdyaXRlci53cml0ZVVpbnQzMigyLCBmKTsKICB9CgogIGYgPSBtZXNzYWdlLmdldFBhZ2VTaXplKCk7CgogIGlmIChmICE9PSAwKSB7CiAgICB3cml0ZXIud3JpdGVVaW50MzIoMywgZik7CiAgfQoKICBmID0gbWVzc2FnZS5nZXRUb3RhbFBhZ2UoKTsKCiAgaWYgKGYgIT09IDApIHsKICAgIHdyaXRlci53cml0ZVVpbnQzMig0LCBmKTsKICB9CgogIGYgPSBtZXNzYWdlLmdldFRvdGFsQ291bnQoKTsKCiAgaWYgKGYgIT09IDApIHsKICAgIHdyaXRlci53cml0ZVVpbnQzMig1LCBmKTsKICB9Cn07Ci8qKgogKiByZXBlYXRlZCBwYi5BbmNob3JQcm9maWxlIHByb2ZpbGVzID0gMTsKICogQHJldHVybiB7IUFycmF5PCFwcm90by5wYi5BbmNob3JQcm9maWxlPn0KICovCgoKcHJvdG8ucGIuY21zLlByb2ZpbGVMaXN0UmVwbHkucHJvdG90eXBlLmdldFByb2ZpbGVzTGlzdCA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldFJlcGVhdGVkV3JhcHBlckZpZWxkKHRoaXMsIGFuY2hvcnR5cGVfcGIuQW5jaG9yUHJvZmlsZSwgMSk7Cn07Ci8qKgogKiBAcGFyYW0geyFBcnJheTwhcHJvdG8ucGIuQW5jaG9yUHJvZmlsZT59IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuUHJvZmlsZUxpc3RSZXBseX0gcmV0dXJucyB0aGlzCiovCgoKcHJvdG8ucGIuY21zLlByb2ZpbGVMaXN0UmVwbHkucHJvdG90eXBlLnNldFByb2ZpbGVzTGlzdCA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UmVwZWF0ZWRXcmFwcGVyRmllbGQodGhpcywgMSwgdmFsdWUpOwp9OwovKioKICogQHBhcmFtIHshcHJvdG8ucGIuQW5jaG9yUHJvZmlsZT19IG9wdF92YWx1ZQogKiBAcGFyYW0ge251bWJlcj19IG9wdF9pbmRleAogKiBAcmV0dXJuIHshcHJvdG8ucGIuQW5jaG9yUHJvZmlsZX0KICovCgoKcHJvdG8ucGIuY21zLlByb2ZpbGVMaXN0UmVwbHkucHJvdG90eXBlLmFkZFByb2ZpbGVzID0gZnVuY3Rpb24gKG9wdF92YWx1ZSwgb3B0X2luZGV4KSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5hZGRUb1JlcGVhdGVkV3JhcHBlckZpZWxkKHRoaXMsIDEsIG9wdF92YWx1ZSwgcHJvdG8ucGIuQW5jaG9yUHJvZmlsZSwgb3B0X2luZGV4KTsKfTsKLyoqCiAqIENsZWFycyB0aGUgbGlzdCBtYWtpbmcgaXQgZW1wdHkgYnV0IG5vbi1udWxsLgogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLlByb2ZpbGVMaXN0UmVwbHl9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuUHJvZmlsZUxpc3RSZXBseS5wcm90b3R5cGUuY2xlYXJQcm9maWxlc0xpc3QgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIHRoaXMuc2V0UHJvZmlsZXNMaXN0KFtdKTsKfTsKLyoqCiAqIG9wdGlvbmFsIHVpbnQzMiBwYWdlX25vID0gMjsKICogQHJldHVybiB7bnVtYmVyfQogKi8KCgpwcm90by5wYi5jbXMuUHJvZmlsZUxpc3RSZXBseS5wcm90b3R5cGUuZ2V0UGFnZU5vID0gZnVuY3Rpb24gKCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdCh0aGlzLCAyLCAwKTsKfTsKLyoqCiAqIEBwYXJhbSB7bnVtYmVyfSB2YWx1ZQogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLlByb2ZpbGVMaXN0UmVwbHl9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuUHJvZmlsZUxpc3RSZXBseS5wcm90b3R5cGUuc2V0UGFnZU5vID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRQcm90bzNJbnRGaWVsZCh0aGlzLCAyLCB2YWx1ZSk7Cn07Ci8qKgogKiBvcHRpb25hbCB1aW50MzIgcGFnZV9zaXplID0gMzsKICogQHJldHVybiB7bnVtYmVyfQogKi8KCgpwcm90by5wYi5jbXMuUHJvZmlsZUxpc3RSZXBseS5wcm90b3R5cGUuZ2V0UGFnZVNpemUgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDMsIDApOwp9OwovKioKICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuUHJvZmlsZUxpc3RSZXBseX0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5Qcm9maWxlTGlzdFJlcGx5LnByb3RvdHlwZS5zZXRQYWdlU2l6ZSA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UHJvdG8zSW50RmllbGQodGhpcywgMywgdmFsdWUpOwp9OwovKioKICogb3B0aW9uYWwgdWludDMyIHRvdGFsX3BhZ2UgPSA0OwogKiBAcmV0dXJuIHtudW1iZXJ9CiAqLwoKCnByb3RvLnBiLmNtcy5Qcm9maWxlTGlzdFJlcGx5LnByb3RvdHlwZS5nZXRUb3RhbFBhZ2UgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDQsIDApOwp9OwovKioKICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuUHJvZmlsZUxpc3RSZXBseX0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5Qcm9maWxlTGlzdFJlcGx5LnByb3RvdHlwZS5zZXRUb3RhbFBhZ2UgPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0ludEZpZWxkKHRoaXMsIDQsIHZhbHVlKTsKfTsKLyoqCiAqIG9wdGlvbmFsIHVpbnQzMiB0b3RhbF9jb3VudCA9IDU7CiAqIEByZXR1cm4ge251bWJlcn0KICovCgoKcHJvdG8ucGIuY21zLlByb2ZpbGVMaXN0UmVwbHkucHJvdG90eXBlLmdldFRvdGFsQ291bnQgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDUsIDApOwp9OwovKioKICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuUHJvZmlsZUxpc3RSZXBseX0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5Qcm9maWxlTGlzdFJlcGx5LnByb3RvdHlwZS5zZXRUb3RhbENvdW50ID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRQcm90bzNJbnRGaWVsZCh0aGlzLCA1LCB2YWx1ZSk7Cn07CgppZiAoanNwYi5NZXNzYWdlLkdFTkVSQVRFX1RPX09CSkVDVCkgewogIC8qKgogICAqIENyZWF0ZXMgYW4gb2JqZWN0IHJlcHJlc2VudGF0aW9uIG9mIHRoaXMgcHJvdG8uCiAgICogRmllbGQgbmFtZXMgdGhhdCBhcmUgcmVzZXJ2ZWQgaW4gSmF2YVNjcmlwdCBhbmQgd2lsbCBiZSByZW5hbWVkIHRvIHBiX25hbWUuCiAgICogT3B0aW9uYWwgZmllbGRzIHRoYXQgYXJlIG5vdCBzZXQgd2lsbCBiZSBzZXQgdG8gdW5kZWZpbmVkLgogICAqIFRvIGFjY2VzcyBhIHJlc2VydmVkIGZpZWxkIHVzZSwgZm9vLnBiXzxuYW1lPiwgZWcsIGZvby5wYl9kZWZhdWx0LgogICAqIEZvciB0aGUgbGlzdCBvZiByZXNlcnZlZCBuYW1lcyBwbGVhc2Ugc2VlOgogICAqICAgICBuZXQvcHJvdG8yL2NvbXBpbGVyL2pzL2ludGVybmFsL2dlbmVyYXRvci5jYyNrS2V5d29yZC4KICAgKiBAcGFyYW0ge2Jvb2xlYW49fSBvcHRfaW5jbHVkZUluc3RhbmNlIERlcHJlY2F0ZWQuIHdoZXRoZXIgdG8gaW5jbHVkZSB0aGUKICAgKiAgICAgSlNQQiBpbnN0YW5jZSBmb3IgdHJhbnNpdGlvbmFsIHNveSBwcm90byBzdXBwb3J0OgogICAqICAgICBodHRwOi8vZ290by9zb3ktcGFyYW0tbWlncmF0aW9uCiAgICogQHJldHVybiB7IU9iamVjdH0KICAgKi8KICBwcm90by5wYi5jbXMuUHJvY2Vzc1Byb2ZpbGVSZXF1ZXN0LnByb3RvdHlwZS50b09iamVjdCA9IGZ1bmN0aW9uIChvcHRfaW5jbHVkZUluc3RhbmNlKSB7CiAgICByZXR1cm4gcHJvdG8ucGIuY21zLlByb2Nlc3NQcm9maWxlUmVxdWVzdC50b09iamVjdChvcHRfaW5jbHVkZUluc3RhbmNlLCB0aGlzKTsKICB9OwogIC8qKgogICAqIFN0YXRpYyB2ZXJzaW9uIG9mIHRoZSB7QHNlZSB0b09iamVjdH0gbWV0aG9kLgogICAqIEBwYXJhbSB7Ym9vbGVhbnx1bmRlZmluZWR9IGluY2x1ZGVJbnN0YW5jZSBEZXByZWNhdGVkLiBXaGV0aGVyIHRvIGluY2x1ZGUKICAgKiAgICAgdGhlIEpTUEIgaW5zdGFuY2UgZm9yIHRyYW5zaXRpb25hbCBzb3kgcHJvdG8gc3VwcG9ydDoKICAgKiAgICAgaHR0cDovL2dvdG8vc295LXBhcmFtLW1pZ3JhdGlvbgogICAqIEBwYXJhbSB7IXByb3RvLnBiLmNtcy5Qcm9jZXNzUHJvZmlsZVJlcXVlc3R9IG1zZyBUaGUgbXNnIGluc3RhbmNlIHRvIHRyYW5zZm9ybS4KICAgKiBAcmV0dXJuIHshT2JqZWN0fQogICAqIEBzdXBwcmVzcyB7dW51c2VkTG9jYWxWYXJpYWJsZXN9IGYgaXMgb25seSB1c2VkIGZvciBuZXN0ZWQgbWVzc2FnZXMKICAgKi8KCgogIHByb3RvLnBiLmNtcy5Qcm9jZXNzUHJvZmlsZVJlcXVlc3QudG9PYmplY3QgPSBmdW5jdGlvbiAoaW5jbHVkZUluc3RhbmNlLCBtc2cpIHsKICAgIHZhciBmLAogICAgICAgIG9iaiA9IHsKICAgICAgcHJvZmlsZUlkOiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdChtc2csIDEsIDApLAogICAgICBzdGF0dXM6IGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KG1zZywgMiwgMCksCiAgICAgIHJlYXNvbjoganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQobXNnLCAzLCAiIikKICAgIH07CgogICAgaWYgKGluY2x1ZGVJbnN0YW5jZSkgewogICAgICBvYmouJGpzcGJNZXNzYWdlSW5zdGFuY2UgPSBtc2c7CiAgICB9CgogICAgcmV0dXJuIG9iajsKICB9Owp9Ci8qKgogKiBEZXNlcmlhbGl6ZXMgYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUgZm9ybWF0KS4KICogQHBhcmFtIHtqc3BiLkJ5dGVTb3VyY2V9IGJ5dGVzIFRoZSBieXRlcyB0byBkZXNlcmlhbGl6ZS4KICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5Qcm9jZXNzUHJvZmlsZVJlcXVlc3R9CiAqLwoKCnByb3RvLnBiLmNtcy5Qcm9jZXNzUHJvZmlsZVJlcXVlc3QuZGVzZXJpYWxpemVCaW5hcnkgPSBmdW5jdGlvbiAoYnl0ZXMpIHsKICB2YXIgcmVhZGVyID0gbmV3IGpzcGIuQmluYXJ5UmVhZGVyKGJ5dGVzKTsKICB2YXIgbXNnID0gbmV3IHByb3RvLnBiLmNtcy5Qcm9jZXNzUHJvZmlsZVJlcXVlc3QoKTsKICByZXR1cm4gcHJvdG8ucGIuY21zLlByb2Nlc3NQcm9maWxlUmVxdWVzdC5kZXNlcmlhbGl6ZUJpbmFyeUZyb21SZWFkZXIobXNnLCByZWFkZXIpOwp9OwovKioKICogRGVzZXJpYWxpemVzIGJpbmFyeSBkYXRhIChpbiBwcm90b2J1ZiB3aXJlIGZvcm1hdCkgZnJvbSB0aGUKICogZ2l2ZW4gcmVhZGVyIGludG8gdGhlIGdpdmVuIG1lc3NhZ2Ugb2JqZWN0LgogKiBAcGFyYW0geyFwcm90by5wYi5jbXMuUHJvY2Vzc1Byb2ZpbGVSZXF1ZXN0fSBtc2cgVGhlIG1lc3NhZ2Ugb2JqZWN0IHRvIGRlc2VyaWFsaXplIGludG8uCiAqIEBwYXJhbSB7IWpzcGIuQmluYXJ5UmVhZGVyfSByZWFkZXIgVGhlIEJpbmFyeVJlYWRlciB0byB1c2UuCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuUHJvY2Vzc1Byb2ZpbGVSZXF1ZXN0fQogKi8KCgpwcm90by5wYi5jbXMuUHJvY2Vzc1Byb2ZpbGVSZXF1ZXN0LmRlc2VyaWFsaXplQmluYXJ5RnJvbVJlYWRlciA9IGZ1bmN0aW9uIChtc2csIHJlYWRlcikgewogIHdoaWxlIChyZWFkZXIubmV4dEZpZWxkKCkpIHsKICAgIGlmIChyZWFkZXIuaXNFbmRHcm91cCgpKSB7CiAgICAgIGJyZWFrOwogICAgfQoKICAgIHZhciBmaWVsZCA9IHJlYWRlci5nZXRGaWVsZE51bWJlcigpOwoKICAgIHN3aXRjaCAoZmllbGQpIHsKICAgICAgY2FzZSAxOgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkVWludDMyKCk7CiAgICAgICAgbXNnLnNldFByb2ZpbGVJZCh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlIDI6CiAgICAgICAgdmFyIHZhbHVlID0gcmVhZGVyLnJlYWRFbnVtKCk7CiAgICAgICAgbXNnLnNldFN0YXR1cyh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlIDM6CiAgICAgICAgdmFyIHZhbHVlID0gcmVhZGVyLnJlYWRTdHJpbmcoKTsKICAgICAgICBtc2cuc2V0UmVhc29uKHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGRlZmF1bHQ6CiAgICAgICAgcmVhZGVyLnNraXBGaWVsZCgpOwogICAgICAgIGJyZWFrOwogICAgfQogIH0KCiAgcmV0dXJuIG1zZzsKfTsKLyoqCiAqIFNlcmlhbGl6ZXMgdGhlIG1lc3NhZ2UgdG8gYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUgZm9ybWF0KS4KICogQHJldHVybiB7IVVpbnQ4QXJyYXl9CiAqLwoKCnByb3RvLnBiLmNtcy5Qcm9jZXNzUHJvZmlsZVJlcXVlc3QucHJvdG90eXBlLnNlcmlhbGl6ZUJpbmFyeSA9IGZ1bmN0aW9uICgpIHsKICB2YXIgd3JpdGVyID0gbmV3IGpzcGIuQmluYXJ5V3JpdGVyKCk7CiAgcHJvdG8ucGIuY21zLlByb2Nlc3NQcm9maWxlUmVxdWVzdC5zZXJpYWxpemVCaW5hcnlUb1dyaXRlcih0aGlzLCB3cml0ZXIpOwogIHJldHVybiB3cml0ZXIuZ2V0UmVzdWx0QnVmZmVyKCk7Cn07Ci8qKgogKiBTZXJpYWxpemVzIHRoZSBnaXZlbiBtZXNzYWdlIHRvIGJpbmFyeSBkYXRhIChpbiBwcm90b2J1ZiB3aXJlCiAqIGZvcm1hdCksIHdyaXRpbmcgdG8gdGhlIGdpdmVuIEJpbmFyeVdyaXRlci4KICogQHBhcmFtIHshcHJvdG8ucGIuY21zLlByb2Nlc3NQcm9maWxlUmVxdWVzdH0gbWVzc2FnZQogKiBAcGFyYW0geyFqc3BiLkJpbmFyeVdyaXRlcn0gd3JpdGVyCiAqIEBzdXBwcmVzcyB7dW51c2VkTG9jYWxWYXJpYWJsZXN9IGYgaXMgb25seSB1c2VkIGZvciBuZXN0ZWQgbWVzc2FnZXMKICovCgoKcHJvdG8ucGIuY21zLlByb2Nlc3NQcm9maWxlUmVxdWVzdC5zZXJpYWxpemVCaW5hcnlUb1dyaXRlciA9IGZ1bmN0aW9uIChtZXNzYWdlLCB3cml0ZXIpIHsKICB2YXIgZiA9IHVuZGVmaW5lZDsKICBmID0gbWVzc2FnZS5nZXRQcm9maWxlSWQoKTsKCiAgaWYgKGYgIT09IDApIHsKICAgIHdyaXRlci53cml0ZVVpbnQzMigxLCBmKTsKICB9CgogIGYgPSBtZXNzYWdlLmdldFN0YXR1cygpOwoKICBpZiAoZiAhPT0gMC4wKSB7CiAgICB3cml0ZXIud3JpdGVFbnVtKDIsIGYpOwogIH0KCiAgZiA9IG1lc3NhZ2UuZ2V0UmVhc29uKCk7CgogIGlmIChmLmxlbmd0aCA+IDApIHsKICAgIHdyaXRlci53cml0ZVN0cmluZygzLCBmKTsKICB9Cn07Ci8qKgogKiBvcHRpb25hbCB1aW50MzIgcHJvZmlsZV9pZCA9IDE7CiAqIEByZXR1cm4ge251bWJlcn0KICovCgoKcHJvdG8ucGIuY21zLlByb2Nlc3NQcm9maWxlUmVxdWVzdC5wcm90b3R5cGUuZ2V0UHJvZmlsZUlkID0gZnVuY3Rpb24gKCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdCh0aGlzLCAxLCAwKTsKfTsKLyoqCiAqIEBwYXJhbSB7bnVtYmVyfSB2YWx1ZQogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLlByb2Nlc3NQcm9maWxlUmVxdWVzdH0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5Qcm9jZXNzUHJvZmlsZVJlcXVlc3QucHJvdG90eXBlLnNldFByb2ZpbGVJZCA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UHJvdG8zSW50RmllbGQodGhpcywgMSwgdmFsdWUpOwp9OwovKioKICogb3B0aW9uYWwgcGIuUmV2aWV3U3RhdHVzIHN0YXR1cyA9IDI7CiAqIEByZXR1cm4geyFwcm90by5wYi5SZXZpZXdTdGF0dXN9CiAqLwoKCnByb3RvLnBiLmNtcy5Qcm9jZXNzUHJvZmlsZVJlcXVlc3QucHJvdG90eXBlLmdldFN0YXR1cyA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQodGhpcywgMiwgMCk7Cn07Ci8qKgogKiBAcGFyYW0geyFwcm90by5wYi5SZXZpZXdTdGF0dXN9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuUHJvY2Vzc1Byb2ZpbGVSZXF1ZXN0fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLlByb2Nlc3NQcm9maWxlUmVxdWVzdC5wcm90b3R5cGUuc2V0U3RhdHVzID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRQcm90bzNFbnVtRmllbGQodGhpcywgMiwgdmFsdWUpOwp9OwovKioKICogb3B0aW9uYWwgc3RyaW5nIHJlYXNvbiA9IDM7CiAqIEByZXR1cm4ge3N0cmluZ30KICovCgoKcHJvdG8ucGIuY21zLlByb2Nlc3NQcm9maWxlUmVxdWVzdC5wcm90b3R5cGUuZ2V0UmVhc29uID0gZnVuY3Rpb24gKCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdCh0aGlzLCAzLCAiIik7Cn07Ci8qKgogKiBAcGFyYW0ge3N0cmluZ30gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5Qcm9jZXNzUHJvZmlsZVJlcXVlc3R9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuUHJvY2Vzc1Byb2ZpbGVSZXF1ZXN0LnByb3RvdHlwZS5zZXRSZWFzb24gPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM1N0cmluZ0ZpZWxkKHRoaXMsIDMsIHZhbHVlKTsKfTsKLyoqCiAqIExpc3Qgb2YgcmVwZWF0ZWQgZmllbGRzIHdpdGhpbiB0aGlzIG1lc3NhZ2UgdHlwZS4KICogQHByaXZhdGUgeyFBcnJheTxudW1iZXI+fQogKiBAY29uc3QKICovCgoKcHJvdG8ucGIuY21zLlZpb2xhdGlvbkxpc3RSZXF1ZXN0LnJlcGVhdGVkRmllbGRzXyA9IFs0XTsKCmlmIChqc3BiLk1lc3NhZ2UuR0VORVJBVEVfVE9fT0JKRUNUKSB7CiAgLyoqCiAgICogQ3JlYXRlcyBhbiBvYmplY3QgcmVwcmVzZW50YXRpb24gb2YgdGhpcyBwcm90by4KICAgKiBGaWVsZCBuYW1lcyB0aGF0IGFyZSByZXNlcnZlZCBpbiBKYXZhU2NyaXB0IGFuZCB3aWxsIGJlIHJlbmFtZWQgdG8gcGJfbmFtZS4KICAgKiBPcHRpb25hbCBmaWVsZHMgdGhhdCBhcmUgbm90IHNldCB3aWxsIGJlIHNldCB0byB1bmRlZmluZWQuCiAgICogVG8gYWNjZXNzIGEgcmVzZXJ2ZWQgZmllbGQgdXNlLCBmb28ucGJfPG5hbWU+LCBlZywgZm9vLnBiX2RlZmF1bHQuCiAgICogRm9yIHRoZSBsaXN0IG9mIHJlc2VydmVkIG5hbWVzIHBsZWFzZSBzZWU6CiAgICogICAgIG5ldC9wcm90bzIvY29tcGlsZXIvanMvaW50ZXJuYWwvZ2VuZXJhdG9yLmNjI2tLZXl3b3JkLgogICAqIEBwYXJhbSB7Ym9vbGVhbj19IG9wdF9pbmNsdWRlSW5zdGFuY2UgRGVwcmVjYXRlZC4gd2hldGhlciB0byBpbmNsdWRlIHRoZQogICAqICAgICBKU1BCIGluc3RhbmNlIGZvciB0cmFuc2l0aW9uYWwgc295IHByb3RvIHN1cHBvcnQ6CiAgICogICAgIGh0dHA6Ly9nb3RvL3NveS1wYXJhbS1taWdyYXRpb24KICAgKiBAcmV0dXJuIHshT2JqZWN0fQogICAqLwogIHByb3RvLnBiLmNtcy5WaW9sYXRpb25MaXN0UmVxdWVzdC5wcm90b3R5cGUudG9PYmplY3QgPSBmdW5jdGlvbiAob3B0X2luY2x1ZGVJbnN0YW5jZSkgewogICAgcmV0dXJuIHByb3RvLnBiLmNtcy5WaW9sYXRpb25MaXN0UmVxdWVzdC50b09iamVjdChvcHRfaW5jbHVkZUluc3RhbmNlLCB0aGlzKTsKICB9OwogIC8qKgogICAqIFN0YXRpYyB2ZXJzaW9uIG9mIHRoZSB7QHNlZSB0b09iamVjdH0gbWV0aG9kLgogICAqIEBwYXJhbSB7Ym9vbGVhbnx1bmRlZmluZWR9IGluY2x1ZGVJbnN0YW5jZSBEZXByZWNhdGVkLiBXaGV0aGVyIHRvIGluY2x1ZGUKICAgKiAgICAgdGhlIEpTUEIgaW5zdGFuY2UgZm9yIHRyYW5zaXRpb25hbCBzb3kgcHJvdG8gc3VwcG9ydDoKICAgKiAgICAgaHR0cDovL2dvdG8vc295LXBhcmFtLW1pZ3JhdGlvbgogICAqIEBwYXJhbSB7IXByb3RvLnBiLmNtcy5WaW9sYXRpb25MaXN0UmVxdWVzdH0gbXNnIFRoZSBtc2cgaW5zdGFuY2UgdG8gdHJhbnNmb3JtLgogICAqIEByZXR1cm4geyFPYmplY3R9CiAgICogQHN1cHByZXNzIHt1bnVzZWRMb2NhbFZhcmlhYmxlc30gZiBpcyBvbmx5IHVzZWQgZm9yIG5lc3RlZCBtZXNzYWdlcwogICAqLwoKCiAgcHJvdG8ucGIuY21zLlZpb2xhdGlvbkxpc3RSZXF1ZXN0LnRvT2JqZWN0ID0gZnVuY3Rpb24gKGluY2x1ZGVJbnN0YW5jZSwgbXNnKSB7CiAgICB2YXIgZiwKICAgICAgICBvYmogPSB7CiAgICAgIHBhZ2VObzoganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQobXNnLCAxLCAwKSwKICAgICAgcGFnZVNpemU6IGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KG1zZywgMiwgMCksCiAgICAgIGFyZWFJZDoganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQobXNnLCAzLCAwKSwKICAgICAgZGVhbFN0YXR1c0xpc3Q6IChmID0ganNwYi5NZXNzYWdlLmdldFJlcGVhdGVkRmllbGQobXNnLCA0KSkgPT0gbnVsbCA/IHVuZGVmaW5lZCA6IGYsCiAgICAgIHNjZW5lOiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdChtc2csIDUsIDApLAogICAgICByZXBvcnRlclR5cGU6IGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KG1zZywgNiwgMCksCiAgICAgIHJlcG9ydGVySWQ6IGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KG1zZywgNywgMCksCiAgICAgIHJlcG9ydGVkVHlwZToganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQobXNnLCA4LCAwKSwKICAgICAgcmVwb3J0ZWRJZDoganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQobXNnLCA5LCAwKSwKICAgICAgY3JlYXRlZFN0YXJ0OiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdChtc2csIDEwLCAwKSwKICAgICAgY3JlYXRlZEVuZDoganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQobXNnLCAxMSwgMCkKICAgIH07CgogICAgaWYgKGluY2x1ZGVJbnN0YW5jZSkgewogICAgICBvYmouJGpzcGJNZXNzYWdlSW5zdGFuY2UgPSBtc2c7CiAgICB9CgogICAgcmV0dXJuIG9iajsKICB9Owp9Ci8qKgogKiBEZXNlcmlhbGl6ZXMgYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUgZm9ybWF0KS4KICogQHBhcmFtIHtqc3BiLkJ5dGVTb3VyY2V9IGJ5dGVzIFRoZSBieXRlcyB0byBkZXNlcmlhbGl6ZS4KICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5WaW9sYXRpb25MaXN0UmVxdWVzdH0KICovCgoKcHJvdG8ucGIuY21zLlZpb2xhdGlvbkxpc3RSZXF1ZXN0LmRlc2VyaWFsaXplQmluYXJ5ID0gZnVuY3Rpb24gKGJ5dGVzKSB7CiAgdmFyIHJlYWRlciA9IG5ldyBqc3BiLkJpbmFyeVJlYWRlcihieXRlcyk7CiAgdmFyIG1zZyA9IG5ldyBwcm90by5wYi5jbXMuVmlvbGF0aW9uTGlzdFJlcXVlc3QoKTsKICByZXR1cm4gcHJvdG8ucGIuY21zLlZpb2xhdGlvbkxpc3RSZXF1ZXN0LmRlc2VyaWFsaXplQmluYXJ5RnJvbVJlYWRlcihtc2csIHJlYWRlcik7Cn07Ci8qKgogKiBEZXNlcmlhbGl6ZXMgYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUgZm9ybWF0KSBmcm9tIHRoZQogKiBnaXZlbiByZWFkZXIgaW50byB0aGUgZ2l2ZW4gbWVzc2FnZSBvYmplY3QuCiAqIEBwYXJhbSB7IXByb3RvLnBiLmNtcy5WaW9sYXRpb25MaXN0UmVxdWVzdH0gbXNnIFRoZSBtZXNzYWdlIG9iamVjdCB0byBkZXNlcmlhbGl6ZSBpbnRvLgogKiBAcGFyYW0geyFqc3BiLkJpbmFyeVJlYWRlcn0gcmVhZGVyIFRoZSBCaW5hcnlSZWFkZXIgdG8gdXNlLgogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLlZpb2xhdGlvbkxpc3RSZXF1ZXN0fQogKi8KCgpwcm90by5wYi5jbXMuVmlvbGF0aW9uTGlzdFJlcXVlc3QuZGVzZXJpYWxpemVCaW5hcnlGcm9tUmVhZGVyID0gZnVuY3Rpb24gKG1zZywgcmVhZGVyKSB7CiAgd2hpbGUgKHJlYWRlci5uZXh0RmllbGQoKSkgewogICAgaWYgKHJlYWRlci5pc0VuZEdyb3VwKCkpIHsKICAgICAgYnJlYWs7CiAgICB9CgogICAgdmFyIGZpZWxkID0gcmVhZGVyLmdldEZpZWxkTnVtYmVyKCk7CgogICAgc3dpdGNoIChmaWVsZCkgewogICAgICBjYXNlIDE6CiAgICAgICAgdmFyIHZhbHVlID0gcmVhZGVyLnJlYWRVaW50MzIoKTsKICAgICAgICBtc2cuc2V0UGFnZU5vKHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgMjoKICAgICAgICB2YXIgdmFsdWUgPSByZWFkZXIucmVhZFVpbnQzMigpOwogICAgICAgIG1zZy5zZXRQYWdlU2l6ZSh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlIDM6CiAgICAgICAgdmFyIHZhbHVlID0gcmVhZGVyLnJlYWRVaW50MzIoKTsKICAgICAgICBtc2cuc2V0QXJlYUlkKHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgNDoKICAgICAgICB2YXIgdmFsdWVzID0gcmVhZGVyLmlzRGVsaW1pdGVkKCkgPyByZWFkZXIucmVhZFBhY2tlZEVudW0oKSA6IFtyZWFkZXIucmVhZEVudW0oKV07CgogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdmFsdWVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBtc2cuYWRkRGVhbFN0YXR1cyh2YWx1ZXNbaV0pOwogICAgICAgIH0KCiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlIDU6CiAgICAgICAgdmFyIHZhbHVlID0gcmVhZGVyLnJlYWRFbnVtKCk7CiAgICAgICAgbXNnLnNldFNjZW5lKHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgNjoKICAgICAgICB2YXIgdmFsdWUgPSByZWFkZXIucmVhZEVudW0oKTsKICAgICAgICBtc2cuc2V0UmVwb3J0ZXJUeXBlKHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgNzoKICAgICAgICB2YXIgdmFsdWUgPSByZWFkZXIucmVhZFVpbnQzMigpOwogICAgICAgIG1zZy5zZXRSZXBvcnRlcklkKHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgODoKICAgICAgICB2YXIgdmFsdWUgPSByZWFkZXIucmVhZEVudW0oKTsKICAgICAgICBtc2cuc2V0UmVwb3J0ZWRUeXBlKHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgOToKICAgICAgICB2YXIgdmFsdWUgPSByZWFkZXIucmVhZFVpbnQzMigpOwogICAgICAgIG1zZy5zZXRSZXBvcnRlZElkKHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgMTA6CiAgICAgICAgdmFyIHZhbHVlID0gcmVhZGVyLnJlYWRVaW50MzIoKTsKICAgICAgICBtc2cuc2V0Q3JlYXRlZFN0YXJ0KHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgMTE6CiAgICAgICAgdmFyIHZhbHVlID0gcmVhZGVyLnJlYWRVaW50MzIoKTsKICAgICAgICBtc2cuc2V0Q3JlYXRlZEVuZCh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBkZWZhdWx0OgogICAgICAgIHJlYWRlci5za2lwRmllbGQoKTsKICAgICAgICBicmVhazsKICAgIH0KICB9CgogIHJldHVybiBtc2c7Cn07Ci8qKgogKiBTZXJpYWxpemVzIHRoZSBtZXNzYWdlIHRvIGJpbmFyeSBkYXRhIChpbiBwcm90b2J1ZiB3aXJlIGZvcm1hdCkuCiAqIEByZXR1cm4geyFVaW50OEFycmF5fQogKi8KCgpwcm90by5wYi5jbXMuVmlvbGF0aW9uTGlzdFJlcXVlc3QucHJvdG90eXBlLnNlcmlhbGl6ZUJpbmFyeSA9IGZ1bmN0aW9uICgpIHsKICB2YXIgd3JpdGVyID0gbmV3IGpzcGIuQmluYXJ5V3JpdGVyKCk7CiAgcHJvdG8ucGIuY21zLlZpb2xhdGlvbkxpc3RSZXF1ZXN0LnNlcmlhbGl6ZUJpbmFyeVRvV3JpdGVyKHRoaXMsIHdyaXRlcik7CiAgcmV0dXJuIHdyaXRlci5nZXRSZXN1bHRCdWZmZXIoKTsKfTsKLyoqCiAqIFNlcmlhbGl6ZXMgdGhlIGdpdmVuIG1lc3NhZ2UgdG8gYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUKICogZm9ybWF0KSwgd3JpdGluZyB0byB0aGUgZ2l2ZW4gQmluYXJ5V3JpdGVyLgogKiBAcGFyYW0geyFwcm90by5wYi5jbXMuVmlvbGF0aW9uTGlzdFJlcXVlc3R9IG1lc3NhZ2UKICogQHBhcmFtIHshanNwYi5CaW5hcnlXcml0ZXJ9IHdyaXRlcgogKiBAc3VwcHJlc3Mge3VudXNlZExvY2FsVmFyaWFibGVzfSBmIGlzIG9ubHkgdXNlZCBmb3IgbmVzdGVkIG1lc3NhZ2VzCiAqLwoKCnByb3RvLnBiLmNtcy5WaW9sYXRpb25MaXN0UmVxdWVzdC5zZXJpYWxpemVCaW5hcnlUb1dyaXRlciA9IGZ1bmN0aW9uIChtZXNzYWdlLCB3cml0ZXIpIHsKICB2YXIgZiA9IHVuZGVmaW5lZDsKICBmID0gbWVzc2FnZS5nZXRQYWdlTm8oKTsKCiAgaWYgKGYgIT09IDApIHsKICAgIHdyaXRlci53cml0ZVVpbnQzMigxLCBmKTsKICB9CgogIGYgPSBtZXNzYWdlLmdldFBhZ2VTaXplKCk7CgogIGlmIChmICE9PSAwKSB7CiAgICB3cml0ZXIud3JpdGVVaW50MzIoMiwgZik7CiAgfQoKICBmID0gbWVzc2FnZS5nZXRBcmVhSWQoKTsKCiAgaWYgKGYgIT09IDApIHsKICAgIHdyaXRlci53cml0ZVVpbnQzMigzLCBmKTsKICB9CgogIGYgPSBtZXNzYWdlLmdldERlYWxTdGF0dXNMaXN0KCk7CgogIGlmIChmLmxlbmd0aCA+IDApIHsKICAgIHdyaXRlci53cml0ZVBhY2tlZEVudW0oNCwgZik7CiAgfQoKICBmID0gbWVzc2FnZS5nZXRTY2VuZSgpOwoKICBpZiAoZiAhPT0gMC4wKSB7CiAgICB3cml0ZXIud3JpdGVFbnVtKDUsIGYpOwogIH0KCiAgZiA9IG1lc3NhZ2UuZ2V0UmVwb3J0ZXJUeXBlKCk7CgogIGlmIChmICE9PSAwLjApIHsKICAgIHdyaXRlci53cml0ZUVudW0oNiwgZik7CiAgfQoKICBmID0gbWVzc2FnZS5nZXRSZXBvcnRlcklkKCk7CgogIGlmIChmICE9PSAwKSB7CiAgICB3cml0ZXIud3JpdGVVaW50MzIoNywgZik7CiAgfQoKICBmID0gbWVzc2FnZS5nZXRSZXBvcnRlZFR5cGUoKTsKCiAgaWYgKGYgIT09IDAuMCkgewogICAgd3JpdGVyLndyaXRlRW51bSg4LCBmKTsKICB9CgogIGYgPSBtZXNzYWdlLmdldFJlcG9ydGVkSWQoKTsKCiAgaWYgKGYgIT09IDApIHsKICAgIHdyaXRlci53cml0ZVVpbnQzMig5LCBmKTsKICB9CgogIGYgPSBtZXNzYWdlLmdldENyZWF0ZWRTdGFydCgpOwoKICBpZiAoZiAhPT0gMCkgewogICAgd3JpdGVyLndyaXRlVWludDMyKDEwLCBmKTsKICB9CgogIGYgPSBtZXNzYWdlLmdldENyZWF0ZWRFbmQoKTsKCiAgaWYgKGYgIT09IDApIHsKICAgIHdyaXRlci53cml0ZVVpbnQzMigxMSwgZik7CiAgfQp9OwovKioKICogb3B0aW9uYWwgdWludDMyIHBhZ2Vfbm8gPSAxOwogKiBAcmV0dXJuIHtudW1iZXJ9CiAqLwoKCnByb3RvLnBiLmNtcy5WaW9sYXRpb25MaXN0UmVxdWVzdC5wcm90b3R5cGUuZ2V0UGFnZU5vID0gZnVuY3Rpb24gKCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdCh0aGlzLCAxLCAwKTsKfTsKLyoqCiAqIEBwYXJhbSB7bnVtYmVyfSB2YWx1ZQogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLlZpb2xhdGlvbkxpc3RSZXF1ZXN0fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLlZpb2xhdGlvbkxpc3RSZXF1ZXN0LnByb3RvdHlwZS5zZXRQYWdlTm8gPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0ludEZpZWxkKHRoaXMsIDEsIHZhbHVlKTsKfTsKLyoqCiAqIG9wdGlvbmFsIHVpbnQzMiBwYWdlX3NpemUgPSAyOwogKiBAcmV0dXJuIHtudW1iZXJ9CiAqLwoKCnByb3RvLnBiLmNtcy5WaW9sYXRpb25MaXN0UmVxdWVzdC5wcm90b3R5cGUuZ2V0UGFnZVNpemUgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDIsIDApOwp9OwovKioKICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuVmlvbGF0aW9uTGlzdFJlcXVlc3R9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuVmlvbGF0aW9uTGlzdFJlcXVlc3QucHJvdG90eXBlLnNldFBhZ2VTaXplID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRQcm90bzNJbnRGaWVsZCh0aGlzLCAyLCB2YWx1ZSk7Cn07Ci8qKgogKiBvcHRpb25hbCB1aW50MzIgYXJlYV9pZCA9IDM7CiAqIEByZXR1cm4ge251bWJlcn0KICovCgoKcHJvdG8ucGIuY21zLlZpb2xhdGlvbkxpc3RSZXF1ZXN0LnByb3RvdHlwZS5nZXRBcmVhSWQgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDMsIDApOwp9OwovKioKICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuVmlvbGF0aW9uTGlzdFJlcXVlc3R9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuVmlvbGF0aW9uTGlzdFJlcXVlc3QucHJvdG90eXBlLnNldEFyZWFJZCA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UHJvdG8zSW50RmllbGQodGhpcywgMywgdmFsdWUpOwp9OwovKioKICogcmVwZWF0ZWQgcGIuQmxvY2tTdGF0dXMgZGVhbF9zdGF0dXMgPSA0OwogKiBAcmV0dXJuIHshQXJyYXk8IXByb3RvLnBiLkJsb2NrU3RhdHVzPn0KICovCgoKcHJvdG8ucGIuY21zLlZpb2xhdGlvbkxpc3RSZXF1ZXN0LnByb3RvdHlwZS5nZXREZWFsU3RhdHVzTGlzdCA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldFJlcGVhdGVkRmllbGQodGhpcywgNCk7Cn07Ci8qKgogKiBAcGFyYW0geyFBcnJheTwhcHJvdG8ucGIuQmxvY2tTdGF0dXM+fSB2YWx1ZQogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLlZpb2xhdGlvbkxpc3RSZXF1ZXN0fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLlZpb2xhdGlvbkxpc3RSZXF1ZXN0LnByb3RvdHlwZS5zZXREZWFsU3RhdHVzTGlzdCA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0RmllbGQodGhpcywgNCwgdmFsdWUgfHwgW10pOwp9OwovKioKICogQHBhcmFtIHshcHJvdG8ucGIuQmxvY2tTdGF0dXN9IHZhbHVlCiAqIEBwYXJhbSB7bnVtYmVyPX0gb3B0X2luZGV4CiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuVmlvbGF0aW9uTGlzdFJlcXVlc3R9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuVmlvbGF0aW9uTGlzdFJlcXVlc3QucHJvdG90eXBlLmFkZERlYWxTdGF0dXMgPSBmdW5jdGlvbiAodmFsdWUsIG9wdF9pbmRleCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuYWRkVG9SZXBlYXRlZEZpZWxkKHRoaXMsIDQsIHZhbHVlLCBvcHRfaW5kZXgpOwp9OwovKioKICogQ2xlYXJzIHRoZSBsaXN0IG1ha2luZyBpdCBlbXB0eSBidXQgbm9uLW51bGwuCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuVmlvbGF0aW9uTGlzdFJlcXVlc3R9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuVmlvbGF0aW9uTGlzdFJlcXVlc3QucHJvdG90eXBlLmNsZWFyRGVhbFN0YXR1c0xpc3QgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIHRoaXMuc2V0RGVhbFN0YXR1c0xpc3QoW10pOwp9OwovKioKICogb3B0aW9uYWwgcGIuVmlvbGF0aW9uU2NlbmUgU2NlbmUgPSA1OwogKiBAcmV0dXJuIHshcHJvdG8ucGIuVmlvbGF0aW9uU2NlbmV9CiAqLwoKCnByb3RvLnBiLmNtcy5WaW9sYXRpb25MaXN0UmVxdWVzdC5wcm90b3R5cGUuZ2V0U2NlbmUgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDUsIDApOwp9OwovKioKICogQHBhcmFtIHshcHJvdG8ucGIuVmlvbGF0aW9uU2NlbmV9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuVmlvbGF0aW9uTGlzdFJlcXVlc3R9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuVmlvbGF0aW9uTGlzdFJlcXVlc3QucHJvdG90eXBlLnNldFNjZW5lID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRQcm90bzNFbnVtRmllbGQodGhpcywgNSwgdmFsdWUpOwp9OwovKioKICogb3B0aW9uYWwgcGIuRW50aXR5VHlwZSByZXBvcnRlcl90eXBlID0gNjsKICogQHJldHVybiB7IXByb3RvLnBiLkVudGl0eVR5cGV9CiAqLwoKCnByb3RvLnBiLmNtcy5WaW9sYXRpb25MaXN0UmVxdWVzdC5wcm90b3R5cGUuZ2V0UmVwb3J0ZXJUeXBlID0gZnVuY3Rpb24gKCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdCh0aGlzLCA2LCAwKTsKfTsKLyoqCiAqIEBwYXJhbSB7IXByb3RvLnBiLkVudGl0eVR5cGV9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuVmlvbGF0aW9uTGlzdFJlcXVlc3R9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuVmlvbGF0aW9uTGlzdFJlcXVlc3QucHJvdG90eXBlLnNldFJlcG9ydGVyVHlwZSA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UHJvdG8zRW51bUZpZWxkKHRoaXMsIDYsIHZhbHVlKTsKfTsKLyoqCiAqIG9wdGlvbmFsIHVpbnQzMiByZXBvcnRlcl9pZCA9IDc7CiAqIEByZXR1cm4ge251bWJlcn0KICovCgoKcHJvdG8ucGIuY21zLlZpb2xhdGlvbkxpc3RSZXF1ZXN0LnByb3RvdHlwZS5nZXRSZXBvcnRlcklkID0gZnVuY3Rpb24gKCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdCh0aGlzLCA3LCAwKTsKfTsKLyoqCiAqIEBwYXJhbSB7bnVtYmVyfSB2YWx1ZQogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLlZpb2xhdGlvbkxpc3RSZXF1ZXN0fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLlZpb2xhdGlvbkxpc3RSZXF1ZXN0LnByb3RvdHlwZS5zZXRSZXBvcnRlcklkID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRQcm90bzNJbnRGaWVsZCh0aGlzLCA3LCB2YWx1ZSk7Cn07Ci8qKgogKiBvcHRpb25hbCBwYi5FbnRpdHlUeXBlIHJlcG9ydGVkX3R5cGUgPSA4OwogKiBAcmV0dXJuIHshcHJvdG8ucGIuRW50aXR5VHlwZX0KICovCgoKcHJvdG8ucGIuY21zLlZpb2xhdGlvbkxpc3RSZXF1ZXN0LnByb3RvdHlwZS5nZXRSZXBvcnRlZFR5cGUgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDgsIDApOwp9OwovKioKICogQHBhcmFtIHshcHJvdG8ucGIuRW50aXR5VHlwZX0gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5WaW9sYXRpb25MaXN0UmVxdWVzdH0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5WaW9sYXRpb25MaXN0UmVxdWVzdC5wcm90b3R5cGUuc2V0UmVwb3J0ZWRUeXBlID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRQcm90bzNFbnVtRmllbGQodGhpcywgOCwgdmFsdWUpOwp9OwovKioKICogb3B0aW9uYWwgdWludDMyIHJlcG9ydGVkX2lkID0gOTsKICogQHJldHVybiB7bnVtYmVyfQogKi8KCgpwcm90by5wYi5jbXMuVmlvbGF0aW9uTGlzdFJlcXVlc3QucHJvdG90eXBlLmdldFJlcG9ydGVkSWQgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDksIDApOwp9OwovKioKICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuVmlvbGF0aW9uTGlzdFJlcXVlc3R9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuVmlvbGF0aW9uTGlzdFJlcXVlc3QucHJvdG90eXBlLnNldFJlcG9ydGVkSWQgPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0ludEZpZWxkKHRoaXMsIDksIHZhbHVlKTsKfTsKLyoqCiAqIG9wdGlvbmFsIHVpbnQzMiBjcmVhdGVkX3N0YXJ0ID0gMTA7CiAqIEByZXR1cm4ge251bWJlcn0KICovCgoKcHJvdG8ucGIuY21zLlZpb2xhdGlvbkxpc3RSZXF1ZXN0LnByb3RvdHlwZS5nZXRDcmVhdGVkU3RhcnQgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDEwLCAwKTsKfTsKLyoqCiAqIEBwYXJhbSB7bnVtYmVyfSB2YWx1ZQogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLlZpb2xhdGlvbkxpc3RSZXF1ZXN0fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLlZpb2xhdGlvbkxpc3RSZXF1ZXN0LnByb3RvdHlwZS5zZXRDcmVhdGVkU3RhcnQgPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0ludEZpZWxkKHRoaXMsIDEwLCB2YWx1ZSk7Cn07Ci8qKgogKiBvcHRpb25hbCB1aW50MzIgY3JlYXRlZF9lbmQgPSAxMTsKICogQHJldHVybiB7bnVtYmVyfQogKi8KCgpwcm90by5wYi5jbXMuVmlvbGF0aW9uTGlzdFJlcXVlc3QucHJvdG90eXBlLmdldENyZWF0ZWRFbmQgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDExLCAwKTsKfTsKLyoqCiAqIEBwYXJhbSB7bnVtYmVyfSB2YWx1ZQogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLlZpb2xhdGlvbkxpc3RSZXF1ZXN0fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLlZpb2xhdGlvbkxpc3RSZXF1ZXN0LnByb3RvdHlwZS5zZXRDcmVhdGVkRW5kID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRQcm90bzNJbnRGaWVsZCh0aGlzLCAxMSwgdmFsdWUpOwp9OwovKioKICogTGlzdCBvZiByZXBlYXRlZCBmaWVsZHMgd2l0aGluIHRoaXMgbWVzc2FnZSB0eXBlLgogKiBAcHJpdmF0ZSB7IUFycmF5PG51bWJlcj59CiAqIEBjb25zdAogKi8KCgpwcm90by5wYi5jbXMuVmlvbGF0aW9uTGlzdFJlcGx5LnJlcGVhdGVkRmllbGRzXyA9IFsxXTsKCmlmIChqc3BiLk1lc3NhZ2UuR0VORVJBVEVfVE9fT0JKRUNUKSB7CiAgLyoqCiAgICogQ3JlYXRlcyBhbiBvYmplY3QgcmVwcmVzZW50YXRpb24gb2YgdGhpcyBwcm90by4KICAgKiBGaWVsZCBuYW1lcyB0aGF0IGFyZSByZXNlcnZlZCBpbiBKYXZhU2NyaXB0IGFuZCB3aWxsIGJlIHJlbmFtZWQgdG8gcGJfbmFtZS4KICAgKiBPcHRpb25hbCBmaWVsZHMgdGhhdCBhcmUgbm90IHNldCB3aWxsIGJlIHNldCB0byB1bmRlZmluZWQuCiAgICogVG8gYWNjZXNzIGEgcmVzZXJ2ZWQgZmllbGQgdXNlLCBmb28ucGJfPG5hbWU+LCBlZywgZm9vLnBiX2RlZmF1bHQuCiAgICogRm9yIHRoZSBsaXN0IG9mIHJlc2VydmVkIG5hbWVzIHBsZWFzZSBzZWU6CiAgICogICAgIG5ldC9wcm90bzIvY29tcGlsZXIvanMvaW50ZXJuYWwvZ2VuZXJhdG9yLmNjI2tLZXl3b3JkLgogICAqIEBwYXJhbSB7Ym9vbGVhbj19IG9wdF9pbmNsdWRlSW5zdGFuY2UgRGVwcmVjYXRlZC4gd2hldGhlciB0byBpbmNsdWRlIHRoZQogICAqICAgICBKU1BCIGluc3RhbmNlIGZvciB0cmFuc2l0aW9uYWwgc295IHByb3RvIHN1cHBvcnQ6CiAgICogICAgIGh0dHA6Ly9nb3RvL3NveS1wYXJhbS1taWdyYXRpb24KICAgKiBAcmV0dXJuIHshT2JqZWN0fQogICAqLwogIHByb3RvLnBiLmNtcy5WaW9sYXRpb25MaXN0UmVwbHkucHJvdG90eXBlLnRvT2JqZWN0ID0gZnVuY3Rpb24gKG9wdF9pbmNsdWRlSW5zdGFuY2UpIHsKICAgIHJldHVybiBwcm90by5wYi5jbXMuVmlvbGF0aW9uTGlzdFJlcGx5LnRvT2JqZWN0KG9wdF9pbmNsdWRlSW5zdGFuY2UsIHRoaXMpOwogIH07CiAgLyoqCiAgICogU3RhdGljIHZlcnNpb24gb2YgdGhlIHtAc2VlIHRvT2JqZWN0fSBtZXRob2QuCiAgICogQHBhcmFtIHtib29sZWFufHVuZGVmaW5lZH0gaW5jbHVkZUluc3RhbmNlIERlcHJlY2F0ZWQuIFdoZXRoZXIgdG8gaW5jbHVkZQogICAqICAgICB0aGUgSlNQQiBpbnN0YW5jZSBmb3IgdHJhbnNpdGlvbmFsIHNveSBwcm90byBzdXBwb3J0OgogICAqICAgICBodHRwOi8vZ290by9zb3ktcGFyYW0tbWlncmF0aW9uCiAgICogQHBhcmFtIHshcHJvdG8ucGIuY21zLlZpb2xhdGlvbkxpc3RSZXBseX0gbXNnIFRoZSBtc2cgaW5zdGFuY2UgdG8gdHJhbnNmb3JtLgogICAqIEByZXR1cm4geyFPYmplY3R9CiAgICogQHN1cHByZXNzIHt1bnVzZWRMb2NhbFZhcmlhYmxlc30gZiBpcyBvbmx5IHVzZWQgZm9yIG5lc3RlZCBtZXNzYWdlcwogICAqLwoKCiAgcHJvdG8ucGIuY21zLlZpb2xhdGlvbkxpc3RSZXBseS50b09iamVjdCA9IGZ1bmN0aW9uIChpbmNsdWRlSW5zdGFuY2UsIG1zZykgewogICAgdmFyIGYsCiAgICAgICAgb2JqID0gewogICAgICByZWNvcmRzTGlzdDoganNwYi5NZXNzYWdlLnRvT2JqZWN0TGlzdChtc2cuZ2V0UmVjb3Jkc0xpc3QoKSwgdXNlcnR5cGVfcGIuVmlvbGF0aW9uUmVjb3JkLnRvT2JqZWN0LCBpbmNsdWRlSW5zdGFuY2UpLAogICAgICBwYWdlTm86IGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KG1zZywgMiwgMCksCiAgICAgIHBhZ2VTaXplOiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdChtc2csIDMsIDApLAogICAgICB0b3RhbFBhZ2U6IGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KG1zZywgNCwgMCksCiAgICAgIHRvdGFsQ291bnQ6IGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KG1zZywgNSwgMCkKICAgIH07CgogICAgaWYgKGluY2x1ZGVJbnN0YW5jZSkgewogICAgICBvYmouJGpzcGJNZXNzYWdlSW5zdGFuY2UgPSBtc2c7CiAgICB9CgogICAgcmV0dXJuIG9iajsKICB9Owp9Ci8qKgogKiBEZXNlcmlhbGl6ZXMgYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUgZm9ybWF0KS4KICogQHBhcmFtIHtqc3BiLkJ5dGVTb3VyY2V9IGJ5dGVzIFRoZSBieXRlcyB0byBkZXNlcmlhbGl6ZS4KICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5WaW9sYXRpb25MaXN0UmVwbHl9CiAqLwoKCnByb3RvLnBiLmNtcy5WaW9sYXRpb25MaXN0UmVwbHkuZGVzZXJpYWxpemVCaW5hcnkgPSBmdW5jdGlvbiAoYnl0ZXMpIHsKICB2YXIgcmVhZGVyID0gbmV3IGpzcGIuQmluYXJ5UmVhZGVyKGJ5dGVzKTsKICB2YXIgbXNnID0gbmV3IHByb3RvLnBiLmNtcy5WaW9sYXRpb25MaXN0UmVwbHkoKTsKICByZXR1cm4gcHJvdG8ucGIuY21zLlZpb2xhdGlvbkxpc3RSZXBseS5kZXNlcmlhbGl6ZUJpbmFyeUZyb21SZWFkZXIobXNnLCByZWFkZXIpOwp9OwovKioKICogRGVzZXJpYWxpemVzIGJpbmFyeSBkYXRhIChpbiBwcm90b2J1ZiB3aXJlIGZvcm1hdCkgZnJvbSB0aGUKICogZ2l2ZW4gcmVhZGVyIGludG8gdGhlIGdpdmVuIG1lc3NhZ2Ugb2JqZWN0LgogKiBAcGFyYW0geyFwcm90by5wYi5jbXMuVmlvbGF0aW9uTGlzdFJlcGx5fSBtc2cgVGhlIG1lc3NhZ2Ugb2JqZWN0IHRvIGRlc2VyaWFsaXplIGludG8uCiAqIEBwYXJhbSB7IWpzcGIuQmluYXJ5UmVhZGVyfSByZWFkZXIgVGhlIEJpbmFyeVJlYWRlciB0byB1c2UuCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuVmlvbGF0aW9uTGlzdFJlcGx5fQogKi8KCgpwcm90by5wYi5jbXMuVmlvbGF0aW9uTGlzdFJlcGx5LmRlc2VyaWFsaXplQmluYXJ5RnJvbVJlYWRlciA9IGZ1bmN0aW9uIChtc2csIHJlYWRlcikgewogIHdoaWxlIChyZWFkZXIubmV4dEZpZWxkKCkpIHsKICAgIGlmIChyZWFkZXIuaXNFbmRHcm91cCgpKSB7CiAgICAgIGJyZWFrOwogICAgfQoKICAgIHZhciBmaWVsZCA9IHJlYWRlci5nZXRGaWVsZE51bWJlcigpOwoKICAgIHN3aXRjaCAoZmllbGQpIHsKICAgICAgY2FzZSAxOgogICAgICAgIHZhciB2YWx1ZSA9IG5ldyB1c2VydHlwZV9wYi5WaW9sYXRpb25SZWNvcmQoKTsKICAgICAgICByZWFkZXIucmVhZE1lc3NhZ2UodmFsdWUsIHVzZXJ0eXBlX3BiLlZpb2xhdGlvblJlY29yZC5kZXNlcmlhbGl6ZUJpbmFyeUZyb21SZWFkZXIpOwogICAgICAgIG1zZy5hZGRSZWNvcmRzKHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgMjoKICAgICAgICB2YXIgdmFsdWUgPSByZWFkZXIucmVhZFVpbnQzMigpOwogICAgICAgIG1zZy5zZXRQYWdlTm8odmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSAzOgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkVWludDMyKCk7CiAgICAgICAgbXNnLnNldFBhZ2VTaXplKHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgNDoKICAgICAgICB2YXIgdmFsdWUgPSByZWFkZXIucmVhZFVpbnQzMigpOwogICAgICAgIG1zZy5zZXRUb3RhbFBhZ2UodmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSA1OgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkVWludDMyKCk7CiAgICAgICAgbXNnLnNldFRvdGFsQ291bnQodmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgZGVmYXVsdDoKICAgICAgICByZWFkZXIuc2tpcEZpZWxkKCk7CiAgICAgICAgYnJlYWs7CiAgICB9CiAgfQoKICByZXR1cm4gbXNnOwp9OwovKioKICogU2VyaWFsaXplcyB0aGUgbWVzc2FnZSB0byBiaW5hcnkgZGF0YSAoaW4gcHJvdG9idWYgd2lyZSBmb3JtYXQpLgogKiBAcmV0dXJuIHshVWludDhBcnJheX0KICovCgoKcHJvdG8ucGIuY21zLlZpb2xhdGlvbkxpc3RSZXBseS5wcm90b3R5cGUuc2VyaWFsaXplQmluYXJ5ID0gZnVuY3Rpb24gKCkgewogIHZhciB3cml0ZXIgPSBuZXcganNwYi5CaW5hcnlXcml0ZXIoKTsKICBwcm90by5wYi5jbXMuVmlvbGF0aW9uTGlzdFJlcGx5LnNlcmlhbGl6ZUJpbmFyeVRvV3JpdGVyKHRoaXMsIHdyaXRlcik7CiAgcmV0dXJuIHdyaXRlci5nZXRSZXN1bHRCdWZmZXIoKTsKfTsKLyoqCiAqIFNlcmlhbGl6ZXMgdGhlIGdpdmVuIG1lc3NhZ2UgdG8gYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUKICogZm9ybWF0KSwgd3JpdGluZyB0byB0aGUgZ2l2ZW4gQmluYXJ5V3JpdGVyLgogKiBAcGFyYW0geyFwcm90by5wYi5jbXMuVmlvbGF0aW9uTGlzdFJlcGx5fSBtZXNzYWdlCiAqIEBwYXJhbSB7IWpzcGIuQmluYXJ5V3JpdGVyfSB3cml0ZXIKICogQHN1cHByZXNzIHt1bnVzZWRMb2NhbFZhcmlhYmxlc30gZiBpcyBvbmx5IHVzZWQgZm9yIG5lc3RlZCBtZXNzYWdlcwogKi8KCgpwcm90by5wYi5jbXMuVmlvbGF0aW9uTGlzdFJlcGx5LnNlcmlhbGl6ZUJpbmFyeVRvV3JpdGVyID0gZnVuY3Rpb24gKG1lc3NhZ2UsIHdyaXRlcikgewogIHZhciBmID0gdW5kZWZpbmVkOwogIGYgPSBtZXNzYWdlLmdldFJlY29yZHNMaXN0KCk7CgogIGlmIChmLmxlbmd0aCA+IDApIHsKICAgIHdyaXRlci53cml0ZVJlcGVhdGVkTWVzc2FnZSgxLCBmLCB1c2VydHlwZV9wYi5WaW9sYXRpb25SZWNvcmQuc2VyaWFsaXplQmluYXJ5VG9Xcml0ZXIpOwogIH0KCiAgZiA9IG1lc3NhZ2UuZ2V0UGFnZU5vKCk7CgogIGlmIChmICE9PSAwKSB7CiAgICB3cml0ZXIud3JpdGVVaW50MzIoMiwgZik7CiAgfQoKICBmID0gbWVzc2FnZS5nZXRQYWdlU2l6ZSgpOwoKICBpZiAoZiAhPT0gMCkgewogICAgd3JpdGVyLndyaXRlVWludDMyKDMsIGYpOwogIH0KCiAgZiA9IG1lc3NhZ2UuZ2V0VG90YWxQYWdlKCk7CgogIGlmIChmICE9PSAwKSB7CiAgICB3cml0ZXIud3JpdGVVaW50MzIoNCwgZik7CiAgfQoKICBmID0gbWVzc2FnZS5nZXRUb3RhbENvdW50KCk7CgogIGlmIChmICE9PSAwKSB7CiAgICB3cml0ZXIud3JpdGVVaW50MzIoNSwgZik7CiAgfQp9OwovKioKICogcmVwZWF0ZWQgcGIuVmlvbGF0aW9uUmVjb3JkIHJlY29yZHMgPSAxOwogKiBAcmV0dXJuIHshQXJyYXk8IXByb3RvLnBiLlZpb2xhdGlvblJlY29yZD59CiAqLwoKCnByb3RvLnBiLmNtcy5WaW9sYXRpb25MaXN0UmVwbHkucHJvdG90eXBlLmdldFJlY29yZHNMaXN0ID0gZnVuY3Rpb24gKCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuZ2V0UmVwZWF0ZWRXcmFwcGVyRmllbGQodGhpcywgdXNlcnR5cGVfcGIuVmlvbGF0aW9uUmVjb3JkLCAxKTsKfTsKLyoqCiAqIEBwYXJhbSB7IUFycmF5PCFwcm90by5wYi5WaW9sYXRpb25SZWNvcmQ+fSB2YWx1ZQogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLlZpb2xhdGlvbkxpc3RSZXBseX0gcmV0dXJucyB0aGlzCiovCgoKcHJvdG8ucGIuY21zLlZpb2xhdGlvbkxpc3RSZXBseS5wcm90b3R5cGUuc2V0UmVjb3Jkc0xpc3QgPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFJlcGVhdGVkV3JhcHBlckZpZWxkKHRoaXMsIDEsIHZhbHVlKTsKfTsKLyoqCiAqIEBwYXJhbSB7IXByb3RvLnBiLlZpb2xhdGlvblJlY29yZD19IG9wdF92YWx1ZQogKiBAcGFyYW0ge251bWJlcj19IG9wdF9pbmRleAogKiBAcmV0dXJuIHshcHJvdG8ucGIuVmlvbGF0aW9uUmVjb3JkfQogKi8KCgpwcm90by5wYi5jbXMuVmlvbGF0aW9uTGlzdFJlcGx5LnByb3RvdHlwZS5hZGRSZWNvcmRzID0gZnVuY3Rpb24gKG9wdF92YWx1ZSwgb3B0X2luZGV4KSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5hZGRUb1JlcGVhdGVkV3JhcHBlckZpZWxkKHRoaXMsIDEsIG9wdF92YWx1ZSwgcHJvdG8ucGIuVmlvbGF0aW9uUmVjb3JkLCBvcHRfaW5kZXgpOwp9OwovKioKICogQ2xlYXJzIHRoZSBsaXN0IG1ha2luZyBpdCBlbXB0eSBidXQgbm9uLW51bGwuCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuVmlvbGF0aW9uTGlzdFJlcGx5fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLlZpb2xhdGlvbkxpc3RSZXBseS5wcm90b3R5cGUuY2xlYXJSZWNvcmRzTGlzdCA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4gdGhpcy5zZXRSZWNvcmRzTGlzdChbXSk7Cn07Ci8qKgogKiBvcHRpb25hbCB1aW50MzIgcGFnZV9ubyA9IDI7CiAqIEByZXR1cm4ge251bWJlcn0KICovCgoKcHJvdG8ucGIuY21zLlZpb2xhdGlvbkxpc3RSZXBseS5wcm90b3R5cGUuZ2V0UGFnZU5vID0gZnVuY3Rpb24gKCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdCh0aGlzLCAyLCAwKTsKfTsKLyoqCiAqIEBwYXJhbSB7bnVtYmVyfSB2YWx1ZQogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLlZpb2xhdGlvbkxpc3RSZXBseX0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5WaW9sYXRpb25MaXN0UmVwbHkucHJvdG90eXBlLnNldFBhZ2VObyA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UHJvdG8zSW50RmllbGQodGhpcywgMiwgdmFsdWUpOwp9OwovKioKICogb3B0aW9uYWwgdWludDMyIHBhZ2Vfc2l6ZSA9IDM7CiAqIEByZXR1cm4ge251bWJlcn0KICovCgoKcHJvdG8ucGIuY21zLlZpb2xhdGlvbkxpc3RSZXBseS5wcm90b3R5cGUuZ2V0UGFnZVNpemUgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDMsIDApOwp9OwovKioKICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuVmlvbGF0aW9uTGlzdFJlcGx5fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLlZpb2xhdGlvbkxpc3RSZXBseS5wcm90b3R5cGUuc2V0UGFnZVNpemUgPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0ludEZpZWxkKHRoaXMsIDMsIHZhbHVlKTsKfTsKLyoqCiAqIG9wdGlvbmFsIHVpbnQzMiB0b3RhbF9wYWdlID0gNDsKICogQHJldHVybiB7bnVtYmVyfQogKi8KCgpwcm90by5wYi5jbXMuVmlvbGF0aW9uTGlzdFJlcGx5LnByb3RvdHlwZS5nZXRUb3RhbFBhZ2UgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDQsIDApOwp9OwovKioKICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuVmlvbGF0aW9uTGlzdFJlcGx5fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLlZpb2xhdGlvbkxpc3RSZXBseS5wcm90b3R5cGUuc2V0VG90YWxQYWdlID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRQcm90bzNJbnRGaWVsZCh0aGlzLCA0LCB2YWx1ZSk7Cn07Ci8qKgogKiBvcHRpb25hbCB1aW50MzIgdG90YWxfY291bnQgPSA1OwogKiBAcmV0dXJuIHtudW1iZXJ9CiAqLwoKCnByb3RvLnBiLmNtcy5WaW9sYXRpb25MaXN0UmVwbHkucHJvdG90eXBlLmdldFRvdGFsQ291bnQgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDUsIDApOwp9OwovKioKICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuVmlvbGF0aW9uTGlzdFJlcGx5fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLlZpb2xhdGlvbkxpc3RSZXBseS5wcm90b3R5cGUuc2V0VG90YWxDb3VudCA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UHJvdG8zSW50RmllbGQodGhpcywgNSwgdmFsdWUpOwp9OwoKaWYgKGpzcGIuTWVzc2FnZS5HRU5FUkFURV9UT19PQkpFQ1QpIHsKICAvKioKICAgKiBDcmVhdGVzIGFuIG9iamVjdCByZXByZXNlbnRhdGlvbiBvZiB0aGlzIHByb3RvLgogICAqIEZpZWxkIG5hbWVzIHRoYXQgYXJlIHJlc2VydmVkIGluIEphdmFTY3JpcHQgYW5kIHdpbGwgYmUgcmVuYW1lZCB0byBwYl9uYW1lLgogICAqIE9wdGlvbmFsIGZpZWxkcyB0aGF0IGFyZSBub3Qgc2V0IHdpbGwgYmUgc2V0IHRvIHVuZGVmaW5lZC4KICAgKiBUbyBhY2Nlc3MgYSByZXNlcnZlZCBmaWVsZCB1c2UsIGZvby5wYl88bmFtZT4sIGVnLCBmb28ucGJfZGVmYXVsdC4KICAgKiBGb3IgdGhlIGxpc3Qgb2YgcmVzZXJ2ZWQgbmFtZXMgcGxlYXNlIHNlZToKICAgKiAgICAgbmV0L3Byb3RvMi9jb21waWxlci9qcy9pbnRlcm5hbC9nZW5lcmF0b3IuY2Mja0tleXdvcmQuCiAgICogQHBhcmFtIHtib29sZWFuPX0gb3B0X2luY2x1ZGVJbnN0YW5jZSBEZXByZWNhdGVkLiB3aGV0aGVyIHRvIGluY2x1ZGUgdGhlCiAgICogICAgIEpTUEIgaW5zdGFuY2UgZm9yIHRyYW5zaXRpb25hbCBzb3kgcHJvdG8gc3VwcG9ydDoKICAgKiAgICAgaHR0cDovL2dvdG8vc295LXBhcmFtLW1pZ3JhdGlvbgogICAqIEByZXR1cm4geyFPYmplY3R9CiAgICovCiAgcHJvdG8ucGIuY21zLlByb2Nlc3NWaW9sYXRpb25SZXF1ZXN0LnByb3RvdHlwZS50b09iamVjdCA9IGZ1bmN0aW9uIChvcHRfaW5jbHVkZUluc3RhbmNlKSB7CiAgICByZXR1cm4gcHJvdG8ucGIuY21zLlByb2Nlc3NWaW9sYXRpb25SZXF1ZXN0LnRvT2JqZWN0KG9wdF9pbmNsdWRlSW5zdGFuY2UsIHRoaXMpOwogIH07CiAgLyoqCiAgICogU3RhdGljIHZlcnNpb24gb2YgdGhlIHtAc2VlIHRvT2JqZWN0fSBtZXRob2QuCiAgICogQHBhcmFtIHtib29sZWFufHVuZGVmaW5lZH0gaW5jbHVkZUluc3RhbmNlIERlcHJlY2F0ZWQuIFdoZXRoZXIgdG8gaW5jbHVkZQogICAqICAgICB0aGUgSlNQQiBpbnN0YW5jZSBmb3IgdHJhbnNpdGlvbmFsIHNveSBwcm90byBzdXBwb3J0OgogICAqICAgICBodHRwOi8vZ290by9zb3ktcGFyYW0tbWlncmF0aW9uCiAgICogQHBhcmFtIHshcHJvdG8ucGIuY21zLlByb2Nlc3NWaW9sYXRpb25SZXF1ZXN0fSBtc2cgVGhlIG1zZyBpbnN0YW5jZSB0byB0cmFuc2Zvcm0uCiAgICogQHJldHVybiB7IU9iamVjdH0KICAgKiBAc3VwcHJlc3Mge3VudXNlZExvY2FsVmFyaWFibGVzfSBmIGlzIG9ubHkgdXNlZCBmb3IgbmVzdGVkIG1lc3NhZ2VzCiAgICovCgoKICBwcm90by5wYi5jbXMuUHJvY2Vzc1Zpb2xhdGlvblJlcXVlc3QudG9PYmplY3QgPSBmdW5jdGlvbiAoaW5jbHVkZUluc3RhbmNlLCBtc2cpIHsKICAgIHZhciBmLAogICAgICAgIG9iaiA9IHsKICAgICAgdmlvbGF0aW9uSWQ6IGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KG1zZywgMSwgMCksCiAgICAgIGRlYWxTdGF0dXM6IGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KG1zZywgMiwgMCksCiAgICAgIGRlYWxNZXNzYWdlOiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdChtc2csIDMsICIiKSwKICAgICAgYmxvY2tEdXJhdGlvbjoganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQobXNnLCA0LCAwKQogICAgfTsKCiAgICBpZiAoaW5jbHVkZUluc3RhbmNlKSB7CiAgICAgIG9iai4kanNwYk1lc3NhZ2VJbnN0YW5jZSA9IG1zZzsKICAgIH0KCiAgICByZXR1cm4gb2JqOwogIH07Cn0KLyoqCiAqIERlc2VyaWFsaXplcyBiaW5hcnkgZGF0YSAoaW4gcHJvdG9idWYgd2lyZSBmb3JtYXQpLgogKiBAcGFyYW0ge2pzcGIuQnl0ZVNvdXJjZX0gYnl0ZXMgVGhlIGJ5dGVzIHRvIGRlc2VyaWFsaXplLgogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLlByb2Nlc3NWaW9sYXRpb25SZXF1ZXN0fQogKi8KCgpwcm90by5wYi5jbXMuUHJvY2Vzc1Zpb2xhdGlvblJlcXVlc3QuZGVzZXJpYWxpemVCaW5hcnkgPSBmdW5jdGlvbiAoYnl0ZXMpIHsKICB2YXIgcmVhZGVyID0gbmV3IGpzcGIuQmluYXJ5UmVhZGVyKGJ5dGVzKTsKICB2YXIgbXNnID0gbmV3IHByb3RvLnBiLmNtcy5Qcm9jZXNzVmlvbGF0aW9uUmVxdWVzdCgpOwogIHJldHVybiBwcm90by5wYi5jbXMuUHJvY2Vzc1Zpb2xhdGlvblJlcXVlc3QuZGVzZXJpYWxpemVCaW5hcnlGcm9tUmVhZGVyKG1zZywgcmVhZGVyKTsKfTsKLyoqCiAqIERlc2VyaWFsaXplcyBiaW5hcnkgZGF0YSAoaW4gcHJvdG9idWYgd2lyZSBmb3JtYXQpIGZyb20gdGhlCiAqIGdpdmVuIHJlYWRlciBpbnRvIHRoZSBnaXZlbiBtZXNzYWdlIG9iamVjdC4KICogQHBhcmFtIHshcHJvdG8ucGIuY21zLlByb2Nlc3NWaW9sYXRpb25SZXF1ZXN0fSBtc2cgVGhlIG1lc3NhZ2Ugb2JqZWN0IHRvIGRlc2VyaWFsaXplIGludG8uCiAqIEBwYXJhbSB7IWpzcGIuQmluYXJ5UmVhZGVyfSByZWFkZXIgVGhlIEJpbmFyeVJlYWRlciB0byB1c2UuCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuUHJvY2Vzc1Zpb2xhdGlvblJlcXVlc3R9CiAqLwoKCnByb3RvLnBiLmNtcy5Qcm9jZXNzVmlvbGF0aW9uUmVxdWVzdC5kZXNlcmlhbGl6ZUJpbmFyeUZyb21SZWFkZXIgPSBmdW5jdGlvbiAobXNnLCByZWFkZXIpIHsKICB3aGlsZSAocmVhZGVyLm5leHRGaWVsZCgpKSB7CiAgICBpZiAocmVhZGVyLmlzRW5kR3JvdXAoKSkgewogICAgICBicmVhazsKICAgIH0KCiAgICB2YXIgZmllbGQgPSByZWFkZXIuZ2V0RmllbGROdW1iZXIoKTsKCiAgICBzd2l0Y2ggKGZpZWxkKSB7CiAgICAgIGNhc2UgMToKICAgICAgICB2YXIgdmFsdWUgPSByZWFkZXIucmVhZFVpbnQ2NCgpOwogICAgICAgIG1zZy5zZXRWaW9sYXRpb25JZCh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlIDI6CiAgICAgICAgdmFyIHZhbHVlID0gcmVhZGVyLnJlYWRFbnVtKCk7CiAgICAgICAgbXNnLnNldERlYWxTdGF0dXModmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSAzOgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkU3RyaW5nKCk7CiAgICAgICAgbXNnLnNldERlYWxNZXNzYWdlKHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgNDoKICAgICAgICB2YXIgdmFsdWUgPSByZWFkZXIucmVhZFVpbnQzMigpOwogICAgICAgIG1zZy5zZXRCbG9ja0R1cmF0aW9uKHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGRlZmF1bHQ6CiAgICAgICAgcmVhZGVyLnNraXBGaWVsZCgpOwogICAgICAgIGJyZWFrOwogICAgfQogIH0KCiAgcmV0dXJuIG1zZzsKfTsKLyoqCiAqIFNlcmlhbGl6ZXMgdGhlIG1lc3NhZ2UgdG8gYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUgZm9ybWF0KS4KICogQHJldHVybiB7IVVpbnQ4QXJyYXl9CiAqLwoKCnByb3RvLnBiLmNtcy5Qcm9jZXNzVmlvbGF0aW9uUmVxdWVzdC5wcm90b3R5cGUuc2VyaWFsaXplQmluYXJ5ID0gZnVuY3Rpb24gKCkgewogIHZhciB3cml0ZXIgPSBuZXcganNwYi5CaW5hcnlXcml0ZXIoKTsKICBwcm90by5wYi5jbXMuUHJvY2Vzc1Zpb2xhdGlvblJlcXVlc3Quc2VyaWFsaXplQmluYXJ5VG9Xcml0ZXIodGhpcywgd3JpdGVyKTsKICByZXR1cm4gd3JpdGVyLmdldFJlc3VsdEJ1ZmZlcigpOwp9OwovKioKICogU2VyaWFsaXplcyB0aGUgZ2l2ZW4gbWVzc2FnZSB0byBiaW5hcnkgZGF0YSAoaW4gcHJvdG9idWYgd2lyZQogKiBmb3JtYXQpLCB3cml0aW5nIHRvIHRoZSBnaXZlbiBCaW5hcnlXcml0ZXIuCiAqIEBwYXJhbSB7IXByb3RvLnBiLmNtcy5Qcm9jZXNzVmlvbGF0aW9uUmVxdWVzdH0gbWVzc2FnZQogKiBAcGFyYW0geyFqc3BiLkJpbmFyeVdyaXRlcn0gd3JpdGVyCiAqIEBzdXBwcmVzcyB7dW51c2VkTG9jYWxWYXJpYWJsZXN9IGYgaXMgb25seSB1c2VkIGZvciBuZXN0ZWQgbWVzc2FnZXMKICovCgoKcHJvdG8ucGIuY21zLlByb2Nlc3NWaW9sYXRpb25SZXF1ZXN0LnNlcmlhbGl6ZUJpbmFyeVRvV3JpdGVyID0gZnVuY3Rpb24gKG1lc3NhZ2UsIHdyaXRlcikgewogIHZhciBmID0gdW5kZWZpbmVkOwogIGYgPSBtZXNzYWdlLmdldFZpb2xhdGlvbklkKCk7CgogIGlmIChmICE9PSAwKSB7CiAgICB3cml0ZXIud3JpdGVVaW50NjQoMSwgZik7CiAgfQoKICBmID0gbWVzc2FnZS5nZXREZWFsU3RhdHVzKCk7CgogIGlmIChmICE9PSAwLjApIHsKICAgIHdyaXRlci53cml0ZUVudW0oMiwgZik7CiAgfQoKICBmID0gbWVzc2FnZS5nZXREZWFsTWVzc2FnZSgpOwoKICBpZiAoZi5sZW5ndGggPiAwKSB7CiAgICB3cml0ZXIud3JpdGVTdHJpbmcoMywgZik7CiAgfQoKICBmID0gbWVzc2FnZS5nZXRCbG9ja0R1cmF0aW9uKCk7CgogIGlmIChmICE9PSAwKSB7CiAgICB3cml0ZXIud3JpdGVVaW50MzIoNCwgZik7CiAgfQp9OwovKioKICogb3B0aW9uYWwgdWludDY0IHZpb2xhdGlvbl9pZCA9IDE7CiAqIEByZXR1cm4ge251bWJlcn0KICovCgoKcHJvdG8ucGIuY21zLlByb2Nlc3NWaW9sYXRpb25SZXF1ZXN0LnByb3RvdHlwZS5nZXRWaW9sYXRpb25JZCA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQodGhpcywgMSwgMCk7Cn07Ci8qKgogKiBAcGFyYW0ge251bWJlcn0gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5Qcm9jZXNzVmlvbGF0aW9uUmVxdWVzdH0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5Qcm9jZXNzVmlvbGF0aW9uUmVxdWVzdC5wcm90b3R5cGUuc2V0VmlvbGF0aW9uSWQgPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0ludEZpZWxkKHRoaXMsIDEsIHZhbHVlKTsKfTsKLyoqCiAqIG9wdGlvbmFsIHBiLkJsb2NrU3RhdHVzIGRlYWxfc3RhdHVzID0gMjsKICogQHJldHVybiB7IXByb3RvLnBiLkJsb2NrU3RhdHVzfQogKi8KCgpwcm90by5wYi5jbXMuUHJvY2Vzc1Zpb2xhdGlvblJlcXVlc3QucHJvdG90eXBlLmdldERlYWxTdGF0dXMgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDIsIDApOwp9OwovKioKICogQHBhcmFtIHshcHJvdG8ucGIuQmxvY2tTdGF0dXN9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuUHJvY2Vzc1Zpb2xhdGlvblJlcXVlc3R9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuUHJvY2Vzc1Zpb2xhdGlvblJlcXVlc3QucHJvdG90eXBlLnNldERlYWxTdGF0dXMgPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0VudW1GaWVsZCh0aGlzLCAyLCB2YWx1ZSk7Cn07Ci8qKgogKiBvcHRpb25hbCBzdHJpbmcgZGVhbF9tZXNzYWdlID0gMzsKICogQHJldHVybiB7c3RyaW5nfQogKi8KCgpwcm90by5wYi5jbXMuUHJvY2Vzc1Zpb2xhdGlvblJlcXVlc3QucHJvdG90eXBlLmdldERlYWxNZXNzYWdlID0gZnVuY3Rpb24gKCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdCh0aGlzLCAzLCAiIik7Cn07Ci8qKgogKiBAcGFyYW0ge3N0cmluZ30gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5Qcm9jZXNzVmlvbGF0aW9uUmVxdWVzdH0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5Qcm9jZXNzVmlvbGF0aW9uUmVxdWVzdC5wcm90b3R5cGUuc2V0RGVhbE1lc3NhZ2UgPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM1N0cmluZ0ZpZWxkKHRoaXMsIDMsIHZhbHVlKTsKfTsKLyoqCiAqIG9wdGlvbmFsIHVpbnQzMiBibG9ja19kdXJhdGlvbiA9IDQ7CiAqIEByZXR1cm4ge251bWJlcn0KICovCgoKcHJvdG8ucGIuY21zLlByb2Nlc3NWaW9sYXRpb25SZXF1ZXN0LnByb3RvdHlwZS5nZXRCbG9ja0R1cmF0aW9uID0gZnVuY3Rpb24gKCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdCh0aGlzLCA0LCAwKTsKfTsKLyoqCiAqIEBwYXJhbSB7bnVtYmVyfSB2YWx1ZQogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLlByb2Nlc3NWaW9sYXRpb25SZXF1ZXN0fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLlByb2Nlc3NWaW9sYXRpb25SZXF1ZXN0LnByb3RvdHlwZS5zZXRCbG9ja0R1cmF0aW9uID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRQcm90bzNJbnRGaWVsZCh0aGlzLCA0LCB2YWx1ZSk7Cn07CgppZiAoanNwYi5NZXNzYWdlLkdFTkVSQVRFX1RPX09CSkVDVCkgewogIC8qKgogICAqIENyZWF0ZXMgYW4gb2JqZWN0IHJlcHJlc2VudGF0aW9uIG9mIHRoaXMgcHJvdG8uCiAgICogRmllbGQgbmFtZXMgdGhhdCBhcmUgcmVzZXJ2ZWQgaW4gSmF2YVNjcmlwdCBhbmQgd2lsbCBiZSByZW5hbWVkIHRvIHBiX25hbWUuCiAgICogT3B0aW9uYWwgZmllbGRzIHRoYXQgYXJlIG5vdCBzZXQgd2lsbCBiZSBzZXQgdG8gdW5kZWZpbmVkLgogICAqIFRvIGFjY2VzcyBhIHJlc2VydmVkIGZpZWxkIHVzZSwgZm9vLnBiXzxuYW1lPiwgZWcsIGZvby5wYl9kZWZhdWx0LgogICAqIEZvciB0aGUgbGlzdCBvZiByZXNlcnZlZCBuYW1lcyBwbGVhc2Ugc2VlOgogICAqICAgICBuZXQvcHJvdG8yL2NvbXBpbGVyL2pzL2ludGVybmFsL2dlbmVyYXRvci5jYyNrS2V5d29yZC4KICAgKiBAcGFyYW0ge2Jvb2xlYW49fSBvcHRfaW5jbHVkZUluc3RhbmNlIERlcHJlY2F0ZWQuIHdoZXRoZXIgdG8gaW5jbHVkZSB0aGUKICAgKiAgICAgSlNQQiBpbnN0YW5jZSBmb3IgdHJhbnNpdGlvbmFsIHNveSBwcm90byBzdXBwb3J0OgogICAqICAgICBodHRwOi8vZ290by9zb3ktcGFyYW0tbWlncmF0aW9uCiAgICogQHJldHVybiB7IU9iamVjdH0KICAgKi8KICBwcm90by5wYi5jbXMuTGl2ZUxpc3RSZXF1ZXN0LnByb3RvdHlwZS50b09iamVjdCA9IGZ1bmN0aW9uIChvcHRfaW5jbHVkZUluc3RhbmNlKSB7CiAgICByZXR1cm4gcHJvdG8ucGIuY21zLkxpdmVMaXN0UmVxdWVzdC50b09iamVjdChvcHRfaW5jbHVkZUluc3RhbmNlLCB0aGlzKTsKICB9OwogIC8qKgogICAqIFN0YXRpYyB2ZXJzaW9uIG9mIHRoZSB7QHNlZSB0b09iamVjdH0gbWV0aG9kLgogICAqIEBwYXJhbSB7Ym9vbGVhbnx1bmRlZmluZWR9IGluY2x1ZGVJbnN0YW5jZSBEZXByZWNhdGVkLiBXaGV0aGVyIHRvIGluY2x1ZGUKICAgKiAgICAgdGhlIEpTUEIgaW5zdGFuY2UgZm9yIHRyYW5zaXRpb25hbCBzb3kgcHJvdG8gc3VwcG9ydDoKICAgKiAgICAgaHR0cDovL2dvdG8vc295LXBhcmFtLW1pZ3JhdGlvbgogICAqIEBwYXJhbSB7IXByb3RvLnBiLmNtcy5MaXZlTGlzdFJlcXVlc3R9IG1zZyBUaGUgbXNnIGluc3RhbmNlIHRvIHRyYW5zZm9ybS4KICAgKiBAcmV0dXJuIHshT2JqZWN0fQogICAqIEBzdXBwcmVzcyB7dW51c2VkTG9jYWxWYXJpYWJsZXN9IGYgaXMgb25seSB1c2VkIGZvciBuZXN0ZWQgbWVzc2FnZXMKICAgKi8KCgogIHByb3RvLnBiLmNtcy5MaXZlTGlzdFJlcXVlc3QudG9PYmplY3QgPSBmdW5jdGlvbiAoaW5jbHVkZUluc3RhbmNlLCBtc2cpIHsKICAgIHZhciBmLAogICAgICAgIG9iaiA9IHsKICAgICAgcGFnZU5vOiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdChtc2csIDEsIDApLAogICAgICBwYWdlU2l6ZToganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQobXNnLCAyLCAwKSwKICAgICAgYXJlYUlkOiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdChtc2csIDMsIDApLAogICAgICBhbmNob3JJZDoganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQobXNnLCA0LCAwKSwKICAgICAgc3RhdHVzOiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdChtc2csIDUsIDApLAogICAgICBjcmVhdGVkU3RhcnQ6IGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KG1zZywgNiwgMCksCiAgICAgIGNyZWF0ZWRFbmQ6IGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KG1zZywgNywgMCkKICAgIH07CgogICAgaWYgKGluY2x1ZGVJbnN0YW5jZSkgewogICAgICBvYmouJGpzcGJNZXNzYWdlSW5zdGFuY2UgPSBtc2c7CiAgICB9CgogICAgcmV0dXJuIG9iajsKICB9Owp9Ci8qKgogKiBEZXNlcmlhbGl6ZXMgYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUgZm9ybWF0KS4KICogQHBhcmFtIHtqc3BiLkJ5dGVTb3VyY2V9IGJ5dGVzIFRoZSBieXRlcyB0byBkZXNlcmlhbGl6ZS4KICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5MaXZlTGlzdFJlcXVlc3R9CiAqLwoKCnByb3RvLnBiLmNtcy5MaXZlTGlzdFJlcXVlc3QuZGVzZXJpYWxpemVCaW5hcnkgPSBmdW5jdGlvbiAoYnl0ZXMpIHsKICB2YXIgcmVhZGVyID0gbmV3IGpzcGIuQmluYXJ5UmVhZGVyKGJ5dGVzKTsKICB2YXIgbXNnID0gbmV3IHByb3RvLnBiLmNtcy5MaXZlTGlzdFJlcXVlc3QoKTsKICByZXR1cm4gcHJvdG8ucGIuY21zLkxpdmVMaXN0UmVxdWVzdC5kZXNlcmlhbGl6ZUJpbmFyeUZyb21SZWFkZXIobXNnLCByZWFkZXIpOwp9OwovKioKICogRGVzZXJpYWxpemVzIGJpbmFyeSBkYXRhIChpbiBwcm90b2J1ZiB3aXJlIGZvcm1hdCkgZnJvbSB0aGUKICogZ2l2ZW4gcmVhZGVyIGludG8gdGhlIGdpdmVuIG1lc3NhZ2Ugb2JqZWN0LgogKiBAcGFyYW0geyFwcm90by5wYi5jbXMuTGl2ZUxpc3RSZXF1ZXN0fSBtc2cgVGhlIG1lc3NhZ2Ugb2JqZWN0IHRvIGRlc2VyaWFsaXplIGludG8uCiAqIEBwYXJhbSB7IWpzcGIuQmluYXJ5UmVhZGVyfSByZWFkZXIgVGhlIEJpbmFyeVJlYWRlciB0byB1c2UuCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuTGl2ZUxpc3RSZXF1ZXN0fQogKi8KCgpwcm90by5wYi5jbXMuTGl2ZUxpc3RSZXF1ZXN0LmRlc2VyaWFsaXplQmluYXJ5RnJvbVJlYWRlciA9IGZ1bmN0aW9uIChtc2csIHJlYWRlcikgewogIHdoaWxlIChyZWFkZXIubmV4dEZpZWxkKCkpIHsKICAgIGlmIChyZWFkZXIuaXNFbmRHcm91cCgpKSB7CiAgICAgIGJyZWFrOwogICAgfQoKICAgIHZhciBmaWVsZCA9IHJlYWRlci5nZXRGaWVsZE51bWJlcigpOwoKICAgIHN3aXRjaCAoZmllbGQpIHsKICAgICAgY2FzZSAxOgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkVWludDMyKCk7CiAgICAgICAgbXNnLnNldFBhZ2VObyh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlIDI6CiAgICAgICAgdmFyIHZhbHVlID0gcmVhZGVyLnJlYWRVaW50MzIoKTsKICAgICAgICBtc2cuc2V0UGFnZVNpemUodmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSAzOgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkVWludDMyKCk7CiAgICAgICAgbXNnLnNldEFyZWFJZCh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlIDQ6CiAgICAgICAgdmFyIHZhbHVlID0gcmVhZGVyLnJlYWRVaW50MzIoKTsKICAgICAgICBtc2cuc2V0QW5jaG9ySWQodmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSA1OgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkRW51bSgpOwogICAgICAgIG1zZy5zZXRTdGF0dXModmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSA2OgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkVWludDMyKCk7CiAgICAgICAgbXNnLnNldENyZWF0ZWRTdGFydCh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlIDc6CiAgICAgICAgdmFyIHZhbHVlID0gcmVhZGVyLnJlYWRVaW50MzIoKTsKICAgICAgICBtc2cuc2V0Q3JlYXRlZEVuZCh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBkZWZhdWx0OgogICAgICAgIHJlYWRlci5za2lwRmllbGQoKTsKICAgICAgICBicmVhazsKICAgIH0KICB9CgogIHJldHVybiBtc2c7Cn07Ci8qKgogKiBTZXJpYWxpemVzIHRoZSBtZXNzYWdlIHRvIGJpbmFyeSBkYXRhIChpbiBwcm90b2J1ZiB3aXJlIGZvcm1hdCkuCiAqIEByZXR1cm4geyFVaW50OEFycmF5fQogKi8KCgpwcm90by5wYi5jbXMuTGl2ZUxpc3RSZXF1ZXN0LnByb3RvdHlwZS5zZXJpYWxpemVCaW5hcnkgPSBmdW5jdGlvbiAoKSB7CiAgdmFyIHdyaXRlciA9IG5ldyBqc3BiLkJpbmFyeVdyaXRlcigpOwogIHByb3RvLnBiLmNtcy5MaXZlTGlzdFJlcXVlc3Quc2VyaWFsaXplQmluYXJ5VG9Xcml0ZXIodGhpcywgd3JpdGVyKTsKICByZXR1cm4gd3JpdGVyLmdldFJlc3VsdEJ1ZmZlcigpOwp9OwovKioKICogU2VyaWFsaXplcyB0aGUgZ2l2ZW4gbWVzc2FnZSB0byBiaW5hcnkgZGF0YSAoaW4gcHJvdG9idWYgd2lyZQogKiBmb3JtYXQpLCB3cml0aW5nIHRvIHRoZSBnaXZlbiBCaW5hcnlXcml0ZXIuCiAqIEBwYXJhbSB7IXByb3RvLnBiLmNtcy5MaXZlTGlzdFJlcXVlc3R9IG1lc3NhZ2UKICogQHBhcmFtIHshanNwYi5CaW5hcnlXcml0ZXJ9IHdyaXRlcgogKiBAc3VwcHJlc3Mge3VudXNlZExvY2FsVmFyaWFibGVzfSBmIGlzIG9ubHkgdXNlZCBmb3IgbmVzdGVkIG1lc3NhZ2VzCiAqLwoKCnByb3RvLnBiLmNtcy5MaXZlTGlzdFJlcXVlc3Quc2VyaWFsaXplQmluYXJ5VG9Xcml0ZXIgPSBmdW5jdGlvbiAobWVzc2FnZSwgd3JpdGVyKSB7CiAgdmFyIGYgPSB1bmRlZmluZWQ7CiAgZiA9IG1lc3NhZ2UuZ2V0UGFnZU5vKCk7CgogIGlmIChmICE9PSAwKSB7CiAgICB3cml0ZXIud3JpdGVVaW50MzIoMSwgZik7CiAgfQoKICBmID0gbWVzc2FnZS5nZXRQYWdlU2l6ZSgpOwoKICBpZiAoZiAhPT0gMCkgewogICAgd3JpdGVyLndyaXRlVWludDMyKDIsIGYpOwogIH0KCiAgZiA9IG1lc3NhZ2UuZ2V0QXJlYUlkKCk7CgogIGlmIChmICE9PSAwKSB7CiAgICB3cml0ZXIud3JpdGVVaW50MzIoMywgZik7CiAgfQoKICBmID0gbWVzc2FnZS5nZXRBbmNob3JJZCgpOwoKICBpZiAoZiAhPT0gMCkgewogICAgd3JpdGVyLndyaXRlVWludDMyKDQsIGYpOwogIH0KCiAgZiA9IG1lc3NhZ2UuZ2V0U3RhdHVzKCk7CgogIGlmIChmICE9PSAwLjApIHsKICAgIHdyaXRlci53cml0ZUVudW0oNSwgZik7CiAgfQoKICBmID0gbWVzc2FnZS5nZXRDcmVhdGVkU3RhcnQoKTsKCiAgaWYgKGYgIT09IDApIHsKICAgIHdyaXRlci53cml0ZVVpbnQzMig2LCBmKTsKICB9CgogIGYgPSBtZXNzYWdlLmdldENyZWF0ZWRFbmQoKTsKCiAgaWYgKGYgIT09IDApIHsKICAgIHdyaXRlci53cml0ZVVpbnQzMig3LCBmKTsKICB9Cn07Ci8qKgogKiBvcHRpb25hbCB1aW50MzIgcGFnZV9ubyA9IDE7CiAqIEByZXR1cm4ge251bWJlcn0KICovCgoKcHJvdG8ucGIuY21zLkxpdmVMaXN0UmVxdWVzdC5wcm90b3R5cGUuZ2V0UGFnZU5vID0gZnVuY3Rpb24gKCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdCh0aGlzLCAxLCAwKTsKfTsKLyoqCiAqIEBwYXJhbSB7bnVtYmVyfSB2YWx1ZQogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLkxpdmVMaXN0UmVxdWVzdH0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5MaXZlTGlzdFJlcXVlc3QucHJvdG90eXBlLnNldFBhZ2VObyA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UHJvdG8zSW50RmllbGQodGhpcywgMSwgdmFsdWUpOwp9OwovKioKICogb3B0aW9uYWwgdWludDMyIHBhZ2Vfc2l6ZSA9IDI7CiAqIEByZXR1cm4ge251bWJlcn0KICovCgoKcHJvdG8ucGIuY21zLkxpdmVMaXN0UmVxdWVzdC5wcm90b3R5cGUuZ2V0UGFnZVNpemUgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDIsIDApOwp9OwovKioKICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuTGl2ZUxpc3RSZXF1ZXN0fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLkxpdmVMaXN0UmVxdWVzdC5wcm90b3R5cGUuc2V0UGFnZVNpemUgPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0ludEZpZWxkKHRoaXMsIDIsIHZhbHVlKTsKfTsKLyoqCiAqIG9wdGlvbmFsIHVpbnQzMiBhcmVhX2lkID0gMzsKICogQHJldHVybiB7bnVtYmVyfQogKi8KCgpwcm90by5wYi5jbXMuTGl2ZUxpc3RSZXF1ZXN0LnByb3RvdHlwZS5nZXRBcmVhSWQgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDMsIDApOwp9OwovKioKICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuTGl2ZUxpc3RSZXF1ZXN0fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLkxpdmVMaXN0UmVxdWVzdC5wcm90b3R5cGUuc2V0QXJlYUlkID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRQcm90bzNJbnRGaWVsZCh0aGlzLCAzLCB2YWx1ZSk7Cn07Ci8qKgogKiBvcHRpb25hbCB1aW50MzIgYW5jaG9yX2lkID0gNDsKICogQHJldHVybiB7bnVtYmVyfQogKi8KCgpwcm90by5wYi5jbXMuTGl2ZUxpc3RSZXF1ZXN0LnByb3RvdHlwZS5nZXRBbmNob3JJZCA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQodGhpcywgNCwgMCk7Cn07Ci8qKgogKiBAcGFyYW0ge251bWJlcn0gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5MaXZlTGlzdFJlcXVlc3R9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuTGl2ZUxpc3RSZXF1ZXN0LnByb3RvdHlwZS5zZXRBbmNob3JJZCA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UHJvdG8zSW50RmllbGQodGhpcywgNCwgdmFsdWUpOwp9OwovKioKICogb3B0aW9uYWwgcGIuUmV2aWV3U3RhdHVzIHN0YXR1cyA9IDU7CiAqIEByZXR1cm4geyFwcm90by5wYi5SZXZpZXdTdGF0dXN9CiAqLwoKCnByb3RvLnBiLmNtcy5MaXZlTGlzdFJlcXVlc3QucHJvdG90eXBlLmdldFN0YXR1cyA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQodGhpcywgNSwgMCk7Cn07Ci8qKgogKiBAcGFyYW0geyFwcm90by5wYi5SZXZpZXdTdGF0dXN9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuTGl2ZUxpc3RSZXF1ZXN0fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLkxpdmVMaXN0UmVxdWVzdC5wcm90b3R5cGUuc2V0U3RhdHVzID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRQcm90bzNFbnVtRmllbGQodGhpcywgNSwgdmFsdWUpOwp9OwovKioKICogb3B0aW9uYWwgdWludDMyIGNyZWF0ZWRfc3RhcnQgPSA2OwogKiBAcmV0dXJuIHtudW1iZXJ9CiAqLwoKCnByb3RvLnBiLmNtcy5MaXZlTGlzdFJlcXVlc3QucHJvdG90eXBlLmdldENyZWF0ZWRTdGFydCA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQodGhpcywgNiwgMCk7Cn07Ci8qKgogKiBAcGFyYW0ge251bWJlcn0gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5MaXZlTGlzdFJlcXVlc3R9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuTGl2ZUxpc3RSZXF1ZXN0LnByb3RvdHlwZS5zZXRDcmVhdGVkU3RhcnQgPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0ludEZpZWxkKHRoaXMsIDYsIHZhbHVlKTsKfTsKLyoqCiAqIG9wdGlvbmFsIHVpbnQzMiBjcmVhdGVkX2VuZCA9IDc7CiAqIEByZXR1cm4ge251bWJlcn0KICovCgoKcHJvdG8ucGIuY21zLkxpdmVMaXN0UmVxdWVzdC5wcm90b3R5cGUuZ2V0Q3JlYXRlZEVuZCA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQodGhpcywgNywgMCk7Cn07Ci8qKgogKiBAcGFyYW0ge251bWJlcn0gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5MaXZlTGlzdFJlcXVlc3R9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuTGl2ZUxpc3RSZXF1ZXN0LnByb3RvdHlwZS5zZXRDcmVhdGVkRW5kID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRQcm90bzNJbnRGaWVsZCh0aGlzLCA3LCB2YWx1ZSk7Cn07Ci8qKgogKiBMaXN0IG9mIHJlcGVhdGVkIGZpZWxkcyB3aXRoaW4gdGhpcyBtZXNzYWdlIHR5cGUuCiAqIEBwcml2YXRlIHshQXJyYXk8bnVtYmVyPn0KICogQGNvbnN0CiAqLwoKCnByb3RvLnBiLmNtcy5MaXZlTGlzdFJlcGx5LnJlcGVhdGVkRmllbGRzXyA9IFsxXTsKCmlmIChqc3BiLk1lc3NhZ2UuR0VORVJBVEVfVE9fT0JKRUNUKSB7CiAgLyoqCiAgICogQ3JlYXRlcyBhbiBvYmplY3QgcmVwcmVzZW50YXRpb24gb2YgdGhpcyBwcm90by4KICAgKiBGaWVsZCBuYW1lcyB0aGF0IGFyZSByZXNlcnZlZCBpbiBKYXZhU2NyaXB0IGFuZCB3aWxsIGJlIHJlbmFtZWQgdG8gcGJfbmFtZS4KICAgKiBPcHRpb25hbCBmaWVsZHMgdGhhdCBhcmUgbm90IHNldCB3aWxsIGJlIHNldCB0byB1bmRlZmluZWQuCiAgICogVG8gYWNjZXNzIGEgcmVzZXJ2ZWQgZmllbGQgdXNlLCBmb28ucGJfPG5hbWU+LCBlZywgZm9vLnBiX2RlZmF1bHQuCiAgICogRm9yIHRoZSBsaXN0IG9mIHJlc2VydmVkIG5hbWVzIHBsZWFzZSBzZWU6CiAgICogICAgIG5ldC9wcm90bzIvY29tcGlsZXIvanMvaW50ZXJuYWwvZ2VuZXJhdG9yLmNjI2tLZXl3b3JkLgogICAqIEBwYXJhbSB7Ym9vbGVhbj19IG9wdF9pbmNsdWRlSW5zdGFuY2UgRGVwcmVjYXRlZC4gd2hldGhlciB0byBpbmNsdWRlIHRoZQogICAqICAgICBKU1BCIGluc3RhbmNlIGZvciB0cmFuc2l0aW9uYWwgc295IHByb3RvIHN1cHBvcnQ6CiAgICogICAgIGh0dHA6Ly9nb3RvL3NveS1wYXJhbS1taWdyYXRpb24KICAgKiBAcmV0dXJuIHshT2JqZWN0fQogICAqLwogIHByb3RvLnBiLmNtcy5MaXZlTGlzdFJlcGx5LnByb3RvdHlwZS50b09iamVjdCA9IGZ1bmN0aW9uIChvcHRfaW5jbHVkZUluc3RhbmNlKSB7CiAgICByZXR1cm4gcHJvdG8ucGIuY21zLkxpdmVMaXN0UmVwbHkudG9PYmplY3Qob3B0X2luY2x1ZGVJbnN0YW5jZSwgdGhpcyk7CiAgfTsKICAvKioKICAgKiBTdGF0aWMgdmVyc2lvbiBvZiB0aGUge0BzZWUgdG9PYmplY3R9IG1ldGhvZC4KICAgKiBAcGFyYW0ge2Jvb2xlYW58dW5kZWZpbmVkfSBpbmNsdWRlSW5zdGFuY2UgRGVwcmVjYXRlZC4gV2hldGhlciB0byBpbmNsdWRlCiAgICogICAgIHRoZSBKU1BCIGluc3RhbmNlIGZvciB0cmFuc2l0aW9uYWwgc295IHByb3RvIHN1cHBvcnQ6CiAgICogICAgIGh0dHA6Ly9nb3RvL3NveS1wYXJhbS1taWdyYXRpb24KICAgKiBAcGFyYW0geyFwcm90by5wYi5jbXMuTGl2ZUxpc3RSZXBseX0gbXNnIFRoZSBtc2cgaW5zdGFuY2UgdG8gdHJhbnNmb3JtLgogICAqIEByZXR1cm4geyFPYmplY3R9CiAgICogQHN1cHByZXNzIHt1bnVzZWRMb2NhbFZhcmlhYmxlc30gZiBpcyBvbmx5IHVzZWQgZm9yIG5lc3RlZCBtZXNzYWdlcwogICAqLwoKCiAgcHJvdG8ucGIuY21zLkxpdmVMaXN0UmVwbHkudG9PYmplY3QgPSBmdW5jdGlvbiAoaW5jbHVkZUluc3RhbmNlLCBtc2cpIHsKICAgIHZhciBmLAogICAgICAgIG9iaiA9IHsKICAgICAgcmVjb3Jkc0xpc3Q6IGpzcGIuTWVzc2FnZS50b09iamVjdExpc3QobXNnLmdldFJlY29yZHNMaXN0KCksIHVzZXJ0eXBlX3BiLkZpbGVSZWNvcmQudG9PYmplY3QsIGluY2x1ZGVJbnN0YW5jZSksCiAgICAgIHBhZ2VObzoganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQobXNnLCAyLCAwKSwKICAgICAgcGFnZVNpemU6IGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KG1zZywgMywgMCksCiAgICAgIHRvdGFsUGFnZToganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQobXNnLCA0LCAwKSwKICAgICAgdG90YWxDb3VudDoganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQobXNnLCA1LCAwKQogICAgfTsKCiAgICBpZiAoaW5jbHVkZUluc3RhbmNlKSB7CiAgICAgIG9iai4kanNwYk1lc3NhZ2VJbnN0YW5jZSA9IG1zZzsKICAgIH0KCiAgICByZXR1cm4gb2JqOwogIH07Cn0KLyoqCiAqIERlc2VyaWFsaXplcyBiaW5hcnkgZGF0YSAoaW4gcHJvdG9idWYgd2lyZSBmb3JtYXQpLgogKiBAcGFyYW0ge2pzcGIuQnl0ZVNvdXJjZX0gYnl0ZXMgVGhlIGJ5dGVzIHRvIGRlc2VyaWFsaXplLgogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLkxpdmVMaXN0UmVwbHl9CiAqLwoKCnByb3RvLnBiLmNtcy5MaXZlTGlzdFJlcGx5LmRlc2VyaWFsaXplQmluYXJ5ID0gZnVuY3Rpb24gKGJ5dGVzKSB7CiAgdmFyIHJlYWRlciA9IG5ldyBqc3BiLkJpbmFyeVJlYWRlcihieXRlcyk7CiAgdmFyIG1zZyA9IG5ldyBwcm90by5wYi5jbXMuTGl2ZUxpc3RSZXBseSgpOwogIHJldHVybiBwcm90by5wYi5jbXMuTGl2ZUxpc3RSZXBseS5kZXNlcmlhbGl6ZUJpbmFyeUZyb21SZWFkZXIobXNnLCByZWFkZXIpOwp9OwovKioKICogRGVzZXJpYWxpemVzIGJpbmFyeSBkYXRhIChpbiBwcm90b2J1ZiB3aXJlIGZvcm1hdCkgZnJvbSB0aGUKICogZ2l2ZW4gcmVhZGVyIGludG8gdGhlIGdpdmVuIG1lc3NhZ2Ugb2JqZWN0LgogKiBAcGFyYW0geyFwcm90by5wYi5jbXMuTGl2ZUxpc3RSZXBseX0gbXNnIFRoZSBtZXNzYWdlIG9iamVjdCB0byBkZXNlcmlhbGl6ZSBpbnRvLgogKiBAcGFyYW0geyFqc3BiLkJpbmFyeVJlYWRlcn0gcmVhZGVyIFRoZSBCaW5hcnlSZWFkZXIgdG8gdXNlLgogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLkxpdmVMaXN0UmVwbHl9CiAqLwoKCnByb3RvLnBiLmNtcy5MaXZlTGlzdFJlcGx5LmRlc2VyaWFsaXplQmluYXJ5RnJvbVJlYWRlciA9IGZ1bmN0aW9uIChtc2csIHJlYWRlcikgewogIHdoaWxlIChyZWFkZXIubmV4dEZpZWxkKCkpIHsKICAgIGlmIChyZWFkZXIuaXNFbmRHcm91cCgpKSB7CiAgICAgIGJyZWFrOwogICAgfQoKICAgIHZhciBmaWVsZCA9IHJlYWRlci5nZXRGaWVsZE51bWJlcigpOwoKICAgIHN3aXRjaCAoZmllbGQpIHsKICAgICAgY2FzZSAxOgogICAgICAgIHZhciB2YWx1ZSA9IG5ldyB1c2VydHlwZV9wYi5GaWxlUmVjb3JkKCk7CiAgICAgICAgcmVhZGVyLnJlYWRNZXNzYWdlKHZhbHVlLCB1c2VydHlwZV9wYi5GaWxlUmVjb3JkLmRlc2VyaWFsaXplQmluYXJ5RnJvbVJlYWRlcik7CiAgICAgICAgbXNnLmFkZFJlY29yZHModmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSAyOgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkVWludDMyKCk7CiAgICAgICAgbXNnLnNldFBhZ2VObyh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlIDM6CiAgICAgICAgdmFyIHZhbHVlID0gcmVhZGVyLnJlYWRVaW50MzIoKTsKICAgICAgICBtc2cuc2V0UGFnZVNpemUodmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSA0OgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkVWludDMyKCk7CiAgICAgICAgbXNnLnNldFRvdGFsUGFnZSh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlIDU6CiAgICAgICAgdmFyIHZhbHVlID0gcmVhZGVyLnJlYWRVaW50MzIoKTsKICAgICAgICBtc2cuc2V0VG90YWxDb3VudCh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBkZWZhdWx0OgogICAgICAgIHJlYWRlci5za2lwRmllbGQoKTsKICAgICAgICBicmVhazsKICAgIH0KICB9CgogIHJldHVybiBtc2c7Cn07Ci8qKgogKiBTZXJpYWxpemVzIHRoZSBtZXNzYWdlIHRvIGJpbmFyeSBkYXRhIChpbiBwcm90b2J1ZiB3aXJlIGZvcm1hdCkuCiAqIEByZXR1cm4geyFVaW50OEFycmF5fQogKi8KCgpwcm90by5wYi5jbXMuTGl2ZUxpc3RSZXBseS5wcm90b3R5cGUuc2VyaWFsaXplQmluYXJ5ID0gZnVuY3Rpb24gKCkgewogIHZhciB3cml0ZXIgPSBuZXcganNwYi5CaW5hcnlXcml0ZXIoKTsKICBwcm90by5wYi5jbXMuTGl2ZUxpc3RSZXBseS5zZXJpYWxpemVCaW5hcnlUb1dyaXRlcih0aGlzLCB3cml0ZXIpOwogIHJldHVybiB3cml0ZXIuZ2V0UmVzdWx0QnVmZmVyKCk7Cn07Ci8qKgogKiBTZXJpYWxpemVzIHRoZSBnaXZlbiBtZXNzYWdlIHRvIGJpbmFyeSBkYXRhIChpbiBwcm90b2J1ZiB3aXJlCiAqIGZvcm1hdCksIHdyaXRpbmcgdG8gdGhlIGdpdmVuIEJpbmFyeVdyaXRlci4KICogQHBhcmFtIHshcHJvdG8ucGIuY21zLkxpdmVMaXN0UmVwbHl9IG1lc3NhZ2UKICogQHBhcmFtIHshanNwYi5CaW5hcnlXcml0ZXJ9IHdyaXRlcgogKiBAc3VwcHJlc3Mge3VudXNlZExvY2FsVmFyaWFibGVzfSBmIGlzIG9ubHkgdXNlZCBmb3IgbmVzdGVkIG1lc3NhZ2VzCiAqLwoKCnByb3RvLnBiLmNtcy5MaXZlTGlzdFJlcGx5LnNlcmlhbGl6ZUJpbmFyeVRvV3JpdGVyID0gZnVuY3Rpb24gKG1lc3NhZ2UsIHdyaXRlcikgewogIHZhciBmID0gdW5kZWZpbmVkOwogIGYgPSBtZXNzYWdlLmdldFJlY29yZHNMaXN0KCk7CgogIGlmIChmLmxlbmd0aCA+IDApIHsKICAgIHdyaXRlci53cml0ZVJlcGVhdGVkTWVzc2FnZSgxLCBmLCB1c2VydHlwZV9wYi5GaWxlUmVjb3JkLnNlcmlhbGl6ZUJpbmFyeVRvV3JpdGVyKTsKICB9CgogIGYgPSBtZXNzYWdlLmdldFBhZ2VObygpOwoKICBpZiAoZiAhPT0gMCkgewogICAgd3JpdGVyLndyaXRlVWludDMyKDIsIGYpOwogIH0KCiAgZiA9IG1lc3NhZ2UuZ2V0UGFnZVNpemUoKTsKCiAgaWYgKGYgIT09IDApIHsKICAgIHdyaXRlci53cml0ZVVpbnQzMigzLCBmKTsKICB9CgogIGYgPSBtZXNzYWdlLmdldFRvdGFsUGFnZSgpOwoKICBpZiAoZiAhPT0gMCkgewogICAgd3JpdGVyLndyaXRlVWludDMyKDQsIGYpOwogIH0KCiAgZiA9IG1lc3NhZ2UuZ2V0VG90YWxDb3VudCgpOwoKICBpZiAoZiAhPT0gMCkgewogICAgd3JpdGVyLndyaXRlVWludDMyKDUsIGYpOwogIH0KfTsKLyoqCiAqIHJlcGVhdGVkIHBiLkZpbGVSZWNvcmQgcmVjb3JkcyA9IDE7CiAqIEByZXR1cm4geyFBcnJheTwhcHJvdG8ucGIuRmlsZVJlY29yZD59CiAqLwoKCnByb3RvLnBiLmNtcy5MaXZlTGlzdFJlcGx5LnByb3RvdHlwZS5nZXRSZWNvcmRzTGlzdCA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldFJlcGVhdGVkV3JhcHBlckZpZWxkKHRoaXMsIHVzZXJ0eXBlX3BiLkZpbGVSZWNvcmQsIDEpOwp9OwovKioKICogQHBhcmFtIHshQXJyYXk8IXByb3RvLnBiLkZpbGVSZWNvcmQ+fSB2YWx1ZQogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLkxpdmVMaXN0UmVwbHl9IHJldHVybnMgdGhpcwoqLwoKCnByb3RvLnBiLmNtcy5MaXZlTGlzdFJlcGx5LnByb3RvdHlwZS5zZXRSZWNvcmRzTGlzdCA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UmVwZWF0ZWRXcmFwcGVyRmllbGQodGhpcywgMSwgdmFsdWUpOwp9OwovKioKICogQHBhcmFtIHshcHJvdG8ucGIuRmlsZVJlY29yZD19IG9wdF92YWx1ZQogKiBAcGFyYW0ge251bWJlcj19IG9wdF9pbmRleAogKiBAcmV0dXJuIHshcHJvdG8ucGIuRmlsZVJlY29yZH0KICovCgoKcHJvdG8ucGIuY21zLkxpdmVMaXN0UmVwbHkucHJvdG90eXBlLmFkZFJlY29yZHMgPSBmdW5jdGlvbiAob3B0X3ZhbHVlLCBvcHRfaW5kZXgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmFkZFRvUmVwZWF0ZWRXcmFwcGVyRmllbGQodGhpcywgMSwgb3B0X3ZhbHVlLCBwcm90by5wYi5GaWxlUmVjb3JkLCBvcHRfaW5kZXgpOwp9OwovKioKICogQ2xlYXJzIHRoZSBsaXN0IG1ha2luZyBpdCBlbXB0eSBidXQgbm9uLW51bGwuCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuTGl2ZUxpc3RSZXBseX0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5MaXZlTGlzdFJlcGx5LnByb3RvdHlwZS5jbGVhclJlY29yZHNMaXN0ID0gZnVuY3Rpb24gKCkgewogIHJldHVybiB0aGlzLnNldFJlY29yZHNMaXN0KFtdKTsKfTsKLyoqCiAqIG9wdGlvbmFsIHVpbnQzMiBwYWdlX25vID0gMjsKICogQHJldHVybiB7bnVtYmVyfQogKi8KCgpwcm90by5wYi5jbXMuTGl2ZUxpc3RSZXBseS5wcm90b3R5cGUuZ2V0UGFnZU5vID0gZnVuY3Rpb24gKCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdCh0aGlzLCAyLCAwKTsKfTsKLyoqCiAqIEBwYXJhbSB7bnVtYmVyfSB2YWx1ZQogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLkxpdmVMaXN0UmVwbHl9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuTGl2ZUxpc3RSZXBseS5wcm90b3R5cGUuc2V0UGFnZU5vID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRQcm90bzNJbnRGaWVsZCh0aGlzLCAyLCB2YWx1ZSk7Cn07Ci8qKgogKiBvcHRpb25hbCB1aW50MzIgcGFnZV9zaXplID0gMzsKICogQHJldHVybiB7bnVtYmVyfQogKi8KCgpwcm90by5wYi5jbXMuTGl2ZUxpc3RSZXBseS5wcm90b3R5cGUuZ2V0UGFnZVNpemUgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDMsIDApOwp9OwovKioKICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuTGl2ZUxpc3RSZXBseX0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5MaXZlTGlzdFJlcGx5LnByb3RvdHlwZS5zZXRQYWdlU2l6ZSA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UHJvdG8zSW50RmllbGQodGhpcywgMywgdmFsdWUpOwp9OwovKioKICogb3B0aW9uYWwgdWludDMyIHRvdGFsX3BhZ2UgPSA0OwogKiBAcmV0dXJuIHtudW1iZXJ9CiAqLwoKCnByb3RvLnBiLmNtcy5MaXZlTGlzdFJlcGx5LnByb3RvdHlwZS5nZXRUb3RhbFBhZ2UgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDQsIDApOwp9OwovKioKICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuTGl2ZUxpc3RSZXBseX0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5MaXZlTGlzdFJlcGx5LnByb3RvdHlwZS5zZXRUb3RhbFBhZ2UgPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0ludEZpZWxkKHRoaXMsIDQsIHZhbHVlKTsKfTsKLyoqCiAqIG9wdGlvbmFsIHVpbnQzMiB0b3RhbF9jb3VudCA9IDU7CiAqIEByZXR1cm4ge251bWJlcn0KICovCgoKcHJvdG8ucGIuY21zLkxpdmVMaXN0UmVwbHkucHJvdG90eXBlLmdldFRvdGFsQ291bnQgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDUsIDApOwp9OwovKioKICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuTGl2ZUxpc3RSZXBseX0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5MaXZlTGlzdFJlcGx5LnByb3RvdHlwZS5zZXRUb3RhbENvdW50ID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRQcm90bzNJbnRGaWVsZCh0aGlzLCA1LCB2YWx1ZSk7Cn07CgppZiAoanNwYi5NZXNzYWdlLkdFTkVSQVRFX1RPX09CSkVDVCkgewogIC8qKgogICAqIENyZWF0ZXMgYW4gb2JqZWN0IHJlcHJlc2VudGF0aW9uIG9mIHRoaXMgcHJvdG8uCiAgICogRmllbGQgbmFtZXMgdGhhdCBhcmUgcmVzZXJ2ZWQgaW4gSmF2YVNjcmlwdCBhbmQgd2lsbCBiZSByZW5hbWVkIHRvIHBiX25hbWUuCiAgICogT3B0aW9uYWwgZmllbGRzIHRoYXQgYXJlIG5vdCBzZXQgd2lsbCBiZSBzZXQgdG8gdW5kZWZpbmVkLgogICAqIFRvIGFjY2VzcyBhIHJlc2VydmVkIGZpZWxkIHVzZSwgZm9vLnBiXzxuYW1lPiwgZWcsIGZvby5wYl9kZWZhdWx0LgogICAqIEZvciB0aGUgbGlzdCBvZiByZXNlcnZlZCBuYW1lcyBwbGVhc2Ugc2VlOgogICAqICAgICBuZXQvcHJvdG8yL2NvbXBpbGVyL2pzL2ludGVybmFsL2dlbmVyYXRvci5jYyNrS2V5d29yZC4KICAgKiBAcGFyYW0ge2Jvb2xlYW49fSBvcHRfaW5jbHVkZUluc3RhbmNlIERlcHJlY2F0ZWQuIHdoZXRoZXIgdG8gaW5jbHVkZSB0aGUKICAgKiAgICAgSlNQQiBpbnN0YW5jZSBmb3IgdHJhbnNpdGlvbmFsIHNveSBwcm90byBzdXBwb3J0OgogICAqICAgICBodHRwOi8vZ290by9zb3ktcGFyYW0tbWlncmF0aW9uCiAgICogQHJldHVybiB7IU9iamVjdH0KICAgKi8KICBwcm90by5wYi5jbXMuUGF5TGlzdFJlcXVlc3QucHJvdG90eXBlLnRvT2JqZWN0ID0gZnVuY3Rpb24gKG9wdF9pbmNsdWRlSW5zdGFuY2UpIHsKICAgIHJldHVybiBwcm90by5wYi5jbXMuUGF5TGlzdFJlcXVlc3QudG9PYmplY3Qob3B0X2luY2x1ZGVJbnN0YW5jZSwgdGhpcyk7CiAgfTsKICAvKioKICAgKiBTdGF0aWMgdmVyc2lvbiBvZiB0aGUge0BzZWUgdG9PYmplY3R9IG1ldGhvZC4KICAgKiBAcGFyYW0ge2Jvb2xlYW58dW5kZWZpbmVkfSBpbmNsdWRlSW5zdGFuY2UgRGVwcmVjYXRlZC4gV2hldGhlciB0byBpbmNsdWRlCiAgICogICAgIHRoZSBKU1BCIGluc3RhbmNlIGZvciB0cmFuc2l0aW9uYWwgc295IHByb3RvIHN1cHBvcnQ6CiAgICogICAgIGh0dHA6Ly9nb3RvL3NveS1wYXJhbS1taWdyYXRpb24KICAgKiBAcGFyYW0geyFwcm90by5wYi5jbXMuUGF5TGlzdFJlcXVlc3R9IG1zZyBUaGUgbXNnIGluc3RhbmNlIHRvIHRyYW5zZm9ybS4KICAgKiBAcmV0dXJuIHshT2JqZWN0fQogICAqIEBzdXBwcmVzcyB7dW51c2VkTG9jYWxWYXJpYWJsZXN9IGYgaXMgb25seSB1c2VkIGZvciBuZXN0ZWQgbWVzc2FnZXMKICAgKi8KCgogIHByb3RvLnBiLmNtcy5QYXlMaXN0UmVxdWVzdC50b09iamVjdCA9IGZ1bmN0aW9uIChpbmNsdWRlSW5zdGFuY2UsIG1zZykgewogICAgdmFyIGYsCiAgICAgICAgb2JqID0gewogICAgICBwYWdlTm86IGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KG1zZywgMSwgMCksCiAgICAgIHBhZ2VTaXplOiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdChtc2csIDIsIDApLAogICAgICBhcmVhSWQ6IGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KG1zZywgMywgMCksCiAgICAgIGFwcElkOiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdChtc2csIDQsIDApLAogICAgICB1c2VySWQ6IGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KG1zZywgNSwgMCksCiAgICAgIHJlY29yZElkOiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdChtc2csIDYsIDApLAogICAgICBzdGF0dXM6IGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KG1zZywgNywgMCksCiAgICAgIGNyZWF0ZWRTdGFydDoganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQobXNnLCA4LCAwKSwKICAgICAgY3JlYXRlZEVuZDoganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQobXNnLCA5LCAwKQogICAgfTsKCiAgICBpZiAoaW5jbHVkZUluc3RhbmNlKSB7CiAgICAgIG9iai4kanNwYk1lc3NhZ2VJbnN0YW5jZSA9IG1zZzsKICAgIH0KCiAgICByZXR1cm4gb2JqOwogIH07Cn0KLyoqCiAqIERlc2VyaWFsaXplcyBiaW5hcnkgZGF0YSAoaW4gcHJvdG9idWYgd2lyZSBmb3JtYXQpLgogKiBAcGFyYW0ge2pzcGIuQnl0ZVNvdXJjZX0gYnl0ZXMgVGhlIGJ5dGVzIHRvIGRlc2VyaWFsaXplLgogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLlBheUxpc3RSZXF1ZXN0fQogKi8KCgpwcm90by5wYi5jbXMuUGF5TGlzdFJlcXVlc3QuZGVzZXJpYWxpemVCaW5hcnkgPSBmdW5jdGlvbiAoYnl0ZXMpIHsKICB2YXIgcmVhZGVyID0gbmV3IGpzcGIuQmluYXJ5UmVhZGVyKGJ5dGVzKTsKICB2YXIgbXNnID0gbmV3IHByb3RvLnBiLmNtcy5QYXlMaXN0UmVxdWVzdCgpOwogIHJldHVybiBwcm90by5wYi5jbXMuUGF5TGlzdFJlcXVlc3QuZGVzZXJpYWxpemVCaW5hcnlGcm9tUmVhZGVyKG1zZywgcmVhZGVyKTsKfTsKLyoqCiAqIERlc2VyaWFsaXplcyBiaW5hcnkgZGF0YSAoaW4gcHJvdG9idWYgd2lyZSBmb3JtYXQpIGZyb20gdGhlCiAqIGdpdmVuIHJlYWRlciBpbnRvIHRoZSBnaXZlbiBtZXNzYWdlIG9iamVjdC4KICogQHBhcmFtIHshcHJvdG8ucGIuY21zLlBheUxpc3RSZXF1ZXN0fSBtc2cgVGhlIG1lc3NhZ2Ugb2JqZWN0IHRvIGRlc2VyaWFsaXplIGludG8uCiAqIEBwYXJhbSB7IWpzcGIuQmluYXJ5UmVhZGVyfSByZWFkZXIgVGhlIEJpbmFyeVJlYWRlciB0byB1c2UuCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuUGF5TGlzdFJlcXVlc3R9CiAqLwoKCnByb3RvLnBiLmNtcy5QYXlMaXN0UmVxdWVzdC5kZXNlcmlhbGl6ZUJpbmFyeUZyb21SZWFkZXIgPSBmdW5jdGlvbiAobXNnLCByZWFkZXIpIHsKICB3aGlsZSAocmVhZGVyLm5leHRGaWVsZCgpKSB7CiAgICBpZiAocmVhZGVyLmlzRW5kR3JvdXAoKSkgewogICAgICBicmVhazsKICAgIH0KCiAgICB2YXIgZmllbGQgPSByZWFkZXIuZ2V0RmllbGROdW1iZXIoKTsKCiAgICBzd2l0Y2ggKGZpZWxkKSB7CiAgICAgIGNhc2UgMToKICAgICAgICB2YXIgdmFsdWUgPSByZWFkZXIucmVhZFVpbnQzMigpOwogICAgICAgIG1zZy5zZXRQYWdlTm8odmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSAyOgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkVWludDMyKCk7CiAgICAgICAgbXNnLnNldFBhZ2VTaXplKHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgMzoKICAgICAgICB2YXIgdmFsdWUgPSByZWFkZXIucmVhZFVpbnQzMigpOwogICAgICAgIG1zZy5zZXRBcmVhSWQodmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSA0OgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkVWludDMyKCk7CiAgICAgICAgbXNnLnNldEFwcElkKHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgNToKICAgICAgICB2YXIgdmFsdWUgPSByZWFkZXIucmVhZFVpbnQzMigpOwogICAgICAgIG1zZy5zZXRVc2VySWQodmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSA2OgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkVWludDY0KCk7CiAgICAgICAgbXNnLnNldFJlY29yZElkKHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgNzoKICAgICAgICB2YXIgdmFsdWUgPSByZWFkZXIucmVhZEVudW0oKTsKICAgICAgICBtc2cuc2V0U3RhdHVzKHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgODoKICAgICAgICB2YXIgdmFsdWUgPSByZWFkZXIucmVhZFVpbnQzMigpOwogICAgICAgIG1zZy5zZXRDcmVhdGVkU3RhcnQodmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSA5OgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkVWludDMyKCk7CiAgICAgICAgbXNnLnNldENyZWF0ZWRFbmQodmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgZGVmYXVsdDoKICAgICAgICByZWFkZXIuc2tpcEZpZWxkKCk7CiAgICAgICAgYnJlYWs7CiAgICB9CiAgfQoKICByZXR1cm4gbXNnOwp9OwovKioKICogU2VyaWFsaXplcyB0aGUgbWVzc2FnZSB0byBiaW5hcnkgZGF0YSAoaW4gcHJvdG9idWYgd2lyZSBmb3JtYXQpLgogKiBAcmV0dXJuIHshVWludDhBcnJheX0KICovCgoKcHJvdG8ucGIuY21zLlBheUxpc3RSZXF1ZXN0LnByb3RvdHlwZS5zZXJpYWxpemVCaW5hcnkgPSBmdW5jdGlvbiAoKSB7CiAgdmFyIHdyaXRlciA9IG5ldyBqc3BiLkJpbmFyeVdyaXRlcigpOwogIHByb3RvLnBiLmNtcy5QYXlMaXN0UmVxdWVzdC5zZXJpYWxpemVCaW5hcnlUb1dyaXRlcih0aGlzLCB3cml0ZXIpOwogIHJldHVybiB3cml0ZXIuZ2V0UmVzdWx0QnVmZmVyKCk7Cn07Ci8qKgogKiBTZXJpYWxpemVzIHRoZSBnaXZlbiBtZXNzYWdlIHRvIGJpbmFyeSBkYXRhIChpbiBwcm90b2J1ZiB3aXJlCiAqIGZvcm1hdCksIHdyaXRpbmcgdG8gdGhlIGdpdmVuIEJpbmFyeVdyaXRlci4KICogQHBhcmFtIHshcHJvdG8ucGIuY21zLlBheUxpc3RSZXF1ZXN0fSBtZXNzYWdlCiAqIEBwYXJhbSB7IWpzcGIuQmluYXJ5V3JpdGVyfSB3cml0ZXIKICogQHN1cHByZXNzIHt1bnVzZWRMb2NhbFZhcmlhYmxlc30gZiBpcyBvbmx5IHVzZWQgZm9yIG5lc3RlZCBtZXNzYWdlcwogKi8KCgpwcm90by5wYi5jbXMuUGF5TGlzdFJlcXVlc3Quc2VyaWFsaXplQmluYXJ5VG9Xcml0ZXIgPSBmdW5jdGlvbiAobWVzc2FnZSwgd3JpdGVyKSB7CiAgdmFyIGYgPSB1bmRlZmluZWQ7CiAgZiA9IG1lc3NhZ2UuZ2V0UGFnZU5vKCk7CgogIGlmIChmICE9PSAwKSB7CiAgICB3cml0ZXIud3JpdGVVaW50MzIoMSwgZik7CiAgfQoKICBmID0gbWVzc2FnZS5nZXRQYWdlU2l6ZSgpOwoKICBpZiAoZiAhPT0gMCkgewogICAgd3JpdGVyLndyaXRlVWludDMyKDIsIGYpOwogIH0KCiAgZiA9IG1lc3NhZ2UuZ2V0QXJlYUlkKCk7CgogIGlmIChmICE9PSAwKSB7CiAgICB3cml0ZXIud3JpdGVVaW50MzIoMywgZik7CiAgfQoKICBmID0gbWVzc2FnZS5nZXRBcHBJZCgpOwoKICBpZiAoZiAhPT0gMCkgewogICAgd3JpdGVyLndyaXRlVWludDMyKDQsIGYpOwogIH0KCiAgZiA9IG1lc3NhZ2UuZ2V0VXNlcklkKCk7CgogIGlmIChmICE9PSAwKSB7CiAgICB3cml0ZXIud3JpdGVVaW50MzIoNSwgZik7CiAgfQoKICBmID0gbWVzc2FnZS5nZXRSZWNvcmRJZCgpOwoKICBpZiAoZiAhPT0gMCkgewogICAgd3JpdGVyLndyaXRlVWludDY0KDYsIGYpOwogIH0KCiAgZiA9IG1lc3NhZ2UuZ2V0U3RhdHVzKCk7CgogIGlmIChmICE9PSAwLjApIHsKICAgIHdyaXRlci53cml0ZUVudW0oNywgZik7CiAgfQoKICBmID0gbWVzc2FnZS5nZXRDcmVhdGVkU3RhcnQoKTsKCiAgaWYgKGYgIT09IDApIHsKICAgIHdyaXRlci53cml0ZVVpbnQzMig4LCBmKTsKICB9CgogIGYgPSBtZXNzYWdlLmdldENyZWF0ZWRFbmQoKTsKCiAgaWYgKGYgIT09IDApIHsKICAgIHdyaXRlci53cml0ZVVpbnQzMig5LCBmKTsKICB9Cn07Ci8qKgogKiBvcHRpb25hbCB1aW50MzIgcGFnZV9ubyA9IDE7CiAqIEByZXR1cm4ge251bWJlcn0KICovCgoKcHJvdG8ucGIuY21zLlBheUxpc3RSZXF1ZXN0LnByb3RvdHlwZS5nZXRQYWdlTm8gPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDEsIDApOwp9OwovKioKICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuUGF5TGlzdFJlcXVlc3R9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuUGF5TGlzdFJlcXVlc3QucHJvdG90eXBlLnNldFBhZ2VObyA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UHJvdG8zSW50RmllbGQodGhpcywgMSwgdmFsdWUpOwp9OwovKioKICogb3B0aW9uYWwgdWludDMyIHBhZ2Vfc2l6ZSA9IDI7CiAqIEByZXR1cm4ge251bWJlcn0KICovCgoKcHJvdG8ucGIuY21zLlBheUxpc3RSZXF1ZXN0LnByb3RvdHlwZS5nZXRQYWdlU2l6ZSA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQodGhpcywgMiwgMCk7Cn07Ci8qKgogKiBAcGFyYW0ge251bWJlcn0gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5QYXlMaXN0UmVxdWVzdH0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5QYXlMaXN0UmVxdWVzdC5wcm90b3R5cGUuc2V0UGFnZVNpemUgPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0ludEZpZWxkKHRoaXMsIDIsIHZhbHVlKTsKfTsKLyoqCiAqIG9wdGlvbmFsIHVpbnQzMiBhcmVhX2lkID0gMzsKICogQHJldHVybiB7bnVtYmVyfQogKi8KCgpwcm90by5wYi5jbXMuUGF5TGlzdFJlcXVlc3QucHJvdG90eXBlLmdldEFyZWFJZCA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQodGhpcywgMywgMCk7Cn07Ci8qKgogKiBAcGFyYW0ge251bWJlcn0gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5QYXlMaXN0UmVxdWVzdH0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5QYXlMaXN0UmVxdWVzdC5wcm90b3R5cGUuc2V0QXJlYUlkID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRQcm90bzNJbnRGaWVsZCh0aGlzLCAzLCB2YWx1ZSk7Cn07Ci8qKgogKiBvcHRpb25hbCB1aW50MzIgYXBwX2lkID0gNDsKICogQHJldHVybiB7bnVtYmVyfQogKi8KCgpwcm90by5wYi5jbXMuUGF5TGlzdFJlcXVlc3QucHJvdG90eXBlLmdldEFwcElkID0gZnVuY3Rpb24gKCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdCh0aGlzLCA0LCAwKTsKfTsKLyoqCiAqIEBwYXJhbSB7bnVtYmVyfSB2YWx1ZQogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLlBheUxpc3RSZXF1ZXN0fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLlBheUxpc3RSZXF1ZXN0LnByb3RvdHlwZS5zZXRBcHBJZCA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UHJvdG8zSW50RmllbGQodGhpcywgNCwgdmFsdWUpOwp9OwovKioKICogb3B0aW9uYWwgdWludDMyIHVzZXJfaWQgPSA1OwogKiBAcmV0dXJuIHtudW1iZXJ9CiAqLwoKCnByb3RvLnBiLmNtcy5QYXlMaXN0UmVxdWVzdC5wcm90b3R5cGUuZ2V0VXNlcklkID0gZnVuY3Rpb24gKCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdCh0aGlzLCA1LCAwKTsKfTsKLyoqCiAqIEBwYXJhbSB7bnVtYmVyfSB2YWx1ZQogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLlBheUxpc3RSZXF1ZXN0fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLlBheUxpc3RSZXF1ZXN0LnByb3RvdHlwZS5zZXRVc2VySWQgPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0ludEZpZWxkKHRoaXMsIDUsIHZhbHVlKTsKfTsKLyoqCiAqIG9wdGlvbmFsIHVpbnQ2NCByZWNvcmRfaWQgPSA2OwogKiBAcmV0dXJuIHtudW1iZXJ9CiAqLwoKCnByb3RvLnBiLmNtcy5QYXlMaXN0UmVxdWVzdC5wcm90b3R5cGUuZ2V0UmVjb3JkSWQgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDYsIDApOwp9OwovKioKICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuUGF5TGlzdFJlcXVlc3R9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuUGF5TGlzdFJlcXVlc3QucHJvdG90eXBlLnNldFJlY29yZElkID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRQcm90bzNJbnRGaWVsZCh0aGlzLCA2LCB2YWx1ZSk7Cn07Ci8qKgogKiBvcHRpb25hbCBwYi5QYXlTdGF0dXMgc3RhdHVzID0gNzsKICogQHJldHVybiB7IXByb3RvLnBiLlBheVN0YXR1c30KICovCgoKcHJvdG8ucGIuY21zLlBheUxpc3RSZXF1ZXN0LnByb3RvdHlwZS5nZXRTdGF0dXMgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDcsIDApOwp9OwovKioKICogQHBhcmFtIHshcHJvdG8ucGIuUGF5U3RhdHVzfSB2YWx1ZQogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLlBheUxpc3RSZXF1ZXN0fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLlBheUxpc3RSZXF1ZXN0LnByb3RvdHlwZS5zZXRTdGF0dXMgPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0VudW1GaWVsZCh0aGlzLCA3LCB2YWx1ZSk7Cn07Ci8qKgogKiBvcHRpb25hbCB1aW50MzIgY3JlYXRlZF9zdGFydCA9IDg7CiAqIEByZXR1cm4ge251bWJlcn0KICovCgoKcHJvdG8ucGIuY21zLlBheUxpc3RSZXF1ZXN0LnByb3RvdHlwZS5nZXRDcmVhdGVkU3RhcnQgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDgsIDApOwp9OwovKioKICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuUGF5TGlzdFJlcXVlc3R9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuUGF5TGlzdFJlcXVlc3QucHJvdG90eXBlLnNldENyZWF0ZWRTdGFydCA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UHJvdG8zSW50RmllbGQodGhpcywgOCwgdmFsdWUpOwp9OwovKioKICogb3B0aW9uYWwgdWludDMyIGNyZWF0ZWRfZW5kID0gOTsKICogQHJldHVybiB7bnVtYmVyfQogKi8KCgpwcm90by5wYi5jbXMuUGF5TGlzdFJlcXVlc3QucHJvdG90eXBlLmdldENyZWF0ZWRFbmQgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDksIDApOwp9OwovKioKICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuUGF5TGlzdFJlcXVlc3R9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuUGF5TGlzdFJlcXVlc3QucHJvdG90eXBlLnNldENyZWF0ZWRFbmQgPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0ludEZpZWxkKHRoaXMsIDksIHZhbHVlKTsKfTsKLyoqCiAqIExpc3Qgb2YgcmVwZWF0ZWQgZmllbGRzIHdpdGhpbiB0aGlzIG1lc3NhZ2UgdHlwZS4KICogQHByaXZhdGUgeyFBcnJheTxudW1iZXI+fQogKiBAY29uc3QKICovCgoKcHJvdG8ucGIuY21zLlBheUxpc3RSZXBseS5yZXBlYXRlZEZpZWxkc18gPSBbMV07CgppZiAoanNwYi5NZXNzYWdlLkdFTkVSQVRFX1RPX09CSkVDVCkgewogIC8qKgogICAqIENyZWF0ZXMgYW4gb2JqZWN0IHJlcHJlc2VudGF0aW9uIG9mIHRoaXMgcHJvdG8uCiAgICogRmllbGQgbmFtZXMgdGhhdCBhcmUgcmVzZXJ2ZWQgaW4gSmF2YVNjcmlwdCBhbmQgd2lsbCBiZSByZW5hbWVkIHRvIHBiX25hbWUuCiAgICogT3B0aW9uYWwgZmllbGRzIHRoYXQgYXJlIG5vdCBzZXQgd2lsbCBiZSBzZXQgdG8gdW5kZWZpbmVkLgogICAqIFRvIGFjY2VzcyBhIHJlc2VydmVkIGZpZWxkIHVzZSwgZm9vLnBiXzxuYW1lPiwgZWcsIGZvby5wYl9kZWZhdWx0LgogICAqIEZvciB0aGUgbGlzdCBvZiByZXNlcnZlZCBuYW1lcyBwbGVhc2Ugc2VlOgogICAqICAgICBuZXQvcHJvdG8yL2NvbXBpbGVyL2pzL2ludGVybmFsL2dlbmVyYXRvci5jYyNrS2V5d29yZC4KICAgKiBAcGFyYW0ge2Jvb2xlYW49fSBvcHRfaW5jbHVkZUluc3RhbmNlIERlcHJlY2F0ZWQuIHdoZXRoZXIgdG8gaW5jbHVkZSB0aGUKICAgKiAgICAgSlNQQiBpbnN0YW5jZSBmb3IgdHJhbnNpdGlvbmFsIHNveSBwcm90byBzdXBwb3J0OgogICAqICAgICBodHRwOi8vZ290by9zb3ktcGFyYW0tbWlncmF0aW9uCiAgICogQHJldHVybiB7IU9iamVjdH0KICAgKi8KICBwcm90by5wYi5jbXMuUGF5TGlzdFJlcGx5LnByb3RvdHlwZS50b09iamVjdCA9IGZ1bmN0aW9uIChvcHRfaW5jbHVkZUluc3RhbmNlKSB7CiAgICByZXR1cm4gcHJvdG8ucGIuY21zLlBheUxpc3RSZXBseS50b09iamVjdChvcHRfaW5jbHVkZUluc3RhbmNlLCB0aGlzKTsKICB9OwogIC8qKgogICAqIFN0YXRpYyB2ZXJzaW9uIG9mIHRoZSB7QHNlZSB0b09iamVjdH0gbWV0aG9kLgogICAqIEBwYXJhbSB7Ym9vbGVhbnx1bmRlZmluZWR9IGluY2x1ZGVJbnN0YW5jZSBEZXByZWNhdGVkLiBXaGV0aGVyIHRvIGluY2x1ZGUKICAgKiAgICAgdGhlIEpTUEIgaW5zdGFuY2UgZm9yIHRyYW5zaXRpb25hbCBzb3kgcHJvdG8gc3VwcG9ydDoKICAgKiAgICAgaHR0cDovL2dvdG8vc295LXBhcmFtLW1pZ3JhdGlvbgogICAqIEBwYXJhbSB7IXByb3RvLnBiLmNtcy5QYXlMaXN0UmVwbHl9IG1zZyBUaGUgbXNnIGluc3RhbmNlIHRvIHRyYW5zZm9ybS4KICAgKiBAcmV0dXJuIHshT2JqZWN0fQogICAqIEBzdXBwcmVzcyB7dW51c2VkTG9jYWxWYXJpYWJsZXN9IGYgaXMgb25seSB1c2VkIGZvciBuZXN0ZWQgbWVzc2FnZXMKICAgKi8KCgogIHByb3RvLnBiLmNtcy5QYXlMaXN0UmVwbHkudG9PYmplY3QgPSBmdW5jdGlvbiAoaW5jbHVkZUluc3RhbmNlLCBtc2cpIHsKICAgIHZhciBmLAogICAgICAgIG9iaiA9IHsKICAgICAgcmVjb3Jkc0xpc3Q6IGpzcGIuTWVzc2FnZS50b09iamVjdExpc3QobXNnLmdldFJlY29yZHNMaXN0KCksIHVzZXJ0eXBlX3BiLlBheVJlY29yZC50b09iamVjdCwgaW5jbHVkZUluc3RhbmNlKSwKICAgICAgcGFnZU5vOiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdChtc2csIDIsIDApLAogICAgICBwYWdlU2l6ZToganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQobXNnLCAzLCAwKSwKICAgICAgdG90YWxQYWdlOiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdChtc2csIDQsIDApLAogICAgICB0b3RhbENvdW50OiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdChtc2csIDUsIDApCiAgICB9OwoKICAgIGlmIChpbmNsdWRlSW5zdGFuY2UpIHsKICAgICAgb2JqLiRqc3BiTWVzc2FnZUluc3RhbmNlID0gbXNnOwogICAgfQoKICAgIHJldHVybiBvYmo7CiAgfTsKfQovKioKICogRGVzZXJpYWxpemVzIGJpbmFyeSBkYXRhIChpbiBwcm90b2J1ZiB3aXJlIGZvcm1hdCkuCiAqIEBwYXJhbSB7anNwYi5CeXRlU291cmNlfSBieXRlcyBUaGUgYnl0ZXMgdG8gZGVzZXJpYWxpemUuCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuUGF5TGlzdFJlcGx5fQogKi8KCgpwcm90by5wYi5jbXMuUGF5TGlzdFJlcGx5LmRlc2VyaWFsaXplQmluYXJ5ID0gZnVuY3Rpb24gKGJ5dGVzKSB7CiAgdmFyIHJlYWRlciA9IG5ldyBqc3BiLkJpbmFyeVJlYWRlcihieXRlcyk7CiAgdmFyIG1zZyA9IG5ldyBwcm90by5wYi5jbXMuUGF5TGlzdFJlcGx5KCk7CiAgcmV0dXJuIHByb3RvLnBiLmNtcy5QYXlMaXN0UmVwbHkuZGVzZXJpYWxpemVCaW5hcnlGcm9tUmVhZGVyKG1zZywgcmVhZGVyKTsKfTsKLyoqCiAqIERlc2VyaWFsaXplcyBiaW5hcnkgZGF0YSAoaW4gcHJvdG9idWYgd2lyZSBmb3JtYXQpIGZyb20gdGhlCiAqIGdpdmVuIHJlYWRlciBpbnRvIHRoZSBnaXZlbiBtZXNzYWdlIG9iamVjdC4KICogQHBhcmFtIHshcHJvdG8ucGIuY21zLlBheUxpc3RSZXBseX0gbXNnIFRoZSBtZXNzYWdlIG9iamVjdCB0byBkZXNlcmlhbGl6ZSBpbnRvLgogKiBAcGFyYW0geyFqc3BiLkJpbmFyeVJlYWRlcn0gcmVhZGVyIFRoZSBCaW5hcnlSZWFkZXIgdG8gdXNlLgogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLlBheUxpc3RSZXBseX0KICovCgoKcHJvdG8ucGIuY21zLlBheUxpc3RSZXBseS5kZXNlcmlhbGl6ZUJpbmFyeUZyb21SZWFkZXIgPSBmdW5jdGlvbiAobXNnLCByZWFkZXIpIHsKICB3aGlsZSAocmVhZGVyLm5leHRGaWVsZCgpKSB7CiAgICBpZiAocmVhZGVyLmlzRW5kR3JvdXAoKSkgewogICAgICBicmVhazsKICAgIH0KCiAgICB2YXIgZmllbGQgPSByZWFkZXIuZ2V0RmllbGROdW1iZXIoKTsKCiAgICBzd2l0Y2ggKGZpZWxkKSB7CiAgICAgIGNhc2UgMToKICAgICAgICB2YXIgdmFsdWUgPSBuZXcgdXNlcnR5cGVfcGIuUGF5UmVjb3JkKCk7CiAgICAgICAgcmVhZGVyLnJlYWRNZXNzYWdlKHZhbHVlLCB1c2VydHlwZV9wYi5QYXlSZWNvcmQuZGVzZXJpYWxpemVCaW5hcnlGcm9tUmVhZGVyKTsKICAgICAgICBtc2cuYWRkUmVjb3Jkcyh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlIDI6CiAgICAgICAgdmFyIHZhbHVlID0gcmVhZGVyLnJlYWRVaW50MzIoKTsKICAgICAgICBtc2cuc2V0UGFnZU5vKHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgMzoKICAgICAgICB2YXIgdmFsdWUgPSByZWFkZXIucmVhZFVpbnQzMigpOwogICAgICAgIG1zZy5zZXRQYWdlU2l6ZSh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlIDQ6CiAgICAgICAgdmFyIHZhbHVlID0gcmVhZGVyLnJlYWRVaW50MzIoKTsKICAgICAgICBtc2cuc2V0VG90YWxQYWdlKHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgNToKICAgICAgICB2YXIgdmFsdWUgPSByZWFkZXIucmVhZFVpbnQzMigpOwogICAgICAgIG1zZy5zZXRUb3RhbENvdW50KHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGRlZmF1bHQ6CiAgICAgICAgcmVhZGVyLnNraXBGaWVsZCgpOwogICAgICAgIGJyZWFrOwogICAgfQogIH0KCiAgcmV0dXJuIG1zZzsKfTsKLyoqCiAqIFNlcmlhbGl6ZXMgdGhlIG1lc3NhZ2UgdG8gYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUgZm9ybWF0KS4KICogQHJldHVybiB7IVVpbnQ4QXJyYXl9CiAqLwoKCnByb3RvLnBiLmNtcy5QYXlMaXN0UmVwbHkucHJvdG90eXBlLnNlcmlhbGl6ZUJpbmFyeSA9IGZ1bmN0aW9uICgpIHsKICB2YXIgd3JpdGVyID0gbmV3IGpzcGIuQmluYXJ5V3JpdGVyKCk7CiAgcHJvdG8ucGIuY21zLlBheUxpc3RSZXBseS5zZXJpYWxpemVCaW5hcnlUb1dyaXRlcih0aGlzLCB3cml0ZXIpOwogIHJldHVybiB3cml0ZXIuZ2V0UmVzdWx0QnVmZmVyKCk7Cn07Ci8qKgogKiBTZXJpYWxpemVzIHRoZSBnaXZlbiBtZXNzYWdlIHRvIGJpbmFyeSBkYXRhIChpbiBwcm90b2J1ZiB3aXJlCiAqIGZvcm1hdCksIHdyaXRpbmcgdG8gdGhlIGdpdmVuIEJpbmFyeVdyaXRlci4KICogQHBhcmFtIHshcHJvdG8ucGIuY21zLlBheUxpc3RSZXBseX0gbWVzc2FnZQogKiBAcGFyYW0geyFqc3BiLkJpbmFyeVdyaXRlcn0gd3JpdGVyCiAqIEBzdXBwcmVzcyB7dW51c2VkTG9jYWxWYXJpYWJsZXN9IGYgaXMgb25seSB1c2VkIGZvciBuZXN0ZWQgbWVzc2FnZXMKICovCgoKcHJvdG8ucGIuY21zLlBheUxpc3RSZXBseS5zZXJpYWxpemVCaW5hcnlUb1dyaXRlciA9IGZ1bmN0aW9uIChtZXNzYWdlLCB3cml0ZXIpIHsKICB2YXIgZiA9IHVuZGVmaW5lZDsKICBmID0gbWVzc2FnZS5nZXRSZWNvcmRzTGlzdCgpOwoKICBpZiAoZi5sZW5ndGggPiAwKSB7CiAgICB3cml0ZXIud3JpdGVSZXBlYXRlZE1lc3NhZ2UoMSwgZiwgdXNlcnR5cGVfcGIuUGF5UmVjb3JkLnNlcmlhbGl6ZUJpbmFyeVRvV3JpdGVyKTsKICB9CgogIGYgPSBtZXNzYWdlLmdldFBhZ2VObygpOwoKICBpZiAoZiAhPT0gMCkgewogICAgd3JpdGVyLndyaXRlVWludDMyKDIsIGYpOwogIH0KCiAgZiA9IG1lc3NhZ2UuZ2V0UGFnZVNpemUoKTsKCiAgaWYgKGYgIT09IDApIHsKICAgIHdyaXRlci53cml0ZVVpbnQzMigzLCBmKTsKICB9CgogIGYgPSBtZXNzYWdlLmdldFRvdGFsUGFnZSgpOwoKICBpZiAoZiAhPT0gMCkgewogICAgd3JpdGVyLndyaXRlVWludDMyKDQsIGYpOwogIH0KCiAgZiA9IG1lc3NhZ2UuZ2V0VG90YWxDb3VudCgpOwoKICBpZiAoZiAhPT0gMCkgewogICAgd3JpdGVyLndyaXRlVWludDMyKDUsIGYpOwogIH0KfTsKLyoqCiAqIHJlcGVhdGVkIHBiLlBheVJlY29yZCByZWNvcmRzID0gMTsKICogQHJldHVybiB7IUFycmF5PCFwcm90by5wYi5QYXlSZWNvcmQ+fQogKi8KCgpwcm90by5wYi5jbXMuUGF5TGlzdFJlcGx5LnByb3RvdHlwZS5nZXRSZWNvcmRzTGlzdCA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldFJlcGVhdGVkV3JhcHBlckZpZWxkKHRoaXMsIHVzZXJ0eXBlX3BiLlBheVJlY29yZCwgMSk7Cn07Ci8qKgogKiBAcGFyYW0geyFBcnJheTwhcHJvdG8ucGIuUGF5UmVjb3JkPn0gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5QYXlMaXN0UmVwbHl9IHJldHVybnMgdGhpcwoqLwoKCnByb3RvLnBiLmNtcy5QYXlMaXN0UmVwbHkucHJvdG90eXBlLnNldFJlY29yZHNMaXN0ID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRSZXBlYXRlZFdyYXBwZXJGaWVsZCh0aGlzLCAxLCB2YWx1ZSk7Cn07Ci8qKgogKiBAcGFyYW0geyFwcm90by5wYi5QYXlSZWNvcmQ9fSBvcHRfdmFsdWUKICogQHBhcmFtIHtudW1iZXI9fSBvcHRfaW5kZXgKICogQHJldHVybiB7IXByb3RvLnBiLlBheVJlY29yZH0KICovCgoKcHJvdG8ucGIuY21zLlBheUxpc3RSZXBseS5wcm90b3R5cGUuYWRkUmVjb3JkcyA9IGZ1bmN0aW9uIChvcHRfdmFsdWUsIG9wdF9pbmRleCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuYWRkVG9SZXBlYXRlZFdyYXBwZXJGaWVsZCh0aGlzLCAxLCBvcHRfdmFsdWUsIHByb3RvLnBiLlBheVJlY29yZCwgb3B0X2luZGV4KTsKfTsKLyoqCiAqIENsZWFycyB0aGUgbGlzdCBtYWtpbmcgaXQgZW1wdHkgYnV0IG5vbi1udWxsLgogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLlBheUxpc3RSZXBseX0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5QYXlMaXN0UmVwbHkucHJvdG90eXBlLmNsZWFyUmVjb3Jkc0xpc3QgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIHRoaXMuc2V0UmVjb3Jkc0xpc3QoW10pOwp9OwovKioKICogb3B0aW9uYWwgdWludDMyIHBhZ2Vfbm8gPSAyOwogKiBAcmV0dXJuIHtudW1iZXJ9CiAqLwoKCnByb3RvLnBiLmNtcy5QYXlMaXN0UmVwbHkucHJvdG90eXBlLmdldFBhZ2VObyA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQodGhpcywgMiwgMCk7Cn07Ci8qKgogKiBAcGFyYW0ge251bWJlcn0gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5QYXlMaXN0UmVwbHl9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuUGF5TGlzdFJlcGx5LnByb3RvdHlwZS5zZXRQYWdlTm8gPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0ludEZpZWxkKHRoaXMsIDIsIHZhbHVlKTsKfTsKLyoqCiAqIG9wdGlvbmFsIHVpbnQzMiBwYWdlX3NpemUgPSAzOwogKiBAcmV0dXJuIHtudW1iZXJ9CiAqLwoKCnByb3RvLnBiLmNtcy5QYXlMaXN0UmVwbHkucHJvdG90eXBlLmdldFBhZ2VTaXplID0gZnVuY3Rpb24gKCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdCh0aGlzLCAzLCAwKTsKfTsKLyoqCiAqIEBwYXJhbSB7bnVtYmVyfSB2YWx1ZQogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLlBheUxpc3RSZXBseX0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5QYXlMaXN0UmVwbHkucHJvdG90eXBlLnNldFBhZ2VTaXplID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRQcm90bzNJbnRGaWVsZCh0aGlzLCAzLCB2YWx1ZSk7Cn07Ci8qKgogKiBvcHRpb25hbCB1aW50MzIgdG90YWxfcGFnZSA9IDQ7CiAqIEByZXR1cm4ge251bWJlcn0KICovCgoKcHJvdG8ucGIuY21zLlBheUxpc3RSZXBseS5wcm90b3R5cGUuZ2V0VG90YWxQYWdlID0gZnVuY3Rpb24gKCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdCh0aGlzLCA0LCAwKTsKfTsKLyoqCiAqIEBwYXJhbSB7bnVtYmVyfSB2YWx1ZQogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLlBheUxpc3RSZXBseX0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5QYXlMaXN0UmVwbHkucHJvdG90eXBlLnNldFRvdGFsUGFnZSA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UHJvdG8zSW50RmllbGQodGhpcywgNCwgdmFsdWUpOwp9OwovKioKICogb3B0aW9uYWwgdWludDMyIHRvdGFsX2NvdW50ID0gNTsKICogQHJldHVybiB7bnVtYmVyfQogKi8KCgpwcm90by5wYi5jbXMuUGF5TGlzdFJlcGx5LnByb3RvdHlwZS5nZXRUb3RhbENvdW50ID0gZnVuY3Rpb24gKCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdCh0aGlzLCA1LCAwKTsKfTsKLyoqCiAqIEBwYXJhbSB7bnVtYmVyfSB2YWx1ZQogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLlBheUxpc3RSZXBseX0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5QYXlMaXN0UmVwbHkucHJvdG90eXBlLnNldFRvdGFsQ291bnQgPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0ludEZpZWxkKHRoaXMsIDUsIHZhbHVlKTsKfTsKCmlmIChqc3BiLk1lc3NhZ2UuR0VORVJBVEVfVE9fT0JKRUNUKSB7CiAgLyoqCiAgICogQ3JlYXRlcyBhbiBvYmplY3QgcmVwcmVzZW50YXRpb24gb2YgdGhpcyBwcm90by4KICAgKiBGaWVsZCBuYW1lcyB0aGF0IGFyZSByZXNlcnZlZCBpbiBKYXZhU2NyaXB0IGFuZCB3aWxsIGJlIHJlbmFtZWQgdG8gcGJfbmFtZS4KICAgKiBPcHRpb25hbCBmaWVsZHMgdGhhdCBhcmUgbm90IHNldCB3aWxsIGJlIHNldCB0byB1bmRlZmluZWQuCiAgICogVG8gYWNjZXNzIGEgcmVzZXJ2ZWQgZmllbGQgdXNlLCBmb28ucGJfPG5hbWU+LCBlZywgZm9vLnBiX2RlZmF1bHQuCiAgICogRm9yIHRoZSBsaXN0IG9mIHJlc2VydmVkIG5hbWVzIHBsZWFzZSBzZWU6CiAgICogICAgIG5ldC9wcm90bzIvY29tcGlsZXIvanMvaW50ZXJuYWwvZ2VuZXJhdG9yLmNjI2tLZXl3b3JkLgogICAqIEBwYXJhbSB7Ym9vbGVhbj19IG9wdF9pbmNsdWRlSW5zdGFuY2UgRGVwcmVjYXRlZC4gd2hldGhlciB0byBpbmNsdWRlIHRoZQogICAqICAgICBKU1BCIGluc3RhbmNlIGZvciB0cmFuc2l0aW9uYWwgc295IHByb3RvIHN1cHBvcnQ6CiAgICogICAgIGh0dHA6Ly9nb3RvL3NveS1wYXJhbS1taWdyYXRpb24KICAgKiBAcmV0dXJuIHshT2JqZWN0fQogICAqLwogIHByb3RvLnBiLmNtcy5Sb2JvdExpc3RSZXF1ZXN0LnByb3RvdHlwZS50b09iamVjdCA9IGZ1bmN0aW9uIChvcHRfaW5jbHVkZUluc3RhbmNlKSB7CiAgICByZXR1cm4gcHJvdG8ucGIuY21zLlJvYm90TGlzdFJlcXVlc3QudG9PYmplY3Qob3B0X2luY2x1ZGVJbnN0YW5jZSwgdGhpcyk7CiAgfTsKICAvKioKICAgKiBTdGF0aWMgdmVyc2lvbiBvZiB0aGUge0BzZWUgdG9PYmplY3R9IG1ldGhvZC4KICAgKiBAcGFyYW0ge2Jvb2xlYW58dW5kZWZpbmVkfSBpbmNsdWRlSW5zdGFuY2UgRGVwcmVjYXRlZC4gV2hldGhlciB0byBpbmNsdWRlCiAgICogICAgIHRoZSBKU1BCIGluc3RhbmNlIGZvciB0cmFuc2l0aW9uYWwgc295IHByb3RvIHN1cHBvcnQ6CiAgICogICAgIGh0dHA6Ly9nb3RvL3NveS1wYXJhbS1taWdyYXRpb24KICAgKiBAcGFyYW0geyFwcm90by5wYi5jbXMuUm9ib3RMaXN0UmVxdWVzdH0gbXNnIFRoZSBtc2cgaW5zdGFuY2UgdG8gdHJhbnNmb3JtLgogICAqIEByZXR1cm4geyFPYmplY3R9CiAgICogQHN1cHByZXNzIHt1bnVzZWRMb2NhbFZhcmlhYmxlc30gZiBpcyBvbmx5IHVzZWQgZm9yIG5lc3RlZCBtZXNzYWdlcwogICAqLwoKCiAgcHJvdG8ucGIuY21zLlJvYm90TGlzdFJlcXVlc3QudG9PYmplY3QgPSBmdW5jdGlvbiAoaW5jbHVkZUluc3RhbmNlLCBtc2cpIHsKICAgIHZhciBmLAogICAgICAgIG9iaiA9IHsKICAgICAgcGFnZU5vOiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdChtc2csIDEsIDApLAogICAgICBwYWdlU2l6ZToganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQobXNnLCAyLCAwKSwKICAgICAgYXJlYUlkOiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdChtc2csIDMsIDApLAogICAgICBlbmFibGU6IGpzcGIuTWVzc2FnZS5nZXRCb29sZWFuRmllbGRXaXRoRGVmYXVsdChtc2csIDQsIGZhbHNlKSwKICAgICAgcm9ib3RJZDoganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQobXNnLCA1LCAwKQogICAgfTsKCiAgICBpZiAoaW5jbHVkZUluc3RhbmNlKSB7CiAgICAgIG9iai4kanNwYk1lc3NhZ2VJbnN0YW5jZSA9IG1zZzsKICAgIH0KCiAgICByZXR1cm4gb2JqOwogIH07Cn0KLyoqCiAqIERlc2VyaWFsaXplcyBiaW5hcnkgZGF0YSAoaW4gcHJvdG9idWYgd2lyZSBmb3JtYXQpLgogKiBAcGFyYW0ge2pzcGIuQnl0ZVNvdXJjZX0gYnl0ZXMgVGhlIGJ5dGVzIHRvIGRlc2VyaWFsaXplLgogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLlJvYm90TGlzdFJlcXVlc3R9CiAqLwoKCnByb3RvLnBiLmNtcy5Sb2JvdExpc3RSZXF1ZXN0LmRlc2VyaWFsaXplQmluYXJ5ID0gZnVuY3Rpb24gKGJ5dGVzKSB7CiAgdmFyIHJlYWRlciA9IG5ldyBqc3BiLkJpbmFyeVJlYWRlcihieXRlcyk7CiAgdmFyIG1zZyA9IG5ldyBwcm90by5wYi5jbXMuUm9ib3RMaXN0UmVxdWVzdCgpOwogIHJldHVybiBwcm90by5wYi5jbXMuUm9ib3RMaXN0UmVxdWVzdC5kZXNlcmlhbGl6ZUJpbmFyeUZyb21SZWFkZXIobXNnLCByZWFkZXIpOwp9OwovKioKICogRGVzZXJpYWxpemVzIGJpbmFyeSBkYXRhIChpbiBwcm90b2J1ZiB3aXJlIGZvcm1hdCkgZnJvbSB0aGUKICogZ2l2ZW4gcmVhZGVyIGludG8gdGhlIGdpdmVuIG1lc3NhZ2Ugb2JqZWN0LgogKiBAcGFyYW0geyFwcm90by5wYi5jbXMuUm9ib3RMaXN0UmVxdWVzdH0gbXNnIFRoZSBtZXNzYWdlIG9iamVjdCB0byBkZXNlcmlhbGl6ZSBpbnRvLgogKiBAcGFyYW0geyFqc3BiLkJpbmFyeVJlYWRlcn0gcmVhZGVyIFRoZSBCaW5hcnlSZWFkZXIgdG8gdXNlLgogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLlJvYm90TGlzdFJlcXVlc3R9CiAqLwoKCnByb3RvLnBiLmNtcy5Sb2JvdExpc3RSZXF1ZXN0LmRlc2VyaWFsaXplQmluYXJ5RnJvbVJlYWRlciA9IGZ1bmN0aW9uIChtc2csIHJlYWRlcikgewogIHdoaWxlIChyZWFkZXIubmV4dEZpZWxkKCkpIHsKICAgIGlmIChyZWFkZXIuaXNFbmRHcm91cCgpKSB7CiAgICAgIGJyZWFrOwogICAgfQoKICAgIHZhciBmaWVsZCA9IHJlYWRlci5nZXRGaWVsZE51bWJlcigpOwoKICAgIHN3aXRjaCAoZmllbGQpIHsKICAgICAgY2FzZSAxOgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkVWludDMyKCk7CiAgICAgICAgbXNnLnNldFBhZ2VObyh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlIDI6CiAgICAgICAgdmFyIHZhbHVlID0gcmVhZGVyLnJlYWRVaW50MzIoKTsKICAgICAgICBtc2cuc2V0UGFnZVNpemUodmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSAzOgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkVWludDMyKCk7CiAgICAgICAgbXNnLnNldEFyZWFJZCh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlIDQ6CiAgICAgICAgdmFyIHZhbHVlID0gcmVhZGVyLnJlYWRCb29sKCk7CiAgICAgICAgbXNnLnNldEVuYWJsZSh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlIDU6CiAgICAgICAgdmFyIHZhbHVlID0gcmVhZGVyLnJlYWRVaW50MzIoKTsKICAgICAgICBtc2cuc2V0Um9ib3RJZCh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBkZWZhdWx0OgogICAgICAgIHJlYWRlci5za2lwRmllbGQoKTsKICAgICAgICBicmVhazsKICAgIH0KICB9CgogIHJldHVybiBtc2c7Cn07Ci8qKgogKiBTZXJpYWxpemVzIHRoZSBtZXNzYWdlIHRvIGJpbmFyeSBkYXRhIChpbiBwcm90b2J1ZiB3aXJlIGZvcm1hdCkuCiAqIEByZXR1cm4geyFVaW50OEFycmF5fQogKi8KCgpwcm90by5wYi5jbXMuUm9ib3RMaXN0UmVxdWVzdC5wcm90b3R5cGUuc2VyaWFsaXplQmluYXJ5ID0gZnVuY3Rpb24gKCkgewogIHZhciB3cml0ZXIgPSBuZXcganNwYi5CaW5hcnlXcml0ZXIoKTsKICBwcm90by5wYi5jbXMuUm9ib3RMaXN0UmVxdWVzdC5zZXJpYWxpemVCaW5hcnlUb1dyaXRlcih0aGlzLCB3cml0ZXIpOwogIHJldHVybiB3cml0ZXIuZ2V0UmVzdWx0QnVmZmVyKCk7Cn07Ci8qKgogKiBTZXJpYWxpemVzIHRoZSBnaXZlbiBtZXNzYWdlIHRvIGJpbmFyeSBkYXRhIChpbiBwcm90b2J1ZiB3aXJlCiAqIGZvcm1hdCksIHdyaXRpbmcgdG8gdGhlIGdpdmVuIEJpbmFyeVdyaXRlci4KICogQHBhcmFtIHshcHJvdG8ucGIuY21zLlJvYm90TGlzdFJlcXVlc3R9IG1lc3NhZ2UKICogQHBhcmFtIHshanNwYi5CaW5hcnlXcml0ZXJ9IHdyaXRlcgogKiBAc3VwcHJlc3Mge3VudXNlZExvY2FsVmFyaWFibGVzfSBmIGlzIG9ubHkgdXNlZCBmb3IgbmVzdGVkIG1lc3NhZ2VzCiAqLwoKCnByb3RvLnBiLmNtcy5Sb2JvdExpc3RSZXF1ZXN0LnNlcmlhbGl6ZUJpbmFyeVRvV3JpdGVyID0gZnVuY3Rpb24gKG1lc3NhZ2UsIHdyaXRlcikgewogIHZhciBmID0gdW5kZWZpbmVkOwogIGYgPSBtZXNzYWdlLmdldFBhZ2VObygpOwoKICBpZiAoZiAhPT0gMCkgewogICAgd3JpdGVyLndyaXRlVWludDMyKDEsIGYpOwogIH0KCiAgZiA9IG1lc3NhZ2UuZ2V0UGFnZVNpemUoKTsKCiAgaWYgKGYgIT09IDApIHsKICAgIHdyaXRlci53cml0ZVVpbnQzMigyLCBmKTsKICB9CgogIGYgPSBtZXNzYWdlLmdldEFyZWFJZCgpOwoKICBpZiAoZiAhPT0gMCkgewogICAgd3JpdGVyLndyaXRlVWludDMyKDMsIGYpOwogIH0KCiAgZiA9IG1lc3NhZ2UuZ2V0RW5hYmxlKCk7CgogIGlmIChmKSB7CiAgICB3cml0ZXIud3JpdGVCb29sKDQsIGYpOwogIH0KCiAgZiA9IG1lc3NhZ2UuZ2V0Um9ib3RJZCgpOwoKICBpZiAoZiAhPT0gMCkgewogICAgd3JpdGVyLndyaXRlVWludDMyKDUsIGYpOwogIH0KfTsKLyoqCiAqIG9wdGlvbmFsIHVpbnQzMiBwYWdlX25vID0gMTsKICogQHJldHVybiB7bnVtYmVyfQogKi8KCgpwcm90by5wYi5jbXMuUm9ib3RMaXN0UmVxdWVzdC5wcm90b3R5cGUuZ2V0UGFnZU5vID0gZnVuY3Rpb24gKCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdCh0aGlzLCAxLCAwKTsKfTsKLyoqCiAqIEBwYXJhbSB7bnVtYmVyfSB2YWx1ZQogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLlJvYm90TGlzdFJlcXVlc3R9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuUm9ib3RMaXN0UmVxdWVzdC5wcm90b3R5cGUuc2V0UGFnZU5vID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRQcm90bzNJbnRGaWVsZCh0aGlzLCAxLCB2YWx1ZSk7Cn07Ci8qKgogKiBvcHRpb25hbCB1aW50MzIgcGFnZV9zaXplID0gMjsKICogQHJldHVybiB7bnVtYmVyfQogKi8KCgpwcm90by5wYi5jbXMuUm9ib3RMaXN0UmVxdWVzdC5wcm90b3R5cGUuZ2V0UGFnZVNpemUgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDIsIDApOwp9OwovKioKICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuUm9ib3RMaXN0UmVxdWVzdH0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5Sb2JvdExpc3RSZXF1ZXN0LnByb3RvdHlwZS5zZXRQYWdlU2l6ZSA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UHJvdG8zSW50RmllbGQodGhpcywgMiwgdmFsdWUpOwp9OwovKioKICogb3B0aW9uYWwgdWludDMyIGFyZWFfaWQgPSAzOwogKiBAcmV0dXJuIHtudW1iZXJ9CiAqLwoKCnByb3RvLnBiLmNtcy5Sb2JvdExpc3RSZXF1ZXN0LnByb3RvdHlwZS5nZXRBcmVhSWQgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDMsIDApOwp9OwovKioKICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuUm9ib3RMaXN0UmVxdWVzdH0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5Sb2JvdExpc3RSZXF1ZXN0LnByb3RvdHlwZS5zZXRBcmVhSWQgPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0ludEZpZWxkKHRoaXMsIDMsIHZhbHVlKTsKfTsKLyoqCiAqIG9wdGlvbmFsIGJvb2wgZW5hYmxlID0gNDsKICogQHJldHVybiB7Ym9vbGVhbn0KICovCgoKcHJvdG8ucGIuY21zLlJvYm90TGlzdFJlcXVlc3QucHJvdG90eXBlLmdldEVuYWJsZSA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldEJvb2xlYW5GaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDQsIGZhbHNlKTsKfTsKLyoqCiAqIEBwYXJhbSB7Ym9vbGVhbn0gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5Sb2JvdExpc3RSZXF1ZXN0fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLlJvYm90TGlzdFJlcXVlc3QucHJvdG90eXBlLnNldEVuYWJsZSA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UHJvdG8zQm9vbGVhbkZpZWxkKHRoaXMsIDQsIHZhbHVlKTsKfTsKLyoqCiAqIG9wdGlvbmFsIHVpbnQzMiByb2JvdF9pZCA9IDU7CiAqIEByZXR1cm4ge251bWJlcn0KICovCgoKcHJvdG8ucGIuY21zLlJvYm90TGlzdFJlcXVlc3QucHJvdG90eXBlLmdldFJvYm90SWQgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDUsIDApOwp9OwovKioKICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuUm9ib3RMaXN0UmVxdWVzdH0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5Sb2JvdExpc3RSZXF1ZXN0LnByb3RvdHlwZS5zZXRSb2JvdElkID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRQcm90bzNJbnRGaWVsZCh0aGlzLCA1LCB2YWx1ZSk7Cn07Ci8qKgogKiBMaXN0IG9mIHJlcGVhdGVkIGZpZWxkcyB3aXRoaW4gdGhpcyBtZXNzYWdlIHR5cGUuCiAqIEBwcml2YXRlIHshQXJyYXk8bnVtYmVyPn0KICogQGNvbnN0CiAqLwoKCnByb3RvLnBiLmNtcy5Sb2JvdExpc3RSZXBseS5yZXBlYXRlZEZpZWxkc18gPSBbMV07CgppZiAoanNwYi5NZXNzYWdlLkdFTkVSQVRFX1RPX09CSkVDVCkgewogIC8qKgogICAqIENyZWF0ZXMgYW4gb2JqZWN0IHJlcHJlc2VudGF0aW9uIG9mIHRoaXMgcHJvdG8uCiAgICogRmllbGQgbmFtZXMgdGhhdCBhcmUgcmVzZXJ2ZWQgaW4gSmF2YVNjcmlwdCBhbmQgd2lsbCBiZSByZW5hbWVkIHRvIHBiX25hbWUuCiAgICogT3B0aW9uYWwgZmllbGRzIHRoYXQgYXJlIG5vdCBzZXQgd2lsbCBiZSBzZXQgdG8gdW5kZWZpbmVkLgogICAqIFRvIGFjY2VzcyBhIHJlc2VydmVkIGZpZWxkIHVzZSwgZm9vLnBiXzxuYW1lPiwgZWcsIGZvby5wYl9kZWZhdWx0LgogICAqIEZvciB0aGUgbGlzdCBvZiByZXNlcnZlZCBuYW1lcyBwbGVhc2Ugc2VlOgogICAqICAgICBuZXQvcHJvdG8yL2NvbXBpbGVyL2pzL2ludGVybmFsL2dlbmVyYXRvci5jYyNrS2V5d29yZC4KICAgKiBAcGFyYW0ge2Jvb2xlYW49fSBvcHRfaW5jbHVkZUluc3RhbmNlIERlcHJlY2F0ZWQuIHdoZXRoZXIgdG8gaW5jbHVkZSB0aGUKICAgKiAgICAgSlNQQiBpbnN0YW5jZSBmb3IgdHJhbnNpdGlvbmFsIHNveSBwcm90byBzdXBwb3J0OgogICAqICAgICBodHRwOi8vZ290by9zb3ktcGFyYW0tbWlncmF0aW9uCiAgICogQHJldHVybiB7IU9iamVjdH0KICAgKi8KICBwcm90by5wYi5jbXMuUm9ib3RMaXN0UmVwbHkucHJvdG90eXBlLnRvT2JqZWN0ID0gZnVuY3Rpb24gKG9wdF9pbmNsdWRlSW5zdGFuY2UpIHsKICAgIHJldHVybiBwcm90by5wYi5jbXMuUm9ib3RMaXN0UmVwbHkudG9PYmplY3Qob3B0X2luY2x1ZGVJbnN0YW5jZSwgdGhpcyk7CiAgfTsKICAvKioKICAgKiBTdGF0aWMgdmVyc2lvbiBvZiB0aGUge0BzZWUgdG9PYmplY3R9IG1ldGhvZC4KICAgKiBAcGFyYW0ge2Jvb2xlYW58dW5kZWZpbmVkfSBpbmNsdWRlSW5zdGFuY2UgRGVwcmVjYXRlZC4gV2hldGhlciB0byBpbmNsdWRlCiAgICogICAgIHRoZSBKU1BCIGluc3RhbmNlIGZvciB0cmFuc2l0aW9uYWwgc295IHByb3RvIHN1cHBvcnQ6CiAgICogICAgIGh0dHA6Ly9nb3RvL3NveS1wYXJhbS1taWdyYXRpb24KICAgKiBAcGFyYW0geyFwcm90by5wYi5jbXMuUm9ib3RMaXN0UmVwbHl9IG1zZyBUaGUgbXNnIGluc3RhbmNlIHRvIHRyYW5zZm9ybS4KICAgKiBAcmV0dXJuIHshT2JqZWN0fQogICAqIEBzdXBwcmVzcyB7dW51c2VkTG9jYWxWYXJpYWJsZXN9IGYgaXMgb25seSB1c2VkIGZvciBuZXN0ZWQgbWVzc2FnZXMKICAgKi8KCgogIHByb3RvLnBiLmNtcy5Sb2JvdExpc3RSZXBseS50b09iamVjdCA9IGZ1bmN0aW9uIChpbmNsdWRlSW5zdGFuY2UsIG1zZykgewogICAgdmFyIGYsCiAgICAgICAgb2JqID0gewogICAgICByb2JvdHNMaXN0OiBqc3BiLk1lc3NhZ2UudG9PYmplY3RMaXN0KG1zZy5nZXRSb2JvdHNMaXN0KCksIGFuY2hvcnR5cGVfcGIuQW5jaG9yUHJvZmlsZS50b09iamVjdCwgaW5jbHVkZUluc3RhbmNlKSwKICAgICAgcGFnZU5vOiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdChtc2csIDIsIDApLAogICAgICBwYWdlU2l6ZToganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQobXNnLCAzLCAwKSwKICAgICAgdG90YWxQYWdlOiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdChtc2csIDQsIDApLAogICAgICB0b3RhbENvdW50OiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdChtc2csIDUsIDApCiAgICB9OwoKICAgIGlmIChpbmNsdWRlSW5zdGFuY2UpIHsKICAgICAgb2JqLiRqc3BiTWVzc2FnZUluc3RhbmNlID0gbXNnOwogICAgfQoKICAgIHJldHVybiBvYmo7CiAgfTsKfQovKioKICogRGVzZXJpYWxpemVzIGJpbmFyeSBkYXRhIChpbiBwcm90b2J1ZiB3aXJlIGZvcm1hdCkuCiAqIEBwYXJhbSB7anNwYi5CeXRlU291cmNlfSBieXRlcyBUaGUgYnl0ZXMgdG8gZGVzZXJpYWxpemUuCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuUm9ib3RMaXN0UmVwbHl9CiAqLwoKCnByb3RvLnBiLmNtcy5Sb2JvdExpc3RSZXBseS5kZXNlcmlhbGl6ZUJpbmFyeSA9IGZ1bmN0aW9uIChieXRlcykgewogIHZhciByZWFkZXIgPSBuZXcganNwYi5CaW5hcnlSZWFkZXIoYnl0ZXMpOwogIHZhciBtc2cgPSBuZXcgcHJvdG8ucGIuY21zLlJvYm90TGlzdFJlcGx5KCk7CiAgcmV0dXJuIHByb3RvLnBiLmNtcy5Sb2JvdExpc3RSZXBseS5kZXNlcmlhbGl6ZUJpbmFyeUZyb21SZWFkZXIobXNnLCByZWFkZXIpOwp9OwovKioKICogRGVzZXJpYWxpemVzIGJpbmFyeSBkYXRhIChpbiBwcm90b2J1ZiB3aXJlIGZvcm1hdCkgZnJvbSB0aGUKICogZ2l2ZW4gcmVhZGVyIGludG8gdGhlIGdpdmVuIG1lc3NhZ2Ugb2JqZWN0LgogKiBAcGFyYW0geyFwcm90by5wYi5jbXMuUm9ib3RMaXN0UmVwbHl9IG1zZyBUaGUgbWVzc2FnZSBvYmplY3QgdG8gZGVzZXJpYWxpemUgaW50by4KICogQHBhcmFtIHshanNwYi5CaW5hcnlSZWFkZXJ9IHJlYWRlciBUaGUgQmluYXJ5UmVhZGVyIHRvIHVzZS4KICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5Sb2JvdExpc3RSZXBseX0KICovCgoKcHJvdG8ucGIuY21zLlJvYm90TGlzdFJlcGx5LmRlc2VyaWFsaXplQmluYXJ5RnJvbVJlYWRlciA9IGZ1bmN0aW9uIChtc2csIHJlYWRlcikgewogIHdoaWxlIChyZWFkZXIubmV4dEZpZWxkKCkpIHsKICAgIGlmIChyZWFkZXIuaXNFbmRHcm91cCgpKSB7CiAgICAgIGJyZWFrOwogICAgfQoKICAgIHZhciBmaWVsZCA9IHJlYWRlci5nZXRGaWVsZE51bWJlcigpOwoKICAgIHN3aXRjaCAoZmllbGQpIHsKICAgICAgY2FzZSAxOgogICAgICAgIHZhciB2YWx1ZSA9IG5ldyBhbmNob3J0eXBlX3BiLkFuY2hvclByb2ZpbGUoKTsKICAgICAgICByZWFkZXIucmVhZE1lc3NhZ2UodmFsdWUsIGFuY2hvcnR5cGVfcGIuQW5jaG9yUHJvZmlsZS5kZXNlcmlhbGl6ZUJpbmFyeUZyb21SZWFkZXIpOwogICAgICAgIG1zZy5hZGRSb2JvdHModmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSAyOgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkVWludDMyKCk7CiAgICAgICAgbXNnLnNldFBhZ2VObyh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlIDM6CiAgICAgICAgdmFyIHZhbHVlID0gcmVhZGVyLnJlYWRVaW50MzIoKTsKICAgICAgICBtc2cuc2V0UGFnZVNpemUodmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSA0OgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkVWludDMyKCk7CiAgICAgICAgbXNnLnNldFRvdGFsUGFnZSh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlIDU6CiAgICAgICAgdmFyIHZhbHVlID0gcmVhZGVyLnJlYWRVaW50MzIoKTsKICAgICAgICBtc2cuc2V0VG90YWxDb3VudCh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBkZWZhdWx0OgogICAgICAgIHJlYWRlci5za2lwRmllbGQoKTsKICAgICAgICBicmVhazsKICAgIH0KICB9CgogIHJldHVybiBtc2c7Cn07Ci8qKgogKiBTZXJpYWxpemVzIHRoZSBtZXNzYWdlIHRvIGJpbmFyeSBkYXRhIChpbiBwcm90b2J1ZiB3aXJlIGZvcm1hdCkuCiAqIEByZXR1cm4geyFVaW50OEFycmF5fQogKi8KCgpwcm90by5wYi5jbXMuUm9ib3RMaXN0UmVwbHkucHJvdG90eXBlLnNlcmlhbGl6ZUJpbmFyeSA9IGZ1bmN0aW9uICgpIHsKICB2YXIgd3JpdGVyID0gbmV3IGpzcGIuQmluYXJ5V3JpdGVyKCk7CiAgcHJvdG8ucGIuY21zLlJvYm90TGlzdFJlcGx5LnNlcmlhbGl6ZUJpbmFyeVRvV3JpdGVyKHRoaXMsIHdyaXRlcik7CiAgcmV0dXJuIHdyaXRlci5nZXRSZXN1bHRCdWZmZXIoKTsKfTsKLyoqCiAqIFNlcmlhbGl6ZXMgdGhlIGdpdmVuIG1lc3NhZ2UgdG8gYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUKICogZm9ybWF0KSwgd3JpdGluZyB0byB0aGUgZ2l2ZW4gQmluYXJ5V3JpdGVyLgogKiBAcGFyYW0geyFwcm90by5wYi5jbXMuUm9ib3RMaXN0UmVwbHl9IG1lc3NhZ2UKICogQHBhcmFtIHshanNwYi5CaW5hcnlXcml0ZXJ9IHdyaXRlcgogKiBAc3VwcHJlc3Mge3VudXNlZExvY2FsVmFyaWFibGVzfSBmIGlzIG9ubHkgdXNlZCBmb3IgbmVzdGVkIG1lc3NhZ2VzCiAqLwoKCnByb3RvLnBiLmNtcy5Sb2JvdExpc3RSZXBseS5zZXJpYWxpemVCaW5hcnlUb1dyaXRlciA9IGZ1bmN0aW9uIChtZXNzYWdlLCB3cml0ZXIpIHsKICB2YXIgZiA9IHVuZGVmaW5lZDsKICBmID0gbWVzc2FnZS5nZXRSb2JvdHNMaXN0KCk7CgogIGlmIChmLmxlbmd0aCA+IDApIHsKICAgIHdyaXRlci53cml0ZVJlcGVhdGVkTWVzc2FnZSgxLCBmLCBhbmNob3J0eXBlX3BiLkFuY2hvclByb2ZpbGUuc2VyaWFsaXplQmluYXJ5VG9Xcml0ZXIpOwogIH0KCiAgZiA9IG1lc3NhZ2UuZ2V0UGFnZU5vKCk7CgogIGlmIChmICE9PSAwKSB7CiAgICB3cml0ZXIud3JpdGVVaW50MzIoMiwgZik7CiAgfQoKICBmID0gbWVzc2FnZS5nZXRQYWdlU2l6ZSgpOwoKICBpZiAoZiAhPT0gMCkgewogICAgd3JpdGVyLndyaXRlVWludDMyKDMsIGYpOwogIH0KCiAgZiA9IG1lc3NhZ2UuZ2V0VG90YWxQYWdlKCk7CgogIGlmIChmICE9PSAwKSB7CiAgICB3cml0ZXIud3JpdGVVaW50MzIoNCwgZik7CiAgfQoKICBmID0gbWVzc2FnZS5nZXRUb3RhbENvdW50KCk7CgogIGlmIChmICE9PSAwKSB7CiAgICB3cml0ZXIud3JpdGVVaW50MzIoNSwgZik7CiAgfQp9OwovKioKICogcmVwZWF0ZWQgcGIuQW5jaG9yUHJvZmlsZSByb2JvdHMgPSAxOwogKiBAcmV0dXJuIHshQXJyYXk8IXByb3RvLnBiLkFuY2hvclByb2ZpbGU+fQogKi8KCgpwcm90by5wYi5jbXMuUm9ib3RMaXN0UmVwbHkucHJvdG90eXBlLmdldFJvYm90c0xpc3QgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRSZXBlYXRlZFdyYXBwZXJGaWVsZCh0aGlzLCBhbmNob3J0eXBlX3BiLkFuY2hvclByb2ZpbGUsIDEpOwp9OwovKioKICogQHBhcmFtIHshQXJyYXk8IXByb3RvLnBiLkFuY2hvclByb2ZpbGU+fSB2YWx1ZQogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLlJvYm90TGlzdFJlcGx5fSByZXR1cm5zIHRoaXMKKi8KCgpwcm90by5wYi5jbXMuUm9ib3RMaXN0UmVwbHkucHJvdG90eXBlLnNldFJvYm90c0xpc3QgPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFJlcGVhdGVkV3JhcHBlckZpZWxkKHRoaXMsIDEsIHZhbHVlKTsKfTsKLyoqCiAqIEBwYXJhbSB7IXByb3RvLnBiLkFuY2hvclByb2ZpbGU9fSBvcHRfdmFsdWUKICogQHBhcmFtIHtudW1iZXI9fSBvcHRfaW5kZXgKICogQHJldHVybiB7IXByb3RvLnBiLkFuY2hvclByb2ZpbGV9CiAqLwoKCnByb3RvLnBiLmNtcy5Sb2JvdExpc3RSZXBseS5wcm90b3R5cGUuYWRkUm9ib3RzID0gZnVuY3Rpb24gKG9wdF92YWx1ZSwgb3B0X2luZGV4KSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5hZGRUb1JlcGVhdGVkV3JhcHBlckZpZWxkKHRoaXMsIDEsIG9wdF92YWx1ZSwgcHJvdG8ucGIuQW5jaG9yUHJvZmlsZSwgb3B0X2luZGV4KTsKfTsKLyoqCiAqIENsZWFycyB0aGUgbGlzdCBtYWtpbmcgaXQgZW1wdHkgYnV0IG5vbi1udWxsLgogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLlJvYm90TGlzdFJlcGx5fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLlJvYm90TGlzdFJlcGx5LnByb3RvdHlwZS5jbGVhclJvYm90c0xpc3QgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIHRoaXMuc2V0Um9ib3RzTGlzdChbXSk7Cn07Ci8qKgogKiBvcHRpb25hbCB1aW50MzIgcGFnZV9ubyA9IDI7CiAqIEByZXR1cm4ge251bWJlcn0KICovCgoKcHJvdG8ucGIuY21zLlJvYm90TGlzdFJlcGx5LnByb3RvdHlwZS5nZXRQYWdlTm8gPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDIsIDApOwp9OwovKioKICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuUm9ib3RMaXN0UmVwbHl9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuUm9ib3RMaXN0UmVwbHkucHJvdG90eXBlLnNldFBhZ2VObyA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UHJvdG8zSW50RmllbGQodGhpcywgMiwgdmFsdWUpOwp9OwovKioKICogb3B0aW9uYWwgdWludDMyIHBhZ2Vfc2l6ZSA9IDM7CiAqIEByZXR1cm4ge251bWJlcn0KICovCgoKcHJvdG8ucGIuY21zLlJvYm90TGlzdFJlcGx5LnByb3RvdHlwZS5nZXRQYWdlU2l6ZSA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQodGhpcywgMywgMCk7Cn07Ci8qKgogKiBAcGFyYW0ge251bWJlcn0gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5Sb2JvdExpc3RSZXBseX0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5Sb2JvdExpc3RSZXBseS5wcm90b3R5cGUuc2V0UGFnZVNpemUgPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0ludEZpZWxkKHRoaXMsIDMsIHZhbHVlKTsKfTsKLyoqCiAqIG9wdGlvbmFsIHVpbnQzMiB0b3RhbF9wYWdlID0gNDsKICogQHJldHVybiB7bnVtYmVyfQogKi8KCgpwcm90by5wYi5jbXMuUm9ib3RMaXN0UmVwbHkucHJvdG90eXBlLmdldFRvdGFsUGFnZSA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQodGhpcywgNCwgMCk7Cn07Ci8qKgogKiBAcGFyYW0ge251bWJlcn0gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5Sb2JvdExpc3RSZXBseX0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5Sb2JvdExpc3RSZXBseS5wcm90b3R5cGUuc2V0VG90YWxQYWdlID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRQcm90bzNJbnRGaWVsZCh0aGlzLCA0LCB2YWx1ZSk7Cn07Ci8qKgogKiBvcHRpb25hbCB1aW50MzIgdG90YWxfY291bnQgPSA1OwogKiBAcmV0dXJuIHtudW1iZXJ9CiAqLwoKCnByb3RvLnBiLmNtcy5Sb2JvdExpc3RSZXBseS5wcm90b3R5cGUuZ2V0VG90YWxDb3VudCA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQodGhpcywgNSwgMCk7Cn07Ci8qKgogKiBAcGFyYW0ge251bWJlcn0gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5Sb2JvdExpc3RSZXBseX0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5Sb2JvdExpc3RSZXBseS5wcm90b3R5cGUuc2V0VG90YWxDb3VudCA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UHJvdG8zSW50RmllbGQodGhpcywgNSwgdmFsdWUpOwp9OwoKaWYgKGpzcGIuTWVzc2FnZS5HRU5FUkFURV9UT19PQkpFQ1QpIHsKICAvKioKICAgKiBDcmVhdGVzIGFuIG9iamVjdCByZXByZXNlbnRhdGlvbiBvZiB0aGlzIHByb3RvLgogICAqIEZpZWxkIG5hbWVzIHRoYXQgYXJlIHJlc2VydmVkIGluIEphdmFTY3JpcHQgYW5kIHdpbGwgYmUgcmVuYW1lZCB0byBwYl9uYW1lLgogICAqIE9wdGlvbmFsIGZpZWxkcyB0aGF0IGFyZSBub3Qgc2V0IHdpbGwgYmUgc2V0IHRvIHVuZGVmaW5lZC4KICAgKiBUbyBhY2Nlc3MgYSByZXNlcnZlZCBmaWVsZCB1c2UsIGZvby5wYl88bmFtZT4sIGVnLCBmb28ucGJfZGVmYXVsdC4KICAgKiBGb3IgdGhlIGxpc3Qgb2YgcmVzZXJ2ZWQgbmFtZXMgcGxlYXNlIHNlZToKICAgKiAgICAgbmV0L3Byb3RvMi9jb21waWxlci9qcy9pbnRlcm5hbC9nZW5lcmF0b3IuY2Mja0tleXdvcmQuCiAgICogQHBhcmFtIHtib29sZWFuPX0gb3B0X2luY2x1ZGVJbnN0YW5jZSBEZXByZWNhdGVkLiB3aGV0aGVyIHRvIGluY2x1ZGUgdGhlCiAgICogICAgIEpTUEIgaW5zdGFuY2UgZm9yIHRyYW5zaXRpb25hbCBzb3kgcHJvdG8gc3VwcG9ydDoKICAgKiAgICAgaHR0cDovL2dvdG8vc295LXBhcmFtLW1pZ3JhdGlvbgogICAqIEByZXR1cm4geyFPYmplY3R9CiAgICovCiAgcHJvdG8ucGIuY21zLlJvYm90TWVzc2FnZUxpc3RSZXF1ZXN0LnByb3RvdHlwZS50b09iamVjdCA9IGZ1bmN0aW9uIChvcHRfaW5jbHVkZUluc3RhbmNlKSB7CiAgICByZXR1cm4gcHJvdG8ucGIuY21zLlJvYm90TWVzc2FnZUxpc3RSZXF1ZXN0LnRvT2JqZWN0KG9wdF9pbmNsdWRlSW5zdGFuY2UsIHRoaXMpOwogIH07CiAgLyoqCiAgICogU3RhdGljIHZlcnNpb24gb2YgdGhlIHtAc2VlIHRvT2JqZWN0fSBtZXRob2QuCiAgICogQHBhcmFtIHtib29sZWFufHVuZGVmaW5lZH0gaW5jbHVkZUluc3RhbmNlIERlcHJlY2F0ZWQuIFdoZXRoZXIgdG8gaW5jbHVkZQogICAqICAgICB0aGUgSlNQQiBpbnN0YW5jZSBmb3IgdHJhbnNpdGlvbmFsIHNveSBwcm90byBzdXBwb3J0OgogICAqICAgICBodHRwOi8vZ290by9zb3ktcGFyYW0tbWlncmF0aW9uCiAgICogQHBhcmFtIHshcHJvdG8ucGIuY21zLlJvYm90TWVzc2FnZUxpc3RSZXF1ZXN0fSBtc2cgVGhlIG1zZyBpbnN0YW5jZSB0byB0cmFuc2Zvcm0uCiAgICogQHJldHVybiB7IU9iamVjdH0KICAgKiBAc3VwcHJlc3Mge3VudXNlZExvY2FsVmFyaWFibGVzfSBmIGlzIG9ubHkgdXNlZCBmb3IgbmVzdGVkIG1lc3NhZ2VzCiAgICovCgoKICBwcm90by5wYi5jbXMuUm9ib3RNZXNzYWdlTGlzdFJlcXVlc3QudG9PYmplY3QgPSBmdW5jdGlvbiAoaW5jbHVkZUluc3RhbmNlLCBtc2cpIHsKICAgIHZhciBmLAogICAgICAgIG9iaiA9IHsKICAgICAgcm9ib3RJZDoganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQobXNnLCAxLCAwKQogICAgfTsKCiAgICBpZiAoaW5jbHVkZUluc3RhbmNlKSB7CiAgICAgIG9iai4kanNwYk1lc3NhZ2VJbnN0YW5jZSA9IG1zZzsKICAgIH0KCiAgICByZXR1cm4gb2JqOwogIH07Cn0KLyoqCiAqIERlc2VyaWFsaXplcyBiaW5hcnkgZGF0YSAoaW4gcHJvdG9idWYgd2lyZSBmb3JtYXQpLgogKiBAcGFyYW0ge2pzcGIuQnl0ZVNvdXJjZX0gYnl0ZXMgVGhlIGJ5dGVzIHRvIGRlc2VyaWFsaXplLgogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLlJvYm90TWVzc2FnZUxpc3RSZXF1ZXN0fQogKi8KCgpwcm90by5wYi5jbXMuUm9ib3RNZXNzYWdlTGlzdFJlcXVlc3QuZGVzZXJpYWxpemVCaW5hcnkgPSBmdW5jdGlvbiAoYnl0ZXMpIHsKICB2YXIgcmVhZGVyID0gbmV3IGpzcGIuQmluYXJ5UmVhZGVyKGJ5dGVzKTsKICB2YXIgbXNnID0gbmV3IHByb3RvLnBiLmNtcy5Sb2JvdE1lc3NhZ2VMaXN0UmVxdWVzdCgpOwogIHJldHVybiBwcm90by5wYi5jbXMuUm9ib3RNZXNzYWdlTGlzdFJlcXVlc3QuZGVzZXJpYWxpemVCaW5hcnlGcm9tUmVhZGVyKG1zZywgcmVhZGVyKTsKfTsKLyoqCiAqIERlc2VyaWFsaXplcyBiaW5hcnkgZGF0YSAoaW4gcHJvdG9idWYgd2lyZSBmb3JtYXQpIGZyb20gdGhlCiAqIGdpdmVuIHJlYWRlciBpbnRvIHRoZSBnaXZlbiBtZXNzYWdlIG9iamVjdC4KICogQHBhcmFtIHshcHJvdG8ucGIuY21zLlJvYm90TWVzc2FnZUxpc3RSZXF1ZXN0fSBtc2cgVGhlIG1lc3NhZ2Ugb2JqZWN0IHRvIGRlc2VyaWFsaXplIGludG8uCiAqIEBwYXJhbSB7IWpzcGIuQmluYXJ5UmVhZGVyfSByZWFkZXIgVGhlIEJpbmFyeVJlYWRlciB0byB1c2UuCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuUm9ib3RNZXNzYWdlTGlzdFJlcXVlc3R9CiAqLwoKCnByb3RvLnBiLmNtcy5Sb2JvdE1lc3NhZ2VMaXN0UmVxdWVzdC5kZXNlcmlhbGl6ZUJpbmFyeUZyb21SZWFkZXIgPSBmdW5jdGlvbiAobXNnLCByZWFkZXIpIHsKICB3aGlsZSAocmVhZGVyLm5leHRGaWVsZCgpKSB7CiAgICBpZiAocmVhZGVyLmlzRW5kR3JvdXAoKSkgewogICAgICBicmVhazsKICAgIH0KCiAgICB2YXIgZmllbGQgPSByZWFkZXIuZ2V0RmllbGROdW1iZXIoKTsKCiAgICBzd2l0Y2ggKGZpZWxkKSB7CiAgICAgIGNhc2UgMToKICAgICAgICB2YXIgdmFsdWUgPSByZWFkZXIucmVhZFVpbnQzMigpOwogICAgICAgIG1zZy5zZXRSb2JvdElkKHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGRlZmF1bHQ6CiAgICAgICAgcmVhZGVyLnNraXBGaWVsZCgpOwogICAgICAgIGJyZWFrOwogICAgfQogIH0KCiAgcmV0dXJuIG1zZzsKfTsKLyoqCiAqIFNlcmlhbGl6ZXMgdGhlIG1lc3NhZ2UgdG8gYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUgZm9ybWF0KS4KICogQHJldHVybiB7IVVpbnQ4QXJyYXl9CiAqLwoKCnByb3RvLnBiLmNtcy5Sb2JvdE1lc3NhZ2VMaXN0UmVxdWVzdC5wcm90b3R5cGUuc2VyaWFsaXplQmluYXJ5ID0gZnVuY3Rpb24gKCkgewogIHZhciB3cml0ZXIgPSBuZXcganNwYi5CaW5hcnlXcml0ZXIoKTsKICBwcm90by5wYi5jbXMuUm9ib3RNZXNzYWdlTGlzdFJlcXVlc3Quc2VyaWFsaXplQmluYXJ5VG9Xcml0ZXIodGhpcywgd3JpdGVyKTsKICByZXR1cm4gd3JpdGVyLmdldFJlc3VsdEJ1ZmZlcigpOwp9OwovKioKICogU2VyaWFsaXplcyB0aGUgZ2l2ZW4gbWVzc2FnZSB0byBiaW5hcnkgZGF0YSAoaW4gcHJvdG9idWYgd2lyZQogKiBmb3JtYXQpLCB3cml0aW5nIHRvIHRoZSBnaXZlbiBCaW5hcnlXcml0ZXIuCiAqIEBwYXJhbSB7IXByb3RvLnBiLmNtcy5Sb2JvdE1lc3NhZ2VMaXN0UmVxdWVzdH0gbWVzc2FnZQogKiBAcGFyYW0geyFqc3BiLkJpbmFyeVdyaXRlcn0gd3JpdGVyCiAqIEBzdXBwcmVzcyB7dW51c2VkTG9jYWxWYXJpYWJsZXN9IGYgaXMgb25seSB1c2VkIGZvciBuZXN0ZWQgbWVzc2FnZXMKICovCgoKcHJvdG8ucGIuY21zLlJvYm90TWVzc2FnZUxpc3RSZXF1ZXN0LnNlcmlhbGl6ZUJpbmFyeVRvV3JpdGVyID0gZnVuY3Rpb24gKG1lc3NhZ2UsIHdyaXRlcikgewogIHZhciBmID0gdW5kZWZpbmVkOwogIGYgPSBtZXNzYWdlLmdldFJvYm90SWQoKTsKCiAgaWYgKGYgIT09IDApIHsKICAgIHdyaXRlci53cml0ZVVpbnQzMigxLCBmKTsKICB9Cn07Ci8qKgogKiBvcHRpb25hbCB1aW50MzIgcm9ib3RfaWQgPSAxOwogKiBAcmV0dXJuIHtudW1iZXJ9CiAqLwoKCnByb3RvLnBiLmNtcy5Sb2JvdE1lc3NhZ2VMaXN0UmVxdWVzdC5wcm90b3R5cGUuZ2V0Um9ib3RJZCA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQodGhpcywgMSwgMCk7Cn07Ci8qKgogKiBAcGFyYW0ge251bWJlcn0gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5Sb2JvdE1lc3NhZ2VMaXN0UmVxdWVzdH0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5Sb2JvdE1lc3NhZ2VMaXN0UmVxdWVzdC5wcm90b3R5cGUuc2V0Um9ib3RJZCA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UHJvdG8zSW50RmllbGQodGhpcywgMSwgdmFsdWUpOwp9OwovKioKICogTGlzdCBvZiByZXBlYXRlZCBmaWVsZHMgd2l0aGluIHRoaXMgbWVzc2FnZSB0eXBlLgogKiBAcHJpdmF0ZSB7IUFycmF5PG51bWJlcj59CiAqIEBjb25zdAogKi8KCgpwcm90by5wYi5jbXMuUm9ib3RNZXNzYWdlTGlzdFJlcGx5LnJlcGVhdGVkRmllbGRzXyA9IFsxXTsKCmlmIChqc3BiLk1lc3NhZ2UuR0VORVJBVEVfVE9fT0JKRUNUKSB7CiAgLyoqCiAgICogQ3JlYXRlcyBhbiBvYmplY3QgcmVwcmVzZW50YXRpb24gb2YgdGhpcyBwcm90by4KICAgKiBGaWVsZCBuYW1lcyB0aGF0IGFyZSByZXNlcnZlZCBpbiBKYXZhU2NyaXB0IGFuZCB3aWxsIGJlIHJlbmFtZWQgdG8gcGJfbmFtZS4KICAgKiBPcHRpb25hbCBmaWVsZHMgdGhhdCBhcmUgbm90IHNldCB3aWxsIGJlIHNldCB0byB1bmRlZmluZWQuCiAgICogVG8gYWNjZXNzIGEgcmVzZXJ2ZWQgZmllbGQgdXNlLCBmb28ucGJfPG5hbWU+LCBlZywgZm9vLnBiX2RlZmF1bHQuCiAgICogRm9yIHRoZSBsaXN0IG9mIHJlc2VydmVkIG5hbWVzIHBsZWFzZSBzZWU6CiAgICogICAgIG5ldC9wcm90bzIvY29tcGlsZXIvanMvaW50ZXJuYWwvZ2VuZXJhdG9yLmNjI2tLZXl3b3JkLgogICAqIEBwYXJhbSB7Ym9vbGVhbj19IG9wdF9pbmNsdWRlSW5zdGFuY2UgRGVwcmVjYXRlZC4gd2hldGhlciB0byBpbmNsdWRlIHRoZQogICAqICAgICBKU1BCIGluc3RhbmNlIGZvciB0cmFuc2l0aW9uYWwgc295IHByb3RvIHN1cHBvcnQ6CiAgICogICAgIGh0dHA6Ly9nb3RvL3NveS1wYXJhbS1taWdyYXRpb24KICAgKiBAcmV0dXJuIHshT2JqZWN0fQogICAqLwogIHByb3RvLnBiLmNtcy5Sb2JvdE1lc3NhZ2VMaXN0UmVwbHkucHJvdG90eXBlLnRvT2JqZWN0ID0gZnVuY3Rpb24gKG9wdF9pbmNsdWRlSW5zdGFuY2UpIHsKICAgIHJldHVybiBwcm90by5wYi5jbXMuUm9ib3RNZXNzYWdlTGlzdFJlcGx5LnRvT2JqZWN0KG9wdF9pbmNsdWRlSW5zdGFuY2UsIHRoaXMpOwogIH07CiAgLyoqCiAgICogU3RhdGljIHZlcnNpb24gb2YgdGhlIHtAc2VlIHRvT2JqZWN0fSBtZXRob2QuCiAgICogQHBhcmFtIHtib29sZWFufHVuZGVmaW5lZH0gaW5jbHVkZUluc3RhbmNlIERlcHJlY2F0ZWQuIFdoZXRoZXIgdG8gaW5jbHVkZQogICAqICAgICB0aGUgSlNQQiBpbnN0YW5jZSBmb3IgdHJhbnNpdGlvbmFsIHNveSBwcm90byBzdXBwb3J0OgogICAqICAgICBodHRwOi8vZ290by9zb3ktcGFyYW0tbWlncmF0aW9uCiAgICogQHBhcmFtIHshcHJvdG8ucGIuY21zLlJvYm90TWVzc2FnZUxpc3RSZXBseX0gbXNnIFRoZSBtc2cgaW5zdGFuY2UgdG8gdHJhbnNmb3JtLgogICAqIEByZXR1cm4geyFPYmplY3R9CiAgICogQHN1cHByZXNzIHt1bnVzZWRMb2NhbFZhcmlhYmxlc30gZiBpcyBvbmx5IHVzZWQgZm9yIG5lc3RlZCBtZXNzYWdlcwogICAqLwoKCiAgcHJvdG8ucGIuY21zLlJvYm90TWVzc2FnZUxpc3RSZXBseS50b09iamVjdCA9IGZ1bmN0aW9uIChpbmNsdWRlSW5zdGFuY2UsIG1zZykgewogICAgdmFyIGYsCiAgICAgICAgb2JqID0gewogICAgICBtZXNzYWdlc0xpc3Q6IGpzcGIuTWVzc2FnZS50b09iamVjdExpc3QobXNnLmdldE1lc3NhZ2VzTGlzdCgpLCBjbXN0eXBlX3BiLlJvYm90TWVzc2FnZS50b09iamVjdCwgaW5jbHVkZUluc3RhbmNlKQogICAgfTsKCiAgICBpZiAoaW5jbHVkZUluc3RhbmNlKSB7CiAgICAgIG9iai4kanNwYk1lc3NhZ2VJbnN0YW5jZSA9IG1zZzsKICAgIH0KCiAgICByZXR1cm4gb2JqOwogIH07Cn0KLyoqCiAqIERlc2VyaWFsaXplcyBiaW5hcnkgZGF0YSAoaW4gcHJvdG9idWYgd2lyZSBmb3JtYXQpLgogKiBAcGFyYW0ge2pzcGIuQnl0ZVNvdXJjZX0gYnl0ZXMgVGhlIGJ5dGVzIHRvIGRlc2VyaWFsaXplLgogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLlJvYm90TWVzc2FnZUxpc3RSZXBseX0KICovCgoKcHJvdG8ucGIuY21zLlJvYm90TWVzc2FnZUxpc3RSZXBseS5kZXNlcmlhbGl6ZUJpbmFyeSA9IGZ1bmN0aW9uIChieXRlcykgewogIHZhciByZWFkZXIgPSBuZXcganNwYi5CaW5hcnlSZWFkZXIoYnl0ZXMpOwogIHZhciBtc2cgPSBuZXcgcHJvdG8ucGIuY21zLlJvYm90TWVzc2FnZUxpc3RSZXBseSgpOwogIHJldHVybiBwcm90by5wYi5jbXMuUm9ib3RNZXNzYWdlTGlzdFJlcGx5LmRlc2VyaWFsaXplQmluYXJ5RnJvbVJlYWRlcihtc2csIHJlYWRlcik7Cn07Ci8qKgogKiBEZXNlcmlhbGl6ZXMgYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUgZm9ybWF0KSBmcm9tIHRoZQogKiBnaXZlbiByZWFkZXIgaW50byB0aGUgZ2l2ZW4gbWVzc2FnZSBvYmplY3QuCiAqIEBwYXJhbSB7IXByb3RvLnBiLmNtcy5Sb2JvdE1lc3NhZ2VMaXN0UmVwbHl9IG1zZyBUaGUgbWVzc2FnZSBvYmplY3QgdG8gZGVzZXJpYWxpemUgaW50by4KICogQHBhcmFtIHshanNwYi5CaW5hcnlSZWFkZXJ9IHJlYWRlciBUaGUgQmluYXJ5UmVhZGVyIHRvIHVzZS4KICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5Sb2JvdE1lc3NhZ2VMaXN0UmVwbHl9CiAqLwoKCnByb3RvLnBiLmNtcy5Sb2JvdE1lc3NhZ2VMaXN0UmVwbHkuZGVzZXJpYWxpemVCaW5hcnlGcm9tUmVhZGVyID0gZnVuY3Rpb24gKG1zZywgcmVhZGVyKSB7CiAgd2hpbGUgKHJlYWRlci5uZXh0RmllbGQoKSkgewogICAgaWYgKHJlYWRlci5pc0VuZEdyb3VwKCkpIHsKICAgICAgYnJlYWs7CiAgICB9CgogICAgdmFyIGZpZWxkID0gcmVhZGVyLmdldEZpZWxkTnVtYmVyKCk7CgogICAgc3dpdGNoIChmaWVsZCkgewogICAgICBjYXNlIDE6CiAgICAgICAgdmFyIHZhbHVlID0gbmV3IGNtc3R5cGVfcGIuUm9ib3RNZXNzYWdlKCk7CiAgICAgICAgcmVhZGVyLnJlYWRNZXNzYWdlKHZhbHVlLCBjbXN0eXBlX3BiLlJvYm90TWVzc2FnZS5kZXNlcmlhbGl6ZUJpbmFyeUZyb21SZWFkZXIpOwogICAgICAgIG1zZy5hZGRNZXNzYWdlcyh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBkZWZhdWx0OgogICAgICAgIHJlYWRlci5za2lwRmllbGQoKTsKICAgICAgICBicmVhazsKICAgIH0KICB9CgogIHJldHVybiBtc2c7Cn07Ci8qKgogKiBTZXJpYWxpemVzIHRoZSBtZXNzYWdlIHRvIGJpbmFyeSBkYXRhIChpbiBwcm90b2J1ZiB3aXJlIGZvcm1hdCkuCiAqIEByZXR1cm4geyFVaW50OEFycmF5fQogKi8KCgpwcm90by5wYi5jbXMuUm9ib3RNZXNzYWdlTGlzdFJlcGx5LnByb3RvdHlwZS5zZXJpYWxpemVCaW5hcnkgPSBmdW5jdGlvbiAoKSB7CiAgdmFyIHdyaXRlciA9IG5ldyBqc3BiLkJpbmFyeVdyaXRlcigpOwogIHByb3RvLnBiLmNtcy5Sb2JvdE1lc3NhZ2VMaXN0UmVwbHkuc2VyaWFsaXplQmluYXJ5VG9Xcml0ZXIodGhpcywgd3JpdGVyKTsKICByZXR1cm4gd3JpdGVyLmdldFJlc3VsdEJ1ZmZlcigpOwp9OwovKioKICogU2VyaWFsaXplcyB0aGUgZ2l2ZW4gbWVzc2FnZSB0byBiaW5hcnkgZGF0YSAoaW4gcHJvdG9idWYgd2lyZQogKiBmb3JtYXQpLCB3cml0aW5nIHRvIHRoZSBnaXZlbiBCaW5hcnlXcml0ZXIuCiAqIEBwYXJhbSB7IXByb3RvLnBiLmNtcy5Sb2JvdE1lc3NhZ2VMaXN0UmVwbHl9IG1lc3NhZ2UKICogQHBhcmFtIHshanNwYi5CaW5hcnlXcml0ZXJ9IHdyaXRlcgogKiBAc3VwcHJlc3Mge3VudXNlZExvY2FsVmFyaWFibGVzfSBmIGlzIG9ubHkgdXNlZCBmb3IgbmVzdGVkIG1lc3NhZ2VzCiAqLwoKCnByb3RvLnBiLmNtcy5Sb2JvdE1lc3NhZ2VMaXN0UmVwbHkuc2VyaWFsaXplQmluYXJ5VG9Xcml0ZXIgPSBmdW5jdGlvbiAobWVzc2FnZSwgd3JpdGVyKSB7CiAgdmFyIGYgPSB1bmRlZmluZWQ7CiAgZiA9IG1lc3NhZ2UuZ2V0TWVzc2FnZXNMaXN0KCk7CgogIGlmIChmLmxlbmd0aCA+IDApIHsKICAgIHdyaXRlci53cml0ZVJlcGVhdGVkTWVzc2FnZSgxLCBmLCBjbXN0eXBlX3BiLlJvYm90TWVzc2FnZS5zZXJpYWxpemVCaW5hcnlUb1dyaXRlcik7CiAgfQp9OwovKioKICogcmVwZWF0ZWQgcGIuUm9ib3RNZXNzYWdlIG1lc3NhZ2VzID0gMTsKICogQHJldHVybiB7IUFycmF5PCFwcm90by5wYi5Sb2JvdE1lc3NhZ2U+fQogKi8KCgpwcm90by5wYi5jbXMuUm9ib3RNZXNzYWdlTGlzdFJlcGx5LnByb3RvdHlwZS5nZXRNZXNzYWdlc0xpc3QgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRSZXBlYXRlZFdyYXBwZXJGaWVsZCh0aGlzLCBjbXN0eXBlX3BiLlJvYm90TWVzc2FnZSwgMSk7Cn07Ci8qKgogKiBAcGFyYW0geyFBcnJheTwhcHJvdG8ucGIuUm9ib3RNZXNzYWdlPn0gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5Sb2JvdE1lc3NhZ2VMaXN0UmVwbHl9IHJldHVybnMgdGhpcwoqLwoKCnByb3RvLnBiLmNtcy5Sb2JvdE1lc3NhZ2VMaXN0UmVwbHkucHJvdG90eXBlLnNldE1lc3NhZ2VzTGlzdCA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UmVwZWF0ZWRXcmFwcGVyRmllbGQodGhpcywgMSwgdmFsdWUpOwp9OwovKioKICogQHBhcmFtIHshcHJvdG8ucGIuUm9ib3RNZXNzYWdlPX0gb3B0X3ZhbHVlCiAqIEBwYXJhbSB7bnVtYmVyPX0gb3B0X2luZGV4CiAqIEByZXR1cm4geyFwcm90by5wYi5Sb2JvdE1lc3NhZ2V9CiAqLwoKCnByb3RvLnBiLmNtcy5Sb2JvdE1lc3NhZ2VMaXN0UmVwbHkucHJvdG90eXBlLmFkZE1lc3NhZ2VzID0gZnVuY3Rpb24gKG9wdF92YWx1ZSwgb3B0X2luZGV4KSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5hZGRUb1JlcGVhdGVkV3JhcHBlckZpZWxkKHRoaXMsIDEsIG9wdF92YWx1ZSwgcHJvdG8ucGIuUm9ib3RNZXNzYWdlLCBvcHRfaW5kZXgpOwp9OwovKioKICogQ2xlYXJzIHRoZSBsaXN0IG1ha2luZyBpdCBlbXB0eSBidXQgbm9uLW51bGwuCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuUm9ib3RNZXNzYWdlTGlzdFJlcGx5fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLlJvYm90TWVzc2FnZUxpc3RSZXBseS5wcm90b3R5cGUuY2xlYXJNZXNzYWdlc0xpc3QgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIHRoaXMuc2V0TWVzc2FnZXNMaXN0KFtdKTsKfTsKCmlmIChqc3BiLk1lc3NhZ2UuR0VORVJBVEVfVE9fT0JKRUNUKSB7CiAgLyoqCiAgICogQ3JlYXRlcyBhbiBvYmplY3QgcmVwcmVzZW50YXRpb24gb2YgdGhpcyBwcm90by4KICAgKiBGaWVsZCBuYW1lcyB0aGF0IGFyZSByZXNlcnZlZCBpbiBKYXZhU2NyaXB0IGFuZCB3aWxsIGJlIHJlbmFtZWQgdG8gcGJfbmFtZS4KICAgKiBPcHRpb25hbCBmaWVsZHMgdGhhdCBhcmUgbm90IHNldCB3aWxsIGJlIHNldCB0byB1bmRlZmluZWQuCiAgICogVG8gYWNjZXNzIGEgcmVzZXJ2ZWQgZmllbGQgdXNlLCBmb28ucGJfPG5hbWU+LCBlZywgZm9vLnBiX2RlZmF1bHQuCiAgICogRm9yIHRoZSBsaXN0IG9mIHJlc2VydmVkIG5hbWVzIHBsZWFzZSBzZWU6CiAgICogICAgIG5ldC9wcm90bzIvY29tcGlsZXIvanMvaW50ZXJuYWwvZ2VuZXJhdG9yLmNjI2tLZXl3b3JkLgogICAqIEBwYXJhbSB7Ym9vbGVhbj19IG9wdF9pbmNsdWRlSW5zdGFuY2UgRGVwcmVjYXRlZC4gd2hldGhlciB0byBpbmNsdWRlIHRoZQogICAqICAgICBKU1BCIGluc3RhbmNlIGZvciB0cmFuc2l0aW9uYWwgc295IHByb3RvIHN1cHBvcnQ6CiAgICogICAgIGh0dHA6Ly9nb3RvL3NveS1wYXJhbS1taWdyYXRpb24KICAgKiBAcmV0dXJuIHshT2JqZWN0fQogICAqLwogIHByb3RvLnBiLmNtcy5BdXRvTWVzc2FnZUxpc3RSZXF1ZXN0LnByb3RvdHlwZS50b09iamVjdCA9IGZ1bmN0aW9uIChvcHRfaW5jbHVkZUluc3RhbmNlKSB7CiAgICByZXR1cm4gcHJvdG8ucGIuY21zLkF1dG9NZXNzYWdlTGlzdFJlcXVlc3QudG9PYmplY3Qob3B0X2luY2x1ZGVJbnN0YW5jZSwgdGhpcyk7CiAgfTsKICAvKioKICAgKiBTdGF0aWMgdmVyc2lvbiBvZiB0aGUge0BzZWUgdG9PYmplY3R9IG1ldGhvZC4KICAgKiBAcGFyYW0ge2Jvb2xlYW58dW5kZWZpbmVkfSBpbmNsdWRlSW5zdGFuY2UgRGVwcmVjYXRlZC4gV2hldGhlciB0byBpbmNsdWRlCiAgICogICAgIHRoZSBKU1BCIGluc3RhbmNlIGZvciB0cmFuc2l0aW9uYWwgc295IHByb3RvIHN1cHBvcnQ6CiAgICogICAgIGh0dHA6Ly9nb3RvL3NveS1wYXJhbS1taWdyYXRpb24KICAgKiBAcGFyYW0geyFwcm90by5wYi5jbXMuQXV0b01lc3NhZ2VMaXN0UmVxdWVzdH0gbXNnIFRoZSBtc2cgaW5zdGFuY2UgdG8gdHJhbnNmb3JtLgogICAqIEByZXR1cm4geyFPYmplY3R9CiAgICogQHN1cHByZXNzIHt1bnVzZWRMb2NhbFZhcmlhYmxlc30gZiBpcyBvbmx5IHVzZWQgZm9yIG5lc3RlZCBtZXNzYWdlcwogICAqLwoKCiAgcHJvdG8ucGIuY21zLkF1dG9NZXNzYWdlTGlzdFJlcXVlc3QudG9PYmplY3QgPSBmdW5jdGlvbiAoaW5jbHVkZUluc3RhbmNlLCBtc2cpIHsKICAgIHZhciBmLAogICAgICAgIG9iaiA9IHsKICAgICAgcGFnZU5vOiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdChtc2csIDEsIDApLAogICAgICBwYWdlU2l6ZToganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQobXNnLCAyLCAwKSwKICAgICAgYXJlYUlkOiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdChtc2csIDMsIDApLAogICAgICBlbmFibGU6IGpzcGIuTWVzc2FnZS5nZXRCb29sZWFuRmllbGRXaXRoRGVmYXVsdChtc2csIDQsIGZhbHNlKSwKICAgICAgYWN0aW9uOiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdChtc2csIDUsIDApCiAgICB9OwoKICAgIGlmIChpbmNsdWRlSW5zdGFuY2UpIHsKICAgICAgb2JqLiRqc3BiTWVzc2FnZUluc3RhbmNlID0gbXNnOwogICAgfQoKICAgIHJldHVybiBvYmo7CiAgfTsKfQovKioKICogRGVzZXJpYWxpemVzIGJpbmFyeSBkYXRhIChpbiBwcm90b2J1ZiB3aXJlIGZvcm1hdCkuCiAqIEBwYXJhbSB7anNwYi5CeXRlU291cmNlfSBieXRlcyBUaGUgYnl0ZXMgdG8gZGVzZXJpYWxpemUuCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuQXV0b01lc3NhZ2VMaXN0UmVxdWVzdH0KICovCgoKcHJvdG8ucGIuY21zLkF1dG9NZXNzYWdlTGlzdFJlcXVlc3QuZGVzZXJpYWxpemVCaW5hcnkgPSBmdW5jdGlvbiAoYnl0ZXMpIHsKICB2YXIgcmVhZGVyID0gbmV3IGpzcGIuQmluYXJ5UmVhZGVyKGJ5dGVzKTsKICB2YXIgbXNnID0gbmV3IHByb3RvLnBiLmNtcy5BdXRvTWVzc2FnZUxpc3RSZXF1ZXN0KCk7CiAgcmV0dXJuIHByb3RvLnBiLmNtcy5BdXRvTWVzc2FnZUxpc3RSZXF1ZXN0LmRlc2VyaWFsaXplQmluYXJ5RnJvbVJlYWRlcihtc2csIHJlYWRlcik7Cn07Ci8qKgogKiBEZXNlcmlhbGl6ZXMgYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUgZm9ybWF0KSBmcm9tIHRoZQogKiBnaXZlbiByZWFkZXIgaW50byB0aGUgZ2l2ZW4gbWVzc2FnZSBvYmplY3QuCiAqIEBwYXJhbSB7IXByb3RvLnBiLmNtcy5BdXRvTWVzc2FnZUxpc3RSZXF1ZXN0fSBtc2cgVGhlIG1lc3NhZ2Ugb2JqZWN0IHRvIGRlc2VyaWFsaXplIGludG8uCiAqIEBwYXJhbSB7IWpzcGIuQmluYXJ5UmVhZGVyfSByZWFkZXIgVGhlIEJpbmFyeVJlYWRlciB0byB1c2UuCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuQXV0b01lc3NhZ2VMaXN0UmVxdWVzdH0KICovCgoKcHJvdG8ucGIuY21zLkF1dG9NZXNzYWdlTGlzdFJlcXVlc3QuZGVzZXJpYWxpemVCaW5hcnlGcm9tUmVhZGVyID0gZnVuY3Rpb24gKG1zZywgcmVhZGVyKSB7CiAgd2hpbGUgKHJlYWRlci5uZXh0RmllbGQoKSkgewogICAgaWYgKHJlYWRlci5pc0VuZEdyb3VwKCkpIHsKICAgICAgYnJlYWs7CiAgICB9CgogICAgdmFyIGZpZWxkID0gcmVhZGVyLmdldEZpZWxkTnVtYmVyKCk7CgogICAgc3dpdGNoIChmaWVsZCkgewogICAgICBjYXNlIDE6CiAgICAgICAgdmFyIHZhbHVlID0gcmVhZGVyLnJlYWRVaW50MzIoKTsKICAgICAgICBtc2cuc2V0UGFnZU5vKHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgMjoKICAgICAgICB2YXIgdmFsdWUgPSByZWFkZXIucmVhZFVpbnQzMigpOwogICAgICAgIG1zZy5zZXRQYWdlU2l6ZSh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlIDM6CiAgICAgICAgdmFyIHZhbHVlID0gcmVhZGVyLnJlYWRVaW50MzIoKTsKICAgICAgICBtc2cuc2V0QXJlYUlkKHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgNDoKICAgICAgICB2YXIgdmFsdWUgPSByZWFkZXIucmVhZEJvb2woKTsKICAgICAgICBtc2cuc2V0RW5hYmxlKHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgNToKICAgICAgICB2YXIgdmFsdWUgPSByZWFkZXIucmVhZEVudW0oKTsKICAgICAgICBtc2cuc2V0QWN0aW9uKHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGRlZmF1bHQ6CiAgICAgICAgcmVhZGVyLnNraXBGaWVsZCgpOwogICAgICAgIGJyZWFrOwogICAgfQogIH0KCiAgcmV0dXJuIG1zZzsKfTsKLyoqCiAqIFNlcmlhbGl6ZXMgdGhlIG1lc3NhZ2UgdG8gYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUgZm9ybWF0KS4KICogQHJldHVybiB7IVVpbnQ4QXJyYXl9CiAqLwoKCnByb3RvLnBiLmNtcy5BdXRvTWVzc2FnZUxpc3RSZXF1ZXN0LnByb3RvdHlwZS5zZXJpYWxpemVCaW5hcnkgPSBmdW5jdGlvbiAoKSB7CiAgdmFyIHdyaXRlciA9IG5ldyBqc3BiLkJpbmFyeVdyaXRlcigpOwogIHByb3RvLnBiLmNtcy5BdXRvTWVzc2FnZUxpc3RSZXF1ZXN0LnNlcmlhbGl6ZUJpbmFyeVRvV3JpdGVyKHRoaXMsIHdyaXRlcik7CiAgcmV0dXJuIHdyaXRlci5nZXRSZXN1bHRCdWZmZXIoKTsKfTsKLyoqCiAqIFNlcmlhbGl6ZXMgdGhlIGdpdmVuIG1lc3NhZ2UgdG8gYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUKICogZm9ybWF0KSwgd3JpdGluZyB0byB0aGUgZ2l2ZW4gQmluYXJ5V3JpdGVyLgogKiBAcGFyYW0geyFwcm90by5wYi5jbXMuQXV0b01lc3NhZ2VMaXN0UmVxdWVzdH0gbWVzc2FnZQogKiBAcGFyYW0geyFqc3BiLkJpbmFyeVdyaXRlcn0gd3JpdGVyCiAqIEBzdXBwcmVzcyB7dW51c2VkTG9jYWxWYXJpYWJsZXN9IGYgaXMgb25seSB1c2VkIGZvciBuZXN0ZWQgbWVzc2FnZXMKICovCgoKcHJvdG8ucGIuY21zLkF1dG9NZXNzYWdlTGlzdFJlcXVlc3Quc2VyaWFsaXplQmluYXJ5VG9Xcml0ZXIgPSBmdW5jdGlvbiAobWVzc2FnZSwgd3JpdGVyKSB7CiAgdmFyIGYgPSB1bmRlZmluZWQ7CiAgZiA9IG1lc3NhZ2UuZ2V0UGFnZU5vKCk7CgogIGlmIChmICE9PSAwKSB7CiAgICB3cml0ZXIud3JpdGVVaW50MzIoMSwgZik7CiAgfQoKICBmID0gbWVzc2FnZS5nZXRQYWdlU2l6ZSgpOwoKICBpZiAoZiAhPT0gMCkgewogICAgd3JpdGVyLndyaXRlVWludDMyKDIsIGYpOwogIH0KCiAgZiA9IG1lc3NhZ2UuZ2V0QXJlYUlkKCk7CgogIGlmIChmICE9PSAwKSB7CiAgICB3cml0ZXIud3JpdGVVaW50MzIoMywgZik7CiAgfQoKICBmID0gbWVzc2FnZS5nZXRFbmFibGUoKTsKCiAgaWYgKGYpIHsKICAgIHdyaXRlci53cml0ZUJvb2woNCwgZik7CiAgfQoKICBmID0gbWVzc2FnZS5nZXRBY3Rpb24oKTsKCiAgaWYgKGYgIT09IDAuMCkgewogICAgd3JpdGVyLndyaXRlRW51bSg1LCBmKTsKICB9Cn07Ci8qKgogKiBvcHRpb25hbCB1aW50MzIgcGFnZV9ubyA9IDE7CiAqIEByZXR1cm4ge251bWJlcn0KICovCgoKcHJvdG8ucGIuY21zLkF1dG9NZXNzYWdlTGlzdFJlcXVlc3QucHJvdG90eXBlLmdldFBhZ2VObyA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQodGhpcywgMSwgMCk7Cn07Ci8qKgogKiBAcGFyYW0ge251bWJlcn0gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5BdXRvTWVzc2FnZUxpc3RSZXF1ZXN0fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLkF1dG9NZXNzYWdlTGlzdFJlcXVlc3QucHJvdG90eXBlLnNldFBhZ2VObyA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UHJvdG8zSW50RmllbGQodGhpcywgMSwgdmFsdWUpOwp9OwovKioKICogb3B0aW9uYWwgdWludDMyIHBhZ2Vfc2l6ZSA9IDI7CiAqIEByZXR1cm4ge251bWJlcn0KICovCgoKcHJvdG8ucGIuY21zLkF1dG9NZXNzYWdlTGlzdFJlcXVlc3QucHJvdG90eXBlLmdldFBhZ2VTaXplID0gZnVuY3Rpb24gKCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdCh0aGlzLCAyLCAwKTsKfTsKLyoqCiAqIEBwYXJhbSB7bnVtYmVyfSB2YWx1ZQogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLkF1dG9NZXNzYWdlTGlzdFJlcXVlc3R9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuQXV0b01lc3NhZ2VMaXN0UmVxdWVzdC5wcm90b3R5cGUuc2V0UGFnZVNpemUgPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0ludEZpZWxkKHRoaXMsIDIsIHZhbHVlKTsKfTsKLyoqCiAqIG9wdGlvbmFsIHVpbnQzMiBhcmVhX2lkID0gMzsKICogQHJldHVybiB7bnVtYmVyfQogKi8KCgpwcm90by5wYi5jbXMuQXV0b01lc3NhZ2VMaXN0UmVxdWVzdC5wcm90b3R5cGUuZ2V0QXJlYUlkID0gZnVuY3Rpb24gKCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdCh0aGlzLCAzLCAwKTsKfTsKLyoqCiAqIEBwYXJhbSB7bnVtYmVyfSB2YWx1ZQogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLkF1dG9NZXNzYWdlTGlzdFJlcXVlc3R9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuQXV0b01lc3NhZ2VMaXN0UmVxdWVzdC5wcm90b3R5cGUuc2V0QXJlYUlkID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRQcm90bzNJbnRGaWVsZCh0aGlzLCAzLCB2YWx1ZSk7Cn07Ci8qKgogKiBvcHRpb25hbCBib29sIGVuYWJsZSA9IDQ7CiAqIEByZXR1cm4ge2Jvb2xlYW59CiAqLwoKCnByb3RvLnBiLmNtcy5BdXRvTWVzc2FnZUxpc3RSZXF1ZXN0LnByb3RvdHlwZS5nZXRFbmFibGUgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRCb29sZWFuRmllbGRXaXRoRGVmYXVsdCh0aGlzLCA0LCBmYWxzZSk7Cn07Ci8qKgogKiBAcGFyYW0ge2Jvb2xlYW59IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuQXV0b01lc3NhZ2VMaXN0UmVxdWVzdH0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5BdXRvTWVzc2FnZUxpc3RSZXF1ZXN0LnByb3RvdHlwZS5zZXRFbmFibGUgPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0Jvb2xlYW5GaWVsZCh0aGlzLCA0LCB2YWx1ZSk7Cn07Ci8qKgogKiBvcHRpb25hbCBwYi5BY3Rpb25UeXBlIGFjdGlvbiA9IDU7CiAqIEByZXR1cm4geyFwcm90by5wYi5BY3Rpb25UeXBlfQogKi8KCgpwcm90by5wYi5jbXMuQXV0b01lc3NhZ2VMaXN0UmVxdWVzdC5wcm90b3R5cGUuZ2V0QWN0aW9uID0gZnVuY3Rpb24gKCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdCh0aGlzLCA1LCAwKTsKfTsKLyoqCiAqIEBwYXJhbSB7IXByb3RvLnBiLkFjdGlvblR5cGV9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuQXV0b01lc3NhZ2VMaXN0UmVxdWVzdH0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5BdXRvTWVzc2FnZUxpc3RSZXF1ZXN0LnByb3RvdHlwZS5zZXRBY3Rpb24gPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0VudW1GaWVsZCh0aGlzLCA1LCB2YWx1ZSk7Cn07Ci8qKgogKiBMaXN0IG9mIHJlcGVhdGVkIGZpZWxkcyB3aXRoaW4gdGhpcyBtZXNzYWdlIHR5cGUuCiAqIEBwcml2YXRlIHshQXJyYXk8bnVtYmVyPn0KICogQGNvbnN0CiAqLwoKCnByb3RvLnBiLmNtcy5BdXRvTWVzc2FnZUxpc3RSZXBseS5yZXBlYXRlZEZpZWxkc18gPSBbMV07CgppZiAoanNwYi5NZXNzYWdlLkdFTkVSQVRFX1RPX09CSkVDVCkgewogIC8qKgogICAqIENyZWF0ZXMgYW4gb2JqZWN0IHJlcHJlc2VudGF0aW9uIG9mIHRoaXMgcHJvdG8uCiAgICogRmllbGQgbmFtZXMgdGhhdCBhcmUgcmVzZXJ2ZWQgaW4gSmF2YVNjcmlwdCBhbmQgd2lsbCBiZSByZW5hbWVkIHRvIHBiX25hbWUuCiAgICogT3B0aW9uYWwgZmllbGRzIHRoYXQgYXJlIG5vdCBzZXQgd2lsbCBiZSBzZXQgdG8gdW5kZWZpbmVkLgogICAqIFRvIGFjY2VzcyBhIHJlc2VydmVkIGZpZWxkIHVzZSwgZm9vLnBiXzxuYW1lPiwgZWcsIGZvby5wYl9kZWZhdWx0LgogICAqIEZvciB0aGUgbGlzdCBvZiByZXNlcnZlZCBuYW1lcyBwbGVhc2Ugc2VlOgogICAqICAgICBuZXQvcHJvdG8yL2NvbXBpbGVyL2pzL2ludGVybmFsL2dlbmVyYXRvci5jYyNrS2V5d29yZC4KICAgKiBAcGFyYW0ge2Jvb2xlYW49fSBvcHRfaW5jbHVkZUluc3RhbmNlIERlcHJlY2F0ZWQuIHdoZXRoZXIgdG8gaW5jbHVkZSB0aGUKICAgKiAgICAgSlNQQiBpbnN0YW5jZSBmb3IgdHJhbnNpdGlvbmFsIHNveSBwcm90byBzdXBwb3J0OgogICAqICAgICBodHRwOi8vZ290by9zb3ktcGFyYW0tbWlncmF0aW9uCiAgICogQHJldHVybiB7IU9iamVjdH0KICAgKi8KICBwcm90by5wYi5jbXMuQXV0b01lc3NhZ2VMaXN0UmVwbHkucHJvdG90eXBlLnRvT2JqZWN0ID0gZnVuY3Rpb24gKG9wdF9pbmNsdWRlSW5zdGFuY2UpIHsKICAgIHJldHVybiBwcm90by5wYi5jbXMuQXV0b01lc3NhZ2VMaXN0UmVwbHkudG9PYmplY3Qob3B0X2luY2x1ZGVJbnN0YW5jZSwgdGhpcyk7CiAgfTsKICAvKioKICAgKiBTdGF0aWMgdmVyc2lvbiBvZiB0aGUge0BzZWUgdG9PYmplY3R9IG1ldGhvZC4KICAgKiBAcGFyYW0ge2Jvb2xlYW58dW5kZWZpbmVkfSBpbmNsdWRlSW5zdGFuY2UgRGVwcmVjYXRlZC4gV2hldGhlciB0byBpbmNsdWRlCiAgICogICAgIHRoZSBKU1BCIGluc3RhbmNlIGZvciB0cmFuc2l0aW9uYWwgc295IHByb3RvIHN1cHBvcnQ6CiAgICogICAgIGh0dHA6Ly9nb3RvL3NveS1wYXJhbS1taWdyYXRpb24KICAgKiBAcGFyYW0geyFwcm90by5wYi5jbXMuQXV0b01lc3NhZ2VMaXN0UmVwbHl9IG1zZyBUaGUgbXNnIGluc3RhbmNlIHRvIHRyYW5zZm9ybS4KICAgKiBAcmV0dXJuIHshT2JqZWN0fQogICAqIEBzdXBwcmVzcyB7dW51c2VkTG9jYWxWYXJpYWJsZXN9IGYgaXMgb25seSB1c2VkIGZvciBuZXN0ZWQgbWVzc2FnZXMKICAgKi8KCgogIHByb3RvLnBiLmNtcy5BdXRvTWVzc2FnZUxpc3RSZXBseS50b09iamVjdCA9IGZ1bmN0aW9uIChpbmNsdWRlSW5zdGFuY2UsIG1zZykgewogICAgdmFyIGYsCiAgICAgICAgb2JqID0gewogICAgICBtZXNzYWdlc0xpc3Q6IGpzcGIuTWVzc2FnZS50b09iamVjdExpc3QobXNnLmdldE1lc3NhZ2VzTGlzdCgpLCBjbXN0eXBlX3BiLkF1dG9NZXNzYWdlLnRvT2JqZWN0LCBpbmNsdWRlSW5zdGFuY2UpLAogICAgICBwYWdlTm86IGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KG1zZywgMiwgMCksCiAgICAgIHBhZ2VTaXplOiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdChtc2csIDMsIDApLAogICAgICB0b3RhbFBhZ2U6IGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KG1zZywgNCwgMCksCiAgICAgIHRvdGFsQ291bnQ6IGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KG1zZywgNSwgMCkKICAgIH07CgogICAgaWYgKGluY2x1ZGVJbnN0YW5jZSkgewogICAgICBvYmouJGpzcGJNZXNzYWdlSW5zdGFuY2UgPSBtc2c7CiAgICB9CgogICAgcmV0dXJuIG9iajsKICB9Owp9Ci8qKgogKiBEZXNlcmlhbGl6ZXMgYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUgZm9ybWF0KS4KICogQHBhcmFtIHtqc3BiLkJ5dGVTb3VyY2V9IGJ5dGVzIFRoZSBieXRlcyB0byBkZXNlcmlhbGl6ZS4KICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5BdXRvTWVzc2FnZUxpc3RSZXBseX0KICovCgoKcHJvdG8ucGIuY21zLkF1dG9NZXNzYWdlTGlzdFJlcGx5LmRlc2VyaWFsaXplQmluYXJ5ID0gZnVuY3Rpb24gKGJ5dGVzKSB7CiAgdmFyIHJlYWRlciA9IG5ldyBqc3BiLkJpbmFyeVJlYWRlcihieXRlcyk7CiAgdmFyIG1zZyA9IG5ldyBwcm90by5wYi5jbXMuQXV0b01lc3NhZ2VMaXN0UmVwbHkoKTsKICByZXR1cm4gcHJvdG8ucGIuY21zLkF1dG9NZXNzYWdlTGlzdFJlcGx5LmRlc2VyaWFsaXplQmluYXJ5RnJvbVJlYWRlcihtc2csIHJlYWRlcik7Cn07Ci8qKgogKiBEZXNlcmlhbGl6ZXMgYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUgZm9ybWF0KSBmcm9tIHRoZQogKiBnaXZlbiByZWFkZXIgaW50byB0aGUgZ2l2ZW4gbWVzc2FnZSBvYmplY3QuCiAqIEBwYXJhbSB7IXByb3RvLnBiLmNtcy5BdXRvTWVzc2FnZUxpc3RSZXBseX0gbXNnIFRoZSBtZXNzYWdlIG9iamVjdCB0byBkZXNlcmlhbGl6ZSBpbnRvLgogKiBAcGFyYW0geyFqc3BiLkJpbmFyeVJlYWRlcn0gcmVhZGVyIFRoZSBCaW5hcnlSZWFkZXIgdG8gdXNlLgogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLkF1dG9NZXNzYWdlTGlzdFJlcGx5fQogKi8KCgpwcm90by5wYi5jbXMuQXV0b01lc3NhZ2VMaXN0UmVwbHkuZGVzZXJpYWxpemVCaW5hcnlGcm9tUmVhZGVyID0gZnVuY3Rpb24gKG1zZywgcmVhZGVyKSB7CiAgd2hpbGUgKHJlYWRlci5uZXh0RmllbGQoKSkgewogICAgaWYgKHJlYWRlci5pc0VuZEdyb3VwKCkpIHsKICAgICAgYnJlYWs7CiAgICB9CgogICAgdmFyIGZpZWxkID0gcmVhZGVyLmdldEZpZWxkTnVtYmVyKCk7CgogICAgc3dpdGNoIChmaWVsZCkgewogICAgICBjYXNlIDE6CiAgICAgICAgdmFyIHZhbHVlID0gbmV3IGNtc3R5cGVfcGIuQXV0b01lc3NhZ2UoKTsKICAgICAgICByZWFkZXIucmVhZE1lc3NhZ2UodmFsdWUsIGNtc3R5cGVfcGIuQXV0b01lc3NhZ2UuZGVzZXJpYWxpemVCaW5hcnlGcm9tUmVhZGVyKTsKICAgICAgICBtc2cuYWRkTWVzc2FnZXModmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSAyOgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkVWludDMyKCk7CiAgICAgICAgbXNnLnNldFBhZ2VObyh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlIDM6CiAgICAgICAgdmFyIHZhbHVlID0gcmVhZGVyLnJlYWRVaW50MzIoKTsKICAgICAgICBtc2cuc2V0UGFnZVNpemUodmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSA0OgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkVWludDMyKCk7CiAgICAgICAgbXNnLnNldFRvdGFsUGFnZSh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlIDU6CiAgICAgICAgdmFyIHZhbHVlID0gcmVhZGVyLnJlYWRVaW50MzIoKTsKICAgICAgICBtc2cuc2V0VG90YWxDb3VudCh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBkZWZhdWx0OgogICAgICAgIHJlYWRlci5za2lwRmllbGQoKTsKICAgICAgICBicmVhazsKICAgIH0KICB9CgogIHJldHVybiBtc2c7Cn07Ci8qKgogKiBTZXJpYWxpemVzIHRoZSBtZXNzYWdlIHRvIGJpbmFyeSBkYXRhIChpbiBwcm90b2J1ZiB3aXJlIGZvcm1hdCkuCiAqIEByZXR1cm4geyFVaW50OEFycmF5fQogKi8KCgpwcm90by5wYi5jbXMuQXV0b01lc3NhZ2VMaXN0UmVwbHkucHJvdG90eXBlLnNlcmlhbGl6ZUJpbmFyeSA9IGZ1bmN0aW9uICgpIHsKICB2YXIgd3JpdGVyID0gbmV3IGpzcGIuQmluYXJ5V3JpdGVyKCk7CiAgcHJvdG8ucGIuY21zLkF1dG9NZXNzYWdlTGlzdFJlcGx5LnNlcmlhbGl6ZUJpbmFyeVRvV3JpdGVyKHRoaXMsIHdyaXRlcik7CiAgcmV0dXJuIHdyaXRlci5nZXRSZXN1bHRCdWZmZXIoKTsKfTsKLyoqCiAqIFNlcmlhbGl6ZXMgdGhlIGdpdmVuIG1lc3NhZ2UgdG8gYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUKICogZm9ybWF0KSwgd3JpdGluZyB0byB0aGUgZ2l2ZW4gQmluYXJ5V3JpdGVyLgogKiBAcGFyYW0geyFwcm90by5wYi5jbXMuQXV0b01lc3NhZ2VMaXN0UmVwbHl9IG1lc3NhZ2UKICogQHBhcmFtIHshanNwYi5CaW5hcnlXcml0ZXJ9IHdyaXRlcgogKiBAc3VwcHJlc3Mge3VudXNlZExvY2FsVmFyaWFibGVzfSBmIGlzIG9ubHkgdXNlZCBmb3IgbmVzdGVkIG1lc3NhZ2VzCiAqLwoKCnByb3RvLnBiLmNtcy5BdXRvTWVzc2FnZUxpc3RSZXBseS5zZXJpYWxpemVCaW5hcnlUb1dyaXRlciA9IGZ1bmN0aW9uIChtZXNzYWdlLCB3cml0ZXIpIHsKICB2YXIgZiA9IHVuZGVmaW5lZDsKICBmID0gbWVzc2FnZS5nZXRNZXNzYWdlc0xpc3QoKTsKCiAgaWYgKGYubGVuZ3RoID4gMCkgewogICAgd3JpdGVyLndyaXRlUmVwZWF0ZWRNZXNzYWdlKDEsIGYsIGNtc3R5cGVfcGIuQXV0b01lc3NhZ2Uuc2VyaWFsaXplQmluYXJ5VG9Xcml0ZXIpOwogIH0KCiAgZiA9IG1lc3NhZ2UuZ2V0UGFnZU5vKCk7CgogIGlmIChmICE9PSAwKSB7CiAgICB3cml0ZXIud3JpdGVVaW50MzIoMiwgZik7CiAgfQoKICBmID0gbWVzc2FnZS5nZXRQYWdlU2l6ZSgpOwoKICBpZiAoZiAhPT0gMCkgewogICAgd3JpdGVyLndyaXRlVWludDMyKDMsIGYpOwogIH0KCiAgZiA9IG1lc3NhZ2UuZ2V0VG90YWxQYWdlKCk7CgogIGlmIChmICE9PSAwKSB7CiAgICB3cml0ZXIud3JpdGVVaW50MzIoNCwgZik7CiAgfQoKICBmID0gbWVzc2FnZS5nZXRUb3RhbENvdW50KCk7CgogIGlmIChmICE9PSAwKSB7CiAgICB3cml0ZXIud3JpdGVVaW50MzIoNSwgZik7CiAgfQp9OwovKioKICogcmVwZWF0ZWQgcGIuQXV0b01lc3NhZ2UgbWVzc2FnZXMgPSAxOwogKiBAcmV0dXJuIHshQXJyYXk8IXByb3RvLnBiLkF1dG9NZXNzYWdlPn0KICovCgoKcHJvdG8ucGIuY21zLkF1dG9NZXNzYWdlTGlzdFJlcGx5LnByb3RvdHlwZS5nZXRNZXNzYWdlc0xpc3QgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRSZXBlYXRlZFdyYXBwZXJGaWVsZCh0aGlzLCBjbXN0eXBlX3BiLkF1dG9NZXNzYWdlLCAxKTsKfTsKLyoqCiAqIEBwYXJhbSB7IUFycmF5PCFwcm90by5wYi5BdXRvTWVzc2FnZT59IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuQXV0b01lc3NhZ2VMaXN0UmVwbHl9IHJldHVybnMgdGhpcwoqLwoKCnByb3RvLnBiLmNtcy5BdXRvTWVzc2FnZUxpc3RSZXBseS5wcm90b3R5cGUuc2V0TWVzc2FnZXNMaXN0ID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRSZXBlYXRlZFdyYXBwZXJGaWVsZCh0aGlzLCAxLCB2YWx1ZSk7Cn07Ci8qKgogKiBAcGFyYW0geyFwcm90by5wYi5BdXRvTWVzc2FnZT19IG9wdF92YWx1ZQogKiBAcGFyYW0ge251bWJlcj19IG9wdF9pbmRleAogKiBAcmV0dXJuIHshcHJvdG8ucGIuQXV0b01lc3NhZ2V9CiAqLwoKCnByb3RvLnBiLmNtcy5BdXRvTWVzc2FnZUxpc3RSZXBseS5wcm90b3R5cGUuYWRkTWVzc2FnZXMgPSBmdW5jdGlvbiAob3B0X3ZhbHVlLCBvcHRfaW5kZXgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmFkZFRvUmVwZWF0ZWRXcmFwcGVyRmllbGQodGhpcywgMSwgb3B0X3ZhbHVlLCBwcm90by5wYi5BdXRvTWVzc2FnZSwgb3B0X2luZGV4KTsKfTsKLyoqCiAqIENsZWFycyB0aGUgbGlzdCBtYWtpbmcgaXQgZW1wdHkgYnV0IG5vbi1udWxsLgogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLkF1dG9NZXNzYWdlTGlzdFJlcGx5fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLkF1dG9NZXNzYWdlTGlzdFJlcGx5LnByb3RvdHlwZS5jbGVhck1lc3NhZ2VzTGlzdCA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4gdGhpcy5zZXRNZXNzYWdlc0xpc3QoW10pOwp9OwovKioKICogb3B0aW9uYWwgdWludDMyIHBhZ2Vfbm8gPSAyOwogKiBAcmV0dXJuIHtudW1iZXJ9CiAqLwoKCnByb3RvLnBiLmNtcy5BdXRvTWVzc2FnZUxpc3RSZXBseS5wcm90b3R5cGUuZ2V0UGFnZU5vID0gZnVuY3Rpb24gKCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdCh0aGlzLCAyLCAwKTsKfTsKLyoqCiAqIEBwYXJhbSB7bnVtYmVyfSB2YWx1ZQogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLkF1dG9NZXNzYWdlTGlzdFJlcGx5fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLkF1dG9NZXNzYWdlTGlzdFJlcGx5LnByb3RvdHlwZS5zZXRQYWdlTm8gPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0ludEZpZWxkKHRoaXMsIDIsIHZhbHVlKTsKfTsKLyoqCiAqIG9wdGlvbmFsIHVpbnQzMiBwYWdlX3NpemUgPSAzOwogKiBAcmV0dXJuIHtudW1iZXJ9CiAqLwoKCnByb3RvLnBiLmNtcy5BdXRvTWVzc2FnZUxpc3RSZXBseS5wcm90b3R5cGUuZ2V0UGFnZVNpemUgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDMsIDApOwp9OwovKioKICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuQXV0b01lc3NhZ2VMaXN0UmVwbHl9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuQXV0b01lc3NhZ2VMaXN0UmVwbHkucHJvdG90eXBlLnNldFBhZ2VTaXplID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRQcm90bzNJbnRGaWVsZCh0aGlzLCAzLCB2YWx1ZSk7Cn07Ci8qKgogKiBvcHRpb25hbCB1aW50MzIgdG90YWxfcGFnZSA9IDQ7CiAqIEByZXR1cm4ge251bWJlcn0KICovCgoKcHJvdG8ucGIuY21zLkF1dG9NZXNzYWdlTGlzdFJlcGx5LnByb3RvdHlwZS5nZXRUb3RhbFBhZ2UgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDQsIDApOwp9OwovKioKICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuQXV0b01lc3NhZ2VMaXN0UmVwbHl9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuQXV0b01lc3NhZ2VMaXN0UmVwbHkucHJvdG90eXBlLnNldFRvdGFsUGFnZSA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UHJvdG8zSW50RmllbGQodGhpcywgNCwgdmFsdWUpOwp9OwovKioKICogb3B0aW9uYWwgdWludDMyIHRvdGFsX2NvdW50ID0gNTsKICogQHJldHVybiB7bnVtYmVyfQogKi8KCgpwcm90by5wYi5jbXMuQXV0b01lc3NhZ2VMaXN0UmVwbHkucHJvdG90eXBlLmdldFRvdGFsQ291bnQgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDUsIDApOwp9OwovKioKICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuQXV0b01lc3NhZ2VMaXN0UmVwbHl9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuQXV0b01lc3NhZ2VMaXN0UmVwbHkucHJvdG90eXBlLnNldFRvdGFsQ291bnQgPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0ludEZpZWxkKHRoaXMsIDUsIHZhbHVlKTsKfTsKCmlmIChqc3BiLk1lc3NhZ2UuR0VORVJBVEVfVE9fT0JKRUNUKSB7CiAgLyoqCiAgICogQ3JlYXRlcyBhbiBvYmplY3QgcmVwcmVzZW50YXRpb24gb2YgdGhpcyBwcm90by4KICAgKiBGaWVsZCBuYW1lcyB0aGF0IGFyZSByZXNlcnZlZCBpbiBKYXZhU2NyaXB0IGFuZCB3aWxsIGJlIHJlbmFtZWQgdG8gcGJfbmFtZS4KICAgKiBPcHRpb25hbCBmaWVsZHMgdGhhdCBhcmUgbm90IHNldCB3aWxsIGJlIHNldCB0byB1bmRlZmluZWQuCiAgICogVG8gYWNjZXNzIGEgcmVzZXJ2ZWQgZmllbGQgdXNlLCBmb28ucGJfPG5hbWU+LCBlZywgZm9vLnBiX2RlZmF1bHQuCiAgICogRm9yIHRoZSBsaXN0IG9mIHJlc2VydmVkIG5hbWVzIHBsZWFzZSBzZWU6CiAgICogICAgIG5ldC9wcm90bzIvY29tcGlsZXIvanMvaW50ZXJuYWwvZ2VuZXJhdG9yLmNjI2tLZXl3b3JkLgogICAqIEBwYXJhbSB7Ym9vbGVhbj19IG9wdF9pbmNsdWRlSW5zdGFuY2UgRGVwcmVjYXRlZC4gd2hldGhlciB0byBpbmNsdWRlIHRoZQogICAqICAgICBKU1BCIGluc3RhbmNlIGZvciB0cmFuc2l0aW9uYWwgc295IHByb3RvIHN1cHBvcnQ6CiAgICogICAgIGh0dHA6Ly9nb3RvL3NveS1wYXJhbS1taWdyYXRpb24KICAgKiBAcmV0dXJuIHshT2JqZWN0fQogICAqLwogIHByb3RvLnBiLmNtcy5DaGF0TWVzc2FnZUxpc3RSZXF1ZXN0LnByb3RvdHlwZS50b09iamVjdCA9IGZ1bmN0aW9uIChvcHRfaW5jbHVkZUluc3RhbmNlKSB7CiAgICByZXR1cm4gcHJvdG8ucGIuY21zLkNoYXRNZXNzYWdlTGlzdFJlcXVlc3QudG9PYmplY3Qob3B0X2luY2x1ZGVJbnN0YW5jZSwgdGhpcyk7CiAgfTsKICAvKioKICAgKiBTdGF0aWMgdmVyc2lvbiBvZiB0aGUge0BzZWUgdG9PYmplY3R9IG1ldGhvZC4KICAgKiBAcGFyYW0ge2Jvb2xlYW58dW5kZWZpbmVkfSBpbmNsdWRlSW5zdGFuY2UgRGVwcmVjYXRlZC4gV2hldGhlciB0byBpbmNsdWRlCiAgICogICAgIHRoZSBKU1BCIGluc3RhbmNlIGZvciB0cmFuc2l0aW9uYWwgc295IHByb3RvIHN1cHBvcnQ6CiAgICogICAgIGh0dHA6Ly9nb3RvL3NveS1wYXJhbS1taWdyYXRpb24KICAgKiBAcGFyYW0geyFwcm90by5wYi5jbXMuQ2hhdE1lc3NhZ2VMaXN0UmVxdWVzdH0gbXNnIFRoZSBtc2cgaW5zdGFuY2UgdG8gdHJhbnNmb3JtLgogICAqIEByZXR1cm4geyFPYmplY3R9CiAgICogQHN1cHByZXNzIHt1bnVzZWRMb2NhbFZhcmlhYmxlc30gZiBpcyBvbmx5IHVzZWQgZm9yIG5lc3RlZCBtZXNzYWdlcwogICAqLwoKCiAgcHJvdG8ucGIuY21zLkNoYXRNZXNzYWdlTGlzdFJlcXVlc3QudG9PYmplY3QgPSBmdW5jdGlvbiAoaW5jbHVkZUluc3RhbmNlLCBtc2cpIHsKICAgIHZhciBmLAogICAgICAgIG9iaiA9IHsKICAgICAgcGFnZU5vOiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdChtc2csIDEsIDApLAogICAgICBwYWdlU2l6ZToganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQobXNnLCAyLCAwKSwKICAgICAgYXJlYUlkOiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdChtc2csIDMsIDApLAogICAgICBhcHBJZDoganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQobXNnLCA0LCAwKSwKICAgICAgdXNlcklkOiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdChtc2csIDUsIDApLAogICAgICBhbmNob3JJZDoganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQobXNnLCA2LCAwKSwKICAgICAgZGlyZWN0aW9uOiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdChtc2csIDcsIDApLAogICAgICB0eXBlOiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdChtc2csIDgsIDApLAogICAgICBrZXl3b3JkOiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdChtc2csIDksICIiKSwKICAgICAgY3JlYXRlZFN0YXJ0OiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdChtc2csIDEwLCAwKSwKICAgICAgY3JlYXRlZEVuZDoganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQobXNnLCAxMSwgMCkKICAgIH07CgogICAgaWYgKGluY2x1ZGVJbnN0YW5jZSkgewogICAgICBvYmouJGpzcGJNZXNzYWdlSW5zdGFuY2UgPSBtc2c7CiAgICB9CgogICAgcmV0dXJuIG9iajsKICB9Owp9Ci8qKgogKiBEZXNlcmlhbGl6ZXMgYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUgZm9ybWF0KS4KICogQHBhcmFtIHtqc3BiLkJ5dGVTb3VyY2V9IGJ5dGVzIFRoZSBieXRlcyB0byBkZXNlcmlhbGl6ZS4KICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5DaGF0TWVzc2FnZUxpc3RSZXF1ZXN0fQogKi8KCgpwcm90by5wYi5jbXMuQ2hhdE1lc3NhZ2VMaXN0UmVxdWVzdC5kZXNlcmlhbGl6ZUJpbmFyeSA9IGZ1bmN0aW9uIChieXRlcykgewogIHZhciByZWFkZXIgPSBuZXcganNwYi5CaW5hcnlSZWFkZXIoYnl0ZXMpOwogIHZhciBtc2cgPSBuZXcgcHJvdG8ucGIuY21zLkNoYXRNZXNzYWdlTGlzdFJlcXVlc3QoKTsKICByZXR1cm4gcHJvdG8ucGIuY21zLkNoYXRNZXNzYWdlTGlzdFJlcXVlc3QuZGVzZXJpYWxpemVCaW5hcnlGcm9tUmVhZGVyKG1zZywgcmVhZGVyKTsKfTsKLyoqCiAqIERlc2VyaWFsaXplcyBiaW5hcnkgZGF0YSAoaW4gcHJvdG9idWYgd2lyZSBmb3JtYXQpIGZyb20gdGhlCiAqIGdpdmVuIHJlYWRlciBpbnRvIHRoZSBnaXZlbiBtZXNzYWdlIG9iamVjdC4KICogQHBhcmFtIHshcHJvdG8ucGIuY21zLkNoYXRNZXNzYWdlTGlzdFJlcXVlc3R9IG1zZyBUaGUgbWVzc2FnZSBvYmplY3QgdG8gZGVzZXJpYWxpemUgaW50by4KICogQHBhcmFtIHshanNwYi5CaW5hcnlSZWFkZXJ9IHJlYWRlciBUaGUgQmluYXJ5UmVhZGVyIHRvIHVzZS4KICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5DaGF0TWVzc2FnZUxpc3RSZXF1ZXN0fQogKi8KCgpwcm90by5wYi5jbXMuQ2hhdE1lc3NhZ2VMaXN0UmVxdWVzdC5kZXNlcmlhbGl6ZUJpbmFyeUZyb21SZWFkZXIgPSBmdW5jdGlvbiAobXNnLCByZWFkZXIpIHsKICB3aGlsZSAocmVhZGVyLm5leHRGaWVsZCgpKSB7CiAgICBpZiAocmVhZGVyLmlzRW5kR3JvdXAoKSkgewogICAgICBicmVhazsKICAgIH0KCiAgICB2YXIgZmllbGQgPSByZWFkZXIuZ2V0RmllbGROdW1iZXIoKTsKCiAgICBzd2l0Y2ggKGZpZWxkKSB7CiAgICAgIGNhc2UgMToKICAgICAgICB2YXIgdmFsdWUgPSByZWFkZXIucmVhZFVpbnQzMigpOwogICAgICAgIG1zZy5zZXRQYWdlTm8odmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSAyOgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkVWludDMyKCk7CiAgICAgICAgbXNnLnNldFBhZ2VTaXplKHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgMzoKICAgICAgICB2YXIgdmFsdWUgPSByZWFkZXIucmVhZFVpbnQzMigpOwogICAgICAgIG1zZy5zZXRBcmVhSWQodmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSA0OgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkVWludDMyKCk7CiAgICAgICAgbXNnLnNldEFwcElkKHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgNToKICAgICAgICB2YXIgdmFsdWUgPSByZWFkZXIucmVhZFVpbnQzMigpOwogICAgICAgIG1zZy5zZXRVc2VySWQodmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSA2OgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkVWludDMyKCk7CiAgICAgICAgbXNnLnNldEFuY2hvcklkKHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgNzoKICAgICAgICB2YXIgdmFsdWUgPSByZWFkZXIucmVhZEVudW0oKTsKICAgICAgICBtc2cuc2V0RGlyZWN0aW9uKHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgODoKICAgICAgICB2YXIgdmFsdWUgPSByZWFkZXIucmVhZEVudW0oKTsKICAgICAgICBtc2cuc2V0VHlwZSh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlIDk6CiAgICAgICAgdmFyIHZhbHVlID0gcmVhZGVyLnJlYWRTdHJpbmcoKTsKICAgICAgICBtc2cuc2V0S2V5d29yZCh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlIDEwOgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkVWludDMyKCk7CiAgICAgICAgbXNnLnNldENyZWF0ZWRTdGFydCh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlIDExOgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkVWludDMyKCk7CiAgICAgICAgbXNnLnNldENyZWF0ZWRFbmQodmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgZGVmYXVsdDoKICAgICAgICByZWFkZXIuc2tpcEZpZWxkKCk7CiAgICAgICAgYnJlYWs7CiAgICB9CiAgfQoKICByZXR1cm4gbXNnOwp9OwovKioKICogU2VyaWFsaXplcyB0aGUgbWVzc2FnZSB0byBiaW5hcnkgZGF0YSAoaW4gcHJvdG9idWYgd2lyZSBmb3JtYXQpLgogKiBAcmV0dXJuIHshVWludDhBcnJheX0KICovCgoKcHJvdG8ucGIuY21zLkNoYXRNZXNzYWdlTGlzdFJlcXVlc3QucHJvdG90eXBlLnNlcmlhbGl6ZUJpbmFyeSA9IGZ1bmN0aW9uICgpIHsKICB2YXIgd3JpdGVyID0gbmV3IGpzcGIuQmluYXJ5V3JpdGVyKCk7CiAgcHJvdG8ucGIuY21zLkNoYXRNZXNzYWdlTGlzdFJlcXVlc3Quc2VyaWFsaXplQmluYXJ5VG9Xcml0ZXIodGhpcywgd3JpdGVyKTsKICByZXR1cm4gd3JpdGVyLmdldFJlc3VsdEJ1ZmZlcigpOwp9OwovKioKICogU2VyaWFsaXplcyB0aGUgZ2l2ZW4gbWVzc2FnZSB0byBiaW5hcnkgZGF0YSAoaW4gcHJvdG9idWYgd2lyZQogKiBmb3JtYXQpLCB3cml0aW5nIHRvIHRoZSBnaXZlbiBCaW5hcnlXcml0ZXIuCiAqIEBwYXJhbSB7IXByb3RvLnBiLmNtcy5DaGF0TWVzc2FnZUxpc3RSZXF1ZXN0fSBtZXNzYWdlCiAqIEBwYXJhbSB7IWpzcGIuQmluYXJ5V3JpdGVyfSB3cml0ZXIKICogQHN1cHByZXNzIHt1bnVzZWRMb2NhbFZhcmlhYmxlc30gZiBpcyBvbmx5IHVzZWQgZm9yIG5lc3RlZCBtZXNzYWdlcwogKi8KCgpwcm90by5wYi5jbXMuQ2hhdE1lc3NhZ2VMaXN0UmVxdWVzdC5zZXJpYWxpemVCaW5hcnlUb1dyaXRlciA9IGZ1bmN0aW9uIChtZXNzYWdlLCB3cml0ZXIpIHsKICB2YXIgZiA9IHVuZGVmaW5lZDsKICBmID0gbWVzc2FnZS5nZXRQYWdlTm8oKTsKCiAgaWYgKGYgIT09IDApIHsKICAgIHdyaXRlci53cml0ZVVpbnQzMigxLCBmKTsKICB9CgogIGYgPSBtZXNzYWdlLmdldFBhZ2VTaXplKCk7CgogIGlmIChmICE9PSAwKSB7CiAgICB3cml0ZXIud3JpdGVVaW50MzIoMiwgZik7CiAgfQoKICBmID0gbWVzc2FnZS5nZXRBcmVhSWQoKTsKCiAgaWYgKGYgIT09IDApIHsKICAgIHdyaXRlci53cml0ZVVpbnQzMigzLCBmKTsKICB9CgogIGYgPSBtZXNzYWdlLmdldEFwcElkKCk7CgogIGlmIChmICE9PSAwKSB7CiAgICB3cml0ZXIud3JpdGVVaW50MzIoNCwgZik7CiAgfQoKICBmID0gbWVzc2FnZS5nZXRVc2VySWQoKTsKCiAgaWYgKGYgIT09IDApIHsKICAgIHdyaXRlci53cml0ZVVpbnQzMig1LCBmKTsKICB9CgogIGYgPSBtZXNzYWdlLmdldEFuY2hvcklkKCk7CgogIGlmIChmICE9PSAwKSB7CiAgICB3cml0ZXIud3JpdGVVaW50MzIoNiwgZik7CiAgfQoKICBmID0gbWVzc2FnZS5nZXREaXJlY3Rpb24oKTsKCiAgaWYgKGYgIT09IDAuMCkgewogICAgd3JpdGVyLndyaXRlRW51bSg3LCBmKTsKICB9CgogIGYgPSBtZXNzYWdlLmdldFR5cGUoKTsKCiAgaWYgKGYgIT09IDAuMCkgewogICAgd3JpdGVyLndyaXRlRW51bSg4LCBmKTsKICB9CgogIGYgPSBtZXNzYWdlLmdldEtleXdvcmQoKTsKCiAgaWYgKGYubGVuZ3RoID4gMCkgewogICAgd3JpdGVyLndyaXRlU3RyaW5nKDksIGYpOwogIH0KCiAgZiA9IG1lc3NhZ2UuZ2V0Q3JlYXRlZFN0YXJ0KCk7CgogIGlmIChmICE9PSAwKSB7CiAgICB3cml0ZXIud3JpdGVVaW50MzIoMTAsIGYpOwogIH0KCiAgZiA9IG1lc3NhZ2UuZ2V0Q3JlYXRlZEVuZCgpOwoKICBpZiAoZiAhPT0gMCkgewogICAgd3JpdGVyLndyaXRlVWludDMyKDExLCBmKTsKICB9Cn07Ci8qKgogKiBvcHRpb25hbCB1aW50MzIgcGFnZV9ubyA9IDE7CiAqIEByZXR1cm4ge251bWJlcn0KICovCgoKcHJvdG8ucGIuY21zLkNoYXRNZXNzYWdlTGlzdFJlcXVlc3QucHJvdG90eXBlLmdldFBhZ2VObyA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQodGhpcywgMSwgMCk7Cn07Ci8qKgogKiBAcGFyYW0ge251bWJlcn0gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5DaGF0TWVzc2FnZUxpc3RSZXF1ZXN0fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLkNoYXRNZXNzYWdlTGlzdFJlcXVlc3QucHJvdG90eXBlLnNldFBhZ2VObyA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UHJvdG8zSW50RmllbGQodGhpcywgMSwgdmFsdWUpOwp9OwovKioKICogb3B0aW9uYWwgdWludDMyIHBhZ2Vfc2l6ZSA9IDI7CiAqIEByZXR1cm4ge251bWJlcn0KICovCgoKcHJvdG8ucGIuY21zLkNoYXRNZXNzYWdlTGlzdFJlcXVlc3QucHJvdG90eXBlLmdldFBhZ2VTaXplID0gZnVuY3Rpb24gKCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdCh0aGlzLCAyLCAwKTsKfTsKLyoqCiAqIEBwYXJhbSB7bnVtYmVyfSB2YWx1ZQogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLkNoYXRNZXNzYWdlTGlzdFJlcXVlc3R9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuQ2hhdE1lc3NhZ2VMaXN0UmVxdWVzdC5wcm90b3R5cGUuc2V0UGFnZVNpemUgPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0ludEZpZWxkKHRoaXMsIDIsIHZhbHVlKTsKfTsKLyoqCiAqIG9wdGlvbmFsIHVpbnQzMiBhcmVhX2lkID0gMzsKICogQHJldHVybiB7bnVtYmVyfQogKi8KCgpwcm90by5wYi5jbXMuQ2hhdE1lc3NhZ2VMaXN0UmVxdWVzdC5wcm90b3R5cGUuZ2V0QXJlYUlkID0gZnVuY3Rpb24gKCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdCh0aGlzLCAzLCAwKTsKfTsKLyoqCiAqIEBwYXJhbSB7bnVtYmVyfSB2YWx1ZQogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLkNoYXRNZXNzYWdlTGlzdFJlcXVlc3R9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuQ2hhdE1lc3NhZ2VMaXN0UmVxdWVzdC5wcm90b3R5cGUuc2V0QXJlYUlkID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRQcm90bzNJbnRGaWVsZCh0aGlzLCAzLCB2YWx1ZSk7Cn07Ci8qKgogKiBvcHRpb25hbCB1aW50MzIgYXBwX2lkID0gNDsKICogQHJldHVybiB7bnVtYmVyfQogKi8KCgpwcm90by5wYi5jbXMuQ2hhdE1lc3NhZ2VMaXN0UmVxdWVzdC5wcm90b3R5cGUuZ2V0QXBwSWQgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDQsIDApOwp9OwovKioKICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuQ2hhdE1lc3NhZ2VMaXN0UmVxdWVzdH0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5DaGF0TWVzc2FnZUxpc3RSZXF1ZXN0LnByb3RvdHlwZS5zZXRBcHBJZCA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UHJvdG8zSW50RmllbGQodGhpcywgNCwgdmFsdWUpOwp9OwovKioKICogb3B0aW9uYWwgdWludDMyIHVzZXJfaWQgPSA1OwogKiBAcmV0dXJuIHtudW1iZXJ9CiAqLwoKCnByb3RvLnBiLmNtcy5DaGF0TWVzc2FnZUxpc3RSZXF1ZXN0LnByb3RvdHlwZS5nZXRVc2VySWQgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDUsIDApOwp9OwovKioKICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuQ2hhdE1lc3NhZ2VMaXN0UmVxdWVzdH0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5DaGF0TWVzc2FnZUxpc3RSZXF1ZXN0LnByb3RvdHlwZS5zZXRVc2VySWQgPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0ludEZpZWxkKHRoaXMsIDUsIHZhbHVlKTsKfTsKLyoqCiAqIG9wdGlvbmFsIHVpbnQzMiBhbmNob3JfaWQgPSA2OwogKiBAcmV0dXJuIHtudW1iZXJ9CiAqLwoKCnByb3RvLnBiLmNtcy5DaGF0TWVzc2FnZUxpc3RSZXF1ZXN0LnByb3RvdHlwZS5nZXRBbmNob3JJZCA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQodGhpcywgNiwgMCk7Cn07Ci8qKgogKiBAcGFyYW0ge251bWJlcn0gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5DaGF0TWVzc2FnZUxpc3RSZXF1ZXN0fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLkNoYXRNZXNzYWdlTGlzdFJlcXVlc3QucHJvdG90eXBlLnNldEFuY2hvcklkID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRQcm90bzNJbnRGaWVsZCh0aGlzLCA2LCB2YWx1ZSk7Cn07Ci8qKgogKiBvcHRpb25hbCBwYi5NZXNzYWdlRGlyZWN0aW9uIGRpcmVjdGlvbiA9IDc7CiAqIEByZXR1cm4geyFwcm90by5wYi5NZXNzYWdlRGlyZWN0aW9ufQogKi8KCgpwcm90by5wYi5jbXMuQ2hhdE1lc3NhZ2VMaXN0UmVxdWVzdC5wcm90b3R5cGUuZ2V0RGlyZWN0aW9uID0gZnVuY3Rpb24gKCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdCh0aGlzLCA3LCAwKTsKfTsKLyoqCiAqIEBwYXJhbSB7IXByb3RvLnBiLk1lc3NhZ2VEaXJlY3Rpb259IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuQ2hhdE1lc3NhZ2VMaXN0UmVxdWVzdH0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5DaGF0TWVzc2FnZUxpc3RSZXF1ZXN0LnByb3RvdHlwZS5zZXREaXJlY3Rpb24gPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0VudW1GaWVsZCh0aGlzLCA3LCB2YWx1ZSk7Cn07Ci8qKgogKiBvcHRpb25hbCBwYi5NZXNzYWdlVHlwZSB0eXBlID0gODsKICogQHJldHVybiB7IXByb3RvLnBiLk1lc3NhZ2VUeXBlfQogKi8KCgpwcm90by5wYi5jbXMuQ2hhdE1lc3NhZ2VMaXN0UmVxdWVzdC5wcm90b3R5cGUuZ2V0VHlwZSA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQodGhpcywgOCwgMCk7Cn07Ci8qKgogKiBAcGFyYW0geyFwcm90by5wYi5NZXNzYWdlVHlwZX0gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5DaGF0TWVzc2FnZUxpc3RSZXF1ZXN0fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLkNoYXRNZXNzYWdlTGlzdFJlcXVlc3QucHJvdG90eXBlLnNldFR5cGUgPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0VudW1GaWVsZCh0aGlzLCA4LCB2YWx1ZSk7Cn07Ci8qKgogKiBvcHRpb25hbCBzdHJpbmcga2V5d29yZCA9IDk7CiAqIEByZXR1cm4ge3N0cmluZ30KICovCgoKcHJvdG8ucGIuY21zLkNoYXRNZXNzYWdlTGlzdFJlcXVlc3QucHJvdG90eXBlLmdldEtleXdvcmQgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDksICIiKTsKfTsKLyoqCiAqIEBwYXJhbSB7c3RyaW5nfSB2YWx1ZQogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLkNoYXRNZXNzYWdlTGlzdFJlcXVlc3R9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuQ2hhdE1lc3NhZ2VMaXN0UmVxdWVzdC5wcm90b3R5cGUuc2V0S2V5d29yZCA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UHJvdG8zU3RyaW5nRmllbGQodGhpcywgOSwgdmFsdWUpOwp9OwovKioKICogb3B0aW9uYWwgdWludDMyIGNyZWF0ZWRfc3RhcnQgPSAxMDsKICogQHJldHVybiB7bnVtYmVyfQogKi8KCgpwcm90by5wYi5jbXMuQ2hhdE1lc3NhZ2VMaXN0UmVxdWVzdC5wcm90b3R5cGUuZ2V0Q3JlYXRlZFN0YXJ0ID0gZnVuY3Rpb24gKCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdCh0aGlzLCAxMCwgMCk7Cn07Ci8qKgogKiBAcGFyYW0ge251bWJlcn0gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5DaGF0TWVzc2FnZUxpc3RSZXF1ZXN0fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLkNoYXRNZXNzYWdlTGlzdFJlcXVlc3QucHJvdG90eXBlLnNldENyZWF0ZWRTdGFydCA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UHJvdG8zSW50RmllbGQodGhpcywgMTAsIHZhbHVlKTsKfTsKLyoqCiAqIG9wdGlvbmFsIHVpbnQzMiBjcmVhdGVkX2VuZCA9IDExOwogKiBAcmV0dXJuIHtudW1iZXJ9CiAqLwoKCnByb3RvLnBiLmNtcy5DaGF0TWVzc2FnZUxpc3RSZXF1ZXN0LnByb3RvdHlwZS5nZXRDcmVhdGVkRW5kID0gZnVuY3Rpb24gKCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdCh0aGlzLCAxMSwgMCk7Cn07Ci8qKgogKiBAcGFyYW0ge251bWJlcn0gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5DaGF0TWVzc2FnZUxpc3RSZXF1ZXN0fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLkNoYXRNZXNzYWdlTGlzdFJlcXVlc3QucHJvdG90eXBlLnNldENyZWF0ZWRFbmQgPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0ludEZpZWxkKHRoaXMsIDExLCB2YWx1ZSk7Cn07Ci8qKgogKiBMaXN0IG9mIHJlcGVhdGVkIGZpZWxkcyB3aXRoaW4gdGhpcyBtZXNzYWdlIHR5cGUuCiAqIEBwcml2YXRlIHshQXJyYXk8bnVtYmVyPn0KICogQGNvbnN0CiAqLwoKCnByb3RvLnBiLmNtcy5DaGF0TWVzc2FnZUxpc3RSZXBseS5yZXBlYXRlZEZpZWxkc18gPSBbMV07CgppZiAoanNwYi5NZXNzYWdlLkdFTkVSQVRFX1RPX09CSkVDVCkgewogIC8qKgogICAqIENyZWF0ZXMgYW4gb2JqZWN0IHJlcHJlc2VudGF0aW9uIG9mIHRoaXMgcHJvdG8uCiAgICogRmllbGQgbmFtZXMgdGhhdCBhcmUgcmVzZXJ2ZWQgaW4gSmF2YVNjcmlwdCBhbmQgd2lsbCBiZSByZW5hbWVkIHRvIHBiX25hbWUuCiAgICogT3B0aW9uYWwgZmllbGRzIHRoYXQgYXJlIG5vdCBzZXQgd2lsbCBiZSBzZXQgdG8gdW5kZWZpbmVkLgogICAqIFRvIGFjY2VzcyBhIHJlc2VydmVkIGZpZWxkIHVzZSwgZm9vLnBiXzxuYW1lPiwgZWcsIGZvby5wYl9kZWZhdWx0LgogICAqIEZvciB0aGUgbGlzdCBvZiByZXNlcnZlZCBuYW1lcyBwbGVhc2Ugc2VlOgogICAqICAgICBuZXQvcHJvdG8yL2NvbXBpbGVyL2pzL2ludGVybmFsL2dlbmVyYXRvci5jYyNrS2V5d29yZC4KICAgKiBAcGFyYW0ge2Jvb2xlYW49fSBvcHRfaW5jbHVkZUluc3RhbmNlIERlcHJlY2F0ZWQuIHdoZXRoZXIgdG8gaW5jbHVkZSB0aGUKICAgKiAgICAgSlNQQiBpbnN0YW5jZSBmb3IgdHJhbnNpdGlvbmFsIHNveSBwcm90byBzdXBwb3J0OgogICAqICAgICBodHRwOi8vZ290by9zb3ktcGFyYW0tbWlncmF0aW9uCiAgICogQHJldHVybiB7IU9iamVjdH0KICAgKi8KICBwcm90by5wYi5jbXMuQ2hhdE1lc3NhZ2VMaXN0UmVwbHkucHJvdG90eXBlLnRvT2JqZWN0ID0gZnVuY3Rpb24gKG9wdF9pbmNsdWRlSW5zdGFuY2UpIHsKICAgIHJldHVybiBwcm90by5wYi5jbXMuQ2hhdE1lc3NhZ2VMaXN0UmVwbHkudG9PYmplY3Qob3B0X2luY2x1ZGVJbnN0YW5jZSwgdGhpcyk7CiAgfTsKICAvKioKICAgKiBTdGF0aWMgdmVyc2lvbiBvZiB0aGUge0BzZWUgdG9PYmplY3R9IG1ldGhvZC4KICAgKiBAcGFyYW0ge2Jvb2xlYW58dW5kZWZpbmVkfSBpbmNsdWRlSW5zdGFuY2UgRGVwcmVjYXRlZC4gV2hldGhlciB0byBpbmNsdWRlCiAgICogICAgIHRoZSBKU1BCIGluc3RhbmNlIGZvciB0cmFuc2l0aW9uYWwgc295IHByb3RvIHN1cHBvcnQ6CiAgICogICAgIGh0dHA6Ly9nb3RvL3NveS1wYXJhbS1taWdyYXRpb24KICAgKiBAcGFyYW0geyFwcm90by5wYi5jbXMuQ2hhdE1lc3NhZ2VMaXN0UmVwbHl9IG1zZyBUaGUgbXNnIGluc3RhbmNlIHRvIHRyYW5zZm9ybS4KICAgKiBAcmV0dXJuIHshT2JqZWN0fQogICAqIEBzdXBwcmVzcyB7dW51c2VkTG9jYWxWYXJpYWJsZXN9IGYgaXMgb25seSB1c2VkIGZvciBuZXN0ZWQgbWVzc2FnZXMKICAgKi8KCgogIHByb3RvLnBiLmNtcy5DaGF0TWVzc2FnZUxpc3RSZXBseS50b09iamVjdCA9IGZ1bmN0aW9uIChpbmNsdWRlSW5zdGFuY2UsIG1zZykgewogICAgdmFyIGYsCiAgICAgICAgb2JqID0gewogICAgICBtZXNzYWdlc0xpc3Q6IGpzcGIuTWVzc2FnZS50b09iamVjdExpc3QobXNnLmdldE1lc3NhZ2VzTGlzdCgpLCBjbXN0eXBlX3BiLkNoYXRNZXNzYWdlLnRvT2JqZWN0LCBpbmNsdWRlSW5zdGFuY2UpLAogICAgICBwYWdlTm86IGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KG1zZywgMiwgMCksCiAgICAgIHBhZ2VTaXplOiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdChtc2csIDMsIDApLAogICAgICB0b3RhbFBhZ2U6IGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KG1zZywgNCwgMCksCiAgICAgIHRvdGFsQ291bnQ6IGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KG1zZywgNSwgMCkKICAgIH07CgogICAgaWYgKGluY2x1ZGVJbnN0YW5jZSkgewogICAgICBvYmouJGpzcGJNZXNzYWdlSW5zdGFuY2UgPSBtc2c7CiAgICB9CgogICAgcmV0dXJuIG9iajsKICB9Owp9Ci8qKgogKiBEZXNlcmlhbGl6ZXMgYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUgZm9ybWF0KS4KICogQHBhcmFtIHtqc3BiLkJ5dGVTb3VyY2V9IGJ5dGVzIFRoZSBieXRlcyB0byBkZXNlcmlhbGl6ZS4KICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5DaGF0TWVzc2FnZUxpc3RSZXBseX0KICovCgoKcHJvdG8ucGIuY21zLkNoYXRNZXNzYWdlTGlzdFJlcGx5LmRlc2VyaWFsaXplQmluYXJ5ID0gZnVuY3Rpb24gKGJ5dGVzKSB7CiAgdmFyIHJlYWRlciA9IG5ldyBqc3BiLkJpbmFyeVJlYWRlcihieXRlcyk7CiAgdmFyIG1zZyA9IG5ldyBwcm90by5wYi5jbXMuQ2hhdE1lc3NhZ2VMaXN0UmVwbHkoKTsKICByZXR1cm4gcHJvdG8ucGIuY21zLkNoYXRNZXNzYWdlTGlzdFJlcGx5LmRlc2VyaWFsaXplQmluYXJ5RnJvbVJlYWRlcihtc2csIHJlYWRlcik7Cn07Ci8qKgogKiBEZXNlcmlhbGl6ZXMgYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUgZm9ybWF0KSBmcm9tIHRoZQogKiBnaXZlbiByZWFkZXIgaW50byB0aGUgZ2l2ZW4gbWVzc2FnZSBvYmplY3QuCiAqIEBwYXJhbSB7IXByb3RvLnBiLmNtcy5DaGF0TWVzc2FnZUxpc3RSZXBseX0gbXNnIFRoZSBtZXNzYWdlIG9iamVjdCB0byBkZXNlcmlhbGl6ZSBpbnRvLgogKiBAcGFyYW0geyFqc3BiLkJpbmFyeVJlYWRlcn0gcmVhZGVyIFRoZSBCaW5hcnlSZWFkZXIgdG8gdXNlLgogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLkNoYXRNZXNzYWdlTGlzdFJlcGx5fQogKi8KCgpwcm90by5wYi5jbXMuQ2hhdE1lc3NhZ2VMaXN0UmVwbHkuZGVzZXJpYWxpemVCaW5hcnlGcm9tUmVhZGVyID0gZnVuY3Rpb24gKG1zZywgcmVhZGVyKSB7CiAgd2hpbGUgKHJlYWRlci5uZXh0RmllbGQoKSkgewogICAgaWYgKHJlYWRlci5pc0VuZEdyb3VwKCkpIHsKICAgICAgYnJlYWs7CiAgICB9CgogICAgdmFyIGZpZWxkID0gcmVhZGVyLmdldEZpZWxkTnVtYmVyKCk7CgogICAgc3dpdGNoIChmaWVsZCkgewogICAgICBjYXNlIDE6CiAgICAgICAgdmFyIHZhbHVlID0gbmV3IGNtc3R5cGVfcGIuQ2hhdE1lc3NhZ2UoKTsKICAgICAgICByZWFkZXIucmVhZE1lc3NhZ2UodmFsdWUsIGNtc3R5cGVfcGIuQ2hhdE1lc3NhZ2UuZGVzZXJpYWxpemVCaW5hcnlGcm9tUmVhZGVyKTsKICAgICAgICBtc2cuYWRkTWVzc2FnZXModmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSAyOgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkVWludDMyKCk7CiAgICAgICAgbXNnLnNldFBhZ2VObyh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlIDM6CiAgICAgICAgdmFyIHZhbHVlID0gcmVhZGVyLnJlYWRVaW50MzIoKTsKICAgICAgICBtc2cuc2V0UGFnZVNpemUodmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSA0OgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkVWludDMyKCk7CiAgICAgICAgbXNnLnNldFRvdGFsUGFnZSh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlIDU6CiAgICAgICAgdmFyIHZhbHVlID0gcmVhZGVyLnJlYWRVaW50MzIoKTsKICAgICAgICBtc2cuc2V0VG90YWxDb3VudCh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBkZWZhdWx0OgogICAgICAgIHJlYWRlci5za2lwRmllbGQoKTsKICAgICAgICBicmVhazsKICAgIH0KICB9CgogIHJldHVybiBtc2c7Cn07Ci8qKgogKiBTZXJpYWxpemVzIHRoZSBtZXNzYWdlIHRvIGJpbmFyeSBkYXRhIChpbiBwcm90b2J1ZiB3aXJlIGZvcm1hdCkuCiAqIEByZXR1cm4geyFVaW50OEFycmF5fQogKi8KCgpwcm90by5wYi5jbXMuQ2hhdE1lc3NhZ2VMaXN0UmVwbHkucHJvdG90eXBlLnNlcmlhbGl6ZUJpbmFyeSA9IGZ1bmN0aW9uICgpIHsKICB2YXIgd3JpdGVyID0gbmV3IGpzcGIuQmluYXJ5V3JpdGVyKCk7CiAgcHJvdG8ucGIuY21zLkNoYXRNZXNzYWdlTGlzdFJlcGx5LnNlcmlhbGl6ZUJpbmFyeVRvV3JpdGVyKHRoaXMsIHdyaXRlcik7CiAgcmV0dXJuIHdyaXRlci5nZXRSZXN1bHRCdWZmZXIoKTsKfTsKLyoqCiAqIFNlcmlhbGl6ZXMgdGhlIGdpdmVuIG1lc3NhZ2UgdG8gYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUKICogZm9ybWF0KSwgd3JpdGluZyB0byB0aGUgZ2l2ZW4gQmluYXJ5V3JpdGVyLgogKiBAcGFyYW0geyFwcm90by5wYi5jbXMuQ2hhdE1lc3NhZ2VMaXN0UmVwbHl9IG1lc3NhZ2UKICogQHBhcmFtIHshanNwYi5CaW5hcnlXcml0ZXJ9IHdyaXRlcgogKiBAc3VwcHJlc3Mge3VudXNlZExvY2FsVmFyaWFibGVzfSBmIGlzIG9ubHkgdXNlZCBmb3IgbmVzdGVkIG1lc3NhZ2VzCiAqLwoKCnByb3RvLnBiLmNtcy5DaGF0TWVzc2FnZUxpc3RSZXBseS5zZXJpYWxpemVCaW5hcnlUb1dyaXRlciA9IGZ1bmN0aW9uIChtZXNzYWdlLCB3cml0ZXIpIHsKICB2YXIgZiA9IHVuZGVmaW5lZDsKICBmID0gbWVzc2FnZS5nZXRNZXNzYWdlc0xpc3QoKTsKCiAgaWYgKGYubGVuZ3RoID4gMCkgewogICAgd3JpdGVyLndyaXRlUmVwZWF0ZWRNZXNzYWdlKDEsIGYsIGNtc3R5cGVfcGIuQ2hhdE1lc3NhZ2Uuc2VyaWFsaXplQmluYXJ5VG9Xcml0ZXIpOwogIH0KCiAgZiA9IG1lc3NhZ2UuZ2V0UGFnZU5vKCk7CgogIGlmIChmICE9PSAwKSB7CiAgICB3cml0ZXIud3JpdGVVaW50MzIoMiwgZik7CiAgfQoKICBmID0gbWVzc2FnZS5nZXRQYWdlU2l6ZSgpOwoKICBpZiAoZiAhPT0gMCkgewogICAgd3JpdGVyLndyaXRlVWludDMyKDMsIGYpOwogIH0KCiAgZiA9IG1lc3NhZ2UuZ2V0VG90YWxQYWdlKCk7CgogIGlmIChmICE9PSAwKSB7CiAgICB3cml0ZXIud3JpdGVVaW50MzIoNCwgZik7CiAgfQoKICBmID0gbWVzc2FnZS5nZXRUb3RhbENvdW50KCk7CgogIGlmIChmICE9PSAwKSB7CiAgICB3cml0ZXIud3JpdGVVaW50MzIoNSwgZik7CiAgfQp9OwovKioKICogcmVwZWF0ZWQgcGIuQ2hhdE1lc3NhZ2UgbWVzc2FnZXMgPSAxOwogKiBAcmV0dXJuIHshQXJyYXk8IXByb3RvLnBiLkNoYXRNZXNzYWdlPn0KICovCgoKcHJvdG8ucGIuY21zLkNoYXRNZXNzYWdlTGlzdFJlcGx5LnByb3RvdHlwZS5nZXRNZXNzYWdlc0xpc3QgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRSZXBlYXRlZFdyYXBwZXJGaWVsZCh0aGlzLCBjbXN0eXBlX3BiLkNoYXRNZXNzYWdlLCAxKTsKfTsKLyoqCiAqIEBwYXJhbSB7IUFycmF5PCFwcm90by5wYi5DaGF0TWVzc2FnZT59IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuQ2hhdE1lc3NhZ2VMaXN0UmVwbHl9IHJldHVybnMgdGhpcwoqLwoKCnByb3RvLnBiLmNtcy5DaGF0TWVzc2FnZUxpc3RSZXBseS5wcm90b3R5cGUuc2V0TWVzc2FnZXNMaXN0ID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRSZXBlYXRlZFdyYXBwZXJGaWVsZCh0aGlzLCAxLCB2YWx1ZSk7Cn07Ci8qKgogKiBAcGFyYW0geyFwcm90by5wYi5DaGF0TWVzc2FnZT19IG9wdF92YWx1ZQogKiBAcGFyYW0ge251bWJlcj19IG9wdF9pbmRleAogKiBAcmV0dXJuIHshcHJvdG8ucGIuQ2hhdE1lc3NhZ2V9CiAqLwoKCnByb3RvLnBiLmNtcy5DaGF0TWVzc2FnZUxpc3RSZXBseS5wcm90b3R5cGUuYWRkTWVzc2FnZXMgPSBmdW5jdGlvbiAob3B0X3ZhbHVlLCBvcHRfaW5kZXgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmFkZFRvUmVwZWF0ZWRXcmFwcGVyRmllbGQodGhpcywgMSwgb3B0X3ZhbHVlLCBwcm90by5wYi5DaGF0TWVzc2FnZSwgb3B0X2luZGV4KTsKfTsKLyoqCiAqIENsZWFycyB0aGUgbGlzdCBtYWtpbmcgaXQgZW1wdHkgYnV0IG5vbi1udWxsLgogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLkNoYXRNZXNzYWdlTGlzdFJlcGx5fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLkNoYXRNZXNzYWdlTGlzdFJlcGx5LnByb3RvdHlwZS5jbGVhck1lc3NhZ2VzTGlzdCA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4gdGhpcy5zZXRNZXNzYWdlc0xpc3QoW10pOwp9OwovKioKICogb3B0aW9uYWwgdWludDMyIHBhZ2Vfbm8gPSAyOwogKiBAcmV0dXJuIHtudW1iZXJ9CiAqLwoKCnByb3RvLnBiLmNtcy5DaGF0TWVzc2FnZUxpc3RSZXBseS5wcm90b3R5cGUuZ2V0UGFnZU5vID0gZnVuY3Rpb24gKCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdCh0aGlzLCAyLCAwKTsKfTsKLyoqCiAqIEBwYXJhbSB7bnVtYmVyfSB2YWx1ZQogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLkNoYXRNZXNzYWdlTGlzdFJlcGx5fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLkNoYXRNZXNzYWdlTGlzdFJlcGx5LnByb3RvdHlwZS5zZXRQYWdlTm8gPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0ludEZpZWxkKHRoaXMsIDIsIHZhbHVlKTsKfTsKLyoqCiAqIG9wdGlvbmFsIHVpbnQzMiBwYWdlX3NpemUgPSAzOwogKiBAcmV0dXJuIHtudW1iZXJ9CiAqLwoKCnByb3RvLnBiLmNtcy5DaGF0TWVzc2FnZUxpc3RSZXBseS5wcm90b3R5cGUuZ2V0UGFnZVNpemUgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDMsIDApOwp9OwovKioKICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuQ2hhdE1lc3NhZ2VMaXN0UmVwbHl9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuQ2hhdE1lc3NhZ2VMaXN0UmVwbHkucHJvdG90eXBlLnNldFBhZ2VTaXplID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRQcm90bzNJbnRGaWVsZCh0aGlzLCAzLCB2YWx1ZSk7Cn07Ci8qKgogKiBvcHRpb25hbCB1aW50MzIgdG90YWxfcGFnZSA9IDQ7CiAqIEByZXR1cm4ge251bWJlcn0KICovCgoKcHJvdG8ucGIuY21zLkNoYXRNZXNzYWdlTGlzdFJlcGx5LnByb3RvdHlwZS5nZXRUb3RhbFBhZ2UgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDQsIDApOwp9OwovKioKICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuQ2hhdE1lc3NhZ2VMaXN0UmVwbHl9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuQ2hhdE1lc3NhZ2VMaXN0UmVwbHkucHJvdG90eXBlLnNldFRvdGFsUGFnZSA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UHJvdG8zSW50RmllbGQodGhpcywgNCwgdmFsdWUpOwp9OwovKioKICogb3B0aW9uYWwgdWludDMyIHRvdGFsX2NvdW50ID0gNTsKICogQHJldHVybiB7bnVtYmVyfQogKi8KCgpwcm90by5wYi5jbXMuQ2hhdE1lc3NhZ2VMaXN0UmVwbHkucHJvdG90eXBlLmdldFRvdGFsQ291bnQgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDUsIDApOwp9OwovKioKICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuQ2hhdE1lc3NhZ2VMaXN0UmVwbHl9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuQ2hhdE1lc3NhZ2VMaXN0UmVwbHkucHJvdG90eXBlLnNldFRvdGFsQ291bnQgPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0ludEZpZWxkKHRoaXMsIDUsIHZhbHVlKTsKfTsKCmlmIChqc3BiLk1lc3NhZ2UuR0VORVJBVEVfVE9fT0JKRUNUKSB7CiAgLyoqCiAgICogQ3JlYXRlcyBhbiBvYmplY3QgcmVwcmVzZW50YXRpb24gb2YgdGhpcyBwcm90by4KICAgKiBGaWVsZCBuYW1lcyB0aGF0IGFyZSByZXNlcnZlZCBpbiBKYXZhU2NyaXB0IGFuZCB3aWxsIGJlIHJlbmFtZWQgdG8gcGJfbmFtZS4KICAgKiBPcHRpb25hbCBmaWVsZHMgdGhhdCBhcmUgbm90IHNldCB3aWxsIGJlIHNldCB0byB1bmRlZmluZWQuCiAgICogVG8gYWNjZXNzIGEgcmVzZXJ2ZWQgZmllbGQgdXNlLCBmb28ucGJfPG5hbWU+LCBlZywgZm9vLnBiX2RlZmF1bHQuCiAgICogRm9yIHRoZSBsaXN0IG9mIHJlc2VydmVkIG5hbWVzIHBsZWFzZSBzZWU6CiAgICogICAgIG5ldC9wcm90bzIvY29tcGlsZXIvanMvaW50ZXJuYWwvZ2VuZXJhdG9yLmNjI2tLZXl3b3JkLgogICAqIEBwYXJhbSB7Ym9vbGVhbj19IG9wdF9pbmNsdWRlSW5zdGFuY2UgRGVwcmVjYXRlZC4gd2hldGhlciB0byBpbmNsdWRlIHRoZQogICAqICAgICBKU1BCIGluc3RhbmNlIGZvciB0cmFuc2l0aW9uYWwgc295IHByb3RvIHN1cHBvcnQ6CiAgICogICAgIGh0dHA6Ly9nb3RvL3NveS1wYXJhbS1taWdyYXRpb24KICAgKiBAcmV0dXJuIHshT2JqZWN0fQogICAqLwogIHByb3RvLnBiLmNtcy5DYWxsTGlzdFJlcXVlc3QucHJvdG90eXBlLnRvT2JqZWN0ID0gZnVuY3Rpb24gKG9wdF9pbmNsdWRlSW5zdGFuY2UpIHsKICAgIHJldHVybiBwcm90by5wYi5jbXMuQ2FsbExpc3RSZXF1ZXN0LnRvT2JqZWN0KG9wdF9pbmNsdWRlSW5zdGFuY2UsIHRoaXMpOwogIH07CiAgLyoqCiAgICogU3RhdGljIHZlcnNpb24gb2YgdGhlIHtAc2VlIHRvT2JqZWN0fSBtZXRob2QuCiAgICogQHBhcmFtIHtib29sZWFufHVuZGVmaW5lZH0gaW5jbHVkZUluc3RhbmNlIERlcHJlY2F0ZWQuIFdoZXRoZXIgdG8gaW5jbHVkZQogICAqICAgICB0aGUgSlNQQiBpbnN0YW5jZSBmb3IgdHJhbnNpdGlvbmFsIHNveSBwcm90byBzdXBwb3J0OgogICAqICAgICBodHRwOi8vZ290by9zb3ktcGFyYW0tbWlncmF0aW9uCiAgICogQHBhcmFtIHshcHJvdG8ucGIuY21zLkNhbGxMaXN0UmVxdWVzdH0gbXNnIFRoZSBtc2cgaW5zdGFuY2UgdG8gdHJhbnNmb3JtLgogICAqIEByZXR1cm4geyFPYmplY3R9CiAgICogQHN1cHByZXNzIHt1bnVzZWRMb2NhbFZhcmlhYmxlc30gZiBpcyBvbmx5IHVzZWQgZm9yIG5lc3RlZCBtZXNzYWdlcwogICAqLwoKCiAgcHJvdG8ucGIuY21zLkNhbGxMaXN0UmVxdWVzdC50b09iamVjdCA9IGZ1bmN0aW9uIChpbmNsdWRlSW5zdGFuY2UsIG1zZykgewogICAgdmFyIGYsCiAgICAgICAgb2JqID0gewogICAgICBwYWdlTm86IGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KG1zZywgMSwgMCksCiAgICAgIHBhZ2VTaXplOiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdChtc2csIDIsIDApLAogICAgICBhcmVhSWQ6IGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KG1zZywgMywgMCksCiAgICAgIGFwcElkOiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdChtc2csIDQsIDApLAogICAgICB1c2VySWQ6IGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KG1zZywgNSwgMCksCiAgICAgIGFuY2hvcklkOiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdChtc2csIDYsIDApLAogICAgICBjYWxsVHlwZToganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQobXNnLCA3LCAwKSwKICAgICAgaGFuZ1R5cGU6IGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KG1zZywgOCwgMCksCiAgICAgIHN0YXR1czoganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQobXNnLCA5LCAwKSwKICAgICAgbWluRHVyYXRpb246IGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KG1zZywgMTAsIDApLAogICAgICBtYXhEdXJhdGlvbjoganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQobXNnLCAxMSwgMCksCiAgICAgIGNyZWF0ZWRTdGFydDoganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQobXNnLCAxMiwgMCksCiAgICAgIGNyZWF0ZWRFbmQ6IGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KG1zZywgMTMsIDApCiAgICB9OwoKICAgIGlmIChpbmNsdWRlSW5zdGFuY2UpIHsKICAgICAgb2JqLiRqc3BiTWVzc2FnZUluc3RhbmNlID0gbXNnOwogICAgfQoKICAgIHJldHVybiBvYmo7CiAgfTsKfQovKioKICogRGVzZXJpYWxpemVzIGJpbmFyeSBkYXRhIChpbiBwcm90b2J1ZiB3aXJlIGZvcm1hdCkuCiAqIEBwYXJhbSB7anNwYi5CeXRlU291cmNlfSBieXRlcyBUaGUgYnl0ZXMgdG8gZGVzZXJpYWxpemUuCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuQ2FsbExpc3RSZXF1ZXN0fQogKi8KCgpwcm90by5wYi5jbXMuQ2FsbExpc3RSZXF1ZXN0LmRlc2VyaWFsaXplQmluYXJ5ID0gZnVuY3Rpb24gKGJ5dGVzKSB7CiAgdmFyIHJlYWRlciA9IG5ldyBqc3BiLkJpbmFyeVJlYWRlcihieXRlcyk7CiAgdmFyIG1zZyA9IG5ldyBwcm90by5wYi5jbXMuQ2FsbExpc3RSZXF1ZXN0KCk7CiAgcmV0dXJuIHByb3RvLnBiLmNtcy5DYWxsTGlzdFJlcXVlc3QuZGVzZXJpYWxpemVCaW5hcnlGcm9tUmVhZGVyKG1zZywgcmVhZGVyKTsKfTsKLyoqCiAqIERlc2VyaWFsaXplcyBiaW5hcnkgZGF0YSAoaW4gcHJvdG9idWYgd2lyZSBmb3JtYXQpIGZyb20gdGhlCiAqIGdpdmVuIHJlYWRlciBpbnRvIHRoZSBnaXZlbiBtZXNzYWdlIG9iamVjdC4KICogQHBhcmFtIHshcHJvdG8ucGIuY21zLkNhbGxMaXN0UmVxdWVzdH0gbXNnIFRoZSBtZXNzYWdlIG9iamVjdCB0byBkZXNlcmlhbGl6ZSBpbnRvLgogKiBAcGFyYW0geyFqc3BiLkJpbmFyeVJlYWRlcn0gcmVhZGVyIFRoZSBCaW5hcnlSZWFkZXIgdG8gdXNlLgogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLkNhbGxMaXN0UmVxdWVzdH0KICovCgoKcHJvdG8ucGIuY21zLkNhbGxMaXN0UmVxdWVzdC5kZXNlcmlhbGl6ZUJpbmFyeUZyb21SZWFkZXIgPSBmdW5jdGlvbiAobXNnLCByZWFkZXIpIHsKICB3aGlsZSAocmVhZGVyLm5leHRGaWVsZCgpKSB7CiAgICBpZiAocmVhZGVyLmlzRW5kR3JvdXAoKSkgewogICAgICBicmVhazsKICAgIH0KCiAgICB2YXIgZmllbGQgPSByZWFkZXIuZ2V0RmllbGROdW1iZXIoKTsKCiAgICBzd2l0Y2ggKGZpZWxkKSB7CiAgICAgIGNhc2UgMToKICAgICAgICB2YXIgdmFsdWUgPSByZWFkZXIucmVhZFVpbnQzMigpOwogICAgICAgIG1zZy5zZXRQYWdlTm8odmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSAyOgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkVWludDMyKCk7CiAgICAgICAgbXNnLnNldFBhZ2VTaXplKHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgMzoKICAgICAgICB2YXIgdmFsdWUgPSByZWFkZXIucmVhZFVpbnQzMigpOwogICAgICAgIG1zZy5zZXRBcmVhSWQodmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSA0OgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkVWludDMyKCk7CiAgICAgICAgbXNnLnNldEFwcElkKHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgNToKICAgICAgICB2YXIgdmFsdWUgPSByZWFkZXIucmVhZFVpbnQzMigpOwogICAgICAgIG1zZy5zZXRVc2VySWQodmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSA2OgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkVWludDMyKCk7CiAgICAgICAgbXNnLnNldEFuY2hvcklkKHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgNzoKICAgICAgICB2YXIgdmFsdWUgPSByZWFkZXIucmVhZEVudW0oKTsKICAgICAgICBtc2cuc2V0Q2FsbFR5cGUodmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSA4OgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkRW51bSgpOwogICAgICAgIG1zZy5zZXRIYW5nVHlwZSh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlIDk6CiAgICAgICAgdmFyIHZhbHVlID0gcmVhZGVyLnJlYWRFbnVtKCk7CiAgICAgICAgbXNnLnNldFN0YXR1cyh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlIDEwOgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkVWludDMyKCk7CiAgICAgICAgbXNnLnNldE1pbkR1cmF0aW9uKHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgMTE6CiAgICAgICAgdmFyIHZhbHVlID0gcmVhZGVyLnJlYWRVaW50MzIoKTsKICAgICAgICBtc2cuc2V0TWF4RHVyYXRpb24odmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSAxMjoKICAgICAgICB2YXIgdmFsdWUgPSByZWFkZXIucmVhZFVpbnQzMigpOwogICAgICAgIG1zZy5zZXRDcmVhdGVkU3RhcnQodmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSAxMzoKICAgICAgICB2YXIgdmFsdWUgPSByZWFkZXIucmVhZFVpbnQzMigpOwogICAgICAgIG1zZy5zZXRDcmVhdGVkRW5kKHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGRlZmF1bHQ6CiAgICAgICAgcmVhZGVyLnNraXBGaWVsZCgpOwogICAgICAgIGJyZWFrOwogICAgfQogIH0KCiAgcmV0dXJuIG1zZzsKfTsKLyoqCiAqIFNlcmlhbGl6ZXMgdGhlIG1lc3NhZ2UgdG8gYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUgZm9ybWF0KS4KICogQHJldHVybiB7IVVpbnQ4QXJyYXl9CiAqLwoKCnByb3RvLnBiLmNtcy5DYWxsTGlzdFJlcXVlc3QucHJvdG90eXBlLnNlcmlhbGl6ZUJpbmFyeSA9IGZ1bmN0aW9uICgpIHsKICB2YXIgd3JpdGVyID0gbmV3IGpzcGIuQmluYXJ5V3JpdGVyKCk7CiAgcHJvdG8ucGIuY21zLkNhbGxMaXN0UmVxdWVzdC5zZXJpYWxpemVCaW5hcnlUb1dyaXRlcih0aGlzLCB3cml0ZXIpOwogIHJldHVybiB3cml0ZXIuZ2V0UmVzdWx0QnVmZmVyKCk7Cn07Ci8qKgogKiBTZXJpYWxpemVzIHRoZSBnaXZlbiBtZXNzYWdlIHRvIGJpbmFyeSBkYXRhIChpbiBwcm90b2J1ZiB3aXJlCiAqIGZvcm1hdCksIHdyaXRpbmcgdG8gdGhlIGdpdmVuIEJpbmFyeVdyaXRlci4KICogQHBhcmFtIHshcHJvdG8ucGIuY21zLkNhbGxMaXN0UmVxdWVzdH0gbWVzc2FnZQogKiBAcGFyYW0geyFqc3BiLkJpbmFyeVdyaXRlcn0gd3JpdGVyCiAqIEBzdXBwcmVzcyB7dW51c2VkTG9jYWxWYXJpYWJsZXN9IGYgaXMgb25seSB1c2VkIGZvciBuZXN0ZWQgbWVzc2FnZXMKICovCgoKcHJvdG8ucGIuY21zLkNhbGxMaXN0UmVxdWVzdC5zZXJpYWxpemVCaW5hcnlUb1dyaXRlciA9IGZ1bmN0aW9uIChtZXNzYWdlLCB3cml0ZXIpIHsKICB2YXIgZiA9IHVuZGVmaW5lZDsKICBmID0gbWVzc2FnZS5nZXRQYWdlTm8oKTsKCiAgaWYgKGYgIT09IDApIHsKICAgIHdyaXRlci53cml0ZVVpbnQzMigxLCBmKTsKICB9CgogIGYgPSBtZXNzYWdlLmdldFBhZ2VTaXplKCk7CgogIGlmIChmICE9PSAwKSB7CiAgICB3cml0ZXIud3JpdGVVaW50MzIoMiwgZik7CiAgfQoKICBmID0gbWVzc2FnZS5nZXRBcmVhSWQoKTsKCiAgaWYgKGYgIT09IDApIHsKICAgIHdyaXRlci53cml0ZVVpbnQzMigzLCBmKTsKICB9CgogIGYgPSBtZXNzYWdlLmdldEFwcElkKCk7CgogIGlmIChmICE9PSAwKSB7CiAgICB3cml0ZXIud3JpdGVVaW50MzIoNCwgZik7CiAgfQoKICBmID0gbWVzc2FnZS5nZXRVc2VySWQoKTsKCiAgaWYgKGYgIT09IDApIHsKICAgIHdyaXRlci53cml0ZVVpbnQzMig1LCBmKTsKICB9CgogIGYgPSBtZXNzYWdlLmdldEFuY2hvcklkKCk7CgogIGlmIChmICE9PSAwKSB7CiAgICB3cml0ZXIud3JpdGVVaW50MzIoNiwgZik7CiAgfQoKICBmID0gbWVzc2FnZS5nZXRDYWxsVHlwZSgpOwoKICBpZiAoZiAhPT0gMC4wKSB7CiAgICB3cml0ZXIud3JpdGVFbnVtKDcsIGYpOwogIH0KCiAgZiA9IG1lc3NhZ2UuZ2V0SGFuZ1R5cGUoKTsKCiAgaWYgKGYgIT09IDAuMCkgewogICAgd3JpdGVyLndyaXRlRW51bSg4LCBmKTsKICB9CgogIGYgPSBtZXNzYWdlLmdldFN0YXR1cygpOwoKICBpZiAoZiAhPT0gMC4wKSB7CiAgICB3cml0ZXIud3JpdGVFbnVtKDksIGYpOwogIH0KCiAgZiA9IG1lc3NhZ2UuZ2V0TWluRHVyYXRpb24oKTsKCiAgaWYgKGYgIT09IDApIHsKICAgIHdyaXRlci53cml0ZVVpbnQzMigxMCwgZik7CiAgfQoKICBmID0gbWVzc2FnZS5nZXRNYXhEdXJhdGlvbigpOwoKICBpZiAoZiAhPT0gMCkgewogICAgd3JpdGVyLndyaXRlVWludDMyKDExLCBmKTsKICB9CgogIGYgPSBtZXNzYWdlLmdldENyZWF0ZWRTdGFydCgpOwoKICBpZiAoZiAhPT0gMCkgewogICAgd3JpdGVyLndyaXRlVWludDMyKDEyLCBmKTsKICB9CgogIGYgPSBtZXNzYWdlLmdldENyZWF0ZWRFbmQoKTsKCiAgaWYgKGYgIT09IDApIHsKICAgIHdyaXRlci53cml0ZVVpbnQzMigxMywgZik7CiAgfQp9OwovKioKICogb3B0aW9uYWwgdWludDMyIHBhZ2Vfbm8gPSAxOwogKiBAcmV0dXJuIHtudW1iZXJ9CiAqLwoKCnByb3RvLnBiLmNtcy5DYWxsTGlzdFJlcXVlc3QucHJvdG90eXBlLmdldFBhZ2VObyA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQodGhpcywgMSwgMCk7Cn07Ci8qKgogKiBAcGFyYW0ge251bWJlcn0gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5DYWxsTGlzdFJlcXVlc3R9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuQ2FsbExpc3RSZXF1ZXN0LnByb3RvdHlwZS5zZXRQYWdlTm8gPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0ludEZpZWxkKHRoaXMsIDEsIHZhbHVlKTsKfTsKLyoqCiAqIG9wdGlvbmFsIHVpbnQzMiBwYWdlX3NpemUgPSAyOwogKiBAcmV0dXJuIHtudW1iZXJ9CiAqLwoKCnByb3RvLnBiLmNtcy5DYWxsTGlzdFJlcXVlc3QucHJvdG90eXBlLmdldFBhZ2VTaXplID0gZnVuY3Rpb24gKCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdCh0aGlzLCAyLCAwKTsKfTsKLyoqCiAqIEBwYXJhbSB7bnVtYmVyfSB2YWx1ZQogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLkNhbGxMaXN0UmVxdWVzdH0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5DYWxsTGlzdFJlcXVlc3QucHJvdG90eXBlLnNldFBhZ2VTaXplID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRQcm90bzNJbnRGaWVsZCh0aGlzLCAyLCB2YWx1ZSk7Cn07Ci8qKgogKiBvcHRpb25hbCB1aW50MzIgYXJlYV9pZCA9IDM7CiAqIEByZXR1cm4ge251bWJlcn0KICovCgoKcHJvdG8ucGIuY21zLkNhbGxMaXN0UmVxdWVzdC5wcm90b3R5cGUuZ2V0QXJlYUlkID0gZnVuY3Rpb24gKCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdCh0aGlzLCAzLCAwKTsKfTsKLyoqCiAqIEBwYXJhbSB7bnVtYmVyfSB2YWx1ZQogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLkNhbGxMaXN0UmVxdWVzdH0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5DYWxsTGlzdFJlcXVlc3QucHJvdG90eXBlLnNldEFyZWFJZCA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UHJvdG8zSW50RmllbGQodGhpcywgMywgdmFsdWUpOwp9OwovKioKICogb3B0aW9uYWwgdWludDMyIGFwcF9pZCA9IDQ7CiAqIEByZXR1cm4ge251bWJlcn0KICovCgoKcHJvdG8ucGIuY21zLkNhbGxMaXN0UmVxdWVzdC5wcm90b3R5cGUuZ2V0QXBwSWQgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDQsIDApOwp9OwovKioKICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuQ2FsbExpc3RSZXF1ZXN0fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLkNhbGxMaXN0UmVxdWVzdC5wcm90b3R5cGUuc2V0QXBwSWQgPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0ludEZpZWxkKHRoaXMsIDQsIHZhbHVlKTsKfTsKLyoqCiAqIG9wdGlvbmFsIHVpbnQzMiB1c2VyX2lkID0gNTsKICogQHJldHVybiB7bnVtYmVyfQogKi8KCgpwcm90by5wYi5jbXMuQ2FsbExpc3RSZXF1ZXN0LnByb3RvdHlwZS5nZXRVc2VySWQgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDUsIDApOwp9OwovKioKICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuQ2FsbExpc3RSZXF1ZXN0fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLkNhbGxMaXN0UmVxdWVzdC5wcm90b3R5cGUuc2V0VXNlcklkID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRQcm90bzNJbnRGaWVsZCh0aGlzLCA1LCB2YWx1ZSk7Cn07Ci8qKgogKiBvcHRpb25hbCB1aW50MzIgYW5jaG9yX2lkID0gNjsKICogQHJldHVybiB7bnVtYmVyfQogKi8KCgpwcm90by5wYi5jbXMuQ2FsbExpc3RSZXF1ZXN0LnByb3RvdHlwZS5nZXRBbmNob3JJZCA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQodGhpcywgNiwgMCk7Cn07Ci8qKgogKiBAcGFyYW0ge251bWJlcn0gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5DYWxsTGlzdFJlcXVlc3R9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuQ2FsbExpc3RSZXF1ZXN0LnByb3RvdHlwZS5zZXRBbmNob3JJZCA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UHJvdG8zSW50RmllbGQodGhpcywgNiwgdmFsdWUpOwp9OwovKioKICogb3B0aW9uYWwgcGIuQ2FsbFR5cGUgY2FsbF90eXBlID0gNzsKICogQHJldHVybiB7IXByb3RvLnBiLkNhbGxUeXBlfQogKi8KCgpwcm90by5wYi5jbXMuQ2FsbExpc3RSZXF1ZXN0LnByb3RvdHlwZS5nZXRDYWxsVHlwZSA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQodGhpcywgNywgMCk7Cn07Ci8qKgogKiBAcGFyYW0geyFwcm90by5wYi5DYWxsVHlwZX0gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5DYWxsTGlzdFJlcXVlc3R9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuQ2FsbExpc3RSZXF1ZXN0LnByb3RvdHlwZS5zZXRDYWxsVHlwZSA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UHJvdG8zRW51bUZpZWxkKHRoaXMsIDcsIHZhbHVlKTsKfTsKLyoqCiAqIG9wdGlvbmFsIHBiLkhhbmdUeXBlIGhhbmdfdHlwZSA9IDg7CiAqIEByZXR1cm4geyFwcm90by5wYi5IYW5nVHlwZX0KICovCgoKcHJvdG8ucGIuY21zLkNhbGxMaXN0UmVxdWVzdC5wcm90b3R5cGUuZ2V0SGFuZ1R5cGUgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDgsIDApOwp9OwovKioKICogQHBhcmFtIHshcHJvdG8ucGIuSGFuZ1R5cGV9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuQ2FsbExpc3RSZXF1ZXN0fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLkNhbGxMaXN0UmVxdWVzdC5wcm90b3R5cGUuc2V0SGFuZ1R5cGUgPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0VudW1GaWVsZCh0aGlzLCA4LCB2YWx1ZSk7Cn07Ci8qKgogKiBvcHRpb25hbCBwYi5DYWxsU3RhdHVzIHN0YXR1cyA9IDk7CiAqIEByZXR1cm4geyFwcm90by5wYi5DYWxsU3RhdHVzfQogKi8KCgpwcm90by5wYi5jbXMuQ2FsbExpc3RSZXF1ZXN0LnByb3RvdHlwZS5nZXRTdGF0dXMgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDksIDApOwp9OwovKioKICogQHBhcmFtIHshcHJvdG8ucGIuQ2FsbFN0YXR1c30gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5DYWxsTGlzdFJlcXVlc3R9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuQ2FsbExpc3RSZXF1ZXN0LnByb3RvdHlwZS5zZXRTdGF0dXMgPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0VudW1GaWVsZCh0aGlzLCA5LCB2YWx1ZSk7Cn07Ci8qKgogKiBvcHRpb25hbCB1aW50MzIgbWluX2R1cmF0aW9uID0gMTA7CiAqIEByZXR1cm4ge251bWJlcn0KICovCgoKcHJvdG8ucGIuY21zLkNhbGxMaXN0UmVxdWVzdC5wcm90b3R5cGUuZ2V0TWluRHVyYXRpb24gPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDEwLCAwKTsKfTsKLyoqCiAqIEBwYXJhbSB7bnVtYmVyfSB2YWx1ZQogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLkNhbGxMaXN0UmVxdWVzdH0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5DYWxsTGlzdFJlcXVlc3QucHJvdG90eXBlLnNldE1pbkR1cmF0aW9uID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRQcm90bzNJbnRGaWVsZCh0aGlzLCAxMCwgdmFsdWUpOwp9OwovKioKICogb3B0aW9uYWwgdWludDMyIG1heF9kdXJhdGlvbiA9IDExOwogKiBAcmV0dXJuIHtudW1iZXJ9CiAqLwoKCnByb3RvLnBiLmNtcy5DYWxsTGlzdFJlcXVlc3QucHJvdG90eXBlLmdldE1heER1cmF0aW9uID0gZnVuY3Rpb24gKCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdCh0aGlzLCAxMSwgMCk7Cn07Ci8qKgogKiBAcGFyYW0ge251bWJlcn0gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5DYWxsTGlzdFJlcXVlc3R9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuQ2FsbExpc3RSZXF1ZXN0LnByb3RvdHlwZS5zZXRNYXhEdXJhdGlvbiA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UHJvdG8zSW50RmllbGQodGhpcywgMTEsIHZhbHVlKTsKfTsKLyoqCiAqIG9wdGlvbmFsIHVpbnQzMiBjcmVhdGVkX3N0YXJ0ID0gMTI7CiAqIEByZXR1cm4ge251bWJlcn0KICovCgoKcHJvdG8ucGIuY21zLkNhbGxMaXN0UmVxdWVzdC5wcm90b3R5cGUuZ2V0Q3JlYXRlZFN0YXJ0ID0gZnVuY3Rpb24gKCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdCh0aGlzLCAxMiwgMCk7Cn07Ci8qKgogKiBAcGFyYW0ge251bWJlcn0gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5DYWxsTGlzdFJlcXVlc3R9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuQ2FsbExpc3RSZXF1ZXN0LnByb3RvdHlwZS5zZXRDcmVhdGVkU3RhcnQgPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0ludEZpZWxkKHRoaXMsIDEyLCB2YWx1ZSk7Cn07Ci8qKgogKiBvcHRpb25hbCB1aW50MzIgY3JlYXRlZF9lbmQgPSAxMzsKICogQHJldHVybiB7bnVtYmVyfQogKi8KCgpwcm90by5wYi5jbXMuQ2FsbExpc3RSZXF1ZXN0LnByb3RvdHlwZS5nZXRDcmVhdGVkRW5kID0gZnVuY3Rpb24gKCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdCh0aGlzLCAxMywgMCk7Cn07Ci8qKgogKiBAcGFyYW0ge251bWJlcn0gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5DYWxsTGlzdFJlcXVlc3R9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuQ2FsbExpc3RSZXF1ZXN0LnByb3RvdHlwZS5zZXRDcmVhdGVkRW5kID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRQcm90bzNJbnRGaWVsZCh0aGlzLCAxMywgdmFsdWUpOwp9OwovKioKICogTGlzdCBvZiByZXBlYXRlZCBmaWVsZHMgd2l0aGluIHRoaXMgbWVzc2FnZSB0eXBlLgogKiBAcHJpdmF0ZSB7IUFycmF5PG51bWJlcj59CiAqIEBjb25zdAogKi8KCgpwcm90by5wYi5jbXMuQ2FsbExpc3RSZXBseS5yZXBlYXRlZEZpZWxkc18gPSBbMV07CgppZiAoanNwYi5NZXNzYWdlLkdFTkVSQVRFX1RPX09CSkVDVCkgewogIC8qKgogICAqIENyZWF0ZXMgYW4gb2JqZWN0IHJlcHJlc2VudGF0aW9uIG9mIHRoaXMgcHJvdG8uCiAgICogRmllbGQgbmFtZXMgdGhhdCBhcmUgcmVzZXJ2ZWQgaW4gSmF2YVNjcmlwdCBhbmQgd2lsbCBiZSByZW5hbWVkIHRvIHBiX25hbWUuCiAgICogT3B0aW9uYWwgZmllbGRzIHRoYXQgYXJlIG5vdCBzZXQgd2lsbCBiZSBzZXQgdG8gdW5kZWZpbmVkLgogICAqIFRvIGFjY2VzcyBhIHJlc2VydmVkIGZpZWxkIHVzZSwgZm9vLnBiXzxuYW1lPiwgZWcsIGZvby5wYl9kZWZhdWx0LgogICAqIEZvciB0aGUgbGlzdCBvZiByZXNlcnZlZCBuYW1lcyBwbGVhc2Ugc2VlOgogICAqICAgICBuZXQvcHJvdG8yL2NvbXBpbGVyL2pzL2ludGVybmFsL2dlbmVyYXRvci5jYyNrS2V5d29yZC4KICAgKiBAcGFyYW0ge2Jvb2xlYW49fSBvcHRfaW5jbHVkZUluc3RhbmNlIERlcHJlY2F0ZWQuIHdoZXRoZXIgdG8gaW5jbHVkZSB0aGUKICAgKiAgICAgSlNQQiBpbnN0YW5jZSBmb3IgdHJhbnNpdGlvbmFsIHNveSBwcm90byBzdXBwb3J0OgogICAqICAgICBodHRwOi8vZ290by9zb3ktcGFyYW0tbWlncmF0aW9uCiAgICogQHJldHVybiB7IU9iamVjdH0KICAgKi8KICBwcm90by5wYi5jbXMuQ2FsbExpc3RSZXBseS5wcm90b3R5cGUudG9PYmplY3QgPSBmdW5jdGlvbiAob3B0X2luY2x1ZGVJbnN0YW5jZSkgewogICAgcmV0dXJuIHByb3RvLnBiLmNtcy5DYWxsTGlzdFJlcGx5LnRvT2JqZWN0KG9wdF9pbmNsdWRlSW5zdGFuY2UsIHRoaXMpOwogIH07CiAgLyoqCiAgICogU3RhdGljIHZlcnNpb24gb2YgdGhlIHtAc2VlIHRvT2JqZWN0fSBtZXRob2QuCiAgICogQHBhcmFtIHtib29sZWFufHVuZGVmaW5lZH0gaW5jbHVkZUluc3RhbmNlIERlcHJlY2F0ZWQuIFdoZXRoZXIgdG8gaW5jbHVkZQogICAqICAgICB0aGUgSlNQQiBpbnN0YW5jZSBmb3IgdHJhbnNpdGlvbmFsIHNveSBwcm90byBzdXBwb3J0OgogICAqICAgICBodHRwOi8vZ290by9zb3ktcGFyYW0tbWlncmF0aW9uCiAgICogQHBhcmFtIHshcHJvdG8ucGIuY21zLkNhbGxMaXN0UmVwbHl9IG1zZyBUaGUgbXNnIGluc3RhbmNlIHRvIHRyYW5zZm9ybS4KICAgKiBAcmV0dXJuIHshT2JqZWN0fQogICAqIEBzdXBwcmVzcyB7dW51c2VkTG9jYWxWYXJpYWJsZXN9IGYgaXMgb25seSB1c2VkIGZvciBuZXN0ZWQgbWVzc2FnZXMKICAgKi8KCgogIHByb3RvLnBiLmNtcy5DYWxsTGlzdFJlcGx5LnRvT2JqZWN0ID0gZnVuY3Rpb24gKGluY2x1ZGVJbnN0YW5jZSwgbXNnKSB7CiAgICB2YXIgZiwKICAgICAgICBvYmogPSB7CiAgICAgIGNhbGxzTGlzdDoganNwYi5NZXNzYWdlLnRvT2JqZWN0TGlzdChtc2cuZ2V0Q2FsbHNMaXN0KCksIHVzZXJ0eXBlX3BiLkNhbGxSZWNvcmQudG9PYmplY3QsIGluY2x1ZGVJbnN0YW5jZSksCiAgICAgIHBhZ2VObzoganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQobXNnLCAyLCAwKSwKICAgICAgcGFnZVNpemU6IGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KG1zZywgMywgMCksCiAgICAgIHRvdGFsUGFnZToganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQobXNnLCA0LCAwKSwKICAgICAgdG90YWxDb3VudDoganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQobXNnLCA1LCAwKQogICAgfTsKCiAgICBpZiAoaW5jbHVkZUluc3RhbmNlKSB7CiAgICAgIG9iai4kanNwYk1lc3NhZ2VJbnN0YW5jZSA9IG1zZzsKICAgIH0KCiAgICByZXR1cm4gb2JqOwogIH07Cn0KLyoqCiAqIERlc2VyaWFsaXplcyBiaW5hcnkgZGF0YSAoaW4gcHJvdG9idWYgd2lyZSBmb3JtYXQpLgogKiBAcGFyYW0ge2pzcGIuQnl0ZVNvdXJjZX0gYnl0ZXMgVGhlIGJ5dGVzIHRvIGRlc2VyaWFsaXplLgogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLkNhbGxMaXN0UmVwbHl9CiAqLwoKCnByb3RvLnBiLmNtcy5DYWxsTGlzdFJlcGx5LmRlc2VyaWFsaXplQmluYXJ5ID0gZnVuY3Rpb24gKGJ5dGVzKSB7CiAgdmFyIHJlYWRlciA9IG5ldyBqc3BiLkJpbmFyeVJlYWRlcihieXRlcyk7CiAgdmFyIG1zZyA9IG5ldyBwcm90by5wYi5jbXMuQ2FsbExpc3RSZXBseSgpOwogIHJldHVybiBwcm90by5wYi5jbXMuQ2FsbExpc3RSZXBseS5kZXNlcmlhbGl6ZUJpbmFyeUZyb21SZWFkZXIobXNnLCByZWFkZXIpOwp9OwovKioKICogRGVzZXJpYWxpemVzIGJpbmFyeSBkYXRhIChpbiBwcm90b2J1ZiB3aXJlIGZvcm1hdCkgZnJvbSB0aGUKICogZ2l2ZW4gcmVhZGVyIGludG8gdGhlIGdpdmVuIG1lc3NhZ2Ugb2JqZWN0LgogKiBAcGFyYW0geyFwcm90by5wYi5jbXMuQ2FsbExpc3RSZXBseX0gbXNnIFRoZSBtZXNzYWdlIG9iamVjdCB0byBkZXNlcmlhbGl6ZSBpbnRvLgogKiBAcGFyYW0geyFqc3BiLkJpbmFyeVJlYWRlcn0gcmVhZGVyIFRoZSBCaW5hcnlSZWFkZXIgdG8gdXNlLgogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLkNhbGxMaXN0UmVwbHl9CiAqLwoKCnByb3RvLnBiLmNtcy5DYWxsTGlzdFJlcGx5LmRlc2VyaWFsaXplQmluYXJ5RnJvbVJlYWRlciA9IGZ1bmN0aW9uIChtc2csIHJlYWRlcikgewogIHdoaWxlIChyZWFkZXIubmV4dEZpZWxkKCkpIHsKICAgIGlmIChyZWFkZXIuaXNFbmRHcm91cCgpKSB7CiAgICAgIGJyZWFrOwogICAgfQoKICAgIHZhciBmaWVsZCA9IHJlYWRlci5nZXRGaWVsZE51bWJlcigpOwoKICAgIHN3aXRjaCAoZmllbGQpIHsKICAgICAgY2FzZSAxOgogICAgICAgIHZhciB2YWx1ZSA9IG5ldyB1c2VydHlwZV9wYi5DYWxsUmVjb3JkKCk7CiAgICAgICAgcmVhZGVyLnJlYWRNZXNzYWdlKHZhbHVlLCB1c2VydHlwZV9wYi5DYWxsUmVjb3JkLmRlc2VyaWFsaXplQmluYXJ5RnJvbVJlYWRlcik7CiAgICAgICAgbXNnLmFkZENhbGxzKHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgMjoKICAgICAgICB2YXIgdmFsdWUgPSByZWFkZXIucmVhZFVpbnQzMigpOwogICAgICAgIG1zZy5zZXRQYWdlTm8odmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSAzOgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkVWludDMyKCk7CiAgICAgICAgbXNnLnNldFBhZ2VTaXplKHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgNDoKICAgICAgICB2YXIgdmFsdWUgPSByZWFkZXIucmVhZFVpbnQzMigpOwogICAgICAgIG1zZy5zZXRUb3RhbFBhZ2UodmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSA1OgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkVWludDMyKCk7CiAgICAgICAgbXNnLnNldFRvdGFsQ291bnQodmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgZGVmYXVsdDoKICAgICAgICByZWFkZXIuc2tpcEZpZWxkKCk7CiAgICAgICAgYnJlYWs7CiAgICB9CiAgfQoKICByZXR1cm4gbXNnOwp9OwovKioKICogU2VyaWFsaXplcyB0aGUgbWVzc2FnZSB0byBiaW5hcnkgZGF0YSAoaW4gcHJvdG9idWYgd2lyZSBmb3JtYXQpLgogKiBAcmV0dXJuIHshVWludDhBcnJheX0KICovCgoKcHJvdG8ucGIuY21zLkNhbGxMaXN0UmVwbHkucHJvdG90eXBlLnNlcmlhbGl6ZUJpbmFyeSA9IGZ1bmN0aW9uICgpIHsKICB2YXIgd3JpdGVyID0gbmV3IGpzcGIuQmluYXJ5V3JpdGVyKCk7CiAgcHJvdG8ucGIuY21zLkNhbGxMaXN0UmVwbHkuc2VyaWFsaXplQmluYXJ5VG9Xcml0ZXIodGhpcywgd3JpdGVyKTsKICByZXR1cm4gd3JpdGVyLmdldFJlc3VsdEJ1ZmZlcigpOwp9OwovKioKICogU2VyaWFsaXplcyB0aGUgZ2l2ZW4gbWVzc2FnZSB0byBiaW5hcnkgZGF0YSAoaW4gcHJvdG9idWYgd2lyZQogKiBmb3JtYXQpLCB3cml0aW5nIHRvIHRoZSBnaXZlbiBCaW5hcnlXcml0ZXIuCiAqIEBwYXJhbSB7IXByb3RvLnBiLmNtcy5DYWxsTGlzdFJlcGx5fSBtZXNzYWdlCiAqIEBwYXJhbSB7IWpzcGIuQmluYXJ5V3JpdGVyfSB3cml0ZXIKICogQHN1cHByZXNzIHt1bnVzZWRMb2NhbFZhcmlhYmxlc30gZiBpcyBvbmx5IHVzZWQgZm9yIG5lc3RlZCBtZXNzYWdlcwogKi8KCgpwcm90by5wYi5jbXMuQ2FsbExpc3RSZXBseS5zZXJpYWxpemVCaW5hcnlUb1dyaXRlciA9IGZ1bmN0aW9uIChtZXNzYWdlLCB3cml0ZXIpIHsKICB2YXIgZiA9IHVuZGVmaW5lZDsKICBmID0gbWVzc2FnZS5nZXRDYWxsc0xpc3QoKTsKCiAgaWYgKGYubGVuZ3RoID4gMCkgewogICAgd3JpdGVyLndyaXRlUmVwZWF0ZWRNZXNzYWdlKDEsIGYsIHVzZXJ0eXBlX3BiLkNhbGxSZWNvcmQuc2VyaWFsaXplQmluYXJ5VG9Xcml0ZXIpOwogIH0KCiAgZiA9IG1lc3NhZ2UuZ2V0UGFnZU5vKCk7CgogIGlmIChmICE9PSAwKSB7CiAgICB3cml0ZXIud3JpdGVVaW50MzIoMiwgZik7CiAgfQoKICBmID0gbWVzc2FnZS5nZXRQYWdlU2l6ZSgpOwoKICBpZiAoZiAhPT0gMCkgewogICAgd3JpdGVyLndyaXRlVWludDMyKDMsIGYpOwogIH0KCiAgZiA9IG1lc3NhZ2UuZ2V0VG90YWxQYWdlKCk7CgogIGlmIChmICE9PSAwKSB7CiAgICB3cml0ZXIud3JpdGVVaW50MzIoNCwgZik7CiAgfQoKICBmID0gbWVzc2FnZS5nZXRUb3RhbENvdW50KCk7CgogIGlmIChmICE9PSAwKSB7CiAgICB3cml0ZXIud3JpdGVVaW50MzIoNSwgZik7CiAgfQp9OwovKioKICogcmVwZWF0ZWQgcGIuQ2FsbFJlY29yZCBjYWxscyA9IDE7CiAqIEByZXR1cm4geyFBcnJheTwhcHJvdG8ucGIuQ2FsbFJlY29yZD59CiAqLwoKCnByb3RvLnBiLmNtcy5DYWxsTGlzdFJlcGx5LnByb3RvdHlwZS5nZXRDYWxsc0xpc3QgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRSZXBlYXRlZFdyYXBwZXJGaWVsZCh0aGlzLCB1c2VydHlwZV9wYi5DYWxsUmVjb3JkLCAxKTsKfTsKLyoqCiAqIEBwYXJhbSB7IUFycmF5PCFwcm90by5wYi5DYWxsUmVjb3JkPn0gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5DYWxsTGlzdFJlcGx5fSByZXR1cm5zIHRoaXMKKi8KCgpwcm90by5wYi5jbXMuQ2FsbExpc3RSZXBseS5wcm90b3R5cGUuc2V0Q2FsbHNMaXN0ID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRSZXBlYXRlZFdyYXBwZXJGaWVsZCh0aGlzLCAxLCB2YWx1ZSk7Cn07Ci8qKgogKiBAcGFyYW0geyFwcm90by5wYi5DYWxsUmVjb3JkPX0gb3B0X3ZhbHVlCiAqIEBwYXJhbSB7bnVtYmVyPX0gb3B0X2luZGV4CiAqIEByZXR1cm4geyFwcm90by5wYi5DYWxsUmVjb3JkfQogKi8KCgpwcm90by5wYi5jbXMuQ2FsbExpc3RSZXBseS5wcm90b3R5cGUuYWRkQ2FsbHMgPSBmdW5jdGlvbiAob3B0X3ZhbHVlLCBvcHRfaW5kZXgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmFkZFRvUmVwZWF0ZWRXcmFwcGVyRmllbGQodGhpcywgMSwgb3B0X3ZhbHVlLCBwcm90by5wYi5DYWxsUmVjb3JkLCBvcHRfaW5kZXgpOwp9OwovKioKICogQ2xlYXJzIHRoZSBsaXN0IG1ha2luZyBpdCBlbXB0eSBidXQgbm9uLW51bGwuCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuQ2FsbExpc3RSZXBseX0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5DYWxsTGlzdFJlcGx5LnByb3RvdHlwZS5jbGVhckNhbGxzTGlzdCA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4gdGhpcy5zZXRDYWxsc0xpc3QoW10pOwp9OwovKioKICogb3B0aW9uYWwgdWludDMyIHBhZ2Vfbm8gPSAyOwogKiBAcmV0dXJuIHtudW1iZXJ9CiAqLwoKCnByb3RvLnBiLmNtcy5DYWxsTGlzdFJlcGx5LnByb3RvdHlwZS5nZXRQYWdlTm8gPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDIsIDApOwp9OwovKioKICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuQ2FsbExpc3RSZXBseX0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5DYWxsTGlzdFJlcGx5LnByb3RvdHlwZS5zZXRQYWdlTm8gPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0ludEZpZWxkKHRoaXMsIDIsIHZhbHVlKTsKfTsKLyoqCiAqIG9wdGlvbmFsIHVpbnQzMiBwYWdlX3NpemUgPSAzOwogKiBAcmV0dXJuIHtudW1iZXJ9CiAqLwoKCnByb3RvLnBiLmNtcy5DYWxsTGlzdFJlcGx5LnByb3RvdHlwZS5nZXRQYWdlU2l6ZSA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQodGhpcywgMywgMCk7Cn07Ci8qKgogKiBAcGFyYW0ge251bWJlcn0gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5DYWxsTGlzdFJlcGx5fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLkNhbGxMaXN0UmVwbHkucHJvdG90eXBlLnNldFBhZ2VTaXplID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRQcm90bzNJbnRGaWVsZCh0aGlzLCAzLCB2YWx1ZSk7Cn07Ci8qKgogKiBvcHRpb25hbCB1aW50MzIgdG90YWxfcGFnZSA9IDQ7CiAqIEByZXR1cm4ge251bWJlcn0KICovCgoKcHJvdG8ucGIuY21zLkNhbGxMaXN0UmVwbHkucHJvdG90eXBlLmdldFRvdGFsUGFnZSA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQodGhpcywgNCwgMCk7Cn07Ci8qKgogKiBAcGFyYW0ge251bWJlcn0gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5DYWxsTGlzdFJlcGx5fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLkNhbGxMaXN0UmVwbHkucHJvdG90eXBlLnNldFRvdGFsUGFnZSA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UHJvdG8zSW50RmllbGQodGhpcywgNCwgdmFsdWUpOwp9OwovKioKICogb3B0aW9uYWwgdWludDMyIHRvdGFsX2NvdW50ID0gNTsKICogQHJldHVybiB7bnVtYmVyfQogKi8KCgpwcm90by5wYi5jbXMuQ2FsbExpc3RSZXBseS5wcm90b3R5cGUuZ2V0VG90YWxDb3VudCA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQodGhpcywgNSwgMCk7Cn07Ci8qKgogKiBAcGFyYW0ge251bWJlcn0gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5DYWxsTGlzdFJlcGx5fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLkNhbGxMaXN0UmVwbHkucHJvdG90eXBlLnNldFRvdGFsQ291bnQgPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0ludEZpZWxkKHRoaXMsIDUsIHZhbHVlKTsKfTsKCmlmIChqc3BiLk1lc3NhZ2UuR0VORVJBVEVfVE9fT0JKRUNUKSB7CiAgLyoqCiAgICogQ3JlYXRlcyBhbiBvYmplY3QgcmVwcmVzZW50YXRpb24gb2YgdGhpcyBwcm90by4KICAgKiBGaWVsZCBuYW1lcyB0aGF0IGFyZSByZXNlcnZlZCBpbiBKYXZhU2NyaXB0IGFuZCB3aWxsIGJlIHJlbmFtZWQgdG8gcGJfbmFtZS4KICAgKiBPcHRpb25hbCBmaWVsZHMgdGhhdCBhcmUgbm90IHNldCB3aWxsIGJlIHNldCB0byB1bmRlZmluZWQuCiAgICogVG8gYWNjZXNzIGEgcmVzZXJ2ZWQgZmllbGQgdXNlLCBmb28ucGJfPG5hbWU+LCBlZywgZm9vLnBiX2RlZmF1bHQuCiAgICogRm9yIHRoZSBsaXN0IG9mIHJlc2VydmVkIG5hbWVzIHBsZWFzZSBzZWU6CiAgICogICAgIG5ldC9wcm90bzIvY29tcGlsZXIvanMvaW50ZXJuYWwvZ2VuZXJhdG9yLmNjI2tLZXl3b3JkLgogICAqIEBwYXJhbSB7Ym9vbGVhbj19IG9wdF9pbmNsdWRlSW5zdGFuY2UgRGVwcmVjYXRlZC4gd2hldGhlciB0byBpbmNsdWRlIHRoZQogICAqICAgICBKU1BCIGluc3RhbmNlIGZvciB0cmFuc2l0aW9uYWwgc295IHByb3RvIHN1cHBvcnQ6CiAgICogICAgIGh0dHA6Ly9nb3RvL3NveS1wYXJhbS1taWdyYXRpb24KICAgKiBAcmV0dXJuIHshT2JqZWN0fQogICAqLwogIHByb3RvLnBiLmNtcy5UcmFuc2FjdGlvbkxpc3RSZXF1ZXN0LnByb3RvdHlwZS50b09iamVjdCA9IGZ1bmN0aW9uIChvcHRfaW5jbHVkZUluc3RhbmNlKSB7CiAgICByZXR1cm4gcHJvdG8ucGIuY21zLlRyYW5zYWN0aW9uTGlzdFJlcXVlc3QudG9PYmplY3Qob3B0X2luY2x1ZGVJbnN0YW5jZSwgdGhpcyk7CiAgfTsKICAvKioKICAgKiBTdGF0aWMgdmVyc2lvbiBvZiB0aGUge0BzZWUgdG9PYmplY3R9IG1ldGhvZC4KICAgKiBAcGFyYW0ge2Jvb2xlYW58dW5kZWZpbmVkfSBpbmNsdWRlSW5zdGFuY2UgRGVwcmVjYXRlZC4gV2hldGhlciB0byBpbmNsdWRlCiAgICogICAgIHRoZSBKU1BCIGluc3RhbmNlIGZvciB0cmFuc2l0aW9uYWwgc295IHByb3RvIHN1cHBvcnQ6CiAgICogICAgIGh0dHA6Ly9nb3RvL3NveS1wYXJhbS1taWdyYXRpb24KICAgKiBAcGFyYW0geyFwcm90by5wYi5jbXMuVHJhbnNhY3Rpb25MaXN0UmVxdWVzdH0gbXNnIFRoZSBtc2cgaW5zdGFuY2UgdG8gdHJhbnNmb3JtLgogICAqIEByZXR1cm4geyFPYmplY3R9CiAgICogQHN1cHByZXNzIHt1bnVzZWRMb2NhbFZhcmlhYmxlc30gZiBpcyBvbmx5IHVzZWQgZm9yIG5lc3RlZCBtZXNzYWdlcwogICAqLwoKCiAgcHJvdG8ucGIuY21zLlRyYW5zYWN0aW9uTGlzdFJlcXVlc3QudG9PYmplY3QgPSBmdW5jdGlvbiAoaW5jbHVkZUluc3RhbmNlLCBtc2cpIHsKICAgIHZhciBmLAogICAgICAgIG9iaiA9IHsKICAgICAgcGFnZU5vOiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdChtc2csIDEsIDApLAogICAgICBwYWdlU2l6ZToganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQobXNnLCAyLCAwKSwKICAgICAgYXJlYUlkOiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdChtc2csIDMsIDApLAogICAgICBhcHBJZDoganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQobXNnLCA0LCAwKSwKICAgICAgdHJhZGVyVHlwZToganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQobXNnLCA1LCAwKSwKICAgICAgdHJhZGVySWQ6IGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KG1zZywgNiwgMCksCiAgICAgIHNvdXJjZVR5cGU6IGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KG1zZywgNywgMCksCiAgICAgIGNyZWF0ZWRTdGFydDoganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQobXNnLCA4LCAwKSwKICAgICAgY3JlYXRlZEVuZDoganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQobXNnLCA5LCAwKQogICAgfTsKCiAgICBpZiAoaW5jbHVkZUluc3RhbmNlKSB7CiAgICAgIG9iai4kanNwYk1lc3NhZ2VJbnN0YW5jZSA9IG1zZzsKICAgIH0KCiAgICByZXR1cm4gb2JqOwogIH07Cn0KLyoqCiAqIERlc2VyaWFsaXplcyBiaW5hcnkgZGF0YSAoaW4gcHJvdG9idWYgd2lyZSBmb3JtYXQpLgogKiBAcGFyYW0ge2pzcGIuQnl0ZVNvdXJjZX0gYnl0ZXMgVGhlIGJ5dGVzIHRvIGRlc2VyaWFsaXplLgogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLlRyYW5zYWN0aW9uTGlzdFJlcXVlc3R9CiAqLwoKCnByb3RvLnBiLmNtcy5UcmFuc2FjdGlvbkxpc3RSZXF1ZXN0LmRlc2VyaWFsaXplQmluYXJ5ID0gZnVuY3Rpb24gKGJ5dGVzKSB7CiAgdmFyIHJlYWRlciA9IG5ldyBqc3BiLkJpbmFyeVJlYWRlcihieXRlcyk7CiAgdmFyIG1zZyA9IG5ldyBwcm90by5wYi5jbXMuVHJhbnNhY3Rpb25MaXN0UmVxdWVzdCgpOwogIHJldHVybiBwcm90by5wYi5jbXMuVHJhbnNhY3Rpb25MaXN0UmVxdWVzdC5kZXNlcmlhbGl6ZUJpbmFyeUZyb21SZWFkZXIobXNnLCByZWFkZXIpOwp9OwovKioKICogRGVzZXJpYWxpemVzIGJpbmFyeSBkYXRhIChpbiBwcm90b2J1ZiB3aXJlIGZvcm1hdCkgZnJvbSB0aGUKICogZ2l2ZW4gcmVhZGVyIGludG8gdGhlIGdpdmVuIG1lc3NhZ2Ugb2JqZWN0LgogKiBAcGFyYW0geyFwcm90by5wYi5jbXMuVHJhbnNhY3Rpb25MaXN0UmVxdWVzdH0gbXNnIFRoZSBtZXNzYWdlIG9iamVjdCB0byBkZXNlcmlhbGl6ZSBpbnRvLgogKiBAcGFyYW0geyFqc3BiLkJpbmFyeVJlYWRlcn0gcmVhZGVyIFRoZSBCaW5hcnlSZWFkZXIgdG8gdXNlLgogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLlRyYW5zYWN0aW9uTGlzdFJlcXVlc3R9CiAqLwoKCnByb3RvLnBiLmNtcy5UcmFuc2FjdGlvbkxpc3RSZXF1ZXN0LmRlc2VyaWFsaXplQmluYXJ5RnJvbVJlYWRlciA9IGZ1bmN0aW9uIChtc2csIHJlYWRlcikgewogIHdoaWxlIChyZWFkZXIubmV4dEZpZWxkKCkpIHsKICAgIGlmIChyZWFkZXIuaXNFbmRHcm91cCgpKSB7CiAgICAgIGJyZWFrOwogICAgfQoKICAgIHZhciBmaWVsZCA9IHJlYWRlci5nZXRGaWVsZE51bWJlcigpOwoKICAgIHN3aXRjaCAoZmllbGQpIHsKICAgICAgY2FzZSAxOgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkVWludDMyKCk7CiAgICAgICAgbXNnLnNldFBhZ2VObyh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlIDI6CiAgICAgICAgdmFyIHZhbHVlID0gcmVhZGVyLnJlYWRVaW50MzIoKTsKICAgICAgICBtc2cuc2V0UGFnZVNpemUodmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSAzOgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkVWludDMyKCk7CiAgICAgICAgbXNnLnNldEFyZWFJZCh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlIDQ6CiAgICAgICAgdmFyIHZhbHVlID0gcmVhZGVyLnJlYWRVaW50MzIoKTsKICAgICAgICBtc2cuc2V0QXBwSWQodmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSA1OgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkRW51bSgpOwogICAgICAgIG1zZy5zZXRUcmFkZXJUeXBlKHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgNjoKICAgICAgICB2YXIgdmFsdWUgPSByZWFkZXIucmVhZFVpbnQzMigpOwogICAgICAgIG1zZy5zZXRUcmFkZXJJZCh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlIDc6CiAgICAgICAgdmFyIHZhbHVlID0gcmVhZGVyLnJlYWRFbnVtKCk7CiAgICAgICAgbXNnLnNldFNvdXJjZVR5cGUodmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSA4OgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkVWludDMyKCk7CiAgICAgICAgbXNnLnNldENyZWF0ZWRTdGFydCh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlIDk6CiAgICAgICAgdmFyIHZhbHVlID0gcmVhZGVyLnJlYWRVaW50MzIoKTsKICAgICAgICBtc2cuc2V0Q3JlYXRlZEVuZCh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBkZWZhdWx0OgogICAgICAgIHJlYWRlci5za2lwRmllbGQoKTsKICAgICAgICBicmVhazsKICAgIH0KICB9CgogIHJldHVybiBtc2c7Cn07Ci8qKgogKiBTZXJpYWxpemVzIHRoZSBtZXNzYWdlIHRvIGJpbmFyeSBkYXRhIChpbiBwcm90b2J1ZiB3aXJlIGZvcm1hdCkuCiAqIEByZXR1cm4geyFVaW50OEFycmF5fQogKi8KCgpwcm90by5wYi5jbXMuVHJhbnNhY3Rpb25MaXN0UmVxdWVzdC5wcm90b3R5cGUuc2VyaWFsaXplQmluYXJ5ID0gZnVuY3Rpb24gKCkgewogIHZhciB3cml0ZXIgPSBuZXcganNwYi5CaW5hcnlXcml0ZXIoKTsKICBwcm90by5wYi5jbXMuVHJhbnNhY3Rpb25MaXN0UmVxdWVzdC5zZXJpYWxpemVCaW5hcnlUb1dyaXRlcih0aGlzLCB3cml0ZXIpOwogIHJldHVybiB3cml0ZXIuZ2V0UmVzdWx0QnVmZmVyKCk7Cn07Ci8qKgogKiBTZXJpYWxpemVzIHRoZSBnaXZlbiBtZXNzYWdlIHRvIGJpbmFyeSBkYXRhIChpbiBwcm90b2J1ZiB3aXJlCiAqIGZvcm1hdCksIHdyaXRpbmcgdG8gdGhlIGdpdmVuIEJpbmFyeVdyaXRlci4KICogQHBhcmFtIHshcHJvdG8ucGIuY21zLlRyYW5zYWN0aW9uTGlzdFJlcXVlc3R9IG1lc3NhZ2UKICogQHBhcmFtIHshanNwYi5CaW5hcnlXcml0ZXJ9IHdyaXRlcgogKiBAc3VwcHJlc3Mge3VudXNlZExvY2FsVmFyaWFibGVzfSBmIGlzIG9ubHkgdXNlZCBmb3IgbmVzdGVkIG1lc3NhZ2VzCiAqLwoKCnByb3RvLnBiLmNtcy5UcmFuc2FjdGlvbkxpc3RSZXF1ZXN0LnNlcmlhbGl6ZUJpbmFyeVRvV3JpdGVyID0gZnVuY3Rpb24gKG1lc3NhZ2UsIHdyaXRlcikgewogIHZhciBmID0gdW5kZWZpbmVkOwogIGYgPSBtZXNzYWdlLmdldFBhZ2VObygpOwoKICBpZiAoZiAhPT0gMCkgewogICAgd3JpdGVyLndyaXRlVWludDMyKDEsIGYpOwogIH0KCiAgZiA9IG1lc3NhZ2UuZ2V0UGFnZVNpemUoKTsKCiAgaWYgKGYgIT09IDApIHsKICAgIHdyaXRlci53cml0ZVVpbnQzMigyLCBmKTsKICB9CgogIGYgPSBtZXNzYWdlLmdldEFyZWFJZCgpOwoKICBpZiAoZiAhPT0gMCkgewogICAgd3JpdGVyLndyaXRlVWludDMyKDMsIGYpOwogIH0KCiAgZiA9IG1lc3NhZ2UuZ2V0QXBwSWQoKTsKCiAgaWYgKGYgIT09IDApIHsKICAgIHdyaXRlci53cml0ZVVpbnQzMig0LCBmKTsKICB9CgogIGYgPSBtZXNzYWdlLmdldFRyYWRlclR5cGUoKTsKCiAgaWYgKGYgIT09IDAuMCkgewogICAgd3JpdGVyLndyaXRlRW51bSg1LCBmKTsKICB9CgogIGYgPSBtZXNzYWdlLmdldFRyYWRlcklkKCk7CgogIGlmIChmICE9PSAwKSB7CiAgICB3cml0ZXIud3JpdGVVaW50MzIoNiwgZik7CiAgfQoKICBmID0gbWVzc2FnZS5nZXRTb3VyY2VUeXBlKCk7CgogIGlmIChmICE9PSAwLjApIHsKICAgIHdyaXRlci53cml0ZUVudW0oNywgZik7CiAgfQoKICBmID0gbWVzc2FnZS5nZXRDcmVhdGVkU3RhcnQoKTsKCiAgaWYgKGYgIT09IDApIHsKICAgIHdyaXRlci53cml0ZVVpbnQzMig4LCBmKTsKICB9CgogIGYgPSBtZXNzYWdlLmdldENyZWF0ZWRFbmQoKTsKCiAgaWYgKGYgIT09IDApIHsKICAgIHdyaXRlci53cml0ZVVpbnQzMig5LCBmKTsKICB9Cn07Ci8qKgogKiBvcHRpb25hbCB1aW50MzIgcGFnZV9ubyA9IDE7CiAqIEByZXR1cm4ge251bWJlcn0KICovCgoKcHJvdG8ucGIuY21zLlRyYW5zYWN0aW9uTGlzdFJlcXVlc3QucHJvdG90eXBlLmdldFBhZ2VObyA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQodGhpcywgMSwgMCk7Cn07Ci8qKgogKiBAcGFyYW0ge251bWJlcn0gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5UcmFuc2FjdGlvbkxpc3RSZXF1ZXN0fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLlRyYW5zYWN0aW9uTGlzdFJlcXVlc3QucHJvdG90eXBlLnNldFBhZ2VObyA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UHJvdG8zSW50RmllbGQodGhpcywgMSwgdmFsdWUpOwp9OwovKioKICogb3B0aW9uYWwgdWludDMyIHBhZ2Vfc2l6ZSA9IDI7CiAqIEByZXR1cm4ge251bWJlcn0KICovCgoKcHJvdG8ucGIuY21zLlRyYW5zYWN0aW9uTGlzdFJlcXVlc3QucHJvdG90eXBlLmdldFBhZ2VTaXplID0gZnVuY3Rpb24gKCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdCh0aGlzLCAyLCAwKTsKfTsKLyoqCiAqIEBwYXJhbSB7bnVtYmVyfSB2YWx1ZQogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLlRyYW5zYWN0aW9uTGlzdFJlcXVlc3R9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuVHJhbnNhY3Rpb25MaXN0UmVxdWVzdC5wcm90b3R5cGUuc2V0UGFnZVNpemUgPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0ludEZpZWxkKHRoaXMsIDIsIHZhbHVlKTsKfTsKLyoqCiAqIG9wdGlvbmFsIHVpbnQzMiBhcmVhX2lkID0gMzsKICogQHJldHVybiB7bnVtYmVyfQogKi8KCgpwcm90by5wYi5jbXMuVHJhbnNhY3Rpb25MaXN0UmVxdWVzdC5wcm90b3R5cGUuZ2V0QXJlYUlkID0gZnVuY3Rpb24gKCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdCh0aGlzLCAzLCAwKTsKfTsKLyoqCiAqIEBwYXJhbSB7bnVtYmVyfSB2YWx1ZQogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLlRyYW5zYWN0aW9uTGlzdFJlcXVlc3R9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuVHJhbnNhY3Rpb25MaXN0UmVxdWVzdC5wcm90b3R5cGUuc2V0QXJlYUlkID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRQcm90bzNJbnRGaWVsZCh0aGlzLCAzLCB2YWx1ZSk7Cn07Ci8qKgogKiBvcHRpb25hbCB1aW50MzIgYXBwX2lkID0gNDsKICogQHJldHVybiB7bnVtYmVyfQogKi8KCgpwcm90by5wYi5jbXMuVHJhbnNhY3Rpb25MaXN0UmVxdWVzdC5wcm90b3R5cGUuZ2V0QXBwSWQgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDQsIDApOwp9OwovKioKICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuVHJhbnNhY3Rpb25MaXN0UmVxdWVzdH0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5UcmFuc2FjdGlvbkxpc3RSZXF1ZXN0LnByb3RvdHlwZS5zZXRBcHBJZCA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UHJvdG8zSW50RmllbGQodGhpcywgNCwgdmFsdWUpOwp9OwovKioKICogb3B0aW9uYWwgcGIuRW50aXR5VHlwZSB0cmFkZXJfdHlwZSA9IDU7CiAqIEByZXR1cm4geyFwcm90by5wYi5FbnRpdHlUeXBlfQogKi8KCgpwcm90by5wYi5jbXMuVHJhbnNhY3Rpb25MaXN0UmVxdWVzdC5wcm90b3R5cGUuZ2V0VHJhZGVyVHlwZSA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQodGhpcywgNSwgMCk7Cn07Ci8qKgogKiBAcGFyYW0geyFwcm90by5wYi5FbnRpdHlUeXBlfSB2YWx1ZQogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLlRyYW5zYWN0aW9uTGlzdFJlcXVlc3R9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuVHJhbnNhY3Rpb25MaXN0UmVxdWVzdC5wcm90b3R5cGUuc2V0VHJhZGVyVHlwZSA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UHJvdG8zRW51bUZpZWxkKHRoaXMsIDUsIHZhbHVlKTsKfTsKLyoqCiAqIG9wdGlvbmFsIHVpbnQzMiB0cmFkZXJfaWQgPSA2OwogKiBAcmV0dXJuIHtudW1iZXJ9CiAqLwoKCnByb3RvLnBiLmNtcy5UcmFuc2FjdGlvbkxpc3RSZXF1ZXN0LnByb3RvdHlwZS5nZXRUcmFkZXJJZCA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQodGhpcywgNiwgMCk7Cn07Ci8qKgogKiBAcGFyYW0ge251bWJlcn0gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5UcmFuc2FjdGlvbkxpc3RSZXF1ZXN0fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLlRyYW5zYWN0aW9uTGlzdFJlcXVlc3QucHJvdG90eXBlLnNldFRyYWRlcklkID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRQcm90bzNJbnRGaWVsZCh0aGlzLCA2LCB2YWx1ZSk7Cn07Ci8qKgogKiBvcHRpb25hbCBwYi5FbnRpdHlUeXBlIHNvdXJjZV90eXBlID0gNzsKICogQHJldHVybiB7IXByb3RvLnBiLkVudGl0eVR5cGV9CiAqLwoKCnByb3RvLnBiLmNtcy5UcmFuc2FjdGlvbkxpc3RSZXF1ZXN0LnByb3RvdHlwZS5nZXRTb3VyY2VUeXBlID0gZnVuY3Rpb24gKCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdCh0aGlzLCA3LCAwKTsKfTsKLyoqCiAqIEBwYXJhbSB7IXByb3RvLnBiLkVudGl0eVR5cGV9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuVHJhbnNhY3Rpb25MaXN0UmVxdWVzdH0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5UcmFuc2FjdGlvbkxpc3RSZXF1ZXN0LnByb3RvdHlwZS5zZXRTb3VyY2VUeXBlID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRQcm90bzNFbnVtRmllbGQodGhpcywgNywgdmFsdWUpOwp9OwovKioKICogb3B0aW9uYWwgdWludDMyIGNyZWF0ZWRfc3RhcnQgPSA4OwogKiBAcmV0dXJuIHtudW1iZXJ9CiAqLwoKCnByb3RvLnBiLmNtcy5UcmFuc2FjdGlvbkxpc3RSZXF1ZXN0LnByb3RvdHlwZS5nZXRDcmVhdGVkU3RhcnQgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDgsIDApOwp9OwovKioKICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuVHJhbnNhY3Rpb25MaXN0UmVxdWVzdH0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5UcmFuc2FjdGlvbkxpc3RSZXF1ZXN0LnByb3RvdHlwZS5zZXRDcmVhdGVkU3RhcnQgPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0ludEZpZWxkKHRoaXMsIDgsIHZhbHVlKTsKfTsKLyoqCiAqIG9wdGlvbmFsIHVpbnQzMiBjcmVhdGVkX2VuZCA9IDk7CiAqIEByZXR1cm4ge251bWJlcn0KICovCgoKcHJvdG8ucGIuY21zLlRyYW5zYWN0aW9uTGlzdFJlcXVlc3QucHJvdG90eXBlLmdldENyZWF0ZWRFbmQgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDksIDApOwp9OwovKioKICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuVHJhbnNhY3Rpb25MaXN0UmVxdWVzdH0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5UcmFuc2FjdGlvbkxpc3RSZXF1ZXN0LnByb3RvdHlwZS5zZXRDcmVhdGVkRW5kID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRQcm90bzNJbnRGaWVsZCh0aGlzLCA5LCB2YWx1ZSk7Cn07Ci8qKgogKiBMaXN0IG9mIHJlcGVhdGVkIGZpZWxkcyB3aXRoaW4gdGhpcyBtZXNzYWdlIHR5cGUuCiAqIEBwcml2YXRlIHshQXJyYXk8bnVtYmVyPn0KICogQGNvbnN0CiAqLwoKCnByb3RvLnBiLmNtcy5UcmFuc2FjdGlvbkxpc3RSZXBseS5yZXBlYXRlZEZpZWxkc18gPSBbMV07CgppZiAoanNwYi5NZXNzYWdlLkdFTkVSQVRFX1RPX09CSkVDVCkgewogIC8qKgogICAqIENyZWF0ZXMgYW4gb2JqZWN0IHJlcHJlc2VudGF0aW9uIG9mIHRoaXMgcHJvdG8uCiAgICogRmllbGQgbmFtZXMgdGhhdCBhcmUgcmVzZXJ2ZWQgaW4gSmF2YVNjcmlwdCBhbmQgd2lsbCBiZSByZW5hbWVkIHRvIHBiX25hbWUuCiAgICogT3B0aW9uYWwgZmllbGRzIHRoYXQgYXJlIG5vdCBzZXQgd2lsbCBiZSBzZXQgdG8gdW5kZWZpbmVkLgogICAqIFRvIGFjY2VzcyBhIHJlc2VydmVkIGZpZWxkIHVzZSwgZm9vLnBiXzxuYW1lPiwgZWcsIGZvby5wYl9kZWZhdWx0LgogICAqIEZvciB0aGUgbGlzdCBvZiByZXNlcnZlZCBuYW1lcyBwbGVhc2Ugc2VlOgogICAqICAgICBuZXQvcHJvdG8yL2NvbXBpbGVyL2pzL2ludGVybmFsL2dlbmVyYXRvci5jYyNrS2V5d29yZC4KICAgKiBAcGFyYW0ge2Jvb2xlYW49fSBvcHRfaW5jbHVkZUluc3RhbmNlIERlcHJlY2F0ZWQuIHdoZXRoZXIgdG8gaW5jbHVkZSB0aGUKICAgKiAgICAgSlNQQiBpbnN0YW5jZSBmb3IgdHJhbnNpdGlvbmFsIHNveSBwcm90byBzdXBwb3J0OgogICAqICAgICBodHRwOi8vZ290by9zb3ktcGFyYW0tbWlncmF0aW9uCiAgICogQHJldHVybiB7IU9iamVjdH0KICAgKi8KICBwcm90by5wYi5jbXMuVHJhbnNhY3Rpb25MaXN0UmVwbHkucHJvdG90eXBlLnRvT2JqZWN0ID0gZnVuY3Rpb24gKG9wdF9pbmNsdWRlSW5zdGFuY2UpIHsKICAgIHJldHVybiBwcm90by5wYi5jbXMuVHJhbnNhY3Rpb25MaXN0UmVwbHkudG9PYmplY3Qob3B0X2luY2x1ZGVJbnN0YW5jZSwgdGhpcyk7CiAgfTsKICAvKioKICAgKiBTdGF0aWMgdmVyc2lvbiBvZiB0aGUge0BzZWUgdG9PYmplY3R9IG1ldGhvZC4KICAgKiBAcGFyYW0ge2Jvb2xlYW58dW5kZWZpbmVkfSBpbmNsdWRlSW5zdGFuY2UgRGVwcmVjYXRlZC4gV2hldGhlciB0byBpbmNsdWRlCiAgICogICAgIHRoZSBKU1BCIGluc3RhbmNlIGZvciB0cmFuc2l0aW9uYWwgc295IHByb3RvIHN1cHBvcnQ6CiAgICogICAgIGh0dHA6Ly9nb3RvL3NveS1wYXJhbS1taWdyYXRpb24KICAgKiBAcGFyYW0geyFwcm90by5wYi5jbXMuVHJhbnNhY3Rpb25MaXN0UmVwbHl9IG1zZyBUaGUgbXNnIGluc3RhbmNlIHRvIHRyYW5zZm9ybS4KICAgKiBAcmV0dXJuIHshT2JqZWN0fQogICAqIEBzdXBwcmVzcyB7dW51c2VkTG9jYWxWYXJpYWJsZXN9IGYgaXMgb25seSB1c2VkIGZvciBuZXN0ZWQgbWVzc2FnZXMKICAgKi8KCgogIHByb3RvLnBiLmNtcy5UcmFuc2FjdGlvbkxpc3RSZXBseS50b09iamVjdCA9IGZ1bmN0aW9uIChpbmNsdWRlSW5zdGFuY2UsIG1zZykgewogICAgdmFyIGYsCiAgICAgICAgb2JqID0gewogICAgICB0cmFuc2FjdGlvbnNMaXN0OiBqc3BiLk1lc3NhZ2UudG9PYmplY3RMaXN0KG1zZy5nZXRUcmFuc2FjdGlvbnNMaXN0KCksIHVzZXJ0eXBlX3BiLlRyYW5zYWN0aW9uLnRvT2JqZWN0LCBpbmNsdWRlSW5zdGFuY2UpLAogICAgICBwYWdlTm86IGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KG1zZywgMiwgMCksCiAgICAgIHBhZ2VTaXplOiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdChtc2csIDMsIDApLAogICAgICB0b3RhbFBhZ2U6IGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KG1zZywgNCwgMCksCiAgICAgIHRvdGFsQ291bnQ6IGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KG1zZywgNSwgMCkKICAgIH07CgogICAgaWYgKGluY2x1ZGVJbnN0YW5jZSkgewogICAgICBvYmouJGpzcGJNZXNzYWdlSW5zdGFuY2UgPSBtc2c7CiAgICB9CgogICAgcmV0dXJuIG9iajsKICB9Owp9Ci8qKgogKiBEZXNlcmlhbGl6ZXMgYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUgZm9ybWF0KS4KICogQHBhcmFtIHtqc3BiLkJ5dGVTb3VyY2V9IGJ5dGVzIFRoZSBieXRlcyB0byBkZXNlcmlhbGl6ZS4KICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5UcmFuc2FjdGlvbkxpc3RSZXBseX0KICovCgoKcHJvdG8ucGIuY21zLlRyYW5zYWN0aW9uTGlzdFJlcGx5LmRlc2VyaWFsaXplQmluYXJ5ID0gZnVuY3Rpb24gKGJ5dGVzKSB7CiAgdmFyIHJlYWRlciA9IG5ldyBqc3BiLkJpbmFyeVJlYWRlcihieXRlcyk7CiAgdmFyIG1zZyA9IG5ldyBwcm90by5wYi5jbXMuVHJhbnNhY3Rpb25MaXN0UmVwbHkoKTsKICByZXR1cm4gcHJvdG8ucGIuY21zLlRyYW5zYWN0aW9uTGlzdFJlcGx5LmRlc2VyaWFsaXplQmluYXJ5RnJvbVJlYWRlcihtc2csIHJlYWRlcik7Cn07Ci8qKgogKiBEZXNlcmlhbGl6ZXMgYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUgZm9ybWF0KSBmcm9tIHRoZQogKiBnaXZlbiByZWFkZXIgaW50byB0aGUgZ2l2ZW4gbWVzc2FnZSBvYmplY3QuCiAqIEBwYXJhbSB7IXByb3RvLnBiLmNtcy5UcmFuc2FjdGlvbkxpc3RSZXBseX0gbXNnIFRoZSBtZXNzYWdlIG9iamVjdCB0byBkZXNlcmlhbGl6ZSBpbnRvLgogKiBAcGFyYW0geyFqc3BiLkJpbmFyeVJlYWRlcn0gcmVhZGVyIFRoZSBCaW5hcnlSZWFkZXIgdG8gdXNlLgogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLlRyYW5zYWN0aW9uTGlzdFJlcGx5fQogKi8KCgpwcm90by5wYi5jbXMuVHJhbnNhY3Rpb25MaXN0UmVwbHkuZGVzZXJpYWxpemVCaW5hcnlGcm9tUmVhZGVyID0gZnVuY3Rpb24gKG1zZywgcmVhZGVyKSB7CiAgd2hpbGUgKHJlYWRlci5uZXh0RmllbGQoKSkgewogICAgaWYgKHJlYWRlci5pc0VuZEdyb3VwKCkpIHsKICAgICAgYnJlYWs7CiAgICB9CgogICAgdmFyIGZpZWxkID0gcmVhZGVyLmdldEZpZWxkTnVtYmVyKCk7CgogICAgc3dpdGNoIChmaWVsZCkgewogICAgICBjYXNlIDE6CiAgICAgICAgdmFyIHZhbHVlID0gbmV3IHVzZXJ0eXBlX3BiLlRyYW5zYWN0aW9uKCk7CiAgICAgICAgcmVhZGVyLnJlYWRNZXNzYWdlKHZhbHVlLCB1c2VydHlwZV9wYi5UcmFuc2FjdGlvbi5kZXNlcmlhbGl6ZUJpbmFyeUZyb21SZWFkZXIpOwogICAgICAgIG1zZy5hZGRUcmFuc2FjdGlvbnModmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSAyOgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkVWludDMyKCk7CiAgICAgICAgbXNnLnNldFBhZ2VObyh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlIDM6CiAgICAgICAgdmFyIHZhbHVlID0gcmVhZGVyLnJlYWRVaW50MzIoKTsKICAgICAgICBtc2cuc2V0UGFnZVNpemUodmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSA0OgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkVWludDMyKCk7CiAgICAgICAgbXNnLnNldFRvdGFsUGFnZSh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlIDU6CiAgICAgICAgdmFyIHZhbHVlID0gcmVhZGVyLnJlYWRVaW50MzIoKTsKICAgICAgICBtc2cuc2V0VG90YWxDb3VudCh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBkZWZhdWx0OgogICAgICAgIHJlYWRlci5za2lwRmllbGQoKTsKICAgICAgICBicmVhazsKICAgIH0KICB9CgogIHJldHVybiBtc2c7Cn07Ci8qKgogKiBTZXJpYWxpemVzIHRoZSBtZXNzYWdlIHRvIGJpbmFyeSBkYXRhIChpbiBwcm90b2J1ZiB3aXJlIGZvcm1hdCkuCiAqIEByZXR1cm4geyFVaW50OEFycmF5fQogKi8KCgpwcm90by5wYi5jbXMuVHJhbnNhY3Rpb25MaXN0UmVwbHkucHJvdG90eXBlLnNlcmlhbGl6ZUJpbmFyeSA9IGZ1bmN0aW9uICgpIHsKICB2YXIgd3JpdGVyID0gbmV3IGpzcGIuQmluYXJ5V3JpdGVyKCk7CiAgcHJvdG8ucGIuY21zLlRyYW5zYWN0aW9uTGlzdFJlcGx5LnNlcmlhbGl6ZUJpbmFyeVRvV3JpdGVyKHRoaXMsIHdyaXRlcik7CiAgcmV0dXJuIHdyaXRlci5nZXRSZXN1bHRCdWZmZXIoKTsKfTsKLyoqCiAqIFNlcmlhbGl6ZXMgdGhlIGdpdmVuIG1lc3NhZ2UgdG8gYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUKICogZm9ybWF0KSwgd3JpdGluZyB0byB0aGUgZ2l2ZW4gQmluYXJ5V3JpdGVyLgogKiBAcGFyYW0geyFwcm90by5wYi5jbXMuVHJhbnNhY3Rpb25MaXN0UmVwbHl9IG1lc3NhZ2UKICogQHBhcmFtIHshanNwYi5CaW5hcnlXcml0ZXJ9IHdyaXRlcgogKiBAc3VwcHJlc3Mge3VudXNlZExvY2FsVmFyaWFibGVzfSBmIGlzIG9ubHkgdXNlZCBmb3IgbmVzdGVkIG1lc3NhZ2VzCiAqLwoKCnByb3RvLnBiLmNtcy5UcmFuc2FjdGlvbkxpc3RSZXBseS5zZXJpYWxpemVCaW5hcnlUb1dyaXRlciA9IGZ1bmN0aW9uIChtZXNzYWdlLCB3cml0ZXIpIHsKICB2YXIgZiA9IHVuZGVmaW5lZDsKICBmID0gbWVzc2FnZS5nZXRUcmFuc2FjdGlvbnNMaXN0KCk7CgogIGlmIChmLmxlbmd0aCA+IDApIHsKICAgIHdyaXRlci53cml0ZVJlcGVhdGVkTWVzc2FnZSgxLCBmLCB1c2VydHlwZV9wYi5UcmFuc2FjdGlvbi5zZXJpYWxpemVCaW5hcnlUb1dyaXRlcik7CiAgfQoKICBmID0gbWVzc2FnZS5nZXRQYWdlTm8oKTsKCiAgaWYgKGYgIT09IDApIHsKICAgIHdyaXRlci53cml0ZVVpbnQzMigyLCBmKTsKICB9CgogIGYgPSBtZXNzYWdlLmdldFBhZ2VTaXplKCk7CgogIGlmIChmICE9PSAwKSB7CiAgICB3cml0ZXIud3JpdGVVaW50MzIoMywgZik7CiAgfQoKICBmID0gbWVzc2FnZS5nZXRUb3RhbFBhZ2UoKTsKCiAgaWYgKGYgIT09IDApIHsKICAgIHdyaXRlci53cml0ZVVpbnQzMig0LCBmKTsKICB9CgogIGYgPSBtZXNzYWdlLmdldFRvdGFsQ291bnQoKTsKCiAgaWYgKGYgIT09IDApIHsKICAgIHdyaXRlci53cml0ZVVpbnQzMig1LCBmKTsKICB9Cn07Ci8qKgogKiByZXBlYXRlZCBwYi5UcmFuc2FjdGlvbiB0cmFuc2FjdGlvbnMgPSAxOwogKiBAcmV0dXJuIHshQXJyYXk8IXByb3RvLnBiLlRyYW5zYWN0aW9uPn0KICovCgoKcHJvdG8ucGIuY21zLlRyYW5zYWN0aW9uTGlzdFJlcGx5LnByb3RvdHlwZS5nZXRUcmFuc2FjdGlvbnNMaXN0ID0gZnVuY3Rpb24gKCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuZ2V0UmVwZWF0ZWRXcmFwcGVyRmllbGQodGhpcywgdXNlcnR5cGVfcGIuVHJhbnNhY3Rpb24sIDEpOwp9OwovKioKICogQHBhcmFtIHshQXJyYXk8IXByb3RvLnBiLlRyYW5zYWN0aW9uPn0gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5UcmFuc2FjdGlvbkxpc3RSZXBseX0gcmV0dXJucyB0aGlzCiovCgoKcHJvdG8ucGIuY21zLlRyYW5zYWN0aW9uTGlzdFJlcGx5LnByb3RvdHlwZS5zZXRUcmFuc2FjdGlvbnNMaXN0ID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRSZXBlYXRlZFdyYXBwZXJGaWVsZCh0aGlzLCAxLCB2YWx1ZSk7Cn07Ci8qKgogKiBAcGFyYW0geyFwcm90by5wYi5UcmFuc2FjdGlvbj19IG9wdF92YWx1ZQogKiBAcGFyYW0ge251bWJlcj19IG9wdF9pbmRleAogKiBAcmV0dXJuIHshcHJvdG8ucGIuVHJhbnNhY3Rpb259CiAqLwoKCnByb3RvLnBiLmNtcy5UcmFuc2FjdGlvbkxpc3RSZXBseS5wcm90b3R5cGUuYWRkVHJhbnNhY3Rpb25zID0gZnVuY3Rpb24gKG9wdF92YWx1ZSwgb3B0X2luZGV4KSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5hZGRUb1JlcGVhdGVkV3JhcHBlckZpZWxkKHRoaXMsIDEsIG9wdF92YWx1ZSwgcHJvdG8ucGIuVHJhbnNhY3Rpb24sIG9wdF9pbmRleCk7Cn07Ci8qKgogKiBDbGVhcnMgdGhlIGxpc3QgbWFraW5nIGl0IGVtcHR5IGJ1dCBub24tbnVsbC4KICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5UcmFuc2FjdGlvbkxpc3RSZXBseX0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5UcmFuc2FjdGlvbkxpc3RSZXBseS5wcm90b3R5cGUuY2xlYXJUcmFuc2FjdGlvbnNMaXN0ID0gZnVuY3Rpb24gKCkgewogIHJldHVybiB0aGlzLnNldFRyYW5zYWN0aW9uc0xpc3QoW10pOwp9OwovKioKICogb3B0aW9uYWwgdWludDMyIHBhZ2Vfbm8gPSAyOwogKiBAcmV0dXJuIHtudW1iZXJ9CiAqLwoKCnByb3RvLnBiLmNtcy5UcmFuc2FjdGlvbkxpc3RSZXBseS5wcm90b3R5cGUuZ2V0UGFnZU5vID0gZnVuY3Rpb24gKCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdCh0aGlzLCAyLCAwKTsKfTsKLyoqCiAqIEBwYXJhbSB7bnVtYmVyfSB2YWx1ZQogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLlRyYW5zYWN0aW9uTGlzdFJlcGx5fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLlRyYW5zYWN0aW9uTGlzdFJlcGx5LnByb3RvdHlwZS5zZXRQYWdlTm8gPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0ludEZpZWxkKHRoaXMsIDIsIHZhbHVlKTsKfTsKLyoqCiAqIG9wdGlvbmFsIHVpbnQzMiBwYWdlX3NpemUgPSAzOwogKiBAcmV0dXJuIHtudW1iZXJ9CiAqLwoKCnByb3RvLnBiLmNtcy5UcmFuc2FjdGlvbkxpc3RSZXBseS5wcm90b3R5cGUuZ2V0UGFnZVNpemUgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDMsIDApOwp9OwovKioKICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuVHJhbnNhY3Rpb25MaXN0UmVwbHl9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuVHJhbnNhY3Rpb25MaXN0UmVwbHkucHJvdG90eXBlLnNldFBhZ2VTaXplID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRQcm90bzNJbnRGaWVsZCh0aGlzLCAzLCB2YWx1ZSk7Cn07Ci8qKgogKiBvcHRpb25hbCB1aW50MzIgdG90YWxfcGFnZSA9IDQ7CiAqIEByZXR1cm4ge251bWJlcn0KICovCgoKcHJvdG8ucGIuY21zLlRyYW5zYWN0aW9uTGlzdFJlcGx5LnByb3RvdHlwZS5nZXRUb3RhbFBhZ2UgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDQsIDApOwp9OwovKioKICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuVHJhbnNhY3Rpb25MaXN0UmVwbHl9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuVHJhbnNhY3Rpb25MaXN0UmVwbHkucHJvdG90eXBlLnNldFRvdGFsUGFnZSA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UHJvdG8zSW50RmllbGQodGhpcywgNCwgdmFsdWUpOwp9OwovKioKICogb3B0aW9uYWwgdWludDMyIHRvdGFsX2NvdW50ID0gNTsKICogQHJldHVybiB7bnVtYmVyfQogKi8KCgpwcm90by5wYi5jbXMuVHJhbnNhY3Rpb25MaXN0UmVwbHkucHJvdG90eXBlLmdldFRvdGFsQ291bnQgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDUsIDApOwp9OwovKioKICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuVHJhbnNhY3Rpb25MaXN0UmVwbHl9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuVHJhbnNhY3Rpb25MaXN0UmVwbHkucHJvdG90eXBlLnNldFRvdGFsQ291bnQgPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0ludEZpZWxkKHRoaXMsIDUsIHZhbHVlKTsKfTsKCmlmIChqc3BiLk1lc3NhZ2UuR0VORVJBVEVfVE9fT0JKRUNUKSB7CiAgLyoqCiAgICogQ3JlYXRlcyBhbiBvYmplY3QgcmVwcmVzZW50YXRpb24gb2YgdGhpcyBwcm90by4KICAgKiBGaWVsZCBuYW1lcyB0aGF0IGFyZSByZXNlcnZlZCBpbiBKYXZhU2NyaXB0IGFuZCB3aWxsIGJlIHJlbmFtZWQgdG8gcGJfbmFtZS4KICAgKiBPcHRpb25hbCBmaWVsZHMgdGhhdCBhcmUgbm90IHNldCB3aWxsIGJlIHNldCB0byB1bmRlZmluZWQuCiAgICogVG8gYWNjZXNzIGEgcmVzZXJ2ZWQgZmllbGQgdXNlLCBmb28ucGJfPG5hbWU+LCBlZywgZm9vLnBiX2RlZmF1bHQuCiAgICogRm9yIHRoZSBsaXN0IG9mIHJlc2VydmVkIG5hbWVzIHBsZWFzZSBzZWU6CiAgICogICAgIG5ldC9wcm90bzIvY29tcGlsZXIvanMvaW50ZXJuYWwvZ2VuZXJhdG9yLmNjI2tLZXl3b3JkLgogICAqIEBwYXJhbSB7Ym9vbGVhbj19IG9wdF9pbmNsdWRlSW5zdGFuY2UgRGVwcmVjYXRlZC4gd2hldGhlciB0byBpbmNsdWRlIHRoZQogICAqICAgICBKU1BCIGluc3RhbmNlIGZvciB0cmFuc2l0aW9uYWwgc295IHByb3RvIHN1cHBvcnQ6CiAgICogICAgIGh0dHA6Ly9nb3RvL3NveS1wYXJhbS1taWdyYXRpb24KICAgKiBAcmV0dXJuIHshT2JqZWN0fQogICAqLwogIHByb3RvLnBiLmNtcy5BZG1pbkZpbGVDaHVuay5wcm90b3R5cGUudG9PYmplY3QgPSBmdW5jdGlvbiAob3B0X2luY2x1ZGVJbnN0YW5jZSkgewogICAgcmV0dXJuIHByb3RvLnBiLmNtcy5BZG1pbkZpbGVDaHVuay50b09iamVjdChvcHRfaW5jbHVkZUluc3RhbmNlLCB0aGlzKTsKICB9OwogIC8qKgogICAqIFN0YXRpYyB2ZXJzaW9uIG9mIHRoZSB7QHNlZSB0b09iamVjdH0gbWV0aG9kLgogICAqIEBwYXJhbSB7Ym9vbGVhbnx1bmRlZmluZWR9IGluY2x1ZGVJbnN0YW5jZSBEZXByZWNhdGVkLiBXaGV0aGVyIHRvIGluY2x1ZGUKICAgKiAgICAgdGhlIEpTUEIgaW5zdGFuY2UgZm9yIHRyYW5zaXRpb25hbCBzb3kgcHJvdG8gc3VwcG9ydDoKICAgKiAgICAgaHR0cDovL2dvdG8vc295LXBhcmFtLW1pZ3JhdGlvbgogICAqIEBwYXJhbSB7IXByb3RvLnBiLmNtcy5BZG1pbkZpbGVDaHVua30gbXNnIFRoZSBtc2cgaW5zdGFuY2UgdG8gdHJhbnNmb3JtLgogICAqIEByZXR1cm4geyFPYmplY3R9CiAgICogQHN1cHByZXNzIHt1bnVzZWRMb2NhbFZhcmlhYmxlc30gZiBpcyBvbmx5IHVzZWQgZm9yIG5lc3RlZCBtZXNzYWdlcwogICAqLwoKCiAgcHJvdG8ucGIuY21zLkFkbWluRmlsZUNodW5rLnRvT2JqZWN0ID0gZnVuY3Rpb24gKGluY2x1ZGVJbnN0YW5jZSwgbXNnKSB7CiAgICB2YXIgZiwKICAgICAgICBvYmogPSB7CiAgICAgIG9mZnNldDoganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQobXNnLCAxLCAwKSwKICAgICAgZmlsZW5hbWU6IGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KG1zZywgMiwgIiIpLAogICAgICB0eXBlOiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdChtc2csIDMsIDApLAogICAgICBjb250ZW50OiBtc2cuZ2V0Q29udGVudF9hc0I2NCgpLAogICAgICBhcmVhSWQ6IGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KG1zZywgNSwgMCkKICAgIH07CgogICAgaWYgKGluY2x1ZGVJbnN0YW5jZSkgewogICAgICBvYmouJGpzcGJNZXNzYWdlSW5zdGFuY2UgPSBtc2c7CiAgICB9CgogICAgcmV0dXJuIG9iajsKICB9Owp9Ci8qKgogKiBEZXNlcmlhbGl6ZXMgYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUgZm9ybWF0KS4KICogQHBhcmFtIHtqc3BiLkJ5dGVTb3VyY2V9IGJ5dGVzIFRoZSBieXRlcyB0byBkZXNlcmlhbGl6ZS4KICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5BZG1pbkZpbGVDaHVua30KICovCgoKcHJvdG8ucGIuY21zLkFkbWluRmlsZUNodW5rLmRlc2VyaWFsaXplQmluYXJ5ID0gZnVuY3Rpb24gKGJ5dGVzKSB7CiAgdmFyIHJlYWRlciA9IG5ldyBqc3BiLkJpbmFyeVJlYWRlcihieXRlcyk7CiAgdmFyIG1zZyA9IG5ldyBwcm90by5wYi5jbXMuQWRtaW5GaWxlQ2h1bmsoKTsKICByZXR1cm4gcHJvdG8ucGIuY21zLkFkbWluRmlsZUNodW5rLmRlc2VyaWFsaXplQmluYXJ5RnJvbVJlYWRlcihtc2csIHJlYWRlcik7Cn07Ci8qKgogKiBEZXNlcmlhbGl6ZXMgYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUgZm9ybWF0KSBmcm9tIHRoZQogKiBnaXZlbiByZWFkZXIgaW50byB0aGUgZ2l2ZW4gbWVzc2FnZSBvYmplY3QuCiAqIEBwYXJhbSB7IXByb3RvLnBiLmNtcy5BZG1pbkZpbGVDaHVua30gbXNnIFRoZSBtZXNzYWdlIG9iamVjdCB0byBkZXNlcmlhbGl6ZSBpbnRvLgogKiBAcGFyYW0geyFqc3BiLkJpbmFyeVJlYWRlcn0gcmVhZGVyIFRoZSBCaW5hcnlSZWFkZXIgdG8gdXNlLgogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLkFkbWluRmlsZUNodW5rfQogKi8KCgpwcm90by5wYi5jbXMuQWRtaW5GaWxlQ2h1bmsuZGVzZXJpYWxpemVCaW5hcnlGcm9tUmVhZGVyID0gZnVuY3Rpb24gKG1zZywgcmVhZGVyKSB7CiAgd2hpbGUgKHJlYWRlci5uZXh0RmllbGQoKSkgewogICAgaWYgKHJlYWRlci5pc0VuZEdyb3VwKCkpIHsKICAgICAgYnJlYWs7CiAgICB9CgogICAgdmFyIGZpZWxkID0gcmVhZGVyLmdldEZpZWxkTnVtYmVyKCk7CgogICAgc3dpdGNoIChmaWVsZCkgewogICAgICBjYXNlIDE6CiAgICAgICAgdmFyIHZhbHVlID0gcmVhZGVyLnJlYWRVaW50MzIoKTsKICAgICAgICBtc2cuc2V0T2Zmc2V0KHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgMjoKICAgICAgICB2YXIgdmFsdWUgPSByZWFkZXIucmVhZFN0cmluZygpOwogICAgICAgIG1zZy5zZXRGaWxlbmFtZSh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlIDM6CiAgICAgICAgdmFyIHZhbHVlID0gcmVhZGVyLnJlYWRFbnVtKCk7CiAgICAgICAgbXNnLnNldFR5cGUodmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSA0OgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkQnl0ZXMoKTsKICAgICAgICBtc2cuc2V0Q29udGVudCh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlIDU6CiAgICAgICAgdmFyIHZhbHVlID0gcmVhZGVyLnJlYWRVaW50MzIoKTsKICAgICAgICBtc2cuc2V0QXJlYUlkKHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGRlZmF1bHQ6CiAgICAgICAgcmVhZGVyLnNraXBGaWVsZCgpOwogICAgICAgIGJyZWFrOwogICAgfQogIH0KCiAgcmV0dXJuIG1zZzsKfTsKLyoqCiAqIFNlcmlhbGl6ZXMgdGhlIG1lc3NhZ2UgdG8gYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUgZm9ybWF0KS4KICogQHJldHVybiB7IVVpbnQ4QXJyYXl9CiAqLwoKCnByb3RvLnBiLmNtcy5BZG1pbkZpbGVDaHVuay5wcm90b3R5cGUuc2VyaWFsaXplQmluYXJ5ID0gZnVuY3Rpb24gKCkgewogIHZhciB3cml0ZXIgPSBuZXcganNwYi5CaW5hcnlXcml0ZXIoKTsKICBwcm90by5wYi5jbXMuQWRtaW5GaWxlQ2h1bmsuc2VyaWFsaXplQmluYXJ5VG9Xcml0ZXIodGhpcywgd3JpdGVyKTsKICByZXR1cm4gd3JpdGVyLmdldFJlc3VsdEJ1ZmZlcigpOwp9OwovKioKICogU2VyaWFsaXplcyB0aGUgZ2l2ZW4gbWVzc2FnZSB0byBiaW5hcnkgZGF0YSAoaW4gcHJvdG9idWYgd2lyZQogKiBmb3JtYXQpLCB3cml0aW5nIHRvIHRoZSBnaXZlbiBCaW5hcnlXcml0ZXIuCiAqIEBwYXJhbSB7IXByb3RvLnBiLmNtcy5BZG1pbkZpbGVDaHVua30gbWVzc2FnZQogKiBAcGFyYW0geyFqc3BiLkJpbmFyeVdyaXRlcn0gd3JpdGVyCiAqIEBzdXBwcmVzcyB7dW51c2VkTG9jYWxWYXJpYWJsZXN9IGYgaXMgb25seSB1c2VkIGZvciBuZXN0ZWQgbWVzc2FnZXMKICovCgoKcHJvdG8ucGIuY21zLkFkbWluRmlsZUNodW5rLnNlcmlhbGl6ZUJpbmFyeVRvV3JpdGVyID0gZnVuY3Rpb24gKG1lc3NhZ2UsIHdyaXRlcikgewogIHZhciBmID0gdW5kZWZpbmVkOwogIGYgPSBtZXNzYWdlLmdldE9mZnNldCgpOwoKICBpZiAoZiAhPT0gMCkgewogICAgd3JpdGVyLndyaXRlVWludDMyKDEsIGYpOwogIH0KCiAgZiA9IG1lc3NhZ2UuZ2V0RmlsZW5hbWUoKTsKCiAgaWYgKGYubGVuZ3RoID4gMCkgewogICAgd3JpdGVyLndyaXRlU3RyaW5nKDIsIGYpOwogIH0KCiAgZiA9IG1lc3NhZ2UuZ2V0VHlwZSgpOwoKICBpZiAoZiAhPT0gMC4wKSB7CiAgICB3cml0ZXIud3JpdGVFbnVtKDMsIGYpOwogIH0KCiAgZiA9IG1lc3NhZ2UuZ2V0Q29udGVudF9hc1U4KCk7CgogIGlmIChmLmxlbmd0aCA+IDApIHsKICAgIHdyaXRlci53cml0ZUJ5dGVzKDQsIGYpOwogIH0KCiAgZiA9IG1lc3NhZ2UuZ2V0QXJlYUlkKCk7CgogIGlmIChmICE9PSAwKSB7CiAgICB3cml0ZXIud3JpdGVVaW50MzIoNSwgZik7CiAgfQp9OwovKioKICogb3B0aW9uYWwgdWludDMyIG9mZnNldCA9IDE7CiAqIEByZXR1cm4ge251bWJlcn0KICovCgoKcHJvdG8ucGIuY21zLkFkbWluRmlsZUNodW5rLnByb3RvdHlwZS5nZXRPZmZzZXQgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDEsIDApOwp9OwovKioKICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuQWRtaW5GaWxlQ2h1bmt9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuQWRtaW5GaWxlQ2h1bmsucHJvdG90eXBlLnNldE9mZnNldCA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UHJvdG8zSW50RmllbGQodGhpcywgMSwgdmFsdWUpOwp9OwovKioKICogb3B0aW9uYWwgc3RyaW5nIGZpbGVuYW1lID0gMjsKICogQHJldHVybiB7c3RyaW5nfQogKi8KCgpwcm90by5wYi5jbXMuQWRtaW5GaWxlQ2h1bmsucHJvdG90eXBlLmdldEZpbGVuYW1lID0gZnVuY3Rpb24gKCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdCh0aGlzLCAyLCAiIik7Cn07Ci8qKgogKiBAcGFyYW0ge3N0cmluZ30gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5BZG1pbkZpbGVDaHVua30gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5BZG1pbkZpbGVDaHVuay5wcm90b3R5cGUuc2V0RmlsZW5hbWUgPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM1N0cmluZ0ZpZWxkKHRoaXMsIDIsIHZhbHVlKTsKfTsKLyoqCiAqIG9wdGlvbmFsIHBiLkZpbGVUeXBlIHR5cGUgPSAzOwogKiBAcmV0dXJuIHshcHJvdG8ucGIuRmlsZVR5cGV9CiAqLwoKCnByb3RvLnBiLmNtcy5BZG1pbkZpbGVDaHVuay5wcm90b3R5cGUuZ2V0VHlwZSA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQodGhpcywgMywgMCk7Cn07Ci8qKgogKiBAcGFyYW0geyFwcm90by5wYi5GaWxlVHlwZX0gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5BZG1pbkZpbGVDaHVua30gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5BZG1pbkZpbGVDaHVuay5wcm90b3R5cGUuc2V0VHlwZSA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UHJvdG8zRW51bUZpZWxkKHRoaXMsIDMsIHZhbHVlKTsKfTsKLyoqCiAqIG9wdGlvbmFsIGJ5dGVzIGNvbnRlbnQgPSA0OwogKiBAcmV0dXJuIHtzdHJpbmd9CiAqLwoKCnByb3RvLnBiLmNtcy5BZG1pbkZpbGVDaHVuay5wcm90b3R5cGUuZ2V0Q29udGVudCA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQodGhpcywgNCwgIiIpOwp9OwovKioKICogb3B0aW9uYWwgYnl0ZXMgY29udGVudCA9IDQ7CiAqIFRoaXMgaXMgYSB0eXBlLWNvbnZlcnNpb24gd3JhcHBlciBhcm91bmQgYGdldENvbnRlbnQoKWAKICogQHJldHVybiB7c3RyaW5nfQogKi8KCgpwcm90by5wYi5jbXMuQWRtaW5GaWxlQ2h1bmsucHJvdG90eXBlLmdldENvbnRlbnRfYXNCNjQgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5ieXRlc0FzQjY0KHRoaXMuZ2V0Q29udGVudCgpKTsKfTsKLyoqCiAqIG9wdGlvbmFsIGJ5dGVzIGNvbnRlbnQgPSA0OwogKiBOb3RlIHRoYXQgVWludDhBcnJheSBpcyBub3Qgc3VwcG9ydGVkIG9uIGFsbCBicm93c2Vycy4KICogQHNlZSBodHRwOi8vY2FuaXVzZS5jb20vVWludDhBcnJheQogKiBUaGlzIGlzIGEgdHlwZS1jb252ZXJzaW9uIHdyYXBwZXIgYXJvdW5kIGBnZXRDb250ZW50KClgCiAqIEByZXR1cm4geyFVaW50OEFycmF5fQogKi8KCgpwcm90by5wYi5jbXMuQWRtaW5GaWxlQ2h1bmsucHJvdG90eXBlLmdldENvbnRlbnRfYXNVOCA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmJ5dGVzQXNVOCh0aGlzLmdldENvbnRlbnQoKSk7Cn07Ci8qKgogKiBAcGFyYW0geyEoc3RyaW5nfFVpbnQ4QXJyYXkpfSB2YWx1ZQogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLkFkbWluRmlsZUNodW5rfSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLkFkbWluRmlsZUNodW5rLnByb3RvdHlwZS5zZXRDb250ZW50ID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRQcm90bzNCeXRlc0ZpZWxkKHRoaXMsIDQsIHZhbHVlKTsKfTsKLyoqCiAqIG9wdGlvbmFsIHVpbnQzMiBhcmVhX2lkID0gNTsKICogQHJldHVybiB7bnVtYmVyfQogKi8KCgpwcm90by5wYi5jbXMuQWRtaW5GaWxlQ2h1bmsucHJvdG90eXBlLmdldEFyZWFJZCA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQodGhpcywgNSwgMCk7Cn07Ci8qKgogKiBAcGFyYW0ge251bWJlcn0gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5BZG1pbkZpbGVDaHVua30gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5BZG1pbkZpbGVDaHVuay5wcm90b3R5cGUuc2V0QXJlYUlkID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRQcm90bzNJbnRGaWVsZCh0aGlzLCA1LCB2YWx1ZSk7Cn07Cgpnb29nLm9iamVjdC5leHRlbmQoZXhwb3J0cywgcHJvdG8ucGIuY21zKTs="},null]}