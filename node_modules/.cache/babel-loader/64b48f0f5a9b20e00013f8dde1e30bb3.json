{"remainingRequest":"/home/mengy/develop/iwork/kafo/vue-admin/node_modules/babel-loader/lib/index.js!/home/mengy/develop/iwork/kafo/vue-admin/src/proto/js/cms_pb.js","dependencies":[{"path":"/home/mengy/develop/iwork/kafo/vue-admin/src/proto/js/cms_pb.js","mtime":1631588621219},{"path":"/home/mengy/develop/iwork/kafo/vue-admin/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/home/mengy/develop/iwork/kafo/vue-admin/node_modules/babel-loader/lib/index.js","mtime":315532800000}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:Ly8gc291cmNlOiBjbXMucHJvdG8KCi8qKgogKiBAZmlsZW92ZXJ2aWV3CiAqIEBlbmhhbmNlYWJsZQogKiBAc3VwcHJlc3Mge21pc3NpbmdSZXF1aXJlfSByZXBvcnRzIGVycm9yIG9uIGltcGxpY2l0IHR5cGUgdXNhZ2VzLgogKiBAc3VwcHJlc3Mge21lc3NhZ2VDb252ZW50aW9uc30gSlMgQ29tcGlsZXIgcmVwb3J0cyBhbiBlcnJvciBpZiBhIHZhcmlhYmxlIG9yCiAqICAgICBmaWVsZCBzdGFydHMgd2l0aCAnTVNHXycgYW5kIGlzbid0IGEgdHJhbnNsYXRhYmxlIG1lc3NhZ2UuCiAqIEBwdWJsaWMKICovCi8vIEdFTkVSQVRFRCBDT0RFIC0tIERPIE5PVCBFRElUIQoKLyogZXNsaW50LWRpc2FibGUgKi8KLy8gQHRzLW5vY2hlY2sKdmFyIGpzcGIgPSByZXF1aXJlKCdnb29nbGUtcHJvdG9idWYnKTsKCnZhciBnb29nID0ganNwYjsKdmFyIGdsb2JhbCA9IEZ1bmN0aW9uKCdyZXR1cm4gdGhpcycpKCk7Cgp2YXIgdXNlcnR5cGVfcGIgPSByZXF1aXJlKCcuL3VzZXJ0eXBlX3BiLmpzJyk7Cgpnb29nLm9iamVjdC5leHRlbmQocHJvdG8sIHVzZXJ0eXBlX3BiKTsKCnZhciBhbmNob3J0eXBlX3BiID0gcmVxdWlyZSgnLi9hbmNob3J0eXBlX3BiLmpzJyk7Cgpnb29nLm9iamVjdC5leHRlbmQocHJvdG8sIGFuY2hvcnR5cGVfcGIpOwoKdmFyIGNtc3R5cGVfcGIgPSByZXF1aXJlKCcuL2Ntc3R5cGVfcGIuanMnKTsKCmdvb2cub2JqZWN0LmV4dGVuZChwcm90bywgY21zdHlwZV9wYik7Cmdvb2cuZXhwb3J0U3ltYm9sKCdwcm90by5wYi5jbXMuQWRqdXN0QmFsYW5jZVJlcGx5JywgbnVsbCwgZ2xvYmFsKTsKZ29vZy5leHBvcnRTeW1ib2woJ3Byb3RvLnBiLmNtcy5BZGp1c3RCYWxhbmNlUmVxdWVzdCcsIG51bGwsIGdsb2JhbCk7Cmdvb2cuZXhwb3J0U3ltYm9sKCdwcm90by5wYi5jbXMuQWRtaW5GaWxlQ2h1bmsnLCBudWxsLCBnbG9iYWwpOwpnb29nLmV4cG9ydFN5bWJvbCgncHJvdG8ucGIuY21zLkFkbWluTGlzdFJlcGx5JywgbnVsbCwgZ2xvYmFsKTsKZ29vZy5leHBvcnRTeW1ib2woJ3Byb3RvLnBiLmNtcy5BbmNob3JGdWxsUmVwbHknLCBudWxsLCBnbG9iYWwpOwpnb29nLmV4cG9ydFN5bWJvbCgncHJvdG8ucGIuY21zLkFuY2hvckZ1bGxSZXF1ZXN0JywgbnVsbCwgZ2xvYmFsKTsKZ29vZy5leHBvcnRTeW1ib2woJ3Byb3RvLnBiLmNtcy5BbmNob3JMaXN0UmVwbHknLCBudWxsLCBnbG9iYWwpOwpnb29nLmV4cG9ydFN5bWJvbCgncHJvdG8ucGIuY21zLkFuY2hvckxpc3RSZXF1ZXN0JywgbnVsbCwgZ2xvYmFsKTsKZ29vZy5leHBvcnRTeW1ib2woJ3Byb3RvLnBiLmNtcy5BcHBMaXN0UmVwbHknLCBudWxsLCBnbG9iYWwpOwpnb29nLmV4cG9ydFN5bWJvbCgncHJvdG8ucGIuY21zLkFwcFN0YXQnLCBudWxsLCBnbG9iYWwpOwpnb29nLmV4cG9ydFN5bWJvbCgncHJvdG8ucGIuY21zLkFyZWFMaXN0UmVwbHknLCBudWxsLCBnbG9iYWwpOwpnb29nLmV4cG9ydFN5bWJvbCgncHJvdG8ucGIuY21zLkFyZWFTdGF0UmVwbHknLCBudWxsLCBnbG9iYWwpOwpnb29nLmV4cG9ydFN5bWJvbCgncHJvdG8ucGIuY21zLkFyZWFTdGF0UmVxdWVzdCcsIG51bGwsIGdsb2JhbCk7Cmdvb2cuZXhwb3J0U3ltYm9sKCdwcm90by5wYi5jbXMuQXV0aG9yaXplQW5jaG9yUmVxdWVzdCcsIG51bGwsIGdsb2JhbCk7Cmdvb2cuZXhwb3J0U3ltYm9sKCdwcm90by5wYi5jbXMuQXV0b01lc3NhZ2VMaXN0UmVwbHknLCBudWxsLCBnbG9iYWwpOwpnb29nLmV4cG9ydFN5bWJvbCgncHJvdG8ucGIuY21zLkF1dG9NZXNzYWdlTGlzdFJlcXVlc3QnLCBudWxsLCBnbG9iYWwpOwpnb29nLmV4cG9ydFN5bWJvbCgncHJvdG8ucGIuY21zLkJsb2NrUmVxdWVzdCcsIG51bGwsIGdsb2JhbCk7Cmdvb2cuZXhwb3J0U3ltYm9sKCdwcm90by5wYi5jbXMuQ2FsbExpc3RSZXBseScsIG51bGwsIGdsb2JhbCk7Cmdvb2cuZXhwb3J0U3ltYm9sKCdwcm90by5wYi5jbXMuQ2FsbExpc3RSZXF1ZXN0JywgbnVsbCwgZ2xvYmFsKTsKZ29vZy5leHBvcnRTeW1ib2woJ3Byb3RvLnBiLmNtcy5DaGF0TWVzc2FnZUxpc3RSZXBseScsIG51bGwsIGdsb2JhbCk7Cmdvb2cuZXhwb3J0U3ltYm9sKCdwcm90by5wYi5jbXMuQ2hhdE1lc3NhZ2VMaXN0UmVxdWVzdCcsIG51bGwsIGdsb2JhbCk7Cmdvb2cuZXhwb3J0U3ltYm9sKCdwcm90by5wYi5jbXMuQ3JlYXRlU2V0dGxlUmVxdWVzdCcsIG51bGwsIGdsb2JhbCk7Cmdvb2cuZXhwb3J0U3ltYm9sKCdwcm90by5wYi5jbXMuR3VpbGRMaXN0UmVwbHknLCBudWxsLCBnbG9iYWwpOwpnb29nLmV4cG9ydFN5bWJvbCgncHJvdG8ucGIuY21zLkhvbWVTdGF0UmVwbHknLCBudWxsLCBnbG9iYWwpOwpnb29nLmV4cG9ydFN5bWJvbCgncHJvdG8ucGIuY21zLkhvbWVTdGF0UmVxdWVzdCcsIG51bGwsIGdsb2JhbCk7Cmdvb2cuZXhwb3J0U3ltYm9sKCdwcm90by5wYi5jbXMuTGl2ZUxpc3RSZXBseScsIG51bGwsIGdsb2JhbCk7Cmdvb2cuZXhwb3J0U3ltYm9sKCdwcm90by5wYi5jbXMuTGl2ZUxpc3RSZXF1ZXN0JywgbnVsbCwgZ2xvYmFsKTsKZ29vZy5leHBvcnRTeW1ib2woJ3Byb3RvLnBiLmNtcy5Mb2dpblJlcXVlc3QnLCBudWxsLCBnbG9iYWwpOwpnb29nLmV4cG9ydFN5bWJvbCgncHJvdG8ucGIuY21zLk1pZ3JhdGVSZXF1ZXN0JywgbnVsbCwgZ2xvYmFsKTsKZ29vZy5leHBvcnRTeW1ib2woJ3Byb3RvLnBiLmNtcy5Nb21lbnRMaXN0UmVwbHknLCBudWxsLCBnbG9iYWwpOwpnb29nLmV4cG9ydFN5bWJvbCgncHJvdG8ucGIuY21zLk1vbWVudExpc3RSZXF1ZXN0JywgbnVsbCwgZ2xvYmFsKTsKZ29vZy5leHBvcnRTeW1ib2woJ3Byb3RvLnBiLmNtcy5PdmVydmlld1JlcGx5JywgbnVsbCwgZ2xvYmFsKTsKZ29vZy5leHBvcnRTeW1ib2woJ3Byb3RvLnBiLmNtcy5PdmVydmlld1JlcXVlc3QnLCBudWxsLCBnbG9iYWwpOwpnb29nLmV4cG9ydFN5bWJvbCgncHJvdG8ucGIuY21zLlBheUxpc3RSZXBseScsIG51bGwsIGdsb2JhbCk7Cmdvb2cuZXhwb3J0U3ltYm9sKCdwcm90by5wYi5jbXMuUGF5TGlzdFJlcXVlc3QnLCBudWxsLCBnbG9iYWwpOwpnb29nLmV4cG9ydFN5bWJvbCgncHJvdG8ucGIuY21zLlByb2Nlc3NQcm9maWxlUmVxdWVzdCcsIG51bGwsIGdsb2JhbCk7Cmdvb2cuZXhwb3J0U3ltYm9sKCdwcm90by5wYi5jbXMuUHJvY2Vzc1Zpb2xhdGlvblJlcXVlc3QnLCBudWxsLCBnbG9iYWwpOwpnb29nLmV4cG9ydFN5bWJvbCgncHJvdG8ucGIuY21zLlByb2ZpbGVMaXN0UmVwbHknLCBudWxsLCBnbG9iYWwpOwpnb29nLmV4cG9ydFN5bWJvbCgncHJvdG8ucGIuY21zLlByb2ZpbGVMaXN0UmVxdWVzdCcsIG51bGwsIGdsb2JhbCk7Cmdvb2cuZXhwb3J0U3ltYm9sKCdwcm90by5wYi5jbXMuUm9ib3RMaXN0UmVwbHknLCBudWxsLCBnbG9iYWwpOwpnb29nLmV4cG9ydFN5bWJvbCgncHJvdG8ucGIuY21zLlJvYm90TGlzdFJlcXVlc3QnLCBudWxsLCBnbG9iYWwpOwpnb29nLmV4cG9ydFN5bWJvbCgncHJvdG8ucGIuY21zLlJvYm90TWVzc2FnZUxpc3RSZXBseScsIG51bGwsIGdsb2JhbCk7Cmdvb2cuZXhwb3J0U3ltYm9sKCdwcm90by5wYi5jbXMuUm9ib3RNZXNzYWdlTGlzdFJlcXVlc3QnLCBudWxsLCBnbG9iYWwpOwpnb29nLmV4cG9ydFN5bWJvbCgncHJvdG8ucGIuY21zLlNldHRsZUxpc3RSZXBseScsIG51bGwsIGdsb2JhbCk7Cmdvb2cuZXhwb3J0U3ltYm9sKCdwcm90by5wYi5jbXMuU2V0dGxlTGlzdFJlcXVlc3QnLCBudWxsLCBnbG9iYWwpOwpnb29nLmV4cG9ydFN5bWJvbCgncHJvdG8ucGIuY21zLlNldHRsZVByb2dyZXNzUmVwbHknLCBudWxsLCBnbG9iYWwpOwpnb29nLmV4cG9ydFN5bWJvbCgncHJvdG8ucGIuY21zLlNldHRsZVByb2dyZXNzUmVxdWVzdCcsIG51bGwsIGdsb2JhbCk7Cmdvb2cuZXhwb3J0U3ltYm9sKCdwcm90by5wYi5jbXMuU3VibWl0U2V0dGxlUmVxdWVzdCcsIG51bGwsIGdsb2JhbCk7Cmdvb2cuZXhwb3J0U3ltYm9sKCdwcm90by5wYi5jbXMuVHJhbnNhY3Rpb25MaXN0UmVwbHknLCBudWxsLCBnbG9iYWwpOwpnb29nLmV4cG9ydFN5bWJvbCgncHJvdG8ucGIuY21zLlRyYW5zYWN0aW9uTGlzdFJlcXVlc3QnLCBudWxsLCBnbG9iYWwpOwpnb29nLmV4cG9ydFN5bWJvbCgncHJvdG8ucGIuY21zLlVuYmxvY2tSZXF1ZXN0JywgbnVsbCwgZ2xvYmFsKTsKZ29vZy5leHBvcnRTeW1ib2woJ3Byb3RvLnBiLmNtcy5Vc2VyTGlzdFJlcGx5JywgbnVsbCwgZ2xvYmFsKTsKZ29vZy5leHBvcnRTeW1ib2woJ3Byb3RvLnBiLmNtcy5Vc2VyTGlzdFJlcXVlc3QnLCBudWxsLCBnbG9iYWwpOwpnb29nLmV4cG9ydFN5bWJvbCgncHJvdG8ucGIuY21zLlZpb2xhdGlvbkxpc3RSZXBseScsIG51bGwsIGdsb2JhbCk7Cmdvb2cuZXhwb3J0U3ltYm9sKCdwcm90by5wYi5jbXMuVmlvbGF0aW9uTGlzdFJlcXVlc3QnLCBudWxsLCBnbG9iYWwpOwovKioKICogR2VuZXJhdGVkIGJ5IEpzUGJDb2RlR2VuZXJhdG9yLgogKiBAcGFyYW0ge0FycmF5PX0gb3B0X2RhdGEgT3B0aW9uYWwgaW5pdGlhbCBkYXRhIGFycmF5LCB0eXBpY2FsbHkgZnJvbSBhCiAqIHNlcnZlciByZXNwb25zZSwgb3IgY29uc3RydWN0ZWQgZGlyZWN0bHkgaW4gSmF2YXNjcmlwdC4gVGhlIGFycmF5IGlzIHVzZWQKICogaW4gcGxhY2UgYW5kIGJlY29tZXMgcGFydCBvZiB0aGUgY29uc3RydWN0ZWQgb2JqZWN0LiBJdCBpcyBub3QgY2xvbmVkLgogKiBJZiBubyBkYXRhIGlzIHByb3ZpZGVkLCB0aGUgY29uc3RydWN0ZWQgb2JqZWN0IHdpbGwgYmUgZW1wdHksIGJ1dCBzdGlsbAogKiB2YWxpZC4KICogQGV4dGVuZHMge2pzcGIuTWVzc2FnZX0KICogQGNvbnN0cnVjdG9yCiAqLwoKcHJvdG8ucGIuY21zLkFyZWFMaXN0UmVwbHkgPSBmdW5jdGlvbiAob3B0X2RhdGEpIHsKICBqc3BiLk1lc3NhZ2UuaW5pdGlhbGl6ZSh0aGlzLCBvcHRfZGF0YSwgMCwgLTEsIHByb3RvLnBiLmNtcy5BcmVhTGlzdFJlcGx5LnJlcGVhdGVkRmllbGRzXywgbnVsbCk7Cn07Cgpnb29nLmluaGVyaXRzKHByb3RvLnBiLmNtcy5BcmVhTGlzdFJlcGx5LCBqc3BiLk1lc3NhZ2UpOwoKaWYgKGdvb2cuREVCVUcgJiYgIUNPTVBJTEVEKSB7CiAgLyoqCiAgICogQHB1YmxpYwogICAqIEBvdmVycmlkZQogICAqLwogIHByb3RvLnBiLmNtcy5BcmVhTGlzdFJlcGx5LmRpc3BsYXlOYW1lID0gJ3Byb3RvLnBiLmNtcy5BcmVhTGlzdFJlcGx5JzsKfQovKioKICogR2VuZXJhdGVkIGJ5IEpzUGJDb2RlR2VuZXJhdG9yLgogKiBAcGFyYW0ge0FycmF5PX0gb3B0X2RhdGEgT3B0aW9uYWwgaW5pdGlhbCBkYXRhIGFycmF5LCB0eXBpY2FsbHkgZnJvbSBhCiAqIHNlcnZlciByZXNwb25zZSwgb3IgY29uc3RydWN0ZWQgZGlyZWN0bHkgaW4gSmF2YXNjcmlwdC4gVGhlIGFycmF5IGlzIHVzZWQKICogaW4gcGxhY2UgYW5kIGJlY29tZXMgcGFydCBvZiB0aGUgY29uc3RydWN0ZWQgb2JqZWN0LiBJdCBpcyBub3QgY2xvbmVkLgogKiBJZiBubyBkYXRhIGlzIHByb3ZpZGVkLCB0aGUgY29uc3RydWN0ZWQgb2JqZWN0IHdpbGwgYmUgZW1wdHksIGJ1dCBzdGlsbAogKiB2YWxpZC4KICogQGV4dGVuZHMge2pzcGIuTWVzc2FnZX0KICogQGNvbnN0cnVjdG9yCiAqLwoKCnByb3RvLnBiLmNtcy5Mb2dpblJlcXVlc3QgPSBmdW5jdGlvbiAob3B0X2RhdGEpIHsKICBqc3BiLk1lc3NhZ2UuaW5pdGlhbGl6ZSh0aGlzLCBvcHRfZGF0YSwgMCwgLTEsIG51bGwsIG51bGwpOwp9OwoKZ29vZy5pbmhlcml0cyhwcm90by5wYi5jbXMuTG9naW5SZXF1ZXN0LCBqc3BiLk1lc3NhZ2UpOwoKaWYgKGdvb2cuREVCVUcgJiYgIUNPTVBJTEVEKSB7CiAgLyoqCiAgICogQHB1YmxpYwogICAqIEBvdmVycmlkZQogICAqLwogIHByb3RvLnBiLmNtcy5Mb2dpblJlcXVlc3QuZGlzcGxheU5hbWUgPSAncHJvdG8ucGIuY21zLkxvZ2luUmVxdWVzdCc7Cn0KLyoqCiAqIEdlbmVyYXRlZCBieSBKc1BiQ29kZUdlbmVyYXRvci4KICogQHBhcmFtIHtBcnJheT19IG9wdF9kYXRhIE9wdGlvbmFsIGluaXRpYWwgZGF0YSBhcnJheSwgdHlwaWNhbGx5IGZyb20gYQogKiBzZXJ2ZXIgcmVzcG9uc2UsIG9yIGNvbnN0cnVjdGVkIGRpcmVjdGx5IGluIEphdmFzY3JpcHQuIFRoZSBhcnJheSBpcyB1c2VkCiAqIGluIHBsYWNlIGFuZCBiZWNvbWVzIHBhcnQgb2YgdGhlIGNvbnN0cnVjdGVkIG9iamVjdC4gSXQgaXMgbm90IGNsb25lZC4KICogSWYgbm8gZGF0YSBpcyBwcm92aWRlZCwgdGhlIGNvbnN0cnVjdGVkIG9iamVjdCB3aWxsIGJlIGVtcHR5LCBidXQgc3RpbGwKICogdmFsaWQuCiAqIEBleHRlbmRzIHtqc3BiLk1lc3NhZ2V9CiAqIEBjb25zdHJ1Y3RvcgogKi8KCgpwcm90by5wYi5jbXMuT3ZlcnZpZXdSZXF1ZXN0ID0gZnVuY3Rpb24gKG9wdF9kYXRhKSB7CiAganNwYi5NZXNzYWdlLmluaXRpYWxpemUodGhpcywgb3B0X2RhdGEsIDAsIC0xLCBudWxsLCBudWxsKTsKfTsKCmdvb2cuaW5oZXJpdHMocHJvdG8ucGIuY21zLk92ZXJ2aWV3UmVxdWVzdCwganNwYi5NZXNzYWdlKTsKCmlmIChnb29nLkRFQlVHICYmICFDT01QSUxFRCkgewogIC8qKgogICAqIEBwdWJsaWMKICAgKiBAb3ZlcnJpZGUKICAgKi8KICBwcm90by5wYi5jbXMuT3ZlcnZpZXdSZXF1ZXN0LmRpc3BsYXlOYW1lID0gJ3Byb3RvLnBiLmNtcy5PdmVydmlld1JlcXVlc3QnOwp9Ci8qKgogKiBHZW5lcmF0ZWQgYnkgSnNQYkNvZGVHZW5lcmF0b3IuCiAqIEBwYXJhbSB7QXJyYXk9fSBvcHRfZGF0YSBPcHRpb25hbCBpbml0aWFsIGRhdGEgYXJyYXksIHR5cGljYWxseSBmcm9tIGEKICogc2VydmVyIHJlc3BvbnNlLCBvciBjb25zdHJ1Y3RlZCBkaXJlY3RseSBpbiBKYXZhc2NyaXB0LiBUaGUgYXJyYXkgaXMgdXNlZAogKiBpbiBwbGFjZSBhbmQgYmVjb21lcyBwYXJ0IG9mIHRoZSBjb25zdHJ1Y3RlZCBvYmplY3QuIEl0IGlzIG5vdCBjbG9uZWQuCiAqIElmIG5vIGRhdGEgaXMgcHJvdmlkZWQsIHRoZSBjb25zdHJ1Y3RlZCBvYmplY3Qgd2lsbCBiZSBlbXB0eSwgYnV0IHN0aWxsCiAqIHZhbGlkLgogKiBAZXh0ZW5kcyB7anNwYi5NZXNzYWdlfQogKiBAY29uc3RydWN0b3IKICovCgoKcHJvdG8ucGIuY21zLk92ZXJ2aWV3UmVwbHkgPSBmdW5jdGlvbiAob3B0X2RhdGEpIHsKICBqc3BiLk1lc3NhZ2UuaW5pdGlhbGl6ZSh0aGlzLCBvcHRfZGF0YSwgMCwgLTEsIG51bGwsIG51bGwpOwp9OwoKZ29vZy5pbmhlcml0cyhwcm90by5wYi5jbXMuT3ZlcnZpZXdSZXBseSwganNwYi5NZXNzYWdlKTsKCmlmIChnb29nLkRFQlVHICYmICFDT01QSUxFRCkgewogIC8qKgogICAqIEBwdWJsaWMKICAgKiBAb3ZlcnJpZGUKICAgKi8KICBwcm90by5wYi5jbXMuT3ZlcnZpZXdSZXBseS5kaXNwbGF5TmFtZSA9ICdwcm90by5wYi5jbXMuT3ZlcnZpZXdSZXBseSc7Cn0KLyoqCiAqIEdlbmVyYXRlZCBieSBKc1BiQ29kZUdlbmVyYXRvci4KICogQHBhcmFtIHtBcnJheT19IG9wdF9kYXRhIE9wdGlvbmFsIGluaXRpYWwgZGF0YSBhcnJheSwgdHlwaWNhbGx5IGZyb20gYQogKiBzZXJ2ZXIgcmVzcG9uc2UsIG9yIGNvbnN0cnVjdGVkIGRpcmVjdGx5IGluIEphdmFzY3JpcHQuIFRoZSBhcnJheSBpcyB1c2VkCiAqIGluIHBsYWNlIGFuZCBiZWNvbWVzIHBhcnQgb2YgdGhlIGNvbnN0cnVjdGVkIG9iamVjdC4gSXQgaXMgbm90IGNsb25lZC4KICogSWYgbm8gZGF0YSBpcyBwcm92aWRlZCwgdGhlIGNvbnN0cnVjdGVkIG9iamVjdCB3aWxsIGJlIGVtcHR5LCBidXQgc3RpbGwKICogdmFsaWQuCiAqIEBleHRlbmRzIHtqc3BiLk1lc3NhZ2V9CiAqIEBjb25zdHJ1Y3RvcgogKi8KCgpwcm90by5wYi5jbXMuSG9tZVN0YXRSZXF1ZXN0ID0gZnVuY3Rpb24gKG9wdF9kYXRhKSB7CiAganNwYi5NZXNzYWdlLmluaXRpYWxpemUodGhpcywgb3B0X2RhdGEsIDAsIC0xLCBudWxsLCBudWxsKTsKfTsKCmdvb2cuaW5oZXJpdHMocHJvdG8ucGIuY21zLkhvbWVTdGF0UmVxdWVzdCwganNwYi5NZXNzYWdlKTsKCmlmIChnb29nLkRFQlVHICYmICFDT01QSUxFRCkgewogIC8qKgogICAqIEBwdWJsaWMKICAgKiBAb3ZlcnJpZGUKICAgKi8KICBwcm90by5wYi5jbXMuSG9tZVN0YXRSZXF1ZXN0LmRpc3BsYXlOYW1lID0gJ3Byb3RvLnBiLmNtcy5Ib21lU3RhdFJlcXVlc3QnOwp9Ci8qKgogKiBHZW5lcmF0ZWQgYnkgSnNQYkNvZGVHZW5lcmF0b3IuCiAqIEBwYXJhbSB7QXJyYXk9fSBvcHRfZGF0YSBPcHRpb25hbCBpbml0aWFsIGRhdGEgYXJyYXksIHR5cGljYWxseSBmcm9tIGEKICogc2VydmVyIHJlc3BvbnNlLCBvciBjb25zdHJ1Y3RlZCBkaXJlY3RseSBpbiBKYXZhc2NyaXB0LiBUaGUgYXJyYXkgaXMgdXNlZAogKiBpbiBwbGFjZSBhbmQgYmVjb21lcyBwYXJ0IG9mIHRoZSBjb25zdHJ1Y3RlZCBvYmplY3QuIEl0IGlzIG5vdCBjbG9uZWQuCiAqIElmIG5vIGRhdGEgaXMgcHJvdmlkZWQsIHRoZSBjb25zdHJ1Y3RlZCBvYmplY3Qgd2lsbCBiZSBlbXB0eSwgYnV0IHN0aWxsCiAqIHZhbGlkLgogKiBAZXh0ZW5kcyB7anNwYi5NZXNzYWdlfQogKiBAY29uc3RydWN0b3IKICovCgoKcHJvdG8ucGIuY21zLkFwcFN0YXQgPSBmdW5jdGlvbiAob3B0X2RhdGEpIHsKICBqc3BiLk1lc3NhZ2UuaW5pdGlhbGl6ZSh0aGlzLCBvcHRfZGF0YSwgMCwgLTEsIG51bGwsIG51bGwpOwp9OwoKZ29vZy5pbmhlcml0cyhwcm90by5wYi5jbXMuQXBwU3RhdCwganNwYi5NZXNzYWdlKTsKCmlmIChnb29nLkRFQlVHICYmICFDT01QSUxFRCkgewogIC8qKgogICAqIEBwdWJsaWMKICAgKiBAb3ZlcnJpZGUKICAgKi8KICBwcm90by5wYi5jbXMuQXBwU3RhdC5kaXNwbGF5TmFtZSA9ICdwcm90by5wYi5jbXMuQXBwU3RhdCc7Cn0KLyoqCiAqIEdlbmVyYXRlZCBieSBKc1BiQ29kZUdlbmVyYXRvci4KICogQHBhcmFtIHtBcnJheT19IG9wdF9kYXRhIE9wdGlvbmFsIGluaXRpYWwgZGF0YSBhcnJheSwgdHlwaWNhbGx5IGZyb20gYQogKiBzZXJ2ZXIgcmVzcG9uc2UsIG9yIGNvbnN0cnVjdGVkIGRpcmVjdGx5IGluIEphdmFzY3JpcHQuIFRoZSBhcnJheSBpcyB1c2VkCiAqIGluIHBsYWNlIGFuZCBiZWNvbWVzIHBhcnQgb2YgdGhlIGNvbnN0cnVjdGVkIG9iamVjdC4gSXQgaXMgbm90IGNsb25lZC4KICogSWYgbm8gZGF0YSBpcyBwcm92aWRlZCwgdGhlIGNvbnN0cnVjdGVkIG9iamVjdCB3aWxsIGJlIGVtcHR5LCBidXQgc3RpbGwKICogdmFsaWQuCiAqIEBleHRlbmRzIHtqc3BiLk1lc3NhZ2V9CiAqIEBjb25zdHJ1Y3RvcgogKi8KCgpwcm90by5wYi5jbXMuSG9tZVN0YXRSZXBseSA9IGZ1bmN0aW9uIChvcHRfZGF0YSkgewogIGpzcGIuTWVzc2FnZS5pbml0aWFsaXplKHRoaXMsIG9wdF9kYXRhLCAwLCAtMSwgcHJvdG8ucGIuY21zLkhvbWVTdGF0UmVwbHkucmVwZWF0ZWRGaWVsZHNfLCBudWxsKTsKfTsKCmdvb2cuaW5oZXJpdHMocHJvdG8ucGIuY21zLkhvbWVTdGF0UmVwbHksIGpzcGIuTWVzc2FnZSk7CgppZiAoZ29vZy5ERUJVRyAmJiAhQ09NUElMRUQpIHsKICAvKioKICAgKiBAcHVibGljCiAgICogQG92ZXJyaWRlCiAgICovCiAgcHJvdG8ucGIuY21zLkhvbWVTdGF0UmVwbHkuZGlzcGxheU5hbWUgPSAncHJvdG8ucGIuY21zLkhvbWVTdGF0UmVwbHknOwp9Ci8qKgogKiBHZW5lcmF0ZWQgYnkgSnNQYkNvZGVHZW5lcmF0b3IuCiAqIEBwYXJhbSB7QXJyYXk9fSBvcHRfZGF0YSBPcHRpb25hbCBpbml0aWFsIGRhdGEgYXJyYXksIHR5cGljYWxseSBmcm9tIGEKICogc2VydmVyIHJlc3BvbnNlLCBvciBjb25zdHJ1Y3RlZCBkaXJlY3RseSBpbiBKYXZhc2NyaXB0LiBUaGUgYXJyYXkgaXMgdXNlZAogKiBpbiBwbGFjZSBhbmQgYmVjb21lcyBwYXJ0IG9mIHRoZSBjb25zdHJ1Y3RlZCBvYmplY3QuIEl0IGlzIG5vdCBjbG9uZWQuCiAqIElmIG5vIGRhdGEgaXMgcHJvdmlkZWQsIHRoZSBjb25zdHJ1Y3RlZCBvYmplY3Qgd2lsbCBiZSBlbXB0eSwgYnV0IHN0aWxsCiAqIHZhbGlkLgogKiBAZXh0ZW5kcyB7anNwYi5NZXNzYWdlfQogKiBAY29uc3RydWN0b3IKICovCgoKcHJvdG8ucGIuY21zLkFyZWFTdGF0UmVxdWVzdCA9IGZ1bmN0aW9uIChvcHRfZGF0YSkgewogIGpzcGIuTWVzc2FnZS5pbml0aWFsaXplKHRoaXMsIG9wdF9kYXRhLCAwLCAtMSwgbnVsbCwgbnVsbCk7Cn07Cgpnb29nLmluaGVyaXRzKHByb3RvLnBiLmNtcy5BcmVhU3RhdFJlcXVlc3QsIGpzcGIuTWVzc2FnZSk7CgppZiAoZ29vZy5ERUJVRyAmJiAhQ09NUElMRUQpIHsKICAvKioKICAgKiBAcHVibGljCiAgICogQG92ZXJyaWRlCiAgICovCiAgcHJvdG8ucGIuY21zLkFyZWFTdGF0UmVxdWVzdC5kaXNwbGF5TmFtZSA9ICdwcm90by5wYi5jbXMuQXJlYVN0YXRSZXF1ZXN0JzsKfQovKioKICogR2VuZXJhdGVkIGJ5IEpzUGJDb2RlR2VuZXJhdG9yLgogKiBAcGFyYW0ge0FycmF5PX0gb3B0X2RhdGEgT3B0aW9uYWwgaW5pdGlhbCBkYXRhIGFycmF5LCB0eXBpY2FsbHkgZnJvbSBhCiAqIHNlcnZlciByZXNwb25zZSwgb3IgY29uc3RydWN0ZWQgZGlyZWN0bHkgaW4gSmF2YXNjcmlwdC4gVGhlIGFycmF5IGlzIHVzZWQKICogaW4gcGxhY2UgYW5kIGJlY29tZXMgcGFydCBvZiB0aGUgY29uc3RydWN0ZWQgb2JqZWN0LiBJdCBpcyBub3QgY2xvbmVkLgogKiBJZiBubyBkYXRhIGlzIHByb3ZpZGVkLCB0aGUgY29uc3RydWN0ZWQgb2JqZWN0IHdpbGwgYmUgZW1wdHksIGJ1dCBzdGlsbAogKiB2YWxpZC4KICogQGV4dGVuZHMge2pzcGIuTWVzc2FnZX0KICogQGNvbnN0cnVjdG9yCiAqLwoKCnByb3RvLnBiLmNtcy5BcmVhU3RhdFJlcGx5ID0gZnVuY3Rpb24gKG9wdF9kYXRhKSB7CiAganNwYi5NZXNzYWdlLmluaXRpYWxpemUodGhpcywgb3B0X2RhdGEsIDAsIC0xLCBudWxsLCBudWxsKTsKfTsKCmdvb2cuaW5oZXJpdHMocHJvdG8ucGIuY21zLkFyZWFTdGF0UmVwbHksIGpzcGIuTWVzc2FnZSk7CgppZiAoZ29vZy5ERUJVRyAmJiAhQ09NUElMRUQpIHsKICAvKioKICAgKiBAcHVibGljCiAgICogQG92ZXJyaWRlCiAgICovCiAgcHJvdG8ucGIuY21zLkFyZWFTdGF0UmVwbHkuZGlzcGxheU5hbWUgPSAncHJvdG8ucGIuY21zLkFyZWFTdGF0UmVwbHknOwp9Ci8qKgogKiBHZW5lcmF0ZWQgYnkgSnNQYkNvZGVHZW5lcmF0b3IuCiAqIEBwYXJhbSB7QXJyYXk9fSBvcHRfZGF0YSBPcHRpb25hbCBpbml0aWFsIGRhdGEgYXJyYXksIHR5cGljYWxseSBmcm9tIGEKICogc2VydmVyIHJlc3BvbnNlLCBvciBjb25zdHJ1Y3RlZCBkaXJlY3RseSBpbiBKYXZhc2NyaXB0LiBUaGUgYXJyYXkgaXMgdXNlZAogKiBpbiBwbGFjZSBhbmQgYmVjb21lcyBwYXJ0IG9mIHRoZSBjb25zdHJ1Y3RlZCBvYmplY3QuIEl0IGlzIG5vdCBjbG9uZWQuCiAqIElmIG5vIGRhdGEgaXMgcHJvdmlkZWQsIHRoZSBjb25zdHJ1Y3RlZCBvYmplY3Qgd2lsbCBiZSBlbXB0eSwgYnV0IHN0aWxsCiAqIHZhbGlkLgogKiBAZXh0ZW5kcyB7anNwYi5NZXNzYWdlfQogKiBAY29uc3RydWN0b3IKICovCgoKcHJvdG8ucGIuY21zLkFkbWluTGlzdFJlcGx5ID0gZnVuY3Rpb24gKG9wdF9kYXRhKSB7CiAganNwYi5NZXNzYWdlLmluaXRpYWxpemUodGhpcywgb3B0X2RhdGEsIDAsIC0xLCBwcm90by5wYi5jbXMuQWRtaW5MaXN0UmVwbHkucmVwZWF0ZWRGaWVsZHNfLCBudWxsKTsKfTsKCmdvb2cuaW5oZXJpdHMocHJvdG8ucGIuY21zLkFkbWluTGlzdFJlcGx5LCBqc3BiLk1lc3NhZ2UpOwoKaWYgKGdvb2cuREVCVUcgJiYgIUNPTVBJTEVEKSB7CiAgLyoqCiAgICogQHB1YmxpYwogICAqIEBvdmVycmlkZQogICAqLwogIHByb3RvLnBiLmNtcy5BZG1pbkxpc3RSZXBseS5kaXNwbGF5TmFtZSA9ICdwcm90by5wYi5jbXMuQWRtaW5MaXN0UmVwbHknOwp9Ci8qKgogKiBHZW5lcmF0ZWQgYnkgSnNQYkNvZGVHZW5lcmF0b3IuCiAqIEBwYXJhbSB7QXJyYXk9fSBvcHRfZGF0YSBPcHRpb25hbCBpbml0aWFsIGRhdGEgYXJyYXksIHR5cGljYWxseSBmcm9tIGEKICogc2VydmVyIHJlc3BvbnNlLCBvciBjb25zdHJ1Y3RlZCBkaXJlY3RseSBpbiBKYXZhc2NyaXB0LiBUaGUgYXJyYXkgaXMgdXNlZAogKiBpbiBwbGFjZSBhbmQgYmVjb21lcyBwYXJ0IG9mIHRoZSBjb25zdHJ1Y3RlZCBvYmplY3QuIEl0IGlzIG5vdCBjbG9uZWQuCiAqIElmIG5vIGRhdGEgaXMgcHJvdmlkZWQsIHRoZSBjb25zdHJ1Y3RlZCBvYmplY3Qgd2lsbCBiZSBlbXB0eSwgYnV0IHN0aWxsCiAqIHZhbGlkLgogKiBAZXh0ZW5kcyB7anNwYi5NZXNzYWdlfQogKiBAY29uc3RydWN0b3IKICovCgoKcHJvdG8ucGIuY21zLkd1aWxkTGlzdFJlcGx5ID0gZnVuY3Rpb24gKG9wdF9kYXRhKSB7CiAganNwYi5NZXNzYWdlLmluaXRpYWxpemUodGhpcywgb3B0X2RhdGEsIDAsIC0xLCBwcm90by5wYi5jbXMuR3VpbGRMaXN0UmVwbHkucmVwZWF0ZWRGaWVsZHNfLCBudWxsKTsKfTsKCmdvb2cuaW5oZXJpdHMocHJvdG8ucGIuY21zLkd1aWxkTGlzdFJlcGx5LCBqc3BiLk1lc3NhZ2UpOwoKaWYgKGdvb2cuREVCVUcgJiYgIUNPTVBJTEVEKSB7CiAgLyoqCiAgICogQHB1YmxpYwogICAqIEBvdmVycmlkZQogICAqLwogIHByb3RvLnBiLmNtcy5HdWlsZExpc3RSZXBseS5kaXNwbGF5TmFtZSA9ICdwcm90by5wYi5jbXMuR3VpbGRMaXN0UmVwbHknOwp9Ci8qKgogKiBHZW5lcmF0ZWQgYnkgSnNQYkNvZGVHZW5lcmF0b3IuCiAqIEBwYXJhbSB7QXJyYXk9fSBvcHRfZGF0YSBPcHRpb25hbCBpbml0aWFsIGRhdGEgYXJyYXksIHR5cGljYWxseSBmcm9tIGEKICogc2VydmVyIHJlc3BvbnNlLCBvciBjb25zdHJ1Y3RlZCBkaXJlY3RseSBpbiBKYXZhc2NyaXB0LiBUaGUgYXJyYXkgaXMgdXNlZAogKiBpbiBwbGFjZSBhbmQgYmVjb21lcyBwYXJ0IG9mIHRoZSBjb25zdHJ1Y3RlZCBvYmplY3QuIEl0IGlzIG5vdCBjbG9uZWQuCiAqIElmIG5vIGRhdGEgaXMgcHJvdmlkZWQsIHRoZSBjb25zdHJ1Y3RlZCBvYmplY3Qgd2lsbCBiZSBlbXB0eSwgYnV0IHN0aWxsCiAqIHZhbGlkLgogKiBAZXh0ZW5kcyB7anNwYi5NZXNzYWdlfQogKiBAY29uc3RydWN0b3IKICovCgoKcHJvdG8ucGIuY21zLkFwcExpc3RSZXBseSA9IGZ1bmN0aW9uIChvcHRfZGF0YSkgewogIGpzcGIuTWVzc2FnZS5pbml0aWFsaXplKHRoaXMsIG9wdF9kYXRhLCAwLCAtMSwgcHJvdG8ucGIuY21zLkFwcExpc3RSZXBseS5yZXBlYXRlZEZpZWxkc18sIG51bGwpOwp9OwoKZ29vZy5pbmhlcml0cyhwcm90by5wYi5jbXMuQXBwTGlzdFJlcGx5LCBqc3BiLk1lc3NhZ2UpOwoKaWYgKGdvb2cuREVCVUcgJiYgIUNPTVBJTEVEKSB7CiAgLyoqCiAgICogQHB1YmxpYwogICAqIEBvdmVycmlkZQogICAqLwogIHByb3RvLnBiLmNtcy5BcHBMaXN0UmVwbHkuZGlzcGxheU5hbWUgPSAncHJvdG8ucGIuY21zLkFwcExpc3RSZXBseSc7Cn0KLyoqCiAqIEdlbmVyYXRlZCBieSBKc1BiQ29kZUdlbmVyYXRvci4KICogQHBhcmFtIHtBcnJheT19IG9wdF9kYXRhIE9wdGlvbmFsIGluaXRpYWwgZGF0YSBhcnJheSwgdHlwaWNhbGx5IGZyb20gYQogKiBzZXJ2ZXIgcmVzcG9uc2UsIG9yIGNvbnN0cnVjdGVkIGRpcmVjdGx5IGluIEphdmFzY3JpcHQuIFRoZSBhcnJheSBpcyB1c2VkCiAqIGluIHBsYWNlIGFuZCBiZWNvbWVzIHBhcnQgb2YgdGhlIGNvbnN0cnVjdGVkIG9iamVjdC4gSXQgaXMgbm90IGNsb25lZC4KICogSWYgbm8gZGF0YSBpcyBwcm92aWRlZCwgdGhlIGNvbnN0cnVjdGVkIG9iamVjdCB3aWxsIGJlIGVtcHR5LCBidXQgc3RpbGwKICogdmFsaWQuCiAqIEBleHRlbmRzIHtqc3BiLk1lc3NhZ2V9CiAqIEBjb25zdHJ1Y3RvcgogKi8KCgpwcm90by5wYi5jbXMuQW5jaG9yTGlzdFJlcXVlc3QgPSBmdW5jdGlvbiAob3B0X2RhdGEpIHsKICBqc3BiLk1lc3NhZ2UuaW5pdGlhbGl6ZSh0aGlzLCBvcHRfZGF0YSwgMCwgLTEsIG51bGwsIG51bGwpOwp9OwoKZ29vZy5pbmhlcml0cyhwcm90by5wYi5jbXMuQW5jaG9yTGlzdFJlcXVlc3QsIGpzcGIuTWVzc2FnZSk7CgppZiAoZ29vZy5ERUJVRyAmJiAhQ09NUElMRUQpIHsKICAvKioKICAgKiBAcHVibGljCiAgICogQG92ZXJyaWRlCiAgICovCiAgcHJvdG8ucGIuY21zLkFuY2hvckxpc3RSZXF1ZXN0LmRpc3BsYXlOYW1lID0gJ3Byb3RvLnBiLmNtcy5BbmNob3JMaXN0UmVxdWVzdCc7Cn0KLyoqCiAqIEdlbmVyYXRlZCBieSBKc1BiQ29kZUdlbmVyYXRvci4KICogQHBhcmFtIHtBcnJheT19IG9wdF9kYXRhIE9wdGlvbmFsIGluaXRpYWwgZGF0YSBhcnJheSwgdHlwaWNhbGx5IGZyb20gYQogKiBzZXJ2ZXIgcmVzcG9uc2UsIG9yIGNvbnN0cnVjdGVkIGRpcmVjdGx5IGluIEphdmFzY3JpcHQuIFRoZSBhcnJheSBpcyB1c2VkCiAqIGluIHBsYWNlIGFuZCBiZWNvbWVzIHBhcnQgb2YgdGhlIGNvbnN0cnVjdGVkIG9iamVjdC4gSXQgaXMgbm90IGNsb25lZC4KICogSWYgbm8gZGF0YSBpcyBwcm92aWRlZCwgdGhlIGNvbnN0cnVjdGVkIG9iamVjdCB3aWxsIGJlIGVtcHR5LCBidXQgc3RpbGwKICogdmFsaWQuCiAqIEBleHRlbmRzIHtqc3BiLk1lc3NhZ2V9CiAqIEBjb25zdHJ1Y3RvcgogKi8KCgpwcm90by5wYi5jbXMuQW5jaG9yTGlzdFJlcGx5ID0gZnVuY3Rpb24gKG9wdF9kYXRhKSB7CiAganNwYi5NZXNzYWdlLmluaXRpYWxpemUodGhpcywgb3B0X2RhdGEsIDAsIC0xLCBwcm90by5wYi5jbXMuQW5jaG9yTGlzdFJlcGx5LnJlcGVhdGVkRmllbGRzXywgbnVsbCk7Cn07Cgpnb29nLmluaGVyaXRzKHByb3RvLnBiLmNtcy5BbmNob3JMaXN0UmVwbHksIGpzcGIuTWVzc2FnZSk7CgppZiAoZ29vZy5ERUJVRyAmJiAhQ09NUElMRUQpIHsKICAvKioKICAgKiBAcHVibGljCiAgICogQG92ZXJyaWRlCiAgICovCiAgcHJvdG8ucGIuY21zLkFuY2hvckxpc3RSZXBseS5kaXNwbGF5TmFtZSA9ICdwcm90by5wYi5jbXMuQW5jaG9yTGlzdFJlcGx5JzsKfQovKioKICogR2VuZXJhdGVkIGJ5IEpzUGJDb2RlR2VuZXJhdG9yLgogKiBAcGFyYW0ge0FycmF5PX0gb3B0X2RhdGEgT3B0aW9uYWwgaW5pdGlhbCBkYXRhIGFycmF5LCB0eXBpY2FsbHkgZnJvbSBhCiAqIHNlcnZlciByZXNwb25zZSwgb3IgY29uc3RydWN0ZWQgZGlyZWN0bHkgaW4gSmF2YXNjcmlwdC4gVGhlIGFycmF5IGlzIHVzZWQKICogaW4gcGxhY2UgYW5kIGJlY29tZXMgcGFydCBvZiB0aGUgY29uc3RydWN0ZWQgb2JqZWN0LiBJdCBpcyBub3QgY2xvbmVkLgogKiBJZiBubyBkYXRhIGlzIHByb3ZpZGVkLCB0aGUgY29uc3RydWN0ZWQgb2JqZWN0IHdpbGwgYmUgZW1wdHksIGJ1dCBzdGlsbAogKiB2YWxpZC4KICogQGV4dGVuZHMge2pzcGIuTWVzc2FnZX0KICogQGNvbnN0cnVjdG9yCiAqLwoKCnByb3RvLnBiLmNtcy5Vc2VyTGlzdFJlcXVlc3QgPSBmdW5jdGlvbiAob3B0X2RhdGEpIHsKICBqc3BiLk1lc3NhZ2UuaW5pdGlhbGl6ZSh0aGlzLCBvcHRfZGF0YSwgMCwgLTEsIG51bGwsIG51bGwpOwp9OwoKZ29vZy5pbmhlcml0cyhwcm90by5wYi5jbXMuVXNlckxpc3RSZXF1ZXN0LCBqc3BiLk1lc3NhZ2UpOwoKaWYgKGdvb2cuREVCVUcgJiYgIUNPTVBJTEVEKSB7CiAgLyoqCiAgICogQHB1YmxpYwogICAqIEBvdmVycmlkZQogICAqLwogIHByb3RvLnBiLmNtcy5Vc2VyTGlzdFJlcXVlc3QuZGlzcGxheU5hbWUgPSAncHJvdG8ucGIuY21zLlVzZXJMaXN0UmVxdWVzdCc7Cn0KLyoqCiAqIEdlbmVyYXRlZCBieSBKc1BiQ29kZUdlbmVyYXRvci4KICogQHBhcmFtIHtBcnJheT19IG9wdF9kYXRhIE9wdGlvbmFsIGluaXRpYWwgZGF0YSBhcnJheSwgdHlwaWNhbGx5IGZyb20gYQogKiBzZXJ2ZXIgcmVzcG9uc2UsIG9yIGNvbnN0cnVjdGVkIGRpcmVjdGx5IGluIEphdmFzY3JpcHQuIFRoZSBhcnJheSBpcyB1c2VkCiAqIGluIHBsYWNlIGFuZCBiZWNvbWVzIHBhcnQgb2YgdGhlIGNvbnN0cnVjdGVkIG9iamVjdC4gSXQgaXMgbm90IGNsb25lZC4KICogSWYgbm8gZGF0YSBpcyBwcm92aWRlZCwgdGhlIGNvbnN0cnVjdGVkIG9iamVjdCB3aWxsIGJlIGVtcHR5LCBidXQgc3RpbGwKICogdmFsaWQuCiAqIEBleHRlbmRzIHtqc3BiLk1lc3NhZ2V9CiAqIEBjb25zdHJ1Y3RvcgogKi8KCgpwcm90by5wYi5jbXMuVXNlckxpc3RSZXBseSA9IGZ1bmN0aW9uIChvcHRfZGF0YSkgewogIGpzcGIuTWVzc2FnZS5pbml0aWFsaXplKHRoaXMsIG9wdF9kYXRhLCAwLCAtMSwgcHJvdG8ucGIuY21zLlVzZXJMaXN0UmVwbHkucmVwZWF0ZWRGaWVsZHNfLCBudWxsKTsKfTsKCmdvb2cuaW5oZXJpdHMocHJvdG8ucGIuY21zLlVzZXJMaXN0UmVwbHksIGpzcGIuTWVzc2FnZSk7CgppZiAoZ29vZy5ERUJVRyAmJiAhQ09NUElMRUQpIHsKICAvKioKICAgKiBAcHVibGljCiAgICogQG92ZXJyaWRlCiAgICovCiAgcHJvdG8ucGIuY21zLlVzZXJMaXN0UmVwbHkuZGlzcGxheU5hbWUgPSAncHJvdG8ucGIuY21zLlVzZXJMaXN0UmVwbHknOwp9Ci8qKgogKiBHZW5lcmF0ZWQgYnkgSnNQYkNvZGVHZW5lcmF0b3IuCiAqIEBwYXJhbSB7QXJyYXk9fSBvcHRfZGF0YSBPcHRpb25hbCBpbml0aWFsIGRhdGEgYXJyYXksIHR5cGljYWxseSBmcm9tIGEKICogc2VydmVyIHJlc3BvbnNlLCBvciBjb25zdHJ1Y3RlZCBkaXJlY3RseSBpbiBKYXZhc2NyaXB0LiBUaGUgYXJyYXkgaXMgdXNlZAogKiBpbiBwbGFjZSBhbmQgYmVjb21lcyBwYXJ0IG9mIHRoZSBjb25zdHJ1Y3RlZCBvYmplY3QuIEl0IGlzIG5vdCBjbG9uZWQuCiAqIElmIG5vIGRhdGEgaXMgcHJvdmlkZWQsIHRoZSBjb25zdHJ1Y3RlZCBvYmplY3Qgd2lsbCBiZSBlbXB0eSwgYnV0IHN0aWxsCiAqIHZhbGlkLgogKiBAZXh0ZW5kcyB7anNwYi5NZXNzYWdlfQogKiBAY29uc3RydWN0b3IKICovCgoKcHJvdG8ucGIuY21zLkFkanVzdEJhbGFuY2VSZXF1ZXN0ID0gZnVuY3Rpb24gKG9wdF9kYXRhKSB7CiAganNwYi5NZXNzYWdlLmluaXRpYWxpemUodGhpcywgb3B0X2RhdGEsIDAsIC0xLCBudWxsLCBudWxsKTsKfTsKCmdvb2cuaW5oZXJpdHMocHJvdG8ucGIuY21zLkFkanVzdEJhbGFuY2VSZXF1ZXN0LCBqc3BiLk1lc3NhZ2UpOwoKaWYgKGdvb2cuREVCVUcgJiYgIUNPTVBJTEVEKSB7CiAgLyoqCiAgICogQHB1YmxpYwogICAqIEBvdmVycmlkZQogICAqLwogIHByb3RvLnBiLmNtcy5BZGp1c3RCYWxhbmNlUmVxdWVzdC5kaXNwbGF5TmFtZSA9ICdwcm90by5wYi5jbXMuQWRqdXN0QmFsYW5jZVJlcXVlc3QnOwp9Ci8qKgogKiBHZW5lcmF0ZWQgYnkgSnNQYkNvZGVHZW5lcmF0b3IuCiAqIEBwYXJhbSB7QXJyYXk9fSBvcHRfZGF0YSBPcHRpb25hbCBpbml0aWFsIGRhdGEgYXJyYXksIHR5cGljYWxseSBmcm9tIGEKICogc2VydmVyIHJlc3BvbnNlLCBvciBjb25zdHJ1Y3RlZCBkaXJlY3RseSBpbiBKYXZhc2NyaXB0LiBUaGUgYXJyYXkgaXMgdXNlZAogKiBpbiBwbGFjZSBhbmQgYmVjb21lcyBwYXJ0IG9mIHRoZSBjb25zdHJ1Y3RlZCBvYmplY3QuIEl0IGlzIG5vdCBjbG9uZWQuCiAqIElmIG5vIGRhdGEgaXMgcHJvdmlkZWQsIHRoZSBjb25zdHJ1Y3RlZCBvYmplY3Qgd2lsbCBiZSBlbXB0eSwgYnV0IHN0aWxsCiAqIHZhbGlkLgogKiBAZXh0ZW5kcyB7anNwYi5NZXNzYWdlfQogKiBAY29uc3RydWN0b3IKICovCgoKcHJvdG8ucGIuY21zLkFkanVzdEJhbGFuY2VSZXBseSA9IGZ1bmN0aW9uIChvcHRfZGF0YSkgewogIGpzcGIuTWVzc2FnZS5pbml0aWFsaXplKHRoaXMsIG9wdF9kYXRhLCAwLCAtMSwgbnVsbCwgbnVsbCk7Cn07Cgpnb29nLmluaGVyaXRzKHByb3RvLnBiLmNtcy5BZGp1c3RCYWxhbmNlUmVwbHksIGpzcGIuTWVzc2FnZSk7CgppZiAoZ29vZy5ERUJVRyAmJiAhQ09NUElMRUQpIHsKICAvKioKICAgKiBAcHVibGljCiAgICogQG92ZXJyaWRlCiAgICovCiAgcHJvdG8ucGIuY21zLkFkanVzdEJhbGFuY2VSZXBseS5kaXNwbGF5TmFtZSA9ICdwcm90by5wYi5jbXMuQWRqdXN0QmFsYW5jZVJlcGx5JzsKfQovKioKICogR2VuZXJhdGVkIGJ5IEpzUGJDb2RlR2VuZXJhdG9yLgogKiBAcGFyYW0ge0FycmF5PX0gb3B0X2RhdGEgT3B0aW9uYWwgaW5pdGlhbCBkYXRhIGFycmF5LCB0eXBpY2FsbHkgZnJvbSBhCiAqIHNlcnZlciByZXNwb25zZSwgb3IgY29uc3RydWN0ZWQgZGlyZWN0bHkgaW4gSmF2YXNjcmlwdC4gVGhlIGFycmF5IGlzIHVzZWQKICogaW4gcGxhY2UgYW5kIGJlY29tZXMgcGFydCBvZiB0aGUgY29uc3RydWN0ZWQgb2JqZWN0LiBJdCBpcyBub3QgY2xvbmVkLgogKiBJZiBubyBkYXRhIGlzIHByb3ZpZGVkLCB0aGUgY29uc3RydWN0ZWQgb2JqZWN0IHdpbGwgYmUgZW1wdHksIGJ1dCBzdGlsbAogKiB2YWxpZC4KICogQGV4dGVuZHMge2pzcGIuTWVzc2FnZX0KICogQGNvbnN0cnVjdG9yCiAqLwoKCnByb3RvLnBiLmNtcy5CbG9ja1JlcXVlc3QgPSBmdW5jdGlvbiAob3B0X2RhdGEpIHsKICBqc3BiLk1lc3NhZ2UuaW5pdGlhbGl6ZSh0aGlzLCBvcHRfZGF0YSwgMCwgLTEsIG51bGwsIG51bGwpOwp9OwoKZ29vZy5pbmhlcml0cyhwcm90by5wYi5jbXMuQmxvY2tSZXF1ZXN0LCBqc3BiLk1lc3NhZ2UpOwoKaWYgKGdvb2cuREVCVUcgJiYgIUNPTVBJTEVEKSB7CiAgLyoqCiAgICogQHB1YmxpYwogICAqIEBvdmVycmlkZQogICAqLwogIHByb3RvLnBiLmNtcy5CbG9ja1JlcXVlc3QuZGlzcGxheU5hbWUgPSAncHJvdG8ucGIuY21zLkJsb2NrUmVxdWVzdCc7Cn0KLyoqCiAqIEdlbmVyYXRlZCBieSBKc1BiQ29kZUdlbmVyYXRvci4KICogQHBhcmFtIHtBcnJheT19IG9wdF9kYXRhIE9wdGlvbmFsIGluaXRpYWwgZGF0YSBhcnJheSwgdHlwaWNhbGx5IGZyb20gYQogKiBzZXJ2ZXIgcmVzcG9uc2UsIG9yIGNvbnN0cnVjdGVkIGRpcmVjdGx5IGluIEphdmFzY3JpcHQuIFRoZSBhcnJheSBpcyB1c2VkCiAqIGluIHBsYWNlIGFuZCBiZWNvbWVzIHBhcnQgb2YgdGhlIGNvbnN0cnVjdGVkIG9iamVjdC4gSXQgaXMgbm90IGNsb25lZC4KICogSWYgbm8gZGF0YSBpcyBwcm92aWRlZCwgdGhlIGNvbnN0cnVjdGVkIG9iamVjdCB3aWxsIGJlIGVtcHR5LCBidXQgc3RpbGwKICogdmFsaWQuCiAqIEBleHRlbmRzIHtqc3BiLk1lc3NhZ2V9CiAqIEBjb25zdHJ1Y3RvcgogKi8KCgpwcm90by5wYi5jbXMuVW5ibG9ja1JlcXVlc3QgPSBmdW5jdGlvbiAob3B0X2RhdGEpIHsKICBqc3BiLk1lc3NhZ2UuaW5pdGlhbGl6ZSh0aGlzLCBvcHRfZGF0YSwgMCwgLTEsIG51bGwsIG51bGwpOwp9OwoKZ29vZy5pbmhlcml0cyhwcm90by5wYi5jbXMuVW5ibG9ja1JlcXVlc3QsIGpzcGIuTWVzc2FnZSk7CgppZiAoZ29vZy5ERUJVRyAmJiAhQ09NUElMRUQpIHsKICAvKioKICAgKiBAcHVibGljCiAgICogQG92ZXJyaWRlCiAgICovCiAgcHJvdG8ucGIuY21zLlVuYmxvY2tSZXF1ZXN0LmRpc3BsYXlOYW1lID0gJ3Byb3RvLnBiLmNtcy5VbmJsb2NrUmVxdWVzdCc7Cn0KLyoqCiAqIEdlbmVyYXRlZCBieSBKc1BiQ29kZUdlbmVyYXRvci4KICogQHBhcmFtIHtBcnJheT19IG9wdF9kYXRhIE9wdGlvbmFsIGluaXRpYWwgZGF0YSBhcnJheSwgdHlwaWNhbGx5IGZyb20gYQogKiBzZXJ2ZXIgcmVzcG9uc2UsIG9yIGNvbnN0cnVjdGVkIGRpcmVjdGx5IGluIEphdmFzY3JpcHQuIFRoZSBhcnJheSBpcyB1c2VkCiAqIGluIHBsYWNlIGFuZCBiZWNvbWVzIHBhcnQgb2YgdGhlIGNvbnN0cnVjdGVkIG9iamVjdC4gSXQgaXMgbm90IGNsb25lZC4KICogSWYgbm8gZGF0YSBpcyBwcm92aWRlZCwgdGhlIGNvbnN0cnVjdGVkIG9iamVjdCB3aWxsIGJlIGVtcHR5LCBidXQgc3RpbGwKICogdmFsaWQuCiAqIEBleHRlbmRzIHtqc3BiLk1lc3NhZ2V9CiAqIEBjb25zdHJ1Y3RvcgogKi8KCgpwcm90by5wYi5jbXMuTWlncmF0ZVJlcXVlc3QgPSBmdW5jdGlvbiAob3B0X2RhdGEpIHsKICBqc3BiLk1lc3NhZ2UuaW5pdGlhbGl6ZSh0aGlzLCBvcHRfZGF0YSwgMCwgLTEsIG51bGwsIG51bGwpOwp9OwoKZ29vZy5pbmhlcml0cyhwcm90by5wYi5jbXMuTWlncmF0ZVJlcXVlc3QsIGpzcGIuTWVzc2FnZSk7CgppZiAoZ29vZy5ERUJVRyAmJiAhQ09NUElMRUQpIHsKICAvKioKICAgKiBAcHVibGljCiAgICogQG92ZXJyaWRlCiAgICovCiAgcHJvdG8ucGIuY21zLk1pZ3JhdGVSZXF1ZXN0LmRpc3BsYXlOYW1lID0gJ3Byb3RvLnBiLmNtcy5NaWdyYXRlUmVxdWVzdCc7Cn0KLyoqCiAqIEdlbmVyYXRlZCBieSBKc1BiQ29kZUdlbmVyYXRvci4KICogQHBhcmFtIHtBcnJheT19IG9wdF9kYXRhIE9wdGlvbmFsIGluaXRpYWwgZGF0YSBhcnJheSwgdHlwaWNhbGx5IGZyb20gYQogKiBzZXJ2ZXIgcmVzcG9uc2UsIG9yIGNvbnN0cnVjdGVkIGRpcmVjdGx5IGluIEphdmFzY3JpcHQuIFRoZSBhcnJheSBpcyB1c2VkCiAqIGluIHBsYWNlIGFuZCBiZWNvbWVzIHBhcnQgb2YgdGhlIGNvbnN0cnVjdGVkIG9iamVjdC4gSXQgaXMgbm90IGNsb25lZC4KICogSWYgbm8gZGF0YSBpcyBwcm92aWRlZCwgdGhlIGNvbnN0cnVjdGVkIG9iamVjdCB3aWxsIGJlIGVtcHR5LCBidXQgc3RpbGwKICogdmFsaWQuCiAqIEBleHRlbmRzIHtqc3BiLk1lc3NhZ2V9CiAqIEBjb25zdHJ1Y3RvcgogKi8KCgpwcm90by5wYi5jbXMuQXV0aG9yaXplQW5jaG9yUmVxdWVzdCA9IGZ1bmN0aW9uIChvcHRfZGF0YSkgewogIGpzcGIuTWVzc2FnZS5pbml0aWFsaXplKHRoaXMsIG9wdF9kYXRhLCAwLCAtMSwgbnVsbCwgbnVsbCk7Cn07Cgpnb29nLmluaGVyaXRzKHByb3RvLnBiLmNtcy5BdXRob3JpemVBbmNob3JSZXF1ZXN0LCBqc3BiLk1lc3NhZ2UpOwoKaWYgKGdvb2cuREVCVUcgJiYgIUNPTVBJTEVEKSB7CiAgLyoqCiAgICogQHB1YmxpYwogICAqIEBvdmVycmlkZQogICAqLwogIHByb3RvLnBiLmNtcy5BdXRob3JpemVBbmNob3JSZXF1ZXN0LmRpc3BsYXlOYW1lID0gJ3Byb3RvLnBiLmNtcy5BdXRob3JpemVBbmNob3JSZXF1ZXN0JzsKfQovKioKICogR2VuZXJhdGVkIGJ5IEpzUGJDb2RlR2VuZXJhdG9yLgogKiBAcGFyYW0ge0FycmF5PX0gb3B0X2RhdGEgT3B0aW9uYWwgaW5pdGlhbCBkYXRhIGFycmF5LCB0eXBpY2FsbHkgZnJvbSBhCiAqIHNlcnZlciByZXNwb25zZSwgb3IgY29uc3RydWN0ZWQgZGlyZWN0bHkgaW4gSmF2YXNjcmlwdC4gVGhlIGFycmF5IGlzIHVzZWQKICogaW4gcGxhY2UgYW5kIGJlY29tZXMgcGFydCBvZiB0aGUgY29uc3RydWN0ZWQgb2JqZWN0LiBJdCBpcyBub3QgY2xvbmVkLgogKiBJZiBubyBkYXRhIGlzIHByb3ZpZGVkLCB0aGUgY29uc3RydWN0ZWQgb2JqZWN0IHdpbGwgYmUgZW1wdHksIGJ1dCBzdGlsbAogKiB2YWxpZC4KICogQGV4dGVuZHMge2pzcGIuTWVzc2FnZX0KICogQGNvbnN0cnVjdG9yCiAqLwoKCnByb3RvLnBiLmNtcy5BbmNob3JGdWxsUmVxdWVzdCA9IGZ1bmN0aW9uIChvcHRfZGF0YSkgewogIGpzcGIuTWVzc2FnZS5pbml0aWFsaXplKHRoaXMsIG9wdF9kYXRhLCAwLCAtMSwgbnVsbCwgbnVsbCk7Cn07Cgpnb29nLmluaGVyaXRzKHByb3RvLnBiLmNtcy5BbmNob3JGdWxsUmVxdWVzdCwganNwYi5NZXNzYWdlKTsKCmlmIChnb29nLkRFQlVHICYmICFDT01QSUxFRCkgewogIC8qKgogICAqIEBwdWJsaWMKICAgKiBAb3ZlcnJpZGUKICAgKi8KICBwcm90by5wYi5jbXMuQW5jaG9yRnVsbFJlcXVlc3QuZGlzcGxheU5hbWUgPSAncHJvdG8ucGIuY21zLkFuY2hvckZ1bGxSZXF1ZXN0JzsKfQovKioKICogR2VuZXJhdGVkIGJ5IEpzUGJDb2RlR2VuZXJhdG9yLgogKiBAcGFyYW0ge0FycmF5PX0gb3B0X2RhdGEgT3B0aW9uYWwgaW5pdGlhbCBkYXRhIGFycmF5LCB0eXBpY2FsbHkgZnJvbSBhCiAqIHNlcnZlciByZXNwb25zZSwgb3IgY29uc3RydWN0ZWQgZGlyZWN0bHkgaW4gSmF2YXNjcmlwdC4gVGhlIGFycmF5IGlzIHVzZWQKICogaW4gcGxhY2UgYW5kIGJlY29tZXMgcGFydCBvZiB0aGUgY29uc3RydWN0ZWQgb2JqZWN0LiBJdCBpcyBub3QgY2xvbmVkLgogKiBJZiBubyBkYXRhIGlzIHByb3ZpZGVkLCB0aGUgY29uc3RydWN0ZWQgb2JqZWN0IHdpbGwgYmUgZW1wdHksIGJ1dCBzdGlsbAogKiB2YWxpZC4KICogQGV4dGVuZHMge2pzcGIuTWVzc2FnZX0KICogQGNvbnN0cnVjdG9yCiAqLwoKCnByb3RvLnBiLmNtcy5BbmNob3JGdWxsUmVwbHkgPSBmdW5jdGlvbiAob3B0X2RhdGEpIHsKICBqc3BiLk1lc3NhZ2UuaW5pdGlhbGl6ZSh0aGlzLCBvcHRfZGF0YSwgMCwgLTEsIHByb3RvLnBiLmNtcy5BbmNob3JGdWxsUmVwbHkucmVwZWF0ZWRGaWVsZHNfLCBudWxsKTsKfTsKCmdvb2cuaW5oZXJpdHMocHJvdG8ucGIuY21zLkFuY2hvckZ1bGxSZXBseSwganNwYi5NZXNzYWdlKTsKCmlmIChnb29nLkRFQlVHICYmICFDT01QSUxFRCkgewogIC8qKgogICAqIEBwdWJsaWMKICAgKiBAb3ZlcnJpZGUKICAgKi8KICBwcm90by5wYi5jbXMuQW5jaG9yRnVsbFJlcGx5LmRpc3BsYXlOYW1lID0gJ3Byb3RvLnBiLmNtcy5BbmNob3JGdWxsUmVwbHknOwp9Ci8qKgogKiBHZW5lcmF0ZWQgYnkgSnNQYkNvZGVHZW5lcmF0b3IuCiAqIEBwYXJhbSB7QXJyYXk9fSBvcHRfZGF0YSBPcHRpb25hbCBpbml0aWFsIGRhdGEgYXJyYXksIHR5cGljYWxseSBmcm9tIGEKICogc2VydmVyIHJlc3BvbnNlLCBvciBjb25zdHJ1Y3RlZCBkaXJlY3RseSBpbiBKYXZhc2NyaXB0LiBUaGUgYXJyYXkgaXMgdXNlZAogKiBpbiBwbGFjZSBhbmQgYmVjb21lcyBwYXJ0IG9mIHRoZSBjb25zdHJ1Y3RlZCBvYmplY3QuIEl0IGlzIG5vdCBjbG9uZWQuCiAqIElmIG5vIGRhdGEgaXMgcHJvdmlkZWQsIHRoZSBjb25zdHJ1Y3RlZCBvYmplY3Qgd2lsbCBiZSBlbXB0eSwgYnV0IHN0aWxsCiAqIHZhbGlkLgogKiBAZXh0ZW5kcyB7anNwYi5NZXNzYWdlfQogKiBAY29uc3RydWN0b3IKICovCgoKcHJvdG8ucGIuY21zLlByb2ZpbGVMaXN0UmVxdWVzdCA9IGZ1bmN0aW9uIChvcHRfZGF0YSkgewogIGpzcGIuTWVzc2FnZS5pbml0aWFsaXplKHRoaXMsIG9wdF9kYXRhLCAwLCAtMSwgbnVsbCwgbnVsbCk7Cn07Cgpnb29nLmluaGVyaXRzKHByb3RvLnBiLmNtcy5Qcm9maWxlTGlzdFJlcXVlc3QsIGpzcGIuTWVzc2FnZSk7CgppZiAoZ29vZy5ERUJVRyAmJiAhQ09NUElMRUQpIHsKICAvKioKICAgKiBAcHVibGljCiAgICogQG92ZXJyaWRlCiAgICovCiAgcHJvdG8ucGIuY21zLlByb2ZpbGVMaXN0UmVxdWVzdC5kaXNwbGF5TmFtZSA9ICdwcm90by5wYi5jbXMuUHJvZmlsZUxpc3RSZXF1ZXN0JzsKfQovKioKICogR2VuZXJhdGVkIGJ5IEpzUGJDb2RlR2VuZXJhdG9yLgogKiBAcGFyYW0ge0FycmF5PX0gb3B0X2RhdGEgT3B0aW9uYWwgaW5pdGlhbCBkYXRhIGFycmF5LCB0eXBpY2FsbHkgZnJvbSBhCiAqIHNlcnZlciByZXNwb25zZSwgb3IgY29uc3RydWN0ZWQgZGlyZWN0bHkgaW4gSmF2YXNjcmlwdC4gVGhlIGFycmF5IGlzIHVzZWQKICogaW4gcGxhY2UgYW5kIGJlY29tZXMgcGFydCBvZiB0aGUgY29uc3RydWN0ZWQgb2JqZWN0LiBJdCBpcyBub3QgY2xvbmVkLgogKiBJZiBubyBkYXRhIGlzIHByb3ZpZGVkLCB0aGUgY29uc3RydWN0ZWQgb2JqZWN0IHdpbGwgYmUgZW1wdHksIGJ1dCBzdGlsbAogKiB2YWxpZC4KICogQGV4dGVuZHMge2pzcGIuTWVzc2FnZX0KICogQGNvbnN0cnVjdG9yCiAqLwoKCnByb3RvLnBiLmNtcy5Qcm9maWxlTGlzdFJlcGx5ID0gZnVuY3Rpb24gKG9wdF9kYXRhKSB7CiAganNwYi5NZXNzYWdlLmluaXRpYWxpemUodGhpcywgb3B0X2RhdGEsIDAsIC0xLCBwcm90by5wYi5jbXMuUHJvZmlsZUxpc3RSZXBseS5yZXBlYXRlZEZpZWxkc18sIG51bGwpOwp9OwoKZ29vZy5pbmhlcml0cyhwcm90by5wYi5jbXMuUHJvZmlsZUxpc3RSZXBseSwganNwYi5NZXNzYWdlKTsKCmlmIChnb29nLkRFQlVHICYmICFDT01QSUxFRCkgewogIC8qKgogICAqIEBwdWJsaWMKICAgKiBAb3ZlcnJpZGUKICAgKi8KICBwcm90by5wYi5jbXMuUHJvZmlsZUxpc3RSZXBseS5kaXNwbGF5TmFtZSA9ICdwcm90by5wYi5jbXMuUHJvZmlsZUxpc3RSZXBseSc7Cn0KLyoqCiAqIEdlbmVyYXRlZCBieSBKc1BiQ29kZUdlbmVyYXRvci4KICogQHBhcmFtIHtBcnJheT19IG9wdF9kYXRhIE9wdGlvbmFsIGluaXRpYWwgZGF0YSBhcnJheSwgdHlwaWNhbGx5IGZyb20gYQogKiBzZXJ2ZXIgcmVzcG9uc2UsIG9yIGNvbnN0cnVjdGVkIGRpcmVjdGx5IGluIEphdmFzY3JpcHQuIFRoZSBhcnJheSBpcyB1c2VkCiAqIGluIHBsYWNlIGFuZCBiZWNvbWVzIHBhcnQgb2YgdGhlIGNvbnN0cnVjdGVkIG9iamVjdC4gSXQgaXMgbm90IGNsb25lZC4KICogSWYgbm8gZGF0YSBpcyBwcm92aWRlZCwgdGhlIGNvbnN0cnVjdGVkIG9iamVjdCB3aWxsIGJlIGVtcHR5LCBidXQgc3RpbGwKICogdmFsaWQuCiAqIEBleHRlbmRzIHtqc3BiLk1lc3NhZ2V9CiAqIEBjb25zdHJ1Y3RvcgogKi8KCgpwcm90by5wYi5jbXMuUHJvY2Vzc1Byb2ZpbGVSZXF1ZXN0ID0gZnVuY3Rpb24gKG9wdF9kYXRhKSB7CiAganNwYi5NZXNzYWdlLmluaXRpYWxpemUodGhpcywgb3B0X2RhdGEsIDAsIC0xLCBudWxsLCBudWxsKTsKfTsKCmdvb2cuaW5oZXJpdHMocHJvdG8ucGIuY21zLlByb2Nlc3NQcm9maWxlUmVxdWVzdCwganNwYi5NZXNzYWdlKTsKCmlmIChnb29nLkRFQlVHICYmICFDT01QSUxFRCkgewogIC8qKgogICAqIEBwdWJsaWMKICAgKiBAb3ZlcnJpZGUKICAgKi8KICBwcm90by5wYi5jbXMuUHJvY2Vzc1Byb2ZpbGVSZXF1ZXN0LmRpc3BsYXlOYW1lID0gJ3Byb3RvLnBiLmNtcy5Qcm9jZXNzUHJvZmlsZVJlcXVlc3QnOwp9Ci8qKgogKiBHZW5lcmF0ZWQgYnkgSnNQYkNvZGVHZW5lcmF0b3IuCiAqIEBwYXJhbSB7QXJyYXk9fSBvcHRfZGF0YSBPcHRpb25hbCBpbml0aWFsIGRhdGEgYXJyYXksIHR5cGljYWxseSBmcm9tIGEKICogc2VydmVyIHJlc3BvbnNlLCBvciBjb25zdHJ1Y3RlZCBkaXJlY3RseSBpbiBKYXZhc2NyaXB0LiBUaGUgYXJyYXkgaXMgdXNlZAogKiBpbiBwbGFjZSBhbmQgYmVjb21lcyBwYXJ0IG9mIHRoZSBjb25zdHJ1Y3RlZCBvYmplY3QuIEl0IGlzIG5vdCBjbG9uZWQuCiAqIElmIG5vIGRhdGEgaXMgcHJvdmlkZWQsIHRoZSBjb25zdHJ1Y3RlZCBvYmplY3Qgd2lsbCBiZSBlbXB0eSwgYnV0IHN0aWxsCiAqIHZhbGlkLgogKiBAZXh0ZW5kcyB7anNwYi5NZXNzYWdlfQogKiBAY29uc3RydWN0b3IKICovCgoKcHJvdG8ucGIuY21zLlZpb2xhdGlvbkxpc3RSZXF1ZXN0ID0gZnVuY3Rpb24gKG9wdF9kYXRhKSB7CiAganNwYi5NZXNzYWdlLmluaXRpYWxpemUodGhpcywgb3B0X2RhdGEsIDAsIC0xLCBwcm90by5wYi5jbXMuVmlvbGF0aW9uTGlzdFJlcXVlc3QucmVwZWF0ZWRGaWVsZHNfLCBudWxsKTsKfTsKCmdvb2cuaW5oZXJpdHMocHJvdG8ucGIuY21zLlZpb2xhdGlvbkxpc3RSZXF1ZXN0LCBqc3BiLk1lc3NhZ2UpOwoKaWYgKGdvb2cuREVCVUcgJiYgIUNPTVBJTEVEKSB7CiAgLyoqCiAgICogQHB1YmxpYwogICAqIEBvdmVycmlkZQogICAqLwogIHByb3RvLnBiLmNtcy5WaW9sYXRpb25MaXN0UmVxdWVzdC5kaXNwbGF5TmFtZSA9ICdwcm90by5wYi5jbXMuVmlvbGF0aW9uTGlzdFJlcXVlc3QnOwp9Ci8qKgogKiBHZW5lcmF0ZWQgYnkgSnNQYkNvZGVHZW5lcmF0b3IuCiAqIEBwYXJhbSB7QXJyYXk9fSBvcHRfZGF0YSBPcHRpb25hbCBpbml0aWFsIGRhdGEgYXJyYXksIHR5cGljYWxseSBmcm9tIGEKICogc2VydmVyIHJlc3BvbnNlLCBvciBjb25zdHJ1Y3RlZCBkaXJlY3RseSBpbiBKYXZhc2NyaXB0LiBUaGUgYXJyYXkgaXMgdXNlZAogKiBpbiBwbGFjZSBhbmQgYmVjb21lcyBwYXJ0IG9mIHRoZSBjb25zdHJ1Y3RlZCBvYmplY3QuIEl0IGlzIG5vdCBjbG9uZWQuCiAqIElmIG5vIGRhdGEgaXMgcHJvdmlkZWQsIHRoZSBjb25zdHJ1Y3RlZCBvYmplY3Qgd2lsbCBiZSBlbXB0eSwgYnV0IHN0aWxsCiAqIHZhbGlkLgogKiBAZXh0ZW5kcyB7anNwYi5NZXNzYWdlfQogKiBAY29uc3RydWN0b3IKICovCgoKcHJvdG8ucGIuY21zLlZpb2xhdGlvbkxpc3RSZXBseSA9IGZ1bmN0aW9uIChvcHRfZGF0YSkgewogIGpzcGIuTWVzc2FnZS5pbml0aWFsaXplKHRoaXMsIG9wdF9kYXRhLCAwLCAtMSwgcHJvdG8ucGIuY21zLlZpb2xhdGlvbkxpc3RSZXBseS5yZXBlYXRlZEZpZWxkc18sIG51bGwpOwp9OwoKZ29vZy5pbmhlcml0cyhwcm90by5wYi5jbXMuVmlvbGF0aW9uTGlzdFJlcGx5LCBqc3BiLk1lc3NhZ2UpOwoKaWYgKGdvb2cuREVCVUcgJiYgIUNPTVBJTEVEKSB7CiAgLyoqCiAgICogQHB1YmxpYwogICAqIEBvdmVycmlkZQogICAqLwogIHByb3RvLnBiLmNtcy5WaW9sYXRpb25MaXN0UmVwbHkuZGlzcGxheU5hbWUgPSAncHJvdG8ucGIuY21zLlZpb2xhdGlvbkxpc3RSZXBseSc7Cn0KLyoqCiAqIEdlbmVyYXRlZCBieSBKc1BiQ29kZUdlbmVyYXRvci4KICogQHBhcmFtIHtBcnJheT19IG9wdF9kYXRhIE9wdGlvbmFsIGluaXRpYWwgZGF0YSBhcnJheSwgdHlwaWNhbGx5IGZyb20gYQogKiBzZXJ2ZXIgcmVzcG9uc2UsIG9yIGNvbnN0cnVjdGVkIGRpcmVjdGx5IGluIEphdmFzY3JpcHQuIFRoZSBhcnJheSBpcyB1c2VkCiAqIGluIHBsYWNlIGFuZCBiZWNvbWVzIHBhcnQgb2YgdGhlIGNvbnN0cnVjdGVkIG9iamVjdC4gSXQgaXMgbm90IGNsb25lZC4KICogSWYgbm8gZGF0YSBpcyBwcm92aWRlZCwgdGhlIGNvbnN0cnVjdGVkIG9iamVjdCB3aWxsIGJlIGVtcHR5LCBidXQgc3RpbGwKICogdmFsaWQuCiAqIEBleHRlbmRzIHtqc3BiLk1lc3NhZ2V9CiAqIEBjb25zdHJ1Y3RvcgogKi8KCgpwcm90by5wYi5jbXMuUHJvY2Vzc1Zpb2xhdGlvblJlcXVlc3QgPSBmdW5jdGlvbiAob3B0X2RhdGEpIHsKICBqc3BiLk1lc3NhZ2UuaW5pdGlhbGl6ZSh0aGlzLCBvcHRfZGF0YSwgMCwgLTEsIG51bGwsIG51bGwpOwp9OwoKZ29vZy5pbmhlcml0cyhwcm90by5wYi5jbXMuUHJvY2Vzc1Zpb2xhdGlvblJlcXVlc3QsIGpzcGIuTWVzc2FnZSk7CgppZiAoZ29vZy5ERUJVRyAmJiAhQ09NUElMRUQpIHsKICAvKioKICAgKiBAcHVibGljCiAgICogQG92ZXJyaWRlCiAgICovCiAgcHJvdG8ucGIuY21zLlByb2Nlc3NWaW9sYXRpb25SZXF1ZXN0LmRpc3BsYXlOYW1lID0gJ3Byb3RvLnBiLmNtcy5Qcm9jZXNzVmlvbGF0aW9uUmVxdWVzdCc7Cn0KLyoqCiAqIEdlbmVyYXRlZCBieSBKc1BiQ29kZUdlbmVyYXRvci4KICogQHBhcmFtIHtBcnJheT19IG9wdF9kYXRhIE9wdGlvbmFsIGluaXRpYWwgZGF0YSBhcnJheSwgdHlwaWNhbGx5IGZyb20gYQogKiBzZXJ2ZXIgcmVzcG9uc2UsIG9yIGNvbnN0cnVjdGVkIGRpcmVjdGx5IGluIEphdmFzY3JpcHQuIFRoZSBhcnJheSBpcyB1c2VkCiAqIGluIHBsYWNlIGFuZCBiZWNvbWVzIHBhcnQgb2YgdGhlIGNvbnN0cnVjdGVkIG9iamVjdC4gSXQgaXMgbm90IGNsb25lZC4KICogSWYgbm8gZGF0YSBpcyBwcm92aWRlZCwgdGhlIGNvbnN0cnVjdGVkIG9iamVjdCB3aWxsIGJlIGVtcHR5LCBidXQgc3RpbGwKICogdmFsaWQuCiAqIEBleHRlbmRzIHtqc3BiLk1lc3NhZ2V9CiAqIEBjb25zdHJ1Y3RvcgogKi8KCgpwcm90by5wYi5jbXMuTGl2ZUxpc3RSZXF1ZXN0ID0gZnVuY3Rpb24gKG9wdF9kYXRhKSB7CiAganNwYi5NZXNzYWdlLmluaXRpYWxpemUodGhpcywgb3B0X2RhdGEsIDAsIC0xLCBudWxsLCBudWxsKTsKfTsKCmdvb2cuaW5oZXJpdHMocHJvdG8ucGIuY21zLkxpdmVMaXN0UmVxdWVzdCwganNwYi5NZXNzYWdlKTsKCmlmIChnb29nLkRFQlVHICYmICFDT01QSUxFRCkgewogIC8qKgogICAqIEBwdWJsaWMKICAgKiBAb3ZlcnJpZGUKICAgKi8KICBwcm90by5wYi5jbXMuTGl2ZUxpc3RSZXF1ZXN0LmRpc3BsYXlOYW1lID0gJ3Byb3RvLnBiLmNtcy5MaXZlTGlzdFJlcXVlc3QnOwp9Ci8qKgogKiBHZW5lcmF0ZWQgYnkgSnNQYkNvZGVHZW5lcmF0b3IuCiAqIEBwYXJhbSB7QXJyYXk9fSBvcHRfZGF0YSBPcHRpb25hbCBpbml0aWFsIGRhdGEgYXJyYXksIHR5cGljYWxseSBmcm9tIGEKICogc2VydmVyIHJlc3BvbnNlLCBvciBjb25zdHJ1Y3RlZCBkaXJlY3RseSBpbiBKYXZhc2NyaXB0LiBUaGUgYXJyYXkgaXMgdXNlZAogKiBpbiBwbGFjZSBhbmQgYmVjb21lcyBwYXJ0IG9mIHRoZSBjb25zdHJ1Y3RlZCBvYmplY3QuIEl0IGlzIG5vdCBjbG9uZWQuCiAqIElmIG5vIGRhdGEgaXMgcHJvdmlkZWQsIHRoZSBjb25zdHJ1Y3RlZCBvYmplY3Qgd2lsbCBiZSBlbXB0eSwgYnV0IHN0aWxsCiAqIHZhbGlkLgogKiBAZXh0ZW5kcyB7anNwYi5NZXNzYWdlfQogKiBAY29uc3RydWN0b3IKICovCgoKcHJvdG8ucGIuY21zLkxpdmVMaXN0UmVwbHkgPSBmdW5jdGlvbiAob3B0X2RhdGEpIHsKICBqc3BiLk1lc3NhZ2UuaW5pdGlhbGl6ZSh0aGlzLCBvcHRfZGF0YSwgMCwgLTEsIHByb3RvLnBiLmNtcy5MaXZlTGlzdFJlcGx5LnJlcGVhdGVkRmllbGRzXywgbnVsbCk7Cn07Cgpnb29nLmluaGVyaXRzKHByb3RvLnBiLmNtcy5MaXZlTGlzdFJlcGx5LCBqc3BiLk1lc3NhZ2UpOwoKaWYgKGdvb2cuREVCVUcgJiYgIUNPTVBJTEVEKSB7CiAgLyoqCiAgICogQHB1YmxpYwogICAqIEBvdmVycmlkZQogICAqLwogIHByb3RvLnBiLmNtcy5MaXZlTGlzdFJlcGx5LmRpc3BsYXlOYW1lID0gJ3Byb3RvLnBiLmNtcy5MaXZlTGlzdFJlcGx5JzsKfQovKioKICogR2VuZXJhdGVkIGJ5IEpzUGJDb2RlR2VuZXJhdG9yLgogKiBAcGFyYW0ge0FycmF5PX0gb3B0X2RhdGEgT3B0aW9uYWwgaW5pdGlhbCBkYXRhIGFycmF5LCB0eXBpY2FsbHkgZnJvbSBhCiAqIHNlcnZlciByZXNwb25zZSwgb3IgY29uc3RydWN0ZWQgZGlyZWN0bHkgaW4gSmF2YXNjcmlwdC4gVGhlIGFycmF5IGlzIHVzZWQKICogaW4gcGxhY2UgYW5kIGJlY29tZXMgcGFydCBvZiB0aGUgY29uc3RydWN0ZWQgb2JqZWN0LiBJdCBpcyBub3QgY2xvbmVkLgogKiBJZiBubyBkYXRhIGlzIHByb3ZpZGVkLCB0aGUgY29uc3RydWN0ZWQgb2JqZWN0IHdpbGwgYmUgZW1wdHksIGJ1dCBzdGlsbAogKiB2YWxpZC4KICogQGV4dGVuZHMge2pzcGIuTWVzc2FnZX0KICogQGNvbnN0cnVjdG9yCiAqLwoKCnByb3RvLnBiLmNtcy5QYXlMaXN0UmVxdWVzdCA9IGZ1bmN0aW9uIChvcHRfZGF0YSkgewogIGpzcGIuTWVzc2FnZS5pbml0aWFsaXplKHRoaXMsIG9wdF9kYXRhLCAwLCAtMSwgbnVsbCwgbnVsbCk7Cn07Cgpnb29nLmluaGVyaXRzKHByb3RvLnBiLmNtcy5QYXlMaXN0UmVxdWVzdCwganNwYi5NZXNzYWdlKTsKCmlmIChnb29nLkRFQlVHICYmICFDT01QSUxFRCkgewogIC8qKgogICAqIEBwdWJsaWMKICAgKiBAb3ZlcnJpZGUKICAgKi8KICBwcm90by5wYi5jbXMuUGF5TGlzdFJlcXVlc3QuZGlzcGxheU5hbWUgPSAncHJvdG8ucGIuY21zLlBheUxpc3RSZXF1ZXN0JzsKfQovKioKICogR2VuZXJhdGVkIGJ5IEpzUGJDb2RlR2VuZXJhdG9yLgogKiBAcGFyYW0ge0FycmF5PX0gb3B0X2RhdGEgT3B0aW9uYWwgaW5pdGlhbCBkYXRhIGFycmF5LCB0eXBpY2FsbHkgZnJvbSBhCiAqIHNlcnZlciByZXNwb25zZSwgb3IgY29uc3RydWN0ZWQgZGlyZWN0bHkgaW4gSmF2YXNjcmlwdC4gVGhlIGFycmF5IGlzIHVzZWQKICogaW4gcGxhY2UgYW5kIGJlY29tZXMgcGFydCBvZiB0aGUgY29uc3RydWN0ZWQgb2JqZWN0LiBJdCBpcyBub3QgY2xvbmVkLgogKiBJZiBubyBkYXRhIGlzIHByb3ZpZGVkLCB0aGUgY29uc3RydWN0ZWQgb2JqZWN0IHdpbGwgYmUgZW1wdHksIGJ1dCBzdGlsbAogKiB2YWxpZC4KICogQGV4dGVuZHMge2pzcGIuTWVzc2FnZX0KICogQGNvbnN0cnVjdG9yCiAqLwoKCnByb3RvLnBiLmNtcy5QYXlMaXN0UmVwbHkgPSBmdW5jdGlvbiAob3B0X2RhdGEpIHsKICBqc3BiLk1lc3NhZ2UuaW5pdGlhbGl6ZSh0aGlzLCBvcHRfZGF0YSwgMCwgLTEsIHByb3RvLnBiLmNtcy5QYXlMaXN0UmVwbHkucmVwZWF0ZWRGaWVsZHNfLCBudWxsKTsKfTsKCmdvb2cuaW5oZXJpdHMocHJvdG8ucGIuY21zLlBheUxpc3RSZXBseSwganNwYi5NZXNzYWdlKTsKCmlmIChnb29nLkRFQlVHICYmICFDT01QSUxFRCkgewogIC8qKgogICAqIEBwdWJsaWMKICAgKiBAb3ZlcnJpZGUKICAgKi8KICBwcm90by5wYi5jbXMuUGF5TGlzdFJlcGx5LmRpc3BsYXlOYW1lID0gJ3Byb3RvLnBiLmNtcy5QYXlMaXN0UmVwbHknOwp9Ci8qKgogKiBHZW5lcmF0ZWQgYnkgSnNQYkNvZGVHZW5lcmF0b3IuCiAqIEBwYXJhbSB7QXJyYXk9fSBvcHRfZGF0YSBPcHRpb25hbCBpbml0aWFsIGRhdGEgYXJyYXksIHR5cGljYWxseSBmcm9tIGEKICogc2VydmVyIHJlc3BvbnNlLCBvciBjb25zdHJ1Y3RlZCBkaXJlY3RseSBpbiBKYXZhc2NyaXB0LiBUaGUgYXJyYXkgaXMgdXNlZAogKiBpbiBwbGFjZSBhbmQgYmVjb21lcyBwYXJ0IG9mIHRoZSBjb25zdHJ1Y3RlZCBvYmplY3QuIEl0IGlzIG5vdCBjbG9uZWQuCiAqIElmIG5vIGRhdGEgaXMgcHJvdmlkZWQsIHRoZSBjb25zdHJ1Y3RlZCBvYmplY3Qgd2lsbCBiZSBlbXB0eSwgYnV0IHN0aWxsCiAqIHZhbGlkLgogKiBAZXh0ZW5kcyB7anNwYi5NZXNzYWdlfQogKiBAY29uc3RydWN0b3IKICovCgoKcHJvdG8ucGIuY21zLlJvYm90TGlzdFJlcXVlc3QgPSBmdW5jdGlvbiAob3B0X2RhdGEpIHsKICBqc3BiLk1lc3NhZ2UuaW5pdGlhbGl6ZSh0aGlzLCBvcHRfZGF0YSwgMCwgLTEsIG51bGwsIG51bGwpOwp9OwoKZ29vZy5pbmhlcml0cyhwcm90by5wYi5jbXMuUm9ib3RMaXN0UmVxdWVzdCwganNwYi5NZXNzYWdlKTsKCmlmIChnb29nLkRFQlVHICYmICFDT01QSUxFRCkgewogIC8qKgogICAqIEBwdWJsaWMKICAgKiBAb3ZlcnJpZGUKICAgKi8KICBwcm90by5wYi5jbXMuUm9ib3RMaXN0UmVxdWVzdC5kaXNwbGF5TmFtZSA9ICdwcm90by5wYi5jbXMuUm9ib3RMaXN0UmVxdWVzdCc7Cn0KLyoqCiAqIEdlbmVyYXRlZCBieSBKc1BiQ29kZUdlbmVyYXRvci4KICogQHBhcmFtIHtBcnJheT19IG9wdF9kYXRhIE9wdGlvbmFsIGluaXRpYWwgZGF0YSBhcnJheSwgdHlwaWNhbGx5IGZyb20gYQogKiBzZXJ2ZXIgcmVzcG9uc2UsIG9yIGNvbnN0cnVjdGVkIGRpcmVjdGx5IGluIEphdmFzY3JpcHQuIFRoZSBhcnJheSBpcyB1c2VkCiAqIGluIHBsYWNlIGFuZCBiZWNvbWVzIHBhcnQgb2YgdGhlIGNvbnN0cnVjdGVkIG9iamVjdC4gSXQgaXMgbm90IGNsb25lZC4KICogSWYgbm8gZGF0YSBpcyBwcm92aWRlZCwgdGhlIGNvbnN0cnVjdGVkIG9iamVjdCB3aWxsIGJlIGVtcHR5LCBidXQgc3RpbGwKICogdmFsaWQuCiAqIEBleHRlbmRzIHtqc3BiLk1lc3NhZ2V9CiAqIEBjb25zdHJ1Y3RvcgogKi8KCgpwcm90by5wYi5jbXMuUm9ib3RMaXN0UmVwbHkgPSBmdW5jdGlvbiAob3B0X2RhdGEpIHsKICBqc3BiLk1lc3NhZ2UuaW5pdGlhbGl6ZSh0aGlzLCBvcHRfZGF0YSwgMCwgLTEsIHByb3RvLnBiLmNtcy5Sb2JvdExpc3RSZXBseS5yZXBlYXRlZEZpZWxkc18sIG51bGwpOwp9OwoKZ29vZy5pbmhlcml0cyhwcm90by5wYi5jbXMuUm9ib3RMaXN0UmVwbHksIGpzcGIuTWVzc2FnZSk7CgppZiAoZ29vZy5ERUJVRyAmJiAhQ09NUElMRUQpIHsKICAvKioKICAgKiBAcHVibGljCiAgICogQG92ZXJyaWRlCiAgICovCiAgcHJvdG8ucGIuY21zLlJvYm90TGlzdFJlcGx5LmRpc3BsYXlOYW1lID0gJ3Byb3RvLnBiLmNtcy5Sb2JvdExpc3RSZXBseSc7Cn0KLyoqCiAqIEdlbmVyYXRlZCBieSBKc1BiQ29kZUdlbmVyYXRvci4KICogQHBhcmFtIHtBcnJheT19IG9wdF9kYXRhIE9wdGlvbmFsIGluaXRpYWwgZGF0YSBhcnJheSwgdHlwaWNhbGx5IGZyb20gYQogKiBzZXJ2ZXIgcmVzcG9uc2UsIG9yIGNvbnN0cnVjdGVkIGRpcmVjdGx5IGluIEphdmFzY3JpcHQuIFRoZSBhcnJheSBpcyB1c2VkCiAqIGluIHBsYWNlIGFuZCBiZWNvbWVzIHBhcnQgb2YgdGhlIGNvbnN0cnVjdGVkIG9iamVjdC4gSXQgaXMgbm90IGNsb25lZC4KICogSWYgbm8gZGF0YSBpcyBwcm92aWRlZCwgdGhlIGNvbnN0cnVjdGVkIG9iamVjdCB3aWxsIGJlIGVtcHR5LCBidXQgc3RpbGwKICogdmFsaWQuCiAqIEBleHRlbmRzIHtqc3BiLk1lc3NhZ2V9CiAqIEBjb25zdHJ1Y3RvcgogKi8KCgpwcm90by5wYi5jbXMuUm9ib3RNZXNzYWdlTGlzdFJlcXVlc3QgPSBmdW5jdGlvbiAob3B0X2RhdGEpIHsKICBqc3BiLk1lc3NhZ2UuaW5pdGlhbGl6ZSh0aGlzLCBvcHRfZGF0YSwgMCwgLTEsIG51bGwsIG51bGwpOwp9OwoKZ29vZy5pbmhlcml0cyhwcm90by5wYi5jbXMuUm9ib3RNZXNzYWdlTGlzdFJlcXVlc3QsIGpzcGIuTWVzc2FnZSk7CgppZiAoZ29vZy5ERUJVRyAmJiAhQ09NUElMRUQpIHsKICAvKioKICAgKiBAcHVibGljCiAgICogQG92ZXJyaWRlCiAgICovCiAgcHJvdG8ucGIuY21zLlJvYm90TWVzc2FnZUxpc3RSZXF1ZXN0LmRpc3BsYXlOYW1lID0gJ3Byb3RvLnBiLmNtcy5Sb2JvdE1lc3NhZ2VMaXN0UmVxdWVzdCc7Cn0KLyoqCiAqIEdlbmVyYXRlZCBieSBKc1BiQ29kZUdlbmVyYXRvci4KICogQHBhcmFtIHtBcnJheT19IG9wdF9kYXRhIE9wdGlvbmFsIGluaXRpYWwgZGF0YSBhcnJheSwgdHlwaWNhbGx5IGZyb20gYQogKiBzZXJ2ZXIgcmVzcG9uc2UsIG9yIGNvbnN0cnVjdGVkIGRpcmVjdGx5IGluIEphdmFzY3JpcHQuIFRoZSBhcnJheSBpcyB1c2VkCiAqIGluIHBsYWNlIGFuZCBiZWNvbWVzIHBhcnQgb2YgdGhlIGNvbnN0cnVjdGVkIG9iamVjdC4gSXQgaXMgbm90IGNsb25lZC4KICogSWYgbm8gZGF0YSBpcyBwcm92aWRlZCwgdGhlIGNvbnN0cnVjdGVkIG9iamVjdCB3aWxsIGJlIGVtcHR5LCBidXQgc3RpbGwKICogdmFsaWQuCiAqIEBleHRlbmRzIHtqc3BiLk1lc3NhZ2V9CiAqIEBjb25zdHJ1Y3RvcgogKi8KCgpwcm90by5wYi5jbXMuUm9ib3RNZXNzYWdlTGlzdFJlcGx5ID0gZnVuY3Rpb24gKG9wdF9kYXRhKSB7CiAganNwYi5NZXNzYWdlLmluaXRpYWxpemUodGhpcywgb3B0X2RhdGEsIDAsIC0xLCBwcm90by5wYi5jbXMuUm9ib3RNZXNzYWdlTGlzdFJlcGx5LnJlcGVhdGVkRmllbGRzXywgbnVsbCk7Cn07Cgpnb29nLmluaGVyaXRzKHByb3RvLnBiLmNtcy5Sb2JvdE1lc3NhZ2VMaXN0UmVwbHksIGpzcGIuTWVzc2FnZSk7CgppZiAoZ29vZy5ERUJVRyAmJiAhQ09NUElMRUQpIHsKICAvKioKICAgKiBAcHVibGljCiAgICogQG92ZXJyaWRlCiAgICovCiAgcHJvdG8ucGIuY21zLlJvYm90TWVzc2FnZUxpc3RSZXBseS5kaXNwbGF5TmFtZSA9ICdwcm90by5wYi5jbXMuUm9ib3RNZXNzYWdlTGlzdFJlcGx5JzsKfQovKioKICogR2VuZXJhdGVkIGJ5IEpzUGJDb2RlR2VuZXJhdG9yLgogKiBAcGFyYW0ge0FycmF5PX0gb3B0X2RhdGEgT3B0aW9uYWwgaW5pdGlhbCBkYXRhIGFycmF5LCB0eXBpY2FsbHkgZnJvbSBhCiAqIHNlcnZlciByZXNwb25zZSwgb3IgY29uc3RydWN0ZWQgZGlyZWN0bHkgaW4gSmF2YXNjcmlwdC4gVGhlIGFycmF5IGlzIHVzZWQKICogaW4gcGxhY2UgYW5kIGJlY29tZXMgcGFydCBvZiB0aGUgY29uc3RydWN0ZWQgb2JqZWN0LiBJdCBpcyBub3QgY2xvbmVkLgogKiBJZiBubyBkYXRhIGlzIHByb3ZpZGVkLCB0aGUgY29uc3RydWN0ZWQgb2JqZWN0IHdpbGwgYmUgZW1wdHksIGJ1dCBzdGlsbAogKiB2YWxpZC4KICogQGV4dGVuZHMge2pzcGIuTWVzc2FnZX0KICogQGNvbnN0cnVjdG9yCiAqLwoKCnByb3RvLnBiLmNtcy5Nb21lbnRMaXN0UmVxdWVzdCA9IGZ1bmN0aW9uIChvcHRfZGF0YSkgewogIGpzcGIuTWVzc2FnZS5pbml0aWFsaXplKHRoaXMsIG9wdF9kYXRhLCAwLCAtMSwgbnVsbCwgbnVsbCk7Cn07Cgpnb29nLmluaGVyaXRzKHByb3RvLnBiLmNtcy5Nb21lbnRMaXN0UmVxdWVzdCwganNwYi5NZXNzYWdlKTsKCmlmIChnb29nLkRFQlVHICYmICFDT01QSUxFRCkgewogIC8qKgogICAqIEBwdWJsaWMKICAgKiBAb3ZlcnJpZGUKICAgKi8KICBwcm90by5wYi5jbXMuTW9tZW50TGlzdFJlcXVlc3QuZGlzcGxheU5hbWUgPSAncHJvdG8ucGIuY21zLk1vbWVudExpc3RSZXF1ZXN0JzsKfQovKioKICogR2VuZXJhdGVkIGJ5IEpzUGJDb2RlR2VuZXJhdG9yLgogKiBAcGFyYW0ge0FycmF5PX0gb3B0X2RhdGEgT3B0aW9uYWwgaW5pdGlhbCBkYXRhIGFycmF5LCB0eXBpY2FsbHkgZnJvbSBhCiAqIHNlcnZlciByZXNwb25zZSwgb3IgY29uc3RydWN0ZWQgZGlyZWN0bHkgaW4gSmF2YXNjcmlwdC4gVGhlIGFycmF5IGlzIHVzZWQKICogaW4gcGxhY2UgYW5kIGJlY29tZXMgcGFydCBvZiB0aGUgY29uc3RydWN0ZWQgb2JqZWN0LiBJdCBpcyBub3QgY2xvbmVkLgogKiBJZiBubyBkYXRhIGlzIHByb3ZpZGVkLCB0aGUgY29uc3RydWN0ZWQgb2JqZWN0IHdpbGwgYmUgZW1wdHksIGJ1dCBzdGlsbAogKiB2YWxpZC4KICogQGV4dGVuZHMge2pzcGIuTWVzc2FnZX0KICogQGNvbnN0cnVjdG9yCiAqLwoKCnByb3RvLnBiLmNtcy5Nb21lbnRMaXN0UmVwbHkgPSBmdW5jdGlvbiAob3B0X2RhdGEpIHsKICBqc3BiLk1lc3NhZ2UuaW5pdGlhbGl6ZSh0aGlzLCBvcHRfZGF0YSwgMCwgLTEsIHByb3RvLnBiLmNtcy5Nb21lbnRMaXN0UmVwbHkucmVwZWF0ZWRGaWVsZHNfLCBudWxsKTsKfTsKCmdvb2cuaW5oZXJpdHMocHJvdG8ucGIuY21zLk1vbWVudExpc3RSZXBseSwganNwYi5NZXNzYWdlKTsKCmlmIChnb29nLkRFQlVHICYmICFDT01QSUxFRCkgewogIC8qKgogICAqIEBwdWJsaWMKICAgKiBAb3ZlcnJpZGUKICAgKi8KICBwcm90by5wYi5jbXMuTW9tZW50TGlzdFJlcGx5LmRpc3BsYXlOYW1lID0gJ3Byb3RvLnBiLmNtcy5Nb21lbnRMaXN0UmVwbHknOwp9Ci8qKgogKiBHZW5lcmF0ZWQgYnkgSnNQYkNvZGVHZW5lcmF0b3IuCiAqIEBwYXJhbSB7QXJyYXk9fSBvcHRfZGF0YSBPcHRpb25hbCBpbml0aWFsIGRhdGEgYXJyYXksIHR5cGljYWxseSBmcm9tIGEKICogc2VydmVyIHJlc3BvbnNlLCBvciBjb25zdHJ1Y3RlZCBkaXJlY3RseSBpbiBKYXZhc2NyaXB0LiBUaGUgYXJyYXkgaXMgdXNlZAogKiBpbiBwbGFjZSBhbmQgYmVjb21lcyBwYXJ0IG9mIHRoZSBjb25zdHJ1Y3RlZCBvYmplY3QuIEl0IGlzIG5vdCBjbG9uZWQuCiAqIElmIG5vIGRhdGEgaXMgcHJvdmlkZWQsIHRoZSBjb25zdHJ1Y3RlZCBvYmplY3Qgd2lsbCBiZSBlbXB0eSwgYnV0IHN0aWxsCiAqIHZhbGlkLgogKiBAZXh0ZW5kcyB7anNwYi5NZXNzYWdlfQogKiBAY29uc3RydWN0b3IKICovCgoKcHJvdG8ucGIuY21zLkF1dG9NZXNzYWdlTGlzdFJlcXVlc3QgPSBmdW5jdGlvbiAob3B0X2RhdGEpIHsKICBqc3BiLk1lc3NhZ2UuaW5pdGlhbGl6ZSh0aGlzLCBvcHRfZGF0YSwgMCwgLTEsIG51bGwsIG51bGwpOwp9OwoKZ29vZy5pbmhlcml0cyhwcm90by5wYi5jbXMuQXV0b01lc3NhZ2VMaXN0UmVxdWVzdCwganNwYi5NZXNzYWdlKTsKCmlmIChnb29nLkRFQlVHICYmICFDT01QSUxFRCkgewogIC8qKgogICAqIEBwdWJsaWMKICAgKiBAb3ZlcnJpZGUKICAgKi8KICBwcm90by5wYi5jbXMuQXV0b01lc3NhZ2VMaXN0UmVxdWVzdC5kaXNwbGF5TmFtZSA9ICdwcm90by5wYi5jbXMuQXV0b01lc3NhZ2VMaXN0UmVxdWVzdCc7Cn0KLyoqCiAqIEdlbmVyYXRlZCBieSBKc1BiQ29kZUdlbmVyYXRvci4KICogQHBhcmFtIHtBcnJheT19IG9wdF9kYXRhIE9wdGlvbmFsIGluaXRpYWwgZGF0YSBhcnJheSwgdHlwaWNhbGx5IGZyb20gYQogKiBzZXJ2ZXIgcmVzcG9uc2UsIG9yIGNvbnN0cnVjdGVkIGRpcmVjdGx5IGluIEphdmFzY3JpcHQuIFRoZSBhcnJheSBpcyB1c2VkCiAqIGluIHBsYWNlIGFuZCBiZWNvbWVzIHBhcnQgb2YgdGhlIGNvbnN0cnVjdGVkIG9iamVjdC4gSXQgaXMgbm90IGNsb25lZC4KICogSWYgbm8gZGF0YSBpcyBwcm92aWRlZCwgdGhlIGNvbnN0cnVjdGVkIG9iamVjdCB3aWxsIGJlIGVtcHR5LCBidXQgc3RpbGwKICogdmFsaWQuCiAqIEBleHRlbmRzIHtqc3BiLk1lc3NhZ2V9CiAqIEBjb25zdHJ1Y3RvcgogKi8KCgpwcm90by5wYi5jbXMuQXV0b01lc3NhZ2VMaXN0UmVwbHkgPSBmdW5jdGlvbiAob3B0X2RhdGEpIHsKICBqc3BiLk1lc3NhZ2UuaW5pdGlhbGl6ZSh0aGlzLCBvcHRfZGF0YSwgMCwgLTEsIHByb3RvLnBiLmNtcy5BdXRvTWVzc2FnZUxpc3RSZXBseS5yZXBlYXRlZEZpZWxkc18sIG51bGwpOwp9OwoKZ29vZy5pbmhlcml0cyhwcm90by5wYi5jbXMuQXV0b01lc3NhZ2VMaXN0UmVwbHksIGpzcGIuTWVzc2FnZSk7CgppZiAoZ29vZy5ERUJVRyAmJiAhQ09NUElMRUQpIHsKICAvKioKICAgKiBAcHVibGljCiAgICogQG92ZXJyaWRlCiAgICovCiAgcHJvdG8ucGIuY21zLkF1dG9NZXNzYWdlTGlzdFJlcGx5LmRpc3BsYXlOYW1lID0gJ3Byb3RvLnBiLmNtcy5BdXRvTWVzc2FnZUxpc3RSZXBseSc7Cn0KLyoqCiAqIEdlbmVyYXRlZCBieSBKc1BiQ29kZUdlbmVyYXRvci4KICogQHBhcmFtIHtBcnJheT19IG9wdF9kYXRhIE9wdGlvbmFsIGluaXRpYWwgZGF0YSBhcnJheSwgdHlwaWNhbGx5IGZyb20gYQogKiBzZXJ2ZXIgcmVzcG9uc2UsIG9yIGNvbnN0cnVjdGVkIGRpcmVjdGx5IGluIEphdmFzY3JpcHQuIFRoZSBhcnJheSBpcyB1c2VkCiAqIGluIHBsYWNlIGFuZCBiZWNvbWVzIHBhcnQgb2YgdGhlIGNvbnN0cnVjdGVkIG9iamVjdC4gSXQgaXMgbm90IGNsb25lZC4KICogSWYgbm8gZGF0YSBpcyBwcm92aWRlZCwgdGhlIGNvbnN0cnVjdGVkIG9iamVjdCB3aWxsIGJlIGVtcHR5LCBidXQgc3RpbGwKICogdmFsaWQuCiAqIEBleHRlbmRzIHtqc3BiLk1lc3NhZ2V9CiAqIEBjb25zdHJ1Y3RvcgogKi8KCgpwcm90by5wYi5jbXMuQ2hhdE1lc3NhZ2VMaXN0UmVxdWVzdCA9IGZ1bmN0aW9uIChvcHRfZGF0YSkgewogIGpzcGIuTWVzc2FnZS5pbml0aWFsaXplKHRoaXMsIG9wdF9kYXRhLCAwLCAtMSwgbnVsbCwgbnVsbCk7Cn07Cgpnb29nLmluaGVyaXRzKHByb3RvLnBiLmNtcy5DaGF0TWVzc2FnZUxpc3RSZXF1ZXN0LCBqc3BiLk1lc3NhZ2UpOwoKaWYgKGdvb2cuREVCVUcgJiYgIUNPTVBJTEVEKSB7CiAgLyoqCiAgICogQHB1YmxpYwogICAqIEBvdmVycmlkZQogICAqLwogIHByb3RvLnBiLmNtcy5DaGF0TWVzc2FnZUxpc3RSZXF1ZXN0LmRpc3BsYXlOYW1lID0gJ3Byb3RvLnBiLmNtcy5DaGF0TWVzc2FnZUxpc3RSZXF1ZXN0JzsKfQovKioKICogR2VuZXJhdGVkIGJ5IEpzUGJDb2RlR2VuZXJhdG9yLgogKiBAcGFyYW0ge0FycmF5PX0gb3B0X2RhdGEgT3B0aW9uYWwgaW5pdGlhbCBkYXRhIGFycmF5LCB0eXBpY2FsbHkgZnJvbSBhCiAqIHNlcnZlciByZXNwb25zZSwgb3IgY29uc3RydWN0ZWQgZGlyZWN0bHkgaW4gSmF2YXNjcmlwdC4gVGhlIGFycmF5IGlzIHVzZWQKICogaW4gcGxhY2UgYW5kIGJlY29tZXMgcGFydCBvZiB0aGUgY29uc3RydWN0ZWQgb2JqZWN0LiBJdCBpcyBub3QgY2xvbmVkLgogKiBJZiBubyBkYXRhIGlzIHByb3ZpZGVkLCB0aGUgY29uc3RydWN0ZWQgb2JqZWN0IHdpbGwgYmUgZW1wdHksIGJ1dCBzdGlsbAogKiB2YWxpZC4KICogQGV4dGVuZHMge2pzcGIuTWVzc2FnZX0KICogQGNvbnN0cnVjdG9yCiAqLwoKCnByb3RvLnBiLmNtcy5DaGF0TWVzc2FnZUxpc3RSZXBseSA9IGZ1bmN0aW9uIChvcHRfZGF0YSkgewogIGpzcGIuTWVzc2FnZS5pbml0aWFsaXplKHRoaXMsIG9wdF9kYXRhLCAwLCAtMSwgcHJvdG8ucGIuY21zLkNoYXRNZXNzYWdlTGlzdFJlcGx5LnJlcGVhdGVkRmllbGRzXywgbnVsbCk7Cn07Cgpnb29nLmluaGVyaXRzKHByb3RvLnBiLmNtcy5DaGF0TWVzc2FnZUxpc3RSZXBseSwganNwYi5NZXNzYWdlKTsKCmlmIChnb29nLkRFQlVHICYmICFDT01QSUxFRCkgewogIC8qKgogICAqIEBwdWJsaWMKICAgKiBAb3ZlcnJpZGUKICAgKi8KICBwcm90by5wYi5jbXMuQ2hhdE1lc3NhZ2VMaXN0UmVwbHkuZGlzcGxheU5hbWUgPSAncHJvdG8ucGIuY21zLkNoYXRNZXNzYWdlTGlzdFJlcGx5JzsKfQovKioKICogR2VuZXJhdGVkIGJ5IEpzUGJDb2RlR2VuZXJhdG9yLgogKiBAcGFyYW0ge0FycmF5PX0gb3B0X2RhdGEgT3B0aW9uYWwgaW5pdGlhbCBkYXRhIGFycmF5LCB0eXBpY2FsbHkgZnJvbSBhCiAqIHNlcnZlciByZXNwb25zZSwgb3IgY29uc3RydWN0ZWQgZGlyZWN0bHkgaW4gSmF2YXNjcmlwdC4gVGhlIGFycmF5IGlzIHVzZWQKICogaW4gcGxhY2UgYW5kIGJlY29tZXMgcGFydCBvZiB0aGUgY29uc3RydWN0ZWQgb2JqZWN0LiBJdCBpcyBub3QgY2xvbmVkLgogKiBJZiBubyBkYXRhIGlzIHByb3ZpZGVkLCB0aGUgY29uc3RydWN0ZWQgb2JqZWN0IHdpbGwgYmUgZW1wdHksIGJ1dCBzdGlsbAogKiB2YWxpZC4KICogQGV4dGVuZHMge2pzcGIuTWVzc2FnZX0KICogQGNvbnN0cnVjdG9yCiAqLwoKCnByb3RvLnBiLmNtcy5DYWxsTGlzdFJlcXVlc3QgPSBmdW5jdGlvbiAob3B0X2RhdGEpIHsKICBqc3BiLk1lc3NhZ2UuaW5pdGlhbGl6ZSh0aGlzLCBvcHRfZGF0YSwgMCwgLTEsIG51bGwsIG51bGwpOwp9OwoKZ29vZy5pbmhlcml0cyhwcm90by5wYi5jbXMuQ2FsbExpc3RSZXF1ZXN0LCBqc3BiLk1lc3NhZ2UpOwoKaWYgKGdvb2cuREVCVUcgJiYgIUNPTVBJTEVEKSB7CiAgLyoqCiAgICogQHB1YmxpYwogICAqIEBvdmVycmlkZQogICAqLwogIHByb3RvLnBiLmNtcy5DYWxsTGlzdFJlcXVlc3QuZGlzcGxheU5hbWUgPSAncHJvdG8ucGIuY21zLkNhbGxMaXN0UmVxdWVzdCc7Cn0KLyoqCiAqIEdlbmVyYXRlZCBieSBKc1BiQ29kZUdlbmVyYXRvci4KICogQHBhcmFtIHtBcnJheT19IG9wdF9kYXRhIE9wdGlvbmFsIGluaXRpYWwgZGF0YSBhcnJheSwgdHlwaWNhbGx5IGZyb20gYQogKiBzZXJ2ZXIgcmVzcG9uc2UsIG9yIGNvbnN0cnVjdGVkIGRpcmVjdGx5IGluIEphdmFzY3JpcHQuIFRoZSBhcnJheSBpcyB1c2VkCiAqIGluIHBsYWNlIGFuZCBiZWNvbWVzIHBhcnQgb2YgdGhlIGNvbnN0cnVjdGVkIG9iamVjdC4gSXQgaXMgbm90IGNsb25lZC4KICogSWYgbm8gZGF0YSBpcyBwcm92aWRlZCwgdGhlIGNvbnN0cnVjdGVkIG9iamVjdCB3aWxsIGJlIGVtcHR5LCBidXQgc3RpbGwKICogdmFsaWQuCiAqIEBleHRlbmRzIHtqc3BiLk1lc3NhZ2V9CiAqIEBjb25zdHJ1Y3RvcgogKi8KCgpwcm90by5wYi5jbXMuQ2FsbExpc3RSZXBseSA9IGZ1bmN0aW9uIChvcHRfZGF0YSkgewogIGpzcGIuTWVzc2FnZS5pbml0aWFsaXplKHRoaXMsIG9wdF9kYXRhLCAwLCAtMSwgcHJvdG8ucGIuY21zLkNhbGxMaXN0UmVwbHkucmVwZWF0ZWRGaWVsZHNfLCBudWxsKTsKfTsKCmdvb2cuaW5oZXJpdHMocHJvdG8ucGIuY21zLkNhbGxMaXN0UmVwbHksIGpzcGIuTWVzc2FnZSk7CgppZiAoZ29vZy5ERUJVRyAmJiAhQ09NUElMRUQpIHsKICAvKioKICAgKiBAcHVibGljCiAgICogQG92ZXJyaWRlCiAgICovCiAgcHJvdG8ucGIuY21zLkNhbGxMaXN0UmVwbHkuZGlzcGxheU5hbWUgPSAncHJvdG8ucGIuY21zLkNhbGxMaXN0UmVwbHknOwp9Ci8qKgogKiBHZW5lcmF0ZWQgYnkgSnNQYkNvZGVHZW5lcmF0b3IuCiAqIEBwYXJhbSB7QXJyYXk9fSBvcHRfZGF0YSBPcHRpb25hbCBpbml0aWFsIGRhdGEgYXJyYXksIHR5cGljYWxseSBmcm9tIGEKICogc2VydmVyIHJlc3BvbnNlLCBvciBjb25zdHJ1Y3RlZCBkaXJlY3RseSBpbiBKYXZhc2NyaXB0LiBUaGUgYXJyYXkgaXMgdXNlZAogKiBpbiBwbGFjZSBhbmQgYmVjb21lcyBwYXJ0IG9mIHRoZSBjb25zdHJ1Y3RlZCBvYmplY3QuIEl0IGlzIG5vdCBjbG9uZWQuCiAqIElmIG5vIGRhdGEgaXMgcHJvdmlkZWQsIHRoZSBjb25zdHJ1Y3RlZCBvYmplY3Qgd2lsbCBiZSBlbXB0eSwgYnV0IHN0aWxsCiAqIHZhbGlkLgogKiBAZXh0ZW5kcyB7anNwYi5NZXNzYWdlfQogKiBAY29uc3RydWN0b3IKICovCgoKcHJvdG8ucGIuY21zLlRyYW5zYWN0aW9uTGlzdFJlcXVlc3QgPSBmdW5jdGlvbiAob3B0X2RhdGEpIHsKICBqc3BiLk1lc3NhZ2UuaW5pdGlhbGl6ZSh0aGlzLCBvcHRfZGF0YSwgMCwgLTEsIG51bGwsIG51bGwpOwp9OwoKZ29vZy5pbmhlcml0cyhwcm90by5wYi5jbXMuVHJhbnNhY3Rpb25MaXN0UmVxdWVzdCwganNwYi5NZXNzYWdlKTsKCmlmIChnb29nLkRFQlVHICYmICFDT01QSUxFRCkgewogIC8qKgogICAqIEBwdWJsaWMKICAgKiBAb3ZlcnJpZGUKICAgKi8KICBwcm90by5wYi5jbXMuVHJhbnNhY3Rpb25MaXN0UmVxdWVzdC5kaXNwbGF5TmFtZSA9ICdwcm90by5wYi5jbXMuVHJhbnNhY3Rpb25MaXN0UmVxdWVzdCc7Cn0KLyoqCiAqIEdlbmVyYXRlZCBieSBKc1BiQ29kZUdlbmVyYXRvci4KICogQHBhcmFtIHtBcnJheT19IG9wdF9kYXRhIE9wdGlvbmFsIGluaXRpYWwgZGF0YSBhcnJheSwgdHlwaWNhbGx5IGZyb20gYQogKiBzZXJ2ZXIgcmVzcG9uc2UsIG9yIGNvbnN0cnVjdGVkIGRpcmVjdGx5IGluIEphdmFzY3JpcHQuIFRoZSBhcnJheSBpcyB1c2VkCiAqIGluIHBsYWNlIGFuZCBiZWNvbWVzIHBhcnQgb2YgdGhlIGNvbnN0cnVjdGVkIG9iamVjdC4gSXQgaXMgbm90IGNsb25lZC4KICogSWYgbm8gZGF0YSBpcyBwcm92aWRlZCwgdGhlIGNvbnN0cnVjdGVkIG9iamVjdCB3aWxsIGJlIGVtcHR5LCBidXQgc3RpbGwKICogdmFsaWQuCiAqIEBleHRlbmRzIHtqc3BiLk1lc3NhZ2V9CiAqIEBjb25zdHJ1Y3RvcgogKi8KCgpwcm90by5wYi5jbXMuVHJhbnNhY3Rpb25MaXN0UmVwbHkgPSBmdW5jdGlvbiAob3B0X2RhdGEpIHsKICBqc3BiLk1lc3NhZ2UuaW5pdGlhbGl6ZSh0aGlzLCBvcHRfZGF0YSwgMCwgLTEsIHByb3RvLnBiLmNtcy5UcmFuc2FjdGlvbkxpc3RSZXBseS5yZXBlYXRlZEZpZWxkc18sIG51bGwpOwp9OwoKZ29vZy5pbmhlcml0cyhwcm90by5wYi5jbXMuVHJhbnNhY3Rpb25MaXN0UmVwbHksIGpzcGIuTWVzc2FnZSk7CgppZiAoZ29vZy5ERUJVRyAmJiAhQ09NUElMRUQpIHsKICAvKioKICAgKiBAcHVibGljCiAgICogQG92ZXJyaWRlCiAgICovCiAgcHJvdG8ucGIuY21zLlRyYW5zYWN0aW9uTGlzdFJlcGx5LmRpc3BsYXlOYW1lID0gJ3Byb3RvLnBiLmNtcy5UcmFuc2FjdGlvbkxpc3RSZXBseSc7Cn0KLyoqCiAqIEdlbmVyYXRlZCBieSBKc1BiQ29kZUdlbmVyYXRvci4KICogQHBhcmFtIHtBcnJheT19IG9wdF9kYXRhIE9wdGlvbmFsIGluaXRpYWwgZGF0YSBhcnJheSwgdHlwaWNhbGx5IGZyb20gYQogKiBzZXJ2ZXIgcmVzcG9uc2UsIG9yIGNvbnN0cnVjdGVkIGRpcmVjdGx5IGluIEphdmFzY3JpcHQuIFRoZSBhcnJheSBpcyB1c2VkCiAqIGluIHBsYWNlIGFuZCBiZWNvbWVzIHBhcnQgb2YgdGhlIGNvbnN0cnVjdGVkIG9iamVjdC4gSXQgaXMgbm90IGNsb25lZC4KICogSWYgbm8gZGF0YSBpcyBwcm92aWRlZCwgdGhlIGNvbnN0cnVjdGVkIG9iamVjdCB3aWxsIGJlIGVtcHR5LCBidXQgc3RpbGwKICogdmFsaWQuCiAqIEBleHRlbmRzIHtqc3BiLk1lc3NhZ2V9CiAqIEBjb25zdHJ1Y3RvcgogKi8KCgpwcm90by5wYi5jbXMuQ3JlYXRlU2V0dGxlUmVxdWVzdCA9IGZ1bmN0aW9uIChvcHRfZGF0YSkgewogIGpzcGIuTWVzc2FnZS5pbml0aWFsaXplKHRoaXMsIG9wdF9kYXRhLCAwLCAtMSwgbnVsbCwgbnVsbCk7Cn07Cgpnb29nLmluaGVyaXRzKHByb3RvLnBiLmNtcy5DcmVhdGVTZXR0bGVSZXF1ZXN0LCBqc3BiLk1lc3NhZ2UpOwoKaWYgKGdvb2cuREVCVUcgJiYgIUNPTVBJTEVEKSB7CiAgLyoqCiAgICogQHB1YmxpYwogICAqIEBvdmVycmlkZQogICAqLwogIHByb3RvLnBiLmNtcy5DcmVhdGVTZXR0bGVSZXF1ZXN0LmRpc3BsYXlOYW1lID0gJ3Byb3RvLnBiLmNtcy5DcmVhdGVTZXR0bGVSZXF1ZXN0JzsKfQovKioKICogR2VuZXJhdGVkIGJ5IEpzUGJDb2RlR2VuZXJhdG9yLgogKiBAcGFyYW0ge0FycmF5PX0gb3B0X2RhdGEgT3B0aW9uYWwgaW5pdGlhbCBkYXRhIGFycmF5LCB0eXBpY2FsbHkgZnJvbSBhCiAqIHNlcnZlciByZXNwb25zZSwgb3IgY29uc3RydWN0ZWQgZGlyZWN0bHkgaW4gSmF2YXNjcmlwdC4gVGhlIGFycmF5IGlzIHVzZWQKICogaW4gcGxhY2UgYW5kIGJlY29tZXMgcGFydCBvZiB0aGUgY29uc3RydWN0ZWQgb2JqZWN0LiBJdCBpcyBub3QgY2xvbmVkLgogKiBJZiBubyBkYXRhIGlzIHByb3ZpZGVkLCB0aGUgY29uc3RydWN0ZWQgb2JqZWN0IHdpbGwgYmUgZW1wdHksIGJ1dCBzdGlsbAogKiB2YWxpZC4KICogQGV4dGVuZHMge2pzcGIuTWVzc2FnZX0KICogQGNvbnN0cnVjdG9yCiAqLwoKCnByb3RvLnBiLmNtcy5TdWJtaXRTZXR0bGVSZXF1ZXN0ID0gZnVuY3Rpb24gKG9wdF9kYXRhKSB7CiAganNwYi5NZXNzYWdlLmluaXRpYWxpemUodGhpcywgb3B0X2RhdGEsIDAsIC0xLCBwcm90by5wYi5jbXMuU3VibWl0U2V0dGxlUmVxdWVzdC5yZXBlYXRlZEZpZWxkc18sIG51bGwpOwp9OwoKZ29vZy5pbmhlcml0cyhwcm90by5wYi5jbXMuU3VibWl0U2V0dGxlUmVxdWVzdCwganNwYi5NZXNzYWdlKTsKCmlmIChnb29nLkRFQlVHICYmICFDT01QSUxFRCkgewogIC8qKgogICAqIEBwdWJsaWMKICAgKiBAb3ZlcnJpZGUKICAgKi8KICBwcm90by5wYi5jbXMuU3VibWl0U2V0dGxlUmVxdWVzdC5kaXNwbGF5TmFtZSA9ICdwcm90by5wYi5jbXMuU3VibWl0U2V0dGxlUmVxdWVzdCc7Cn0KLyoqCiAqIEdlbmVyYXRlZCBieSBKc1BiQ29kZUdlbmVyYXRvci4KICogQHBhcmFtIHtBcnJheT19IG9wdF9kYXRhIE9wdGlvbmFsIGluaXRpYWwgZGF0YSBhcnJheSwgdHlwaWNhbGx5IGZyb20gYQogKiBzZXJ2ZXIgcmVzcG9uc2UsIG9yIGNvbnN0cnVjdGVkIGRpcmVjdGx5IGluIEphdmFzY3JpcHQuIFRoZSBhcnJheSBpcyB1c2VkCiAqIGluIHBsYWNlIGFuZCBiZWNvbWVzIHBhcnQgb2YgdGhlIGNvbnN0cnVjdGVkIG9iamVjdC4gSXQgaXMgbm90IGNsb25lZC4KICogSWYgbm8gZGF0YSBpcyBwcm92aWRlZCwgdGhlIGNvbnN0cnVjdGVkIG9iamVjdCB3aWxsIGJlIGVtcHR5LCBidXQgc3RpbGwKICogdmFsaWQuCiAqIEBleHRlbmRzIHtqc3BiLk1lc3NhZ2V9CiAqIEBjb25zdHJ1Y3RvcgogKi8KCgpwcm90by5wYi5jbXMuU2V0dGxlUHJvZ3Jlc3NSZXF1ZXN0ID0gZnVuY3Rpb24gKG9wdF9kYXRhKSB7CiAganNwYi5NZXNzYWdlLmluaXRpYWxpemUodGhpcywgb3B0X2RhdGEsIDAsIC0xLCBudWxsLCBudWxsKTsKfTsKCmdvb2cuaW5oZXJpdHMocHJvdG8ucGIuY21zLlNldHRsZVByb2dyZXNzUmVxdWVzdCwganNwYi5NZXNzYWdlKTsKCmlmIChnb29nLkRFQlVHICYmICFDT01QSUxFRCkgewogIC8qKgogICAqIEBwdWJsaWMKICAgKiBAb3ZlcnJpZGUKICAgKi8KICBwcm90by5wYi5jbXMuU2V0dGxlUHJvZ3Jlc3NSZXF1ZXN0LmRpc3BsYXlOYW1lID0gJ3Byb3RvLnBiLmNtcy5TZXR0bGVQcm9ncmVzc1JlcXVlc3QnOwp9Ci8qKgogKiBHZW5lcmF0ZWQgYnkgSnNQYkNvZGVHZW5lcmF0b3IuCiAqIEBwYXJhbSB7QXJyYXk9fSBvcHRfZGF0YSBPcHRpb25hbCBpbml0aWFsIGRhdGEgYXJyYXksIHR5cGljYWxseSBmcm9tIGEKICogc2VydmVyIHJlc3BvbnNlLCBvciBjb25zdHJ1Y3RlZCBkaXJlY3RseSBpbiBKYXZhc2NyaXB0LiBUaGUgYXJyYXkgaXMgdXNlZAogKiBpbiBwbGFjZSBhbmQgYmVjb21lcyBwYXJ0IG9mIHRoZSBjb25zdHJ1Y3RlZCBvYmplY3QuIEl0IGlzIG5vdCBjbG9uZWQuCiAqIElmIG5vIGRhdGEgaXMgcHJvdmlkZWQsIHRoZSBjb25zdHJ1Y3RlZCBvYmplY3Qgd2lsbCBiZSBlbXB0eSwgYnV0IHN0aWxsCiAqIHZhbGlkLgogKiBAZXh0ZW5kcyB7anNwYi5NZXNzYWdlfQogKiBAY29uc3RydWN0b3IKICovCgoKcHJvdG8ucGIuY21zLlNldHRsZVByb2dyZXNzUmVwbHkgPSBmdW5jdGlvbiAob3B0X2RhdGEpIHsKICBqc3BiLk1lc3NhZ2UuaW5pdGlhbGl6ZSh0aGlzLCBvcHRfZGF0YSwgMCwgLTEsIG51bGwsIG51bGwpOwp9OwoKZ29vZy5pbmhlcml0cyhwcm90by5wYi5jbXMuU2V0dGxlUHJvZ3Jlc3NSZXBseSwganNwYi5NZXNzYWdlKTsKCmlmIChnb29nLkRFQlVHICYmICFDT01QSUxFRCkgewogIC8qKgogICAqIEBwdWJsaWMKICAgKiBAb3ZlcnJpZGUKICAgKi8KICBwcm90by5wYi5jbXMuU2V0dGxlUHJvZ3Jlc3NSZXBseS5kaXNwbGF5TmFtZSA9ICdwcm90by5wYi5jbXMuU2V0dGxlUHJvZ3Jlc3NSZXBseSc7Cn0KLyoqCiAqIEdlbmVyYXRlZCBieSBKc1BiQ29kZUdlbmVyYXRvci4KICogQHBhcmFtIHtBcnJheT19IG9wdF9kYXRhIE9wdGlvbmFsIGluaXRpYWwgZGF0YSBhcnJheSwgdHlwaWNhbGx5IGZyb20gYQogKiBzZXJ2ZXIgcmVzcG9uc2UsIG9yIGNvbnN0cnVjdGVkIGRpcmVjdGx5IGluIEphdmFzY3JpcHQuIFRoZSBhcnJheSBpcyB1c2VkCiAqIGluIHBsYWNlIGFuZCBiZWNvbWVzIHBhcnQgb2YgdGhlIGNvbnN0cnVjdGVkIG9iamVjdC4gSXQgaXMgbm90IGNsb25lZC4KICogSWYgbm8gZGF0YSBpcyBwcm92aWRlZCwgdGhlIGNvbnN0cnVjdGVkIG9iamVjdCB3aWxsIGJlIGVtcHR5LCBidXQgc3RpbGwKICogdmFsaWQuCiAqIEBleHRlbmRzIHtqc3BiLk1lc3NhZ2V9CiAqIEBjb25zdHJ1Y3RvcgogKi8KCgpwcm90by5wYi5jbXMuU2V0dGxlTGlzdFJlcXVlc3QgPSBmdW5jdGlvbiAob3B0X2RhdGEpIHsKICBqc3BiLk1lc3NhZ2UuaW5pdGlhbGl6ZSh0aGlzLCBvcHRfZGF0YSwgMCwgLTEsIG51bGwsIG51bGwpOwp9OwoKZ29vZy5pbmhlcml0cyhwcm90by5wYi5jbXMuU2V0dGxlTGlzdFJlcXVlc3QsIGpzcGIuTWVzc2FnZSk7CgppZiAoZ29vZy5ERUJVRyAmJiAhQ09NUElMRUQpIHsKICAvKioKICAgKiBAcHVibGljCiAgICogQG92ZXJyaWRlCiAgICovCiAgcHJvdG8ucGIuY21zLlNldHRsZUxpc3RSZXF1ZXN0LmRpc3BsYXlOYW1lID0gJ3Byb3RvLnBiLmNtcy5TZXR0bGVMaXN0UmVxdWVzdCc7Cn0KLyoqCiAqIEdlbmVyYXRlZCBieSBKc1BiQ29kZUdlbmVyYXRvci4KICogQHBhcmFtIHtBcnJheT19IG9wdF9kYXRhIE9wdGlvbmFsIGluaXRpYWwgZGF0YSBhcnJheSwgdHlwaWNhbGx5IGZyb20gYQogKiBzZXJ2ZXIgcmVzcG9uc2UsIG9yIGNvbnN0cnVjdGVkIGRpcmVjdGx5IGluIEphdmFzY3JpcHQuIFRoZSBhcnJheSBpcyB1c2VkCiAqIGluIHBsYWNlIGFuZCBiZWNvbWVzIHBhcnQgb2YgdGhlIGNvbnN0cnVjdGVkIG9iamVjdC4gSXQgaXMgbm90IGNsb25lZC4KICogSWYgbm8gZGF0YSBpcyBwcm92aWRlZCwgdGhlIGNvbnN0cnVjdGVkIG9iamVjdCB3aWxsIGJlIGVtcHR5LCBidXQgc3RpbGwKICogdmFsaWQuCiAqIEBleHRlbmRzIHtqc3BiLk1lc3NhZ2V9CiAqIEBjb25zdHJ1Y3RvcgogKi8KCgpwcm90by5wYi5jbXMuU2V0dGxlTGlzdFJlcGx5ID0gZnVuY3Rpb24gKG9wdF9kYXRhKSB7CiAganNwYi5NZXNzYWdlLmluaXRpYWxpemUodGhpcywgb3B0X2RhdGEsIDAsIC0xLCBwcm90by5wYi5jbXMuU2V0dGxlTGlzdFJlcGx5LnJlcGVhdGVkRmllbGRzXywgbnVsbCk7Cn07Cgpnb29nLmluaGVyaXRzKHByb3RvLnBiLmNtcy5TZXR0bGVMaXN0UmVwbHksIGpzcGIuTWVzc2FnZSk7CgppZiAoZ29vZy5ERUJVRyAmJiAhQ09NUElMRUQpIHsKICAvKioKICAgKiBAcHVibGljCiAgICogQG92ZXJyaWRlCiAgICovCiAgcHJvdG8ucGIuY21zLlNldHRsZUxpc3RSZXBseS5kaXNwbGF5TmFtZSA9ICdwcm90by5wYi5jbXMuU2V0dGxlTGlzdFJlcGx5JzsKfQovKioKICogR2VuZXJhdGVkIGJ5IEpzUGJDb2RlR2VuZXJhdG9yLgogKiBAcGFyYW0ge0FycmF5PX0gb3B0X2RhdGEgT3B0aW9uYWwgaW5pdGlhbCBkYXRhIGFycmF5LCB0eXBpY2FsbHkgZnJvbSBhCiAqIHNlcnZlciByZXNwb25zZSwgb3IgY29uc3RydWN0ZWQgZGlyZWN0bHkgaW4gSmF2YXNjcmlwdC4gVGhlIGFycmF5IGlzIHVzZWQKICogaW4gcGxhY2UgYW5kIGJlY29tZXMgcGFydCBvZiB0aGUgY29uc3RydWN0ZWQgb2JqZWN0LiBJdCBpcyBub3QgY2xvbmVkLgogKiBJZiBubyBkYXRhIGlzIHByb3ZpZGVkLCB0aGUgY29uc3RydWN0ZWQgb2JqZWN0IHdpbGwgYmUgZW1wdHksIGJ1dCBzdGlsbAogKiB2YWxpZC4KICogQGV4dGVuZHMge2pzcGIuTWVzc2FnZX0KICogQGNvbnN0cnVjdG9yCiAqLwoKCnByb3RvLnBiLmNtcy5BZG1pbkZpbGVDaHVuayA9IGZ1bmN0aW9uIChvcHRfZGF0YSkgewogIGpzcGIuTWVzc2FnZS5pbml0aWFsaXplKHRoaXMsIG9wdF9kYXRhLCAwLCAtMSwgbnVsbCwgbnVsbCk7Cn07Cgpnb29nLmluaGVyaXRzKHByb3RvLnBiLmNtcy5BZG1pbkZpbGVDaHVuaywganNwYi5NZXNzYWdlKTsKCmlmIChnb29nLkRFQlVHICYmICFDT01QSUxFRCkgewogIC8qKgogICAqIEBwdWJsaWMKICAgKiBAb3ZlcnJpZGUKICAgKi8KICBwcm90by5wYi5jbXMuQWRtaW5GaWxlQ2h1bmsuZGlzcGxheU5hbWUgPSAncHJvdG8ucGIuY21zLkFkbWluRmlsZUNodW5rJzsKfQovKioKICogTGlzdCBvZiByZXBlYXRlZCBmaWVsZHMgd2l0aGluIHRoaXMgbWVzc2FnZSB0eXBlLgogKiBAcHJpdmF0ZSB7IUFycmF5PG51bWJlcj59CiAqIEBjb25zdAogKi8KCgpwcm90by5wYi5jbXMuQXJlYUxpc3RSZXBseS5yZXBlYXRlZEZpZWxkc18gPSBbMV07CgppZiAoanNwYi5NZXNzYWdlLkdFTkVSQVRFX1RPX09CSkVDVCkgewogIC8qKgogICAqIENyZWF0ZXMgYW4gb2JqZWN0IHJlcHJlc2VudGF0aW9uIG9mIHRoaXMgcHJvdG8uCiAgICogRmllbGQgbmFtZXMgdGhhdCBhcmUgcmVzZXJ2ZWQgaW4gSmF2YVNjcmlwdCBhbmQgd2lsbCBiZSByZW5hbWVkIHRvIHBiX25hbWUuCiAgICogT3B0aW9uYWwgZmllbGRzIHRoYXQgYXJlIG5vdCBzZXQgd2lsbCBiZSBzZXQgdG8gdW5kZWZpbmVkLgogICAqIFRvIGFjY2VzcyBhIHJlc2VydmVkIGZpZWxkIHVzZSwgZm9vLnBiXzxuYW1lPiwgZWcsIGZvby5wYl9kZWZhdWx0LgogICAqIEZvciB0aGUgbGlzdCBvZiByZXNlcnZlZCBuYW1lcyBwbGVhc2Ugc2VlOgogICAqICAgICBuZXQvcHJvdG8yL2NvbXBpbGVyL2pzL2ludGVybmFsL2dlbmVyYXRvci5jYyNrS2V5d29yZC4KICAgKiBAcGFyYW0ge2Jvb2xlYW49fSBvcHRfaW5jbHVkZUluc3RhbmNlIERlcHJlY2F0ZWQuIHdoZXRoZXIgdG8gaW5jbHVkZSB0aGUKICAgKiAgICAgSlNQQiBpbnN0YW5jZSBmb3IgdHJhbnNpdGlvbmFsIHNveSBwcm90byBzdXBwb3J0OgogICAqICAgICBodHRwOi8vZ290by9zb3ktcGFyYW0tbWlncmF0aW9uCiAgICogQHJldHVybiB7IU9iamVjdH0KICAgKi8KICBwcm90by5wYi5jbXMuQXJlYUxpc3RSZXBseS5wcm90b3R5cGUudG9PYmplY3QgPSBmdW5jdGlvbiAob3B0X2luY2x1ZGVJbnN0YW5jZSkgewogICAgcmV0dXJuIHByb3RvLnBiLmNtcy5BcmVhTGlzdFJlcGx5LnRvT2JqZWN0KG9wdF9pbmNsdWRlSW5zdGFuY2UsIHRoaXMpOwogIH07CiAgLyoqCiAgICogU3RhdGljIHZlcnNpb24gb2YgdGhlIHtAc2VlIHRvT2JqZWN0fSBtZXRob2QuCiAgICogQHBhcmFtIHtib29sZWFufHVuZGVmaW5lZH0gaW5jbHVkZUluc3RhbmNlIERlcHJlY2F0ZWQuIFdoZXRoZXIgdG8gaW5jbHVkZQogICAqICAgICB0aGUgSlNQQiBpbnN0YW5jZSBmb3IgdHJhbnNpdGlvbmFsIHNveSBwcm90byBzdXBwb3J0OgogICAqICAgICBodHRwOi8vZ290by9zb3ktcGFyYW0tbWlncmF0aW9uCiAgICogQHBhcmFtIHshcHJvdG8ucGIuY21zLkFyZWFMaXN0UmVwbHl9IG1zZyBUaGUgbXNnIGluc3RhbmNlIHRvIHRyYW5zZm9ybS4KICAgKiBAcmV0dXJuIHshT2JqZWN0fQogICAqIEBzdXBwcmVzcyB7dW51c2VkTG9jYWxWYXJpYWJsZXN9IGYgaXMgb25seSB1c2VkIGZvciBuZXN0ZWQgbWVzc2FnZXMKICAgKi8KCgogIHByb3RvLnBiLmNtcy5BcmVhTGlzdFJlcGx5LnRvT2JqZWN0ID0gZnVuY3Rpb24gKGluY2x1ZGVJbnN0YW5jZSwgbXNnKSB7CiAgICB2YXIgZiwKICAgICAgICBvYmogPSB7CiAgICAgIGFyZWFzTGlzdDoganNwYi5NZXNzYWdlLnRvT2JqZWN0TGlzdChtc2cuZ2V0QXJlYXNMaXN0KCksIHVzZXJ0eXBlX3BiLkFyZWEudG9PYmplY3QsIGluY2x1ZGVJbnN0YW5jZSkKICAgIH07CgogICAgaWYgKGluY2x1ZGVJbnN0YW5jZSkgewogICAgICBvYmouJGpzcGJNZXNzYWdlSW5zdGFuY2UgPSBtc2c7CiAgICB9CgogICAgcmV0dXJuIG9iajsKICB9Owp9Ci8qKgogKiBEZXNlcmlhbGl6ZXMgYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUgZm9ybWF0KS4KICogQHBhcmFtIHtqc3BiLkJ5dGVTb3VyY2V9IGJ5dGVzIFRoZSBieXRlcyB0byBkZXNlcmlhbGl6ZS4KICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5BcmVhTGlzdFJlcGx5fQogKi8KCgpwcm90by5wYi5jbXMuQXJlYUxpc3RSZXBseS5kZXNlcmlhbGl6ZUJpbmFyeSA9IGZ1bmN0aW9uIChieXRlcykgewogIHZhciByZWFkZXIgPSBuZXcganNwYi5CaW5hcnlSZWFkZXIoYnl0ZXMpOwogIHZhciBtc2cgPSBuZXcgcHJvdG8ucGIuY21zLkFyZWFMaXN0UmVwbHkoKTsKICByZXR1cm4gcHJvdG8ucGIuY21zLkFyZWFMaXN0UmVwbHkuZGVzZXJpYWxpemVCaW5hcnlGcm9tUmVhZGVyKG1zZywgcmVhZGVyKTsKfTsKLyoqCiAqIERlc2VyaWFsaXplcyBiaW5hcnkgZGF0YSAoaW4gcHJvdG9idWYgd2lyZSBmb3JtYXQpIGZyb20gdGhlCiAqIGdpdmVuIHJlYWRlciBpbnRvIHRoZSBnaXZlbiBtZXNzYWdlIG9iamVjdC4KICogQHBhcmFtIHshcHJvdG8ucGIuY21zLkFyZWFMaXN0UmVwbHl9IG1zZyBUaGUgbWVzc2FnZSBvYmplY3QgdG8gZGVzZXJpYWxpemUgaW50by4KICogQHBhcmFtIHshanNwYi5CaW5hcnlSZWFkZXJ9IHJlYWRlciBUaGUgQmluYXJ5UmVhZGVyIHRvIHVzZS4KICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5BcmVhTGlzdFJlcGx5fQogKi8KCgpwcm90by5wYi5jbXMuQXJlYUxpc3RSZXBseS5kZXNlcmlhbGl6ZUJpbmFyeUZyb21SZWFkZXIgPSBmdW5jdGlvbiAobXNnLCByZWFkZXIpIHsKICB3aGlsZSAocmVhZGVyLm5leHRGaWVsZCgpKSB7CiAgICBpZiAocmVhZGVyLmlzRW5kR3JvdXAoKSkgewogICAgICBicmVhazsKICAgIH0KCiAgICB2YXIgZmllbGQgPSByZWFkZXIuZ2V0RmllbGROdW1iZXIoKTsKCiAgICBzd2l0Y2ggKGZpZWxkKSB7CiAgICAgIGNhc2UgMToKICAgICAgICB2YXIgdmFsdWUgPSBuZXcgdXNlcnR5cGVfcGIuQXJlYSgpOwogICAgICAgIHJlYWRlci5yZWFkTWVzc2FnZSh2YWx1ZSwgdXNlcnR5cGVfcGIuQXJlYS5kZXNlcmlhbGl6ZUJpbmFyeUZyb21SZWFkZXIpOwogICAgICAgIG1zZy5hZGRBcmVhcyh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBkZWZhdWx0OgogICAgICAgIHJlYWRlci5za2lwRmllbGQoKTsKICAgICAgICBicmVhazsKICAgIH0KICB9CgogIHJldHVybiBtc2c7Cn07Ci8qKgogKiBTZXJpYWxpemVzIHRoZSBtZXNzYWdlIHRvIGJpbmFyeSBkYXRhIChpbiBwcm90b2J1ZiB3aXJlIGZvcm1hdCkuCiAqIEByZXR1cm4geyFVaW50OEFycmF5fQogKi8KCgpwcm90by5wYi5jbXMuQXJlYUxpc3RSZXBseS5wcm90b3R5cGUuc2VyaWFsaXplQmluYXJ5ID0gZnVuY3Rpb24gKCkgewogIHZhciB3cml0ZXIgPSBuZXcganNwYi5CaW5hcnlXcml0ZXIoKTsKICBwcm90by5wYi5jbXMuQXJlYUxpc3RSZXBseS5zZXJpYWxpemVCaW5hcnlUb1dyaXRlcih0aGlzLCB3cml0ZXIpOwogIHJldHVybiB3cml0ZXIuZ2V0UmVzdWx0QnVmZmVyKCk7Cn07Ci8qKgogKiBTZXJpYWxpemVzIHRoZSBnaXZlbiBtZXNzYWdlIHRvIGJpbmFyeSBkYXRhIChpbiBwcm90b2J1ZiB3aXJlCiAqIGZvcm1hdCksIHdyaXRpbmcgdG8gdGhlIGdpdmVuIEJpbmFyeVdyaXRlci4KICogQHBhcmFtIHshcHJvdG8ucGIuY21zLkFyZWFMaXN0UmVwbHl9IG1lc3NhZ2UKICogQHBhcmFtIHshanNwYi5CaW5hcnlXcml0ZXJ9IHdyaXRlcgogKiBAc3VwcHJlc3Mge3VudXNlZExvY2FsVmFyaWFibGVzfSBmIGlzIG9ubHkgdXNlZCBmb3IgbmVzdGVkIG1lc3NhZ2VzCiAqLwoKCnByb3RvLnBiLmNtcy5BcmVhTGlzdFJlcGx5LnNlcmlhbGl6ZUJpbmFyeVRvV3JpdGVyID0gZnVuY3Rpb24gKG1lc3NhZ2UsIHdyaXRlcikgewogIHZhciBmID0gdW5kZWZpbmVkOwogIGYgPSBtZXNzYWdlLmdldEFyZWFzTGlzdCgpOwoKICBpZiAoZi5sZW5ndGggPiAwKSB7CiAgICB3cml0ZXIud3JpdGVSZXBlYXRlZE1lc3NhZ2UoMSwgZiwgdXNlcnR5cGVfcGIuQXJlYS5zZXJpYWxpemVCaW5hcnlUb1dyaXRlcik7CiAgfQp9OwovKioKICogcmVwZWF0ZWQgcGIuQXJlYSBhcmVhcyA9IDE7CiAqIEByZXR1cm4geyFBcnJheTwhcHJvdG8ucGIuQXJlYT59CiAqLwoKCnByb3RvLnBiLmNtcy5BcmVhTGlzdFJlcGx5LnByb3RvdHlwZS5nZXRBcmVhc0xpc3QgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRSZXBlYXRlZFdyYXBwZXJGaWVsZCh0aGlzLCB1c2VydHlwZV9wYi5BcmVhLCAxKTsKfTsKLyoqCiAqIEBwYXJhbSB7IUFycmF5PCFwcm90by5wYi5BcmVhPn0gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5BcmVhTGlzdFJlcGx5fSByZXR1cm5zIHRoaXMKKi8KCgpwcm90by5wYi5jbXMuQXJlYUxpc3RSZXBseS5wcm90b3R5cGUuc2V0QXJlYXNMaXN0ID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRSZXBlYXRlZFdyYXBwZXJGaWVsZCh0aGlzLCAxLCB2YWx1ZSk7Cn07Ci8qKgogKiBAcGFyYW0geyFwcm90by5wYi5BcmVhPX0gb3B0X3ZhbHVlCiAqIEBwYXJhbSB7bnVtYmVyPX0gb3B0X2luZGV4CiAqIEByZXR1cm4geyFwcm90by5wYi5BcmVhfQogKi8KCgpwcm90by5wYi5jbXMuQXJlYUxpc3RSZXBseS5wcm90b3R5cGUuYWRkQXJlYXMgPSBmdW5jdGlvbiAob3B0X3ZhbHVlLCBvcHRfaW5kZXgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmFkZFRvUmVwZWF0ZWRXcmFwcGVyRmllbGQodGhpcywgMSwgb3B0X3ZhbHVlLCBwcm90by5wYi5BcmVhLCBvcHRfaW5kZXgpOwp9OwovKioKICogQ2xlYXJzIHRoZSBsaXN0IG1ha2luZyBpdCBlbXB0eSBidXQgbm9uLW51bGwuCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuQXJlYUxpc3RSZXBseX0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5BcmVhTGlzdFJlcGx5LnByb3RvdHlwZS5jbGVhckFyZWFzTGlzdCA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4gdGhpcy5zZXRBcmVhc0xpc3QoW10pOwp9OwoKaWYgKGpzcGIuTWVzc2FnZS5HRU5FUkFURV9UT19PQkpFQ1QpIHsKICAvKioKICAgKiBDcmVhdGVzIGFuIG9iamVjdCByZXByZXNlbnRhdGlvbiBvZiB0aGlzIHByb3RvLgogICAqIEZpZWxkIG5hbWVzIHRoYXQgYXJlIHJlc2VydmVkIGluIEphdmFTY3JpcHQgYW5kIHdpbGwgYmUgcmVuYW1lZCB0byBwYl9uYW1lLgogICAqIE9wdGlvbmFsIGZpZWxkcyB0aGF0IGFyZSBub3Qgc2V0IHdpbGwgYmUgc2V0IHRvIHVuZGVmaW5lZC4KICAgKiBUbyBhY2Nlc3MgYSByZXNlcnZlZCBmaWVsZCB1c2UsIGZvby5wYl88bmFtZT4sIGVnLCBmb28ucGJfZGVmYXVsdC4KICAgKiBGb3IgdGhlIGxpc3Qgb2YgcmVzZXJ2ZWQgbmFtZXMgcGxlYXNlIHNlZToKICAgKiAgICAgbmV0L3Byb3RvMi9jb21waWxlci9qcy9pbnRlcm5hbC9nZW5lcmF0b3IuY2Mja0tleXdvcmQuCiAgICogQHBhcmFtIHtib29sZWFuPX0gb3B0X2luY2x1ZGVJbnN0YW5jZSBEZXByZWNhdGVkLiB3aGV0aGVyIHRvIGluY2x1ZGUgdGhlCiAgICogICAgIEpTUEIgaW5zdGFuY2UgZm9yIHRyYW5zaXRpb25hbCBzb3kgcHJvdG8gc3VwcG9ydDoKICAgKiAgICAgaHR0cDovL2dvdG8vc295LXBhcmFtLW1pZ3JhdGlvbgogICAqIEByZXR1cm4geyFPYmplY3R9CiAgICovCiAgcHJvdG8ucGIuY21zLkxvZ2luUmVxdWVzdC5wcm90b3R5cGUudG9PYmplY3QgPSBmdW5jdGlvbiAob3B0X2luY2x1ZGVJbnN0YW5jZSkgewogICAgcmV0dXJuIHByb3RvLnBiLmNtcy5Mb2dpblJlcXVlc3QudG9PYmplY3Qob3B0X2luY2x1ZGVJbnN0YW5jZSwgdGhpcyk7CiAgfTsKICAvKioKICAgKiBTdGF0aWMgdmVyc2lvbiBvZiB0aGUge0BzZWUgdG9PYmplY3R9IG1ldGhvZC4KICAgKiBAcGFyYW0ge2Jvb2xlYW58dW5kZWZpbmVkfSBpbmNsdWRlSW5zdGFuY2UgRGVwcmVjYXRlZC4gV2hldGhlciB0byBpbmNsdWRlCiAgICogICAgIHRoZSBKU1BCIGluc3RhbmNlIGZvciB0cmFuc2l0aW9uYWwgc295IHByb3RvIHN1cHBvcnQ6CiAgICogICAgIGh0dHA6Ly9nb3RvL3NveS1wYXJhbS1taWdyYXRpb24KICAgKiBAcGFyYW0geyFwcm90by5wYi5jbXMuTG9naW5SZXF1ZXN0fSBtc2cgVGhlIG1zZyBpbnN0YW5jZSB0byB0cmFuc2Zvcm0uCiAgICogQHJldHVybiB7IU9iamVjdH0KICAgKiBAc3VwcHJlc3Mge3VudXNlZExvY2FsVmFyaWFibGVzfSBmIGlzIG9ubHkgdXNlZCBmb3IgbmVzdGVkIG1lc3NhZ2VzCiAgICovCgoKICBwcm90by5wYi5jbXMuTG9naW5SZXF1ZXN0LnRvT2JqZWN0ID0gZnVuY3Rpb24gKGluY2x1ZGVJbnN0YW5jZSwgbXNnKSB7CiAgICB2YXIgZiwKICAgICAgICBvYmogPSB7CiAgICAgIGVtYWlsOiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdChtc2csIDEsICIiKSwKICAgICAgcGFzc3dvcmQ6IGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KG1zZywgMiwgIiIpCiAgICB9OwoKICAgIGlmIChpbmNsdWRlSW5zdGFuY2UpIHsKICAgICAgb2JqLiRqc3BiTWVzc2FnZUluc3RhbmNlID0gbXNnOwogICAgfQoKICAgIHJldHVybiBvYmo7CiAgfTsKfQovKioKICogRGVzZXJpYWxpemVzIGJpbmFyeSBkYXRhIChpbiBwcm90b2J1ZiB3aXJlIGZvcm1hdCkuCiAqIEBwYXJhbSB7anNwYi5CeXRlU291cmNlfSBieXRlcyBUaGUgYnl0ZXMgdG8gZGVzZXJpYWxpemUuCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuTG9naW5SZXF1ZXN0fQogKi8KCgpwcm90by5wYi5jbXMuTG9naW5SZXF1ZXN0LmRlc2VyaWFsaXplQmluYXJ5ID0gZnVuY3Rpb24gKGJ5dGVzKSB7CiAgdmFyIHJlYWRlciA9IG5ldyBqc3BiLkJpbmFyeVJlYWRlcihieXRlcyk7CiAgdmFyIG1zZyA9IG5ldyBwcm90by5wYi5jbXMuTG9naW5SZXF1ZXN0KCk7CiAgcmV0dXJuIHByb3RvLnBiLmNtcy5Mb2dpblJlcXVlc3QuZGVzZXJpYWxpemVCaW5hcnlGcm9tUmVhZGVyKG1zZywgcmVhZGVyKTsKfTsKLyoqCiAqIERlc2VyaWFsaXplcyBiaW5hcnkgZGF0YSAoaW4gcHJvdG9idWYgd2lyZSBmb3JtYXQpIGZyb20gdGhlCiAqIGdpdmVuIHJlYWRlciBpbnRvIHRoZSBnaXZlbiBtZXNzYWdlIG9iamVjdC4KICogQHBhcmFtIHshcHJvdG8ucGIuY21zLkxvZ2luUmVxdWVzdH0gbXNnIFRoZSBtZXNzYWdlIG9iamVjdCB0byBkZXNlcmlhbGl6ZSBpbnRvLgogKiBAcGFyYW0geyFqc3BiLkJpbmFyeVJlYWRlcn0gcmVhZGVyIFRoZSBCaW5hcnlSZWFkZXIgdG8gdXNlLgogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLkxvZ2luUmVxdWVzdH0KICovCgoKcHJvdG8ucGIuY21zLkxvZ2luUmVxdWVzdC5kZXNlcmlhbGl6ZUJpbmFyeUZyb21SZWFkZXIgPSBmdW5jdGlvbiAobXNnLCByZWFkZXIpIHsKICB3aGlsZSAocmVhZGVyLm5leHRGaWVsZCgpKSB7CiAgICBpZiAocmVhZGVyLmlzRW5kR3JvdXAoKSkgewogICAgICBicmVhazsKICAgIH0KCiAgICB2YXIgZmllbGQgPSByZWFkZXIuZ2V0RmllbGROdW1iZXIoKTsKCiAgICBzd2l0Y2ggKGZpZWxkKSB7CiAgICAgIGNhc2UgMToKICAgICAgICB2YXIgdmFsdWUgPSByZWFkZXIucmVhZFN0cmluZygpOwogICAgICAgIG1zZy5zZXRFbWFpbCh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlIDI6CiAgICAgICAgdmFyIHZhbHVlID0gcmVhZGVyLnJlYWRTdHJpbmcoKTsKICAgICAgICBtc2cuc2V0UGFzc3dvcmQodmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgZGVmYXVsdDoKICAgICAgICByZWFkZXIuc2tpcEZpZWxkKCk7CiAgICAgICAgYnJlYWs7CiAgICB9CiAgfQoKICByZXR1cm4gbXNnOwp9OwovKioKICogU2VyaWFsaXplcyB0aGUgbWVzc2FnZSB0byBiaW5hcnkgZGF0YSAoaW4gcHJvdG9idWYgd2lyZSBmb3JtYXQpLgogKiBAcmV0dXJuIHshVWludDhBcnJheX0KICovCgoKcHJvdG8ucGIuY21zLkxvZ2luUmVxdWVzdC5wcm90b3R5cGUuc2VyaWFsaXplQmluYXJ5ID0gZnVuY3Rpb24gKCkgewogIHZhciB3cml0ZXIgPSBuZXcganNwYi5CaW5hcnlXcml0ZXIoKTsKICBwcm90by5wYi5jbXMuTG9naW5SZXF1ZXN0LnNlcmlhbGl6ZUJpbmFyeVRvV3JpdGVyKHRoaXMsIHdyaXRlcik7CiAgcmV0dXJuIHdyaXRlci5nZXRSZXN1bHRCdWZmZXIoKTsKfTsKLyoqCiAqIFNlcmlhbGl6ZXMgdGhlIGdpdmVuIG1lc3NhZ2UgdG8gYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUKICogZm9ybWF0KSwgd3JpdGluZyB0byB0aGUgZ2l2ZW4gQmluYXJ5V3JpdGVyLgogKiBAcGFyYW0geyFwcm90by5wYi5jbXMuTG9naW5SZXF1ZXN0fSBtZXNzYWdlCiAqIEBwYXJhbSB7IWpzcGIuQmluYXJ5V3JpdGVyfSB3cml0ZXIKICogQHN1cHByZXNzIHt1bnVzZWRMb2NhbFZhcmlhYmxlc30gZiBpcyBvbmx5IHVzZWQgZm9yIG5lc3RlZCBtZXNzYWdlcwogKi8KCgpwcm90by5wYi5jbXMuTG9naW5SZXF1ZXN0LnNlcmlhbGl6ZUJpbmFyeVRvV3JpdGVyID0gZnVuY3Rpb24gKG1lc3NhZ2UsIHdyaXRlcikgewogIHZhciBmID0gdW5kZWZpbmVkOwogIGYgPSBtZXNzYWdlLmdldEVtYWlsKCk7CgogIGlmIChmLmxlbmd0aCA+IDApIHsKICAgIHdyaXRlci53cml0ZVN0cmluZygxLCBmKTsKICB9CgogIGYgPSBtZXNzYWdlLmdldFBhc3N3b3JkKCk7CgogIGlmIChmLmxlbmd0aCA+IDApIHsKICAgIHdyaXRlci53cml0ZVN0cmluZygyLCBmKTsKICB9Cn07Ci8qKgogKiBvcHRpb25hbCBzdHJpbmcgZW1haWwgPSAxOwogKiBAcmV0dXJuIHtzdHJpbmd9CiAqLwoKCnByb3RvLnBiLmNtcy5Mb2dpblJlcXVlc3QucHJvdG90eXBlLmdldEVtYWlsID0gZnVuY3Rpb24gKCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdCh0aGlzLCAxLCAiIik7Cn07Ci8qKgogKiBAcGFyYW0ge3N0cmluZ30gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5Mb2dpblJlcXVlc3R9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuTG9naW5SZXF1ZXN0LnByb3RvdHlwZS5zZXRFbWFpbCA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UHJvdG8zU3RyaW5nRmllbGQodGhpcywgMSwgdmFsdWUpOwp9OwovKioKICogb3B0aW9uYWwgc3RyaW5nIHBhc3N3b3JkID0gMjsKICogQHJldHVybiB7c3RyaW5nfQogKi8KCgpwcm90by5wYi5jbXMuTG9naW5SZXF1ZXN0LnByb3RvdHlwZS5nZXRQYXNzd29yZCA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQodGhpcywgMiwgIiIpOwp9OwovKioKICogQHBhcmFtIHtzdHJpbmd9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuTG9naW5SZXF1ZXN0fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLkxvZ2luUmVxdWVzdC5wcm90b3R5cGUuc2V0UGFzc3dvcmQgPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM1N0cmluZ0ZpZWxkKHRoaXMsIDIsIHZhbHVlKTsKfTsKCmlmIChqc3BiLk1lc3NhZ2UuR0VORVJBVEVfVE9fT0JKRUNUKSB7CiAgLyoqCiAgICogQ3JlYXRlcyBhbiBvYmplY3QgcmVwcmVzZW50YXRpb24gb2YgdGhpcyBwcm90by4KICAgKiBGaWVsZCBuYW1lcyB0aGF0IGFyZSByZXNlcnZlZCBpbiBKYXZhU2NyaXB0IGFuZCB3aWxsIGJlIHJlbmFtZWQgdG8gcGJfbmFtZS4KICAgKiBPcHRpb25hbCBmaWVsZHMgdGhhdCBhcmUgbm90IHNldCB3aWxsIGJlIHNldCB0byB1bmRlZmluZWQuCiAgICogVG8gYWNjZXNzIGEgcmVzZXJ2ZWQgZmllbGQgdXNlLCBmb28ucGJfPG5hbWU+LCBlZywgZm9vLnBiX2RlZmF1bHQuCiAgICogRm9yIHRoZSBsaXN0IG9mIHJlc2VydmVkIG5hbWVzIHBsZWFzZSBzZWU6CiAgICogICAgIG5ldC9wcm90bzIvY29tcGlsZXIvanMvaW50ZXJuYWwvZ2VuZXJhdG9yLmNjI2tLZXl3b3JkLgogICAqIEBwYXJhbSB7Ym9vbGVhbj19IG9wdF9pbmNsdWRlSW5zdGFuY2UgRGVwcmVjYXRlZC4gd2hldGhlciB0byBpbmNsdWRlIHRoZQogICAqICAgICBKU1BCIGluc3RhbmNlIGZvciB0cmFuc2l0aW9uYWwgc295IHByb3RvIHN1cHBvcnQ6CiAgICogICAgIGh0dHA6Ly9nb3RvL3NveS1wYXJhbS1taWdyYXRpb24KICAgKiBAcmV0dXJuIHshT2JqZWN0fQogICAqLwogIHByb3RvLnBiLmNtcy5PdmVydmlld1JlcXVlc3QucHJvdG90eXBlLnRvT2JqZWN0ID0gZnVuY3Rpb24gKG9wdF9pbmNsdWRlSW5zdGFuY2UpIHsKICAgIHJldHVybiBwcm90by5wYi5jbXMuT3ZlcnZpZXdSZXF1ZXN0LnRvT2JqZWN0KG9wdF9pbmNsdWRlSW5zdGFuY2UsIHRoaXMpOwogIH07CiAgLyoqCiAgICogU3RhdGljIHZlcnNpb24gb2YgdGhlIHtAc2VlIHRvT2JqZWN0fSBtZXRob2QuCiAgICogQHBhcmFtIHtib29sZWFufHVuZGVmaW5lZH0gaW5jbHVkZUluc3RhbmNlIERlcHJlY2F0ZWQuIFdoZXRoZXIgdG8gaW5jbHVkZQogICAqICAgICB0aGUgSlNQQiBpbnN0YW5jZSBmb3IgdHJhbnNpdGlvbmFsIHNveSBwcm90byBzdXBwb3J0OgogICAqICAgICBodHRwOi8vZ290by9zb3ktcGFyYW0tbWlncmF0aW9uCiAgICogQHBhcmFtIHshcHJvdG8ucGIuY21zLk92ZXJ2aWV3UmVxdWVzdH0gbXNnIFRoZSBtc2cgaW5zdGFuY2UgdG8gdHJhbnNmb3JtLgogICAqIEByZXR1cm4geyFPYmplY3R9CiAgICogQHN1cHByZXNzIHt1bnVzZWRMb2NhbFZhcmlhYmxlc30gZiBpcyBvbmx5IHVzZWQgZm9yIG5lc3RlZCBtZXNzYWdlcwogICAqLwoKCiAgcHJvdG8ucGIuY21zLk92ZXJ2aWV3UmVxdWVzdC50b09iamVjdCA9IGZ1bmN0aW9uIChpbmNsdWRlSW5zdGFuY2UsIG1zZykgewogICAgdmFyIGYsCiAgICAgICAgb2JqID0gewogICAgICBhcmVhSWQ6IGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KG1zZywgMSwgMCksCiAgICAgIHN0YXJ0QXQ6IGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KG1zZywgMiwgMCksCiAgICAgIGVuZEF0OiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdChtc2csIDMsIDApCiAgICB9OwoKICAgIGlmIChpbmNsdWRlSW5zdGFuY2UpIHsKICAgICAgb2JqLiRqc3BiTWVzc2FnZUluc3RhbmNlID0gbXNnOwogICAgfQoKICAgIHJldHVybiBvYmo7CiAgfTsKfQovKioKICogRGVzZXJpYWxpemVzIGJpbmFyeSBkYXRhIChpbiBwcm90b2J1ZiB3aXJlIGZvcm1hdCkuCiAqIEBwYXJhbSB7anNwYi5CeXRlU291cmNlfSBieXRlcyBUaGUgYnl0ZXMgdG8gZGVzZXJpYWxpemUuCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuT3ZlcnZpZXdSZXF1ZXN0fQogKi8KCgpwcm90by5wYi5jbXMuT3ZlcnZpZXdSZXF1ZXN0LmRlc2VyaWFsaXplQmluYXJ5ID0gZnVuY3Rpb24gKGJ5dGVzKSB7CiAgdmFyIHJlYWRlciA9IG5ldyBqc3BiLkJpbmFyeVJlYWRlcihieXRlcyk7CiAgdmFyIG1zZyA9IG5ldyBwcm90by5wYi5jbXMuT3ZlcnZpZXdSZXF1ZXN0KCk7CiAgcmV0dXJuIHByb3RvLnBiLmNtcy5PdmVydmlld1JlcXVlc3QuZGVzZXJpYWxpemVCaW5hcnlGcm9tUmVhZGVyKG1zZywgcmVhZGVyKTsKfTsKLyoqCiAqIERlc2VyaWFsaXplcyBiaW5hcnkgZGF0YSAoaW4gcHJvdG9idWYgd2lyZSBmb3JtYXQpIGZyb20gdGhlCiAqIGdpdmVuIHJlYWRlciBpbnRvIHRoZSBnaXZlbiBtZXNzYWdlIG9iamVjdC4KICogQHBhcmFtIHshcHJvdG8ucGIuY21zLk92ZXJ2aWV3UmVxdWVzdH0gbXNnIFRoZSBtZXNzYWdlIG9iamVjdCB0byBkZXNlcmlhbGl6ZSBpbnRvLgogKiBAcGFyYW0geyFqc3BiLkJpbmFyeVJlYWRlcn0gcmVhZGVyIFRoZSBCaW5hcnlSZWFkZXIgdG8gdXNlLgogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLk92ZXJ2aWV3UmVxdWVzdH0KICovCgoKcHJvdG8ucGIuY21zLk92ZXJ2aWV3UmVxdWVzdC5kZXNlcmlhbGl6ZUJpbmFyeUZyb21SZWFkZXIgPSBmdW5jdGlvbiAobXNnLCByZWFkZXIpIHsKICB3aGlsZSAocmVhZGVyLm5leHRGaWVsZCgpKSB7CiAgICBpZiAocmVhZGVyLmlzRW5kR3JvdXAoKSkgewogICAgICBicmVhazsKICAgIH0KCiAgICB2YXIgZmllbGQgPSByZWFkZXIuZ2V0RmllbGROdW1iZXIoKTsKCiAgICBzd2l0Y2ggKGZpZWxkKSB7CiAgICAgIGNhc2UgMToKICAgICAgICB2YXIgdmFsdWUgPSByZWFkZXIucmVhZFVpbnQzMigpOwogICAgICAgIG1zZy5zZXRBcmVhSWQodmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSAyOgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkVWludDMyKCk7CiAgICAgICAgbXNnLnNldFN0YXJ0QXQodmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSAzOgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkVWludDMyKCk7CiAgICAgICAgbXNnLnNldEVuZEF0KHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGRlZmF1bHQ6CiAgICAgICAgcmVhZGVyLnNraXBGaWVsZCgpOwogICAgICAgIGJyZWFrOwogICAgfQogIH0KCiAgcmV0dXJuIG1zZzsKfTsKLyoqCiAqIFNlcmlhbGl6ZXMgdGhlIG1lc3NhZ2UgdG8gYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUgZm9ybWF0KS4KICogQHJldHVybiB7IVVpbnQ4QXJyYXl9CiAqLwoKCnByb3RvLnBiLmNtcy5PdmVydmlld1JlcXVlc3QucHJvdG90eXBlLnNlcmlhbGl6ZUJpbmFyeSA9IGZ1bmN0aW9uICgpIHsKICB2YXIgd3JpdGVyID0gbmV3IGpzcGIuQmluYXJ5V3JpdGVyKCk7CiAgcHJvdG8ucGIuY21zLk92ZXJ2aWV3UmVxdWVzdC5zZXJpYWxpemVCaW5hcnlUb1dyaXRlcih0aGlzLCB3cml0ZXIpOwogIHJldHVybiB3cml0ZXIuZ2V0UmVzdWx0QnVmZmVyKCk7Cn07Ci8qKgogKiBTZXJpYWxpemVzIHRoZSBnaXZlbiBtZXNzYWdlIHRvIGJpbmFyeSBkYXRhIChpbiBwcm90b2J1ZiB3aXJlCiAqIGZvcm1hdCksIHdyaXRpbmcgdG8gdGhlIGdpdmVuIEJpbmFyeVdyaXRlci4KICogQHBhcmFtIHshcHJvdG8ucGIuY21zLk92ZXJ2aWV3UmVxdWVzdH0gbWVzc2FnZQogKiBAcGFyYW0geyFqc3BiLkJpbmFyeVdyaXRlcn0gd3JpdGVyCiAqIEBzdXBwcmVzcyB7dW51c2VkTG9jYWxWYXJpYWJsZXN9IGYgaXMgb25seSB1c2VkIGZvciBuZXN0ZWQgbWVzc2FnZXMKICovCgoKcHJvdG8ucGIuY21zLk92ZXJ2aWV3UmVxdWVzdC5zZXJpYWxpemVCaW5hcnlUb1dyaXRlciA9IGZ1bmN0aW9uIChtZXNzYWdlLCB3cml0ZXIpIHsKICB2YXIgZiA9IHVuZGVmaW5lZDsKICBmID0gbWVzc2FnZS5nZXRBcmVhSWQoKTsKCiAgaWYgKGYgIT09IDApIHsKICAgIHdyaXRlci53cml0ZVVpbnQzMigxLCBmKTsKICB9CgogIGYgPSBtZXNzYWdlLmdldFN0YXJ0QXQoKTsKCiAgaWYgKGYgIT09IDApIHsKICAgIHdyaXRlci53cml0ZVVpbnQzMigyLCBmKTsKICB9CgogIGYgPSBtZXNzYWdlLmdldEVuZEF0KCk7CgogIGlmIChmICE9PSAwKSB7CiAgICB3cml0ZXIud3JpdGVVaW50MzIoMywgZik7CiAgfQp9OwovKioKICogb3B0aW9uYWwgdWludDMyIGFyZWFfaWQgPSAxOwogKiBAcmV0dXJuIHtudW1iZXJ9CiAqLwoKCnByb3RvLnBiLmNtcy5PdmVydmlld1JlcXVlc3QucHJvdG90eXBlLmdldEFyZWFJZCA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQodGhpcywgMSwgMCk7Cn07Ci8qKgogKiBAcGFyYW0ge251bWJlcn0gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5PdmVydmlld1JlcXVlc3R9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuT3ZlcnZpZXdSZXF1ZXN0LnByb3RvdHlwZS5zZXRBcmVhSWQgPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0ludEZpZWxkKHRoaXMsIDEsIHZhbHVlKTsKfTsKLyoqCiAqIG9wdGlvbmFsIHVpbnQzMiBzdGFydF9hdCA9IDI7CiAqIEByZXR1cm4ge251bWJlcn0KICovCgoKcHJvdG8ucGIuY21zLk92ZXJ2aWV3UmVxdWVzdC5wcm90b3R5cGUuZ2V0U3RhcnRBdCA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQodGhpcywgMiwgMCk7Cn07Ci8qKgogKiBAcGFyYW0ge251bWJlcn0gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5PdmVydmlld1JlcXVlc3R9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuT3ZlcnZpZXdSZXF1ZXN0LnByb3RvdHlwZS5zZXRTdGFydEF0ID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRQcm90bzNJbnRGaWVsZCh0aGlzLCAyLCB2YWx1ZSk7Cn07Ci8qKgogKiBvcHRpb25hbCB1aW50MzIgZW5kX2F0ID0gMzsKICogQHJldHVybiB7bnVtYmVyfQogKi8KCgpwcm90by5wYi5jbXMuT3ZlcnZpZXdSZXF1ZXN0LnByb3RvdHlwZS5nZXRFbmRBdCA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQodGhpcywgMywgMCk7Cn07Ci8qKgogKiBAcGFyYW0ge251bWJlcn0gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5PdmVydmlld1JlcXVlc3R9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuT3ZlcnZpZXdSZXF1ZXN0LnByb3RvdHlwZS5zZXRFbmRBdCA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UHJvdG8zSW50RmllbGQodGhpcywgMywgdmFsdWUpOwp9OwoKaWYgKGpzcGIuTWVzc2FnZS5HRU5FUkFURV9UT19PQkpFQ1QpIHsKICAvKioKICAgKiBDcmVhdGVzIGFuIG9iamVjdCByZXByZXNlbnRhdGlvbiBvZiB0aGlzIHByb3RvLgogICAqIEZpZWxkIG5hbWVzIHRoYXQgYXJlIHJlc2VydmVkIGluIEphdmFTY3JpcHQgYW5kIHdpbGwgYmUgcmVuYW1lZCB0byBwYl9uYW1lLgogICAqIE9wdGlvbmFsIGZpZWxkcyB0aGF0IGFyZSBub3Qgc2V0IHdpbGwgYmUgc2V0IHRvIHVuZGVmaW5lZC4KICAgKiBUbyBhY2Nlc3MgYSByZXNlcnZlZCBmaWVsZCB1c2UsIGZvby5wYl88bmFtZT4sIGVnLCBmb28ucGJfZGVmYXVsdC4KICAgKiBGb3IgdGhlIGxpc3Qgb2YgcmVzZXJ2ZWQgbmFtZXMgcGxlYXNlIHNlZToKICAgKiAgICAgbmV0L3Byb3RvMi9jb21waWxlci9qcy9pbnRlcm5hbC9nZW5lcmF0b3IuY2Mja0tleXdvcmQuCiAgICogQHBhcmFtIHtib29sZWFuPX0gb3B0X2luY2x1ZGVJbnN0YW5jZSBEZXByZWNhdGVkLiB3aGV0aGVyIHRvIGluY2x1ZGUgdGhlCiAgICogICAgIEpTUEIgaW5zdGFuY2UgZm9yIHRyYW5zaXRpb25hbCBzb3kgcHJvdG8gc3VwcG9ydDoKICAgKiAgICAgaHR0cDovL2dvdG8vc295LXBhcmFtLW1pZ3JhdGlvbgogICAqIEByZXR1cm4geyFPYmplY3R9CiAgICovCiAgcHJvdG8ucGIuY21zLk92ZXJ2aWV3UmVwbHkucHJvdG90eXBlLnRvT2JqZWN0ID0gZnVuY3Rpb24gKG9wdF9pbmNsdWRlSW5zdGFuY2UpIHsKICAgIHJldHVybiBwcm90by5wYi5jbXMuT3ZlcnZpZXdSZXBseS50b09iamVjdChvcHRfaW5jbHVkZUluc3RhbmNlLCB0aGlzKTsKICB9OwogIC8qKgogICAqIFN0YXRpYyB2ZXJzaW9uIG9mIHRoZSB7QHNlZSB0b09iamVjdH0gbWV0aG9kLgogICAqIEBwYXJhbSB7Ym9vbGVhbnx1bmRlZmluZWR9IGluY2x1ZGVJbnN0YW5jZSBEZXByZWNhdGVkLiBXaGV0aGVyIHRvIGluY2x1ZGUKICAgKiAgICAgdGhlIEpTUEIgaW5zdGFuY2UgZm9yIHRyYW5zaXRpb25hbCBzb3kgcHJvdG8gc3VwcG9ydDoKICAgKiAgICAgaHR0cDovL2dvdG8vc295LXBhcmFtLW1pZ3JhdGlvbgogICAqIEBwYXJhbSB7IXByb3RvLnBiLmNtcy5PdmVydmlld1JlcGx5fSBtc2cgVGhlIG1zZyBpbnN0YW5jZSB0byB0cmFuc2Zvcm0uCiAgICogQHJldHVybiB7IU9iamVjdH0KICAgKiBAc3VwcHJlc3Mge3VudXNlZExvY2FsVmFyaWFibGVzfSBmIGlzIG9ubHkgdXNlZCBmb3IgbmVzdGVkIG1lc3NhZ2VzCiAgICovCgoKICBwcm90by5wYi5jbXMuT3ZlcnZpZXdSZXBseS50b09iamVjdCA9IGZ1bmN0aW9uIChpbmNsdWRlSW5zdGFuY2UsIG1zZykgewogICAgdmFyIGYsCiAgICAgICAgb2JqID0gewogICAgICBpbmNvbWU6IGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KG1zZywgMSwgMCksCiAgICAgIHBheUNvdW50OiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdChtc2csIDIsIDApLAogICAgICBuZXdVc2VyOiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdChtc2csIDMsIDApLAogICAgICBhY3RpdmVVc2VyOiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdChtc2csIDQsIDApLAogICAgICBidXN5QW5jaG9yOiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdChtc2csIDUsIDApLAogICAgICBvbmxpbmVBbmNob3I6IGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KG1zZywgNiwgMCksCiAgICAgIHJldmlld0FuY2hvcjoganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQobXNnLCA3LCAwKSwKICAgICAgcmV2aWV3UHJvZmlsZToganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQobXNnLCA4LCAwKSwKICAgICAgcmV2aWV3VmlkZW86IGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KG1zZywgOSwgMCksCiAgICAgIG5ld0Ftb3VudDoganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQobXNnLCAxMCwgMCksCiAgICAgIGV4cGVuc2VBbW91bnQ6IGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KG1zZywgMTEsIDApLAogICAgICB0b3RhbEFtb3VudDoganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQobXNnLCAxMiwgMCkKICAgIH07CgogICAgaWYgKGluY2x1ZGVJbnN0YW5jZSkgewogICAgICBvYmouJGpzcGJNZXNzYWdlSW5zdGFuY2UgPSBtc2c7CiAgICB9CgogICAgcmV0dXJuIG9iajsKICB9Owp9Ci8qKgogKiBEZXNlcmlhbGl6ZXMgYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUgZm9ybWF0KS4KICogQHBhcmFtIHtqc3BiLkJ5dGVTb3VyY2V9IGJ5dGVzIFRoZSBieXRlcyB0byBkZXNlcmlhbGl6ZS4KICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5PdmVydmlld1JlcGx5fQogKi8KCgpwcm90by5wYi5jbXMuT3ZlcnZpZXdSZXBseS5kZXNlcmlhbGl6ZUJpbmFyeSA9IGZ1bmN0aW9uIChieXRlcykgewogIHZhciByZWFkZXIgPSBuZXcganNwYi5CaW5hcnlSZWFkZXIoYnl0ZXMpOwogIHZhciBtc2cgPSBuZXcgcHJvdG8ucGIuY21zLk92ZXJ2aWV3UmVwbHkoKTsKICByZXR1cm4gcHJvdG8ucGIuY21zLk92ZXJ2aWV3UmVwbHkuZGVzZXJpYWxpemVCaW5hcnlGcm9tUmVhZGVyKG1zZywgcmVhZGVyKTsKfTsKLyoqCiAqIERlc2VyaWFsaXplcyBiaW5hcnkgZGF0YSAoaW4gcHJvdG9idWYgd2lyZSBmb3JtYXQpIGZyb20gdGhlCiAqIGdpdmVuIHJlYWRlciBpbnRvIHRoZSBnaXZlbiBtZXNzYWdlIG9iamVjdC4KICogQHBhcmFtIHshcHJvdG8ucGIuY21zLk92ZXJ2aWV3UmVwbHl9IG1zZyBUaGUgbWVzc2FnZSBvYmplY3QgdG8gZGVzZXJpYWxpemUgaW50by4KICogQHBhcmFtIHshanNwYi5CaW5hcnlSZWFkZXJ9IHJlYWRlciBUaGUgQmluYXJ5UmVhZGVyIHRvIHVzZS4KICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5PdmVydmlld1JlcGx5fQogKi8KCgpwcm90by5wYi5jbXMuT3ZlcnZpZXdSZXBseS5kZXNlcmlhbGl6ZUJpbmFyeUZyb21SZWFkZXIgPSBmdW5jdGlvbiAobXNnLCByZWFkZXIpIHsKICB3aGlsZSAocmVhZGVyLm5leHRGaWVsZCgpKSB7CiAgICBpZiAocmVhZGVyLmlzRW5kR3JvdXAoKSkgewogICAgICBicmVhazsKICAgIH0KCiAgICB2YXIgZmllbGQgPSByZWFkZXIuZ2V0RmllbGROdW1iZXIoKTsKCiAgICBzd2l0Y2ggKGZpZWxkKSB7CiAgICAgIGNhc2UgMToKICAgICAgICB2YXIgdmFsdWUgPSByZWFkZXIucmVhZFVpbnQzMigpOwogICAgICAgIG1zZy5zZXRJbmNvbWUodmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSAyOgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkVWludDMyKCk7CiAgICAgICAgbXNnLnNldFBheUNvdW50KHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgMzoKICAgICAgICB2YXIgdmFsdWUgPSByZWFkZXIucmVhZFVpbnQzMigpOwogICAgICAgIG1zZy5zZXROZXdVc2VyKHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgNDoKICAgICAgICB2YXIgdmFsdWUgPSByZWFkZXIucmVhZFVpbnQzMigpOwogICAgICAgIG1zZy5zZXRBY3RpdmVVc2VyKHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgNToKICAgICAgICB2YXIgdmFsdWUgPSByZWFkZXIucmVhZFVpbnQzMigpOwogICAgICAgIG1zZy5zZXRCdXN5QW5jaG9yKHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgNjoKICAgICAgICB2YXIgdmFsdWUgPSByZWFkZXIucmVhZFVpbnQzMigpOwogICAgICAgIG1zZy5zZXRPbmxpbmVBbmNob3IodmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSA3OgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkVWludDMyKCk7CiAgICAgICAgbXNnLnNldFJldmlld0FuY2hvcih2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlIDg6CiAgICAgICAgdmFyIHZhbHVlID0gcmVhZGVyLnJlYWRVaW50MzIoKTsKICAgICAgICBtc2cuc2V0UmV2aWV3UHJvZmlsZSh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlIDk6CiAgICAgICAgdmFyIHZhbHVlID0gcmVhZGVyLnJlYWRVaW50MzIoKTsKICAgICAgICBtc2cuc2V0UmV2aWV3VmlkZW8odmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSAxMDoKICAgICAgICB2YXIgdmFsdWUgPSByZWFkZXIucmVhZFVpbnQ2NCgpOwogICAgICAgIG1zZy5zZXROZXdBbW91bnQodmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSAxMToKICAgICAgICB2YXIgdmFsdWUgPSByZWFkZXIucmVhZFVpbnQ2NCgpOwogICAgICAgIG1zZy5zZXRFeHBlbnNlQW1vdW50KHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgMTI6CiAgICAgICAgdmFyIHZhbHVlID0gcmVhZGVyLnJlYWRVaW50NjQoKTsKICAgICAgICBtc2cuc2V0VG90YWxBbW91bnQodmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgZGVmYXVsdDoKICAgICAgICByZWFkZXIuc2tpcEZpZWxkKCk7CiAgICAgICAgYnJlYWs7CiAgICB9CiAgfQoKICByZXR1cm4gbXNnOwp9OwovKioKICogU2VyaWFsaXplcyB0aGUgbWVzc2FnZSB0byBiaW5hcnkgZGF0YSAoaW4gcHJvdG9idWYgd2lyZSBmb3JtYXQpLgogKiBAcmV0dXJuIHshVWludDhBcnJheX0KICovCgoKcHJvdG8ucGIuY21zLk92ZXJ2aWV3UmVwbHkucHJvdG90eXBlLnNlcmlhbGl6ZUJpbmFyeSA9IGZ1bmN0aW9uICgpIHsKICB2YXIgd3JpdGVyID0gbmV3IGpzcGIuQmluYXJ5V3JpdGVyKCk7CiAgcHJvdG8ucGIuY21zLk92ZXJ2aWV3UmVwbHkuc2VyaWFsaXplQmluYXJ5VG9Xcml0ZXIodGhpcywgd3JpdGVyKTsKICByZXR1cm4gd3JpdGVyLmdldFJlc3VsdEJ1ZmZlcigpOwp9OwovKioKICogU2VyaWFsaXplcyB0aGUgZ2l2ZW4gbWVzc2FnZSB0byBiaW5hcnkgZGF0YSAoaW4gcHJvdG9idWYgd2lyZQogKiBmb3JtYXQpLCB3cml0aW5nIHRvIHRoZSBnaXZlbiBCaW5hcnlXcml0ZXIuCiAqIEBwYXJhbSB7IXByb3RvLnBiLmNtcy5PdmVydmlld1JlcGx5fSBtZXNzYWdlCiAqIEBwYXJhbSB7IWpzcGIuQmluYXJ5V3JpdGVyfSB3cml0ZXIKICogQHN1cHByZXNzIHt1bnVzZWRMb2NhbFZhcmlhYmxlc30gZiBpcyBvbmx5IHVzZWQgZm9yIG5lc3RlZCBtZXNzYWdlcwogKi8KCgpwcm90by5wYi5jbXMuT3ZlcnZpZXdSZXBseS5zZXJpYWxpemVCaW5hcnlUb1dyaXRlciA9IGZ1bmN0aW9uIChtZXNzYWdlLCB3cml0ZXIpIHsKICB2YXIgZiA9IHVuZGVmaW5lZDsKICBmID0gbWVzc2FnZS5nZXRJbmNvbWUoKTsKCiAgaWYgKGYgIT09IDApIHsKICAgIHdyaXRlci53cml0ZVVpbnQzMigxLCBmKTsKICB9CgogIGYgPSBtZXNzYWdlLmdldFBheUNvdW50KCk7CgogIGlmIChmICE9PSAwKSB7CiAgICB3cml0ZXIud3JpdGVVaW50MzIoMiwgZik7CiAgfQoKICBmID0gbWVzc2FnZS5nZXROZXdVc2VyKCk7CgogIGlmIChmICE9PSAwKSB7CiAgICB3cml0ZXIud3JpdGVVaW50MzIoMywgZik7CiAgfQoKICBmID0gbWVzc2FnZS5nZXRBY3RpdmVVc2VyKCk7CgogIGlmIChmICE9PSAwKSB7CiAgICB3cml0ZXIud3JpdGVVaW50MzIoNCwgZik7CiAgfQoKICBmID0gbWVzc2FnZS5nZXRCdXN5QW5jaG9yKCk7CgogIGlmIChmICE9PSAwKSB7CiAgICB3cml0ZXIud3JpdGVVaW50MzIoNSwgZik7CiAgfQoKICBmID0gbWVzc2FnZS5nZXRPbmxpbmVBbmNob3IoKTsKCiAgaWYgKGYgIT09IDApIHsKICAgIHdyaXRlci53cml0ZVVpbnQzMig2LCBmKTsKICB9CgogIGYgPSBtZXNzYWdlLmdldFJldmlld0FuY2hvcigpOwoKICBpZiAoZiAhPT0gMCkgewogICAgd3JpdGVyLndyaXRlVWludDMyKDcsIGYpOwogIH0KCiAgZiA9IG1lc3NhZ2UuZ2V0UmV2aWV3UHJvZmlsZSgpOwoKICBpZiAoZiAhPT0gMCkgewogICAgd3JpdGVyLndyaXRlVWludDMyKDgsIGYpOwogIH0KCiAgZiA9IG1lc3NhZ2UuZ2V0UmV2aWV3VmlkZW8oKTsKCiAgaWYgKGYgIT09IDApIHsKICAgIHdyaXRlci53cml0ZVVpbnQzMig5LCBmKTsKICB9CgogIGYgPSBtZXNzYWdlLmdldE5ld0Ftb3VudCgpOwoKICBpZiAoZiAhPT0gMCkgewogICAgd3JpdGVyLndyaXRlVWludDY0KDEwLCBmKTsKICB9CgogIGYgPSBtZXNzYWdlLmdldEV4cGVuc2VBbW91bnQoKTsKCiAgaWYgKGYgIT09IDApIHsKICAgIHdyaXRlci53cml0ZVVpbnQ2NCgxMSwgZik7CiAgfQoKICBmID0gbWVzc2FnZS5nZXRUb3RhbEFtb3VudCgpOwoKICBpZiAoZiAhPT0gMCkgewogICAgd3JpdGVyLndyaXRlVWludDY0KDEyLCBmKTsKICB9Cn07Ci8qKgogKiBvcHRpb25hbCB1aW50MzIgaW5jb21lID0gMTsKICogQHJldHVybiB7bnVtYmVyfQogKi8KCgpwcm90by5wYi5jbXMuT3ZlcnZpZXdSZXBseS5wcm90b3R5cGUuZ2V0SW5jb21lID0gZnVuY3Rpb24gKCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdCh0aGlzLCAxLCAwKTsKfTsKLyoqCiAqIEBwYXJhbSB7bnVtYmVyfSB2YWx1ZQogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLk92ZXJ2aWV3UmVwbHl9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuT3ZlcnZpZXdSZXBseS5wcm90b3R5cGUuc2V0SW5jb21lID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRQcm90bzNJbnRGaWVsZCh0aGlzLCAxLCB2YWx1ZSk7Cn07Ci8qKgogKiBvcHRpb25hbCB1aW50MzIgcGF5X2NvdW50ID0gMjsKICogQHJldHVybiB7bnVtYmVyfQogKi8KCgpwcm90by5wYi5jbXMuT3ZlcnZpZXdSZXBseS5wcm90b3R5cGUuZ2V0UGF5Q291bnQgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDIsIDApOwp9OwovKioKICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuT3ZlcnZpZXdSZXBseX0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5PdmVydmlld1JlcGx5LnByb3RvdHlwZS5zZXRQYXlDb3VudCA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UHJvdG8zSW50RmllbGQodGhpcywgMiwgdmFsdWUpOwp9OwovKioKICogb3B0aW9uYWwgdWludDMyIG5ld191c2VyID0gMzsKICogQHJldHVybiB7bnVtYmVyfQogKi8KCgpwcm90by5wYi5jbXMuT3ZlcnZpZXdSZXBseS5wcm90b3R5cGUuZ2V0TmV3VXNlciA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQodGhpcywgMywgMCk7Cn07Ci8qKgogKiBAcGFyYW0ge251bWJlcn0gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5PdmVydmlld1JlcGx5fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLk92ZXJ2aWV3UmVwbHkucHJvdG90eXBlLnNldE5ld1VzZXIgPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0ludEZpZWxkKHRoaXMsIDMsIHZhbHVlKTsKfTsKLyoqCiAqIG9wdGlvbmFsIHVpbnQzMiBhY3RpdmVfdXNlciA9IDQ7CiAqIEByZXR1cm4ge251bWJlcn0KICovCgoKcHJvdG8ucGIuY21zLk92ZXJ2aWV3UmVwbHkucHJvdG90eXBlLmdldEFjdGl2ZVVzZXIgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDQsIDApOwp9OwovKioKICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuT3ZlcnZpZXdSZXBseX0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5PdmVydmlld1JlcGx5LnByb3RvdHlwZS5zZXRBY3RpdmVVc2VyID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRQcm90bzNJbnRGaWVsZCh0aGlzLCA0LCB2YWx1ZSk7Cn07Ci8qKgogKiBvcHRpb25hbCB1aW50MzIgYnVzeV9hbmNob3IgPSA1OwogKiBAcmV0dXJuIHtudW1iZXJ9CiAqLwoKCnByb3RvLnBiLmNtcy5PdmVydmlld1JlcGx5LnByb3RvdHlwZS5nZXRCdXN5QW5jaG9yID0gZnVuY3Rpb24gKCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdCh0aGlzLCA1LCAwKTsKfTsKLyoqCiAqIEBwYXJhbSB7bnVtYmVyfSB2YWx1ZQogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLk92ZXJ2aWV3UmVwbHl9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuT3ZlcnZpZXdSZXBseS5wcm90b3R5cGUuc2V0QnVzeUFuY2hvciA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UHJvdG8zSW50RmllbGQodGhpcywgNSwgdmFsdWUpOwp9OwovKioKICogb3B0aW9uYWwgdWludDMyIG9ubGluZV9hbmNob3IgPSA2OwogKiBAcmV0dXJuIHtudW1iZXJ9CiAqLwoKCnByb3RvLnBiLmNtcy5PdmVydmlld1JlcGx5LnByb3RvdHlwZS5nZXRPbmxpbmVBbmNob3IgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDYsIDApOwp9OwovKioKICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuT3ZlcnZpZXdSZXBseX0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5PdmVydmlld1JlcGx5LnByb3RvdHlwZS5zZXRPbmxpbmVBbmNob3IgPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0ludEZpZWxkKHRoaXMsIDYsIHZhbHVlKTsKfTsKLyoqCiAqIG9wdGlvbmFsIHVpbnQzMiByZXZpZXdfYW5jaG9yID0gNzsKICogQHJldHVybiB7bnVtYmVyfQogKi8KCgpwcm90by5wYi5jbXMuT3ZlcnZpZXdSZXBseS5wcm90b3R5cGUuZ2V0UmV2aWV3QW5jaG9yID0gZnVuY3Rpb24gKCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdCh0aGlzLCA3LCAwKTsKfTsKLyoqCiAqIEBwYXJhbSB7bnVtYmVyfSB2YWx1ZQogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLk92ZXJ2aWV3UmVwbHl9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuT3ZlcnZpZXdSZXBseS5wcm90b3R5cGUuc2V0UmV2aWV3QW5jaG9yID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRQcm90bzNJbnRGaWVsZCh0aGlzLCA3LCB2YWx1ZSk7Cn07Ci8qKgogKiBvcHRpb25hbCB1aW50MzIgcmV2aWV3X3Byb2ZpbGUgPSA4OwogKiBAcmV0dXJuIHtudW1iZXJ9CiAqLwoKCnByb3RvLnBiLmNtcy5PdmVydmlld1JlcGx5LnByb3RvdHlwZS5nZXRSZXZpZXdQcm9maWxlID0gZnVuY3Rpb24gKCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdCh0aGlzLCA4LCAwKTsKfTsKLyoqCiAqIEBwYXJhbSB7bnVtYmVyfSB2YWx1ZQogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLk92ZXJ2aWV3UmVwbHl9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuT3ZlcnZpZXdSZXBseS5wcm90b3R5cGUuc2V0UmV2aWV3UHJvZmlsZSA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UHJvdG8zSW50RmllbGQodGhpcywgOCwgdmFsdWUpOwp9OwovKioKICogb3B0aW9uYWwgdWludDMyIHJldmlld192aWRlbyA9IDk7CiAqIEByZXR1cm4ge251bWJlcn0KICovCgoKcHJvdG8ucGIuY21zLk92ZXJ2aWV3UmVwbHkucHJvdG90eXBlLmdldFJldmlld1ZpZGVvID0gZnVuY3Rpb24gKCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdCh0aGlzLCA5LCAwKTsKfTsKLyoqCiAqIEBwYXJhbSB7bnVtYmVyfSB2YWx1ZQogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLk92ZXJ2aWV3UmVwbHl9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuT3ZlcnZpZXdSZXBseS5wcm90b3R5cGUuc2V0UmV2aWV3VmlkZW8gPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0ludEZpZWxkKHRoaXMsIDksIHZhbHVlKTsKfTsKLyoqCiAqIG9wdGlvbmFsIHVpbnQ2NCBuZXdfYW1vdW50ID0gMTA7CiAqIEByZXR1cm4ge251bWJlcn0KICovCgoKcHJvdG8ucGIuY21zLk92ZXJ2aWV3UmVwbHkucHJvdG90eXBlLmdldE5ld0Ftb3VudCA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQodGhpcywgMTAsIDApOwp9OwovKioKICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuT3ZlcnZpZXdSZXBseX0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5PdmVydmlld1JlcGx5LnByb3RvdHlwZS5zZXROZXdBbW91bnQgPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0ludEZpZWxkKHRoaXMsIDEwLCB2YWx1ZSk7Cn07Ci8qKgogKiBvcHRpb25hbCB1aW50NjQgZXhwZW5zZV9hbW91bnQgPSAxMTsKICogQHJldHVybiB7bnVtYmVyfQogKi8KCgpwcm90by5wYi5jbXMuT3ZlcnZpZXdSZXBseS5wcm90b3R5cGUuZ2V0RXhwZW5zZUFtb3VudCA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQodGhpcywgMTEsIDApOwp9OwovKioKICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuT3ZlcnZpZXdSZXBseX0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5PdmVydmlld1JlcGx5LnByb3RvdHlwZS5zZXRFeHBlbnNlQW1vdW50ID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRQcm90bzNJbnRGaWVsZCh0aGlzLCAxMSwgdmFsdWUpOwp9OwovKioKICogb3B0aW9uYWwgdWludDY0IHRvdGFsX2Ftb3VudCA9IDEyOwogKiBAcmV0dXJuIHtudW1iZXJ9CiAqLwoKCnByb3RvLnBiLmNtcy5PdmVydmlld1JlcGx5LnByb3RvdHlwZS5nZXRUb3RhbEFtb3VudCA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQodGhpcywgMTIsIDApOwp9OwovKioKICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuT3ZlcnZpZXdSZXBseX0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5PdmVydmlld1JlcGx5LnByb3RvdHlwZS5zZXRUb3RhbEFtb3VudCA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UHJvdG8zSW50RmllbGQodGhpcywgMTIsIHZhbHVlKTsKfTsKCmlmIChqc3BiLk1lc3NhZ2UuR0VORVJBVEVfVE9fT0JKRUNUKSB7CiAgLyoqCiAgICogQ3JlYXRlcyBhbiBvYmplY3QgcmVwcmVzZW50YXRpb24gb2YgdGhpcyBwcm90by4KICAgKiBGaWVsZCBuYW1lcyB0aGF0IGFyZSByZXNlcnZlZCBpbiBKYXZhU2NyaXB0IGFuZCB3aWxsIGJlIHJlbmFtZWQgdG8gcGJfbmFtZS4KICAgKiBPcHRpb25hbCBmaWVsZHMgdGhhdCBhcmUgbm90IHNldCB3aWxsIGJlIHNldCB0byB1bmRlZmluZWQuCiAgICogVG8gYWNjZXNzIGEgcmVzZXJ2ZWQgZmllbGQgdXNlLCBmb28ucGJfPG5hbWU+LCBlZywgZm9vLnBiX2RlZmF1bHQuCiAgICogRm9yIHRoZSBsaXN0IG9mIHJlc2VydmVkIG5hbWVzIHBsZWFzZSBzZWU6CiAgICogICAgIG5ldC9wcm90bzIvY29tcGlsZXIvanMvaW50ZXJuYWwvZ2VuZXJhdG9yLmNjI2tLZXl3b3JkLgogICAqIEBwYXJhbSB7Ym9vbGVhbj19IG9wdF9pbmNsdWRlSW5zdGFuY2UgRGVwcmVjYXRlZC4gd2hldGhlciB0byBpbmNsdWRlIHRoZQogICAqICAgICBKU1BCIGluc3RhbmNlIGZvciB0cmFuc2l0aW9uYWwgc295IHByb3RvIHN1cHBvcnQ6CiAgICogICAgIGh0dHA6Ly9nb3RvL3NveS1wYXJhbS1taWdyYXRpb24KICAgKiBAcmV0dXJuIHshT2JqZWN0fQogICAqLwogIHByb3RvLnBiLmNtcy5Ib21lU3RhdFJlcXVlc3QucHJvdG90eXBlLnRvT2JqZWN0ID0gZnVuY3Rpb24gKG9wdF9pbmNsdWRlSW5zdGFuY2UpIHsKICAgIHJldHVybiBwcm90by5wYi5jbXMuSG9tZVN0YXRSZXF1ZXN0LnRvT2JqZWN0KG9wdF9pbmNsdWRlSW5zdGFuY2UsIHRoaXMpOwogIH07CiAgLyoqCiAgICogU3RhdGljIHZlcnNpb24gb2YgdGhlIHtAc2VlIHRvT2JqZWN0fSBtZXRob2QuCiAgICogQHBhcmFtIHtib29sZWFufHVuZGVmaW5lZH0gaW5jbHVkZUluc3RhbmNlIERlcHJlY2F0ZWQuIFdoZXRoZXIgdG8gaW5jbHVkZQogICAqICAgICB0aGUgSlNQQiBpbnN0YW5jZSBmb3IgdHJhbnNpdGlvbmFsIHNveSBwcm90byBzdXBwb3J0OgogICAqICAgICBodHRwOi8vZ290by9zb3ktcGFyYW0tbWlncmF0aW9uCiAgICogQHBhcmFtIHshcHJvdG8ucGIuY21zLkhvbWVTdGF0UmVxdWVzdH0gbXNnIFRoZSBtc2cgaW5zdGFuY2UgdG8gdHJhbnNmb3JtLgogICAqIEByZXR1cm4geyFPYmplY3R9CiAgICogQHN1cHByZXNzIHt1bnVzZWRMb2NhbFZhcmlhYmxlc30gZiBpcyBvbmx5IHVzZWQgZm9yIG5lc3RlZCBtZXNzYWdlcwogICAqLwoKCiAgcHJvdG8ucGIuY21zLkhvbWVTdGF0UmVxdWVzdC50b09iamVjdCA9IGZ1bmN0aW9uIChpbmNsdWRlSW5zdGFuY2UsIG1zZykgewogICAgdmFyIGYsCiAgICAgICAgb2JqID0gewogICAgICBhcmVhSWQ6IGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KG1zZywgMSwgMCksCiAgICAgIHN0YXJ0QXQ6IGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KG1zZywgMiwgMCksCiAgICAgIGVuZEF0OiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdChtc2csIDMsIDApCiAgICB9OwoKICAgIGlmIChpbmNsdWRlSW5zdGFuY2UpIHsKICAgICAgb2JqLiRqc3BiTWVzc2FnZUluc3RhbmNlID0gbXNnOwogICAgfQoKICAgIHJldHVybiBvYmo7CiAgfTsKfQovKioKICogRGVzZXJpYWxpemVzIGJpbmFyeSBkYXRhIChpbiBwcm90b2J1ZiB3aXJlIGZvcm1hdCkuCiAqIEBwYXJhbSB7anNwYi5CeXRlU291cmNlfSBieXRlcyBUaGUgYnl0ZXMgdG8gZGVzZXJpYWxpemUuCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuSG9tZVN0YXRSZXF1ZXN0fQogKi8KCgpwcm90by5wYi5jbXMuSG9tZVN0YXRSZXF1ZXN0LmRlc2VyaWFsaXplQmluYXJ5ID0gZnVuY3Rpb24gKGJ5dGVzKSB7CiAgdmFyIHJlYWRlciA9IG5ldyBqc3BiLkJpbmFyeVJlYWRlcihieXRlcyk7CiAgdmFyIG1zZyA9IG5ldyBwcm90by5wYi5jbXMuSG9tZVN0YXRSZXF1ZXN0KCk7CiAgcmV0dXJuIHByb3RvLnBiLmNtcy5Ib21lU3RhdFJlcXVlc3QuZGVzZXJpYWxpemVCaW5hcnlGcm9tUmVhZGVyKG1zZywgcmVhZGVyKTsKfTsKLyoqCiAqIERlc2VyaWFsaXplcyBiaW5hcnkgZGF0YSAoaW4gcHJvdG9idWYgd2lyZSBmb3JtYXQpIGZyb20gdGhlCiAqIGdpdmVuIHJlYWRlciBpbnRvIHRoZSBnaXZlbiBtZXNzYWdlIG9iamVjdC4KICogQHBhcmFtIHshcHJvdG8ucGIuY21zLkhvbWVTdGF0UmVxdWVzdH0gbXNnIFRoZSBtZXNzYWdlIG9iamVjdCB0byBkZXNlcmlhbGl6ZSBpbnRvLgogKiBAcGFyYW0geyFqc3BiLkJpbmFyeVJlYWRlcn0gcmVhZGVyIFRoZSBCaW5hcnlSZWFkZXIgdG8gdXNlLgogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLkhvbWVTdGF0UmVxdWVzdH0KICovCgoKcHJvdG8ucGIuY21zLkhvbWVTdGF0UmVxdWVzdC5kZXNlcmlhbGl6ZUJpbmFyeUZyb21SZWFkZXIgPSBmdW5jdGlvbiAobXNnLCByZWFkZXIpIHsKICB3aGlsZSAocmVhZGVyLm5leHRGaWVsZCgpKSB7CiAgICBpZiAocmVhZGVyLmlzRW5kR3JvdXAoKSkgewogICAgICBicmVhazsKICAgIH0KCiAgICB2YXIgZmllbGQgPSByZWFkZXIuZ2V0RmllbGROdW1iZXIoKTsKCiAgICBzd2l0Y2ggKGZpZWxkKSB7CiAgICAgIGNhc2UgMToKICAgICAgICB2YXIgdmFsdWUgPSByZWFkZXIucmVhZFVpbnQzMigpOwogICAgICAgIG1zZy5zZXRBcmVhSWQodmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSAyOgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkVWludDMyKCk7CiAgICAgICAgbXNnLnNldFN0YXJ0QXQodmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSAzOgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkVWludDMyKCk7CiAgICAgICAgbXNnLnNldEVuZEF0KHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGRlZmF1bHQ6CiAgICAgICAgcmVhZGVyLnNraXBGaWVsZCgpOwogICAgICAgIGJyZWFrOwogICAgfQogIH0KCiAgcmV0dXJuIG1zZzsKfTsKLyoqCiAqIFNlcmlhbGl6ZXMgdGhlIG1lc3NhZ2UgdG8gYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUgZm9ybWF0KS4KICogQHJldHVybiB7IVVpbnQ4QXJyYXl9CiAqLwoKCnByb3RvLnBiLmNtcy5Ib21lU3RhdFJlcXVlc3QucHJvdG90eXBlLnNlcmlhbGl6ZUJpbmFyeSA9IGZ1bmN0aW9uICgpIHsKICB2YXIgd3JpdGVyID0gbmV3IGpzcGIuQmluYXJ5V3JpdGVyKCk7CiAgcHJvdG8ucGIuY21zLkhvbWVTdGF0UmVxdWVzdC5zZXJpYWxpemVCaW5hcnlUb1dyaXRlcih0aGlzLCB3cml0ZXIpOwogIHJldHVybiB3cml0ZXIuZ2V0UmVzdWx0QnVmZmVyKCk7Cn07Ci8qKgogKiBTZXJpYWxpemVzIHRoZSBnaXZlbiBtZXNzYWdlIHRvIGJpbmFyeSBkYXRhIChpbiBwcm90b2J1ZiB3aXJlCiAqIGZvcm1hdCksIHdyaXRpbmcgdG8gdGhlIGdpdmVuIEJpbmFyeVdyaXRlci4KICogQHBhcmFtIHshcHJvdG8ucGIuY21zLkhvbWVTdGF0UmVxdWVzdH0gbWVzc2FnZQogKiBAcGFyYW0geyFqc3BiLkJpbmFyeVdyaXRlcn0gd3JpdGVyCiAqIEBzdXBwcmVzcyB7dW51c2VkTG9jYWxWYXJpYWJsZXN9IGYgaXMgb25seSB1c2VkIGZvciBuZXN0ZWQgbWVzc2FnZXMKICovCgoKcHJvdG8ucGIuY21zLkhvbWVTdGF0UmVxdWVzdC5zZXJpYWxpemVCaW5hcnlUb1dyaXRlciA9IGZ1bmN0aW9uIChtZXNzYWdlLCB3cml0ZXIpIHsKICB2YXIgZiA9IHVuZGVmaW5lZDsKICBmID0gbWVzc2FnZS5nZXRBcmVhSWQoKTsKCiAgaWYgKGYgIT09IDApIHsKICAgIHdyaXRlci53cml0ZVVpbnQzMigxLCBmKTsKICB9CgogIGYgPSBtZXNzYWdlLmdldFN0YXJ0QXQoKTsKCiAgaWYgKGYgIT09IDApIHsKICAgIHdyaXRlci53cml0ZVVpbnQzMigyLCBmKTsKICB9CgogIGYgPSBtZXNzYWdlLmdldEVuZEF0KCk7CgogIGlmIChmICE9PSAwKSB7CiAgICB3cml0ZXIud3JpdGVVaW50MzIoMywgZik7CiAgfQp9OwovKioKICogb3B0aW9uYWwgdWludDMyIGFyZWFfaWQgPSAxOwogKiBAcmV0dXJuIHtudW1iZXJ9CiAqLwoKCnByb3RvLnBiLmNtcy5Ib21lU3RhdFJlcXVlc3QucHJvdG90eXBlLmdldEFyZWFJZCA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQodGhpcywgMSwgMCk7Cn07Ci8qKgogKiBAcGFyYW0ge251bWJlcn0gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5Ib21lU3RhdFJlcXVlc3R9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuSG9tZVN0YXRSZXF1ZXN0LnByb3RvdHlwZS5zZXRBcmVhSWQgPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0ludEZpZWxkKHRoaXMsIDEsIHZhbHVlKTsKfTsKLyoqCiAqIG9wdGlvbmFsIHVpbnQzMiBzdGFydF9hdCA9IDI7CiAqIEByZXR1cm4ge251bWJlcn0KICovCgoKcHJvdG8ucGIuY21zLkhvbWVTdGF0UmVxdWVzdC5wcm90b3R5cGUuZ2V0U3RhcnRBdCA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQodGhpcywgMiwgMCk7Cn07Ci8qKgogKiBAcGFyYW0ge251bWJlcn0gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5Ib21lU3RhdFJlcXVlc3R9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuSG9tZVN0YXRSZXF1ZXN0LnByb3RvdHlwZS5zZXRTdGFydEF0ID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRQcm90bzNJbnRGaWVsZCh0aGlzLCAyLCB2YWx1ZSk7Cn07Ci8qKgogKiBvcHRpb25hbCB1aW50MzIgZW5kX2F0ID0gMzsKICogQHJldHVybiB7bnVtYmVyfQogKi8KCgpwcm90by5wYi5jbXMuSG9tZVN0YXRSZXF1ZXN0LnByb3RvdHlwZS5nZXRFbmRBdCA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQodGhpcywgMywgMCk7Cn07Ci8qKgogKiBAcGFyYW0ge251bWJlcn0gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5Ib21lU3RhdFJlcXVlc3R9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuSG9tZVN0YXRSZXF1ZXN0LnByb3RvdHlwZS5zZXRFbmRBdCA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UHJvdG8zSW50RmllbGQodGhpcywgMywgdmFsdWUpOwp9OwoKaWYgKGpzcGIuTWVzc2FnZS5HRU5FUkFURV9UT19PQkpFQ1QpIHsKICAvKioKICAgKiBDcmVhdGVzIGFuIG9iamVjdCByZXByZXNlbnRhdGlvbiBvZiB0aGlzIHByb3RvLgogICAqIEZpZWxkIG5hbWVzIHRoYXQgYXJlIHJlc2VydmVkIGluIEphdmFTY3JpcHQgYW5kIHdpbGwgYmUgcmVuYW1lZCB0byBwYl9uYW1lLgogICAqIE9wdGlvbmFsIGZpZWxkcyB0aGF0IGFyZSBub3Qgc2V0IHdpbGwgYmUgc2V0IHRvIHVuZGVmaW5lZC4KICAgKiBUbyBhY2Nlc3MgYSByZXNlcnZlZCBmaWVsZCB1c2UsIGZvby5wYl88bmFtZT4sIGVnLCBmb28ucGJfZGVmYXVsdC4KICAgKiBGb3IgdGhlIGxpc3Qgb2YgcmVzZXJ2ZWQgbmFtZXMgcGxlYXNlIHNlZToKICAgKiAgICAgbmV0L3Byb3RvMi9jb21waWxlci9qcy9pbnRlcm5hbC9nZW5lcmF0b3IuY2Mja0tleXdvcmQuCiAgICogQHBhcmFtIHtib29sZWFuPX0gb3B0X2luY2x1ZGVJbnN0YW5jZSBEZXByZWNhdGVkLiB3aGV0aGVyIHRvIGluY2x1ZGUgdGhlCiAgICogICAgIEpTUEIgaW5zdGFuY2UgZm9yIHRyYW5zaXRpb25hbCBzb3kgcHJvdG8gc3VwcG9ydDoKICAgKiAgICAgaHR0cDovL2dvdG8vc295LXBhcmFtLW1pZ3JhdGlvbgogICAqIEByZXR1cm4geyFPYmplY3R9CiAgICovCiAgcHJvdG8ucGIuY21zLkFwcFN0YXQucHJvdG90eXBlLnRvT2JqZWN0ID0gZnVuY3Rpb24gKG9wdF9pbmNsdWRlSW5zdGFuY2UpIHsKICAgIHJldHVybiBwcm90by5wYi5jbXMuQXBwU3RhdC50b09iamVjdChvcHRfaW5jbHVkZUluc3RhbmNlLCB0aGlzKTsKICB9OwogIC8qKgogICAqIFN0YXRpYyB2ZXJzaW9uIG9mIHRoZSB7QHNlZSB0b09iamVjdH0gbWV0aG9kLgogICAqIEBwYXJhbSB7Ym9vbGVhbnx1bmRlZmluZWR9IGluY2x1ZGVJbnN0YW5jZSBEZXByZWNhdGVkLiBXaGV0aGVyIHRvIGluY2x1ZGUKICAgKiAgICAgdGhlIEpTUEIgaW5zdGFuY2UgZm9yIHRyYW5zaXRpb25hbCBzb3kgcHJvdG8gc3VwcG9ydDoKICAgKiAgICAgaHR0cDovL2dvdG8vc295LXBhcmFtLW1pZ3JhdGlvbgogICAqIEBwYXJhbSB7IXByb3RvLnBiLmNtcy5BcHBTdGF0fSBtc2cgVGhlIG1zZyBpbnN0YW5jZSB0byB0cmFuc2Zvcm0uCiAgICogQHJldHVybiB7IU9iamVjdH0KICAgKiBAc3VwcHJlc3Mge3VudXNlZExvY2FsVmFyaWFibGVzfSBmIGlzIG9ubHkgdXNlZCBmb3IgbmVzdGVkIG1lc3NhZ2VzCiAgICovCgoKICBwcm90by5wYi5jbXMuQXBwU3RhdC50b09iamVjdCA9IGZ1bmN0aW9uIChpbmNsdWRlSW5zdGFuY2UsIG1zZykgewogICAgdmFyIGYsCiAgICAgICAgb2JqID0gewogICAgICBhcHBJZDoganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQobXNnLCAxLCAwKSwKICAgICAgb3NUeXBlOiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdChtc2csIDIsIDApLAogICAgICBuYW1lOiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdChtc2csIDMsICIiKSwKICAgICAgbmV3SW5jb21lOiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdChtc2csIDQsIDApLAogICAgICB0b3RhbEluY29tZToganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQobXNnLCA1LCAwKSwKICAgICAgbmV3VXNlcjoganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQobXNnLCA2LCAwKSwKICAgICAgZ29vZ2xlSW5jb21lOiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdChtc2csIDcsIDApLAogICAgICBhcHBsZUluY29tZToganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQobXNnLCA4LCAwKSwKICAgICAgb3RoZXJJbmNvbWU6IGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KG1zZywgOSwgMCkKICAgIH07CgogICAgaWYgKGluY2x1ZGVJbnN0YW5jZSkgewogICAgICBvYmouJGpzcGJNZXNzYWdlSW5zdGFuY2UgPSBtc2c7CiAgICB9CgogICAgcmV0dXJuIG9iajsKICB9Owp9Ci8qKgogKiBEZXNlcmlhbGl6ZXMgYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUgZm9ybWF0KS4KICogQHBhcmFtIHtqc3BiLkJ5dGVTb3VyY2V9IGJ5dGVzIFRoZSBieXRlcyB0byBkZXNlcmlhbGl6ZS4KICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5BcHBTdGF0fQogKi8KCgpwcm90by5wYi5jbXMuQXBwU3RhdC5kZXNlcmlhbGl6ZUJpbmFyeSA9IGZ1bmN0aW9uIChieXRlcykgewogIHZhciByZWFkZXIgPSBuZXcganNwYi5CaW5hcnlSZWFkZXIoYnl0ZXMpOwogIHZhciBtc2cgPSBuZXcgcHJvdG8ucGIuY21zLkFwcFN0YXQoKTsKICByZXR1cm4gcHJvdG8ucGIuY21zLkFwcFN0YXQuZGVzZXJpYWxpemVCaW5hcnlGcm9tUmVhZGVyKG1zZywgcmVhZGVyKTsKfTsKLyoqCiAqIERlc2VyaWFsaXplcyBiaW5hcnkgZGF0YSAoaW4gcHJvdG9idWYgd2lyZSBmb3JtYXQpIGZyb20gdGhlCiAqIGdpdmVuIHJlYWRlciBpbnRvIHRoZSBnaXZlbiBtZXNzYWdlIG9iamVjdC4KICogQHBhcmFtIHshcHJvdG8ucGIuY21zLkFwcFN0YXR9IG1zZyBUaGUgbWVzc2FnZSBvYmplY3QgdG8gZGVzZXJpYWxpemUgaW50by4KICogQHBhcmFtIHshanNwYi5CaW5hcnlSZWFkZXJ9IHJlYWRlciBUaGUgQmluYXJ5UmVhZGVyIHRvIHVzZS4KICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5BcHBTdGF0fQogKi8KCgpwcm90by5wYi5jbXMuQXBwU3RhdC5kZXNlcmlhbGl6ZUJpbmFyeUZyb21SZWFkZXIgPSBmdW5jdGlvbiAobXNnLCByZWFkZXIpIHsKICB3aGlsZSAocmVhZGVyLm5leHRGaWVsZCgpKSB7CiAgICBpZiAocmVhZGVyLmlzRW5kR3JvdXAoKSkgewogICAgICBicmVhazsKICAgIH0KCiAgICB2YXIgZmllbGQgPSByZWFkZXIuZ2V0RmllbGROdW1iZXIoKTsKCiAgICBzd2l0Y2ggKGZpZWxkKSB7CiAgICAgIGNhc2UgMToKICAgICAgICB2YXIgdmFsdWUgPSByZWFkZXIucmVhZFVpbnQzMigpOwogICAgICAgIG1zZy5zZXRBcHBJZCh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlIDI6CiAgICAgICAgdmFyIHZhbHVlID0gcmVhZGVyLnJlYWRFbnVtKCk7CiAgICAgICAgbXNnLnNldE9zVHlwZSh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlIDM6CiAgICAgICAgdmFyIHZhbHVlID0gcmVhZGVyLnJlYWRTdHJpbmcoKTsKICAgICAgICBtc2cuc2V0TmFtZSh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlIDQ6CiAgICAgICAgdmFyIHZhbHVlID0gcmVhZGVyLnJlYWRVaW50MzIoKTsKICAgICAgICBtc2cuc2V0TmV3SW5jb21lKHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgNToKICAgICAgICB2YXIgdmFsdWUgPSByZWFkZXIucmVhZFVpbnQzMigpOwogICAgICAgIG1zZy5zZXRUb3RhbEluY29tZSh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlIDY6CiAgICAgICAgdmFyIHZhbHVlID0gcmVhZGVyLnJlYWRVaW50MzIoKTsKICAgICAgICBtc2cuc2V0TmV3VXNlcih2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlIDc6CiAgICAgICAgdmFyIHZhbHVlID0gcmVhZGVyLnJlYWRVaW50MzIoKTsKICAgICAgICBtc2cuc2V0R29vZ2xlSW5jb21lKHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgODoKICAgICAgICB2YXIgdmFsdWUgPSByZWFkZXIucmVhZFVpbnQzMigpOwogICAgICAgIG1zZy5zZXRBcHBsZUluY29tZSh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlIDk6CiAgICAgICAgdmFyIHZhbHVlID0gcmVhZGVyLnJlYWRVaW50MzIoKTsKICAgICAgICBtc2cuc2V0T3RoZXJJbmNvbWUodmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgZGVmYXVsdDoKICAgICAgICByZWFkZXIuc2tpcEZpZWxkKCk7CiAgICAgICAgYnJlYWs7CiAgICB9CiAgfQoKICByZXR1cm4gbXNnOwp9OwovKioKICogU2VyaWFsaXplcyB0aGUgbWVzc2FnZSB0byBiaW5hcnkgZGF0YSAoaW4gcHJvdG9idWYgd2lyZSBmb3JtYXQpLgogKiBAcmV0dXJuIHshVWludDhBcnJheX0KICovCgoKcHJvdG8ucGIuY21zLkFwcFN0YXQucHJvdG90eXBlLnNlcmlhbGl6ZUJpbmFyeSA9IGZ1bmN0aW9uICgpIHsKICB2YXIgd3JpdGVyID0gbmV3IGpzcGIuQmluYXJ5V3JpdGVyKCk7CiAgcHJvdG8ucGIuY21zLkFwcFN0YXQuc2VyaWFsaXplQmluYXJ5VG9Xcml0ZXIodGhpcywgd3JpdGVyKTsKICByZXR1cm4gd3JpdGVyLmdldFJlc3VsdEJ1ZmZlcigpOwp9OwovKioKICogU2VyaWFsaXplcyB0aGUgZ2l2ZW4gbWVzc2FnZSB0byBiaW5hcnkgZGF0YSAoaW4gcHJvdG9idWYgd2lyZQogKiBmb3JtYXQpLCB3cml0aW5nIHRvIHRoZSBnaXZlbiBCaW5hcnlXcml0ZXIuCiAqIEBwYXJhbSB7IXByb3RvLnBiLmNtcy5BcHBTdGF0fSBtZXNzYWdlCiAqIEBwYXJhbSB7IWpzcGIuQmluYXJ5V3JpdGVyfSB3cml0ZXIKICogQHN1cHByZXNzIHt1bnVzZWRMb2NhbFZhcmlhYmxlc30gZiBpcyBvbmx5IHVzZWQgZm9yIG5lc3RlZCBtZXNzYWdlcwogKi8KCgpwcm90by5wYi5jbXMuQXBwU3RhdC5zZXJpYWxpemVCaW5hcnlUb1dyaXRlciA9IGZ1bmN0aW9uIChtZXNzYWdlLCB3cml0ZXIpIHsKICB2YXIgZiA9IHVuZGVmaW5lZDsKICBmID0gbWVzc2FnZS5nZXRBcHBJZCgpOwoKICBpZiAoZiAhPT0gMCkgewogICAgd3JpdGVyLndyaXRlVWludDMyKDEsIGYpOwogIH0KCiAgZiA9IG1lc3NhZ2UuZ2V0T3NUeXBlKCk7CgogIGlmIChmICE9PSAwLjApIHsKICAgIHdyaXRlci53cml0ZUVudW0oMiwgZik7CiAgfQoKICBmID0gbWVzc2FnZS5nZXROYW1lKCk7CgogIGlmIChmLmxlbmd0aCA+IDApIHsKICAgIHdyaXRlci53cml0ZVN0cmluZygzLCBmKTsKICB9CgogIGYgPSBtZXNzYWdlLmdldE5ld0luY29tZSgpOwoKICBpZiAoZiAhPT0gMCkgewogICAgd3JpdGVyLndyaXRlVWludDMyKDQsIGYpOwogIH0KCiAgZiA9IG1lc3NhZ2UuZ2V0VG90YWxJbmNvbWUoKTsKCiAgaWYgKGYgIT09IDApIHsKICAgIHdyaXRlci53cml0ZVVpbnQzMig1LCBmKTsKICB9CgogIGYgPSBtZXNzYWdlLmdldE5ld1VzZXIoKTsKCiAgaWYgKGYgIT09IDApIHsKICAgIHdyaXRlci53cml0ZVVpbnQzMig2LCBmKTsKICB9CgogIGYgPSBtZXNzYWdlLmdldEdvb2dsZUluY29tZSgpOwoKICBpZiAoZiAhPT0gMCkgewogICAgd3JpdGVyLndyaXRlVWludDMyKDcsIGYpOwogIH0KCiAgZiA9IG1lc3NhZ2UuZ2V0QXBwbGVJbmNvbWUoKTsKCiAgaWYgKGYgIT09IDApIHsKICAgIHdyaXRlci53cml0ZVVpbnQzMig4LCBmKTsKICB9CgogIGYgPSBtZXNzYWdlLmdldE90aGVySW5jb21lKCk7CgogIGlmIChmICE9PSAwKSB7CiAgICB3cml0ZXIud3JpdGVVaW50MzIoOSwgZik7CiAgfQp9OwovKioKICogb3B0aW9uYWwgdWludDMyIGFwcF9pZCA9IDE7CiAqIEByZXR1cm4ge251bWJlcn0KICovCgoKcHJvdG8ucGIuY21zLkFwcFN0YXQucHJvdG90eXBlLmdldEFwcElkID0gZnVuY3Rpb24gKCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdCh0aGlzLCAxLCAwKTsKfTsKLyoqCiAqIEBwYXJhbSB7bnVtYmVyfSB2YWx1ZQogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLkFwcFN0YXR9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuQXBwU3RhdC5wcm90b3R5cGUuc2V0QXBwSWQgPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0ludEZpZWxkKHRoaXMsIDEsIHZhbHVlKTsKfTsKLyoqCiAqIG9wdGlvbmFsIHBiLk9zVHlwZSBvc190eXBlID0gMjsKICogQHJldHVybiB7IXByb3RvLnBiLk9zVHlwZX0KICovCgoKcHJvdG8ucGIuY21zLkFwcFN0YXQucHJvdG90eXBlLmdldE9zVHlwZSA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQodGhpcywgMiwgMCk7Cn07Ci8qKgogKiBAcGFyYW0geyFwcm90by5wYi5Pc1R5cGV9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuQXBwU3RhdH0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5BcHBTdGF0LnByb3RvdHlwZS5zZXRPc1R5cGUgPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0VudW1GaWVsZCh0aGlzLCAyLCB2YWx1ZSk7Cn07Ci8qKgogKiBvcHRpb25hbCBzdHJpbmcgbmFtZSA9IDM7CiAqIEByZXR1cm4ge3N0cmluZ30KICovCgoKcHJvdG8ucGIuY21zLkFwcFN0YXQucHJvdG90eXBlLmdldE5hbWUgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDMsICIiKTsKfTsKLyoqCiAqIEBwYXJhbSB7c3RyaW5nfSB2YWx1ZQogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLkFwcFN0YXR9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuQXBwU3RhdC5wcm90b3R5cGUuc2V0TmFtZSA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UHJvdG8zU3RyaW5nRmllbGQodGhpcywgMywgdmFsdWUpOwp9OwovKioKICogb3B0aW9uYWwgdWludDMyIG5ld19pbmNvbWUgPSA0OwogKiBAcmV0dXJuIHtudW1iZXJ9CiAqLwoKCnByb3RvLnBiLmNtcy5BcHBTdGF0LnByb3RvdHlwZS5nZXROZXdJbmNvbWUgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDQsIDApOwp9OwovKioKICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuQXBwU3RhdH0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5BcHBTdGF0LnByb3RvdHlwZS5zZXROZXdJbmNvbWUgPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0ludEZpZWxkKHRoaXMsIDQsIHZhbHVlKTsKfTsKLyoqCiAqIG9wdGlvbmFsIHVpbnQzMiB0b3RhbF9pbmNvbWUgPSA1OwogKiBAcmV0dXJuIHtudW1iZXJ9CiAqLwoKCnByb3RvLnBiLmNtcy5BcHBTdGF0LnByb3RvdHlwZS5nZXRUb3RhbEluY29tZSA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQodGhpcywgNSwgMCk7Cn07Ci8qKgogKiBAcGFyYW0ge251bWJlcn0gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5BcHBTdGF0fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLkFwcFN0YXQucHJvdG90eXBlLnNldFRvdGFsSW5jb21lID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRQcm90bzNJbnRGaWVsZCh0aGlzLCA1LCB2YWx1ZSk7Cn07Ci8qKgogKiBvcHRpb25hbCB1aW50MzIgbmV3X3VzZXIgPSA2OwogKiBAcmV0dXJuIHtudW1iZXJ9CiAqLwoKCnByb3RvLnBiLmNtcy5BcHBTdGF0LnByb3RvdHlwZS5nZXROZXdVc2VyID0gZnVuY3Rpb24gKCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdCh0aGlzLCA2LCAwKTsKfTsKLyoqCiAqIEBwYXJhbSB7bnVtYmVyfSB2YWx1ZQogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLkFwcFN0YXR9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuQXBwU3RhdC5wcm90b3R5cGUuc2V0TmV3VXNlciA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UHJvdG8zSW50RmllbGQodGhpcywgNiwgdmFsdWUpOwp9OwovKioKICogb3B0aW9uYWwgdWludDMyIGdvb2dsZV9pbmNvbWUgPSA3OwogKiBAcmV0dXJuIHtudW1iZXJ9CiAqLwoKCnByb3RvLnBiLmNtcy5BcHBTdGF0LnByb3RvdHlwZS5nZXRHb29nbGVJbmNvbWUgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDcsIDApOwp9OwovKioKICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuQXBwU3RhdH0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5BcHBTdGF0LnByb3RvdHlwZS5zZXRHb29nbGVJbmNvbWUgPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0ludEZpZWxkKHRoaXMsIDcsIHZhbHVlKTsKfTsKLyoqCiAqIG9wdGlvbmFsIHVpbnQzMiBhcHBsZV9pbmNvbWUgPSA4OwogKiBAcmV0dXJuIHtudW1iZXJ9CiAqLwoKCnByb3RvLnBiLmNtcy5BcHBTdGF0LnByb3RvdHlwZS5nZXRBcHBsZUluY29tZSA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQodGhpcywgOCwgMCk7Cn07Ci8qKgogKiBAcGFyYW0ge251bWJlcn0gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5BcHBTdGF0fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLkFwcFN0YXQucHJvdG90eXBlLnNldEFwcGxlSW5jb21lID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRQcm90bzNJbnRGaWVsZCh0aGlzLCA4LCB2YWx1ZSk7Cn07Ci8qKgogKiBvcHRpb25hbCB1aW50MzIgb3RoZXJfaW5jb21lID0gOTsKICogQHJldHVybiB7bnVtYmVyfQogKi8KCgpwcm90by5wYi5jbXMuQXBwU3RhdC5wcm90b3R5cGUuZ2V0T3RoZXJJbmNvbWUgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDksIDApOwp9OwovKioKICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuQXBwU3RhdH0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5BcHBTdGF0LnByb3RvdHlwZS5zZXRPdGhlckluY29tZSA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UHJvdG8zSW50RmllbGQodGhpcywgOSwgdmFsdWUpOwp9OwovKioKICogTGlzdCBvZiByZXBlYXRlZCBmaWVsZHMgd2l0aGluIHRoaXMgbWVzc2FnZSB0eXBlLgogKiBAcHJpdmF0ZSB7IUFycmF5PG51bWJlcj59CiAqIEBjb25zdAogKi8KCgpwcm90by5wYi5jbXMuSG9tZVN0YXRSZXBseS5yZXBlYXRlZEZpZWxkc18gPSBbMSwgMl07CgppZiAoanNwYi5NZXNzYWdlLkdFTkVSQVRFX1RPX09CSkVDVCkgewogIC8qKgogICAqIENyZWF0ZXMgYW4gb2JqZWN0IHJlcHJlc2VudGF0aW9uIG9mIHRoaXMgcHJvdG8uCiAgICogRmllbGQgbmFtZXMgdGhhdCBhcmUgcmVzZXJ2ZWQgaW4gSmF2YVNjcmlwdCBhbmQgd2lsbCBiZSByZW5hbWVkIHRvIHBiX25hbWUuCiAgICogT3B0aW9uYWwgZmllbGRzIHRoYXQgYXJlIG5vdCBzZXQgd2lsbCBiZSBzZXQgdG8gdW5kZWZpbmVkLgogICAqIFRvIGFjY2VzcyBhIHJlc2VydmVkIGZpZWxkIHVzZSwgZm9vLnBiXzxuYW1lPiwgZWcsIGZvby5wYl9kZWZhdWx0LgogICAqIEZvciB0aGUgbGlzdCBvZiByZXNlcnZlZCBuYW1lcyBwbGVhc2Ugc2VlOgogICAqICAgICBuZXQvcHJvdG8yL2NvbXBpbGVyL2pzL2ludGVybmFsL2dlbmVyYXRvci5jYyNrS2V5d29yZC4KICAgKiBAcGFyYW0ge2Jvb2xlYW49fSBvcHRfaW5jbHVkZUluc3RhbmNlIERlcHJlY2F0ZWQuIHdoZXRoZXIgdG8gaW5jbHVkZSB0aGUKICAgKiAgICAgSlNQQiBpbnN0YW5jZSBmb3IgdHJhbnNpdGlvbmFsIHNveSBwcm90byBzdXBwb3J0OgogICAqICAgICBodHRwOi8vZ290by9zb3ktcGFyYW0tbWlncmF0aW9uCiAgICogQHJldHVybiB7IU9iamVjdH0KICAgKi8KICBwcm90by5wYi5jbXMuSG9tZVN0YXRSZXBseS5wcm90b3R5cGUudG9PYmplY3QgPSBmdW5jdGlvbiAob3B0X2luY2x1ZGVJbnN0YW5jZSkgewogICAgcmV0dXJuIHByb3RvLnBiLmNtcy5Ib21lU3RhdFJlcGx5LnRvT2JqZWN0KG9wdF9pbmNsdWRlSW5zdGFuY2UsIHRoaXMpOwogIH07CiAgLyoqCiAgICogU3RhdGljIHZlcnNpb24gb2YgdGhlIHtAc2VlIHRvT2JqZWN0fSBtZXRob2QuCiAgICogQHBhcmFtIHtib29sZWFufHVuZGVmaW5lZH0gaW5jbHVkZUluc3RhbmNlIERlcHJlY2F0ZWQuIFdoZXRoZXIgdG8gaW5jbHVkZQogICAqICAgICB0aGUgSlNQQiBpbnN0YW5jZSBmb3IgdHJhbnNpdGlvbmFsIHNveSBwcm90byBzdXBwb3J0OgogICAqICAgICBodHRwOi8vZ290by9zb3ktcGFyYW0tbWlncmF0aW9uCiAgICogQHBhcmFtIHshcHJvdG8ucGIuY21zLkhvbWVTdGF0UmVwbHl9IG1zZyBUaGUgbXNnIGluc3RhbmNlIHRvIHRyYW5zZm9ybS4KICAgKiBAcmV0dXJuIHshT2JqZWN0fQogICAqIEBzdXBwcmVzcyB7dW51c2VkTG9jYWxWYXJpYWJsZXN9IGYgaXMgb25seSB1c2VkIGZvciBuZXN0ZWQgbWVzc2FnZXMKICAgKi8KCgogIHByb3RvLnBiLmNtcy5Ib21lU3RhdFJlcGx5LnRvT2JqZWN0ID0gZnVuY3Rpb24gKGluY2x1ZGVJbnN0YW5jZSwgbXNnKSB7CiAgICB2YXIgZiwKICAgICAgICBvYmogPSB7CiAgICAgIHN0YXRzTGlzdDoganNwYi5NZXNzYWdlLnRvT2JqZWN0TGlzdChtc2cuZ2V0U3RhdHNMaXN0KCksIHByb3RvLnBiLmNtcy5BcHBTdGF0LnRvT2JqZWN0LCBpbmNsdWRlSW5zdGFuY2UpLAogICAgICBob3VybHlBY3RpdmVzTGlzdDogKGYgPSBqc3BiLk1lc3NhZ2UuZ2V0UmVwZWF0ZWRGaWVsZChtc2csIDIpKSA9PSBudWxsID8gdW5kZWZpbmVkIDogZgogICAgfTsKCiAgICBpZiAoaW5jbHVkZUluc3RhbmNlKSB7CiAgICAgIG9iai4kanNwYk1lc3NhZ2VJbnN0YW5jZSA9IG1zZzsKICAgIH0KCiAgICByZXR1cm4gb2JqOwogIH07Cn0KLyoqCiAqIERlc2VyaWFsaXplcyBiaW5hcnkgZGF0YSAoaW4gcHJvdG9idWYgd2lyZSBmb3JtYXQpLgogKiBAcGFyYW0ge2pzcGIuQnl0ZVNvdXJjZX0gYnl0ZXMgVGhlIGJ5dGVzIHRvIGRlc2VyaWFsaXplLgogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLkhvbWVTdGF0UmVwbHl9CiAqLwoKCnByb3RvLnBiLmNtcy5Ib21lU3RhdFJlcGx5LmRlc2VyaWFsaXplQmluYXJ5ID0gZnVuY3Rpb24gKGJ5dGVzKSB7CiAgdmFyIHJlYWRlciA9IG5ldyBqc3BiLkJpbmFyeVJlYWRlcihieXRlcyk7CiAgdmFyIG1zZyA9IG5ldyBwcm90by5wYi5jbXMuSG9tZVN0YXRSZXBseSgpOwogIHJldHVybiBwcm90by5wYi5jbXMuSG9tZVN0YXRSZXBseS5kZXNlcmlhbGl6ZUJpbmFyeUZyb21SZWFkZXIobXNnLCByZWFkZXIpOwp9OwovKioKICogRGVzZXJpYWxpemVzIGJpbmFyeSBkYXRhIChpbiBwcm90b2J1ZiB3aXJlIGZvcm1hdCkgZnJvbSB0aGUKICogZ2l2ZW4gcmVhZGVyIGludG8gdGhlIGdpdmVuIG1lc3NhZ2Ugb2JqZWN0LgogKiBAcGFyYW0geyFwcm90by5wYi5jbXMuSG9tZVN0YXRSZXBseX0gbXNnIFRoZSBtZXNzYWdlIG9iamVjdCB0byBkZXNlcmlhbGl6ZSBpbnRvLgogKiBAcGFyYW0geyFqc3BiLkJpbmFyeVJlYWRlcn0gcmVhZGVyIFRoZSBCaW5hcnlSZWFkZXIgdG8gdXNlLgogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLkhvbWVTdGF0UmVwbHl9CiAqLwoKCnByb3RvLnBiLmNtcy5Ib21lU3RhdFJlcGx5LmRlc2VyaWFsaXplQmluYXJ5RnJvbVJlYWRlciA9IGZ1bmN0aW9uIChtc2csIHJlYWRlcikgewogIHdoaWxlIChyZWFkZXIubmV4dEZpZWxkKCkpIHsKICAgIGlmIChyZWFkZXIuaXNFbmRHcm91cCgpKSB7CiAgICAgIGJyZWFrOwogICAgfQoKICAgIHZhciBmaWVsZCA9IHJlYWRlci5nZXRGaWVsZE51bWJlcigpOwoKICAgIHN3aXRjaCAoZmllbGQpIHsKICAgICAgY2FzZSAxOgogICAgICAgIHZhciB2YWx1ZSA9IG5ldyBwcm90by5wYi5jbXMuQXBwU3RhdCgpOwogICAgICAgIHJlYWRlci5yZWFkTWVzc2FnZSh2YWx1ZSwgcHJvdG8ucGIuY21zLkFwcFN0YXQuZGVzZXJpYWxpemVCaW5hcnlGcm9tUmVhZGVyKTsKICAgICAgICBtc2cuYWRkU3RhdHModmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSAyOgogICAgICAgIHZhciB2YWx1ZXMgPSByZWFkZXIuaXNEZWxpbWl0ZWQoKSA/IHJlYWRlci5yZWFkUGFja2VkVWludDMyKCkgOiBbcmVhZGVyLnJlYWRVaW50MzIoKV07CgogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdmFsdWVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBtc2cuYWRkSG91cmx5QWN0aXZlcyh2YWx1ZXNbaV0pOwogICAgICAgIH0KCiAgICAgICAgYnJlYWs7CgogICAgICBkZWZhdWx0OgogICAgICAgIHJlYWRlci5za2lwRmllbGQoKTsKICAgICAgICBicmVhazsKICAgIH0KICB9CgogIHJldHVybiBtc2c7Cn07Ci8qKgogKiBTZXJpYWxpemVzIHRoZSBtZXNzYWdlIHRvIGJpbmFyeSBkYXRhIChpbiBwcm90b2J1ZiB3aXJlIGZvcm1hdCkuCiAqIEByZXR1cm4geyFVaW50OEFycmF5fQogKi8KCgpwcm90by5wYi5jbXMuSG9tZVN0YXRSZXBseS5wcm90b3R5cGUuc2VyaWFsaXplQmluYXJ5ID0gZnVuY3Rpb24gKCkgewogIHZhciB3cml0ZXIgPSBuZXcganNwYi5CaW5hcnlXcml0ZXIoKTsKICBwcm90by5wYi5jbXMuSG9tZVN0YXRSZXBseS5zZXJpYWxpemVCaW5hcnlUb1dyaXRlcih0aGlzLCB3cml0ZXIpOwogIHJldHVybiB3cml0ZXIuZ2V0UmVzdWx0QnVmZmVyKCk7Cn07Ci8qKgogKiBTZXJpYWxpemVzIHRoZSBnaXZlbiBtZXNzYWdlIHRvIGJpbmFyeSBkYXRhIChpbiBwcm90b2J1ZiB3aXJlCiAqIGZvcm1hdCksIHdyaXRpbmcgdG8gdGhlIGdpdmVuIEJpbmFyeVdyaXRlci4KICogQHBhcmFtIHshcHJvdG8ucGIuY21zLkhvbWVTdGF0UmVwbHl9IG1lc3NhZ2UKICogQHBhcmFtIHshanNwYi5CaW5hcnlXcml0ZXJ9IHdyaXRlcgogKiBAc3VwcHJlc3Mge3VudXNlZExvY2FsVmFyaWFibGVzfSBmIGlzIG9ubHkgdXNlZCBmb3IgbmVzdGVkIG1lc3NhZ2VzCiAqLwoKCnByb3RvLnBiLmNtcy5Ib21lU3RhdFJlcGx5LnNlcmlhbGl6ZUJpbmFyeVRvV3JpdGVyID0gZnVuY3Rpb24gKG1lc3NhZ2UsIHdyaXRlcikgewogIHZhciBmID0gdW5kZWZpbmVkOwogIGYgPSBtZXNzYWdlLmdldFN0YXRzTGlzdCgpOwoKICBpZiAoZi5sZW5ndGggPiAwKSB7CiAgICB3cml0ZXIud3JpdGVSZXBlYXRlZE1lc3NhZ2UoMSwgZiwgcHJvdG8ucGIuY21zLkFwcFN0YXQuc2VyaWFsaXplQmluYXJ5VG9Xcml0ZXIpOwogIH0KCiAgZiA9IG1lc3NhZ2UuZ2V0SG91cmx5QWN0aXZlc0xpc3QoKTsKCiAgaWYgKGYubGVuZ3RoID4gMCkgewogICAgd3JpdGVyLndyaXRlUGFja2VkVWludDMyKDIsIGYpOwogIH0KfTsKLyoqCiAqIHJlcGVhdGVkIEFwcFN0YXQgc3RhdHMgPSAxOwogKiBAcmV0dXJuIHshQXJyYXk8IXByb3RvLnBiLmNtcy5BcHBTdGF0Pn0KICovCgoKcHJvdG8ucGIuY21zLkhvbWVTdGF0UmVwbHkucHJvdG90eXBlLmdldFN0YXRzTGlzdCA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldFJlcGVhdGVkV3JhcHBlckZpZWxkKHRoaXMsIHByb3RvLnBiLmNtcy5BcHBTdGF0LCAxKTsKfTsKLyoqCiAqIEBwYXJhbSB7IUFycmF5PCFwcm90by5wYi5jbXMuQXBwU3RhdD59IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuSG9tZVN0YXRSZXBseX0gcmV0dXJucyB0aGlzCiovCgoKcHJvdG8ucGIuY21zLkhvbWVTdGF0UmVwbHkucHJvdG90eXBlLnNldFN0YXRzTGlzdCA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UmVwZWF0ZWRXcmFwcGVyRmllbGQodGhpcywgMSwgdmFsdWUpOwp9OwovKioKICogQHBhcmFtIHshcHJvdG8ucGIuY21zLkFwcFN0YXQ9fSBvcHRfdmFsdWUKICogQHBhcmFtIHtudW1iZXI9fSBvcHRfaW5kZXgKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5BcHBTdGF0fQogKi8KCgpwcm90by5wYi5jbXMuSG9tZVN0YXRSZXBseS5wcm90b3R5cGUuYWRkU3RhdHMgPSBmdW5jdGlvbiAob3B0X3ZhbHVlLCBvcHRfaW5kZXgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmFkZFRvUmVwZWF0ZWRXcmFwcGVyRmllbGQodGhpcywgMSwgb3B0X3ZhbHVlLCBwcm90by5wYi5jbXMuQXBwU3RhdCwgb3B0X2luZGV4KTsKfTsKLyoqCiAqIENsZWFycyB0aGUgbGlzdCBtYWtpbmcgaXQgZW1wdHkgYnV0IG5vbi1udWxsLgogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLkhvbWVTdGF0UmVwbHl9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuSG9tZVN0YXRSZXBseS5wcm90b3R5cGUuY2xlYXJTdGF0c0xpc3QgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIHRoaXMuc2V0U3RhdHNMaXN0KFtdKTsKfTsKLyoqCiAqIHJlcGVhdGVkIHVpbnQzMiBob3VybHlfYWN0aXZlcyA9IDI7CiAqIEByZXR1cm4geyFBcnJheTxudW1iZXI+fQogKi8KCgpwcm90by5wYi5jbXMuSG9tZVN0YXRSZXBseS5wcm90b3R5cGUuZ2V0SG91cmx5QWN0aXZlc0xpc3QgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRSZXBlYXRlZEZpZWxkKHRoaXMsIDIpOwp9OwovKioKICogQHBhcmFtIHshQXJyYXk8bnVtYmVyPn0gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5Ib21lU3RhdFJlcGx5fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLkhvbWVTdGF0UmVwbHkucHJvdG90eXBlLnNldEhvdXJseUFjdGl2ZXNMaXN0ID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRGaWVsZCh0aGlzLCAyLCB2YWx1ZSB8fCBbXSk7Cn07Ci8qKgogKiBAcGFyYW0ge251bWJlcn0gdmFsdWUKICogQHBhcmFtIHtudW1iZXI9fSBvcHRfaW5kZXgKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5Ib21lU3RhdFJlcGx5fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLkhvbWVTdGF0UmVwbHkucHJvdG90eXBlLmFkZEhvdXJseUFjdGl2ZXMgPSBmdW5jdGlvbiAodmFsdWUsIG9wdF9pbmRleCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuYWRkVG9SZXBlYXRlZEZpZWxkKHRoaXMsIDIsIHZhbHVlLCBvcHRfaW5kZXgpOwp9OwovKioKICogQ2xlYXJzIHRoZSBsaXN0IG1ha2luZyBpdCBlbXB0eSBidXQgbm9uLW51bGwuCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuSG9tZVN0YXRSZXBseX0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5Ib21lU3RhdFJlcGx5LnByb3RvdHlwZS5jbGVhckhvdXJseUFjdGl2ZXNMaXN0ID0gZnVuY3Rpb24gKCkgewogIHJldHVybiB0aGlzLnNldEhvdXJseUFjdGl2ZXNMaXN0KFtdKTsKfTsKCmlmIChqc3BiLk1lc3NhZ2UuR0VORVJBVEVfVE9fT0JKRUNUKSB7CiAgLyoqCiAgICogQ3JlYXRlcyBhbiBvYmplY3QgcmVwcmVzZW50YXRpb24gb2YgdGhpcyBwcm90by4KICAgKiBGaWVsZCBuYW1lcyB0aGF0IGFyZSByZXNlcnZlZCBpbiBKYXZhU2NyaXB0IGFuZCB3aWxsIGJlIHJlbmFtZWQgdG8gcGJfbmFtZS4KICAgKiBPcHRpb25hbCBmaWVsZHMgdGhhdCBhcmUgbm90IHNldCB3aWxsIGJlIHNldCB0byB1bmRlZmluZWQuCiAgICogVG8gYWNjZXNzIGEgcmVzZXJ2ZWQgZmllbGQgdXNlLCBmb28ucGJfPG5hbWU+LCBlZywgZm9vLnBiX2RlZmF1bHQuCiAgICogRm9yIHRoZSBsaXN0IG9mIHJlc2VydmVkIG5hbWVzIHBsZWFzZSBzZWU6CiAgICogICAgIG5ldC9wcm90bzIvY29tcGlsZXIvanMvaW50ZXJuYWwvZ2VuZXJhdG9yLmNjI2tLZXl3b3JkLgogICAqIEBwYXJhbSB7Ym9vbGVhbj19IG9wdF9pbmNsdWRlSW5zdGFuY2UgRGVwcmVjYXRlZC4gd2hldGhlciB0byBpbmNsdWRlIHRoZQogICAqICAgICBKU1BCIGluc3RhbmNlIGZvciB0cmFuc2l0aW9uYWwgc295IHByb3RvIHN1cHBvcnQ6CiAgICogICAgIGh0dHA6Ly9nb3RvL3NveS1wYXJhbS1taWdyYXRpb24KICAgKiBAcmV0dXJuIHshT2JqZWN0fQogICAqLwogIHByb3RvLnBiLmNtcy5BcmVhU3RhdFJlcXVlc3QucHJvdG90eXBlLnRvT2JqZWN0ID0gZnVuY3Rpb24gKG9wdF9pbmNsdWRlSW5zdGFuY2UpIHsKICAgIHJldHVybiBwcm90by5wYi5jbXMuQXJlYVN0YXRSZXF1ZXN0LnRvT2JqZWN0KG9wdF9pbmNsdWRlSW5zdGFuY2UsIHRoaXMpOwogIH07CiAgLyoqCiAgICogU3RhdGljIHZlcnNpb24gb2YgdGhlIHtAc2VlIHRvT2JqZWN0fSBtZXRob2QuCiAgICogQHBhcmFtIHtib29sZWFufHVuZGVmaW5lZH0gaW5jbHVkZUluc3RhbmNlIERlcHJlY2F0ZWQuIFdoZXRoZXIgdG8gaW5jbHVkZQogICAqICAgICB0aGUgSlNQQiBpbnN0YW5jZSBmb3IgdHJhbnNpdGlvbmFsIHNveSBwcm90byBzdXBwb3J0OgogICAqICAgICBodHRwOi8vZ290by9zb3ktcGFyYW0tbWlncmF0aW9uCiAgICogQHBhcmFtIHshcHJvdG8ucGIuY21zLkFyZWFTdGF0UmVxdWVzdH0gbXNnIFRoZSBtc2cgaW5zdGFuY2UgdG8gdHJhbnNmb3JtLgogICAqIEByZXR1cm4geyFPYmplY3R9CiAgICogQHN1cHByZXNzIHt1bnVzZWRMb2NhbFZhcmlhYmxlc30gZiBpcyBvbmx5IHVzZWQgZm9yIG5lc3RlZCBtZXNzYWdlcwogICAqLwoKCiAgcHJvdG8ucGIuY21zLkFyZWFTdGF0UmVxdWVzdC50b09iamVjdCA9IGZ1bmN0aW9uIChpbmNsdWRlSW5zdGFuY2UsIG1zZykgewogICAgdmFyIGYsCiAgICAgICAgb2JqID0ge307CgogICAgaWYgKGluY2x1ZGVJbnN0YW5jZSkgewogICAgICBvYmouJGpzcGJNZXNzYWdlSW5zdGFuY2UgPSBtc2c7CiAgICB9CgogICAgcmV0dXJuIG9iajsKICB9Owp9Ci8qKgogKiBEZXNlcmlhbGl6ZXMgYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUgZm9ybWF0KS4KICogQHBhcmFtIHtqc3BiLkJ5dGVTb3VyY2V9IGJ5dGVzIFRoZSBieXRlcyB0byBkZXNlcmlhbGl6ZS4KICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5BcmVhU3RhdFJlcXVlc3R9CiAqLwoKCnByb3RvLnBiLmNtcy5BcmVhU3RhdFJlcXVlc3QuZGVzZXJpYWxpemVCaW5hcnkgPSBmdW5jdGlvbiAoYnl0ZXMpIHsKICB2YXIgcmVhZGVyID0gbmV3IGpzcGIuQmluYXJ5UmVhZGVyKGJ5dGVzKTsKICB2YXIgbXNnID0gbmV3IHByb3RvLnBiLmNtcy5BcmVhU3RhdFJlcXVlc3QoKTsKICByZXR1cm4gcHJvdG8ucGIuY21zLkFyZWFTdGF0UmVxdWVzdC5kZXNlcmlhbGl6ZUJpbmFyeUZyb21SZWFkZXIobXNnLCByZWFkZXIpOwp9OwovKioKICogRGVzZXJpYWxpemVzIGJpbmFyeSBkYXRhIChpbiBwcm90b2J1ZiB3aXJlIGZvcm1hdCkgZnJvbSB0aGUKICogZ2l2ZW4gcmVhZGVyIGludG8gdGhlIGdpdmVuIG1lc3NhZ2Ugb2JqZWN0LgogKiBAcGFyYW0geyFwcm90by5wYi5jbXMuQXJlYVN0YXRSZXF1ZXN0fSBtc2cgVGhlIG1lc3NhZ2Ugb2JqZWN0IHRvIGRlc2VyaWFsaXplIGludG8uCiAqIEBwYXJhbSB7IWpzcGIuQmluYXJ5UmVhZGVyfSByZWFkZXIgVGhlIEJpbmFyeVJlYWRlciB0byB1c2UuCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuQXJlYVN0YXRSZXF1ZXN0fQogKi8KCgpwcm90by5wYi5jbXMuQXJlYVN0YXRSZXF1ZXN0LmRlc2VyaWFsaXplQmluYXJ5RnJvbVJlYWRlciA9IGZ1bmN0aW9uIChtc2csIHJlYWRlcikgewogIHdoaWxlIChyZWFkZXIubmV4dEZpZWxkKCkpIHsKICAgIGlmIChyZWFkZXIuaXNFbmRHcm91cCgpKSB7CiAgICAgIGJyZWFrOwogICAgfQoKICAgIHZhciBmaWVsZCA9IHJlYWRlci5nZXRGaWVsZE51bWJlcigpOwoKICAgIHN3aXRjaCAoZmllbGQpIHsKICAgICAgZGVmYXVsdDoKICAgICAgICByZWFkZXIuc2tpcEZpZWxkKCk7CiAgICAgICAgYnJlYWs7CiAgICB9CiAgfQoKICByZXR1cm4gbXNnOwp9OwovKioKICogU2VyaWFsaXplcyB0aGUgbWVzc2FnZSB0byBiaW5hcnkgZGF0YSAoaW4gcHJvdG9idWYgd2lyZSBmb3JtYXQpLgogKiBAcmV0dXJuIHshVWludDhBcnJheX0KICovCgoKcHJvdG8ucGIuY21zLkFyZWFTdGF0UmVxdWVzdC5wcm90b3R5cGUuc2VyaWFsaXplQmluYXJ5ID0gZnVuY3Rpb24gKCkgewogIHZhciB3cml0ZXIgPSBuZXcganNwYi5CaW5hcnlXcml0ZXIoKTsKICBwcm90by5wYi5jbXMuQXJlYVN0YXRSZXF1ZXN0LnNlcmlhbGl6ZUJpbmFyeVRvV3JpdGVyKHRoaXMsIHdyaXRlcik7CiAgcmV0dXJuIHdyaXRlci5nZXRSZXN1bHRCdWZmZXIoKTsKfTsKLyoqCiAqIFNlcmlhbGl6ZXMgdGhlIGdpdmVuIG1lc3NhZ2UgdG8gYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUKICogZm9ybWF0KSwgd3JpdGluZyB0byB0aGUgZ2l2ZW4gQmluYXJ5V3JpdGVyLgogKiBAcGFyYW0geyFwcm90by5wYi5jbXMuQXJlYVN0YXRSZXF1ZXN0fSBtZXNzYWdlCiAqIEBwYXJhbSB7IWpzcGIuQmluYXJ5V3JpdGVyfSB3cml0ZXIKICogQHN1cHByZXNzIHt1bnVzZWRMb2NhbFZhcmlhYmxlc30gZiBpcyBvbmx5IHVzZWQgZm9yIG5lc3RlZCBtZXNzYWdlcwogKi8KCgpwcm90by5wYi5jbXMuQXJlYVN0YXRSZXF1ZXN0LnNlcmlhbGl6ZUJpbmFyeVRvV3JpdGVyID0gZnVuY3Rpb24gKG1lc3NhZ2UsIHdyaXRlcikgewogIHZhciBmID0gdW5kZWZpbmVkOwp9OwoKaWYgKGpzcGIuTWVzc2FnZS5HRU5FUkFURV9UT19PQkpFQ1QpIHsKICAvKioKICAgKiBDcmVhdGVzIGFuIG9iamVjdCByZXByZXNlbnRhdGlvbiBvZiB0aGlzIHByb3RvLgogICAqIEZpZWxkIG5hbWVzIHRoYXQgYXJlIHJlc2VydmVkIGluIEphdmFTY3JpcHQgYW5kIHdpbGwgYmUgcmVuYW1lZCB0byBwYl9uYW1lLgogICAqIE9wdGlvbmFsIGZpZWxkcyB0aGF0IGFyZSBub3Qgc2V0IHdpbGwgYmUgc2V0IHRvIHVuZGVmaW5lZC4KICAgKiBUbyBhY2Nlc3MgYSByZXNlcnZlZCBmaWVsZCB1c2UsIGZvby5wYl88bmFtZT4sIGVnLCBmb28ucGJfZGVmYXVsdC4KICAgKiBGb3IgdGhlIGxpc3Qgb2YgcmVzZXJ2ZWQgbmFtZXMgcGxlYXNlIHNlZToKICAgKiAgICAgbmV0L3Byb3RvMi9jb21waWxlci9qcy9pbnRlcm5hbC9nZW5lcmF0b3IuY2Mja0tleXdvcmQuCiAgICogQHBhcmFtIHtib29sZWFuPX0gb3B0X2luY2x1ZGVJbnN0YW5jZSBEZXByZWNhdGVkLiB3aGV0aGVyIHRvIGluY2x1ZGUgdGhlCiAgICogICAgIEpTUEIgaW5zdGFuY2UgZm9yIHRyYW5zaXRpb25hbCBzb3kgcHJvdG8gc3VwcG9ydDoKICAgKiAgICAgaHR0cDovL2dvdG8vc295LXBhcmFtLW1pZ3JhdGlvbgogICAqIEByZXR1cm4geyFPYmplY3R9CiAgICovCiAgcHJvdG8ucGIuY21zLkFyZWFTdGF0UmVwbHkucHJvdG90eXBlLnRvT2JqZWN0ID0gZnVuY3Rpb24gKG9wdF9pbmNsdWRlSW5zdGFuY2UpIHsKICAgIHJldHVybiBwcm90by5wYi5jbXMuQXJlYVN0YXRSZXBseS50b09iamVjdChvcHRfaW5jbHVkZUluc3RhbmNlLCB0aGlzKTsKICB9OwogIC8qKgogICAqIFN0YXRpYyB2ZXJzaW9uIG9mIHRoZSB7QHNlZSB0b09iamVjdH0gbWV0aG9kLgogICAqIEBwYXJhbSB7Ym9vbGVhbnx1bmRlZmluZWR9IGluY2x1ZGVJbnN0YW5jZSBEZXByZWNhdGVkLiBXaGV0aGVyIHRvIGluY2x1ZGUKICAgKiAgICAgdGhlIEpTUEIgaW5zdGFuY2UgZm9yIHRyYW5zaXRpb25hbCBzb3kgcHJvdG8gc3VwcG9ydDoKICAgKiAgICAgaHR0cDovL2dvdG8vc295LXBhcmFtLW1pZ3JhdGlvbgogICAqIEBwYXJhbSB7IXByb3RvLnBiLmNtcy5BcmVhU3RhdFJlcGx5fSBtc2cgVGhlIG1zZyBpbnN0YW5jZSB0byB0cmFuc2Zvcm0uCiAgICogQHJldHVybiB7IU9iamVjdH0KICAgKiBAc3VwcHJlc3Mge3VudXNlZExvY2FsVmFyaWFibGVzfSBmIGlzIG9ubHkgdXNlZCBmb3IgbmVzdGVkIG1lc3NhZ2VzCiAgICovCgoKICBwcm90by5wYi5jbXMuQXJlYVN0YXRSZXBseS50b09iamVjdCA9IGZ1bmN0aW9uIChpbmNsdWRlSW5zdGFuY2UsIG1zZykgewogICAgdmFyIGYsCiAgICAgICAgb2JqID0ge307CgogICAgaWYgKGluY2x1ZGVJbnN0YW5jZSkgewogICAgICBvYmouJGpzcGJNZXNzYWdlSW5zdGFuY2UgPSBtc2c7CiAgICB9CgogICAgcmV0dXJuIG9iajsKICB9Owp9Ci8qKgogKiBEZXNlcmlhbGl6ZXMgYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUgZm9ybWF0KS4KICogQHBhcmFtIHtqc3BiLkJ5dGVTb3VyY2V9IGJ5dGVzIFRoZSBieXRlcyB0byBkZXNlcmlhbGl6ZS4KICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5BcmVhU3RhdFJlcGx5fQogKi8KCgpwcm90by5wYi5jbXMuQXJlYVN0YXRSZXBseS5kZXNlcmlhbGl6ZUJpbmFyeSA9IGZ1bmN0aW9uIChieXRlcykgewogIHZhciByZWFkZXIgPSBuZXcganNwYi5CaW5hcnlSZWFkZXIoYnl0ZXMpOwogIHZhciBtc2cgPSBuZXcgcHJvdG8ucGIuY21zLkFyZWFTdGF0UmVwbHkoKTsKICByZXR1cm4gcHJvdG8ucGIuY21zLkFyZWFTdGF0UmVwbHkuZGVzZXJpYWxpemVCaW5hcnlGcm9tUmVhZGVyKG1zZywgcmVhZGVyKTsKfTsKLyoqCiAqIERlc2VyaWFsaXplcyBiaW5hcnkgZGF0YSAoaW4gcHJvdG9idWYgd2lyZSBmb3JtYXQpIGZyb20gdGhlCiAqIGdpdmVuIHJlYWRlciBpbnRvIHRoZSBnaXZlbiBtZXNzYWdlIG9iamVjdC4KICogQHBhcmFtIHshcHJvdG8ucGIuY21zLkFyZWFTdGF0UmVwbHl9IG1zZyBUaGUgbWVzc2FnZSBvYmplY3QgdG8gZGVzZXJpYWxpemUgaW50by4KICogQHBhcmFtIHshanNwYi5CaW5hcnlSZWFkZXJ9IHJlYWRlciBUaGUgQmluYXJ5UmVhZGVyIHRvIHVzZS4KICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5BcmVhU3RhdFJlcGx5fQogKi8KCgpwcm90by5wYi5jbXMuQXJlYVN0YXRSZXBseS5kZXNlcmlhbGl6ZUJpbmFyeUZyb21SZWFkZXIgPSBmdW5jdGlvbiAobXNnLCByZWFkZXIpIHsKICB3aGlsZSAocmVhZGVyLm5leHRGaWVsZCgpKSB7CiAgICBpZiAocmVhZGVyLmlzRW5kR3JvdXAoKSkgewogICAgICBicmVhazsKICAgIH0KCiAgICB2YXIgZmllbGQgPSByZWFkZXIuZ2V0RmllbGROdW1iZXIoKTsKCiAgICBzd2l0Y2ggKGZpZWxkKSB7CiAgICAgIGRlZmF1bHQ6CiAgICAgICAgcmVhZGVyLnNraXBGaWVsZCgpOwogICAgICAgIGJyZWFrOwogICAgfQogIH0KCiAgcmV0dXJuIG1zZzsKfTsKLyoqCiAqIFNlcmlhbGl6ZXMgdGhlIG1lc3NhZ2UgdG8gYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUgZm9ybWF0KS4KICogQHJldHVybiB7IVVpbnQ4QXJyYXl9CiAqLwoKCnByb3RvLnBiLmNtcy5BcmVhU3RhdFJlcGx5LnByb3RvdHlwZS5zZXJpYWxpemVCaW5hcnkgPSBmdW5jdGlvbiAoKSB7CiAgdmFyIHdyaXRlciA9IG5ldyBqc3BiLkJpbmFyeVdyaXRlcigpOwogIHByb3RvLnBiLmNtcy5BcmVhU3RhdFJlcGx5LnNlcmlhbGl6ZUJpbmFyeVRvV3JpdGVyKHRoaXMsIHdyaXRlcik7CiAgcmV0dXJuIHdyaXRlci5nZXRSZXN1bHRCdWZmZXIoKTsKfTsKLyoqCiAqIFNlcmlhbGl6ZXMgdGhlIGdpdmVuIG1lc3NhZ2UgdG8gYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUKICogZm9ybWF0KSwgd3JpdGluZyB0byB0aGUgZ2l2ZW4gQmluYXJ5V3JpdGVyLgogKiBAcGFyYW0geyFwcm90by5wYi5jbXMuQXJlYVN0YXRSZXBseX0gbWVzc2FnZQogKiBAcGFyYW0geyFqc3BiLkJpbmFyeVdyaXRlcn0gd3JpdGVyCiAqIEBzdXBwcmVzcyB7dW51c2VkTG9jYWxWYXJpYWJsZXN9IGYgaXMgb25seSB1c2VkIGZvciBuZXN0ZWQgbWVzc2FnZXMKICovCgoKcHJvdG8ucGIuY21zLkFyZWFTdGF0UmVwbHkuc2VyaWFsaXplQmluYXJ5VG9Xcml0ZXIgPSBmdW5jdGlvbiAobWVzc2FnZSwgd3JpdGVyKSB7CiAgdmFyIGYgPSB1bmRlZmluZWQ7Cn07Ci8qKgogKiBMaXN0IG9mIHJlcGVhdGVkIGZpZWxkcyB3aXRoaW4gdGhpcyBtZXNzYWdlIHR5cGUuCiAqIEBwcml2YXRlIHshQXJyYXk8bnVtYmVyPn0KICogQGNvbnN0CiAqLwoKCnByb3RvLnBiLmNtcy5BZG1pbkxpc3RSZXBseS5yZXBlYXRlZEZpZWxkc18gPSBbMV07CgppZiAoanNwYi5NZXNzYWdlLkdFTkVSQVRFX1RPX09CSkVDVCkgewogIC8qKgogICAqIENyZWF0ZXMgYW4gb2JqZWN0IHJlcHJlc2VudGF0aW9uIG9mIHRoaXMgcHJvdG8uCiAgICogRmllbGQgbmFtZXMgdGhhdCBhcmUgcmVzZXJ2ZWQgaW4gSmF2YVNjcmlwdCBhbmQgd2lsbCBiZSByZW5hbWVkIHRvIHBiX25hbWUuCiAgICogT3B0aW9uYWwgZmllbGRzIHRoYXQgYXJlIG5vdCBzZXQgd2lsbCBiZSBzZXQgdG8gdW5kZWZpbmVkLgogICAqIFRvIGFjY2VzcyBhIHJlc2VydmVkIGZpZWxkIHVzZSwgZm9vLnBiXzxuYW1lPiwgZWcsIGZvby5wYl9kZWZhdWx0LgogICAqIEZvciB0aGUgbGlzdCBvZiByZXNlcnZlZCBuYW1lcyBwbGVhc2Ugc2VlOgogICAqICAgICBuZXQvcHJvdG8yL2NvbXBpbGVyL2pzL2ludGVybmFsL2dlbmVyYXRvci5jYyNrS2V5d29yZC4KICAgKiBAcGFyYW0ge2Jvb2xlYW49fSBvcHRfaW5jbHVkZUluc3RhbmNlIERlcHJlY2F0ZWQuIHdoZXRoZXIgdG8gaW5jbHVkZSB0aGUKICAgKiAgICAgSlNQQiBpbnN0YW5jZSBmb3IgdHJhbnNpdGlvbmFsIHNveSBwcm90byBzdXBwb3J0OgogICAqICAgICBodHRwOi8vZ290by9zb3ktcGFyYW0tbWlncmF0aW9uCiAgICogQHJldHVybiB7IU9iamVjdH0KICAgKi8KICBwcm90by5wYi5jbXMuQWRtaW5MaXN0UmVwbHkucHJvdG90eXBlLnRvT2JqZWN0ID0gZnVuY3Rpb24gKG9wdF9pbmNsdWRlSW5zdGFuY2UpIHsKICAgIHJldHVybiBwcm90by5wYi5jbXMuQWRtaW5MaXN0UmVwbHkudG9PYmplY3Qob3B0X2luY2x1ZGVJbnN0YW5jZSwgdGhpcyk7CiAgfTsKICAvKioKICAgKiBTdGF0aWMgdmVyc2lvbiBvZiB0aGUge0BzZWUgdG9PYmplY3R9IG1ldGhvZC4KICAgKiBAcGFyYW0ge2Jvb2xlYW58dW5kZWZpbmVkfSBpbmNsdWRlSW5zdGFuY2UgRGVwcmVjYXRlZC4gV2hldGhlciB0byBpbmNsdWRlCiAgICogICAgIHRoZSBKU1BCIGluc3RhbmNlIGZvciB0cmFuc2l0aW9uYWwgc295IHByb3RvIHN1cHBvcnQ6CiAgICogICAgIGh0dHA6Ly9nb3RvL3NveS1wYXJhbS1taWdyYXRpb24KICAgKiBAcGFyYW0geyFwcm90by5wYi5jbXMuQWRtaW5MaXN0UmVwbHl9IG1zZyBUaGUgbXNnIGluc3RhbmNlIHRvIHRyYW5zZm9ybS4KICAgKiBAcmV0dXJuIHshT2JqZWN0fQogICAqIEBzdXBwcmVzcyB7dW51c2VkTG9jYWxWYXJpYWJsZXN9IGYgaXMgb25seSB1c2VkIGZvciBuZXN0ZWQgbWVzc2FnZXMKICAgKi8KCgogIHByb3RvLnBiLmNtcy5BZG1pbkxpc3RSZXBseS50b09iamVjdCA9IGZ1bmN0aW9uIChpbmNsdWRlSW5zdGFuY2UsIG1zZykgewogICAgdmFyIGYsCiAgICAgICAgb2JqID0gewogICAgICBhZG1pbnNMaXN0OiBqc3BiLk1lc3NhZ2UudG9PYmplY3RMaXN0KG1zZy5nZXRBZG1pbnNMaXN0KCksIGNtc3R5cGVfcGIuQWRtaW4udG9PYmplY3QsIGluY2x1ZGVJbnN0YW5jZSkKICAgIH07CgogICAgaWYgKGluY2x1ZGVJbnN0YW5jZSkgewogICAgICBvYmouJGpzcGJNZXNzYWdlSW5zdGFuY2UgPSBtc2c7CiAgICB9CgogICAgcmV0dXJuIG9iajsKICB9Owp9Ci8qKgogKiBEZXNlcmlhbGl6ZXMgYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUgZm9ybWF0KS4KICogQHBhcmFtIHtqc3BiLkJ5dGVTb3VyY2V9IGJ5dGVzIFRoZSBieXRlcyB0byBkZXNlcmlhbGl6ZS4KICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5BZG1pbkxpc3RSZXBseX0KICovCgoKcHJvdG8ucGIuY21zLkFkbWluTGlzdFJlcGx5LmRlc2VyaWFsaXplQmluYXJ5ID0gZnVuY3Rpb24gKGJ5dGVzKSB7CiAgdmFyIHJlYWRlciA9IG5ldyBqc3BiLkJpbmFyeVJlYWRlcihieXRlcyk7CiAgdmFyIG1zZyA9IG5ldyBwcm90by5wYi5jbXMuQWRtaW5MaXN0UmVwbHkoKTsKICByZXR1cm4gcHJvdG8ucGIuY21zLkFkbWluTGlzdFJlcGx5LmRlc2VyaWFsaXplQmluYXJ5RnJvbVJlYWRlcihtc2csIHJlYWRlcik7Cn07Ci8qKgogKiBEZXNlcmlhbGl6ZXMgYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUgZm9ybWF0KSBmcm9tIHRoZQogKiBnaXZlbiByZWFkZXIgaW50byB0aGUgZ2l2ZW4gbWVzc2FnZSBvYmplY3QuCiAqIEBwYXJhbSB7IXByb3RvLnBiLmNtcy5BZG1pbkxpc3RSZXBseX0gbXNnIFRoZSBtZXNzYWdlIG9iamVjdCB0byBkZXNlcmlhbGl6ZSBpbnRvLgogKiBAcGFyYW0geyFqc3BiLkJpbmFyeVJlYWRlcn0gcmVhZGVyIFRoZSBCaW5hcnlSZWFkZXIgdG8gdXNlLgogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLkFkbWluTGlzdFJlcGx5fQogKi8KCgpwcm90by5wYi5jbXMuQWRtaW5MaXN0UmVwbHkuZGVzZXJpYWxpemVCaW5hcnlGcm9tUmVhZGVyID0gZnVuY3Rpb24gKG1zZywgcmVhZGVyKSB7CiAgd2hpbGUgKHJlYWRlci5uZXh0RmllbGQoKSkgewogICAgaWYgKHJlYWRlci5pc0VuZEdyb3VwKCkpIHsKICAgICAgYnJlYWs7CiAgICB9CgogICAgdmFyIGZpZWxkID0gcmVhZGVyLmdldEZpZWxkTnVtYmVyKCk7CgogICAgc3dpdGNoIChmaWVsZCkgewogICAgICBjYXNlIDE6CiAgICAgICAgdmFyIHZhbHVlID0gbmV3IGNtc3R5cGVfcGIuQWRtaW4oKTsKICAgICAgICByZWFkZXIucmVhZE1lc3NhZ2UodmFsdWUsIGNtc3R5cGVfcGIuQWRtaW4uZGVzZXJpYWxpemVCaW5hcnlGcm9tUmVhZGVyKTsKICAgICAgICBtc2cuYWRkQWRtaW5zKHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGRlZmF1bHQ6CiAgICAgICAgcmVhZGVyLnNraXBGaWVsZCgpOwogICAgICAgIGJyZWFrOwogICAgfQogIH0KCiAgcmV0dXJuIG1zZzsKfTsKLyoqCiAqIFNlcmlhbGl6ZXMgdGhlIG1lc3NhZ2UgdG8gYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUgZm9ybWF0KS4KICogQHJldHVybiB7IVVpbnQ4QXJyYXl9CiAqLwoKCnByb3RvLnBiLmNtcy5BZG1pbkxpc3RSZXBseS5wcm90b3R5cGUuc2VyaWFsaXplQmluYXJ5ID0gZnVuY3Rpb24gKCkgewogIHZhciB3cml0ZXIgPSBuZXcganNwYi5CaW5hcnlXcml0ZXIoKTsKICBwcm90by5wYi5jbXMuQWRtaW5MaXN0UmVwbHkuc2VyaWFsaXplQmluYXJ5VG9Xcml0ZXIodGhpcywgd3JpdGVyKTsKICByZXR1cm4gd3JpdGVyLmdldFJlc3VsdEJ1ZmZlcigpOwp9OwovKioKICogU2VyaWFsaXplcyB0aGUgZ2l2ZW4gbWVzc2FnZSB0byBiaW5hcnkgZGF0YSAoaW4gcHJvdG9idWYgd2lyZQogKiBmb3JtYXQpLCB3cml0aW5nIHRvIHRoZSBnaXZlbiBCaW5hcnlXcml0ZXIuCiAqIEBwYXJhbSB7IXByb3RvLnBiLmNtcy5BZG1pbkxpc3RSZXBseX0gbWVzc2FnZQogKiBAcGFyYW0geyFqc3BiLkJpbmFyeVdyaXRlcn0gd3JpdGVyCiAqIEBzdXBwcmVzcyB7dW51c2VkTG9jYWxWYXJpYWJsZXN9IGYgaXMgb25seSB1c2VkIGZvciBuZXN0ZWQgbWVzc2FnZXMKICovCgoKcHJvdG8ucGIuY21zLkFkbWluTGlzdFJlcGx5LnNlcmlhbGl6ZUJpbmFyeVRvV3JpdGVyID0gZnVuY3Rpb24gKG1lc3NhZ2UsIHdyaXRlcikgewogIHZhciBmID0gdW5kZWZpbmVkOwogIGYgPSBtZXNzYWdlLmdldEFkbWluc0xpc3QoKTsKCiAgaWYgKGYubGVuZ3RoID4gMCkgewogICAgd3JpdGVyLndyaXRlUmVwZWF0ZWRNZXNzYWdlKDEsIGYsIGNtc3R5cGVfcGIuQWRtaW4uc2VyaWFsaXplQmluYXJ5VG9Xcml0ZXIpOwogIH0KfTsKLyoqCiAqIHJlcGVhdGVkIHBiLkFkbWluIGFkbWlucyA9IDE7CiAqIEByZXR1cm4geyFBcnJheTwhcHJvdG8ucGIuQWRtaW4+fQogKi8KCgpwcm90by5wYi5jbXMuQWRtaW5MaXN0UmVwbHkucHJvdG90eXBlLmdldEFkbWluc0xpc3QgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRSZXBlYXRlZFdyYXBwZXJGaWVsZCh0aGlzLCBjbXN0eXBlX3BiLkFkbWluLCAxKTsKfTsKLyoqCiAqIEBwYXJhbSB7IUFycmF5PCFwcm90by5wYi5BZG1pbj59IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuQWRtaW5MaXN0UmVwbHl9IHJldHVybnMgdGhpcwoqLwoKCnByb3RvLnBiLmNtcy5BZG1pbkxpc3RSZXBseS5wcm90b3R5cGUuc2V0QWRtaW5zTGlzdCA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UmVwZWF0ZWRXcmFwcGVyRmllbGQodGhpcywgMSwgdmFsdWUpOwp9OwovKioKICogQHBhcmFtIHshcHJvdG8ucGIuQWRtaW49fSBvcHRfdmFsdWUKICogQHBhcmFtIHtudW1iZXI9fSBvcHRfaW5kZXgKICogQHJldHVybiB7IXByb3RvLnBiLkFkbWlufQogKi8KCgpwcm90by5wYi5jbXMuQWRtaW5MaXN0UmVwbHkucHJvdG90eXBlLmFkZEFkbWlucyA9IGZ1bmN0aW9uIChvcHRfdmFsdWUsIG9wdF9pbmRleCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuYWRkVG9SZXBlYXRlZFdyYXBwZXJGaWVsZCh0aGlzLCAxLCBvcHRfdmFsdWUsIHByb3RvLnBiLkFkbWluLCBvcHRfaW5kZXgpOwp9OwovKioKICogQ2xlYXJzIHRoZSBsaXN0IG1ha2luZyBpdCBlbXB0eSBidXQgbm9uLW51bGwuCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuQWRtaW5MaXN0UmVwbHl9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuQWRtaW5MaXN0UmVwbHkucHJvdG90eXBlLmNsZWFyQWRtaW5zTGlzdCA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4gdGhpcy5zZXRBZG1pbnNMaXN0KFtdKTsKfTsKLyoqCiAqIExpc3Qgb2YgcmVwZWF0ZWQgZmllbGRzIHdpdGhpbiB0aGlzIG1lc3NhZ2UgdHlwZS4KICogQHByaXZhdGUgeyFBcnJheTxudW1iZXI+fQogKiBAY29uc3QKICovCgoKcHJvdG8ucGIuY21zLkd1aWxkTGlzdFJlcGx5LnJlcGVhdGVkRmllbGRzXyA9IFsxXTsKCmlmIChqc3BiLk1lc3NhZ2UuR0VORVJBVEVfVE9fT0JKRUNUKSB7CiAgLyoqCiAgICogQ3JlYXRlcyBhbiBvYmplY3QgcmVwcmVzZW50YXRpb24gb2YgdGhpcyBwcm90by4KICAgKiBGaWVsZCBuYW1lcyB0aGF0IGFyZSByZXNlcnZlZCBpbiBKYXZhU2NyaXB0IGFuZCB3aWxsIGJlIHJlbmFtZWQgdG8gcGJfbmFtZS4KICAgKiBPcHRpb25hbCBmaWVsZHMgdGhhdCBhcmUgbm90IHNldCB3aWxsIGJlIHNldCB0byB1bmRlZmluZWQuCiAgICogVG8gYWNjZXNzIGEgcmVzZXJ2ZWQgZmllbGQgdXNlLCBmb28ucGJfPG5hbWU+LCBlZywgZm9vLnBiX2RlZmF1bHQuCiAgICogRm9yIHRoZSBsaXN0IG9mIHJlc2VydmVkIG5hbWVzIHBsZWFzZSBzZWU6CiAgICogICAgIG5ldC9wcm90bzIvY29tcGlsZXIvanMvaW50ZXJuYWwvZ2VuZXJhdG9yLmNjI2tLZXl3b3JkLgogICAqIEBwYXJhbSB7Ym9vbGVhbj19IG9wdF9pbmNsdWRlSW5zdGFuY2UgRGVwcmVjYXRlZC4gd2hldGhlciB0byBpbmNsdWRlIHRoZQogICAqICAgICBKU1BCIGluc3RhbmNlIGZvciB0cmFuc2l0aW9uYWwgc295IHByb3RvIHN1cHBvcnQ6CiAgICogICAgIGh0dHA6Ly9nb3RvL3NveS1wYXJhbS1taWdyYXRpb24KICAgKiBAcmV0dXJuIHshT2JqZWN0fQogICAqLwogIHByb3RvLnBiLmNtcy5HdWlsZExpc3RSZXBseS5wcm90b3R5cGUudG9PYmplY3QgPSBmdW5jdGlvbiAob3B0X2luY2x1ZGVJbnN0YW5jZSkgewogICAgcmV0dXJuIHByb3RvLnBiLmNtcy5HdWlsZExpc3RSZXBseS50b09iamVjdChvcHRfaW5jbHVkZUluc3RhbmNlLCB0aGlzKTsKICB9OwogIC8qKgogICAqIFN0YXRpYyB2ZXJzaW9uIG9mIHRoZSB7QHNlZSB0b09iamVjdH0gbWV0aG9kLgogICAqIEBwYXJhbSB7Ym9vbGVhbnx1bmRlZmluZWR9IGluY2x1ZGVJbnN0YW5jZSBEZXByZWNhdGVkLiBXaGV0aGVyIHRvIGluY2x1ZGUKICAgKiAgICAgdGhlIEpTUEIgaW5zdGFuY2UgZm9yIHRyYW5zaXRpb25hbCBzb3kgcHJvdG8gc3VwcG9ydDoKICAgKiAgICAgaHR0cDovL2dvdG8vc295LXBhcmFtLW1pZ3JhdGlvbgogICAqIEBwYXJhbSB7IXByb3RvLnBiLmNtcy5HdWlsZExpc3RSZXBseX0gbXNnIFRoZSBtc2cgaW5zdGFuY2UgdG8gdHJhbnNmb3JtLgogICAqIEByZXR1cm4geyFPYmplY3R9CiAgICogQHN1cHByZXNzIHt1bnVzZWRMb2NhbFZhcmlhYmxlc30gZiBpcyBvbmx5IHVzZWQgZm9yIG5lc3RlZCBtZXNzYWdlcwogICAqLwoKCiAgcHJvdG8ucGIuY21zLkd1aWxkTGlzdFJlcGx5LnRvT2JqZWN0ID0gZnVuY3Rpb24gKGluY2x1ZGVJbnN0YW5jZSwgbXNnKSB7CiAgICB2YXIgZiwKICAgICAgICBvYmogPSB7CiAgICAgIGd1aWxkc0xpc3Q6IGpzcGIuTWVzc2FnZS50b09iamVjdExpc3QobXNnLmdldEd1aWxkc0xpc3QoKSwgY21zdHlwZV9wYi5HdWlsZC50b09iamVjdCwgaW5jbHVkZUluc3RhbmNlKQogICAgfTsKCiAgICBpZiAoaW5jbHVkZUluc3RhbmNlKSB7CiAgICAgIG9iai4kanNwYk1lc3NhZ2VJbnN0YW5jZSA9IG1zZzsKICAgIH0KCiAgICByZXR1cm4gb2JqOwogIH07Cn0KLyoqCiAqIERlc2VyaWFsaXplcyBiaW5hcnkgZGF0YSAoaW4gcHJvdG9idWYgd2lyZSBmb3JtYXQpLgogKiBAcGFyYW0ge2pzcGIuQnl0ZVNvdXJjZX0gYnl0ZXMgVGhlIGJ5dGVzIHRvIGRlc2VyaWFsaXplLgogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLkd1aWxkTGlzdFJlcGx5fQogKi8KCgpwcm90by5wYi5jbXMuR3VpbGRMaXN0UmVwbHkuZGVzZXJpYWxpemVCaW5hcnkgPSBmdW5jdGlvbiAoYnl0ZXMpIHsKICB2YXIgcmVhZGVyID0gbmV3IGpzcGIuQmluYXJ5UmVhZGVyKGJ5dGVzKTsKICB2YXIgbXNnID0gbmV3IHByb3RvLnBiLmNtcy5HdWlsZExpc3RSZXBseSgpOwogIHJldHVybiBwcm90by5wYi5jbXMuR3VpbGRMaXN0UmVwbHkuZGVzZXJpYWxpemVCaW5hcnlGcm9tUmVhZGVyKG1zZywgcmVhZGVyKTsKfTsKLyoqCiAqIERlc2VyaWFsaXplcyBiaW5hcnkgZGF0YSAoaW4gcHJvdG9idWYgd2lyZSBmb3JtYXQpIGZyb20gdGhlCiAqIGdpdmVuIHJlYWRlciBpbnRvIHRoZSBnaXZlbiBtZXNzYWdlIG9iamVjdC4KICogQHBhcmFtIHshcHJvdG8ucGIuY21zLkd1aWxkTGlzdFJlcGx5fSBtc2cgVGhlIG1lc3NhZ2Ugb2JqZWN0IHRvIGRlc2VyaWFsaXplIGludG8uCiAqIEBwYXJhbSB7IWpzcGIuQmluYXJ5UmVhZGVyfSByZWFkZXIgVGhlIEJpbmFyeVJlYWRlciB0byB1c2UuCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuR3VpbGRMaXN0UmVwbHl9CiAqLwoKCnByb3RvLnBiLmNtcy5HdWlsZExpc3RSZXBseS5kZXNlcmlhbGl6ZUJpbmFyeUZyb21SZWFkZXIgPSBmdW5jdGlvbiAobXNnLCByZWFkZXIpIHsKICB3aGlsZSAocmVhZGVyLm5leHRGaWVsZCgpKSB7CiAgICBpZiAocmVhZGVyLmlzRW5kR3JvdXAoKSkgewogICAgICBicmVhazsKICAgIH0KCiAgICB2YXIgZmllbGQgPSByZWFkZXIuZ2V0RmllbGROdW1iZXIoKTsKCiAgICBzd2l0Y2ggKGZpZWxkKSB7CiAgICAgIGNhc2UgMToKICAgICAgICB2YXIgdmFsdWUgPSBuZXcgY21zdHlwZV9wYi5HdWlsZCgpOwogICAgICAgIHJlYWRlci5yZWFkTWVzc2FnZSh2YWx1ZSwgY21zdHlwZV9wYi5HdWlsZC5kZXNlcmlhbGl6ZUJpbmFyeUZyb21SZWFkZXIpOwogICAgICAgIG1zZy5hZGRHdWlsZHModmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgZGVmYXVsdDoKICAgICAgICByZWFkZXIuc2tpcEZpZWxkKCk7CiAgICAgICAgYnJlYWs7CiAgICB9CiAgfQoKICByZXR1cm4gbXNnOwp9OwovKioKICogU2VyaWFsaXplcyB0aGUgbWVzc2FnZSB0byBiaW5hcnkgZGF0YSAoaW4gcHJvdG9idWYgd2lyZSBmb3JtYXQpLgogKiBAcmV0dXJuIHshVWludDhBcnJheX0KICovCgoKcHJvdG8ucGIuY21zLkd1aWxkTGlzdFJlcGx5LnByb3RvdHlwZS5zZXJpYWxpemVCaW5hcnkgPSBmdW5jdGlvbiAoKSB7CiAgdmFyIHdyaXRlciA9IG5ldyBqc3BiLkJpbmFyeVdyaXRlcigpOwogIHByb3RvLnBiLmNtcy5HdWlsZExpc3RSZXBseS5zZXJpYWxpemVCaW5hcnlUb1dyaXRlcih0aGlzLCB3cml0ZXIpOwogIHJldHVybiB3cml0ZXIuZ2V0UmVzdWx0QnVmZmVyKCk7Cn07Ci8qKgogKiBTZXJpYWxpemVzIHRoZSBnaXZlbiBtZXNzYWdlIHRvIGJpbmFyeSBkYXRhIChpbiBwcm90b2J1ZiB3aXJlCiAqIGZvcm1hdCksIHdyaXRpbmcgdG8gdGhlIGdpdmVuIEJpbmFyeVdyaXRlci4KICogQHBhcmFtIHshcHJvdG8ucGIuY21zLkd1aWxkTGlzdFJlcGx5fSBtZXNzYWdlCiAqIEBwYXJhbSB7IWpzcGIuQmluYXJ5V3JpdGVyfSB3cml0ZXIKICogQHN1cHByZXNzIHt1bnVzZWRMb2NhbFZhcmlhYmxlc30gZiBpcyBvbmx5IHVzZWQgZm9yIG5lc3RlZCBtZXNzYWdlcwogKi8KCgpwcm90by5wYi5jbXMuR3VpbGRMaXN0UmVwbHkuc2VyaWFsaXplQmluYXJ5VG9Xcml0ZXIgPSBmdW5jdGlvbiAobWVzc2FnZSwgd3JpdGVyKSB7CiAgdmFyIGYgPSB1bmRlZmluZWQ7CiAgZiA9IG1lc3NhZ2UuZ2V0R3VpbGRzTGlzdCgpOwoKICBpZiAoZi5sZW5ndGggPiAwKSB7CiAgICB3cml0ZXIud3JpdGVSZXBlYXRlZE1lc3NhZ2UoMSwgZiwgY21zdHlwZV9wYi5HdWlsZC5zZXJpYWxpemVCaW5hcnlUb1dyaXRlcik7CiAgfQp9OwovKioKICogcmVwZWF0ZWQgcGIuR3VpbGQgZ3VpbGRzID0gMTsKICogQHJldHVybiB7IUFycmF5PCFwcm90by5wYi5HdWlsZD59CiAqLwoKCnByb3RvLnBiLmNtcy5HdWlsZExpc3RSZXBseS5wcm90b3R5cGUuZ2V0R3VpbGRzTGlzdCA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldFJlcGVhdGVkV3JhcHBlckZpZWxkKHRoaXMsIGNtc3R5cGVfcGIuR3VpbGQsIDEpOwp9OwovKioKICogQHBhcmFtIHshQXJyYXk8IXByb3RvLnBiLkd1aWxkPn0gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5HdWlsZExpc3RSZXBseX0gcmV0dXJucyB0aGlzCiovCgoKcHJvdG8ucGIuY21zLkd1aWxkTGlzdFJlcGx5LnByb3RvdHlwZS5zZXRHdWlsZHNMaXN0ID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRSZXBlYXRlZFdyYXBwZXJGaWVsZCh0aGlzLCAxLCB2YWx1ZSk7Cn07Ci8qKgogKiBAcGFyYW0geyFwcm90by5wYi5HdWlsZD19IG9wdF92YWx1ZQogKiBAcGFyYW0ge251bWJlcj19IG9wdF9pbmRleAogKiBAcmV0dXJuIHshcHJvdG8ucGIuR3VpbGR9CiAqLwoKCnByb3RvLnBiLmNtcy5HdWlsZExpc3RSZXBseS5wcm90b3R5cGUuYWRkR3VpbGRzID0gZnVuY3Rpb24gKG9wdF92YWx1ZSwgb3B0X2luZGV4KSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5hZGRUb1JlcGVhdGVkV3JhcHBlckZpZWxkKHRoaXMsIDEsIG9wdF92YWx1ZSwgcHJvdG8ucGIuR3VpbGQsIG9wdF9pbmRleCk7Cn07Ci8qKgogKiBDbGVhcnMgdGhlIGxpc3QgbWFraW5nIGl0IGVtcHR5IGJ1dCBub24tbnVsbC4KICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5HdWlsZExpc3RSZXBseX0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5HdWlsZExpc3RSZXBseS5wcm90b3R5cGUuY2xlYXJHdWlsZHNMaXN0ID0gZnVuY3Rpb24gKCkgewogIHJldHVybiB0aGlzLnNldEd1aWxkc0xpc3QoW10pOwp9OwovKioKICogTGlzdCBvZiByZXBlYXRlZCBmaWVsZHMgd2l0aGluIHRoaXMgbWVzc2FnZSB0eXBlLgogKiBAcHJpdmF0ZSB7IUFycmF5PG51bWJlcj59CiAqIEBjb25zdAogKi8KCgpwcm90by5wYi5jbXMuQXBwTGlzdFJlcGx5LnJlcGVhdGVkRmllbGRzXyA9IFsxXTsKCmlmIChqc3BiLk1lc3NhZ2UuR0VORVJBVEVfVE9fT0JKRUNUKSB7CiAgLyoqCiAgICogQ3JlYXRlcyBhbiBvYmplY3QgcmVwcmVzZW50YXRpb24gb2YgdGhpcyBwcm90by4KICAgKiBGaWVsZCBuYW1lcyB0aGF0IGFyZSByZXNlcnZlZCBpbiBKYXZhU2NyaXB0IGFuZCB3aWxsIGJlIHJlbmFtZWQgdG8gcGJfbmFtZS4KICAgKiBPcHRpb25hbCBmaWVsZHMgdGhhdCBhcmUgbm90IHNldCB3aWxsIGJlIHNldCB0byB1bmRlZmluZWQuCiAgICogVG8gYWNjZXNzIGEgcmVzZXJ2ZWQgZmllbGQgdXNlLCBmb28ucGJfPG5hbWU+LCBlZywgZm9vLnBiX2RlZmF1bHQuCiAgICogRm9yIHRoZSBsaXN0IG9mIHJlc2VydmVkIG5hbWVzIHBsZWFzZSBzZWU6CiAgICogICAgIG5ldC9wcm90bzIvY29tcGlsZXIvanMvaW50ZXJuYWwvZ2VuZXJhdG9yLmNjI2tLZXl3b3JkLgogICAqIEBwYXJhbSB7Ym9vbGVhbj19IG9wdF9pbmNsdWRlSW5zdGFuY2UgRGVwcmVjYXRlZC4gd2hldGhlciB0byBpbmNsdWRlIHRoZQogICAqICAgICBKU1BCIGluc3RhbmNlIGZvciB0cmFuc2l0aW9uYWwgc295IHByb3RvIHN1cHBvcnQ6CiAgICogICAgIGh0dHA6Ly9nb3RvL3NveS1wYXJhbS1taWdyYXRpb24KICAgKiBAcmV0dXJuIHshT2JqZWN0fQogICAqLwogIHByb3RvLnBiLmNtcy5BcHBMaXN0UmVwbHkucHJvdG90eXBlLnRvT2JqZWN0ID0gZnVuY3Rpb24gKG9wdF9pbmNsdWRlSW5zdGFuY2UpIHsKICAgIHJldHVybiBwcm90by5wYi5jbXMuQXBwTGlzdFJlcGx5LnRvT2JqZWN0KG9wdF9pbmNsdWRlSW5zdGFuY2UsIHRoaXMpOwogIH07CiAgLyoqCiAgICogU3RhdGljIHZlcnNpb24gb2YgdGhlIHtAc2VlIHRvT2JqZWN0fSBtZXRob2QuCiAgICogQHBhcmFtIHtib29sZWFufHVuZGVmaW5lZH0gaW5jbHVkZUluc3RhbmNlIERlcHJlY2F0ZWQuIFdoZXRoZXIgdG8gaW5jbHVkZQogICAqICAgICB0aGUgSlNQQiBpbnN0YW5jZSBmb3IgdHJhbnNpdGlvbmFsIHNveSBwcm90byBzdXBwb3J0OgogICAqICAgICBodHRwOi8vZ290by9zb3ktcGFyYW0tbWlncmF0aW9uCiAgICogQHBhcmFtIHshcHJvdG8ucGIuY21zLkFwcExpc3RSZXBseX0gbXNnIFRoZSBtc2cgaW5zdGFuY2UgdG8gdHJhbnNmb3JtLgogICAqIEByZXR1cm4geyFPYmplY3R9CiAgICogQHN1cHByZXNzIHt1bnVzZWRMb2NhbFZhcmlhYmxlc30gZiBpcyBvbmx5IHVzZWQgZm9yIG5lc3RlZCBtZXNzYWdlcwogICAqLwoKCiAgcHJvdG8ucGIuY21zLkFwcExpc3RSZXBseS50b09iamVjdCA9IGZ1bmN0aW9uIChpbmNsdWRlSW5zdGFuY2UsIG1zZykgewogICAgdmFyIGYsCiAgICAgICAgb2JqID0gewogICAgICBhcHBzTGlzdDoganNwYi5NZXNzYWdlLnRvT2JqZWN0TGlzdChtc2cuZ2V0QXBwc0xpc3QoKSwgY21zdHlwZV9wYi5BcHAudG9PYmplY3QsIGluY2x1ZGVJbnN0YW5jZSkKICAgIH07CgogICAgaWYgKGluY2x1ZGVJbnN0YW5jZSkgewogICAgICBvYmouJGpzcGJNZXNzYWdlSW5zdGFuY2UgPSBtc2c7CiAgICB9CgogICAgcmV0dXJuIG9iajsKICB9Owp9Ci8qKgogKiBEZXNlcmlhbGl6ZXMgYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUgZm9ybWF0KS4KICogQHBhcmFtIHtqc3BiLkJ5dGVTb3VyY2V9IGJ5dGVzIFRoZSBieXRlcyB0byBkZXNlcmlhbGl6ZS4KICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5BcHBMaXN0UmVwbHl9CiAqLwoKCnByb3RvLnBiLmNtcy5BcHBMaXN0UmVwbHkuZGVzZXJpYWxpemVCaW5hcnkgPSBmdW5jdGlvbiAoYnl0ZXMpIHsKICB2YXIgcmVhZGVyID0gbmV3IGpzcGIuQmluYXJ5UmVhZGVyKGJ5dGVzKTsKICB2YXIgbXNnID0gbmV3IHByb3RvLnBiLmNtcy5BcHBMaXN0UmVwbHkoKTsKICByZXR1cm4gcHJvdG8ucGIuY21zLkFwcExpc3RSZXBseS5kZXNlcmlhbGl6ZUJpbmFyeUZyb21SZWFkZXIobXNnLCByZWFkZXIpOwp9OwovKioKICogRGVzZXJpYWxpemVzIGJpbmFyeSBkYXRhIChpbiBwcm90b2J1ZiB3aXJlIGZvcm1hdCkgZnJvbSB0aGUKICogZ2l2ZW4gcmVhZGVyIGludG8gdGhlIGdpdmVuIG1lc3NhZ2Ugb2JqZWN0LgogKiBAcGFyYW0geyFwcm90by5wYi5jbXMuQXBwTGlzdFJlcGx5fSBtc2cgVGhlIG1lc3NhZ2Ugb2JqZWN0IHRvIGRlc2VyaWFsaXplIGludG8uCiAqIEBwYXJhbSB7IWpzcGIuQmluYXJ5UmVhZGVyfSByZWFkZXIgVGhlIEJpbmFyeVJlYWRlciB0byB1c2UuCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuQXBwTGlzdFJlcGx5fQogKi8KCgpwcm90by5wYi5jbXMuQXBwTGlzdFJlcGx5LmRlc2VyaWFsaXplQmluYXJ5RnJvbVJlYWRlciA9IGZ1bmN0aW9uIChtc2csIHJlYWRlcikgewogIHdoaWxlIChyZWFkZXIubmV4dEZpZWxkKCkpIHsKICAgIGlmIChyZWFkZXIuaXNFbmRHcm91cCgpKSB7CiAgICAgIGJyZWFrOwogICAgfQoKICAgIHZhciBmaWVsZCA9IHJlYWRlci5nZXRGaWVsZE51bWJlcigpOwoKICAgIHN3aXRjaCAoZmllbGQpIHsKICAgICAgY2FzZSAxOgogICAgICAgIHZhciB2YWx1ZSA9IG5ldyBjbXN0eXBlX3BiLkFwcCgpOwogICAgICAgIHJlYWRlci5yZWFkTWVzc2FnZSh2YWx1ZSwgY21zdHlwZV9wYi5BcHAuZGVzZXJpYWxpemVCaW5hcnlGcm9tUmVhZGVyKTsKICAgICAgICBtc2cuYWRkQXBwcyh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBkZWZhdWx0OgogICAgICAgIHJlYWRlci5za2lwRmllbGQoKTsKICAgICAgICBicmVhazsKICAgIH0KICB9CgogIHJldHVybiBtc2c7Cn07Ci8qKgogKiBTZXJpYWxpemVzIHRoZSBtZXNzYWdlIHRvIGJpbmFyeSBkYXRhIChpbiBwcm90b2J1ZiB3aXJlIGZvcm1hdCkuCiAqIEByZXR1cm4geyFVaW50OEFycmF5fQogKi8KCgpwcm90by5wYi5jbXMuQXBwTGlzdFJlcGx5LnByb3RvdHlwZS5zZXJpYWxpemVCaW5hcnkgPSBmdW5jdGlvbiAoKSB7CiAgdmFyIHdyaXRlciA9IG5ldyBqc3BiLkJpbmFyeVdyaXRlcigpOwogIHByb3RvLnBiLmNtcy5BcHBMaXN0UmVwbHkuc2VyaWFsaXplQmluYXJ5VG9Xcml0ZXIodGhpcywgd3JpdGVyKTsKICByZXR1cm4gd3JpdGVyLmdldFJlc3VsdEJ1ZmZlcigpOwp9OwovKioKICogU2VyaWFsaXplcyB0aGUgZ2l2ZW4gbWVzc2FnZSB0byBiaW5hcnkgZGF0YSAoaW4gcHJvdG9idWYgd2lyZQogKiBmb3JtYXQpLCB3cml0aW5nIHRvIHRoZSBnaXZlbiBCaW5hcnlXcml0ZXIuCiAqIEBwYXJhbSB7IXByb3RvLnBiLmNtcy5BcHBMaXN0UmVwbHl9IG1lc3NhZ2UKICogQHBhcmFtIHshanNwYi5CaW5hcnlXcml0ZXJ9IHdyaXRlcgogKiBAc3VwcHJlc3Mge3VudXNlZExvY2FsVmFyaWFibGVzfSBmIGlzIG9ubHkgdXNlZCBmb3IgbmVzdGVkIG1lc3NhZ2VzCiAqLwoKCnByb3RvLnBiLmNtcy5BcHBMaXN0UmVwbHkuc2VyaWFsaXplQmluYXJ5VG9Xcml0ZXIgPSBmdW5jdGlvbiAobWVzc2FnZSwgd3JpdGVyKSB7CiAgdmFyIGYgPSB1bmRlZmluZWQ7CiAgZiA9IG1lc3NhZ2UuZ2V0QXBwc0xpc3QoKTsKCiAgaWYgKGYubGVuZ3RoID4gMCkgewogICAgd3JpdGVyLndyaXRlUmVwZWF0ZWRNZXNzYWdlKDEsIGYsIGNtc3R5cGVfcGIuQXBwLnNlcmlhbGl6ZUJpbmFyeVRvV3JpdGVyKTsKICB9Cn07Ci8qKgogKiByZXBlYXRlZCBwYi5BcHAgYXBwcyA9IDE7CiAqIEByZXR1cm4geyFBcnJheTwhcHJvdG8ucGIuQXBwPn0KICovCgoKcHJvdG8ucGIuY21zLkFwcExpc3RSZXBseS5wcm90b3R5cGUuZ2V0QXBwc0xpc3QgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRSZXBlYXRlZFdyYXBwZXJGaWVsZCh0aGlzLCBjbXN0eXBlX3BiLkFwcCwgMSk7Cn07Ci8qKgogKiBAcGFyYW0geyFBcnJheTwhcHJvdG8ucGIuQXBwPn0gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5BcHBMaXN0UmVwbHl9IHJldHVybnMgdGhpcwoqLwoKCnByb3RvLnBiLmNtcy5BcHBMaXN0UmVwbHkucHJvdG90eXBlLnNldEFwcHNMaXN0ID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRSZXBlYXRlZFdyYXBwZXJGaWVsZCh0aGlzLCAxLCB2YWx1ZSk7Cn07Ci8qKgogKiBAcGFyYW0geyFwcm90by5wYi5BcHA9fSBvcHRfdmFsdWUKICogQHBhcmFtIHtudW1iZXI9fSBvcHRfaW5kZXgKICogQHJldHVybiB7IXByb3RvLnBiLkFwcH0KICovCgoKcHJvdG8ucGIuY21zLkFwcExpc3RSZXBseS5wcm90b3R5cGUuYWRkQXBwcyA9IGZ1bmN0aW9uIChvcHRfdmFsdWUsIG9wdF9pbmRleCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuYWRkVG9SZXBlYXRlZFdyYXBwZXJGaWVsZCh0aGlzLCAxLCBvcHRfdmFsdWUsIHByb3RvLnBiLkFwcCwgb3B0X2luZGV4KTsKfTsKLyoqCiAqIENsZWFycyB0aGUgbGlzdCBtYWtpbmcgaXQgZW1wdHkgYnV0IG5vbi1udWxsLgogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLkFwcExpc3RSZXBseX0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5BcHBMaXN0UmVwbHkucHJvdG90eXBlLmNsZWFyQXBwc0xpc3QgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIHRoaXMuc2V0QXBwc0xpc3QoW10pOwp9OwoKaWYgKGpzcGIuTWVzc2FnZS5HRU5FUkFURV9UT19PQkpFQ1QpIHsKICAvKioKICAgKiBDcmVhdGVzIGFuIG9iamVjdCByZXByZXNlbnRhdGlvbiBvZiB0aGlzIHByb3RvLgogICAqIEZpZWxkIG5hbWVzIHRoYXQgYXJlIHJlc2VydmVkIGluIEphdmFTY3JpcHQgYW5kIHdpbGwgYmUgcmVuYW1lZCB0byBwYl9uYW1lLgogICAqIE9wdGlvbmFsIGZpZWxkcyB0aGF0IGFyZSBub3Qgc2V0IHdpbGwgYmUgc2V0IHRvIHVuZGVmaW5lZC4KICAgKiBUbyBhY2Nlc3MgYSByZXNlcnZlZCBmaWVsZCB1c2UsIGZvby5wYl88bmFtZT4sIGVnLCBmb28ucGJfZGVmYXVsdC4KICAgKiBGb3IgdGhlIGxpc3Qgb2YgcmVzZXJ2ZWQgbmFtZXMgcGxlYXNlIHNlZToKICAgKiAgICAgbmV0L3Byb3RvMi9jb21waWxlci9qcy9pbnRlcm5hbC9nZW5lcmF0b3IuY2Mja0tleXdvcmQuCiAgICogQHBhcmFtIHtib29sZWFuPX0gb3B0X2luY2x1ZGVJbnN0YW5jZSBEZXByZWNhdGVkLiB3aGV0aGVyIHRvIGluY2x1ZGUgdGhlCiAgICogICAgIEpTUEIgaW5zdGFuY2UgZm9yIHRyYW5zaXRpb25hbCBzb3kgcHJvdG8gc3VwcG9ydDoKICAgKiAgICAgaHR0cDovL2dvdG8vc295LXBhcmFtLW1pZ3JhdGlvbgogICAqIEByZXR1cm4geyFPYmplY3R9CiAgICovCiAgcHJvdG8ucGIuY21zLkFuY2hvckxpc3RSZXF1ZXN0LnByb3RvdHlwZS50b09iamVjdCA9IGZ1bmN0aW9uIChvcHRfaW5jbHVkZUluc3RhbmNlKSB7CiAgICByZXR1cm4gcHJvdG8ucGIuY21zLkFuY2hvckxpc3RSZXF1ZXN0LnRvT2JqZWN0KG9wdF9pbmNsdWRlSW5zdGFuY2UsIHRoaXMpOwogIH07CiAgLyoqCiAgICogU3RhdGljIHZlcnNpb24gb2YgdGhlIHtAc2VlIHRvT2JqZWN0fSBtZXRob2QuCiAgICogQHBhcmFtIHtib29sZWFufHVuZGVmaW5lZH0gaW5jbHVkZUluc3RhbmNlIERlcHJlY2F0ZWQuIFdoZXRoZXIgdG8gaW5jbHVkZQogICAqICAgICB0aGUgSlNQQiBpbnN0YW5jZSBmb3IgdHJhbnNpdGlvbmFsIHNveSBwcm90byBzdXBwb3J0OgogICAqICAgICBodHRwOi8vZ290by9zb3ktcGFyYW0tbWlncmF0aW9uCiAgICogQHBhcmFtIHshcHJvdG8ucGIuY21zLkFuY2hvckxpc3RSZXF1ZXN0fSBtc2cgVGhlIG1zZyBpbnN0YW5jZSB0byB0cmFuc2Zvcm0uCiAgICogQHJldHVybiB7IU9iamVjdH0KICAgKiBAc3VwcHJlc3Mge3VudXNlZExvY2FsVmFyaWFibGVzfSBmIGlzIG9ubHkgdXNlZCBmb3IgbmVzdGVkIG1lc3NhZ2VzCiAgICovCgoKICBwcm90by5wYi5jbXMuQW5jaG9yTGlzdFJlcXVlc3QudG9PYmplY3QgPSBmdW5jdGlvbiAoaW5jbHVkZUluc3RhbmNlLCBtc2cpIHsKICAgIHZhciBmLAogICAgICAgIG9iaiA9IHsKICAgICAgcGFnZU5vOiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdChtc2csIDEsIDApLAogICAgICBwYWdlU2l6ZToganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQobXNnLCAyLCAwKSwKICAgICAgYW5jaG9ySWQ6IGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KG1zZywgMywgMCksCiAgICAgIGFyZWFJZDoganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQobXNnLCA0LCAwKSwKICAgICAgZ3VpbGRJZDoganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQobXNnLCA1LCAwKSwKICAgICAgYmxvY2tTdGF0dXM6IGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KG1zZywgNiwgMCksCiAgICAgIG9ubGluZVN0YXR1czoganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQobXNnLCA3LCAwKSwKICAgICAgcmV2aWV3U3RhdHVzOiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdChtc2csIDgsIDApLAogICAgICBjcmVhdGVkU3RhcnQ6IGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KG1zZywgOSwgMCksCiAgICAgIGNyZWF0ZWRFbmQ6IGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KG1zZywgMTAsIDApLAogICAgICBtaW5PZmZsaW5lOiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdChtc2csIDExLCAwKQogICAgfTsKCiAgICBpZiAoaW5jbHVkZUluc3RhbmNlKSB7CiAgICAgIG9iai4kanNwYk1lc3NhZ2VJbnN0YW5jZSA9IG1zZzsKICAgIH0KCiAgICByZXR1cm4gb2JqOwogIH07Cn0KLyoqCiAqIERlc2VyaWFsaXplcyBiaW5hcnkgZGF0YSAoaW4gcHJvdG9idWYgd2lyZSBmb3JtYXQpLgogKiBAcGFyYW0ge2pzcGIuQnl0ZVNvdXJjZX0gYnl0ZXMgVGhlIGJ5dGVzIHRvIGRlc2VyaWFsaXplLgogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLkFuY2hvckxpc3RSZXF1ZXN0fQogKi8KCgpwcm90by5wYi5jbXMuQW5jaG9yTGlzdFJlcXVlc3QuZGVzZXJpYWxpemVCaW5hcnkgPSBmdW5jdGlvbiAoYnl0ZXMpIHsKICB2YXIgcmVhZGVyID0gbmV3IGpzcGIuQmluYXJ5UmVhZGVyKGJ5dGVzKTsKICB2YXIgbXNnID0gbmV3IHByb3RvLnBiLmNtcy5BbmNob3JMaXN0UmVxdWVzdCgpOwogIHJldHVybiBwcm90by5wYi5jbXMuQW5jaG9yTGlzdFJlcXVlc3QuZGVzZXJpYWxpemVCaW5hcnlGcm9tUmVhZGVyKG1zZywgcmVhZGVyKTsKfTsKLyoqCiAqIERlc2VyaWFsaXplcyBiaW5hcnkgZGF0YSAoaW4gcHJvdG9idWYgd2lyZSBmb3JtYXQpIGZyb20gdGhlCiAqIGdpdmVuIHJlYWRlciBpbnRvIHRoZSBnaXZlbiBtZXNzYWdlIG9iamVjdC4KICogQHBhcmFtIHshcHJvdG8ucGIuY21zLkFuY2hvckxpc3RSZXF1ZXN0fSBtc2cgVGhlIG1lc3NhZ2Ugb2JqZWN0IHRvIGRlc2VyaWFsaXplIGludG8uCiAqIEBwYXJhbSB7IWpzcGIuQmluYXJ5UmVhZGVyfSByZWFkZXIgVGhlIEJpbmFyeVJlYWRlciB0byB1c2UuCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuQW5jaG9yTGlzdFJlcXVlc3R9CiAqLwoKCnByb3RvLnBiLmNtcy5BbmNob3JMaXN0UmVxdWVzdC5kZXNlcmlhbGl6ZUJpbmFyeUZyb21SZWFkZXIgPSBmdW5jdGlvbiAobXNnLCByZWFkZXIpIHsKICB3aGlsZSAocmVhZGVyLm5leHRGaWVsZCgpKSB7CiAgICBpZiAocmVhZGVyLmlzRW5kR3JvdXAoKSkgewogICAgICBicmVhazsKICAgIH0KCiAgICB2YXIgZmllbGQgPSByZWFkZXIuZ2V0RmllbGROdW1iZXIoKTsKCiAgICBzd2l0Y2ggKGZpZWxkKSB7CiAgICAgIGNhc2UgMToKICAgICAgICB2YXIgdmFsdWUgPSByZWFkZXIucmVhZFVpbnQzMigpOwogICAgICAgIG1zZy5zZXRQYWdlTm8odmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSAyOgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkVWludDMyKCk7CiAgICAgICAgbXNnLnNldFBhZ2VTaXplKHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgMzoKICAgICAgICB2YXIgdmFsdWUgPSByZWFkZXIucmVhZFVpbnQzMigpOwogICAgICAgIG1zZy5zZXRBbmNob3JJZCh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlIDQ6CiAgICAgICAgdmFyIHZhbHVlID0gcmVhZGVyLnJlYWRVaW50MzIoKTsKICAgICAgICBtc2cuc2V0QXJlYUlkKHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgNToKICAgICAgICB2YXIgdmFsdWUgPSByZWFkZXIucmVhZFVpbnQzMigpOwogICAgICAgIG1zZy5zZXRHdWlsZElkKHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgNjoKICAgICAgICB2YXIgdmFsdWUgPSByZWFkZXIucmVhZEVudW0oKTsKICAgICAgICBtc2cuc2V0QmxvY2tTdGF0dXModmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSA3OgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkRW51bSgpOwogICAgICAgIG1zZy5zZXRPbmxpbmVTdGF0dXModmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSA4OgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkRW51bSgpOwogICAgICAgIG1zZy5zZXRSZXZpZXdTdGF0dXModmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSA5OgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkVWludDMyKCk7CiAgICAgICAgbXNnLnNldENyZWF0ZWRTdGFydCh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlIDEwOgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkVWludDMyKCk7CiAgICAgICAgbXNnLnNldENyZWF0ZWRFbmQodmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSAxMToKICAgICAgICB2YXIgdmFsdWUgPSByZWFkZXIucmVhZFVpbnQzMigpOwogICAgICAgIG1zZy5zZXRNaW5PZmZsaW5lKHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGRlZmF1bHQ6CiAgICAgICAgcmVhZGVyLnNraXBGaWVsZCgpOwogICAgICAgIGJyZWFrOwogICAgfQogIH0KCiAgcmV0dXJuIG1zZzsKfTsKLyoqCiAqIFNlcmlhbGl6ZXMgdGhlIG1lc3NhZ2UgdG8gYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUgZm9ybWF0KS4KICogQHJldHVybiB7IVVpbnQ4QXJyYXl9CiAqLwoKCnByb3RvLnBiLmNtcy5BbmNob3JMaXN0UmVxdWVzdC5wcm90b3R5cGUuc2VyaWFsaXplQmluYXJ5ID0gZnVuY3Rpb24gKCkgewogIHZhciB3cml0ZXIgPSBuZXcganNwYi5CaW5hcnlXcml0ZXIoKTsKICBwcm90by5wYi5jbXMuQW5jaG9yTGlzdFJlcXVlc3Quc2VyaWFsaXplQmluYXJ5VG9Xcml0ZXIodGhpcywgd3JpdGVyKTsKICByZXR1cm4gd3JpdGVyLmdldFJlc3VsdEJ1ZmZlcigpOwp9OwovKioKICogU2VyaWFsaXplcyB0aGUgZ2l2ZW4gbWVzc2FnZSB0byBiaW5hcnkgZGF0YSAoaW4gcHJvdG9idWYgd2lyZQogKiBmb3JtYXQpLCB3cml0aW5nIHRvIHRoZSBnaXZlbiBCaW5hcnlXcml0ZXIuCiAqIEBwYXJhbSB7IXByb3RvLnBiLmNtcy5BbmNob3JMaXN0UmVxdWVzdH0gbWVzc2FnZQogKiBAcGFyYW0geyFqc3BiLkJpbmFyeVdyaXRlcn0gd3JpdGVyCiAqIEBzdXBwcmVzcyB7dW51c2VkTG9jYWxWYXJpYWJsZXN9IGYgaXMgb25seSB1c2VkIGZvciBuZXN0ZWQgbWVzc2FnZXMKICovCgoKcHJvdG8ucGIuY21zLkFuY2hvckxpc3RSZXF1ZXN0LnNlcmlhbGl6ZUJpbmFyeVRvV3JpdGVyID0gZnVuY3Rpb24gKG1lc3NhZ2UsIHdyaXRlcikgewogIHZhciBmID0gdW5kZWZpbmVkOwogIGYgPSBtZXNzYWdlLmdldFBhZ2VObygpOwoKICBpZiAoZiAhPT0gMCkgewogICAgd3JpdGVyLndyaXRlVWludDMyKDEsIGYpOwogIH0KCiAgZiA9IG1lc3NhZ2UuZ2V0UGFnZVNpemUoKTsKCiAgaWYgKGYgIT09IDApIHsKICAgIHdyaXRlci53cml0ZVVpbnQzMigyLCBmKTsKICB9CgogIGYgPSBtZXNzYWdlLmdldEFuY2hvcklkKCk7CgogIGlmIChmICE9PSAwKSB7CiAgICB3cml0ZXIud3JpdGVVaW50MzIoMywgZik7CiAgfQoKICBmID0gbWVzc2FnZS5nZXRBcmVhSWQoKTsKCiAgaWYgKGYgIT09IDApIHsKICAgIHdyaXRlci53cml0ZVVpbnQzMig0LCBmKTsKICB9CgogIGYgPSBtZXNzYWdlLmdldEd1aWxkSWQoKTsKCiAgaWYgKGYgIT09IDApIHsKICAgIHdyaXRlci53cml0ZVVpbnQzMig1LCBmKTsKICB9CgogIGYgPSBtZXNzYWdlLmdldEJsb2NrU3RhdHVzKCk7CgogIGlmIChmICE9PSAwLjApIHsKICAgIHdyaXRlci53cml0ZUVudW0oNiwgZik7CiAgfQoKICBmID0gbWVzc2FnZS5nZXRPbmxpbmVTdGF0dXMoKTsKCiAgaWYgKGYgIT09IDAuMCkgewogICAgd3JpdGVyLndyaXRlRW51bSg3LCBmKTsKICB9CgogIGYgPSBtZXNzYWdlLmdldFJldmlld1N0YXR1cygpOwoKICBpZiAoZiAhPT0gMC4wKSB7CiAgICB3cml0ZXIud3JpdGVFbnVtKDgsIGYpOwogIH0KCiAgZiA9IG1lc3NhZ2UuZ2V0Q3JlYXRlZFN0YXJ0KCk7CgogIGlmIChmICE9PSAwKSB7CiAgICB3cml0ZXIud3JpdGVVaW50MzIoOSwgZik7CiAgfQoKICBmID0gbWVzc2FnZS5nZXRDcmVhdGVkRW5kKCk7CgogIGlmIChmICE9PSAwKSB7CiAgICB3cml0ZXIud3JpdGVVaW50MzIoMTAsIGYpOwogIH0KCiAgZiA9IG1lc3NhZ2UuZ2V0TWluT2ZmbGluZSgpOwoKICBpZiAoZiAhPT0gMCkgewogICAgd3JpdGVyLndyaXRlVWludDMyKDExLCBmKTsKICB9Cn07Ci8qKgogKiBvcHRpb25hbCB1aW50MzIgcGFnZV9ubyA9IDE7CiAqIEByZXR1cm4ge251bWJlcn0KICovCgoKcHJvdG8ucGIuY21zLkFuY2hvckxpc3RSZXF1ZXN0LnByb3RvdHlwZS5nZXRQYWdlTm8gPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDEsIDApOwp9OwovKioKICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuQW5jaG9yTGlzdFJlcXVlc3R9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuQW5jaG9yTGlzdFJlcXVlc3QucHJvdG90eXBlLnNldFBhZ2VObyA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UHJvdG8zSW50RmllbGQodGhpcywgMSwgdmFsdWUpOwp9OwovKioKICogb3B0aW9uYWwgdWludDMyIHBhZ2Vfc2l6ZSA9IDI7CiAqIEByZXR1cm4ge251bWJlcn0KICovCgoKcHJvdG8ucGIuY21zLkFuY2hvckxpc3RSZXF1ZXN0LnByb3RvdHlwZS5nZXRQYWdlU2l6ZSA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQodGhpcywgMiwgMCk7Cn07Ci8qKgogKiBAcGFyYW0ge251bWJlcn0gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5BbmNob3JMaXN0UmVxdWVzdH0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5BbmNob3JMaXN0UmVxdWVzdC5wcm90b3R5cGUuc2V0UGFnZVNpemUgPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0ludEZpZWxkKHRoaXMsIDIsIHZhbHVlKTsKfTsKLyoqCiAqIG9wdGlvbmFsIHVpbnQzMiBhbmNob3JfaWQgPSAzOwogKiBAcmV0dXJuIHtudW1iZXJ9CiAqLwoKCnByb3RvLnBiLmNtcy5BbmNob3JMaXN0UmVxdWVzdC5wcm90b3R5cGUuZ2V0QW5jaG9ySWQgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDMsIDApOwp9OwovKioKICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuQW5jaG9yTGlzdFJlcXVlc3R9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuQW5jaG9yTGlzdFJlcXVlc3QucHJvdG90eXBlLnNldEFuY2hvcklkID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRQcm90bzNJbnRGaWVsZCh0aGlzLCAzLCB2YWx1ZSk7Cn07Ci8qKgogKiBvcHRpb25hbCB1aW50MzIgYXJlYV9pZCA9IDQ7CiAqIEByZXR1cm4ge251bWJlcn0KICovCgoKcHJvdG8ucGIuY21zLkFuY2hvckxpc3RSZXF1ZXN0LnByb3RvdHlwZS5nZXRBcmVhSWQgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDQsIDApOwp9OwovKioKICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuQW5jaG9yTGlzdFJlcXVlc3R9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuQW5jaG9yTGlzdFJlcXVlc3QucHJvdG90eXBlLnNldEFyZWFJZCA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UHJvdG8zSW50RmllbGQodGhpcywgNCwgdmFsdWUpOwp9OwovKioKICogb3B0aW9uYWwgdWludDMyIGd1aWxkX2lkID0gNTsKICogQHJldHVybiB7bnVtYmVyfQogKi8KCgpwcm90by5wYi5jbXMuQW5jaG9yTGlzdFJlcXVlc3QucHJvdG90eXBlLmdldEd1aWxkSWQgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDUsIDApOwp9OwovKioKICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuQW5jaG9yTGlzdFJlcXVlc3R9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuQW5jaG9yTGlzdFJlcXVlc3QucHJvdG90eXBlLnNldEd1aWxkSWQgPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0ludEZpZWxkKHRoaXMsIDUsIHZhbHVlKTsKfTsKLyoqCiAqIG9wdGlvbmFsIHBiLkJsb2NrU3RhdHVzIGJsb2NrX3N0YXR1cyA9IDY7CiAqIEByZXR1cm4geyFwcm90by5wYi5CbG9ja1N0YXR1c30KICovCgoKcHJvdG8ucGIuY21zLkFuY2hvckxpc3RSZXF1ZXN0LnByb3RvdHlwZS5nZXRCbG9ja1N0YXR1cyA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQodGhpcywgNiwgMCk7Cn07Ci8qKgogKiBAcGFyYW0geyFwcm90by5wYi5CbG9ja1N0YXR1c30gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5BbmNob3JMaXN0UmVxdWVzdH0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5BbmNob3JMaXN0UmVxdWVzdC5wcm90b3R5cGUuc2V0QmxvY2tTdGF0dXMgPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0VudW1GaWVsZCh0aGlzLCA2LCB2YWx1ZSk7Cn07Ci8qKgogKiBvcHRpb25hbCBwYi5PbmxpbmVTdGF0dXMgb25saW5lX3N0YXR1cyA9IDc7CiAqIEByZXR1cm4geyFwcm90by5wYi5PbmxpbmVTdGF0dXN9CiAqLwoKCnByb3RvLnBiLmNtcy5BbmNob3JMaXN0UmVxdWVzdC5wcm90b3R5cGUuZ2V0T25saW5lU3RhdHVzID0gZnVuY3Rpb24gKCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdCh0aGlzLCA3LCAwKTsKfTsKLyoqCiAqIEBwYXJhbSB7IXByb3RvLnBiLk9ubGluZVN0YXR1c30gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5BbmNob3JMaXN0UmVxdWVzdH0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5BbmNob3JMaXN0UmVxdWVzdC5wcm90b3R5cGUuc2V0T25saW5lU3RhdHVzID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRQcm90bzNFbnVtRmllbGQodGhpcywgNywgdmFsdWUpOwp9OwovKioKICogb3B0aW9uYWwgcGIuUmV2aWV3U3RhdHVzIHJldmlld19zdGF0dXMgPSA4OwogKiBAcmV0dXJuIHshcHJvdG8ucGIuUmV2aWV3U3RhdHVzfQogKi8KCgpwcm90by5wYi5jbXMuQW5jaG9yTGlzdFJlcXVlc3QucHJvdG90eXBlLmdldFJldmlld1N0YXR1cyA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQodGhpcywgOCwgMCk7Cn07Ci8qKgogKiBAcGFyYW0geyFwcm90by5wYi5SZXZpZXdTdGF0dXN9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuQW5jaG9yTGlzdFJlcXVlc3R9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuQW5jaG9yTGlzdFJlcXVlc3QucHJvdG90eXBlLnNldFJldmlld1N0YXR1cyA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UHJvdG8zRW51bUZpZWxkKHRoaXMsIDgsIHZhbHVlKTsKfTsKLyoqCiAqIG9wdGlvbmFsIHVpbnQzMiBjcmVhdGVkX3N0YXJ0ID0gOTsKICogQHJldHVybiB7bnVtYmVyfQogKi8KCgpwcm90by5wYi5jbXMuQW5jaG9yTGlzdFJlcXVlc3QucHJvdG90eXBlLmdldENyZWF0ZWRTdGFydCA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQodGhpcywgOSwgMCk7Cn07Ci8qKgogKiBAcGFyYW0ge251bWJlcn0gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5BbmNob3JMaXN0UmVxdWVzdH0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5BbmNob3JMaXN0UmVxdWVzdC5wcm90b3R5cGUuc2V0Q3JlYXRlZFN0YXJ0ID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRQcm90bzNJbnRGaWVsZCh0aGlzLCA5LCB2YWx1ZSk7Cn07Ci8qKgogKiBvcHRpb25hbCB1aW50MzIgY3JlYXRlZF9lbmQgPSAxMDsKICogQHJldHVybiB7bnVtYmVyfQogKi8KCgpwcm90by5wYi5jbXMuQW5jaG9yTGlzdFJlcXVlc3QucHJvdG90eXBlLmdldENyZWF0ZWRFbmQgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDEwLCAwKTsKfTsKLyoqCiAqIEBwYXJhbSB7bnVtYmVyfSB2YWx1ZQogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLkFuY2hvckxpc3RSZXF1ZXN0fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLkFuY2hvckxpc3RSZXF1ZXN0LnByb3RvdHlwZS5zZXRDcmVhdGVkRW5kID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRQcm90bzNJbnRGaWVsZCh0aGlzLCAxMCwgdmFsdWUpOwp9OwovKioKICogb3B0aW9uYWwgdWludDMyIG1pbl9vZmZsaW5lID0gMTE7CiAqIEByZXR1cm4ge251bWJlcn0KICovCgoKcHJvdG8ucGIuY21zLkFuY2hvckxpc3RSZXF1ZXN0LnByb3RvdHlwZS5nZXRNaW5PZmZsaW5lID0gZnVuY3Rpb24gKCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdCh0aGlzLCAxMSwgMCk7Cn07Ci8qKgogKiBAcGFyYW0ge251bWJlcn0gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5BbmNob3JMaXN0UmVxdWVzdH0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5BbmNob3JMaXN0UmVxdWVzdC5wcm90b3R5cGUuc2V0TWluT2ZmbGluZSA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UHJvdG8zSW50RmllbGQodGhpcywgMTEsIHZhbHVlKTsKfTsKLyoqCiAqIExpc3Qgb2YgcmVwZWF0ZWQgZmllbGRzIHdpdGhpbiB0aGlzIG1lc3NhZ2UgdHlwZS4KICogQHByaXZhdGUgeyFBcnJheTxudW1iZXI+fQogKiBAY29uc3QKICovCgoKcHJvdG8ucGIuY21zLkFuY2hvckxpc3RSZXBseS5yZXBlYXRlZEZpZWxkc18gPSBbMV07CgppZiAoanNwYi5NZXNzYWdlLkdFTkVSQVRFX1RPX09CSkVDVCkgewogIC8qKgogICAqIENyZWF0ZXMgYW4gb2JqZWN0IHJlcHJlc2VudGF0aW9uIG9mIHRoaXMgcHJvdG8uCiAgICogRmllbGQgbmFtZXMgdGhhdCBhcmUgcmVzZXJ2ZWQgaW4gSmF2YVNjcmlwdCBhbmQgd2lsbCBiZSByZW5hbWVkIHRvIHBiX25hbWUuCiAgICogT3B0aW9uYWwgZmllbGRzIHRoYXQgYXJlIG5vdCBzZXQgd2lsbCBiZSBzZXQgdG8gdW5kZWZpbmVkLgogICAqIFRvIGFjY2VzcyBhIHJlc2VydmVkIGZpZWxkIHVzZSwgZm9vLnBiXzxuYW1lPiwgZWcsIGZvby5wYl9kZWZhdWx0LgogICAqIEZvciB0aGUgbGlzdCBvZiByZXNlcnZlZCBuYW1lcyBwbGVhc2Ugc2VlOgogICAqICAgICBuZXQvcHJvdG8yL2NvbXBpbGVyL2pzL2ludGVybmFsL2dlbmVyYXRvci5jYyNrS2V5d29yZC4KICAgKiBAcGFyYW0ge2Jvb2xlYW49fSBvcHRfaW5jbHVkZUluc3RhbmNlIERlcHJlY2F0ZWQuIHdoZXRoZXIgdG8gaW5jbHVkZSB0aGUKICAgKiAgICAgSlNQQiBpbnN0YW5jZSBmb3IgdHJhbnNpdGlvbmFsIHNveSBwcm90byBzdXBwb3J0OgogICAqICAgICBodHRwOi8vZ290by9zb3ktcGFyYW0tbWlncmF0aW9uCiAgICogQHJldHVybiB7IU9iamVjdH0KICAgKi8KICBwcm90by5wYi5jbXMuQW5jaG9yTGlzdFJlcGx5LnByb3RvdHlwZS50b09iamVjdCA9IGZ1bmN0aW9uIChvcHRfaW5jbHVkZUluc3RhbmNlKSB7CiAgICByZXR1cm4gcHJvdG8ucGIuY21zLkFuY2hvckxpc3RSZXBseS50b09iamVjdChvcHRfaW5jbHVkZUluc3RhbmNlLCB0aGlzKTsKICB9OwogIC8qKgogICAqIFN0YXRpYyB2ZXJzaW9uIG9mIHRoZSB7QHNlZSB0b09iamVjdH0gbWV0aG9kLgogICAqIEBwYXJhbSB7Ym9vbGVhbnx1bmRlZmluZWR9IGluY2x1ZGVJbnN0YW5jZSBEZXByZWNhdGVkLiBXaGV0aGVyIHRvIGluY2x1ZGUKICAgKiAgICAgdGhlIEpTUEIgaW5zdGFuY2UgZm9yIHRyYW5zaXRpb25hbCBzb3kgcHJvdG8gc3VwcG9ydDoKICAgKiAgICAgaHR0cDovL2dvdG8vc295LXBhcmFtLW1pZ3JhdGlvbgogICAqIEBwYXJhbSB7IXByb3RvLnBiLmNtcy5BbmNob3JMaXN0UmVwbHl9IG1zZyBUaGUgbXNnIGluc3RhbmNlIHRvIHRyYW5zZm9ybS4KICAgKiBAcmV0dXJuIHshT2JqZWN0fQogICAqIEBzdXBwcmVzcyB7dW51c2VkTG9jYWxWYXJpYWJsZXN9IGYgaXMgb25seSB1c2VkIGZvciBuZXN0ZWQgbWVzc2FnZXMKICAgKi8KCgogIHByb3RvLnBiLmNtcy5BbmNob3JMaXN0UmVwbHkudG9PYmplY3QgPSBmdW5jdGlvbiAoaW5jbHVkZUluc3RhbmNlLCBtc2cpIHsKICAgIHZhciBmLAogICAgICAgIG9iaiA9IHsKICAgICAgYW5jaG9yc0xpc3Q6IGpzcGIuTWVzc2FnZS50b09iamVjdExpc3QobXNnLmdldEFuY2hvcnNMaXN0KCksIGFuY2hvcnR5cGVfcGIuQW5jaG9yQmFzaWMudG9PYmplY3QsIGluY2x1ZGVJbnN0YW5jZSksCiAgICAgIHBhZ2VObzoganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQobXNnLCAyLCAwKSwKICAgICAgcGFnZVNpemU6IGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KG1zZywgMywgMCksCiAgICAgIHRvdGFsUGFnZToganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQobXNnLCA0LCAwKSwKICAgICAgdG90YWxDb3VudDoganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQobXNnLCA1LCAwKQogICAgfTsKCiAgICBpZiAoaW5jbHVkZUluc3RhbmNlKSB7CiAgICAgIG9iai4kanNwYk1lc3NhZ2VJbnN0YW5jZSA9IG1zZzsKICAgIH0KCiAgICByZXR1cm4gb2JqOwogIH07Cn0KLyoqCiAqIERlc2VyaWFsaXplcyBiaW5hcnkgZGF0YSAoaW4gcHJvdG9idWYgd2lyZSBmb3JtYXQpLgogKiBAcGFyYW0ge2pzcGIuQnl0ZVNvdXJjZX0gYnl0ZXMgVGhlIGJ5dGVzIHRvIGRlc2VyaWFsaXplLgogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLkFuY2hvckxpc3RSZXBseX0KICovCgoKcHJvdG8ucGIuY21zLkFuY2hvckxpc3RSZXBseS5kZXNlcmlhbGl6ZUJpbmFyeSA9IGZ1bmN0aW9uIChieXRlcykgewogIHZhciByZWFkZXIgPSBuZXcganNwYi5CaW5hcnlSZWFkZXIoYnl0ZXMpOwogIHZhciBtc2cgPSBuZXcgcHJvdG8ucGIuY21zLkFuY2hvckxpc3RSZXBseSgpOwogIHJldHVybiBwcm90by5wYi5jbXMuQW5jaG9yTGlzdFJlcGx5LmRlc2VyaWFsaXplQmluYXJ5RnJvbVJlYWRlcihtc2csIHJlYWRlcik7Cn07Ci8qKgogKiBEZXNlcmlhbGl6ZXMgYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUgZm9ybWF0KSBmcm9tIHRoZQogKiBnaXZlbiByZWFkZXIgaW50byB0aGUgZ2l2ZW4gbWVzc2FnZSBvYmplY3QuCiAqIEBwYXJhbSB7IXByb3RvLnBiLmNtcy5BbmNob3JMaXN0UmVwbHl9IG1zZyBUaGUgbWVzc2FnZSBvYmplY3QgdG8gZGVzZXJpYWxpemUgaW50by4KICogQHBhcmFtIHshanNwYi5CaW5hcnlSZWFkZXJ9IHJlYWRlciBUaGUgQmluYXJ5UmVhZGVyIHRvIHVzZS4KICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5BbmNob3JMaXN0UmVwbHl9CiAqLwoKCnByb3RvLnBiLmNtcy5BbmNob3JMaXN0UmVwbHkuZGVzZXJpYWxpemVCaW5hcnlGcm9tUmVhZGVyID0gZnVuY3Rpb24gKG1zZywgcmVhZGVyKSB7CiAgd2hpbGUgKHJlYWRlci5uZXh0RmllbGQoKSkgewogICAgaWYgKHJlYWRlci5pc0VuZEdyb3VwKCkpIHsKICAgICAgYnJlYWs7CiAgICB9CgogICAgdmFyIGZpZWxkID0gcmVhZGVyLmdldEZpZWxkTnVtYmVyKCk7CgogICAgc3dpdGNoIChmaWVsZCkgewogICAgICBjYXNlIDE6CiAgICAgICAgdmFyIHZhbHVlID0gbmV3IGFuY2hvcnR5cGVfcGIuQW5jaG9yQmFzaWMoKTsKICAgICAgICByZWFkZXIucmVhZE1lc3NhZ2UodmFsdWUsIGFuY2hvcnR5cGVfcGIuQW5jaG9yQmFzaWMuZGVzZXJpYWxpemVCaW5hcnlGcm9tUmVhZGVyKTsKICAgICAgICBtc2cuYWRkQW5jaG9ycyh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlIDI6CiAgICAgICAgdmFyIHZhbHVlID0gcmVhZGVyLnJlYWRVaW50MzIoKTsKICAgICAgICBtc2cuc2V0UGFnZU5vKHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgMzoKICAgICAgICB2YXIgdmFsdWUgPSByZWFkZXIucmVhZFVpbnQzMigpOwogICAgICAgIG1zZy5zZXRQYWdlU2l6ZSh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlIDQ6CiAgICAgICAgdmFyIHZhbHVlID0gcmVhZGVyLnJlYWRVaW50MzIoKTsKICAgICAgICBtc2cuc2V0VG90YWxQYWdlKHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgNToKICAgICAgICB2YXIgdmFsdWUgPSByZWFkZXIucmVhZFVpbnQzMigpOwogICAgICAgIG1zZy5zZXRUb3RhbENvdW50KHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGRlZmF1bHQ6CiAgICAgICAgcmVhZGVyLnNraXBGaWVsZCgpOwogICAgICAgIGJyZWFrOwogICAgfQogIH0KCiAgcmV0dXJuIG1zZzsKfTsKLyoqCiAqIFNlcmlhbGl6ZXMgdGhlIG1lc3NhZ2UgdG8gYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUgZm9ybWF0KS4KICogQHJldHVybiB7IVVpbnQ4QXJyYXl9CiAqLwoKCnByb3RvLnBiLmNtcy5BbmNob3JMaXN0UmVwbHkucHJvdG90eXBlLnNlcmlhbGl6ZUJpbmFyeSA9IGZ1bmN0aW9uICgpIHsKICB2YXIgd3JpdGVyID0gbmV3IGpzcGIuQmluYXJ5V3JpdGVyKCk7CiAgcHJvdG8ucGIuY21zLkFuY2hvckxpc3RSZXBseS5zZXJpYWxpemVCaW5hcnlUb1dyaXRlcih0aGlzLCB3cml0ZXIpOwogIHJldHVybiB3cml0ZXIuZ2V0UmVzdWx0QnVmZmVyKCk7Cn07Ci8qKgogKiBTZXJpYWxpemVzIHRoZSBnaXZlbiBtZXNzYWdlIHRvIGJpbmFyeSBkYXRhIChpbiBwcm90b2J1ZiB3aXJlCiAqIGZvcm1hdCksIHdyaXRpbmcgdG8gdGhlIGdpdmVuIEJpbmFyeVdyaXRlci4KICogQHBhcmFtIHshcHJvdG8ucGIuY21zLkFuY2hvckxpc3RSZXBseX0gbWVzc2FnZQogKiBAcGFyYW0geyFqc3BiLkJpbmFyeVdyaXRlcn0gd3JpdGVyCiAqIEBzdXBwcmVzcyB7dW51c2VkTG9jYWxWYXJpYWJsZXN9IGYgaXMgb25seSB1c2VkIGZvciBuZXN0ZWQgbWVzc2FnZXMKICovCgoKcHJvdG8ucGIuY21zLkFuY2hvckxpc3RSZXBseS5zZXJpYWxpemVCaW5hcnlUb1dyaXRlciA9IGZ1bmN0aW9uIChtZXNzYWdlLCB3cml0ZXIpIHsKICB2YXIgZiA9IHVuZGVmaW5lZDsKICBmID0gbWVzc2FnZS5nZXRBbmNob3JzTGlzdCgpOwoKICBpZiAoZi5sZW5ndGggPiAwKSB7CiAgICB3cml0ZXIud3JpdGVSZXBlYXRlZE1lc3NhZ2UoMSwgZiwgYW5jaG9ydHlwZV9wYi5BbmNob3JCYXNpYy5zZXJpYWxpemVCaW5hcnlUb1dyaXRlcik7CiAgfQoKICBmID0gbWVzc2FnZS5nZXRQYWdlTm8oKTsKCiAgaWYgKGYgIT09IDApIHsKICAgIHdyaXRlci53cml0ZVVpbnQzMigyLCBmKTsKICB9CgogIGYgPSBtZXNzYWdlLmdldFBhZ2VTaXplKCk7CgogIGlmIChmICE9PSAwKSB7CiAgICB3cml0ZXIud3JpdGVVaW50MzIoMywgZik7CiAgfQoKICBmID0gbWVzc2FnZS5nZXRUb3RhbFBhZ2UoKTsKCiAgaWYgKGYgIT09IDApIHsKICAgIHdyaXRlci53cml0ZVVpbnQzMig0LCBmKTsKICB9CgogIGYgPSBtZXNzYWdlLmdldFRvdGFsQ291bnQoKTsKCiAgaWYgKGYgIT09IDApIHsKICAgIHdyaXRlci53cml0ZVVpbnQzMig1LCBmKTsKICB9Cn07Ci8qKgogKiByZXBlYXRlZCBwYi5BbmNob3JCYXNpYyBhbmNob3JzID0gMTsKICogQHJldHVybiB7IUFycmF5PCFwcm90by5wYi5BbmNob3JCYXNpYz59CiAqLwoKCnByb3RvLnBiLmNtcy5BbmNob3JMaXN0UmVwbHkucHJvdG90eXBlLmdldEFuY2hvcnNMaXN0ID0gZnVuY3Rpb24gKCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuZ2V0UmVwZWF0ZWRXcmFwcGVyRmllbGQodGhpcywgYW5jaG9ydHlwZV9wYi5BbmNob3JCYXNpYywgMSk7Cn07Ci8qKgogKiBAcGFyYW0geyFBcnJheTwhcHJvdG8ucGIuQW5jaG9yQmFzaWM+fSB2YWx1ZQogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLkFuY2hvckxpc3RSZXBseX0gcmV0dXJucyB0aGlzCiovCgoKcHJvdG8ucGIuY21zLkFuY2hvckxpc3RSZXBseS5wcm90b3R5cGUuc2V0QW5jaG9yc0xpc3QgPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFJlcGVhdGVkV3JhcHBlckZpZWxkKHRoaXMsIDEsIHZhbHVlKTsKfTsKLyoqCiAqIEBwYXJhbSB7IXByb3RvLnBiLkFuY2hvckJhc2ljPX0gb3B0X3ZhbHVlCiAqIEBwYXJhbSB7bnVtYmVyPX0gb3B0X2luZGV4CiAqIEByZXR1cm4geyFwcm90by5wYi5BbmNob3JCYXNpY30KICovCgoKcHJvdG8ucGIuY21zLkFuY2hvckxpc3RSZXBseS5wcm90b3R5cGUuYWRkQW5jaG9ycyA9IGZ1bmN0aW9uIChvcHRfdmFsdWUsIG9wdF9pbmRleCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuYWRkVG9SZXBlYXRlZFdyYXBwZXJGaWVsZCh0aGlzLCAxLCBvcHRfdmFsdWUsIHByb3RvLnBiLkFuY2hvckJhc2ljLCBvcHRfaW5kZXgpOwp9OwovKioKICogQ2xlYXJzIHRoZSBsaXN0IG1ha2luZyBpdCBlbXB0eSBidXQgbm9uLW51bGwuCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuQW5jaG9yTGlzdFJlcGx5fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLkFuY2hvckxpc3RSZXBseS5wcm90b3R5cGUuY2xlYXJBbmNob3JzTGlzdCA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4gdGhpcy5zZXRBbmNob3JzTGlzdChbXSk7Cn07Ci8qKgogKiBvcHRpb25hbCB1aW50MzIgcGFnZV9ubyA9IDI7CiAqIEByZXR1cm4ge251bWJlcn0KICovCgoKcHJvdG8ucGIuY21zLkFuY2hvckxpc3RSZXBseS5wcm90b3R5cGUuZ2V0UGFnZU5vID0gZnVuY3Rpb24gKCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdCh0aGlzLCAyLCAwKTsKfTsKLyoqCiAqIEBwYXJhbSB7bnVtYmVyfSB2YWx1ZQogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLkFuY2hvckxpc3RSZXBseX0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5BbmNob3JMaXN0UmVwbHkucHJvdG90eXBlLnNldFBhZ2VObyA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UHJvdG8zSW50RmllbGQodGhpcywgMiwgdmFsdWUpOwp9OwovKioKICogb3B0aW9uYWwgdWludDMyIHBhZ2Vfc2l6ZSA9IDM7CiAqIEByZXR1cm4ge251bWJlcn0KICovCgoKcHJvdG8ucGIuY21zLkFuY2hvckxpc3RSZXBseS5wcm90b3R5cGUuZ2V0UGFnZVNpemUgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDMsIDApOwp9OwovKioKICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuQW5jaG9yTGlzdFJlcGx5fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLkFuY2hvckxpc3RSZXBseS5wcm90b3R5cGUuc2V0UGFnZVNpemUgPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0ludEZpZWxkKHRoaXMsIDMsIHZhbHVlKTsKfTsKLyoqCiAqIG9wdGlvbmFsIHVpbnQzMiB0b3RhbF9wYWdlID0gNDsKICogQHJldHVybiB7bnVtYmVyfQogKi8KCgpwcm90by5wYi5jbXMuQW5jaG9yTGlzdFJlcGx5LnByb3RvdHlwZS5nZXRUb3RhbFBhZ2UgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDQsIDApOwp9OwovKioKICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuQW5jaG9yTGlzdFJlcGx5fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLkFuY2hvckxpc3RSZXBseS5wcm90b3R5cGUuc2V0VG90YWxQYWdlID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRQcm90bzNJbnRGaWVsZCh0aGlzLCA0LCB2YWx1ZSk7Cn07Ci8qKgogKiBvcHRpb25hbCB1aW50MzIgdG90YWxfY291bnQgPSA1OwogKiBAcmV0dXJuIHtudW1iZXJ9CiAqLwoKCnByb3RvLnBiLmNtcy5BbmNob3JMaXN0UmVwbHkucHJvdG90eXBlLmdldFRvdGFsQ291bnQgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDUsIDApOwp9OwovKioKICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuQW5jaG9yTGlzdFJlcGx5fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLkFuY2hvckxpc3RSZXBseS5wcm90b3R5cGUuc2V0VG90YWxDb3VudCA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UHJvdG8zSW50RmllbGQodGhpcywgNSwgdmFsdWUpOwp9OwoKaWYgKGpzcGIuTWVzc2FnZS5HRU5FUkFURV9UT19PQkpFQ1QpIHsKICAvKioKICAgKiBDcmVhdGVzIGFuIG9iamVjdCByZXByZXNlbnRhdGlvbiBvZiB0aGlzIHByb3RvLgogICAqIEZpZWxkIG5hbWVzIHRoYXQgYXJlIHJlc2VydmVkIGluIEphdmFTY3JpcHQgYW5kIHdpbGwgYmUgcmVuYW1lZCB0byBwYl9uYW1lLgogICAqIE9wdGlvbmFsIGZpZWxkcyB0aGF0IGFyZSBub3Qgc2V0IHdpbGwgYmUgc2V0IHRvIHVuZGVmaW5lZC4KICAgKiBUbyBhY2Nlc3MgYSByZXNlcnZlZCBmaWVsZCB1c2UsIGZvby5wYl88bmFtZT4sIGVnLCBmb28ucGJfZGVmYXVsdC4KICAgKiBGb3IgdGhlIGxpc3Qgb2YgcmVzZXJ2ZWQgbmFtZXMgcGxlYXNlIHNlZToKICAgKiAgICAgbmV0L3Byb3RvMi9jb21waWxlci9qcy9pbnRlcm5hbC9nZW5lcmF0b3IuY2Mja0tleXdvcmQuCiAgICogQHBhcmFtIHtib29sZWFuPX0gb3B0X2luY2x1ZGVJbnN0YW5jZSBEZXByZWNhdGVkLiB3aGV0aGVyIHRvIGluY2x1ZGUgdGhlCiAgICogICAgIEpTUEIgaW5zdGFuY2UgZm9yIHRyYW5zaXRpb25hbCBzb3kgcHJvdG8gc3VwcG9ydDoKICAgKiAgICAgaHR0cDovL2dvdG8vc295LXBhcmFtLW1pZ3JhdGlvbgogICAqIEByZXR1cm4geyFPYmplY3R9CiAgICovCiAgcHJvdG8ucGIuY21zLlVzZXJMaXN0UmVxdWVzdC5wcm90b3R5cGUudG9PYmplY3QgPSBmdW5jdGlvbiAob3B0X2luY2x1ZGVJbnN0YW5jZSkgewogICAgcmV0dXJuIHByb3RvLnBiLmNtcy5Vc2VyTGlzdFJlcXVlc3QudG9PYmplY3Qob3B0X2luY2x1ZGVJbnN0YW5jZSwgdGhpcyk7CiAgfTsKICAvKioKICAgKiBTdGF0aWMgdmVyc2lvbiBvZiB0aGUge0BzZWUgdG9PYmplY3R9IG1ldGhvZC4KICAgKiBAcGFyYW0ge2Jvb2xlYW58dW5kZWZpbmVkfSBpbmNsdWRlSW5zdGFuY2UgRGVwcmVjYXRlZC4gV2hldGhlciB0byBpbmNsdWRlCiAgICogICAgIHRoZSBKU1BCIGluc3RhbmNlIGZvciB0cmFuc2l0aW9uYWwgc295IHByb3RvIHN1cHBvcnQ6CiAgICogICAgIGh0dHA6Ly9nb3RvL3NveS1wYXJhbS1taWdyYXRpb24KICAgKiBAcGFyYW0geyFwcm90by5wYi5jbXMuVXNlckxpc3RSZXF1ZXN0fSBtc2cgVGhlIG1zZyBpbnN0YW5jZSB0byB0cmFuc2Zvcm0uCiAgICogQHJldHVybiB7IU9iamVjdH0KICAgKiBAc3VwcHJlc3Mge3VudXNlZExvY2FsVmFyaWFibGVzfSBmIGlzIG9ubHkgdXNlZCBmb3IgbmVzdGVkIG1lc3NhZ2VzCiAgICovCgoKICBwcm90by5wYi5jbXMuVXNlckxpc3RSZXF1ZXN0LnRvT2JqZWN0ID0gZnVuY3Rpb24gKGluY2x1ZGVJbnN0YW5jZSwgbXNnKSB7CiAgICB2YXIgZiwKICAgICAgICBvYmogPSB7CiAgICAgIHBhZ2VObzoganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQobXNnLCAxLCAwKSwKICAgICAgcGFnZVNpemU6IGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KG1zZywgMiwgMCksCiAgICAgIHVzZXJJZDoganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQobXNnLCAzLCAwKSwKICAgICAgYXJlYUlkOiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdChtc2csIDQsIDApLAogICAgICBuaWNrbmFtZToganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQobXNnLCA1LCAiIiksCiAgICAgIHZpcE9ubHk6IGpzcGIuTWVzc2FnZS5nZXRCb29sZWFuRmllbGRXaXRoRGVmYXVsdChtc2csIDYsIGZhbHNlKSwKICAgICAgZGVwb3NpdE9ubHk6IGpzcGIuTWVzc2FnZS5nZXRCb29sZWFuRmllbGRXaXRoRGVmYXVsdChtc2csIDcsIGZhbHNlKSwKICAgICAgbWluQmFsYW5jZToganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQobXNnLCA4LCAwKSwKICAgICAgY3JlYXRlZFN0YXJ0OiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdChtc2csIDksIDApLAogICAgICBjcmVhdGVkRW5kOiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdChtc2csIDEwLCAwKQogICAgfTsKCiAgICBpZiAoaW5jbHVkZUluc3RhbmNlKSB7CiAgICAgIG9iai4kanNwYk1lc3NhZ2VJbnN0YW5jZSA9IG1zZzsKICAgIH0KCiAgICByZXR1cm4gb2JqOwogIH07Cn0KLyoqCiAqIERlc2VyaWFsaXplcyBiaW5hcnkgZGF0YSAoaW4gcHJvdG9idWYgd2lyZSBmb3JtYXQpLgogKiBAcGFyYW0ge2pzcGIuQnl0ZVNvdXJjZX0gYnl0ZXMgVGhlIGJ5dGVzIHRvIGRlc2VyaWFsaXplLgogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLlVzZXJMaXN0UmVxdWVzdH0KICovCgoKcHJvdG8ucGIuY21zLlVzZXJMaXN0UmVxdWVzdC5kZXNlcmlhbGl6ZUJpbmFyeSA9IGZ1bmN0aW9uIChieXRlcykgewogIHZhciByZWFkZXIgPSBuZXcganNwYi5CaW5hcnlSZWFkZXIoYnl0ZXMpOwogIHZhciBtc2cgPSBuZXcgcHJvdG8ucGIuY21zLlVzZXJMaXN0UmVxdWVzdCgpOwogIHJldHVybiBwcm90by5wYi5jbXMuVXNlckxpc3RSZXF1ZXN0LmRlc2VyaWFsaXplQmluYXJ5RnJvbVJlYWRlcihtc2csIHJlYWRlcik7Cn07Ci8qKgogKiBEZXNlcmlhbGl6ZXMgYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUgZm9ybWF0KSBmcm9tIHRoZQogKiBnaXZlbiByZWFkZXIgaW50byB0aGUgZ2l2ZW4gbWVzc2FnZSBvYmplY3QuCiAqIEBwYXJhbSB7IXByb3RvLnBiLmNtcy5Vc2VyTGlzdFJlcXVlc3R9IG1zZyBUaGUgbWVzc2FnZSBvYmplY3QgdG8gZGVzZXJpYWxpemUgaW50by4KICogQHBhcmFtIHshanNwYi5CaW5hcnlSZWFkZXJ9IHJlYWRlciBUaGUgQmluYXJ5UmVhZGVyIHRvIHVzZS4KICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5Vc2VyTGlzdFJlcXVlc3R9CiAqLwoKCnByb3RvLnBiLmNtcy5Vc2VyTGlzdFJlcXVlc3QuZGVzZXJpYWxpemVCaW5hcnlGcm9tUmVhZGVyID0gZnVuY3Rpb24gKG1zZywgcmVhZGVyKSB7CiAgd2hpbGUgKHJlYWRlci5uZXh0RmllbGQoKSkgewogICAgaWYgKHJlYWRlci5pc0VuZEdyb3VwKCkpIHsKICAgICAgYnJlYWs7CiAgICB9CgogICAgdmFyIGZpZWxkID0gcmVhZGVyLmdldEZpZWxkTnVtYmVyKCk7CgogICAgc3dpdGNoIChmaWVsZCkgewogICAgICBjYXNlIDE6CiAgICAgICAgdmFyIHZhbHVlID0gcmVhZGVyLnJlYWRVaW50MzIoKTsKICAgICAgICBtc2cuc2V0UGFnZU5vKHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgMjoKICAgICAgICB2YXIgdmFsdWUgPSByZWFkZXIucmVhZFVpbnQzMigpOwogICAgICAgIG1zZy5zZXRQYWdlU2l6ZSh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlIDM6CiAgICAgICAgdmFyIHZhbHVlID0gcmVhZGVyLnJlYWRVaW50MzIoKTsKICAgICAgICBtc2cuc2V0VXNlcklkKHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgNDoKICAgICAgICB2YXIgdmFsdWUgPSByZWFkZXIucmVhZFVpbnQzMigpOwogICAgICAgIG1zZy5zZXRBcmVhSWQodmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSA1OgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkU3RyaW5nKCk7CiAgICAgICAgbXNnLnNldE5pY2tuYW1lKHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgNjoKICAgICAgICB2YXIgdmFsdWUgPSByZWFkZXIucmVhZEJvb2woKTsKICAgICAgICBtc2cuc2V0VmlwT25seSh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlIDc6CiAgICAgICAgdmFyIHZhbHVlID0gcmVhZGVyLnJlYWRCb29sKCk7CiAgICAgICAgbXNnLnNldERlcG9zaXRPbmx5KHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgODoKICAgICAgICB2YXIgdmFsdWUgPSByZWFkZXIucmVhZFVpbnQzMigpOwogICAgICAgIG1zZy5zZXRNaW5CYWxhbmNlKHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgOToKICAgICAgICB2YXIgdmFsdWUgPSByZWFkZXIucmVhZFVpbnQzMigpOwogICAgICAgIG1zZy5zZXRDcmVhdGVkU3RhcnQodmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSAxMDoKICAgICAgICB2YXIgdmFsdWUgPSByZWFkZXIucmVhZFVpbnQzMigpOwogICAgICAgIG1zZy5zZXRDcmVhdGVkRW5kKHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGRlZmF1bHQ6CiAgICAgICAgcmVhZGVyLnNraXBGaWVsZCgpOwogICAgICAgIGJyZWFrOwogICAgfQogIH0KCiAgcmV0dXJuIG1zZzsKfTsKLyoqCiAqIFNlcmlhbGl6ZXMgdGhlIG1lc3NhZ2UgdG8gYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUgZm9ybWF0KS4KICogQHJldHVybiB7IVVpbnQ4QXJyYXl9CiAqLwoKCnByb3RvLnBiLmNtcy5Vc2VyTGlzdFJlcXVlc3QucHJvdG90eXBlLnNlcmlhbGl6ZUJpbmFyeSA9IGZ1bmN0aW9uICgpIHsKICB2YXIgd3JpdGVyID0gbmV3IGpzcGIuQmluYXJ5V3JpdGVyKCk7CiAgcHJvdG8ucGIuY21zLlVzZXJMaXN0UmVxdWVzdC5zZXJpYWxpemVCaW5hcnlUb1dyaXRlcih0aGlzLCB3cml0ZXIpOwogIHJldHVybiB3cml0ZXIuZ2V0UmVzdWx0QnVmZmVyKCk7Cn07Ci8qKgogKiBTZXJpYWxpemVzIHRoZSBnaXZlbiBtZXNzYWdlIHRvIGJpbmFyeSBkYXRhIChpbiBwcm90b2J1ZiB3aXJlCiAqIGZvcm1hdCksIHdyaXRpbmcgdG8gdGhlIGdpdmVuIEJpbmFyeVdyaXRlci4KICogQHBhcmFtIHshcHJvdG8ucGIuY21zLlVzZXJMaXN0UmVxdWVzdH0gbWVzc2FnZQogKiBAcGFyYW0geyFqc3BiLkJpbmFyeVdyaXRlcn0gd3JpdGVyCiAqIEBzdXBwcmVzcyB7dW51c2VkTG9jYWxWYXJpYWJsZXN9IGYgaXMgb25seSB1c2VkIGZvciBuZXN0ZWQgbWVzc2FnZXMKICovCgoKcHJvdG8ucGIuY21zLlVzZXJMaXN0UmVxdWVzdC5zZXJpYWxpemVCaW5hcnlUb1dyaXRlciA9IGZ1bmN0aW9uIChtZXNzYWdlLCB3cml0ZXIpIHsKICB2YXIgZiA9IHVuZGVmaW5lZDsKICBmID0gbWVzc2FnZS5nZXRQYWdlTm8oKTsKCiAgaWYgKGYgIT09IDApIHsKICAgIHdyaXRlci53cml0ZVVpbnQzMigxLCBmKTsKICB9CgogIGYgPSBtZXNzYWdlLmdldFBhZ2VTaXplKCk7CgogIGlmIChmICE9PSAwKSB7CiAgICB3cml0ZXIud3JpdGVVaW50MzIoMiwgZik7CiAgfQoKICBmID0gbWVzc2FnZS5nZXRVc2VySWQoKTsKCiAgaWYgKGYgIT09IDApIHsKICAgIHdyaXRlci53cml0ZVVpbnQzMigzLCBmKTsKICB9CgogIGYgPSBtZXNzYWdlLmdldEFyZWFJZCgpOwoKICBpZiAoZiAhPT0gMCkgewogICAgd3JpdGVyLndyaXRlVWludDMyKDQsIGYpOwogIH0KCiAgZiA9IG1lc3NhZ2UuZ2V0Tmlja25hbWUoKTsKCiAgaWYgKGYubGVuZ3RoID4gMCkgewogICAgd3JpdGVyLndyaXRlU3RyaW5nKDUsIGYpOwogIH0KCiAgZiA9IG1lc3NhZ2UuZ2V0VmlwT25seSgpOwoKICBpZiAoZikgewogICAgd3JpdGVyLndyaXRlQm9vbCg2LCBmKTsKICB9CgogIGYgPSBtZXNzYWdlLmdldERlcG9zaXRPbmx5KCk7CgogIGlmIChmKSB7CiAgICB3cml0ZXIud3JpdGVCb29sKDcsIGYpOwogIH0KCiAgZiA9IG1lc3NhZ2UuZ2V0TWluQmFsYW5jZSgpOwoKICBpZiAoZiAhPT0gMCkgewogICAgd3JpdGVyLndyaXRlVWludDMyKDgsIGYpOwogIH0KCiAgZiA9IG1lc3NhZ2UuZ2V0Q3JlYXRlZFN0YXJ0KCk7CgogIGlmIChmICE9PSAwKSB7CiAgICB3cml0ZXIud3JpdGVVaW50MzIoOSwgZik7CiAgfQoKICBmID0gbWVzc2FnZS5nZXRDcmVhdGVkRW5kKCk7CgogIGlmIChmICE9PSAwKSB7CiAgICB3cml0ZXIud3JpdGVVaW50MzIoMTAsIGYpOwogIH0KfTsKLyoqCiAqIG9wdGlvbmFsIHVpbnQzMiBwYWdlX25vID0gMTsKICogQHJldHVybiB7bnVtYmVyfQogKi8KCgpwcm90by5wYi5jbXMuVXNlckxpc3RSZXF1ZXN0LnByb3RvdHlwZS5nZXRQYWdlTm8gPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDEsIDApOwp9OwovKioKICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuVXNlckxpc3RSZXF1ZXN0fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLlVzZXJMaXN0UmVxdWVzdC5wcm90b3R5cGUuc2V0UGFnZU5vID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRQcm90bzNJbnRGaWVsZCh0aGlzLCAxLCB2YWx1ZSk7Cn07Ci8qKgogKiBvcHRpb25hbCB1aW50MzIgcGFnZV9zaXplID0gMjsKICogQHJldHVybiB7bnVtYmVyfQogKi8KCgpwcm90by5wYi5jbXMuVXNlckxpc3RSZXF1ZXN0LnByb3RvdHlwZS5nZXRQYWdlU2l6ZSA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQodGhpcywgMiwgMCk7Cn07Ci8qKgogKiBAcGFyYW0ge251bWJlcn0gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5Vc2VyTGlzdFJlcXVlc3R9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuVXNlckxpc3RSZXF1ZXN0LnByb3RvdHlwZS5zZXRQYWdlU2l6ZSA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UHJvdG8zSW50RmllbGQodGhpcywgMiwgdmFsdWUpOwp9OwovKioKICogb3B0aW9uYWwgdWludDMyIHVzZXJfaWQgPSAzOwogKiBAcmV0dXJuIHtudW1iZXJ9CiAqLwoKCnByb3RvLnBiLmNtcy5Vc2VyTGlzdFJlcXVlc3QucHJvdG90eXBlLmdldFVzZXJJZCA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQodGhpcywgMywgMCk7Cn07Ci8qKgogKiBAcGFyYW0ge251bWJlcn0gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5Vc2VyTGlzdFJlcXVlc3R9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuVXNlckxpc3RSZXF1ZXN0LnByb3RvdHlwZS5zZXRVc2VySWQgPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0ludEZpZWxkKHRoaXMsIDMsIHZhbHVlKTsKfTsKLyoqCiAqIG9wdGlvbmFsIHVpbnQzMiBhcmVhX2lkID0gNDsKICogQHJldHVybiB7bnVtYmVyfQogKi8KCgpwcm90by5wYi5jbXMuVXNlckxpc3RSZXF1ZXN0LnByb3RvdHlwZS5nZXRBcmVhSWQgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDQsIDApOwp9OwovKioKICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuVXNlckxpc3RSZXF1ZXN0fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLlVzZXJMaXN0UmVxdWVzdC5wcm90b3R5cGUuc2V0QXJlYUlkID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRQcm90bzNJbnRGaWVsZCh0aGlzLCA0LCB2YWx1ZSk7Cn07Ci8qKgogKiBvcHRpb25hbCBzdHJpbmcgbmlja25hbWUgPSA1OwogKiBAcmV0dXJuIHtzdHJpbmd9CiAqLwoKCnByb3RvLnBiLmNtcy5Vc2VyTGlzdFJlcXVlc3QucHJvdG90eXBlLmdldE5pY2tuYW1lID0gZnVuY3Rpb24gKCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdCh0aGlzLCA1LCAiIik7Cn07Ci8qKgogKiBAcGFyYW0ge3N0cmluZ30gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5Vc2VyTGlzdFJlcXVlc3R9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuVXNlckxpc3RSZXF1ZXN0LnByb3RvdHlwZS5zZXROaWNrbmFtZSA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UHJvdG8zU3RyaW5nRmllbGQodGhpcywgNSwgdmFsdWUpOwp9OwovKioKICogb3B0aW9uYWwgYm9vbCB2aXBfb25seSA9IDY7CiAqIEByZXR1cm4ge2Jvb2xlYW59CiAqLwoKCnByb3RvLnBiLmNtcy5Vc2VyTGlzdFJlcXVlc3QucHJvdG90eXBlLmdldFZpcE9ubHkgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRCb29sZWFuRmllbGRXaXRoRGVmYXVsdCh0aGlzLCA2LCBmYWxzZSk7Cn07Ci8qKgogKiBAcGFyYW0ge2Jvb2xlYW59IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuVXNlckxpc3RSZXF1ZXN0fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLlVzZXJMaXN0UmVxdWVzdC5wcm90b3R5cGUuc2V0VmlwT25seSA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UHJvdG8zQm9vbGVhbkZpZWxkKHRoaXMsIDYsIHZhbHVlKTsKfTsKLyoqCiAqIG9wdGlvbmFsIGJvb2wgZGVwb3NpdF9vbmx5ID0gNzsKICogQHJldHVybiB7Ym9vbGVhbn0KICovCgoKcHJvdG8ucGIuY21zLlVzZXJMaXN0UmVxdWVzdC5wcm90b3R5cGUuZ2V0RGVwb3NpdE9ubHkgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRCb29sZWFuRmllbGRXaXRoRGVmYXVsdCh0aGlzLCA3LCBmYWxzZSk7Cn07Ci8qKgogKiBAcGFyYW0ge2Jvb2xlYW59IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuVXNlckxpc3RSZXF1ZXN0fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLlVzZXJMaXN0UmVxdWVzdC5wcm90b3R5cGUuc2V0RGVwb3NpdE9ubHkgPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0Jvb2xlYW5GaWVsZCh0aGlzLCA3LCB2YWx1ZSk7Cn07Ci8qKgogKiBvcHRpb25hbCB1aW50MzIgbWluX2JhbGFuY2UgPSA4OwogKiBAcmV0dXJuIHtudW1iZXJ9CiAqLwoKCnByb3RvLnBiLmNtcy5Vc2VyTGlzdFJlcXVlc3QucHJvdG90eXBlLmdldE1pbkJhbGFuY2UgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDgsIDApOwp9OwovKioKICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuVXNlckxpc3RSZXF1ZXN0fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLlVzZXJMaXN0UmVxdWVzdC5wcm90b3R5cGUuc2V0TWluQmFsYW5jZSA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UHJvdG8zSW50RmllbGQodGhpcywgOCwgdmFsdWUpOwp9OwovKioKICogb3B0aW9uYWwgdWludDMyIGNyZWF0ZWRfc3RhcnQgPSA5OwogKiBAcmV0dXJuIHtudW1iZXJ9CiAqLwoKCnByb3RvLnBiLmNtcy5Vc2VyTGlzdFJlcXVlc3QucHJvdG90eXBlLmdldENyZWF0ZWRTdGFydCA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQodGhpcywgOSwgMCk7Cn07Ci8qKgogKiBAcGFyYW0ge251bWJlcn0gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5Vc2VyTGlzdFJlcXVlc3R9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuVXNlckxpc3RSZXF1ZXN0LnByb3RvdHlwZS5zZXRDcmVhdGVkU3RhcnQgPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0ludEZpZWxkKHRoaXMsIDksIHZhbHVlKTsKfTsKLyoqCiAqIG9wdGlvbmFsIHVpbnQzMiBjcmVhdGVkX2VuZCA9IDEwOwogKiBAcmV0dXJuIHtudW1iZXJ9CiAqLwoKCnByb3RvLnBiLmNtcy5Vc2VyTGlzdFJlcXVlc3QucHJvdG90eXBlLmdldENyZWF0ZWRFbmQgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDEwLCAwKTsKfTsKLyoqCiAqIEBwYXJhbSB7bnVtYmVyfSB2YWx1ZQogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLlVzZXJMaXN0UmVxdWVzdH0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5Vc2VyTGlzdFJlcXVlc3QucHJvdG90eXBlLnNldENyZWF0ZWRFbmQgPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0ludEZpZWxkKHRoaXMsIDEwLCB2YWx1ZSk7Cn07Ci8qKgogKiBMaXN0IG9mIHJlcGVhdGVkIGZpZWxkcyB3aXRoaW4gdGhpcyBtZXNzYWdlIHR5cGUuCiAqIEBwcml2YXRlIHshQXJyYXk8bnVtYmVyPn0KICogQGNvbnN0CiAqLwoKCnByb3RvLnBiLmNtcy5Vc2VyTGlzdFJlcGx5LnJlcGVhdGVkRmllbGRzXyA9IFsxXTsKCmlmIChqc3BiLk1lc3NhZ2UuR0VORVJBVEVfVE9fT0JKRUNUKSB7CiAgLyoqCiAgICogQ3JlYXRlcyBhbiBvYmplY3QgcmVwcmVzZW50YXRpb24gb2YgdGhpcyBwcm90by4KICAgKiBGaWVsZCBuYW1lcyB0aGF0IGFyZSByZXNlcnZlZCBpbiBKYXZhU2NyaXB0IGFuZCB3aWxsIGJlIHJlbmFtZWQgdG8gcGJfbmFtZS4KICAgKiBPcHRpb25hbCBmaWVsZHMgdGhhdCBhcmUgbm90IHNldCB3aWxsIGJlIHNldCB0byB1bmRlZmluZWQuCiAgICogVG8gYWNjZXNzIGEgcmVzZXJ2ZWQgZmllbGQgdXNlLCBmb28ucGJfPG5hbWU+LCBlZywgZm9vLnBiX2RlZmF1bHQuCiAgICogRm9yIHRoZSBsaXN0IG9mIHJlc2VydmVkIG5hbWVzIHBsZWFzZSBzZWU6CiAgICogICAgIG5ldC9wcm90bzIvY29tcGlsZXIvanMvaW50ZXJuYWwvZ2VuZXJhdG9yLmNjI2tLZXl3b3JkLgogICAqIEBwYXJhbSB7Ym9vbGVhbj19IG9wdF9pbmNsdWRlSW5zdGFuY2UgRGVwcmVjYXRlZC4gd2hldGhlciB0byBpbmNsdWRlIHRoZQogICAqICAgICBKU1BCIGluc3RhbmNlIGZvciB0cmFuc2l0aW9uYWwgc295IHByb3RvIHN1cHBvcnQ6CiAgICogICAgIGh0dHA6Ly9nb3RvL3NveS1wYXJhbS1taWdyYXRpb24KICAgKiBAcmV0dXJuIHshT2JqZWN0fQogICAqLwogIHByb3RvLnBiLmNtcy5Vc2VyTGlzdFJlcGx5LnByb3RvdHlwZS50b09iamVjdCA9IGZ1bmN0aW9uIChvcHRfaW5jbHVkZUluc3RhbmNlKSB7CiAgICByZXR1cm4gcHJvdG8ucGIuY21zLlVzZXJMaXN0UmVwbHkudG9PYmplY3Qob3B0X2luY2x1ZGVJbnN0YW5jZSwgdGhpcyk7CiAgfTsKICAvKioKICAgKiBTdGF0aWMgdmVyc2lvbiBvZiB0aGUge0BzZWUgdG9PYmplY3R9IG1ldGhvZC4KICAgKiBAcGFyYW0ge2Jvb2xlYW58dW5kZWZpbmVkfSBpbmNsdWRlSW5zdGFuY2UgRGVwcmVjYXRlZC4gV2hldGhlciB0byBpbmNsdWRlCiAgICogICAgIHRoZSBKU1BCIGluc3RhbmNlIGZvciB0cmFuc2l0aW9uYWwgc295IHByb3RvIHN1cHBvcnQ6CiAgICogICAgIGh0dHA6Ly9nb3RvL3NveS1wYXJhbS1taWdyYXRpb24KICAgKiBAcGFyYW0geyFwcm90by5wYi5jbXMuVXNlckxpc3RSZXBseX0gbXNnIFRoZSBtc2cgaW5zdGFuY2UgdG8gdHJhbnNmb3JtLgogICAqIEByZXR1cm4geyFPYmplY3R9CiAgICogQHN1cHByZXNzIHt1bnVzZWRMb2NhbFZhcmlhYmxlc30gZiBpcyBvbmx5IHVzZWQgZm9yIG5lc3RlZCBtZXNzYWdlcwogICAqLwoKCiAgcHJvdG8ucGIuY21zLlVzZXJMaXN0UmVwbHkudG9PYmplY3QgPSBmdW5jdGlvbiAoaW5jbHVkZUluc3RhbmNlLCBtc2cpIHsKICAgIHZhciBmLAogICAgICAgIG9iaiA9IHsKICAgICAgdXNlcnNMaXN0OiBqc3BiLk1lc3NhZ2UudG9PYmplY3RMaXN0KG1zZy5nZXRVc2Vyc0xpc3QoKSwgdXNlcnR5cGVfcGIuVXNlci50b09iamVjdCwgaW5jbHVkZUluc3RhbmNlKSwKICAgICAgcGFnZU5vOiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdChtc2csIDIsIDApLAogICAgICBwYWdlU2l6ZToganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQobXNnLCAzLCAwKSwKICAgICAgdG90YWxQYWdlOiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdChtc2csIDQsIDApLAogICAgICB0b3RhbENvdW50OiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdChtc2csIDUsIDApCiAgICB9OwoKICAgIGlmIChpbmNsdWRlSW5zdGFuY2UpIHsKICAgICAgb2JqLiRqc3BiTWVzc2FnZUluc3RhbmNlID0gbXNnOwogICAgfQoKICAgIHJldHVybiBvYmo7CiAgfTsKfQovKioKICogRGVzZXJpYWxpemVzIGJpbmFyeSBkYXRhIChpbiBwcm90b2J1ZiB3aXJlIGZvcm1hdCkuCiAqIEBwYXJhbSB7anNwYi5CeXRlU291cmNlfSBieXRlcyBUaGUgYnl0ZXMgdG8gZGVzZXJpYWxpemUuCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuVXNlckxpc3RSZXBseX0KICovCgoKcHJvdG8ucGIuY21zLlVzZXJMaXN0UmVwbHkuZGVzZXJpYWxpemVCaW5hcnkgPSBmdW5jdGlvbiAoYnl0ZXMpIHsKICB2YXIgcmVhZGVyID0gbmV3IGpzcGIuQmluYXJ5UmVhZGVyKGJ5dGVzKTsKICB2YXIgbXNnID0gbmV3IHByb3RvLnBiLmNtcy5Vc2VyTGlzdFJlcGx5KCk7CiAgcmV0dXJuIHByb3RvLnBiLmNtcy5Vc2VyTGlzdFJlcGx5LmRlc2VyaWFsaXplQmluYXJ5RnJvbVJlYWRlcihtc2csIHJlYWRlcik7Cn07Ci8qKgogKiBEZXNlcmlhbGl6ZXMgYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUgZm9ybWF0KSBmcm9tIHRoZQogKiBnaXZlbiByZWFkZXIgaW50byB0aGUgZ2l2ZW4gbWVzc2FnZSBvYmplY3QuCiAqIEBwYXJhbSB7IXByb3RvLnBiLmNtcy5Vc2VyTGlzdFJlcGx5fSBtc2cgVGhlIG1lc3NhZ2Ugb2JqZWN0IHRvIGRlc2VyaWFsaXplIGludG8uCiAqIEBwYXJhbSB7IWpzcGIuQmluYXJ5UmVhZGVyfSByZWFkZXIgVGhlIEJpbmFyeVJlYWRlciB0byB1c2UuCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuVXNlckxpc3RSZXBseX0KICovCgoKcHJvdG8ucGIuY21zLlVzZXJMaXN0UmVwbHkuZGVzZXJpYWxpemVCaW5hcnlGcm9tUmVhZGVyID0gZnVuY3Rpb24gKG1zZywgcmVhZGVyKSB7CiAgd2hpbGUgKHJlYWRlci5uZXh0RmllbGQoKSkgewogICAgaWYgKHJlYWRlci5pc0VuZEdyb3VwKCkpIHsKICAgICAgYnJlYWs7CiAgICB9CgogICAgdmFyIGZpZWxkID0gcmVhZGVyLmdldEZpZWxkTnVtYmVyKCk7CgogICAgc3dpdGNoIChmaWVsZCkgewogICAgICBjYXNlIDE6CiAgICAgICAgdmFyIHZhbHVlID0gbmV3IHVzZXJ0eXBlX3BiLlVzZXIoKTsKICAgICAgICByZWFkZXIucmVhZE1lc3NhZ2UodmFsdWUsIHVzZXJ0eXBlX3BiLlVzZXIuZGVzZXJpYWxpemVCaW5hcnlGcm9tUmVhZGVyKTsKICAgICAgICBtc2cuYWRkVXNlcnModmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSAyOgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkVWludDMyKCk7CiAgICAgICAgbXNnLnNldFBhZ2VObyh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlIDM6CiAgICAgICAgdmFyIHZhbHVlID0gcmVhZGVyLnJlYWRVaW50MzIoKTsKICAgICAgICBtc2cuc2V0UGFnZVNpemUodmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSA0OgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkVWludDMyKCk7CiAgICAgICAgbXNnLnNldFRvdGFsUGFnZSh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlIDU6CiAgICAgICAgdmFyIHZhbHVlID0gcmVhZGVyLnJlYWRVaW50MzIoKTsKICAgICAgICBtc2cuc2V0VG90YWxDb3VudCh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBkZWZhdWx0OgogICAgICAgIHJlYWRlci5za2lwRmllbGQoKTsKICAgICAgICBicmVhazsKICAgIH0KICB9CgogIHJldHVybiBtc2c7Cn07Ci8qKgogKiBTZXJpYWxpemVzIHRoZSBtZXNzYWdlIHRvIGJpbmFyeSBkYXRhIChpbiBwcm90b2J1ZiB3aXJlIGZvcm1hdCkuCiAqIEByZXR1cm4geyFVaW50OEFycmF5fQogKi8KCgpwcm90by5wYi5jbXMuVXNlckxpc3RSZXBseS5wcm90b3R5cGUuc2VyaWFsaXplQmluYXJ5ID0gZnVuY3Rpb24gKCkgewogIHZhciB3cml0ZXIgPSBuZXcganNwYi5CaW5hcnlXcml0ZXIoKTsKICBwcm90by5wYi5jbXMuVXNlckxpc3RSZXBseS5zZXJpYWxpemVCaW5hcnlUb1dyaXRlcih0aGlzLCB3cml0ZXIpOwogIHJldHVybiB3cml0ZXIuZ2V0UmVzdWx0QnVmZmVyKCk7Cn07Ci8qKgogKiBTZXJpYWxpemVzIHRoZSBnaXZlbiBtZXNzYWdlIHRvIGJpbmFyeSBkYXRhIChpbiBwcm90b2J1ZiB3aXJlCiAqIGZvcm1hdCksIHdyaXRpbmcgdG8gdGhlIGdpdmVuIEJpbmFyeVdyaXRlci4KICogQHBhcmFtIHshcHJvdG8ucGIuY21zLlVzZXJMaXN0UmVwbHl9IG1lc3NhZ2UKICogQHBhcmFtIHshanNwYi5CaW5hcnlXcml0ZXJ9IHdyaXRlcgogKiBAc3VwcHJlc3Mge3VudXNlZExvY2FsVmFyaWFibGVzfSBmIGlzIG9ubHkgdXNlZCBmb3IgbmVzdGVkIG1lc3NhZ2VzCiAqLwoKCnByb3RvLnBiLmNtcy5Vc2VyTGlzdFJlcGx5LnNlcmlhbGl6ZUJpbmFyeVRvV3JpdGVyID0gZnVuY3Rpb24gKG1lc3NhZ2UsIHdyaXRlcikgewogIHZhciBmID0gdW5kZWZpbmVkOwogIGYgPSBtZXNzYWdlLmdldFVzZXJzTGlzdCgpOwoKICBpZiAoZi5sZW5ndGggPiAwKSB7CiAgICB3cml0ZXIud3JpdGVSZXBlYXRlZE1lc3NhZ2UoMSwgZiwgdXNlcnR5cGVfcGIuVXNlci5zZXJpYWxpemVCaW5hcnlUb1dyaXRlcik7CiAgfQoKICBmID0gbWVzc2FnZS5nZXRQYWdlTm8oKTsKCiAgaWYgKGYgIT09IDApIHsKICAgIHdyaXRlci53cml0ZVVpbnQzMigyLCBmKTsKICB9CgogIGYgPSBtZXNzYWdlLmdldFBhZ2VTaXplKCk7CgogIGlmIChmICE9PSAwKSB7CiAgICB3cml0ZXIud3JpdGVVaW50MzIoMywgZik7CiAgfQoKICBmID0gbWVzc2FnZS5nZXRUb3RhbFBhZ2UoKTsKCiAgaWYgKGYgIT09IDApIHsKICAgIHdyaXRlci53cml0ZVVpbnQzMig0LCBmKTsKICB9CgogIGYgPSBtZXNzYWdlLmdldFRvdGFsQ291bnQoKTsKCiAgaWYgKGYgIT09IDApIHsKICAgIHdyaXRlci53cml0ZVVpbnQzMig1LCBmKTsKICB9Cn07Ci8qKgogKiByZXBlYXRlZCBwYi5Vc2VyIHVzZXJzID0gMTsKICogQHJldHVybiB7IUFycmF5PCFwcm90by5wYi5Vc2VyPn0KICovCgoKcHJvdG8ucGIuY21zLlVzZXJMaXN0UmVwbHkucHJvdG90eXBlLmdldFVzZXJzTGlzdCA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldFJlcGVhdGVkV3JhcHBlckZpZWxkKHRoaXMsIHVzZXJ0eXBlX3BiLlVzZXIsIDEpOwp9OwovKioKICogQHBhcmFtIHshQXJyYXk8IXByb3RvLnBiLlVzZXI+fSB2YWx1ZQogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLlVzZXJMaXN0UmVwbHl9IHJldHVybnMgdGhpcwoqLwoKCnByb3RvLnBiLmNtcy5Vc2VyTGlzdFJlcGx5LnByb3RvdHlwZS5zZXRVc2Vyc0xpc3QgPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFJlcGVhdGVkV3JhcHBlckZpZWxkKHRoaXMsIDEsIHZhbHVlKTsKfTsKLyoqCiAqIEBwYXJhbSB7IXByb3RvLnBiLlVzZXI9fSBvcHRfdmFsdWUKICogQHBhcmFtIHtudW1iZXI9fSBvcHRfaW5kZXgKICogQHJldHVybiB7IXByb3RvLnBiLlVzZXJ9CiAqLwoKCnByb3RvLnBiLmNtcy5Vc2VyTGlzdFJlcGx5LnByb3RvdHlwZS5hZGRVc2VycyA9IGZ1bmN0aW9uIChvcHRfdmFsdWUsIG9wdF9pbmRleCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuYWRkVG9SZXBlYXRlZFdyYXBwZXJGaWVsZCh0aGlzLCAxLCBvcHRfdmFsdWUsIHByb3RvLnBiLlVzZXIsIG9wdF9pbmRleCk7Cn07Ci8qKgogKiBDbGVhcnMgdGhlIGxpc3QgbWFraW5nIGl0IGVtcHR5IGJ1dCBub24tbnVsbC4KICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5Vc2VyTGlzdFJlcGx5fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLlVzZXJMaXN0UmVwbHkucHJvdG90eXBlLmNsZWFyVXNlcnNMaXN0ID0gZnVuY3Rpb24gKCkgewogIHJldHVybiB0aGlzLnNldFVzZXJzTGlzdChbXSk7Cn07Ci8qKgogKiBvcHRpb25hbCB1aW50MzIgcGFnZV9ubyA9IDI7CiAqIEByZXR1cm4ge251bWJlcn0KICovCgoKcHJvdG8ucGIuY21zLlVzZXJMaXN0UmVwbHkucHJvdG90eXBlLmdldFBhZ2VObyA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQodGhpcywgMiwgMCk7Cn07Ci8qKgogKiBAcGFyYW0ge251bWJlcn0gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5Vc2VyTGlzdFJlcGx5fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLlVzZXJMaXN0UmVwbHkucHJvdG90eXBlLnNldFBhZ2VObyA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UHJvdG8zSW50RmllbGQodGhpcywgMiwgdmFsdWUpOwp9OwovKioKICogb3B0aW9uYWwgdWludDMyIHBhZ2Vfc2l6ZSA9IDM7CiAqIEByZXR1cm4ge251bWJlcn0KICovCgoKcHJvdG8ucGIuY21zLlVzZXJMaXN0UmVwbHkucHJvdG90eXBlLmdldFBhZ2VTaXplID0gZnVuY3Rpb24gKCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdCh0aGlzLCAzLCAwKTsKfTsKLyoqCiAqIEBwYXJhbSB7bnVtYmVyfSB2YWx1ZQogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLlVzZXJMaXN0UmVwbHl9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuVXNlckxpc3RSZXBseS5wcm90b3R5cGUuc2V0UGFnZVNpemUgPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0ludEZpZWxkKHRoaXMsIDMsIHZhbHVlKTsKfTsKLyoqCiAqIG9wdGlvbmFsIHVpbnQzMiB0b3RhbF9wYWdlID0gNDsKICogQHJldHVybiB7bnVtYmVyfQogKi8KCgpwcm90by5wYi5jbXMuVXNlckxpc3RSZXBseS5wcm90b3R5cGUuZ2V0VG90YWxQYWdlID0gZnVuY3Rpb24gKCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdCh0aGlzLCA0LCAwKTsKfTsKLyoqCiAqIEBwYXJhbSB7bnVtYmVyfSB2YWx1ZQogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLlVzZXJMaXN0UmVwbHl9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuVXNlckxpc3RSZXBseS5wcm90b3R5cGUuc2V0VG90YWxQYWdlID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRQcm90bzNJbnRGaWVsZCh0aGlzLCA0LCB2YWx1ZSk7Cn07Ci8qKgogKiBvcHRpb25hbCB1aW50MzIgdG90YWxfY291bnQgPSA1OwogKiBAcmV0dXJuIHtudW1iZXJ9CiAqLwoKCnByb3RvLnBiLmNtcy5Vc2VyTGlzdFJlcGx5LnByb3RvdHlwZS5nZXRUb3RhbENvdW50ID0gZnVuY3Rpb24gKCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdCh0aGlzLCA1LCAwKTsKfTsKLyoqCiAqIEBwYXJhbSB7bnVtYmVyfSB2YWx1ZQogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLlVzZXJMaXN0UmVwbHl9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuVXNlckxpc3RSZXBseS5wcm90b3R5cGUuc2V0VG90YWxDb3VudCA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UHJvdG8zSW50RmllbGQodGhpcywgNSwgdmFsdWUpOwp9OwoKaWYgKGpzcGIuTWVzc2FnZS5HRU5FUkFURV9UT19PQkpFQ1QpIHsKICAvKioKICAgKiBDcmVhdGVzIGFuIG9iamVjdCByZXByZXNlbnRhdGlvbiBvZiB0aGlzIHByb3RvLgogICAqIEZpZWxkIG5hbWVzIHRoYXQgYXJlIHJlc2VydmVkIGluIEphdmFTY3JpcHQgYW5kIHdpbGwgYmUgcmVuYW1lZCB0byBwYl9uYW1lLgogICAqIE9wdGlvbmFsIGZpZWxkcyB0aGF0IGFyZSBub3Qgc2V0IHdpbGwgYmUgc2V0IHRvIHVuZGVmaW5lZC4KICAgKiBUbyBhY2Nlc3MgYSByZXNlcnZlZCBmaWVsZCB1c2UsIGZvby5wYl88bmFtZT4sIGVnLCBmb28ucGJfZGVmYXVsdC4KICAgKiBGb3IgdGhlIGxpc3Qgb2YgcmVzZXJ2ZWQgbmFtZXMgcGxlYXNlIHNlZToKICAgKiAgICAgbmV0L3Byb3RvMi9jb21waWxlci9qcy9pbnRlcm5hbC9nZW5lcmF0b3IuY2Mja0tleXdvcmQuCiAgICogQHBhcmFtIHtib29sZWFuPX0gb3B0X2luY2x1ZGVJbnN0YW5jZSBEZXByZWNhdGVkLiB3aGV0aGVyIHRvIGluY2x1ZGUgdGhlCiAgICogICAgIEpTUEIgaW5zdGFuY2UgZm9yIHRyYW5zaXRpb25hbCBzb3kgcHJvdG8gc3VwcG9ydDoKICAgKiAgICAgaHR0cDovL2dvdG8vc295LXBhcmFtLW1pZ3JhdGlvbgogICAqIEByZXR1cm4geyFPYmplY3R9CiAgICovCiAgcHJvdG8ucGIuY21zLkFkanVzdEJhbGFuY2VSZXF1ZXN0LnByb3RvdHlwZS50b09iamVjdCA9IGZ1bmN0aW9uIChvcHRfaW5jbHVkZUluc3RhbmNlKSB7CiAgICByZXR1cm4gcHJvdG8ucGIuY21zLkFkanVzdEJhbGFuY2VSZXF1ZXN0LnRvT2JqZWN0KG9wdF9pbmNsdWRlSW5zdGFuY2UsIHRoaXMpOwogIH07CiAgLyoqCiAgICogU3RhdGljIHZlcnNpb24gb2YgdGhlIHtAc2VlIHRvT2JqZWN0fSBtZXRob2QuCiAgICogQHBhcmFtIHtib29sZWFufHVuZGVmaW5lZH0gaW5jbHVkZUluc3RhbmNlIERlcHJlY2F0ZWQuIFdoZXRoZXIgdG8gaW5jbHVkZQogICAqICAgICB0aGUgSlNQQiBpbnN0YW5jZSBmb3IgdHJhbnNpdGlvbmFsIHNveSBwcm90byBzdXBwb3J0OgogICAqICAgICBodHRwOi8vZ290by9zb3ktcGFyYW0tbWlncmF0aW9uCiAgICogQHBhcmFtIHshcHJvdG8ucGIuY21zLkFkanVzdEJhbGFuY2VSZXF1ZXN0fSBtc2cgVGhlIG1zZyBpbnN0YW5jZSB0byB0cmFuc2Zvcm0uCiAgICogQHJldHVybiB7IU9iamVjdH0KICAgKiBAc3VwcHJlc3Mge3VudXNlZExvY2FsVmFyaWFibGVzfSBmIGlzIG9ubHkgdXNlZCBmb3IgbmVzdGVkIG1lc3NhZ2VzCiAgICovCgoKICBwcm90by5wYi5jbXMuQWRqdXN0QmFsYW5jZVJlcXVlc3QudG9PYmplY3QgPSBmdW5jdGlvbiAoaW5jbHVkZUluc3RhbmNlLCBtc2cpIHsKICAgIHZhciBmLAogICAgICAgIG9iaiA9IHsKICAgICAgZW50aXR5VHlwZToganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQobXNnLCAxLCAwKSwKICAgICAgZW50aXR5SWQ6IGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KG1zZywgMiwgMCksCiAgICAgIGFtb3VudDoganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQobXNnLCAzLCAwKSwKICAgICAgc2VuZE5vdGlmeToganNwYi5NZXNzYWdlLmdldEJvb2xlYW5GaWVsZFdpdGhEZWZhdWx0KG1zZywgNCwgZmFsc2UpLAogICAgICBkZXNjOiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdChtc2csIDUsICIiKQogICAgfTsKCiAgICBpZiAoaW5jbHVkZUluc3RhbmNlKSB7CiAgICAgIG9iai4kanNwYk1lc3NhZ2VJbnN0YW5jZSA9IG1zZzsKICAgIH0KCiAgICByZXR1cm4gb2JqOwogIH07Cn0KLyoqCiAqIERlc2VyaWFsaXplcyBiaW5hcnkgZGF0YSAoaW4gcHJvdG9idWYgd2lyZSBmb3JtYXQpLgogKiBAcGFyYW0ge2pzcGIuQnl0ZVNvdXJjZX0gYnl0ZXMgVGhlIGJ5dGVzIHRvIGRlc2VyaWFsaXplLgogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLkFkanVzdEJhbGFuY2VSZXF1ZXN0fQogKi8KCgpwcm90by5wYi5jbXMuQWRqdXN0QmFsYW5jZVJlcXVlc3QuZGVzZXJpYWxpemVCaW5hcnkgPSBmdW5jdGlvbiAoYnl0ZXMpIHsKICB2YXIgcmVhZGVyID0gbmV3IGpzcGIuQmluYXJ5UmVhZGVyKGJ5dGVzKTsKICB2YXIgbXNnID0gbmV3IHByb3RvLnBiLmNtcy5BZGp1c3RCYWxhbmNlUmVxdWVzdCgpOwogIHJldHVybiBwcm90by5wYi5jbXMuQWRqdXN0QmFsYW5jZVJlcXVlc3QuZGVzZXJpYWxpemVCaW5hcnlGcm9tUmVhZGVyKG1zZywgcmVhZGVyKTsKfTsKLyoqCiAqIERlc2VyaWFsaXplcyBiaW5hcnkgZGF0YSAoaW4gcHJvdG9idWYgd2lyZSBmb3JtYXQpIGZyb20gdGhlCiAqIGdpdmVuIHJlYWRlciBpbnRvIHRoZSBnaXZlbiBtZXNzYWdlIG9iamVjdC4KICogQHBhcmFtIHshcHJvdG8ucGIuY21zLkFkanVzdEJhbGFuY2VSZXF1ZXN0fSBtc2cgVGhlIG1lc3NhZ2Ugb2JqZWN0IHRvIGRlc2VyaWFsaXplIGludG8uCiAqIEBwYXJhbSB7IWpzcGIuQmluYXJ5UmVhZGVyfSByZWFkZXIgVGhlIEJpbmFyeVJlYWRlciB0byB1c2UuCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuQWRqdXN0QmFsYW5jZVJlcXVlc3R9CiAqLwoKCnByb3RvLnBiLmNtcy5BZGp1c3RCYWxhbmNlUmVxdWVzdC5kZXNlcmlhbGl6ZUJpbmFyeUZyb21SZWFkZXIgPSBmdW5jdGlvbiAobXNnLCByZWFkZXIpIHsKICB3aGlsZSAocmVhZGVyLm5leHRGaWVsZCgpKSB7CiAgICBpZiAocmVhZGVyLmlzRW5kR3JvdXAoKSkgewogICAgICBicmVhazsKICAgIH0KCiAgICB2YXIgZmllbGQgPSByZWFkZXIuZ2V0RmllbGROdW1iZXIoKTsKCiAgICBzd2l0Y2ggKGZpZWxkKSB7CiAgICAgIGNhc2UgMToKICAgICAgICB2YXIgdmFsdWUgPSByZWFkZXIucmVhZEVudW0oKTsKICAgICAgICBtc2cuc2V0RW50aXR5VHlwZSh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlIDI6CiAgICAgICAgdmFyIHZhbHVlID0gcmVhZGVyLnJlYWRVaW50MzIoKTsKICAgICAgICBtc2cuc2V0RW50aXR5SWQodmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSAzOgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkSW50MzIoKTsKICAgICAgICBtc2cuc2V0QW1vdW50KHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgNDoKICAgICAgICB2YXIgdmFsdWUgPSByZWFkZXIucmVhZEJvb2woKTsKICAgICAgICBtc2cuc2V0U2VuZE5vdGlmeSh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlIDU6CiAgICAgICAgdmFyIHZhbHVlID0gcmVhZGVyLnJlYWRTdHJpbmcoKTsKICAgICAgICBtc2cuc2V0RGVzYyh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBkZWZhdWx0OgogICAgICAgIHJlYWRlci5za2lwRmllbGQoKTsKICAgICAgICBicmVhazsKICAgIH0KICB9CgogIHJldHVybiBtc2c7Cn07Ci8qKgogKiBTZXJpYWxpemVzIHRoZSBtZXNzYWdlIHRvIGJpbmFyeSBkYXRhIChpbiBwcm90b2J1ZiB3aXJlIGZvcm1hdCkuCiAqIEByZXR1cm4geyFVaW50OEFycmF5fQogKi8KCgpwcm90by5wYi5jbXMuQWRqdXN0QmFsYW5jZVJlcXVlc3QucHJvdG90eXBlLnNlcmlhbGl6ZUJpbmFyeSA9IGZ1bmN0aW9uICgpIHsKICB2YXIgd3JpdGVyID0gbmV3IGpzcGIuQmluYXJ5V3JpdGVyKCk7CiAgcHJvdG8ucGIuY21zLkFkanVzdEJhbGFuY2VSZXF1ZXN0LnNlcmlhbGl6ZUJpbmFyeVRvV3JpdGVyKHRoaXMsIHdyaXRlcik7CiAgcmV0dXJuIHdyaXRlci5nZXRSZXN1bHRCdWZmZXIoKTsKfTsKLyoqCiAqIFNlcmlhbGl6ZXMgdGhlIGdpdmVuIG1lc3NhZ2UgdG8gYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUKICogZm9ybWF0KSwgd3JpdGluZyB0byB0aGUgZ2l2ZW4gQmluYXJ5V3JpdGVyLgogKiBAcGFyYW0geyFwcm90by5wYi5jbXMuQWRqdXN0QmFsYW5jZVJlcXVlc3R9IG1lc3NhZ2UKICogQHBhcmFtIHshanNwYi5CaW5hcnlXcml0ZXJ9IHdyaXRlcgogKiBAc3VwcHJlc3Mge3VudXNlZExvY2FsVmFyaWFibGVzfSBmIGlzIG9ubHkgdXNlZCBmb3IgbmVzdGVkIG1lc3NhZ2VzCiAqLwoKCnByb3RvLnBiLmNtcy5BZGp1c3RCYWxhbmNlUmVxdWVzdC5zZXJpYWxpemVCaW5hcnlUb1dyaXRlciA9IGZ1bmN0aW9uIChtZXNzYWdlLCB3cml0ZXIpIHsKICB2YXIgZiA9IHVuZGVmaW5lZDsKICBmID0gbWVzc2FnZS5nZXRFbnRpdHlUeXBlKCk7CgogIGlmIChmICE9PSAwLjApIHsKICAgIHdyaXRlci53cml0ZUVudW0oMSwgZik7CiAgfQoKICBmID0gbWVzc2FnZS5nZXRFbnRpdHlJZCgpOwoKICBpZiAoZiAhPT0gMCkgewogICAgd3JpdGVyLndyaXRlVWludDMyKDIsIGYpOwogIH0KCiAgZiA9IG1lc3NhZ2UuZ2V0QW1vdW50KCk7CgogIGlmIChmICE9PSAwKSB7CiAgICB3cml0ZXIud3JpdGVJbnQzMigzLCBmKTsKICB9CgogIGYgPSBtZXNzYWdlLmdldFNlbmROb3RpZnkoKTsKCiAgaWYgKGYpIHsKICAgIHdyaXRlci53cml0ZUJvb2woNCwgZik7CiAgfQoKICBmID0gbWVzc2FnZS5nZXREZXNjKCk7CgogIGlmIChmLmxlbmd0aCA+IDApIHsKICAgIHdyaXRlci53cml0ZVN0cmluZyg1LCBmKTsKICB9Cn07Ci8qKgogKiBvcHRpb25hbCBwYi5FbnRpdHlUeXBlIGVudGl0eV90eXBlID0gMTsKICogQHJldHVybiB7IXByb3RvLnBiLkVudGl0eVR5cGV9CiAqLwoKCnByb3RvLnBiLmNtcy5BZGp1c3RCYWxhbmNlUmVxdWVzdC5wcm90b3R5cGUuZ2V0RW50aXR5VHlwZSA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQodGhpcywgMSwgMCk7Cn07Ci8qKgogKiBAcGFyYW0geyFwcm90by5wYi5FbnRpdHlUeXBlfSB2YWx1ZQogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLkFkanVzdEJhbGFuY2VSZXF1ZXN0fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLkFkanVzdEJhbGFuY2VSZXF1ZXN0LnByb3RvdHlwZS5zZXRFbnRpdHlUeXBlID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRQcm90bzNFbnVtRmllbGQodGhpcywgMSwgdmFsdWUpOwp9OwovKioKICogb3B0aW9uYWwgdWludDMyIGVudGl0eV9pZCA9IDI7CiAqIEByZXR1cm4ge251bWJlcn0KICovCgoKcHJvdG8ucGIuY21zLkFkanVzdEJhbGFuY2VSZXF1ZXN0LnByb3RvdHlwZS5nZXRFbnRpdHlJZCA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQodGhpcywgMiwgMCk7Cn07Ci8qKgogKiBAcGFyYW0ge251bWJlcn0gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5BZGp1c3RCYWxhbmNlUmVxdWVzdH0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5BZGp1c3RCYWxhbmNlUmVxdWVzdC5wcm90b3R5cGUuc2V0RW50aXR5SWQgPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0ludEZpZWxkKHRoaXMsIDIsIHZhbHVlKTsKfTsKLyoqCiAqIG9wdGlvbmFsIGludDMyIGFtb3VudCA9IDM7CiAqIEByZXR1cm4ge251bWJlcn0KICovCgoKcHJvdG8ucGIuY21zLkFkanVzdEJhbGFuY2VSZXF1ZXN0LnByb3RvdHlwZS5nZXRBbW91bnQgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDMsIDApOwp9OwovKioKICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuQWRqdXN0QmFsYW5jZVJlcXVlc3R9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuQWRqdXN0QmFsYW5jZVJlcXVlc3QucHJvdG90eXBlLnNldEFtb3VudCA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UHJvdG8zSW50RmllbGQodGhpcywgMywgdmFsdWUpOwp9OwovKioKICogb3B0aW9uYWwgYm9vbCBzZW5kX25vdGlmeSA9IDQ7CiAqIEByZXR1cm4ge2Jvb2xlYW59CiAqLwoKCnByb3RvLnBiLmNtcy5BZGp1c3RCYWxhbmNlUmVxdWVzdC5wcm90b3R5cGUuZ2V0U2VuZE5vdGlmeSA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldEJvb2xlYW5GaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDQsIGZhbHNlKTsKfTsKLyoqCiAqIEBwYXJhbSB7Ym9vbGVhbn0gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5BZGp1c3RCYWxhbmNlUmVxdWVzdH0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5BZGp1c3RCYWxhbmNlUmVxdWVzdC5wcm90b3R5cGUuc2V0U2VuZE5vdGlmeSA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UHJvdG8zQm9vbGVhbkZpZWxkKHRoaXMsIDQsIHZhbHVlKTsKfTsKLyoqCiAqIG9wdGlvbmFsIHN0cmluZyBkZXNjID0gNTsKICogQHJldHVybiB7c3RyaW5nfQogKi8KCgpwcm90by5wYi5jbXMuQWRqdXN0QmFsYW5jZVJlcXVlc3QucHJvdG90eXBlLmdldERlc2MgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDUsICIiKTsKfTsKLyoqCiAqIEBwYXJhbSB7c3RyaW5nfSB2YWx1ZQogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLkFkanVzdEJhbGFuY2VSZXF1ZXN0fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLkFkanVzdEJhbGFuY2VSZXF1ZXN0LnByb3RvdHlwZS5zZXREZXNjID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRQcm90bzNTdHJpbmdGaWVsZCh0aGlzLCA1LCB2YWx1ZSk7Cn07CgppZiAoanNwYi5NZXNzYWdlLkdFTkVSQVRFX1RPX09CSkVDVCkgewogIC8qKgogICAqIENyZWF0ZXMgYW4gb2JqZWN0IHJlcHJlc2VudGF0aW9uIG9mIHRoaXMgcHJvdG8uCiAgICogRmllbGQgbmFtZXMgdGhhdCBhcmUgcmVzZXJ2ZWQgaW4gSmF2YVNjcmlwdCBhbmQgd2lsbCBiZSByZW5hbWVkIHRvIHBiX25hbWUuCiAgICogT3B0aW9uYWwgZmllbGRzIHRoYXQgYXJlIG5vdCBzZXQgd2lsbCBiZSBzZXQgdG8gdW5kZWZpbmVkLgogICAqIFRvIGFjY2VzcyBhIHJlc2VydmVkIGZpZWxkIHVzZSwgZm9vLnBiXzxuYW1lPiwgZWcsIGZvby5wYl9kZWZhdWx0LgogICAqIEZvciB0aGUgbGlzdCBvZiByZXNlcnZlZCBuYW1lcyBwbGVhc2Ugc2VlOgogICAqICAgICBuZXQvcHJvdG8yL2NvbXBpbGVyL2pzL2ludGVybmFsL2dlbmVyYXRvci5jYyNrS2V5d29yZC4KICAgKiBAcGFyYW0ge2Jvb2xlYW49fSBvcHRfaW5jbHVkZUluc3RhbmNlIERlcHJlY2F0ZWQuIHdoZXRoZXIgdG8gaW5jbHVkZSB0aGUKICAgKiAgICAgSlNQQiBpbnN0YW5jZSBmb3IgdHJhbnNpdGlvbmFsIHNveSBwcm90byBzdXBwb3J0OgogICAqICAgICBodHRwOi8vZ290by9zb3ktcGFyYW0tbWlncmF0aW9uCiAgICogQHJldHVybiB7IU9iamVjdH0KICAgKi8KICBwcm90by5wYi5jbXMuQWRqdXN0QmFsYW5jZVJlcGx5LnByb3RvdHlwZS50b09iamVjdCA9IGZ1bmN0aW9uIChvcHRfaW5jbHVkZUluc3RhbmNlKSB7CiAgICByZXR1cm4gcHJvdG8ucGIuY21zLkFkanVzdEJhbGFuY2VSZXBseS50b09iamVjdChvcHRfaW5jbHVkZUluc3RhbmNlLCB0aGlzKTsKICB9OwogIC8qKgogICAqIFN0YXRpYyB2ZXJzaW9uIG9mIHRoZSB7QHNlZSB0b09iamVjdH0gbWV0aG9kLgogICAqIEBwYXJhbSB7Ym9vbGVhbnx1bmRlZmluZWR9IGluY2x1ZGVJbnN0YW5jZSBEZXByZWNhdGVkLiBXaGV0aGVyIHRvIGluY2x1ZGUKICAgKiAgICAgdGhlIEpTUEIgaW5zdGFuY2UgZm9yIHRyYW5zaXRpb25hbCBzb3kgcHJvdG8gc3VwcG9ydDoKICAgKiAgICAgaHR0cDovL2dvdG8vc295LXBhcmFtLW1pZ3JhdGlvbgogICAqIEBwYXJhbSB7IXByb3RvLnBiLmNtcy5BZGp1c3RCYWxhbmNlUmVwbHl9IG1zZyBUaGUgbXNnIGluc3RhbmNlIHRvIHRyYW5zZm9ybS4KICAgKiBAcmV0dXJuIHshT2JqZWN0fQogICAqIEBzdXBwcmVzcyB7dW51c2VkTG9jYWxWYXJpYWJsZXN9IGYgaXMgb25seSB1c2VkIGZvciBuZXN0ZWQgbWVzc2FnZXMKICAgKi8KCgogIHByb3RvLnBiLmNtcy5BZGp1c3RCYWxhbmNlUmVwbHkudG9PYmplY3QgPSBmdW5jdGlvbiAoaW5jbHVkZUluc3RhbmNlLCBtc2cpIHsKICAgIHZhciBmLAogICAgICAgIG9iaiA9IHsKICAgICAgYmFsYW5jZToganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQobXNnLCAxLCAwKQogICAgfTsKCiAgICBpZiAoaW5jbHVkZUluc3RhbmNlKSB7CiAgICAgIG9iai4kanNwYk1lc3NhZ2VJbnN0YW5jZSA9IG1zZzsKICAgIH0KCiAgICByZXR1cm4gb2JqOwogIH07Cn0KLyoqCiAqIERlc2VyaWFsaXplcyBiaW5hcnkgZGF0YSAoaW4gcHJvdG9idWYgd2lyZSBmb3JtYXQpLgogKiBAcGFyYW0ge2pzcGIuQnl0ZVNvdXJjZX0gYnl0ZXMgVGhlIGJ5dGVzIHRvIGRlc2VyaWFsaXplLgogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLkFkanVzdEJhbGFuY2VSZXBseX0KICovCgoKcHJvdG8ucGIuY21zLkFkanVzdEJhbGFuY2VSZXBseS5kZXNlcmlhbGl6ZUJpbmFyeSA9IGZ1bmN0aW9uIChieXRlcykgewogIHZhciByZWFkZXIgPSBuZXcganNwYi5CaW5hcnlSZWFkZXIoYnl0ZXMpOwogIHZhciBtc2cgPSBuZXcgcHJvdG8ucGIuY21zLkFkanVzdEJhbGFuY2VSZXBseSgpOwogIHJldHVybiBwcm90by5wYi5jbXMuQWRqdXN0QmFsYW5jZVJlcGx5LmRlc2VyaWFsaXplQmluYXJ5RnJvbVJlYWRlcihtc2csIHJlYWRlcik7Cn07Ci8qKgogKiBEZXNlcmlhbGl6ZXMgYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUgZm9ybWF0KSBmcm9tIHRoZQogKiBnaXZlbiByZWFkZXIgaW50byB0aGUgZ2l2ZW4gbWVzc2FnZSBvYmplY3QuCiAqIEBwYXJhbSB7IXByb3RvLnBiLmNtcy5BZGp1c3RCYWxhbmNlUmVwbHl9IG1zZyBUaGUgbWVzc2FnZSBvYmplY3QgdG8gZGVzZXJpYWxpemUgaW50by4KICogQHBhcmFtIHshanNwYi5CaW5hcnlSZWFkZXJ9IHJlYWRlciBUaGUgQmluYXJ5UmVhZGVyIHRvIHVzZS4KICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5BZGp1c3RCYWxhbmNlUmVwbHl9CiAqLwoKCnByb3RvLnBiLmNtcy5BZGp1c3RCYWxhbmNlUmVwbHkuZGVzZXJpYWxpemVCaW5hcnlGcm9tUmVhZGVyID0gZnVuY3Rpb24gKG1zZywgcmVhZGVyKSB7CiAgd2hpbGUgKHJlYWRlci5uZXh0RmllbGQoKSkgewogICAgaWYgKHJlYWRlci5pc0VuZEdyb3VwKCkpIHsKICAgICAgYnJlYWs7CiAgICB9CgogICAgdmFyIGZpZWxkID0gcmVhZGVyLmdldEZpZWxkTnVtYmVyKCk7CgogICAgc3dpdGNoIChmaWVsZCkgewogICAgICBjYXNlIDE6CiAgICAgICAgdmFyIHZhbHVlID0gcmVhZGVyLnJlYWRVaW50MzIoKTsKICAgICAgICBtc2cuc2V0QmFsYW5jZSh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBkZWZhdWx0OgogICAgICAgIHJlYWRlci5za2lwRmllbGQoKTsKICAgICAgICBicmVhazsKICAgIH0KICB9CgogIHJldHVybiBtc2c7Cn07Ci8qKgogKiBTZXJpYWxpemVzIHRoZSBtZXNzYWdlIHRvIGJpbmFyeSBkYXRhIChpbiBwcm90b2J1ZiB3aXJlIGZvcm1hdCkuCiAqIEByZXR1cm4geyFVaW50OEFycmF5fQogKi8KCgpwcm90by5wYi5jbXMuQWRqdXN0QmFsYW5jZVJlcGx5LnByb3RvdHlwZS5zZXJpYWxpemVCaW5hcnkgPSBmdW5jdGlvbiAoKSB7CiAgdmFyIHdyaXRlciA9IG5ldyBqc3BiLkJpbmFyeVdyaXRlcigpOwogIHByb3RvLnBiLmNtcy5BZGp1c3RCYWxhbmNlUmVwbHkuc2VyaWFsaXplQmluYXJ5VG9Xcml0ZXIodGhpcywgd3JpdGVyKTsKICByZXR1cm4gd3JpdGVyLmdldFJlc3VsdEJ1ZmZlcigpOwp9OwovKioKICogU2VyaWFsaXplcyB0aGUgZ2l2ZW4gbWVzc2FnZSB0byBiaW5hcnkgZGF0YSAoaW4gcHJvdG9idWYgd2lyZQogKiBmb3JtYXQpLCB3cml0aW5nIHRvIHRoZSBnaXZlbiBCaW5hcnlXcml0ZXIuCiAqIEBwYXJhbSB7IXByb3RvLnBiLmNtcy5BZGp1c3RCYWxhbmNlUmVwbHl9IG1lc3NhZ2UKICogQHBhcmFtIHshanNwYi5CaW5hcnlXcml0ZXJ9IHdyaXRlcgogKiBAc3VwcHJlc3Mge3VudXNlZExvY2FsVmFyaWFibGVzfSBmIGlzIG9ubHkgdXNlZCBmb3IgbmVzdGVkIG1lc3NhZ2VzCiAqLwoKCnByb3RvLnBiLmNtcy5BZGp1c3RCYWxhbmNlUmVwbHkuc2VyaWFsaXplQmluYXJ5VG9Xcml0ZXIgPSBmdW5jdGlvbiAobWVzc2FnZSwgd3JpdGVyKSB7CiAgdmFyIGYgPSB1bmRlZmluZWQ7CiAgZiA9IG1lc3NhZ2UuZ2V0QmFsYW5jZSgpOwoKICBpZiAoZiAhPT0gMCkgewogICAgd3JpdGVyLndyaXRlVWludDMyKDEsIGYpOwogIH0KfTsKLyoqCiAqIG9wdGlvbmFsIHVpbnQzMiBiYWxhbmNlID0gMTsKICogQHJldHVybiB7bnVtYmVyfQogKi8KCgpwcm90by5wYi5jbXMuQWRqdXN0QmFsYW5jZVJlcGx5LnByb3RvdHlwZS5nZXRCYWxhbmNlID0gZnVuY3Rpb24gKCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdCh0aGlzLCAxLCAwKTsKfTsKLyoqCiAqIEBwYXJhbSB7bnVtYmVyfSB2YWx1ZQogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLkFkanVzdEJhbGFuY2VSZXBseX0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5BZGp1c3RCYWxhbmNlUmVwbHkucHJvdG90eXBlLnNldEJhbGFuY2UgPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0ludEZpZWxkKHRoaXMsIDEsIHZhbHVlKTsKfTsKCmlmIChqc3BiLk1lc3NhZ2UuR0VORVJBVEVfVE9fT0JKRUNUKSB7CiAgLyoqCiAgICogQ3JlYXRlcyBhbiBvYmplY3QgcmVwcmVzZW50YXRpb24gb2YgdGhpcyBwcm90by4KICAgKiBGaWVsZCBuYW1lcyB0aGF0IGFyZSByZXNlcnZlZCBpbiBKYXZhU2NyaXB0IGFuZCB3aWxsIGJlIHJlbmFtZWQgdG8gcGJfbmFtZS4KICAgKiBPcHRpb25hbCBmaWVsZHMgdGhhdCBhcmUgbm90IHNldCB3aWxsIGJlIHNldCB0byB1bmRlZmluZWQuCiAgICogVG8gYWNjZXNzIGEgcmVzZXJ2ZWQgZmllbGQgdXNlLCBmb28ucGJfPG5hbWU+LCBlZywgZm9vLnBiX2RlZmF1bHQuCiAgICogRm9yIHRoZSBsaXN0IG9mIHJlc2VydmVkIG5hbWVzIHBsZWFzZSBzZWU6CiAgICogICAgIG5ldC9wcm90bzIvY29tcGlsZXIvanMvaW50ZXJuYWwvZ2VuZXJhdG9yLmNjI2tLZXl3b3JkLgogICAqIEBwYXJhbSB7Ym9vbGVhbj19IG9wdF9pbmNsdWRlSW5zdGFuY2UgRGVwcmVjYXRlZC4gd2hldGhlciB0byBpbmNsdWRlIHRoZQogICAqICAgICBKU1BCIGluc3RhbmNlIGZvciB0cmFuc2l0aW9uYWwgc295IHByb3RvIHN1cHBvcnQ6CiAgICogICAgIGh0dHA6Ly9nb3RvL3NveS1wYXJhbS1taWdyYXRpb24KICAgKiBAcmV0dXJuIHshT2JqZWN0fQogICAqLwogIHByb3RvLnBiLmNtcy5CbG9ja1JlcXVlc3QucHJvdG90eXBlLnRvT2JqZWN0ID0gZnVuY3Rpb24gKG9wdF9pbmNsdWRlSW5zdGFuY2UpIHsKICAgIHJldHVybiBwcm90by5wYi5jbXMuQmxvY2tSZXF1ZXN0LnRvT2JqZWN0KG9wdF9pbmNsdWRlSW5zdGFuY2UsIHRoaXMpOwogIH07CiAgLyoqCiAgICogU3RhdGljIHZlcnNpb24gb2YgdGhlIHtAc2VlIHRvT2JqZWN0fSBtZXRob2QuCiAgICogQHBhcmFtIHtib29sZWFufHVuZGVmaW5lZH0gaW5jbHVkZUluc3RhbmNlIERlcHJlY2F0ZWQuIFdoZXRoZXIgdG8gaW5jbHVkZQogICAqICAgICB0aGUgSlNQQiBpbnN0YW5jZSBmb3IgdHJhbnNpdGlvbmFsIHNveSBwcm90byBzdXBwb3J0OgogICAqICAgICBodHRwOi8vZ290by9zb3ktcGFyYW0tbWlncmF0aW9uCiAgICogQHBhcmFtIHshcHJvdG8ucGIuY21zLkJsb2NrUmVxdWVzdH0gbXNnIFRoZSBtc2cgaW5zdGFuY2UgdG8gdHJhbnNmb3JtLgogICAqIEByZXR1cm4geyFPYmplY3R9CiAgICogQHN1cHByZXNzIHt1bnVzZWRMb2NhbFZhcmlhYmxlc30gZiBpcyBvbmx5IHVzZWQgZm9yIG5lc3RlZCBtZXNzYWdlcwogICAqLwoKCiAgcHJvdG8ucGIuY21zLkJsb2NrUmVxdWVzdC50b09iamVjdCA9IGZ1bmN0aW9uIChpbmNsdWRlSW5zdGFuY2UsIG1zZykgewogICAgdmFyIGYsCiAgICAgICAgb2JqID0gewogICAgICBlbnRpdHlUeXBlOiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdChtc2csIDEsIDApLAogICAgICBlbnRpdHlJZDoganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQobXNnLCAyLCAwKSwKICAgICAgYmxvY2tTdGF0dXM6IGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KG1zZywgMywgMCksCiAgICAgIGR1cmF0aW9uOiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdChtc2csIDQsIDApLAogICAgICByZWFzb246IGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KG1zZywgNSwgIiIpCiAgICB9OwoKICAgIGlmIChpbmNsdWRlSW5zdGFuY2UpIHsKICAgICAgb2JqLiRqc3BiTWVzc2FnZUluc3RhbmNlID0gbXNnOwogICAgfQoKICAgIHJldHVybiBvYmo7CiAgfTsKfQovKioKICogRGVzZXJpYWxpemVzIGJpbmFyeSBkYXRhIChpbiBwcm90b2J1ZiB3aXJlIGZvcm1hdCkuCiAqIEBwYXJhbSB7anNwYi5CeXRlU291cmNlfSBieXRlcyBUaGUgYnl0ZXMgdG8gZGVzZXJpYWxpemUuCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuQmxvY2tSZXF1ZXN0fQogKi8KCgpwcm90by5wYi5jbXMuQmxvY2tSZXF1ZXN0LmRlc2VyaWFsaXplQmluYXJ5ID0gZnVuY3Rpb24gKGJ5dGVzKSB7CiAgdmFyIHJlYWRlciA9IG5ldyBqc3BiLkJpbmFyeVJlYWRlcihieXRlcyk7CiAgdmFyIG1zZyA9IG5ldyBwcm90by5wYi5jbXMuQmxvY2tSZXF1ZXN0KCk7CiAgcmV0dXJuIHByb3RvLnBiLmNtcy5CbG9ja1JlcXVlc3QuZGVzZXJpYWxpemVCaW5hcnlGcm9tUmVhZGVyKG1zZywgcmVhZGVyKTsKfTsKLyoqCiAqIERlc2VyaWFsaXplcyBiaW5hcnkgZGF0YSAoaW4gcHJvdG9idWYgd2lyZSBmb3JtYXQpIGZyb20gdGhlCiAqIGdpdmVuIHJlYWRlciBpbnRvIHRoZSBnaXZlbiBtZXNzYWdlIG9iamVjdC4KICogQHBhcmFtIHshcHJvdG8ucGIuY21zLkJsb2NrUmVxdWVzdH0gbXNnIFRoZSBtZXNzYWdlIG9iamVjdCB0byBkZXNlcmlhbGl6ZSBpbnRvLgogKiBAcGFyYW0geyFqc3BiLkJpbmFyeVJlYWRlcn0gcmVhZGVyIFRoZSBCaW5hcnlSZWFkZXIgdG8gdXNlLgogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLkJsb2NrUmVxdWVzdH0KICovCgoKcHJvdG8ucGIuY21zLkJsb2NrUmVxdWVzdC5kZXNlcmlhbGl6ZUJpbmFyeUZyb21SZWFkZXIgPSBmdW5jdGlvbiAobXNnLCByZWFkZXIpIHsKICB3aGlsZSAocmVhZGVyLm5leHRGaWVsZCgpKSB7CiAgICBpZiAocmVhZGVyLmlzRW5kR3JvdXAoKSkgewogICAgICBicmVhazsKICAgIH0KCiAgICB2YXIgZmllbGQgPSByZWFkZXIuZ2V0RmllbGROdW1iZXIoKTsKCiAgICBzd2l0Y2ggKGZpZWxkKSB7CiAgICAgIGNhc2UgMToKICAgICAgICB2YXIgdmFsdWUgPSByZWFkZXIucmVhZEVudW0oKTsKICAgICAgICBtc2cuc2V0RW50aXR5VHlwZSh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlIDI6CiAgICAgICAgdmFyIHZhbHVlID0gcmVhZGVyLnJlYWRVaW50MzIoKTsKICAgICAgICBtc2cuc2V0RW50aXR5SWQodmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSAzOgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkRW51bSgpOwogICAgICAgIG1zZy5zZXRCbG9ja1N0YXR1cyh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlIDQ6CiAgICAgICAgdmFyIHZhbHVlID0gcmVhZGVyLnJlYWRVaW50MzIoKTsKICAgICAgICBtc2cuc2V0RHVyYXRpb24odmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSA1OgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkU3RyaW5nKCk7CiAgICAgICAgbXNnLnNldFJlYXNvbih2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBkZWZhdWx0OgogICAgICAgIHJlYWRlci5za2lwRmllbGQoKTsKICAgICAgICBicmVhazsKICAgIH0KICB9CgogIHJldHVybiBtc2c7Cn07Ci8qKgogKiBTZXJpYWxpemVzIHRoZSBtZXNzYWdlIHRvIGJpbmFyeSBkYXRhIChpbiBwcm90b2J1ZiB3aXJlIGZvcm1hdCkuCiAqIEByZXR1cm4geyFVaW50OEFycmF5fQogKi8KCgpwcm90by5wYi5jbXMuQmxvY2tSZXF1ZXN0LnByb3RvdHlwZS5zZXJpYWxpemVCaW5hcnkgPSBmdW5jdGlvbiAoKSB7CiAgdmFyIHdyaXRlciA9IG5ldyBqc3BiLkJpbmFyeVdyaXRlcigpOwogIHByb3RvLnBiLmNtcy5CbG9ja1JlcXVlc3Quc2VyaWFsaXplQmluYXJ5VG9Xcml0ZXIodGhpcywgd3JpdGVyKTsKICByZXR1cm4gd3JpdGVyLmdldFJlc3VsdEJ1ZmZlcigpOwp9OwovKioKICogU2VyaWFsaXplcyB0aGUgZ2l2ZW4gbWVzc2FnZSB0byBiaW5hcnkgZGF0YSAoaW4gcHJvdG9idWYgd2lyZQogKiBmb3JtYXQpLCB3cml0aW5nIHRvIHRoZSBnaXZlbiBCaW5hcnlXcml0ZXIuCiAqIEBwYXJhbSB7IXByb3RvLnBiLmNtcy5CbG9ja1JlcXVlc3R9IG1lc3NhZ2UKICogQHBhcmFtIHshanNwYi5CaW5hcnlXcml0ZXJ9IHdyaXRlcgogKiBAc3VwcHJlc3Mge3VudXNlZExvY2FsVmFyaWFibGVzfSBmIGlzIG9ubHkgdXNlZCBmb3IgbmVzdGVkIG1lc3NhZ2VzCiAqLwoKCnByb3RvLnBiLmNtcy5CbG9ja1JlcXVlc3Quc2VyaWFsaXplQmluYXJ5VG9Xcml0ZXIgPSBmdW5jdGlvbiAobWVzc2FnZSwgd3JpdGVyKSB7CiAgdmFyIGYgPSB1bmRlZmluZWQ7CiAgZiA9IG1lc3NhZ2UuZ2V0RW50aXR5VHlwZSgpOwoKICBpZiAoZiAhPT0gMC4wKSB7CiAgICB3cml0ZXIud3JpdGVFbnVtKDEsIGYpOwogIH0KCiAgZiA9IG1lc3NhZ2UuZ2V0RW50aXR5SWQoKTsKCiAgaWYgKGYgIT09IDApIHsKICAgIHdyaXRlci53cml0ZVVpbnQzMigyLCBmKTsKICB9CgogIGYgPSBtZXNzYWdlLmdldEJsb2NrU3RhdHVzKCk7CgogIGlmIChmICE9PSAwLjApIHsKICAgIHdyaXRlci53cml0ZUVudW0oMywgZik7CiAgfQoKICBmID0gbWVzc2FnZS5nZXREdXJhdGlvbigpOwoKICBpZiAoZiAhPT0gMCkgewogICAgd3JpdGVyLndyaXRlVWludDMyKDQsIGYpOwogIH0KCiAgZiA9IG1lc3NhZ2UuZ2V0UmVhc29uKCk7CgogIGlmIChmLmxlbmd0aCA+IDApIHsKICAgIHdyaXRlci53cml0ZVN0cmluZyg1LCBmKTsKICB9Cn07Ci8qKgogKiBvcHRpb25hbCBwYi5FbnRpdHlUeXBlIGVudGl0eV90eXBlID0gMTsKICogQHJldHVybiB7IXByb3RvLnBiLkVudGl0eVR5cGV9CiAqLwoKCnByb3RvLnBiLmNtcy5CbG9ja1JlcXVlc3QucHJvdG90eXBlLmdldEVudGl0eVR5cGUgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDEsIDApOwp9OwovKioKICogQHBhcmFtIHshcHJvdG8ucGIuRW50aXR5VHlwZX0gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5CbG9ja1JlcXVlc3R9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuQmxvY2tSZXF1ZXN0LnByb3RvdHlwZS5zZXRFbnRpdHlUeXBlID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRQcm90bzNFbnVtRmllbGQodGhpcywgMSwgdmFsdWUpOwp9OwovKioKICogb3B0aW9uYWwgdWludDMyIGVudGl0eV9pZCA9IDI7CiAqIEByZXR1cm4ge251bWJlcn0KICovCgoKcHJvdG8ucGIuY21zLkJsb2NrUmVxdWVzdC5wcm90b3R5cGUuZ2V0RW50aXR5SWQgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDIsIDApOwp9OwovKioKICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuQmxvY2tSZXF1ZXN0fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLkJsb2NrUmVxdWVzdC5wcm90b3R5cGUuc2V0RW50aXR5SWQgPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0ludEZpZWxkKHRoaXMsIDIsIHZhbHVlKTsKfTsKLyoqCiAqIG9wdGlvbmFsIHBiLkJsb2NrU3RhdHVzIGJsb2NrX3N0YXR1cyA9IDM7CiAqIEByZXR1cm4geyFwcm90by5wYi5CbG9ja1N0YXR1c30KICovCgoKcHJvdG8ucGIuY21zLkJsb2NrUmVxdWVzdC5wcm90b3R5cGUuZ2V0QmxvY2tTdGF0dXMgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDMsIDApOwp9OwovKioKICogQHBhcmFtIHshcHJvdG8ucGIuQmxvY2tTdGF0dXN9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuQmxvY2tSZXF1ZXN0fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLkJsb2NrUmVxdWVzdC5wcm90b3R5cGUuc2V0QmxvY2tTdGF0dXMgPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0VudW1GaWVsZCh0aGlzLCAzLCB2YWx1ZSk7Cn07Ci8qKgogKiBvcHRpb25hbCB1aW50MzIgZHVyYXRpb24gPSA0OwogKiBAcmV0dXJuIHtudW1iZXJ9CiAqLwoKCnByb3RvLnBiLmNtcy5CbG9ja1JlcXVlc3QucHJvdG90eXBlLmdldER1cmF0aW9uID0gZnVuY3Rpb24gKCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdCh0aGlzLCA0LCAwKTsKfTsKLyoqCiAqIEBwYXJhbSB7bnVtYmVyfSB2YWx1ZQogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLkJsb2NrUmVxdWVzdH0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5CbG9ja1JlcXVlc3QucHJvdG90eXBlLnNldER1cmF0aW9uID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRQcm90bzNJbnRGaWVsZCh0aGlzLCA0LCB2YWx1ZSk7Cn07Ci8qKgogKiBvcHRpb25hbCBzdHJpbmcgcmVhc29uID0gNTsKICogQHJldHVybiB7c3RyaW5nfQogKi8KCgpwcm90by5wYi5jbXMuQmxvY2tSZXF1ZXN0LnByb3RvdHlwZS5nZXRSZWFzb24gPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDUsICIiKTsKfTsKLyoqCiAqIEBwYXJhbSB7c3RyaW5nfSB2YWx1ZQogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLkJsb2NrUmVxdWVzdH0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5CbG9ja1JlcXVlc3QucHJvdG90eXBlLnNldFJlYXNvbiA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UHJvdG8zU3RyaW5nRmllbGQodGhpcywgNSwgdmFsdWUpOwp9OwoKaWYgKGpzcGIuTWVzc2FnZS5HRU5FUkFURV9UT19PQkpFQ1QpIHsKICAvKioKICAgKiBDcmVhdGVzIGFuIG9iamVjdCByZXByZXNlbnRhdGlvbiBvZiB0aGlzIHByb3RvLgogICAqIEZpZWxkIG5hbWVzIHRoYXQgYXJlIHJlc2VydmVkIGluIEphdmFTY3JpcHQgYW5kIHdpbGwgYmUgcmVuYW1lZCB0byBwYl9uYW1lLgogICAqIE9wdGlvbmFsIGZpZWxkcyB0aGF0IGFyZSBub3Qgc2V0IHdpbGwgYmUgc2V0IHRvIHVuZGVmaW5lZC4KICAgKiBUbyBhY2Nlc3MgYSByZXNlcnZlZCBmaWVsZCB1c2UsIGZvby5wYl88bmFtZT4sIGVnLCBmb28ucGJfZGVmYXVsdC4KICAgKiBGb3IgdGhlIGxpc3Qgb2YgcmVzZXJ2ZWQgbmFtZXMgcGxlYXNlIHNlZToKICAgKiAgICAgbmV0L3Byb3RvMi9jb21waWxlci9qcy9pbnRlcm5hbC9nZW5lcmF0b3IuY2Mja0tleXdvcmQuCiAgICogQHBhcmFtIHtib29sZWFuPX0gb3B0X2luY2x1ZGVJbnN0YW5jZSBEZXByZWNhdGVkLiB3aGV0aGVyIHRvIGluY2x1ZGUgdGhlCiAgICogICAgIEpTUEIgaW5zdGFuY2UgZm9yIHRyYW5zaXRpb25hbCBzb3kgcHJvdG8gc3VwcG9ydDoKICAgKiAgICAgaHR0cDovL2dvdG8vc295LXBhcmFtLW1pZ3JhdGlvbgogICAqIEByZXR1cm4geyFPYmplY3R9CiAgICovCiAgcHJvdG8ucGIuY21zLlVuYmxvY2tSZXF1ZXN0LnByb3RvdHlwZS50b09iamVjdCA9IGZ1bmN0aW9uIChvcHRfaW5jbHVkZUluc3RhbmNlKSB7CiAgICByZXR1cm4gcHJvdG8ucGIuY21zLlVuYmxvY2tSZXF1ZXN0LnRvT2JqZWN0KG9wdF9pbmNsdWRlSW5zdGFuY2UsIHRoaXMpOwogIH07CiAgLyoqCiAgICogU3RhdGljIHZlcnNpb24gb2YgdGhlIHtAc2VlIHRvT2JqZWN0fSBtZXRob2QuCiAgICogQHBhcmFtIHtib29sZWFufHVuZGVmaW5lZH0gaW5jbHVkZUluc3RhbmNlIERlcHJlY2F0ZWQuIFdoZXRoZXIgdG8gaW5jbHVkZQogICAqICAgICB0aGUgSlNQQiBpbnN0YW5jZSBmb3IgdHJhbnNpdGlvbmFsIHNveSBwcm90byBzdXBwb3J0OgogICAqICAgICBodHRwOi8vZ290by9zb3ktcGFyYW0tbWlncmF0aW9uCiAgICogQHBhcmFtIHshcHJvdG8ucGIuY21zLlVuYmxvY2tSZXF1ZXN0fSBtc2cgVGhlIG1zZyBpbnN0YW5jZSB0byB0cmFuc2Zvcm0uCiAgICogQHJldHVybiB7IU9iamVjdH0KICAgKiBAc3VwcHJlc3Mge3VudXNlZExvY2FsVmFyaWFibGVzfSBmIGlzIG9ubHkgdXNlZCBmb3IgbmVzdGVkIG1lc3NhZ2VzCiAgICovCgoKICBwcm90by5wYi5jbXMuVW5ibG9ja1JlcXVlc3QudG9PYmplY3QgPSBmdW5jdGlvbiAoaW5jbHVkZUluc3RhbmNlLCBtc2cpIHsKICAgIHZhciBmLAogICAgICAgIG9iaiA9IHsKICAgICAgZW50aXR5VHlwZToganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQobXNnLCAxLCAwKSwKICAgICAgZW50aXR5SWQ6IGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KG1zZywgMiwgMCkKICAgIH07CgogICAgaWYgKGluY2x1ZGVJbnN0YW5jZSkgewogICAgICBvYmouJGpzcGJNZXNzYWdlSW5zdGFuY2UgPSBtc2c7CiAgICB9CgogICAgcmV0dXJuIG9iajsKICB9Owp9Ci8qKgogKiBEZXNlcmlhbGl6ZXMgYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUgZm9ybWF0KS4KICogQHBhcmFtIHtqc3BiLkJ5dGVTb3VyY2V9IGJ5dGVzIFRoZSBieXRlcyB0byBkZXNlcmlhbGl6ZS4KICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5VbmJsb2NrUmVxdWVzdH0KICovCgoKcHJvdG8ucGIuY21zLlVuYmxvY2tSZXF1ZXN0LmRlc2VyaWFsaXplQmluYXJ5ID0gZnVuY3Rpb24gKGJ5dGVzKSB7CiAgdmFyIHJlYWRlciA9IG5ldyBqc3BiLkJpbmFyeVJlYWRlcihieXRlcyk7CiAgdmFyIG1zZyA9IG5ldyBwcm90by5wYi5jbXMuVW5ibG9ja1JlcXVlc3QoKTsKICByZXR1cm4gcHJvdG8ucGIuY21zLlVuYmxvY2tSZXF1ZXN0LmRlc2VyaWFsaXplQmluYXJ5RnJvbVJlYWRlcihtc2csIHJlYWRlcik7Cn07Ci8qKgogKiBEZXNlcmlhbGl6ZXMgYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUgZm9ybWF0KSBmcm9tIHRoZQogKiBnaXZlbiByZWFkZXIgaW50byB0aGUgZ2l2ZW4gbWVzc2FnZSBvYmplY3QuCiAqIEBwYXJhbSB7IXByb3RvLnBiLmNtcy5VbmJsb2NrUmVxdWVzdH0gbXNnIFRoZSBtZXNzYWdlIG9iamVjdCB0byBkZXNlcmlhbGl6ZSBpbnRvLgogKiBAcGFyYW0geyFqc3BiLkJpbmFyeVJlYWRlcn0gcmVhZGVyIFRoZSBCaW5hcnlSZWFkZXIgdG8gdXNlLgogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLlVuYmxvY2tSZXF1ZXN0fQogKi8KCgpwcm90by5wYi5jbXMuVW5ibG9ja1JlcXVlc3QuZGVzZXJpYWxpemVCaW5hcnlGcm9tUmVhZGVyID0gZnVuY3Rpb24gKG1zZywgcmVhZGVyKSB7CiAgd2hpbGUgKHJlYWRlci5uZXh0RmllbGQoKSkgewogICAgaWYgKHJlYWRlci5pc0VuZEdyb3VwKCkpIHsKICAgICAgYnJlYWs7CiAgICB9CgogICAgdmFyIGZpZWxkID0gcmVhZGVyLmdldEZpZWxkTnVtYmVyKCk7CgogICAgc3dpdGNoIChmaWVsZCkgewogICAgICBjYXNlIDE6CiAgICAgICAgdmFyIHZhbHVlID0gcmVhZGVyLnJlYWRFbnVtKCk7CiAgICAgICAgbXNnLnNldEVudGl0eVR5cGUodmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSAyOgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkVWludDMyKCk7CiAgICAgICAgbXNnLnNldEVudGl0eUlkKHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGRlZmF1bHQ6CiAgICAgICAgcmVhZGVyLnNraXBGaWVsZCgpOwogICAgICAgIGJyZWFrOwogICAgfQogIH0KCiAgcmV0dXJuIG1zZzsKfTsKLyoqCiAqIFNlcmlhbGl6ZXMgdGhlIG1lc3NhZ2UgdG8gYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUgZm9ybWF0KS4KICogQHJldHVybiB7IVVpbnQ4QXJyYXl9CiAqLwoKCnByb3RvLnBiLmNtcy5VbmJsb2NrUmVxdWVzdC5wcm90b3R5cGUuc2VyaWFsaXplQmluYXJ5ID0gZnVuY3Rpb24gKCkgewogIHZhciB3cml0ZXIgPSBuZXcganNwYi5CaW5hcnlXcml0ZXIoKTsKICBwcm90by5wYi5jbXMuVW5ibG9ja1JlcXVlc3Quc2VyaWFsaXplQmluYXJ5VG9Xcml0ZXIodGhpcywgd3JpdGVyKTsKICByZXR1cm4gd3JpdGVyLmdldFJlc3VsdEJ1ZmZlcigpOwp9OwovKioKICogU2VyaWFsaXplcyB0aGUgZ2l2ZW4gbWVzc2FnZSB0byBiaW5hcnkgZGF0YSAoaW4gcHJvdG9idWYgd2lyZQogKiBmb3JtYXQpLCB3cml0aW5nIHRvIHRoZSBnaXZlbiBCaW5hcnlXcml0ZXIuCiAqIEBwYXJhbSB7IXByb3RvLnBiLmNtcy5VbmJsb2NrUmVxdWVzdH0gbWVzc2FnZQogKiBAcGFyYW0geyFqc3BiLkJpbmFyeVdyaXRlcn0gd3JpdGVyCiAqIEBzdXBwcmVzcyB7dW51c2VkTG9jYWxWYXJpYWJsZXN9IGYgaXMgb25seSB1c2VkIGZvciBuZXN0ZWQgbWVzc2FnZXMKICovCgoKcHJvdG8ucGIuY21zLlVuYmxvY2tSZXF1ZXN0LnNlcmlhbGl6ZUJpbmFyeVRvV3JpdGVyID0gZnVuY3Rpb24gKG1lc3NhZ2UsIHdyaXRlcikgewogIHZhciBmID0gdW5kZWZpbmVkOwogIGYgPSBtZXNzYWdlLmdldEVudGl0eVR5cGUoKTsKCiAgaWYgKGYgIT09IDAuMCkgewogICAgd3JpdGVyLndyaXRlRW51bSgxLCBmKTsKICB9CgogIGYgPSBtZXNzYWdlLmdldEVudGl0eUlkKCk7CgogIGlmIChmICE9PSAwKSB7CiAgICB3cml0ZXIud3JpdGVVaW50MzIoMiwgZik7CiAgfQp9OwovKioKICogb3B0aW9uYWwgcGIuRW50aXR5VHlwZSBlbnRpdHlfdHlwZSA9IDE7CiAqIEByZXR1cm4geyFwcm90by5wYi5FbnRpdHlUeXBlfQogKi8KCgpwcm90by5wYi5jbXMuVW5ibG9ja1JlcXVlc3QucHJvdG90eXBlLmdldEVudGl0eVR5cGUgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDEsIDApOwp9OwovKioKICogQHBhcmFtIHshcHJvdG8ucGIuRW50aXR5VHlwZX0gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5VbmJsb2NrUmVxdWVzdH0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5VbmJsb2NrUmVxdWVzdC5wcm90b3R5cGUuc2V0RW50aXR5VHlwZSA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UHJvdG8zRW51bUZpZWxkKHRoaXMsIDEsIHZhbHVlKTsKfTsKLyoqCiAqIG9wdGlvbmFsIHVpbnQzMiBlbnRpdHlfaWQgPSAyOwogKiBAcmV0dXJuIHtudW1iZXJ9CiAqLwoKCnByb3RvLnBiLmNtcy5VbmJsb2NrUmVxdWVzdC5wcm90b3R5cGUuZ2V0RW50aXR5SWQgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDIsIDApOwp9OwovKioKICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuVW5ibG9ja1JlcXVlc3R9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuVW5ibG9ja1JlcXVlc3QucHJvdG90eXBlLnNldEVudGl0eUlkID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRQcm90bzNJbnRGaWVsZCh0aGlzLCAyLCB2YWx1ZSk7Cn07CgppZiAoanNwYi5NZXNzYWdlLkdFTkVSQVRFX1RPX09CSkVDVCkgewogIC8qKgogICAqIENyZWF0ZXMgYW4gb2JqZWN0IHJlcHJlc2VudGF0aW9uIG9mIHRoaXMgcHJvdG8uCiAgICogRmllbGQgbmFtZXMgdGhhdCBhcmUgcmVzZXJ2ZWQgaW4gSmF2YVNjcmlwdCBhbmQgd2lsbCBiZSByZW5hbWVkIHRvIHBiX25hbWUuCiAgICogT3B0aW9uYWwgZmllbGRzIHRoYXQgYXJlIG5vdCBzZXQgd2lsbCBiZSBzZXQgdG8gdW5kZWZpbmVkLgogICAqIFRvIGFjY2VzcyBhIHJlc2VydmVkIGZpZWxkIHVzZSwgZm9vLnBiXzxuYW1lPiwgZWcsIGZvby5wYl9kZWZhdWx0LgogICAqIEZvciB0aGUgbGlzdCBvZiByZXNlcnZlZCBuYW1lcyBwbGVhc2Ugc2VlOgogICAqICAgICBuZXQvcHJvdG8yL2NvbXBpbGVyL2pzL2ludGVybmFsL2dlbmVyYXRvci5jYyNrS2V5d29yZC4KICAgKiBAcGFyYW0ge2Jvb2xlYW49fSBvcHRfaW5jbHVkZUluc3RhbmNlIERlcHJlY2F0ZWQuIHdoZXRoZXIgdG8gaW5jbHVkZSB0aGUKICAgKiAgICAgSlNQQiBpbnN0YW5jZSBmb3IgdHJhbnNpdGlvbmFsIHNveSBwcm90byBzdXBwb3J0OgogICAqICAgICBodHRwOi8vZ290by9zb3ktcGFyYW0tbWlncmF0aW9uCiAgICogQHJldHVybiB7IU9iamVjdH0KICAgKi8KICBwcm90by5wYi5jbXMuTWlncmF0ZVJlcXVlc3QucHJvdG90eXBlLnRvT2JqZWN0ID0gZnVuY3Rpb24gKG9wdF9pbmNsdWRlSW5zdGFuY2UpIHsKICAgIHJldHVybiBwcm90by5wYi5jbXMuTWlncmF0ZVJlcXVlc3QudG9PYmplY3Qob3B0X2luY2x1ZGVJbnN0YW5jZSwgdGhpcyk7CiAgfTsKICAvKioKICAgKiBTdGF0aWMgdmVyc2lvbiBvZiB0aGUge0BzZWUgdG9PYmplY3R9IG1ldGhvZC4KICAgKiBAcGFyYW0ge2Jvb2xlYW58dW5kZWZpbmVkfSBpbmNsdWRlSW5zdGFuY2UgRGVwcmVjYXRlZC4gV2hldGhlciB0byBpbmNsdWRlCiAgICogICAgIHRoZSBKU1BCIGluc3RhbmNlIGZvciB0cmFuc2l0aW9uYWwgc295IHByb3RvIHN1cHBvcnQ6CiAgICogICAgIGh0dHA6Ly9nb3RvL3NveS1wYXJhbS1taWdyYXRpb24KICAgKiBAcGFyYW0geyFwcm90by5wYi5jbXMuTWlncmF0ZVJlcXVlc3R9IG1zZyBUaGUgbXNnIGluc3RhbmNlIHRvIHRyYW5zZm9ybS4KICAgKiBAcmV0dXJuIHshT2JqZWN0fQogICAqIEBzdXBwcmVzcyB7dW51c2VkTG9jYWxWYXJpYWJsZXN9IGYgaXMgb25seSB1c2VkIGZvciBuZXN0ZWQgbWVzc2FnZXMKICAgKi8KCgogIHByb3RvLnBiLmNtcy5NaWdyYXRlUmVxdWVzdC50b09iamVjdCA9IGZ1bmN0aW9uIChpbmNsdWRlSW5zdGFuY2UsIG1zZykgewogICAgdmFyIGYsCiAgICAgICAgb2JqID0gewogICAgICBlbnRpdHlUeXBlOiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdChtc2csIDEsIDApLAogICAgICBzcmNJZDoganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQobXNnLCAyLCAwKSwKICAgICAgZHN0SWQ6IGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KG1zZywgMywgMCkKICAgIH07CgogICAgaWYgKGluY2x1ZGVJbnN0YW5jZSkgewogICAgICBvYmouJGpzcGJNZXNzYWdlSW5zdGFuY2UgPSBtc2c7CiAgICB9CgogICAgcmV0dXJuIG9iajsKICB9Owp9Ci8qKgogKiBEZXNlcmlhbGl6ZXMgYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUgZm9ybWF0KS4KICogQHBhcmFtIHtqc3BiLkJ5dGVTb3VyY2V9IGJ5dGVzIFRoZSBieXRlcyB0byBkZXNlcmlhbGl6ZS4KICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5NaWdyYXRlUmVxdWVzdH0KICovCgoKcHJvdG8ucGIuY21zLk1pZ3JhdGVSZXF1ZXN0LmRlc2VyaWFsaXplQmluYXJ5ID0gZnVuY3Rpb24gKGJ5dGVzKSB7CiAgdmFyIHJlYWRlciA9IG5ldyBqc3BiLkJpbmFyeVJlYWRlcihieXRlcyk7CiAgdmFyIG1zZyA9IG5ldyBwcm90by5wYi5jbXMuTWlncmF0ZVJlcXVlc3QoKTsKICByZXR1cm4gcHJvdG8ucGIuY21zLk1pZ3JhdGVSZXF1ZXN0LmRlc2VyaWFsaXplQmluYXJ5RnJvbVJlYWRlcihtc2csIHJlYWRlcik7Cn07Ci8qKgogKiBEZXNlcmlhbGl6ZXMgYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUgZm9ybWF0KSBmcm9tIHRoZQogKiBnaXZlbiByZWFkZXIgaW50byB0aGUgZ2l2ZW4gbWVzc2FnZSBvYmplY3QuCiAqIEBwYXJhbSB7IXByb3RvLnBiLmNtcy5NaWdyYXRlUmVxdWVzdH0gbXNnIFRoZSBtZXNzYWdlIG9iamVjdCB0byBkZXNlcmlhbGl6ZSBpbnRvLgogKiBAcGFyYW0geyFqc3BiLkJpbmFyeVJlYWRlcn0gcmVhZGVyIFRoZSBCaW5hcnlSZWFkZXIgdG8gdXNlLgogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLk1pZ3JhdGVSZXF1ZXN0fQogKi8KCgpwcm90by5wYi5jbXMuTWlncmF0ZVJlcXVlc3QuZGVzZXJpYWxpemVCaW5hcnlGcm9tUmVhZGVyID0gZnVuY3Rpb24gKG1zZywgcmVhZGVyKSB7CiAgd2hpbGUgKHJlYWRlci5uZXh0RmllbGQoKSkgewogICAgaWYgKHJlYWRlci5pc0VuZEdyb3VwKCkpIHsKICAgICAgYnJlYWs7CiAgICB9CgogICAgdmFyIGZpZWxkID0gcmVhZGVyLmdldEZpZWxkTnVtYmVyKCk7CgogICAgc3dpdGNoIChmaWVsZCkgewogICAgICBjYXNlIDE6CiAgICAgICAgdmFyIHZhbHVlID0gcmVhZGVyLnJlYWRFbnVtKCk7CiAgICAgICAgbXNnLnNldEVudGl0eVR5cGUodmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSAyOgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkVWludDMyKCk7CiAgICAgICAgbXNnLnNldFNyY0lkKHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgMzoKICAgICAgICB2YXIgdmFsdWUgPSByZWFkZXIucmVhZFVpbnQzMigpOwogICAgICAgIG1zZy5zZXREc3RJZCh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBkZWZhdWx0OgogICAgICAgIHJlYWRlci5za2lwRmllbGQoKTsKICAgICAgICBicmVhazsKICAgIH0KICB9CgogIHJldHVybiBtc2c7Cn07Ci8qKgogKiBTZXJpYWxpemVzIHRoZSBtZXNzYWdlIHRvIGJpbmFyeSBkYXRhIChpbiBwcm90b2J1ZiB3aXJlIGZvcm1hdCkuCiAqIEByZXR1cm4geyFVaW50OEFycmF5fQogKi8KCgpwcm90by5wYi5jbXMuTWlncmF0ZVJlcXVlc3QucHJvdG90eXBlLnNlcmlhbGl6ZUJpbmFyeSA9IGZ1bmN0aW9uICgpIHsKICB2YXIgd3JpdGVyID0gbmV3IGpzcGIuQmluYXJ5V3JpdGVyKCk7CiAgcHJvdG8ucGIuY21zLk1pZ3JhdGVSZXF1ZXN0LnNlcmlhbGl6ZUJpbmFyeVRvV3JpdGVyKHRoaXMsIHdyaXRlcik7CiAgcmV0dXJuIHdyaXRlci5nZXRSZXN1bHRCdWZmZXIoKTsKfTsKLyoqCiAqIFNlcmlhbGl6ZXMgdGhlIGdpdmVuIG1lc3NhZ2UgdG8gYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUKICogZm9ybWF0KSwgd3JpdGluZyB0byB0aGUgZ2l2ZW4gQmluYXJ5V3JpdGVyLgogKiBAcGFyYW0geyFwcm90by5wYi5jbXMuTWlncmF0ZVJlcXVlc3R9IG1lc3NhZ2UKICogQHBhcmFtIHshanNwYi5CaW5hcnlXcml0ZXJ9IHdyaXRlcgogKiBAc3VwcHJlc3Mge3VudXNlZExvY2FsVmFyaWFibGVzfSBmIGlzIG9ubHkgdXNlZCBmb3IgbmVzdGVkIG1lc3NhZ2VzCiAqLwoKCnByb3RvLnBiLmNtcy5NaWdyYXRlUmVxdWVzdC5zZXJpYWxpemVCaW5hcnlUb1dyaXRlciA9IGZ1bmN0aW9uIChtZXNzYWdlLCB3cml0ZXIpIHsKICB2YXIgZiA9IHVuZGVmaW5lZDsKICBmID0gbWVzc2FnZS5nZXRFbnRpdHlUeXBlKCk7CgogIGlmIChmICE9PSAwLjApIHsKICAgIHdyaXRlci53cml0ZUVudW0oMSwgZik7CiAgfQoKICBmID0gbWVzc2FnZS5nZXRTcmNJZCgpOwoKICBpZiAoZiAhPT0gMCkgewogICAgd3JpdGVyLndyaXRlVWludDMyKDIsIGYpOwogIH0KCiAgZiA9IG1lc3NhZ2UuZ2V0RHN0SWQoKTsKCiAgaWYgKGYgIT09IDApIHsKICAgIHdyaXRlci53cml0ZVVpbnQzMigzLCBmKTsKICB9Cn07Ci8qKgogKiBvcHRpb25hbCBwYi5FbnRpdHlUeXBlIGVudGl0eV90eXBlID0gMTsKICogQHJldHVybiB7IXByb3RvLnBiLkVudGl0eVR5cGV9CiAqLwoKCnByb3RvLnBiLmNtcy5NaWdyYXRlUmVxdWVzdC5wcm90b3R5cGUuZ2V0RW50aXR5VHlwZSA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQodGhpcywgMSwgMCk7Cn07Ci8qKgogKiBAcGFyYW0geyFwcm90by5wYi5FbnRpdHlUeXBlfSB2YWx1ZQogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLk1pZ3JhdGVSZXF1ZXN0fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLk1pZ3JhdGVSZXF1ZXN0LnByb3RvdHlwZS5zZXRFbnRpdHlUeXBlID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRQcm90bzNFbnVtRmllbGQodGhpcywgMSwgdmFsdWUpOwp9OwovKioKICogb3B0aW9uYWwgdWludDMyIHNyY19pZCA9IDI7CiAqIEByZXR1cm4ge251bWJlcn0KICovCgoKcHJvdG8ucGIuY21zLk1pZ3JhdGVSZXF1ZXN0LnByb3RvdHlwZS5nZXRTcmNJZCA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQodGhpcywgMiwgMCk7Cn07Ci8qKgogKiBAcGFyYW0ge251bWJlcn0gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5NaWdyYXRlUmVxdWVzdH0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5NaWdyYXRlUmVxdWVzdC5wcm90b3R5cGUuc2V0U3JjSWQgPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0ludEZpZWxkKHRoaXMsIDIsIHZhbHVlKTsKfTsKLyoqCiAqIG9wdGlvbmFsIHVpbnQzMiBkc3RfaWQgPSAzOwogKiBAcmV0dXJuIHtudW1iZXJ9CiAqLwoKCnByb3RvLnBiLmNtcy5NaWdyYXRlUmVxdWVzdC5wcm90b3R5cGUuZ2V0RHN0SWQgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDMsIDApOwp9OwovKioKICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuTWlncmF0ZVJlcXVlc3R9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuTWlncmF0ZVJlcXVlc3QucHJvdG90eXBlLnNldERzdElkID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRQcm90bzNJbnRGaWVsZCh0aGlzLCAzLCB2YWx1ZSk7Cn07CgppZiAoanNwYi5NZXNzYWdlLkdFTkVSQVRFX1RPX09CSkVDVCkgewogIC8qKgogICAqIENyZWF0ZXMgYW4gb2JqZWN0IHJlcHJlc2VudGF0aW9uIG9mIHRoaXMgcHJvdG8uCiAgICogRmllbGQgbmFtZXMgdGhhdCBhcmUgcmVzZXJ2ZWQgaW4gSmF2YVNjcmlwdCBhbmQgd2lsbCBiZSByZW5hbWVkIHRvIHBiX25hbWUuCiAgICogT3B0aW9uYWwgZmllbGRzIHRoYXQgYXJlIG5vdCBzZXQgd2lsbCBiZSBzZXQgdG8gdW5kZWZpbmVkLgogICAqIFRvIGFjY2VzcyBhIHJlc2VydmVkIGZpZWxkIHVzZSwgZm9vLnBiXzxuYW1lPiwgZWcsIGZvby5wYl9kZWZhdWx0LgogICAqIEZvciB0aGUgbGlzdCBvZiByZXNlcnZlZCBuYW1lcyBwbGVhc2Ugc2VlOgogICAqICAgICBuZXQvcHJvdG8yL2NvbXBpbGVyL2pzL2ludGVybmFsL2dlbmVyYXRvci5jYyNrS2V5d29yZC4KICAgKiBAcGFyYW0ge2Jvb2xlYW49fSBvcHRfaW5jbHVkZUluc3RhbmNlIERlcHJlY2F0ZWQuIHdoZXRoZXIgdG8gaW5jbHVkZSB0aGUKICAgKiAgICAgSlNQQiBpbnN0YW5jZSBmb3IgdHJhbnNpdGlvbmFsIHNveSBwcm90byBzdXBwb3J0OgogICAqICAgICBodHRwOi8vZ290by9zb3ktcGFyYW0tbWlncmF0aW9uCiAgICogQHJldHVybiB7IU9iamVjdH0KICAgKi8KICBwcm90by5wYi5jbXMuQXV0aG9yaXplQW5jaG9yUmVxdWVzdC5wcm90b3R5cGUudG9PYmplY3QgPSBmdW5jdGlvbiAob3B0X2luY2x1ZGVJbnN0YW5jZSkgewogICAgcmV0dXJuIHByb3RvLnBiLmNtcy5BdXRob3JpemVBbmNob3JSZXF1ZXN0LnRvT2JqZWN0KG9wdF9pbmNsdWRlSW5zdGFuY2UsIHRoaXMpOwogIH07CiAgLyoqCiAgICogU3RhdGljIHZlcnNpb24gb2YgdGhlIHtAc2VlIHRvT2JqZWN0fSBtZXRob2QuCiAgICogQHBhcmFtIHtib29sZWFufHVuZGVmaW5lZH0gaW5jbHVkZUluc3RhbmNlIERlcHJlY2F0ZWQuIFdoZXRoZXIgdG8gaW5jbHVkZQogICAqICAgICB0aGUgSlNQQiBpbnN0YW5jZSBmb3IgdHJhbnNpdGlvbmFsIHNveSBwcm90byBzdXBwb3J0OgogICAqICAgICBodHRwOi8vZ290by9zb3ktcGFyYW0tbWlncmF0aW9uCiAgICogQHBhcmFtIHshcHJvdG8ucGIuY21zLkF1dGhvcml6ZUFuY2hvclJlcXVlc3R9IG1zZyBUaGUgbXNnIGluc3RhbmNlIHRvIHRyYW5zZm9ybS4KICAgKiBAcmV0dXJuIHshT2JqZWN0fQogICAqIEBzdXBwcmVzcyB7dW51c2VkTG9jYWxWYXJpYWJsZXN9IGYgaXMgb25seSB1c2VkIGZvciBuZXN0ZWQgbWVzc2FnZXMKICAgKi8KCgogIHByb3RvLnBiLmNtcy5BdXRob3JpemVBbmNob3JSZXF1ZXN0LnRvT2JqZWN0ID0gZnVuY3Rpb24gKGluY2x1ZGVJbnN0YW5jZSwgbXNnKSB7CiAgICB2YXIgZiwKICAgICAgICBvYmogPSB7CiAgICAgIGFuY2hvcklkOiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdChtc2csIDEsIDApLAogICAgICBhcmVhSWQ6IGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KG1zZywgMiwgMCksCiAgICAgIGd1aWxkSWQ6IGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KG1zZywgMywgMCkKICAgIH07CgogICAgaWYgKGluY2x1ZGVJbnN0YW5jZSkgewogICAgICBvYmouJGpzcGJNZXNzYWdlSW5zdGFuY2UgPSBtc2c7CiAgICB9CgogICAgcmV0dXJuIG9iajsKICB9Owp9Ci8qKgogKiBEZXNlcmlhbGl6ZXMgYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUgZm9ybWF0KS4KICogQHBhcmFtIHtqc3BiLkJ5dGVTb3VyY2V9IGJ5dGVzIFRoZSBieXRlcyB0byBkZXNlcmlhbGl6ZS4KICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5BdXRob3JpemVBbmNob3JSZXF1ZXN0fQogKi8KCgpwcm90by5wYi5jbXMuQXV0aG9yaXplQW5jaG9yUmVxdWVzdC5kZXNlcmlhbGl6ZUJpbmFyeSA9IGZ1bmN0aW9uIChieXRlcykgewogIHZhciByZWFkZXIgPSBuZXcganNwYi5CaW5hcnlSZWFkZXIoYnl0ZXMpOwogIHZhciBtc2cgPSBuZXcgcHJvdG8ucGIuY21zLkF1dGhvcml6ZUFuY2hvclJlcXVlc3QoKTsKICByZXR1cm4gcHJvdG8ucGIuY21zLkF1dGhvcml6ZUFuY2hvclJlcXVlc3QuZGVzZXJpYWxpemVCaW5hcnlGcm9tUmVhZGVyKG1zZywgcmVhZGVyKTsKfTsKLyoqCiAqIERlc2VyaWFsaXplcyBiaW5hcnkgZGF0YSAoaW4gcHJvdG9idWYgd2lyZSBmb3JtYXQpIGZyb20gdGhlCiAqIGdpdmVuIHJlYWRlciBpbnRvIHRoZSBnaXZlbiBtZXNzYWdlIG9iamVjdC4KICogQHBhcmFtIHshcHJvdG8ucGIuY21zLkF1dGhvcml6ZUFuY2hvclJlcXVlc3R9IG1zZyBUaGUgbWVzc2FnZSBvYmplY3QgdG8gZGVzZXJpYWxpemUgaW50by4KICogQHBhcmFtIHshanNwYi5CaW5hcnlSZWFkZXJ9IHJlYWRlciBUaGUgQmluYXJ5UmVhZGVyIHRvIHVzZS4KICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5BdXRob3JpemVBbmNob3JSZXF1ZXN0fQogKi8KCgpwcm90by5wYi5jbXMuQXV0aG9yaXplQW5jaG9yUmVxdWVzdC5kZXNlcmlhbGl6ZUJpbmFyeUZyb21SZWFkZXIgPSBmdW5jdGlvbiAobXNnLCByZWFkZXIpIHsKICB3aGlsZSAocmVhZGVyLm5leHRGaWVsZCgpKSB7CiAgICBpZiAocmVhZGVyLmlzRW5kR3JvdXAoKSkgewogICAgICBicmVhazsKICAgIH0KCiAgICB2YXIgZmllbGQgPSByZWFkZXIuZ2V0RmllbGROdW1iZXIoKTsKCiAgICBzd2l0Y2ggKGZpZWxkKSB7CiAgICAgIGNhc2UgMToKICAgICAgICB2YXIgdmFsdWUgPSByZWFkZXIucmVhZFVpbnQzMigpOwogICAgICAgIG1zZy5zZXRBbmNob3JJZCh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlIDI6CiAgICAgICAgdmFyIHZhbHVlID0gcmVhZGVyLnJlYWRVaW50MzIoKTsKICAgICAgICBtc2cuc2V0QXJlYUlkKHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgMzoKICAgICAgICB2YXIgdmFsdWUgPSByZWFkZXIucmVhZFVpbnQzMigpOwogICAgICAgIG1zZy5zZXRHdWlsZElkKHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGRlZmF1bHQ6CiAgICAgICAgcmVhZGVyLnNraXBGaWVsZCgpOwogICAgICAgIGJyZWFrOwogICAgfQogIH0KCiAgcmV0dXJuIG1zZzsKfTsKLyoqCiAqIFNlcmlhbGl6ZXMgdGhlIG1lc3NhZ2UgdG8gYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUgZm9ybWF0KS4KICogQHJldHVybiB7IVVpbnQ4QXJyYXl9CiAqLwoKCnByb3RvLnBiLmNtcy5BdXRob3JpemVBbmNob3JSZXF1ZXN0LnByb3RvdHlwZS5zZXJpYWxpemVCaW5hcnkgPSBmdW5jdGlvbiAoKSB7CiAgdmFyIHdyaXRlciA9IG5ldyBqc3BiLkJpbmFyeVdyaXRlcigpOwogIHByb3RvLnBiLmNtcy5BdXRob3JpemVBbmNob3JSZXF1ZXN0LnNlcmlhbGl6ZUJpbmFyeVRvV3JpdGVyKHRoaXMsIHdyaXRlcik7CiAgcmV0dXJuIHdyaXRlci5nZXRSZXN1bHRCdWZmZXIoKTsKfTsKLyoqCiAqIFNlcmlhbGl6ZXMgdGhlIGdpdmVuIG1lc3NhZ2UgdG8gYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUKICogZm9ybWF0KSwgd3JpdGluZyB0byB0aGUgZ2l2ZW4gQmluYXJ5V3JpdGVyLgogKiBAcGFyYW0geyFwcm90by5wYi5jbXMuQXV0aG9yaXplQW5jaG9yUmVxdWVzdH0gbWVzc2FnZQogKiBAcGFyYW0geyFqc3BiLkJpbmFyeVdyaXRlcn0gd3JpdGVyCiAqIEBzdXBwcmVzcyB7dW51c2VkTG9jYWxWYXJpYWJsZXN9IGYgaXMgb25seSB1c2VkIGZvciBuZXN0ZWQgbWVzc2FnZXMKICovCgoKcHJvdG8ucGIuY21zLkF1dGhvcml6ZUFuY2hvclJlcXVlc3Quc2VyaWFsaXplQmluYXJ5VG9Xcml0ZXIgPSBmdW5jdGlvbiAobWVzc2FnZSwgd3JpdGVyKSB7CiAgdmFyIGYgPSB1bmRlZmluZWQ7CiAgZiA9IG1lc3NhZ2UuZ2V0QW5jaG9ySWQoKTsKCiAgaWYgKGYgIT09IDApIHsKICAgIHdyaXRlci53cml0ZVVpbnQzMigxLCBmKTsKICB9CgogIGYgPSBtZXNzYWdlLmdldEFyZWFJZCgpOwoKICBpZiAoZiAhPT0gMCkgewogICAgd3JpdGVyLndyaXRlVWludDMyKDIsIGYpOwogIH0KCiAgZiA9IG1lc3NhZ2UuZ2V0R3VpbGRJZCgpOwoKICBpZiAoZiAhPT0gMCkgewogICAgd3JpdGVyLndyaXRlVWludDMyKDMsIGYpOwogIH0KfTsKLyoqCiAqIG9wdGlvbmFsIHVpbnQzMiBhbmNob3JfaWQgPSAxOwogKiBAcmV0dXJuIHtudW1iZXJ9CiAqLwoKCnByb3RvLnBiLmNtcy5BdXRob3JpemVBbmNob3JSZXF1ZXN0LnByb3RvdHlwZS5nZXRBbmNob3JJZCA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQodGhpcywgMSwgMCk7Cn07Ci8qKgogKiBAcGFyYW0ge251bWJlcn0gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5BdXRob3JpemVBbmNob3JSZXF1ZXN0fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLkF1dGhvcml6ZUFuY2hvclJlcXVlc3QucHJvdG90eXBlLnNldEFuY2hvcklkID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRQcm90bzNJbnRGaWVsZCh0aGlzLCAxLCB2YWx1ZSk7Cn07Ci8qKgogKiBvcHRpb25hbCB1aW50MzIgYXJlYV9pZCA9IDI7CiAqIEByZXR1cm4ge251bWJlcn0KICovCgoKcHJvdG8ucGIuY21zLkF1dGhvcml6ZUFuY2hvclJlcXVlc3QucHJvdG90eXBlLmdldEFyZWFJZCA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQodGhpcywgMiwgMCk7Cn07Ci8qKgogKiBAcGFyYW0ge251bWJlcn0gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5BdXRob3JpemVBbmNob3JSZXF1ZXN0fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLkF1dGhvcml6ZUFuY2hvclJlcXVlc3QucHJvdG90eXBlLnNldEFyZWFJZCA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UHJvdG8zSW50RmllbGQodGhpcywgMiwgdmFsdWUpOwp9OwovKioKICogb3B0aW9uYWwgdWludDMyIGd1aWxkX2lkID0gMzsKICogQHJldHVybiB7bnVtYmVyfQogKi8KCgpwcm90by5wYi5jbXMuQXV0aG9yaXplQW5jaG9yUmVxdWVzdC5wcm90b3R5cGUuZ2V0R3VpbGRJZCA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQodGhpcywgMywgMCk7Cn07Ci8qKgogKiBAcGFyYW0ge251bWJlcn0gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5BdXRob3JpemVBbmNob3JSZXF1ZXN0fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLkF1dGhvcml6ZUFuY2hvclJlcXVlc3QucHJvdG90eXBlLnNldEd1aWxkSWQgPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0ludEZpZWxkKHRoaXMsIDMsIHZhbHVlKTsKfTsKCmlmIChqc3BiLk1lc3NhZ2UuR0VORVJBVEVfVE9fT0JKRUNUKSB7CiAgLyoqCiAgICogQ3JlYXRlcyBhbiBvYmplY3QgcmVwcmVzZW50YXRpb24gb2YgdGhpcyBwcm90by4KICAgKiBGaWVsZCBuYW1lcyB0aGF0IGFyZSByZXNlcnZlZCBpbiBKYXZhU2NyaXB0IGFuZCB3aWxsIGJlIHJlbmFtZWQgdG8gcGJfbmFtZS4KICAgKiBPcHRpb25hbCBmaWVsZHMgdGhhdCBhcmUgbm90IHNldCB3aWxsIGJlIHNldCB0byB1bmRlZmluZWQuCiAgICogVG8gYWNjZXNzIGEgcmVzZXJ2ZWQgZmllbGQgdXNlLCBmb28ucGJfPG5hbWU+LCBlZywgZm9vLnBiX2RlZmF1bHQuCiAgICogRm9yIHRoZSBsaXN0IG9mIHJlc2VydmVkIG5hbWVzIHBsZWFzZSBzZWU6CiAgICogICAgIG5ldC9wcm90bzIvY29tcGlsZXIvanMvaW50ZXJuYWwvZ2VuZXJhdG9yLmNjI2tLZXl3b3JkLgogICAqIEBwYXJhbSB7Ym9vbGVhbj19IG9wdF9pbmNsdWRlSW5zdGFuY2UgRGVwcmVjYXRlZC4gd2hldGhlciB0byBpbmNsdWRlIHRoZQogICAqICAgICBKU1BCIGluc3RhbmNlIGZvciB0cmFuc2l0aW9uYWwgc295IHByb3RvIHN1cHBvcnQ6CiAgICogICAgIGh0dHA6Ly9nb3RvL3NveS1wYXJhbS1taWdyYXRpb24KICAgKiBAcmV0dXJuIHshT2JqZWN0fQogICAqLwogIHByb3RvLnBiLmNtcy5BbmNob3JGdWxsUmVxdWVzdC5wcm90b3R5cGUudG9PYmplY3QgPSBmdW5jdGlvbiAob3B0X2luY2x1ZGVJbnN0YW5jZSkgewogICAgcmV0dXJuIHByb3RvLnBiLmNtcy5BbmNob3JGdWxsUmVxdWVzdC50b09iamVjdChvcHRfaW5jbHVkZUluc3RhbmNlLCB0aGlzKTsKICB9OwogIC8qKgogICAqIFN0YXRpYyB2ZXJzaW9uIG9mIHRoZSB7QHNlZSB0b09iamVjdH0gbWV0aG9kLgogICAqIEBwYXJhbSB7Ym9vbGVhbnx1bmRlZmluZWR9IGluY2x1ZGVJbnN0YW5jZSBEZXByZWNhdGVkLiBXaGV0aGVyIHRvIGluY2x1ZGUKICAgKiAgICAgdGhlIEpTUEIgaW5zdGFuY2UgZm9yIHRyYW5zaXRpb25hbCBzb3kgcHJvdG8gc3VwcG9ydDoKICAgKiAgICAgaHR0cDovL2dvdG8vc295LXBhcmFtLW1pZ3JhdGlvbgogICAqIEBwYXJhbSB7IXByb3RvLnBiLmNtcy5BbmNob3JGdWxsUmVxdWVzdH0gbXNnIFRoZSBtc2cgaW5zdGFuY2UgdG8gdHJhbnNmb3JtLgogICAqIEByZXR1cm4geyFPYmplY3R9CiAgICogQHN1cHByZXNzIHt1bnVzZWRMb2NhbFZhcmlhYmxlc30gZiBpcyBvbmx5IHVzZWQgZm9yIG5lc3RlZCBtZXNzYWdlcwogICAqLwoKCiAgcHJvdG8ucGIuY21zLkFuY2hvckZ1bGxSZXF1ZXN0LnRvT2JqZWN0ID0gZnVuY3Rpb24gKGluY2x1ZGVJbnN0YW5jZSwgbXNnKSB7CiAgICB2YXIgZiwKICAgICAgICBvYmogPSB7CiAgICAgIGFuY2hvcklkOiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdChtc2csIDEsIDApCiAgICB9OwoKICAgIGlmIChpbmNsdWRlSW5zdGFuY2UpIHsKICAgICAgb2JqLiRqc3BiTWVzc2FnZUluc3RhbmNlID0gbXNnOwogICAgfQoKICAgIHJldHVybiBvYmo7CiAgfTsKfQovKioKICogRGVzZXJpYWxpemVzIGJpbmFyeSBkYXRhIChpbiBwcm90b2J1ZiB3aXJlIGZvcm1hdCkuCiAqIEBwYXJhbSB7anNwYi5CeXRlU291cmNlfSBieXRlcyBUaGUgYnl0ZXMgdG8gZGVzZXJpYWxpemUuCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuQW5jaG9yRnVsbFJlcXVlc3R9CiAqLwoKCnByb3RvLnBiLmNtcy5BbmNob3JGdWxsUmVxdWVzdC5kZXNlcmlhbGl6ZUJpbmFyeSA9IGZ1bmN0aW9uIChieXRlcykgewogIHZhciByZWFkZXIgPSBuZXcganNwYi5CaW5hcnlSZWFkZXIoYnl0ZXMpOwogIHZhciBtc2cgPSBuZXcgcHJvdG8ucGIuY21zLkFuY2hvckZ1bGxSZXF1ZXN0KCk7CiAgcmV0dXJuIHByb3RvLnBiLmNtcy5BbmNob3JGdWxsUmVxdWVzdC5kZXNlcmlhbGl6ZUJpbmFyeUZyb21SZWFkZXIobXNnLCByZWFkZXIpOwp9OwovKioKICogRGVzZXJpYWxpemVzIGJpbmFyeSBkYXRhIChpbiBwcm90b2J1ZiB3aXJlIGZvcm1hdCkgZnJvbSB0aGUKICogZ2l2ZW4gcmVhZGVyIGludG8gdGhlIGdpdmVuIG1lc3NhZ2Ugb2JqZWN0LgogKiBAcGFyYW0geyFwcm90by5wYi5jbXMuQW5jaG9yRnVsbFJlcXVlc3R9IG1zZyBUaGUgbWVzc2FnZSBvYmplY3QgdG8gZGVzZXJpYWxpemUgaW50by4KICogQHBhcmFtIHshanNwYi5CaW5hcnlSZWFkZXJ9IHJlYWRlciBUaGUgQmluYXJ5UmVhZGVyIHRvIHVzZS4KICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5BbmNob3JGdWxsUmVxdWVzdH0KICovCgoKcHJvdG8ucGIuY21zLkFuY2hvckZ1bGxSZXF1ZXN0LmRlc2VyaWFsaXplQmluYXJ5RnJvbVJlYWRlciA9IGZ1bmN0aW9uIChtc2csIHJlYWRlcikgewogIHdoaWxlIChyZWFkZXIubmV4dEZpZWxkKCkpIHsKICAgIGlmIChyZWFkZXIuaXNFbmRHcm91cCgpKSB7CiAgICAgIGJyZWFrOwogICAgfQoKICAgIHZhciBmaWVsZCA9IHJlYWRlci5nZXRGaWVsZE51bWJlcigpOwoKICAgIHN3aXRjaCAoZmllbGQpIHsKICAgICAgY2FzZSAxOgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkVWludDMyKCk7CiAgICAgICAgbXNnLnNldEFuY2hvcklkKHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGRlZmF1bHQ6CiAgICAgICAgcmVhZGVyLnNraXBGaWVsZCgpOwogICAgICAgIGJyZWFrOwogICAgfQogIH0KCiAgcmV0dXJuIG1zZzsKfTsKLyoqCiAqIFNlcmlhbGl6ZXMgdGhlIG1lc3NhZ2UgdG8gYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUgZm9ybWF0KS4KICogQHJldHVybiB7IVVpbnQ4QXJyYXl9CiAqLwoKCnByb3RvLnBiLmNtcy5BbmNob3JGdWxsUmVxdWVzdC5wcm90b3R5cGUuc2VyaWFsaXplQmluYXJ5ID0gZnVuY3Rpb24gKCkgewogIHZhciB3cml0ZXIgPSBuZXcganNwYi5CaW5hcnlXcml0ZXIoKTsKICBwcm90by5wYi5jbXMuQW5jaG9yRnVsbFJlcXVlc3Quc2VyaWFsaXplQmluYXJ5VG9Xcml0ZXIodGhpcywgd3JpdGVyKTsKICByZXR1cm4gd3JpdGVyLmdldFJlc3VsdEJ1ZmZlcigpOwp9OwovKioKICogU2VyaWFsaXplcyB0aGUgZ2l2ZW4gbWVzc2FnZSB0byBiaW5hcnkgZGF0YSAoaW4gcHJvdG9idWYgd2lyZQogKiBmb3JtYXQpLCB3cml0aW5nIHRvIHRoZSBnaXZlbiBCaW5hcnlXcml0ZXIuCiAqIEBwYXJhbSB7IXByb3RvLnBiLmNtcy5BbmNob3JGdWxsUmVxdWVzdH0gbWVzc2FnZQogKiBAcGFyYW0geyFqc3BiLkJpbmFyeVdyaXRlcn0gd3JpdGVyCiAqIEBzdXBwcmVzcyB7dW51c2VkTG9jYWxWYXJpYWJsZXN9IGYgaXMgb25seSB1c2VkIGZvciBuZXN0ZWQgbWVzc2FnZXMKICovCgoKcHJvdG8ucGIuY21zLkFuY2hvckZ1bGxSZXF1ZXN0LnNlcmlhbGl6ZUJpbmFyeVRvV3JpdGVyID0gZnVuY3Rpb24gKG1lc3NhZ2UsIHdyaXRlcikgewogIHZhciBmID0gdW5kZWZpbmVkOwogIGYgPSBtZXNzYWdlLmdldEFuY2hvcklkKCk7CgogIGlmIChmICE9PSAwKSB7CiAgICB3cml0ZXIud3JpdGVVaW50MzIoMSwgZik7CiAgfQp9OwovKioKICogb3B0aW9uYWwgdWludDMyIGFuY2hvcl9pZCA9IDE7CiAqIEByZXR1cm4ge251bWJlcn0KICovCgoKcHJvdG8ucGIuY21zLkFuY2hvckZ1bGxSZXF1ZXN0LnByb3RvdHlwZS5nZXRBbmNob3JJZCA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQodGhpcywgMSwgMCk7Cn07Ci8qKgogKiBAcGFyYW0ge251bWJlcn0gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5BbmNob3JGdWxsUmVxdWVzdH0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5BbmNob3JGdWxsUmVxdWVzdC5wcm90b3R5cGUuc2V0QW5jaG9ySWQgPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0ludEZpZWxkKHRoaXMsIDEsIHZhbHVlKTsKfTsKLyoqCiAqIExpc3Qgb2YgcmVwZWF0ZWQgZmllbGRzIHdpdGhpbiB0aGlzIG1lc3NhZ2UgdHlwZS4KICogQHByaXZhdGUgeyFBcnJheTxudW1iZXI+fQogKiBAY29uc3QKICovCgoKcHJvdG8ucGIuY21zLkFuY2hvckZ1bGxSZXBseS5yZXBlYXRlZEZpZWxkc18gPSBbMl07CgppZiAoanNwYi5NZXNzYWdlLkdFTkVSQVRFX1RPX09CSkVDVCkgewogIC8qKgogICAqIENyZWF0ZXMgYW4gb2JqZWN0IHJlcHJlc2VudGF0aW9uIG9mIHRoaXMgcHJvdG8uCiAgICogRmllbGQgbmFtZXMgdGhhdCBhcmUgcmVzZXJ2ZWQgaW4gSmF2YVNjcmlwdCBhbmQgd2lsbCBiZSByZW5hbWVkIHRvIHBiX25hbWUuCiAgICogT3B0aW9uYWwgZmllbGRzIHRoYXQgYXJlIG5vdCBzZXQgd2lsbCBiZSBzZXQgdG8gdW5kZWZpbmVkLgogICAqIFRvIGFjY2VzcyBhIHJlc2VydmVkIGZpZWxkIHVzZSwgZm9vLnBiXzxuYW1lPiwgZWcsIGZvby5wYl9kZWZhdWx0LgogICAqIEZvciB0aGUgbGlzdCBvZiByZXNlcnZlZCBuYW1lcyBwbGVhc2Ugc2VlOgogICAqICAgICBuZXQvcHJvdG8yL2NvbXBpbGVyL2pzL2ludGVybmFsL2dlbmVyYXRvci5jYyNrS2V5d29yZC4KICAgKiBAcGFyYW0ge2Jvb2xlYW49fSBvcHRfaW5jbHVkZUluc3RhbmNlIERlcHJlY2F0ZWQuIHdoZXRoZXIgdG8gaW5jbHVkZSB0aGUKICAgKiAgICAgSlNQQiBpbnN0YW5jZSBmb3IgdHJhbnNpdGlvbmFsIHNveSBwcm90byBzdXBwb3J0OgogICAqICAgICBodHRwOi8vZ290by9zb3ktcGFyYW0tbWlncmF0aW9uCiAgICogQHJldHVybiB7IU9iamVjdH0KICAgKi8KICBwcm90by5wYi5jbXMuQW5jaG9yRnVsbFJlcGx5LnByb3RvdHlwZS50b09iamVjdCA9IGZ1bmN0aW9uIChvcHRfaW5jbHVkZUluc3RhbmNlKSB7CiAgICByZXR1cm4gcHJvdG8ucGIuY21zLkFuY2hvckZ1bGxSZXBseS50b09iamVjdChvcHRfaW5jbHVkZUluc3RhbmNlLCB0aGlzKTsKICB9OwogIC8qKgogICAqIFN0YXRpYyB2ZXJzaW9uIG9mIHRoZSB7QHNlZSB0b09iamVjdH0gbWV0aG9kLgogICAqIEBwYXJhbSB7Ym9vbGVhbnx1bmRlZmluZWR9IGluY2x1ZGVJbnN0YW5jZSBEZXByZWNhdGVkLiBXaGV0aGVyIHRvIGluY2x1ZGUKICAgKiAgICAgdGhlIEpTUEIgaW5zdGFuY2UgZm9yIHRyYW5zaXRpb25hbCBzb3kgcHJvdG8gc3VwcG9ydDoKICAgKiAgICAgaHR0cDovL2dvdG8vc295LXBhcmFtLW1pZ3JhdGlvbgogICAqIEBwYXJhbSB7IXByb3RvLnBiLmNtcy5BbmNob3JGdWxsUmVwbHl9IG1zZyBUaGUgbXNnIGluc3RhbmNlIHRvIHRyYW5zZm9ybS4KICAgKiBAcmV0dXJuIHshT2JqZWN0fQogICAqIEBzdXBwcmVzcyB7dW51c2VkTG9jYWxWYXJpYWJsZXN9IGYgaXMgb25seSB1c2VkIGZvciBuZXN0ZWQgbWVzc2FnZXMKICAgKi8KCgogIHByb3RvLnBiLmNtcy5BbmNob3JGdWxsUmVwbHkudG9PYmplY3QgPSBmdW5jdGlvbiAoaW5jbHVkZUluc3RhbmNlLCBtc2cpIHsKICAgIHZhciBmLAogICAgICAgIG9iaiA9IHsKICAgICAgYmFzaWM6IChmID0gbXNnLmdldEJhc2ljKCkpICYmIGFuY2hvcnR5cGVfcGIuQW5jaG9yQmFzaWMudG9PYmplY3QoaW5jbHVkZUluc3RhbmNlLCBmKSwKICAgICAgcHJvZmlsZXNMaXN0OiBqc3BiLk1lc3NhZ2UudG9PYmplY3RMaXN0KG1zZy5nZXRQcm9maWxlc0xpc3QoKSwgYW5jaG9ydHlwZV9wYi5BbmNob3JQcm9maWxlLnRvT2JqZWN0LCBpbmNsdWRlSW5zdGFuY2UpCiAgICB9OwoKICAgIGlmIChpbmNsdWRlSW5zdGFuY2UpIHsKICAgICAgb2JqLiRqc3BiTWVzc2FnZUluc3RhbmNlID0gbXNnOwogICAgfQoKICAgIHJldHVybiBvYmo7CiAgfTsKfQovKioKICogRGVzZXJpYWxpemVzIGJpbmFyeSBkYXRhIChpbiBwcm90b2J1ZiB3aXJlIGZvcm1hdCkuCiAqIEBwYXJhbSB7anNwYi5CeXRlU291cmNlfSBieXRlcyBUaGUgYnl0ZXMgdG8gZGVzZXJpYWxpemUuCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuQW5jaG9yRnVsbFJlcGx5fQogKi8KCgpwcm90by5wYi5jbXMuQW5jaG9yRnVsbFJlcGx5LmRlc2VyaWFsaXplQmluYXJ5ID0gZnVuY3Rpb24gKGJ5dGVzKSB7CiAgdmFyIHJlYWRlciA9IG5ldyBqc3BiLkJpbmFyeVJlYWRlcihieXRlcyk7CiAgdmFyIG1zZyA9IG5ldyBwcm90by5wYi5jbXMuQW5jaG9yRnVsbFJlcGx5KCk7CiAgcmV0dXJuIHByb3RvLnBiLmNtcy5BbmNob3JGdWxsUmVwbHkuZGVzZXJpYWxpemVCaW5hcnlGcm9tUmVhZGVyKG1zZywgcmVhZGVyKTsKfTsKLyoqCiAqIERlc2VyaWFsaXplcyBiaW5hcnkgZGF0YSAoaW4gcHJvdG9idWYgd2lyZSBmb3JtYXQpIGZyb20gdGhlCiAqIGdpdmVuIHJlYWRlciBpbnRvIHRoZSBnaXZlbiBtZXNzYWdlIG9iamVjdC4KICogQHBhcmFtIHshcHJvdG8ucGIuY21zLkFuY2hvckZ1bGxSZXBseX0gbXNnIFRoZSBtZXNzYWdlIG9iamVjdCB0byBkZXNlcmlhbGl6ZSBpbnRvLgogKiBAcGFyYW0geyFqc3BiLkJpbmFyeVJlYWRlcn0gcmVhZGVyIFRoZSBCaW5hcnlSZWFkZXIgdG8gdXNlLgogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLkFuY2hvckZ1bGxSZXBseX0KICovCgoKcHJvdG8ucGIuY21zLkFuY2hvckZ1bGxSZXBseS5kZXNlcmlhbGl6ZUJpbmFyeUZyb21SZWFkZXIgPSBmdW5jdGlvbiAobXNnLCByZWFkZXIpIHsKICB3aGlsZSAocmVhZGVyLm5leHRGaWVsZCgpKSB7CiAgICBpZiAocmVhZGVyLmlzRW5kR3JvdXAoKSkgewogICAgICBicmVhazsKICAgIH0KCiAgICB2YXIgZmllbGQgPSByZWFkZXIuZ2V0RmllbGROdW1iZXIoKTsKCiAgICBzd2l0Y2ggKGZpZWxkKSB7CiAgICAgIGNhc2UgMToKICAgICAgICB2YXIgdmFsdWUgPSBuZXcgYW5jaG9ydHlwZV9wYi5BbmNob3JCYXNpYygpOwogICAgICAgIHJlYWRlci5yZWFkTWVzc2FnZSh2YWx1ZSwgYW5jaG9ydHlwZV9wYi5BbmNob3JCYXNpYy5kZXNlcmlhbGl6ZUJpbmFyeUZyb21SZWFkZXIpOwogICAgICAgIG1zZy5zZXRCYXNpYyh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlIDI6CiAgICAgICAgdmFyIHZhbHVlID0gbmV3IGFuY2hvcnR5cGVfcGIuQW5jaG9yUHJvZmlsZSgpOwogICAgICAgIHJlYWRlci5yZWFkTWVzc2FnZSh2YWx1ZSwgYW5jaG9ydHlwZV9wYi5BbmNob3JQcm9maWxlLmRlc2VyaWFsaXplQmluYXJ5RnJvbVJlYWRlcik7CiAgICAgICAgbXNnLmFkZFByb2ZpbGVzKHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGRlZmF1bHQ6CiAgICAgICAgcmVhZGVyLnNraXBGaWVsZCgpOwogICAgICAgIGJyZWFrOwogICAgfQogIH0KCiAgcmV0dXJuIG1zZzsKfTsKLyoqCiAqIFNlcmlhbGl6ZXMgdGhlIG1lc3NhZ2UgdG8gYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUgZm9ybWF0KS4KICogQHJldHVybiB7IVVpbnQ4QXJyYXl9CiAqLwoKCnByb3RvLnBiLmNtcy5BbmNob3JGdWxsUmVwbHkucHJvdG90eXBlLnNlcmlhbGl6ZUJpbmFyeSA9IGZ1bmN0aW9uICgpIHsKICB2YXIgd3JpdGVyID0gbmV3IGpzcGIuQmluYXJ5V3JpdGVyKCk7CiAgcHJvdG8ucGIuY21zLkFuY2hvckZ1bGxSZXBseS5zZXJpYWxpemVCaW5hcnlUb1dyaXRlcih0aGlzLCB3cml0ZXIpOwogIHJldHVybiB3cml0ZXIuZ2V0UmVzdWx0QnVmZmVyKCk7Cn07Ci8qKgogKiBTZXJpYWxpemVzIHRoZSBnaXZlbiBtZXNzYWdlIHRvIGJpbmFyeSBkYXRhIChpbiBwcm90b2J1ZiB3aXJlCiAqIGZvcm1hdCksIHdyaXRpbmcgdG8gdGhlIGdpdmVuIEJpbmFyeVdyaXRlci4KICogQHBhcmFtIHshcHJvdG8ucGIuY21zLkFuY2hvckZ1bGxSZXBseX0gbWVzc2FnZQogKiBAcGFyYW0geyFqc3BiLkJpbmFyeVdyaXRlcn0gd3JpdGVyCiAqIEBzdXBwcmVzcyB7dW51c2VkTG9jYWxWYXJpYWJsZXN9IGYgaXMgb25seSB1c2VkIGZvciBuZXN0ZWQgbWVzc2FnZXMKICovCgoKcHJvdG8ucGIuY21zLkFuY2hvckZ1bGxSZXBseS5zZXJpYWxpemVCaW5hcnlUb1dyaXRlciA9IGZ1bmN0aW9uIChtZXNzYWdlLCB3cml0ZXIpIHsKICB2YXIgZiA9IHVuZGVmaW5lZDsKICBmID0gbWVzc2FnZS5nZXRCYXNpYygpOwoKICBpZiAoZiAhPSBudWxsKSB7CiAgICB3cml0ZXIud3JpdGVNZXNzYWdlKDEsIGYsIGFuY2hvcnR5cGVfcGIuQW5jaG9yQmFzaWMuc2VyaWFsaXplQmluYXJ5VG9Xcml0ZXIpOwogIH0KCiAgZiA9IG1lc3NhZ2UuZ2V0UHJvZmlsZXNMaXN0KCk7CgogIGlmIChmLmxlbmd0aCA+IDApIHsKICAgIHdyaXRlci53cml0ZVJlcGVhdGVkTWVzc2FnZSgyLCBmLCBhbmNob3J0eXBlX3BiLkFuY2hvclByb2ZpbGUuc2VyaWFsaXplQmluYXJ5VG9Xcml0ZXIpOwogIH0KfTsKLyoqCiAqIG9wdGlvbmFsIHBiLkFuY2hvckJhc2ljIGJhc2ljID0gMTsKICogQHJldHVybiB7P3Byb3RvLnBiLkFuY2hvckJhc2ljfQogKi8KCgpwcm90by5wYi5jbXMuQW5jaG9yRnVsbFJlcGx5LnByb3RvdHlwZS5nZXRCYXNpYyA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldFdyYXBwZXJGaWVsZCh0aGlzLCBhbmNob3J0eXBlX3BiLkFuY2hvckJhc2ljLCAxKTsKfTsKLyoqCiAqIEBwYXJhbSB7P3Byb3RvLnBiLkFuY2hvckJhc2ljfHVuZGVmaW5lZH0gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5BbmNob3JGdWxsUmVwbHl9IHJldHVybnMgdGhpcwoqLwoKCnByb3RvLnBiLmNtcy5BbmNob3JGdWxsUmVwbHkucHJvdG90eXBlLnNldEJhc2ljID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRXcmFwcGVyRmllbGQodGhpcywgMSwgdmFsdWUpOwp9OwovKioKICogQ2xlYXJzIHRoZSBtZXNzYWdlIGZpZWxkIG1ha2luZyBpdCB1bmRlZmluZWQuCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuQW5jaG9yRnVsbFJlcGx5fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLkFuY2hvckZ1bGxSZXBseS5wcm90b3R5cGUuY2xlYXJCYXNpYyA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4gdGhpcy5zZXRCYXNpYyh1bmRlZmluZWQpOwp9OwovKioKICogUmV0dXJucyB3aGV0aGVyIHRoaXMgZmllbGQgaXMgc2V0LgogKiBAcmV0dXJuIHtib29sZWFufQogKi8KCgpwcm90by5wYi5jbXMuQW5jaG9yRnVsbFJlcGx5LnByb3RvdHlwZS5oYXNCYXNpYyA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldEZpZWxkKHRoaXMsIDEpICE9IG51bGw7Cn07Ci8qKgogKiByZXBlYXRlZCBwYi5BbmNob3JQcm9maWxlIHByb2ZpbGVzID0gMjsKICogQHJldHVybiB7IUFycmF5PCFwcm90by5wYi5BbmNob3JQcm9maWxlPn0KICovCgoKcHJvdG8ucGIuY21zLkFuY2hvckZ1bGxSZXBseS5wcm90b3R5cGUuZ2V0UHJvZmlsZXNMaXN0ID0gZnVuY3Rpb24gKCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuZ2V0UmVwZWF0ZWRXcmFwcGVyRmllbGQodGhpcywgYW5jaG9ydHlwZV9wYi5BbmNob3JQcm9maWxlLCAyKTsKfTsKLyoqCiAqIEBwYXJhbSB7IUFycmF5PCFwcm90by5wYi5BbmNob3JQcm9maWxlPn0gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5BbmNob3JGdWxsUmVwbHl9IHJldHVybnMgdGhpcwoqLwoKCnByb3RvLnBiLmNtcy5BbmNob3JGdWxsUmVwbHkucHJvdG90eXBlLnNldFByb2ZpbGVzTGlzdCA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UmVwZWF0ZWRXcmFwcGVyRmllbGQodGhpcywgMiwgdmFsdWUpOwp9OwovKioKICogQHBhcmFtIHshcHJvdG8ucGIuQW5jaG9yUHJvZmlsZT19IG9wdF92YWx1ZQogKiBAcGFyYW0ge251bWJlcj19IG9wdF9pbmRleAogKiBAcmV0dXJuIHshcHJvdG8ucGIuQW5jaG9yUHJvZmlsZX0KICovCgoKcHJvdG8ucGIuY21zLkFuY2hvckZ1bGxSZXBseS5wcm90b3R5cGUuYWRkUHJvZmlsZXMgPSBmdW5jdGlvbiAob3B0X3ZhbHVlLCBvcHRfaW5kZXgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmFkZFRvUmVwZWF0ZWRXcmFwcGVyRmllbGQodGhpcywgMiwgb3B0X3ZhbHVlLCBwcm90by5wYi5BbmNob3JQcm9maWxlLCBvcHRfaW5kZXgpOwp9OwovKioKICogQ2xlYXJzIHRoZSBsaXN0IG1ha2luZyBpdCBlbXB0eSBidXQgbm9uLW51bGwuCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuQW5jaG9yRnVsbFJlcGx5fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLkFuY2hvckZ1bGxSZXBseS5wcm90b3R5cGUuY2xlYXJQcm9maWxlc0xpc3QgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIHRoaXMuc2V0UHJvZmlsZXNMaXN0KFtdKTsKfTsKCmlmIChqc3BiLk1lc3NhZ2UuR0VORVJBVEVfVE9fT0JKRUNUKSB7CiAgLyoqCiAgICogQ3JlYXRlcyBhbiBvYmplY3QgcmVwcmVzZW50YXRpb24gb2YgdGhpcyBwcm90by4KICAgKiBGaWVsZCBuYW1lcyB0aGF0IGFyZSByZXNlcnZlZCBpbiBKYXZhU2NyaXB0IGFuZCB3aWxsIGJlIHJlbmFtZWQgdG8gcGJfbmFtZS4KICAgKiBPcHRpb25hbCBmaWVsZHMgdGhhdCBhcmUgbm90IHNldCB3aWxsIGJlIHNldCB0byB1bmRlZmluZWQuCiAgICogVG8gYWNjZXNzIGEgcmVzZXJ2ZWQgZmllbGQgdXNlLCBmb28ucGJfPG5hbWU+LCBlZywgZm9vLnBiX2RlZmF1bHQuCiAgICogRm9yIHRoZSBsaXN0IG9mIHJlc2VydmVkIG5hbWVzIHBsZWFzZSBzZWU6CiAgICogICAgIG5ldC9wcm90bzIvY29tcGlsZXIvanMvaW50ZXJuYWwvZ2VuZXJhdG9yLmNjI2tLZXl3b3JkLgogICAqIEBwYXJhbSB7Ym9vbGVhbj19IG9wdF9pbmNsdWRlSW5zdGFuY2UgRGVwcmVjYXRlZC4gd2hldGhlciB0byBpbmNsdWRlIHRoZQogICAqICAgICBKU1BCIGluc3RhbmNlIGZvciB0cmFuc2l0aW9uYWwgc295IHByb3RvIHN1cHBvcnQ6CiAgICogICAgIGh0dHA6Ly9nb3RvL3NveS1wYXJhbS1taWdyYXRpb24KICAgKiBAcmV0dXJuIHshT2JqZWN0fQogICAqLwogIHByb3RvLnBiLmNtcy5Qcm9maWxlTGlzdFJlcXVlc3QucHJvdG90eXBlLnRvT2JqZWN0ID0gZnVuY3Rpb24gKG9wdF9pbmNsdWRlSW5zdGFuY2UpIHsKICAgIHJldHVybiBwcm90by5wYi5jbXMuUHJvZmlsZUxpc3RSZXF1ZXN0LnRvT2JqZWN0KG9wdF9pbmNsdWRlSW5zdGFuY2UsIHRoaXMpOwogIH07CiAgLyoqCiAgICogU3RhdGljIHZlcnNpb24gb2YgdGhlIHtAc2VlIHRvT2JqZWN0fSBtZXRob2QuCiAgICogQHBhcmFtIHtib29sZWFufHVuZGVmaW5lZH0gaW5jbHVkZUluc3RhbmNlIERlcHJlY2F0ZWQuIFdoZXRoZXIgdG8gaW5jbHVkZQogICAqICAgICB0aGUgSlNQQiBpbnN0YW5jZSBmb3IgdHJhbnNpdGlvbmFsIHNveSBwcm90byBzdXBwb3J0OgogICAqICAgICBodHRwOi8vZ290by9zb3ktcGFyYW0tbWlncmF0aW9uCiAgICogQHBhcmFtIHshcHJvdG8ucGIuY21zLlByb2ZpbGVMaXN0UmVxdWVzdH0gbXNnIFRoZSBtc2cgaW5zdGFuY2UgdG8gdHJhbnNmb3JtLgogICAqIEByZXR1cm4geyFPYmplY3R9CiAgICogQHN1cHByZXNzIHt1bnVzZWRMb2NhbFZhcmlhYmxlc30gZiBpcyBvbmx5IHVzZWQgZm9yIG5lc3RlZCBtZXNzYWdlcwogICAqLwoKCiAgcHJvdG8ucGIuY21zLlByb2ZpbGVMaXN0UmVxdWVzdC50b09iamVjdCA9IGZ1bmN0aW9uIChpbmNsdWRlSW5zdGFuY2UsIG1zZykgewogICAgdmFyIGYsCiAgICAgICAgb2JqID0gewogICAgICBwYWdlTm86IGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KG1zZywgMSwgMCksCiAgICAgIHBhZ2VTaXplOiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdChtc2csIDIsIDApLAogICAgICBhbmNob3JJZDoganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQobXNnLCAzLCAwKSwKICAgICAgYXJlYUlkOiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdChtc2csIDQsIDApLAogICAgICBzdGF0dXM6IGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KG1zZywgNSwgMCkKICAgIH07CgogICAgaWYgKGluY2x1ZGVJbnN0YW5jZSkgewogICAgICBvYmouJGpzcGJNZXNzYWdlSW5zdGFuY2UgPSBtc2c7CiAgICB9CgogICAgcmV0dXJuIG9iajsKICB9Owp9Ci8qKgogKiBEZXNlcmlhbGl6ZXMgYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUgZm9ybWF0KS4KICogQHBhcmFtIHtqc3BiLkJ5dGVTb3VyY2V9IGJ5dGVzIFRoZSBieXRlcyB0byBkZXNlcmlhbGl6ZS4KICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5Qcm9maWxlTGlzdFJlcXVlc3R9CiAqLwoKCnByb3RvLnBiLmNtcy5Qcm9maWxlTGlzdFJlcXVlc3QuZGVzZXJpYWxpemVCaW5hcnkgPSBmdW5jdGlvbiAoYnl0ZXMpIHsKICB2YXIgcmVhZGVyID0gbmV3IGpzcGIuQmluYXJ5UmVhZGVyKGJ5dGVzKTsKICB2YXIgbXNnID0gbmV3IHByb3RvLnBiLmNtcy5Qcm9maWxlTGlzdFJlcXVlc3QoKTsKICByZXR1cm4gcHJvdG8ucGIuY21zLlByb2ZpbGVMaXN0UmVxdWVzdC5kZXNlcmlhbGl6ZUJpbmFyeUZyb21SZWFkZXIobXNnLCByZWFkZXIpOwp9OwovKioKICogRGVzZXJpYWxpemVzIGJpbmFyeSBkYXRhIChpbiBwcm90b2J1ZiB3aXJlIGZvcm1hdCkgZnJvbSB0aGUKICogZ2l2ZW4gcmVhZGVyIGludG8gdGhlIGdpdmVuIG1lc3NhZ2Ugb2JqZWN0LgogKiBAcGFyYW0geyFwcm90by5wYi5jbXMuUHJvZmlsZUxpc3RSZXF1ZXN0fSBtc2cgVGhlIG1lc3NhZ2Ugb2JqZWN0IHRvIGRlc2VyaWFsaXplIGludG8uCiAqIEBwYXJhbSB7IWpzcGIuQmluYXJ5UmVhZGVyfSByZWFkZXIgVGhlIEJpbmFyeVJlYWRlciB0byB1c2UuCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuUHJvZmlsZUxpc3RSZXF1ZXN0fQogKi8KCgpwcm90by5wYi5jbXMuUHJvZmlsZUxpc3RSZXF1ZXN0LmRlc2VyaWFsaXplQmluYXJ5RnJvbVJlYWRlciA9IGZ1bmN0aW9uIChtc2csIHJlYWRlcikgewogIHdoaWxlIChyZWFkZXIubmV4dEZpZWxkKCkpIHsKICAgIGlmIChyZWFkZXIuaXNFbmRHcm91cCgpKSB7CiAgICAgIGJyZWFrOwogICAgfQoKICAgIHZhciBmaWVsZCA9IHJlYWRlci5nZXRGaWVsZE51bWJlcigpOwoKICAgIHN3aXRjaCAoZmllbGQpIHsKICAgICAgY2FzZSAxOgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkVWludDMyKCk7CiAgICAgICAgbXNnLnNldFBhZ2VObyh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlIDI6CiAgICAgICAgdmFyIHZhbHVlID0gcmVhZGVyLnJlYWRVaW50MzIoKTsKICAgICAgICBtc2cuc2V0UGFnZVNpemUodmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSAzOgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkVWludDMyKCk7CiAgICAgICAgbXNnLnNldEFuY2hvcklkKHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgNDoKICAgICAgICB2YXIgdmFsdWUgPSByZWFkZXIucmVhZFVpbnQzMigpOwogICAgICAgIG1zZy5zZXRBcmVhSWQodmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSA1OgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkRW51bSgpOwogICAgICAgIG1zZy5zZXRTdGF0dXModmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgZGVmYXVsdDoKICAgICAgICByZWFkZXIuc2tpcEZpZWxkKCk7CiAgICAgICAgYnJlYWs7CiAgICB9CiAgfQoKICByZXR1cm4gbXNnOwp9OwovKioKICogU2VyaWFsaXplcyB0aGUgbWVzc2FnZSB0byBiaW5hcnkgZGF0YSAoaW4gcHJvdG9idWYgd2lyZSBmb3JtYXQpLgogKiBAcmV0dXJuIHshVWludDhBcnJheX0KICovCgoKcHJvdG8ucGIuY21zLlByb2ZpbGVMaXN0UmVxdWVzdC5wcm90b3R5cGUuc2VyaWFsaXplQmluYXJ5ID0gZnVuY3Rpb24gKCkgewogIHZhciB3cml0ZXIgPSBuZXcganNwYi5CaW5hcnlXcml0ZXIoKTsKICBwcm90by5wYi5jbXMuUHJvZmlsZUxpc3RSZXF1ZXN0LnNlcmlhbGl6ZUJpbmFyeVRvV3JpdGVyKHRoaXMsIHdyaXRlcik7CiAgcmV0dXJuIHdyaXRlci5nZXRSZXN1bHRCdWZmZXIoKTsKfTsKLyoqCiAqIFNlcmlhbGl6ZXMgdGhlIGdpdmVuIG1lc3NhZ2UgdG8gYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUKICogZm9ybWF0KSwgd3JpdGluZyB0byB0aGUgZ2l2ZW4gQmluYXJ5V3JpdGVyLgogKiBAcGFyYW0geyFwcm90by5wYi5jbXMuUHJvZmlsZUxpc3RSZXF1ZXN0fSBtZXNzYWdlCiAqIEBwYXJhbSB7IWpzcGIuQmluYXJ5V3JpdGVyfSB3cml0ZXIKICogQHN1cHByZXNzIHt1bnVzZWRMb2NhbFZhcmlhYmxlc30gZiBpcyBvbmx5IHVzZWQgZm9yIG5lc3RlZCBtZXNzYWdlcwogKi8KCgpwcm90by5wYi5jbXMuUHJvZmlsZUxpc3RSZXF1ZXN0LnNlcmlhbGl6ZUJpbmFyeVRvV3JpdGVyID0gZnVuY3Rpb24gKG1lc3NhZ2UsIHdyaXRlcikgewogIHZhciBmID0gdW5kZWZpbmVkOwogIGYgPSBtZXNzYWdlLmdldFBhZ2VObygpOwoKICBpZiAoZiAhPT0gMCkgewogICAgd3JpdGVyLndyaXRlVWludDMyKDEsIGYpOwogIH0KCiAgZiA9IG1lc3NhZ2UuZ2V0UGFnZVNpemUoKTsKCiAgaWYgKGYgIT09IDApIHsKICAgIHdyaXRlci53cml0ZVVpbnQzMigyLCBmKTsKICB9CgogIGYgPSBtZXNzYWdlLmdldEFuY2hvcklkKCk7CgogIGlmIChmICE9PSAwKSB7CiAgICB3cml0ZXIud3JpdGVVaW50MzIoMywgZik7CiAgfQoKICBmID0gbWVzc2FnZS5nZXRBcmVhSWQoKTsKCiAgaWYgKGYgIT09IDApIHsKICAgIHdyaXRlci53cml0ZVVpbnQzMig0LCBmKTsKICB9CgogIGYgPSBtZXNzYWdlLmdldFN0YXR1cygpOwoKICBpZiAoZiAhPT0gMC4wKSB7CiAgICB3cml0ZXIud3JpdGVFbnVtKDUsIGYpOwogIH0KfTsKLyoqCiAqIG9wdGlvbmFsIHVpbnQzMiBwYWdlX25vID0gMTsKICogQHJldHVybiB7bnVtYmVyfQogKi8KCgpwcm90by5wYi5jbXMuUHJvZmlsZUxpc3RSZXF1ZXN0LnByb3RvdHlwZS5nZXRQYWdlTm8gPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDEsIDApOwp9OwovKioKICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuUHJvZmlsZUxpc3RSZXF1ZXN0fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLlByb2ZpbGVMaXN0UmVxdWVzdC5wcm90b3R5cGUuc2V0UGFnZU5vID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRQcm90bzNJbnRGaWVsZCh0aGlzLCAxLCB2YWx1ZSk7Cn07Ci8qKgogKiBvcHRpb25hbCB1aW50MzIgcGFnZV9zaXplID0gMjsKICogQHJldHVybiB7bnVtYmVyfQogKi8KCgpwcm90by5wYi5jbXMuUHJvZmlsZUxpc3RSZXF1ZXN0LnByb3RvdHlwZS5nZXRQYWdlU2l6ZSA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQodGhpcywgMiwgMCk7Cn07Ci8qKgogKiBAcGFyYW0ge251bWJlcn0gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5Qcm9maWxlTGlzdFJlcXVlc3R9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuUHJvZmlsZUxpc3RSZXF1ZXN0LnByb3RvdHlwZS5zZXRQYWdlU2l6ZSA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UHJvdG8zSW50RmllbGQodGhpcywgMiwgdmFsdWUpOwp9OwovKioKICogb3B0aW9uYWwgdWludDMyIGFuY2hvcl9pZCA9IDM7CiAqIEByZXR1cm4ge251bWJlcn0KICovCgoKcHJvdG8ucGIuY21zLlByb2ZpbGVMaXN0UmVxdWVzdC5wcm90b3R5cGUuZ2V0QW5jaG9ySWQgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDMsIDApOwp9OwovKioKICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuUHJvZmlsZUxpc3RSZXF1ZXN0fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLlByb2ZpbGVMaXN0UmVxdWVzdC5wcm90b3R5cGUuc2V0QW5jaG9ySWQgPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0ludEZpZWxkKHRoaXMsIDMsIHZhbHVlKTsKfTsKLyoqCiAqIG9wdGlvbmFsIHVpbnQzMiBhcmVhX2lkID0gNDsKICogQHJldHVybiB7bnVtYmVyfQogKi8KCgpwcm90by5wYi5jbXMuUHJvZmlsZUxpc3RSZXF1ZXN0LnByb3RvdHlwZS5nZXRBcmVhSWQgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDQsIDApOwp9OwovKioKICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuUHJvZmlsZUxpc3RSZXF1ZXN0fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLlByb2ZpbGVMaXN0UmVxdWVzdC5wcm90b3R5cGUuc2V0QXJlYUlkID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRQcm90bzNJbnRGaWVsZCh0aGlzLCA0LCB2YWx1ZSk7Cn07Ci8qKgogKiBvcHRpb25hbCBwYi5SZXZpZXdTdGF0dXMgc3RhdHVzID0gNTsKICogQHJldHVybiB7IXByb3RvLnBiLlJldmlld1N0YXR1c30KICovCgoKcHJvdG8ucGIuY21zLlByb2ZpbGVMaXN0UmVxdWVzdC5wcm90b3R5cGUuZ2V0U3RhdHVzID0gZnVuY3Rpb24gKCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdCh0aGlzLCA1LCAwKTsKfTsKLyoqCiAqIEBwYXJhbSB7IXByb3RvLnBiLlJldmlld1N0YXR1c30gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5Qcm9maWxlTGlzdFJlcXVlc3R9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuUHJvZmlsZUxpc3RSZXF1ZXN0LnByb3RvdHlwZS5zZXRTdGF0dXMgPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0VudW1GaWVsZCh0aGlzLCA1LCB2YWx1ZSk7Cn07Ci8qKgogKiBMaXN0IG9mIHJlcGVhdGVkIGZpZWxkcyB3aXRoaW4gdGhpcyBtZXNzYWdlIHR5cGUuCiAqIEBwcml2YXRlIHshQXJyYXk8bnVtYmVyPn0KICogQGNvbnN0CiAqLwoKCnByb3RvLnBiLmNtcy5Qcm9maWxlTGlzdFJlcGx5LnJlcGVhdGVkRmllbGRzXyA9IFsxXTsKCmlmIChqc3BiLk1lc3NhZ2UuR0VORVJBVEVfVE9fT0JKRUNUKSB7CiAgLyoqCiAgICogQ3JlYXRlcyBhbiBvYmplY3QgcmVwcmVzZW50YXRpb24gb2YgdGhpcyBwcm90by4KICAgKiBGaWVsZCBuYW1lcyB0aGF0IGFyZSByZXNlcnZlZCBpbiBKYXZhU2NyaXB0IGFuZCB3aWxsIGJlIHJlbmFtZWQgdG8gcGJfbmFtZS4KICAgKiBPcHRpb25hbCBmaWVsZHMgdGhhdCBhcmUgbm90IHNldCB3aWxsIGJlIHNldCB0byB1bmRlZmluZWQuCiAgICogVG8gYWNjZXNzIGEgcmVzZXJ2ZWQgZmllbGQgdXNlLCBmb28ucGJfPG5hbWU+LCBlZywgZm9vLnBiX2RlZmF1bHQuCiAgICogRm9yIHRoZSBsaXN0IG9mIHJlc2VydmVkIG5hbWVzIHBsZWFzZSBzZWU6CiAgICogICAgIG5ldC9wcm90bzIvY29tcGlsZXIvanMvaW50ZXJuYWwvZ2VuZXJhdG9yLmNjI2tLZXl3b3JkLgogICAqIEBwYXJhbSB7Ym9vbGVhbj19IG9wdF9pbmNsdWRlSW5zdGFuY2UgRGVwcmVjYXRlZC4gd2hldGhlciB0byBpbmNsdWRlIHRoZQogICAqICAgICBKU1BCIGluc3RhbmNlIGZvciB0cmFuc2l0aW9uYWwgc295IHByb3RvIHN1cHBvcnQ6CiAgICogICAgIGh0dHA6Ly9nb3RvL3NveS1wYXJhbS1taWdyYXRpb24KICAgKiBAcmV0dXJuIHshT2JqZWN0fQogICAqLwogIHByb3RvLnBiLmNtcy5Qcm9maWxlTGlzdFJlcGx5LnByb3RvdHlwZS50b09iamVjdCA9IGZ1bmN0aW9uIChvcHRfaW5jbHVkZUluc3RhbmNlKSB7CiAgICByZXR1cm4gcHJvdG8ucGIuY21zLlByb2ZpbGVMaXN0UmVwbHkudG9PYmplY3Qob3B0X2luY2x1ZGVJbnN0YW5jZSwgdGhpcyk7CiAgfTsKICAvKioKICAgKiBTdGF0aWMgdmVyc2lvbiBvZiB0aGUge0BzZWUgdG9PYmplY3R9IG1ldGhvZC4KICAgKiBAcGFyYW0ge2Jvb2xlYW58dW5kZWZpbmVkfSBpbmNsdWRlSW5zdGFuY2UgRGVwcmVjYXRlZC4gV2hldGhlciB0byBpbmNsdWRlCiAgICogICAgIHRoZSBKU1BCIGluc3RhbmNlIGZvciB0cmFuc2l0aW9uYWwgc295IHByb3RvIHN1cHBvcnQ6CiAgICogICAgIGh0dHA6Ly9nb3RvL3NveS1wYXJhbS1taWdyYXRpb24KICAgKiBAcGFyYW0geyFwcm90by5wYi5jbXMuUHJvZmlsZUxpc3RSZXBseX0gbXNnIFRoZSBtc2cgaW5zdGFuY2UgdG8gdHJhbnNmb3JtLgogICAqIEByZXR1cm4geyFPYmplY3R9CiAgICogQHN1cHByZXNzIHt1bnVzZWRMb2NhbFZhcmlhYmxlc30gZiBpcyBvbmx5IHVzZWQgZm9yIG5lc3RlZCBtZXNzYWdlcwogICAqLwoKCiAgcHJvdG8ucGIuY21zLlByb2ZpbGVMaXN0UmVwbHkudG9PYmplY3QgPSBmdW5jdGlvbiAoaW5jbHVkZUluc3RhbmNlLCBtc2cpIHsKICAgIHZhciBmLAogICAgICAgIG9iaiA9IHsKICAgICAgcHJvZmlsZXNMaXN0OiBqc3BiLk1lc3NhZ2UudG9PYmplY3RMaXN0KG1zZy5nZXRQcm9maWxlc0xpc3QoKSwgYW5jaG9ydHlwZV9wYi5BbmNob3JQcm9maWxlLnRvT2JqZWN0LCBpbmNsdWRlSW5zdGFuY2UpLAogICAgICBwYWdlTm86IGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KG1zZywgMiwgMCksCiAgICAgIHBhZ2VTaXplOiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdChtc2csIDMsIDApLAogICAgICB0b3RhbFBhZ2U6IGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KG1zZywgNCwgMCksCiAgICAgIHRvdGFsQ291bnQ6IGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KG1zZywgNSwgMCkKICAgIH07CgogICAgaWYgKGluY2x1ZGVJbnN0YW5jZSkgewogICAgICBvYmouJGpzcGJNZXNzYWdlSW5zdGFuY2UgPSBtc2c7CiAgICB9CgogICAgcmV0dXJuIG9iajsKICB9Owp9Ci8qKgogKiBEZXNlcmlhbGl6ZXMgYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUgZm9ybWF0KS4KICogQHBhcmFtIHtqc3BiLkJ5dGVTb3VyY2V9IGJ5dGVzIFRoZSBieXRlcyB0byBkZXNlcmlhbGl6ZS4KICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5Qcm9maWxlTGlzdFJlcGx5fQogKi8KCgpwcm90by5wYi5jbXMuUHJvZmlsZUxpc3RSZXBseS5kZXNlcmlhbGl6ZUJpbmFyeSA9IGZ1bmN0aW9uIChieXRlcykgewogIHZhciByZWFkZXIgPSBuZXcganNwYi5CaW5hcnlSZWFkZXIoYnl0ZXMpOwogIHZhciBtc2cgPSBuZXcgcHJvdG8ucGIuY21zLlByb2ZpbGVMaXN0UmVwbHkoKTsKICByZXR1cm4gcHJvdG8ucGIuY21zLlByb2ZpbGVMaXN0UmVwbHkuZGVzZXJpYWxpemVCaW5hcnlGcm9tUmVhZGVyKG1zZywgcmVhZGVyKTsKfTsKLyoqCiAqIERlc2VyaWFsaXplcyBiaW5hcnkgZGF0YSAoaW4gcHJvdG9idWYgd2lyZSBmb3JtYXQpIGZyb20gdGhlCiAqIGdpdmVuIHJlYWRlciBpbnRvIHRoZSBnaXZlbiBtZXNzYWdlIG9iamVjdC4KICogQHBhcmFtIHshcHJvdG8ucGIuY21zLlByb2ZpbGVMaXN0UmVwbHl9IG1zZyBUaGUgbWVzc2FnZSBvYmplY3QgdG8gZGVzZXJpYWxpemUgaW50by4KICogQHBhcmFtIHshanNwYi5CaW5hcnlSZWFkZXJ9IHJlYWRlciBUaGUgQmluYXJ5UmVhZGVyIHRvIHVzZS4KICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5Qcm9maWxlTGlzdFJlcGx5fQogKi8KCgpwcm90by5wYi5jbXMuUHJvZmlsZUxpc3RSZXBseS5kZXNlcmlhbGl6ZUJpbmFyeUZyb21SZWFkZXIgPSBmdW5jdGlvbiAobXNnLCByZWFkZXIpIHsKICB3aGlsZSAocmVhZGVyLm5leHRGaWVsZCgpKSB7CiAgICBpZiAocmVhZGVyLmlzRW5kR3JvdXAoKSkgewogICAgICBicmVhazsKICAgIH0KCiAgICB2YXIgZmllbGQgPSByZWFkZXIuZ2V0RmllbGROdW1iZXIoKTsKCiAgICBzd2l0Y2ggKGZpZWxkKSB7CiAgICAgIGNhc2UgMToKICAgICAgICB2YXIgdmFsdWUgPSBuZXcgYW5jaG9ydHlwZV9wYi5BbmNob3JQcm9maWxlKCk7CiAgICAgICAgcmVhZGVyLnJlYWRNZXNzYWdlKHZhbHVlLCBhbmNob3J0eXBlX3BiLkFuY2hvclByb2ZpbGUuZGVzZXJpYWxpemVCaW5hcnlGcm9tUmVhZGVyKTsKICAgICAgICBtc2cuYWRkUHJvZmlsZXModmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSAyOgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkVWludDMyKCk7CiAgICAgICAgbXNnLnNldFBhZ2VObyh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlIDM6CiAgICAgICAgdmFyIHZhbHVlID0gcmVhZGVyLnJlYWRVaW50MzIoKTsKICAgICAgICBtc2cuc2V0UGFnZVNpemUodmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSA0OgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkVWludDMyKCk7CiAgICAgICAgbXNnLnNldFRvdGFsUGFnZSh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlIDU6CiAgICAgICAgdmFyIHZhbHVlID0gcmVhZGVyLnJlYWRVaW50MzIoKTsKICAgICAgICBtc2cuc2V0VG90YWxDb3VudCh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBkZWZhdWx0OgogICAgICAgIHJlYWRlci5za2lwRmllbGQoKTsKICAgICAgICBicmVhazsKICAgIH0KICB9CgogIHJldHVybiBtc2c7Cn07Ci8qKgogKiBTZXJpYWxpemVzIHRoZSBtZXNzYWdlIHRvIGJpbmFyeSBkYXRhIChpbiBwcm90b2J1ZiB3aXJlIGZvcm1hdCkuCiAqIEByZXR1cm4geyFVaW50OEFycmF5fQogKi8KCgpwcm90by5wYi5jbXMuUHJvZmlsZUxpc3RSZXBseS5wcm90b3R5cGUuc2VyaWFsaXplQmluYXJ5ID0gZnVuY3Rpb24gKCkgewogIHZhciB3cml0ZXIgPSBuZXcganNwYi5CaW5hcnlXcml0ZXIoKTsKICBwcm90by5wYi5jbXMuUHJvZmlsZUxpc3RSZXBseS5zZXJpYWxpemVCaW5hcnlUb1dyaXRlcih0aGlzLCB3cml0ZXIpOwogIHJldHVybiB3cml0ZXIuZ2V0UmVzdWx0QnVmZmVyKCk7Cn07Ci8qKgogKiBTZXJpYWxpemVzIHRoZSBnaXZlbiBtZXNzYWdlIHRvIGJpbmFyeSBkYXRhIChpbiBwcm90b2J1ZiB3aXJlCiAqIGZvcm1hdCksIHdyaXRpbmcgdG8gdGhlIGdpdmVuIEJpbmFyeVdyaXRlci4KICogQHBhcmFtIHshcHJvdG8ucGIuY21zLlByb2ZpbGVMaXN0UmVwbHl9IG1lc3NhZ2UKICogQHBhcmFtIHshanNwYi5CaW5hcnlXcml0ZXJ9IHdyaXRlcgogKiBAc3VwcHJlc3Mge3VudXNlZExvY2FsVmFyaWFibGVzfSBmIGlzIG9ubHkgdXNlZCBmb3IgbmVzdGVkIG1lc3NhZ2VzCiAqLwoKCnByb3RvLnBiLmNtcy5Qcm9maWxlTGlzdFJlcGx5LnNlcmlhbGl6ZUJpbmFyeVRvV3JpdGVyID0gZnVuY3Rpb24gKG1lc3NhZ2UsIHdyaXRlcikgewogIHZhciBmID0gdW5kZWZpbmVkOwogIGYgPSBtZXNzYWdlLmdldFByb2ZpbGVzTGlzdCgpOwoKICBpZiAoZi5sZW5ndGggPiAwKSB7CiAgICB3cml0ZXIud3JpdGVSZXBlYXRlZE1lc3NhZ2UoMSwgZiwgYW5jaG9ydHlwZV9wYi5BbmNob3JQcm9maWxlLnNlcmlhbGl6ZUJpbmFyeVRvV3JpdGVyKTsKICB9CgogIGYgPSBtZXNzYWdlLmdldFBhZ2VObygpOwoKICBpZiAoZiAhPT0gMCkgewogICAgd3JpdGVyLndyaXRlVWludDMyKDIsIGYpOwogIH0KCiAgZiA9IG1lc3NhZ2UuZ2V0UGFnZVNpemUoKTsKCiAgaWYgKGYgIT09IDApIHsKICAgIHdyaXRlci53cml0ZVVpbnQzMigzLCBmKTsKICB9CgogIGYgPSBtZXNzYWdlLmdldFRvdGFsUGFnZSgpOwoKICBpZiAoZiAhPT0gMCkgewogICAgd3JpdGVyLndyaXRlVWludDMyKDQsIGYpOwogIH0KCiAgZiA9IG1lc3NhZ2UuZ2V0VG90YWxDb3VudCgpOwoKICBpZiAoZiAhPT0gMCkgewogICAgd3JpdGVyLndyaXRlVWludDMyKDUsIGYpOwogIH0KfTsKLyoqCiAqIHJlcGVhdGVkIHBiLkFuY2hvclByb2ZpbGUgcHJvZmlsZXMgPSAxOwogKiBAcmV0dXJuIHshQXJyYXk8IXByb3RvLnBiLkFuY2hvclByb2ZpbGU+fQogKi8KCgpwcm90by5wYi5jbXMuUHJvZmlsZUxpc3RSZXBseS5wcm90b3R5cGUuZ2V0UHJvZmlsZXNMaXN0ID0gZnVuY3Rpb24gKCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuZ2V0UmVwZWF0ZWRXcmFwcGVyRmllbGQodGhpcywgYW5jaG9ydHlwZV9wYi5BbmNob3JQcm9maWxlLCAxKTsKfTsKLyoqCiAqIEBwYXJhbSB7IUFycmF5PCFwcm90by5wYi5BbmNob3JQcm9maWxlPn0gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5Qcm9maWxlTGlzdFJlcGx5fSByZXR1cm5zIHRoaXMKKi8KCgpwcm90by5wYi5jbXMuUHJvZmlsZUxpc3RSZXBseS5wcm90b3R5cGUuc2V0UHJvZmlsZXNMaXN0ID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRSZXBlYXRlZFdyYXBwZXJGaWVsZCh0aGlzLCAxLCB2YWx1ZSk7Cn07Ci8qKgogKiBAcGFyYW0geyFwcm90by5wYi5BbmNob3JQcm9maWxlPX0gb3B0X3ZhbHVlCiAqIEBwYXJhbSB7bnVtYmVyPX0gb3B0X2luZGV4CiAqIEByZXR1cm4geyFwcm90by5wYi5BbmNob3JQcm9maWxlfQogKi8KCgpwcm90by5wYi5jbXMuUHJvZmlsZUxpc3RSZXBseS5wcm90b3R5cGUuYWRkUHJvZmlsZXMgPSBmdW5jdGlvbiAob3B0X3ZhbHVlLCBvcHRfaW5kZXgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmFkZFRvUmVwZWF0ZWRXcmFwcGVyRmllbGQodGhpcywgMSwgb3B0X3ZhbHVlLCBwcm90by5wYi5BbmNob3JQcm9maWxlLCBvcHRfaW5kZXgpOwp9OwovKioKICogQ2xlYXJzIHRoZSBsaXN0IG1ha2luZyBpdCBlbXB0eSBidXQgbm9uLW51bGwuCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuUHJvZmlsZUxpc3RSZXBseX0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5Qcm9maWxlTGlzdFJlcGx5LnByb3RvdHlwZS5jbGVhclByb2ZpbGVzTGlzdCA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4gdGhpcy5zZXRQcm9maWxlc0xpc3QoW10pOwp9OwovKioKICogb3B0aW9uYWwgdWludDMyIHBhZ2Vfbm8gPSAyOwogKiBAcmV0dXJuIHtudW1iZXJ9CiAqLwoKCnByb3RvLnBiLmNtcy5Qcm9maWxlTGlzdFJlcGx5LnByb3RvdHlwZS5nZXRQYWdlTm8gPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDIsIDApOwp9OwovKioKICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuUHJvZmlsZUxpc3RSZXBseX0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5Qcm9maWxlTGlzdFJlcGx5LnByb3RvdHlwZS5zZXRQYWdlTm8gPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0ludEZpZWxkKHRoaXMsIDIsIHZhbHVlKTsKfTsKLyoqCiAqIG9wdGlvbmFsIHVpbnQzMiBwYWdlX3NpemUgPSAzOwogKiBAcmV0dXJuIHtudW1iZXJ9CiAqLwoKCnByb3RvLnBiLmNtcy5Qcm9maWxlTGlzdFJlcGx5LnByb3RvdHlwZS5nZXRQYWdlU2l6ZSA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQodGhpcywgMywgMCk7Cn07Ci8qKgogKiBAcGFyYW0ge251bWJlcn0gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5Qcm9maWxlTGlzdFJlcGx5fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLlByb2ZpbGVMaXN0UmVwbHkucHJvdG90eXBlLnNldFBhZ2VTaXplID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRQcm90bzNJbnRGaWVsZCh0aGlzLCAzLCB2YWx1ZSk7Cn07Ci8qKgogKiBvcHRpb25hbCB1aW50MzIgdG90YWxfcGFnZSA9IDQ7CiAqIEByZXR1cm4ge251bWJlcn0KICovCgoKcHJvdG8ucGIuY21zLlByb2ZpbGVMaXN0UmVwbHkucHJvdG90eXBlLmdldFRvdGFsUGFnZSA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQodGhpcywgNCwgMCk7Cn07Ci8qKgogKiBAcGFyYW0ge251bWJlcn0gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5Qcm9maWxlTGlzdFJlcGx5fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLlByb2ZpbGVMaXN0UmVwbHkucHJvdG90eXBlLnNldFRvdGFsUGFnZSA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UHJvdG8zSW50RmllbGQodGhpcywgNCwgdmFsdWUpOwp9OwovKioKICogb3B0aW9uYWwgdWludDMyIHRvdGFsX2NvdW50ID0gNTsKICogQHJldHVybiB7bnVtYmVyfQogKi8KCgpwcm90by5wYi5jbXMuUHJvZmlsZUxpc3RSZXBseS5wcm90b3R5cGUuZ2V0VG90YWxDb3VudCA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQodGhpcywgNSwgMCk7Cn07Ci8qKgogKiBAcGFyYW0ge251bWJlcn0gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5Qcm9maWxlTGlzdFJlcGx5fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLlByb2ZpbGVMaXN0UmVwbHkucHJvdG90eXBlLnNldFRvdGFsQ291bnQgPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0ludEZpZWxkKHRoaXMsIDUsIHZhbHVlKTsKfTsKCmlmIChqc3BiLk1lc3NhZ2UuR0VORVJBVEVfVE9fT0JKRUNUKSB7CiAgLyoqCiAgICogQ3JlYXRlcyBhbiBvYmplY3QgcmVwcmVzZW50YXRpb24gb2YgdGhpcyBwcm90by4KICAgKiBGaWVsZCBuYW1lcyB0aGF0IGFyZSByZXNlcnZlZCBpbiBKYXZhU2NyaXB0IGFuZCB3aWxsIGJlIHJlbmFtZWQgdG8gcGJfbmFtZS4KICAgKiBPcHRpb25hbCBmaWVsZHMgdGhhdCBhcmUgbm90IHNldCB3aWxsIGJlIHNldCB0byB1bmRlZmluZWQuCiAgICogVG8gYWNjZXNzIGEgcmVzZXJ2ZWQgZmllbGQgdXNlLCBmb28ucGJfPG5hbWU+LCBlZywgZm9vLnBiX2RlZmF1bHQuCiAgICogRm9yIHRoZSBsaXN0IG9mIHJlc2VydmVkIG5hbWVzIHBsZWFzZSBzZWU6CiAgICogICAgIG5ldC9wcm90bzIvY29tcGlsZXIvanMvaW50ZXJuYWwvZ2VuZXJhdG9yLmNjI2tLZXl3b3JkLgogICAqIEBwYXJhbSB7Ym9vbGVhbj19IG9wdF9pbmNsdWRlSW5zdGFuY2UgRGVwcmVjYXRlZC4gd2hldGhlciB0byBpbmNsdWRlIHRoZQogICAqICAgICBKU1BCIGluc3RhbmNlIGZvciB0cmFuc2l0aW9uYWwgc295IHByb3RvIHN1cHBvcnQ6CiAgICogICAgIGh0dHA6Ly9nb3RvL3NveS1wYXJhbS1taWdyYXRpb24KICAgKiBAcmV0dXJuIHshT2JqZWN0fQogICAqLwogIHByb3RvLnBiLmNtcy5Qcm9jZXNzUHJvZmlsZVJlcXVlc3QucHJvdG90eXBlLnRvT2JqZWN0ID0gZnVuY3Rpb24gKG9wdF9pbmNsdWRlSW5zdGFuY2UpIHsKICAgIHJldHVybiBwcm90by5wYi5jbXMuUHJvY2Vzc1Byb2ZpbGVSZXF1ZXN0LnRvT2JqZWN0KG9wdF9pbmNsdWRlSW5zdGFuY2UsIHRoaXMpOwogIH07CiAgLyoqCiAgICogU3RhdGljIHZlcnNpb24gb2YgdGhlIHtAc2VlIHRvT2JqZWN0fSBtZXRob2QuCiAgICogQHBhcmFtIHtib29sZWFufHVuZGVmaW5lZH0gaW5jbHVkZUluc3RhbmNlIERlcHJlY2F0ZWQuIFdoZXRoZXIgdG8gaW5jbHVkZQogICAqICAgICB0aGUgSlNQQiBpbnN0YW5jZSBmb3IgdHJhbnNpdGlvbmFsIHNveSBwcm90byBzdXBwb3J0OgogICAqICAgICBodHRwOi8vZ290by9zb3ktcGFyYW0tbWlncmF0aW9uCiAgICogQHBhcmFtIHshcHJvdG8ucGIuY21zLlByb2Nlc3NQcm9maWxlUmVxdWVzdH0gbXNnIFRoZSBtc2cgaW5zdGFuY2UgdG8gdHJhbnNmb3JtLgogICAqIEByZXR1cm4geyFPYmplY3R9CiAgICogQHN1cHByZXNzIHt1bnVzZWRMb2NhbFZhcmlhYmxlc30gZiBpcyBvbmx5IHVzZWQgZm9yIG5lc3RlZCBtZXNzYWdlcwogICAqLwoKCiAgcHJvdG8ucGIuY21zLlByb2Nlc3NQcm9maWxlUmVxdWVzdC50b09iamVjdCA9IGZ1bmN0aW9uIChpbmNsdWRlSW5zdGFuY2UsIG1zZykgewogICAgdmFyIGYsCiAgICAgICAgb2JqID0gewogICAgICBwcm9maWxlSWQ6IGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KG1zZywgMSwgMCksCiAgICAgIHN0YXR1czoganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQobXNnLCAyLCAwKSwKICAgICAgcmVhc29uOiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdChtc2csIDMsICIiKQogICAgfTsKCiAgICBpZiAoaW5jbHVkZUluc3RhbmNlKSB7CiAgICAgIG9iai4kanNwYk1lc3NhZ2VJbnN0YW5jZSA9IG1zZzsKICAgIH0KCiAgICByZXR1cm4gb2JqOwogIH07Cn0KLyoqCiAqIERlc2VyaWFsaXplcyBiaW5hcnkgZGF0YSAoaW4gcHJvdG9idWYgd2lyZSBmb3JtYXQpLgogKiBAcGFyYW0ge2pzcGIuQnl0ZVNvdXJjZX0gYnl0ZXMgVGhlIGJ5dGVzIHRvIGRlc2VyaWFsaXplLgogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLlByb2Nlc3NQcm9maWxlUmVxdWVzdH0KICovCgoKcHJvdG8ucGIuY21zLlByb2Nlc3NQcm9maWxlUmVxdWVzdC5kZXNlcmlhbGl6ZUJpbmFyeSA9IGZ1bmN0aW9uIChieXRlcykgewogIHZhciByZWFkZXIgPSBuZXcganNwYi5CaW5hcnlSZWFkZXIoYnl0ZXMpOwogIHZhciBtc2cgPSBuZXcgcHJvdG8ucGIuY21zLlByb2Nlc3NQcm9maWxlUmVxdWVzdCgpOwogIHJldHVybiBwcm90by5wYi5jbXMuUHJvY2Vzc1Byb2ZpbGVSZXF1ZXN0LmRlc2VyaWFsaXplQmluYXJ5RnJvbVJlYWRlcihtc2csIHJlYWRlcik7Cn07Ci8qKgogKiBEZXNlcmlhbGl6ZXMgYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUgZm9ybWF0KSBmcm9tIHRoZQogKiBnaXZlbiByZWFkZXIgaW50byB0aGUgZ2l2ZW4gbWVzc2FnZSBvYmplY3QuCiAqIEBwYXJhbSB7IXByb3RvLnBiLmNtcy5Qcm9jZXNzUHJvZmlsZVJlcXVlc3R9IG1zZyBUaGUgbWVzc2FnZSBvYmplY3QgdG8gZGVzZXJpYWxpemUgaW50by4KICogQHBhcmFtIHshanNwYi5CaW5hcnlSZWFkZXJ9IHJlYWRlciBUaGUgQmluYXJ5UmVhZGVyIHRvIHVzZS4KICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5Qcm9jZXNzUHJvZmlsZVJlcXVlc3R9CiAqLwoKCnByb3RvLnBiLmNtcy5Qcm9jZXNzUHJvZmlsZVJlcXVlc3QuZGVzZXJpYWxpemVCaW5hcnlGcm9tUmVhZGVyID0gZnVuY3Rpb24gKG1zZywgcmVhZGVyKSB7CiAgd2hpbGUgKHJlYWRlci5uZXh0RmllbGQoKSkgewogICAgaWYgKHJlYWRlci5pc0VuZEdyb3VwKCkpIHsKICAgICAgYnJlYWs7CiAgICB9CgogICAgdmFyIGZpZWxkID0gcmVhZGVyLmdldEZpZWxkTnVtYmVyKCk7CgogICAgc3dpdGNoIChmaWVsZCkgewogICAgICBjYXNlIDE6CiAgICAgICAgdmFyIHZhbHVlID0gcmVhZGVyLnJlYWRVaW50MzIoKTsKICAgICAgICBtc2cuc2V0UHJvZmlsZUlkKHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgMjoKICAgICAgICB2YXIgdmFsdWUgPSByZWFkZXIucmVhZEVudW0oKTsKICAgICAgICBtc2cuc2V0U3RhdHVzKHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgMzoKICAgICAgICB2YXIgdmFsdWUgPSByZWFkZXIucmVhZFN0cmluZygpOwogICAgICAgIG1zZy5zZXRSZWFzb24odmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgZGVmYXVsdDoKICAgICAgICByZWFkZXIuc2tpcEZpZWxkKCk7CiAgICAgICAgYnJlYWs7CiAgICB9CiAgfQoKICByZXR1cm4gbXNnOwp9OwovKioKICogU2VyaWFsaXplcyB0aGUgbWVzc2FnZSB0byBiaW5hcnkgZGF0YSAoaW4gcHJvdG9idWYgd2lyZSBmb3JtYXQpLgogKiBAcmV0dXJuIHshVWludDhBcnJheX0KICovCgoKcHJvdG8ucGIuY21zLlByb2Nlc3NQcm9maWxlUmVxdWVzdC5wcm90b3R5cGUuc2VyaWFsaXplQmluYXJ5ID0gZnVuY3Rpb24gKCkgewogIHZhciB3cml0ZXIgPSBuZXcganNwYi5CaW5hcnlXcml0ZXIoKTsKICBwcm90by5wYi5jbXMuUHJvY2Vzc1Byb2ZpbGVSZXF1ZXN0LnNlcmlhbGl6ZUJpbmFyeVRvV3JpdGVyKHRoaXMsIHdyaXRlcik7CiAgcmV0dXJuIHdyaXRlci5nZXRSZXN1bHRCdWZmZXIoKTsKfTsKLyoqCiAqIFNlcmlhbGl6ZXMgdGhlIGdpdmVuIG1lc3NhZ2UgdG8gYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUKICogZm9ybWF0KSwgd3JpdGluZyB0byB0aGUgZ2l2ZW4gQmluYXJ5V3JpdGVyLgogKiBAcGFyYW0geyFwcm90by5wYi5jbXMuUHJvY2Vzc1Byb2ZpbGVSZXF1ZXN0fSBtZXNzYWdlCiAqIEBwYXJhbSB7IWpzcGIuQmluYXJ5V3JpdGVyfSB3cml0ZXIKICogQHN1cHByZXNzIHt1bnVzZWRMb2NhbFZhcmlhYmxlc30gZiBpcyBvbmx5IHVzZWQgZm9yIG5lc3RlZCBtZXNzYWdlcwogKi8KCgpwcm90by5wYi5jbXMuUHJvY2Vzc1Byb2ZpbGVSZXF1ZXN0LnNlcmlhbGl6ZUJpbmFyeVRvV3JpdGVyID0gZnVuY3Rpb24gKG1lc3NhZ2UsIHdyaXRlcikgewogIHZhciBmID0gdW5kZWZpbmVkOwogIGYgPSBtZXNzYWdlLmdldFByb2ZpbGVJZCgpOwoKICBpZiAoZiAhPT0gMCkgewogICAgd3JpdGVyLndyaXRlVWludDMyKDEsIGYpOwogIH0KCiAgZiA9IG1lc3NhZ2UuZ2V0U3RhdHVzKCk7CgogIGlmIChmICE9PSAwLjApIHsKICAgIHdyaXRlci53cml0ZUVudW0oMiwgZik7CiAgfQoKICBmID0gbWVzc2FnZS5nZXRSZWFzb24oKTsKCiAgaWYgKGYubGVuZ3RoID4gMCkgewogICAgd3JpdGVyLndyaXRlU3RyaW5nKDMsIGYpOwogIH0KfTsKLyoqCiAqIG9wdGlvbmFsIHVpbnQzMiBwcm9maWxlX2lkID0gMTsKICogQHJldHVybiB7bnVtYmVyfQogKi8KCgpwcm90by5wYi5jbXMuUHJvY2Vzc1Byb2ZpbGVSZXF1ZXN0LnByb3RvdHlwZS5nZXRQcm9maWxlSWQgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDEsIDApOwp9OwovKioKICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuUHJvY2Vzc1Byb2ZpbGVSZXF1ZXN0fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLlByb2Nlc3NQcm9maWxlUmVxdWVzdC5wcm90b3R5cGUuc2V0UHJvZmlsZUlkID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRQcm90bzNJbnRGaWVsZCh0aGlzLCAxLCB2YWx1ZSk7Cn07Ci8qKgogKiBvcHRpb25hbCBwYi5SZXZpZXdTdGF0dXMgc3RhdHVzID0gMjsKICogQHJldHVybiB7IXByb3RvLnBiLlJldmlld1N0YXR1c30KICovCgoKcHJvdG8ucGIuY21zLlByb2Nlc3NQcm9maWxlUmVxdWVzdC5wcm90b3R5cGUuZ2V0U3RhdHVzID0gZnVuY3Rpb24gKCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdCh0aGlzLCAyLCAwKTsKfTsKLyoqCiAqIEBwYXJhbSB7IXByb3RvLnBiLlJldmlld1N0YXR1c30gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5Qcm9jZXNzUHJvZmlsZVJlcXVlc3R9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuUHJvY2Vzc1Byb2ZpbGVSZXF1ZXN0LnByb3RvdHlwZS5zZXRTdGF0dXMgPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0VudW1GaWVsZCh0aGlzLCAyLCB2YWx1ZSk7Cn07Ci8qKgogKiBvcHRpb25hbCBzdHJpbmcgcmVhc29uID0gMzsKICogQHJldHVybiB7c3RyaW5nfQogKi8KCgpwcm90by5wYi5jbXMuUHJvY2Vzc1Byb2ZpbGVSZXF1ZXN0LnByb3RvdHlwZS5nZXRSZWFzb24gPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDMsICIiKTsKfTsKLyoqCiAqIEBwYXJhbSB7c3RyaW5nfSB2YWx1ZQogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLlByb2Nlc3NQcm9maWxlUmVxdWVzdH0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5Qcm9jZXNzUHJvZmlsZVJlcXVlc3QucHJvdG90eXBlLnNldFJlYXNvbiA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UHJvdG8zU3RyaW5nRmllbGQodGhpcywgMywgdmFsdWUpOwp9OwovKioKICogTGlzdCBvZiByZXBlYXRlZCBmaWVsZHMgd2l0aGluIHRoaXMgbWVzc2FnZSB0eXBlLgogKiBAcHJpdmF0ZSB7IUFycmF5PG51bWJlcj59CiAqIEBjb25zdAogKi8KCgpwcm90by5wYi5jbXMuVmlvbGF0aW9uTGlzdFJlcXVlc3QucmVwZWF0ZWRGaWVsZHNfID0gWzRdOwoKaWYgKGpzcGIuTWVzc2FnZS5HRU5FUkFURV9UT19PQkpFQ1QpIHsKICAvKioKICAgKiBDcmVhdGVzIGFuIG9iamVjdCByZXByZXNlbnRhdGlvbiBvZiB0aGlzIHByb3RvLgogICAqIEZpZWxkIG5hbWVzIHRoYXQgYXJlIHJlc2VydmVkIGluIEphdmFTY3JpcHQgYW5kIHdpbGwgYmUgcmVuYW1lZCB0byBwYl9uYW1lLgogICAqIE9wdGlvbmFsIGZpZWxkcyB0aGF0IGFyZSBub3Qgc2V0IHdpbGwgYmUgc2V0IHRvIHVuZGVmaW5lZC4KICAgKiBUbyBhY2Nlc3MgYSByZXNlcnZlZCBmaWVsZCB1c2UsIGZvby5wYl88bmFtZT4sIGVnLCBmb28ucGJfZGVmYXVsdC4KICAgKiBGb3IgdGhlIGxpc3Qgb2YgcmVzZXJ2ZWQgbmFtZXMgcGxlYXNlIHNlZToKICAgKiAgICAgbmV0L3Byb3RvMi9jb21waWxlci9qcy9pbnRlcm5hbC9nZW5lcmF0b3IuY2Mja0tleXdvcmQuCiAgICogQHBhcmFtIHtib29sZWFuPX0gb3B0X2luY2x1ZGVJbnN0YW5jZSBEZXByZWNhdGVkLiB3aGV0aGVyIHRvIGluY2x1ZGUgdGhlCiAgICogICAgIEpTUEIgaW5zdGFuY2UgZm9yIHRyYW5zaXRpb25hbCBzb3kgcHJvdG8gc3VwcG9ydDoKICAgKiAgICAgaHR0cDovL2dvdG8vc295LXBhcmFtLW1pZ3JhdGlvbgogICAqIEByZXR1cm4geyFPYmplY3R9CiAgICovCiAgcHJvdG8ucGIuY21zLlZpb2xhdGlvbkxpc3RSZXF1ZXN0LnByb3RvdHlwZS50b09iamVjdCA9IGZ1bmN0aW9uIChvcHRfaW5jbHVkZUluc3RhbmNlKSB7CiAgICByZXR1cm4gcHJvdG8ucGIuY21zLlZpb2xhdGlvbkxpc3RSZXF1ZXN0LnRvT2JqZWN0KG9wdF9pbmNsdWRlSW5zdGFuY2UsIHRoaXMpOwogIH07CiAgLyoqCiAgICogU3RhdGljIHZlcnNpb24gb2YgdGhlIHtAc2VlIHRvT2JqZWN0fSBtZXRob2QuCiAgICogQHBhcmFtIHtib29sZWFufHVuZGVmaW5lZH0gaW5jbHVkZUluc3RhbmNlIERlcHJlY2F0ZWQuIFdoZXRoZXIgdG8gaW5jbHVkZQogICAqICAgICB0aGUgSlNQQiBpbnN0YW5jZSBmb3IgdHJhbnNpdGlvbmFsIHNveSBwcm90byBzdXBwb3J0OgogICAqICAgICBodHRwOi8vZ290by9zb3ktcGFyYW0tbWlncmF0aW9uCiAgICogQHBhcmFtIHshcHJvdG8ucGIuY21zLlZpb2xhdGlvbkxpc3RSZXF1ZXN0fSBtc2cgVGhlIG1zZyBpbnN0YW5jZSB0byB0cmFuc2Zvcm0uCiAgICogQHJldHVybiB7IU9iamVjdH0KICAgKiBAc3VwcHJlc3Mge3VudXNlZExvY2FsVmFyaWFibGVzfSBmIGlzIG9ubHkgdXNlZCBmb3IgbmVzdGVkIG1lc3NhZ2VzCiAgICovCgoKICBwcm90by5wYi5jbXMuVmlvbGF0aW9uTGlzdFJlcXVlc3QudG9PYmplY3QgPSBmdW5jdGlvbiAoaW5jbHVkZUluc3RhbmNlLCBtc2cpIHsKICAgIHZhciBmLAogICAgICAgIG9iaiA9IHsKICAgICAgcGFnZU5vOiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdChtc2csIDEsIDApLAogICAgICBwYWdlU2l6ZToganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQobXNnLCAyLCAwKSwKICAgICAgYXJlYUlkOiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdChtc2csIDMsIDApLAogICAgICBkZWFsU3RhdHVzTGlzdDogKGYgPSBqc3BiLk1lc3NhZ2UuZ2V0UmVwZWF0ZWRGaWVsZChtc2csIDQpKSA9PSBudWxsID8gdW5kZWZpbmVkIDogZiwKICAgICAgc2NlbmU6IGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KG1zZywgNSwgMCksCiAgICAgIHJlcG9ydGVyVHlwZToganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQobXNnLCA2LCAwKSwKICAgICAgcmVwb3J0ZXJJZDoganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQobXNnLCA3LCAwKSwKICAgICAgcmVwb3J0ZWRUeXBlOiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdChtc2csIDgsIDApLAogICAgICByZXBvcnRlZElkOiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdChtc2csIDksIDApLAogICAgICBjcmVhdGVkU3RhcnQ6IGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KG1zZywgMTAsIDApLAogICAgICBjcmVhdGVkRW5kOiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdChtc2csIDExLCAwKQogICAgfTsKCiAgICBpZiAoaW5jbHVkZUluc3RhbmNlKSB7CiAgICAgIG9iai4kanNwYk1lc3NhZ2VJbnN0YW5jZSA9IG1zZzsKICAgIH0KCiAgICByZXR1cm4gb2JqOwogIH07Cn0KLyoqCiAqIERlc2VyaWFsaXplcyBiaW5hcnkgZGF0YSAoaW4gcHJvdG9idWYgd2lyZSBmb3JtYXQpLgogKiBAcGFyYW0ge2pzcGIuQnl0ZVNvdXJjZX0gYnl0ZXMgVGhlIGJ5dGVzIHRvIGRlc2VyaWFsaXplLgogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLlZpb2xhdGlvbkxpc3RSZXF1ZXN0fQogKi8KCgpwcm90by5wYi5jbXMuVmlvbGF0aW9uTGlzdFJlcXVlc3QuZGVzZXJpYWxpemVCaW5hcnkgPSBmdW5jdGlvbiAoYnl0ZXMpIHsKICB2YXIgcmVhZGVyID0gbmV3IGpzcGIuQmluYXJ5UmVhZGVyKGJ5dGVzKTsKICB2YXIgbXNnID0gbmV3IHByb3RvLnBiLmNtcy5WaW9sYXRpb25MaXN0UmVxdWVzdCgpOwogIHJldHVybiBwcm90by5wYi5jbXMuVmlvbGF0aW9uTGlzdFJlcXVlc3QuZGVzZXJpYWxpemVCaW5hcnlGcm9tUmVhZGVyKG1zZywgcmVhZGVyKTsKfTsKLyoqCiAqIERlc2VyaWFsaXplcyBiaW5hcnkgZGF0YSAoaW4gcHJvdG9idWYgd2lyZSBmb3JtYXQpIGZyb20gdGhlCiAqIGdpdmVuIHJlYWRlciBpbnRvIHRoZSBnaXZlbiBtZXNzYWdlIG9iamVjdC4KICogQHBhcmFtIHshcHJvdG8ucGIuY21zLlZpb2xhdGlvbkxpc3RSZXF1ZXN0fSBtc2cgVGhlIG1lc3NhZ2Ugb2JqZWN0IHRvIGRlc2VyaWFsaXplIGludG8uCiAqIEBwYXJhbSB7IWpzcGIuQmluYXJ5UmVhZGVyfSByZWFkZXIgVGhlIEJpbmFyeVJlYWRlciB0byB1c2UuCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuVmlvbGF0aW9uTGlzdFJlcXVlc3R9CiAqLwoKCnByb3RvLnBiLmNtcy5WaW9sYXRpb25MaXN0UmVxdWVzdC5kZXNlcmlhbGl6ZUJpbmFyeUZyb21SZWFkZXIgPSBmdW5jdGlvbiAobXNnLCByZWFkZXIpIHsKICB3aGlsZSAocmVhZGVyLm5leHRGaWVsZCgpKSB7CiAgICBpZiAocmVhZGVyLmlzRW5kR3JvdXAoKSkgewogICAgICBicmVhazsKICAgIH0KCiAgICB2YXIgZmllbGQgPSByZWFkZXIuZ2V0RmllbGROdW1iZXIoKTsKCiAgICBzd2l0Y2ggKGZpZWxkKSB7CiAgICAgIGNhc2UgMToKICAgICAgICB2YXIgdmFsdWUgPSByZWFkZXIucmVhZFVpbnQzMigpOwogICAgICAgIG1zZy5zZXRQYWdlTm8odmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSAyOgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkVWludDMyKCk7CiAgICAgICAgbXNnLnNldFBhZ2VTaXplKHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgMzoKICAgICAgICB2YXIgdmFsdWUgPSByZWFkZXIucmVhZFVpbnQzMigpOwogICAgICAgIG1zZy5zZXRBcmVhSWQodmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSA0OgogICAgICAgIHZhciB2YWx1ZXMgPSByZWFkZXIuaXNEZWxpbWl0ZWQoKSA/IHJlYWRlci5yZWFkUGFja2VkRW51bSgpIDogW3JlYWRlci5yZWFkRW51bSgpXTsKCiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB2YWx1ZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIG1zZy5hZGREZWFsU3RhdHVzKHZhbHVlc1tpXSk7CiAgICAgICAgfQoKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgNToKICAgICAgICB2YXIgdmFsdWUgPSByZWFkZXIucmVhZEVudW0oKTsKICAgICAgICBtc2cuc2V0U2NlbmUodmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSA2OgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkRW51bSgpOwogICAgICAgIG1zZy5zZXRSZXBvcnRlclR5cGUodmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSA3OgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkVWludDMyKCk7CiAgICAgICAgbXNnLnNldFJlcG9ydGVySWQodmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSA4OgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkRW51bSgpOwogICAgICAgIG1zZy5zZXRSZXBvcnRlZFR5cGUodmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSA5OgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkVWludDMyKCk7CiAgICAgICAgbXNnLnNldFJlcG9ydGVkSWQodmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSAxMDoKICAgICAgICB2YXIgdmFsdWUgPSByZWFkZXIucmVhZFVpbnQzMigpOwogICAgICAgIG1zZy5zZXRDcmVhdGVkU3RhcnQodmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSAxMToKICAgICAgICB2YXIgdmFsdWUgPSByZWFkZXIucmVhZFVpbnQzMigpOwogICAgICAgIG1zZy5zZXRDcmVhdGVkRW5kKHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGRlZmF1bHQ6CiAgICAgICAgcmVhZGVyLnNraXBGaWVsZCgpOwogICAgICAgIGJyZWFrOwogICAgfQogIH0KCiAgcmV0dXJuIG1zZzsKfTsKLyoqCiAqIFNlcmlhbGl6ZXMgdGhlIG1lc3NhZ2UgdG8gYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUgZm9ybWF0KS4KICogQHJldHVybiB7IVVpbnQ4QXJyYXl9CiAqLwoKCnByb3RvLnBiLmNtcy5WaW9sYXRpb25MaXN0UmVxdWVzdC5wcm90b3R5cGUuc2VyaWFsaXplQmluYXJ5ID0gZnVuY3Rpb24gKCkgewogIHZhciB3cml0ZXIgPSBuZXcganNwYi5CaW5hcnlXcml0ZXIoKTsKICBwcm90by5wYi5jbXMuVmlvbGF0aW9uTGlzdFJlcXVlc3Quc2VyaWFsaXplQmluYXJ5VG9Xcml0ZXIodGhpcywgd3JpdGVyKTsKICByZXR1cm4gd3JpdGVyLmdldFJlc3VsdEJ1ZmZlcigpOwp9OwovKioKICogU2VyaWFsaXplcyB0aGUgZ2l2ZW4gbWVzc2FnZSB0byBiaW5hcnkgZGF0YSAoaW4gcHJvdG9idWYgd2lyZQogKiBmb3JtYXQpLCB3cml0aW5nIHRvIHRoZSBnaXZlbiBCaW5hcnlXcml0ZXIuCiAqIEBwYXJhbSB7IXByb3RvLnBiLmNtcy5WaW9sYXRpb25MaXN0UmVxdWVzdH0gbWVzc2FnZQogKiBAcGFyYW0geyFqc3BiLkJpbmFyeVdyaXRlcn0gd3JpdGVyCiAqIEBzdXBwcmVzcyB7dW51c2VkTG9jYWxWYXJpYWJsZXN9IGYgaXMgb25seSB1c2VkIGZvciBuZXN0ZWQgbWVzc2FnZXMKICovCgoKcHJvdG8ucGIuY21zLlZpb2xhdGlvbkxpc3RSZXF1ZXN0LnNlcmlhbGl6ZUJpbmFyeVRvV3JpdGVyID0gZnVuY3Rpb24gKG1lc3NhZ2UsIHdyaXRlcikgewogIHZhciBmID0gdW5kZWZpbmVkOwogIGYgPSBtZXNzYWdlLmdldFBhZ2VObygpOwoKICBpZiAoZiAhPT0gMCkgewogICAgd3JpdGVyLndyaXRlVWludDMyKDEsIGYpOwogIH0KCiAgZiA9IG1lc3NhZ2UuZ2V0UGFnZVNpemUoKTsKCiAgaWYgKGYgIT09IDApIHsKICAgIHdyaXRlci53cml0ZVVpbnQzMigyLCBmKTsKICB9CgogIGYgPSBtZXNzYWdlLmdldEFyZWFJZCgpOwoKICBpZiAoZiAhPT0gMCkgewogICAgd3JpdGVyLndyaXRlVWludDMyKDMsIGYpOwogIH0KCiAgZiA9IG1lc3NhZ2UuZ2V0RGVhbFN0YXR1c0xpc3QoKTsKCiAgaWYgKGYubGVuZ3RoID4gMCkgewogICAgd3JpdGVyLndyaXRlUGFja2VkRW51bSg0LCBmKTsKICB9CgogIGYgPSBtZXNzYWdlLmdldFNjZW5lKCk7CgogIGlmIChmICE9PSAwLjApIHsKICAgIHdyaXRlci53cml0ZUVudW0oNSwgZik7CiAgfQoKICBmID0gbWVzc2FnZS5nZXRSZXBvcnRlclR5cGUoKTsKCiAgaWYgKGYgIT09IDAuMCkgewogICAgd3JpdGVyLndyaXRlRW51bSg2LCBmKTsKICB9CgogIGYgPSBtZXNzYWdlLmdldFJlcG9ydGVySWQoKTsKCiAgaWYgKGYgIT09IDApIHsKICAgIHdyaXRlci53cml0ZVVpbnQzMig3LCBmKTsKICB9CgogIGYgPSBtZXNzYWdlLmdldFJlcG9ydGVkVHlwZSgpOwoKICBpZiAoZiAhPT0gMC4wKSB7CiAgICB3cml0ZXIud3JpdGVFbnVtKDgsIGYpOwogIH0KCiAgZiA9IG1lc3NhZ2UuZ2V0UmVwb3J0ZWRJZCgpOwoKICBpZiAoZiAhPT0gMCkgewogICAgd3JpdGVyLndyaXRlVWludDMyKDksIGYpOwogIH0KCiAgZiA9IG1lc3NhZ2UuZ2V0Q3JlYXRlZFN0YXJ0KCk7CgogIGlmIChmICE9PSAwKSB7CiAgICB3cml0ZXIud3JpdGVVaW50MzIoMTAsIGYpOwogIH0KCiAgZiA9IG1lc3NhZ2UuZ2V0Q3JlYXRlZEVuZCgpOwoKICBpZiAoZiAhPT0gMCkgewogICAgd3JpdGVyLndyaXRlVWludDMyKDExLCBmKTsKICB9Cn07Ci8qKgogKiBvcHRpb25hbCB1aW50MzIgcGFnZV9ubyA9IDE7CiAqIEByZXR1cm4ge251bWJlcn0KICovCgoKcHJvdG8ucGIuY21zLlZpb2xhdGlvbkxpc3RSZXF1ZXN0LnByb3RvdHlwZS5nZXRQYWdlTm8gPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDEsIDApOwp9OwovKioKICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuVmlvbGF0aW9uTGlzdFJlcXVlc3R9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuVmlvbGF0aW9uTGlzdFJlcXVlc3QucHJvdG90eXBlLnNldFBhZ2VObyA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UHJvdG8zSW50RmllbGQodGhpcywgMSwgdmFsdWUpOwp9OwovKioKICogb3B0aW9uYWwgdWludDMyIHBhZ2Vfc2l6ZSA9IDI7CiAqIEByZXR1cm4ge251bWJlcn0KICovCgoKcHJvdG8ucGIuY21zLlZpb2xhdGlvbkxpc3RSZXF1ZXN0LnByb3RvdHlwZS5nZXRQYWdlU2l6ZSA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQodGhpcywgMiwgMCk7Cn07Ci8qKgogKiBAcGFyYW0ge251bWJlcn0gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5WaW9sYXRpb25MaXN0UmVxdWVzdH0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5WaW9sYXRpb25MaXN0UmVxdWVzdC5wcm90b3R5cGUuc2V0UGFnZVNpemUgPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0ludEZpZWxkKHRoaXMsIDIsIHZhbHVlKTsKfTsKLyoqCiAqIG9wdGlvbmFsIHVpbnQzMiBhcmVhX2lkID0gMzsKICogQHJldHVybiB7bnVtYmVyfQogKi8KCgpwcm90by5wYi5jbXMuVmlvbGF0aW9uTGlzdFJlcXVlc3QucHJvdG90eXBlLmdldEFyZWFJZCA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQodGhpcywgMywgMCk7Cn07Ci8qKgogKiBAcGFyYW0ge251bWJlcn0gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5WaW9sYXRpb25MaXN0UmVxdWVzdH0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5WaW9sYXRpb25MaXN0UmVxdWVzdC5wcm90b3R5cGUuc2V0QXJlYUlkID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRQcm90bzNJbnRGaWVsZCh0aGlzLCAzLCB2YWx1ZSk7Cn07Ci8qKgogKiByZXBlYXRlZCBwYi5CbG9ja1N0YXR1cyBkZWFsX3N0YXR1cyA9IDQ7CiAqIEByZXR1cm4geyFBcnJheTwhcHJvdG8ucGIuQmxvY2tTdGF0dXM+fQogKi8KCgpwcm90by5wYi5jbXMuVmlvbGF0aW9uTGlzdFJlcXVlc3QucHJvdG90eXBlLmdldERlYWxTdGF0dXNMaXN0ID0gZnVuY3Rpb24gKCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuZ2V0UmVwZWF0ZWRGaWVsZCh0aGlzLCA0KTsKfTsKLyoqCiAqIEBwYXJhbSB7IUFycmF5PCFwcm90by5wYi5CbG9ja1N0YXR1cz59IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuVmlvbGF0aW9uTGlzdFJlcXVlc3R9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuVmlvbGF0aW9uTGlzdFJlcXVlc3QucHJvdG90eXBlLnNldERlYWxTdGF0dXNMaXN0ID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRGaWVsZCh0aGlzLCA0LCB2YWx1ZSB8fCBbXSk7Cn07Ci8qKgogKiBAcGFyYW0geyFwcm90by5wYi5CbG9ja1N0YXR1c30gdmFsdWUKICogQHBhcmFtIHtudW1iZXI9fSBvcHRfaW5kZXgKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5WaW9sYXRpb25MaXN0UmVxdWVzdH0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5WaW9sYXRpb25MaXN0UmVxdWVzdC5wcm90b3R5cGUuYWRkRGVhbFN0YXR1cyA9IGZ1bmN0aW9uICh2YWx1ZSwgb3B0X2luZGV4KSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5hZGRUb1JlcGVhdGVkRmllbGQodGhpcywgNCwgdmFsdWUsIG9wdF9pbmRleCk7Cn07Ci8qKgogKiBDbGVhcnMgdGhlIGxpc3QgbWFraW5nIGl0IGVtcHR5IGJ1dCBub24tbnVsbC4KICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5WaW9sYXRpb25MaXN0UmVxdWVzdH0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5WaW9sYXRpb25MaXN0UmVxdWVzdC5wcm90b3R5cGUuY2xlYXJEZWFsU3RhdHVzTGlzdCA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4gdGhpcy5zZXREZWFsU3RhdHVzTGlzdChbXSk7Cn07Ci8qKgogKiBvcHRpb25hbCBwYi5WaW9sYXRpb25TY2VuZSBTY2VuZSA9IDU7CiAqIEByZXR1cm4geyFwcm90by5wYi5WaW9sYXRpb25TY2VuZX0KICovCgoKcHJvdG8ucGIuY21zLlZpb2xhdGlvbkxpc3RSZXF1ZXN0LnByb3RvdHlwZS5nZXRTY2VuZSA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQodGhpcywgNSwgMCk7Cn07Ci8qKgogKiBAcGFyYW0geyFwcm90by5wYi5WaW9sYXRpb25TY2VuZX0gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5WaW9sYXRpb25MaXN0UmVxdWVzdH0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5WaW9sYXRpb25MaXN0UmVxdWVzdC5wcm90b3R5cGUuc2V0U2NlbmUgPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0VudW1GaWVsZCh0aGlzLCA1LCB2YWx1ZSk7Cn07Ci8qKgogKiBvcHRpb25hbCBwYi5FbnRpdHlUeXBlIHJlcG9ydGVyX3R5cGUgPSA2OwogKiBAcmV0dXJuIHshcHJvdG8ucGIuRW50aXR5VHlwZX0KICovCgoKcHJvdG8ucGIuY21zLlZpb2xhdGlvbkxpc3RSZXF1ZXN0LnByb3RvdHlwZS5nZXRSZXBvcnRlclR5cGUgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDYsIDApOwp9OwovKioKICogQHBhcmFtIHshcHJvdG8ucGIuRW50aXR5VHlwZX0gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5WaW9sYXRpb25MaXN0UmVxdWVzdH0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5WaW9sYXRpb25MaXN0UmVxdWVzdC5wcm90b3R5cGUuc2V0UmVwb3J0ZXJUeXBlID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRQcm90bzNFbnVtRmllbGQodGhpcywgNiwgdmFsdWUpOwp9OwovKioKICogb3B0aW9uYWwgdWludDMyIHJlcG9ydGVyX2lkID0gNzsKICogQHJldHVybiB7bnVtYmVyfQogKi8KCgpwcm90by5wYi5jbXMuVmlvbGF0aW9uTGlzdFJlcXVlc3QucHJvdG90eXBlLmdldFJlcG9ydGVySWQgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDcsIDApOwp9OwovKioKICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuVmlvbGF0aW9uTGlzdFJlcXVlc3R9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuVmlvbGF0aW9uTGlzdFJlcXVlc3QucHJvdG90eXBlLnNldFJlcG9ydGVySWQgPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0ludEZpZWxkKHRoaXMsIDcsIHZhbHVlKTsKfTsKLyoqCiAqIG9wdGlvbmFsIHBiLkVudGl0eVR5cGUgcmVwb3J0ZWRfdHlwZSA9IDg7CiAqIEByZXR1cm4geyFwcm90by5wYi5FbnRpdHlUeXBlfQogKi8KCgpwcm90by5wYi5jbXMuVmlvbGF0aW9uTGlzdFJlcXVlc3QucHJvdG90eXBlLmdldFJlcG9ydGVkVHlwZSA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQodGhpcywgOCwgMCk7Cn07Ci8qKgogKiBAcGFyYW0geyFwcm90by5wYi5FbnRpdHlUeXBlfSB2YWx1ZQogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLlZpb2xhdGlvbkxpc3RSZXF1ZXN0fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLlZpb2xhdGlvbkxpc3RSZXF1ZXN0LnByb3RvdHlwZS5zZXRSZXBvcnRlZFR5cGUgPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0VudW1GaWVsZCh0aGlzLCA4LCB2YWx1ZSk7Cn07Ci8qKgogKiBvcHRpb25hbCB1aW50MzIgcmVwb3J0ZWRfaWQgPSA5OwogKiBAcmV0dXJuIHtudW1iZXJ9CiAqLwoKCnByb3RvLnBiLmNtcy5WaW9sYXRpb25MaXN0UmVxdWVzdC5wcm90b3R5cGUuZ2V0UmVwb3J0ZWRJZCA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQodGhpcywgOSwgMCk7Cn07Ci8qKgogKiBAcGFyYW0ge251bWJlcn0gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5WaW9sYXRpb25MaXN0UmVxdWVzdH0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5WaW9sYXRpb25MaXN0UmVxdWVzdC5wcm90b3R5cGUuc2V0UmVwb3J0ZWRJZCA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UHJvdG8zSW50RmllbGQodGhpcywgOSwgdmFsdWUpOwp9OwovKioKICogb3B0aW9uYWwgdWludDMyIGNyZWF0ZWRfc3RhcnQgPSAxMDsKICogQHJldHVybiB7bnVtYmVyfQogKi8KCgpwcm90by5wYi5jbXMuVmlvbGF0aW9uTGlzdFJlcXVlc3QucHJvdG90eXBlLmdldENyZWF0ZWRTdGFydCA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQodGhpcywgMTAsIDApOwp9OwovKioKICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuVmlvbGF0aW9uTGlzdFJlcXVlc3R9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuVmlvbGF0aW9uTGlzdFJlcXVlc3QucHJvdG90eXBlLnNldENyZWF0ZWRTdGFydCA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UHJvdG8zSW50RmllbGQodGhpcywgMTAsIHZhbHVlKTsKfTsKLyoqCiAqIG9wdGlvbmFsIHVpbnQzMiBjcmVhdGVkX2VuZCA9IDExOwogKiBAcmV0dXJuIHtudW1iZXJ9CiAqLwoKCnByb3RvLnBiLmNtcy5WaW9sYXRpb25MaXN0UmVxdWVzdC5wcm90b3R5cGUuZ2V0Q3JlYXRlZEVuZCA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQodGhpcywgMTEsIDApOwp9OwovKioKICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuVmlvbGF0aW9uTGlzdFJlcXVlc3R9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuVmlvbGF0aW9uTGlzdFJlcXVlc3QucHJvdG90eXBlLnNldENyZWF0ZWRFbmQgPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0ludEZpZWxkKHRoaXMsIDExLCB2YWx1ZSk7Cn07Ci8qKgogKiBMaXN0IG9mIHJlcGVhdGVkIGZpZWxkcyB3aXRoaW4gdGhpcyBtZXNzYWdlIHR5cGUuCiAqIEBwcml2YXRlIHshQXJyYXk8bnVtYmVyPn0KICogQGNvbnN0CiAqLwoKCnByb3RvLnBiLmNtcy5WaW9sYXRpb25MaXN0UmVwbHkucmVwZWF0ZWRGaWVsZHNfID0gWzFdOwoKaWYgKGpzcGIuTWVzc2FnZS5HRU5FUkFURV9UT19PQkpFQ1QpIHsKICAvKioKICAgKiBDcmVhdGVzIGFuIG9iamVjdCByZXByZXNlbnRhdGlvbiBvZiB0aGlzIHByb3RvLgogICAqIEZpZWxkIG5hbWVzIHRoYXQgYXJlIHJlc2VydmVkIGluIEphdmFTY3JpcHQgYW5kIHdpbGwgYmUgcmVuYW1lZCB0byBwYl9uYW1lLgogICAqIE9wdGlvbmFsIGZpZWxkcyB0aGF0IGFyZSBub3Qgc2V0IHdpbGwgYmUgc2V0IHRvIHVuZGVmaW5lZC4KICAgKiBUbyBhY2Nlc3MgYSByZXNlcnZlZCBmaWVsZCB1c2UsIGZvby5wYl88bmFtZT4sIGVnLCBmb28ucGJfZGVmYXVsdC4KICAgKiBGb3IgdGhlIGxpc3Qgb2YgcmVzZXJ2ZWQgbmFtZXMgcGxlYXNlIHNlZToKICAgKiAgICAgbmV0L3Byb3RvMi9jb21waWxlci9qcy9pbnRlcm5hbC9nZW5lcmF0b3IuY2Mja0tleXdvcmQuCiAgICogQHBhcmFtIHtib29sZWFuPX0gb3B0X2luY2x1ZGVJbnN0YW5jZSBEZXByZWNhdGVkLiB3aGV0aGVyIHRvIGluY2x1ZGUgdGhlCiAgICogICAgIEpTUEIgaW5zdGFuY2UgZm9yIHRyYW5zaXRpb25hbCBzb3kgcHJvdG8gc3VwcG9ydDoKICAgKiAgICAgaHR0cDovL2dvdG8vc295LXBhcmFtLW1pZ3JhdGlvbgogICAqIEByZXR1cm4geyFPYmplY3R9CiAgICovCiAgcHJvdG8ucGIuY21zLlZpb2xhdGlvbkxpc3RSZXBseS5wcm90b3R5cGUudG9PYmplY3QgPSBmdW5jdGlvbiAob3B0X2luY2x1ZGVJbnN0YW5jZSkgewogICAgcmV0dXJuIHByb3RvLnBiLmNtcy5WaW9sYXRpb25MaXN0UmVwbHkudG9PYmplY3Qob3B0X2luY2x1ZGVJbnN0YW5jZSwgdGhpcyk7CiAgfTsKICAvKioKICAgKiBTdGF0aWMgdmVyc2lvbiBvZiB0aGUge0BzZWUgdG9PYmplY3R9IG1ldGhvZC4KICAgKiBAcGFyYW0ge2Jvb2xlYW58dW5kZWZpbmVkfSBpbmNsdWRlSW5zdGFuY2UgRGVwcmVjYXRlZC4gV2hldGhlciB0byBpbmNsdWRlCiAgICogICAgIHRoZSBKU1BCIGluc3RhbmNlIGZvciB0cmFuc2l0aW9uYWwgc295IHByb3RvIHN1cHBvcnQ6CiAgICogICAgIGh0dHA6Ly9nb3RvL3NveS1wYXJhbS1taWdyYXRpb24KICAgKiBAcGFyYW0geyFwcm90by5wYi5jbXMuVmlvbGF0aW9uTGlzdFJlcGx5fSBtc2cgVGhlIG1zZyBpbnN0YW5jZSB0byB0cmFuc2Zvcm0uCiAgICogQHJldHVybiB7IU9iamVjdH0KICAgKiBAc3VwcHJlc3Mge3VudXNlZExvY2FsVmFyaWFibGVzfSBmIGlzIG9ubHkgdXNlZCBmb3IgbmVzdGVkIG1lc3NhZ2VzCiAgICovCgoKICBwcm90by5wYi5jbXMuVmlvbGF0aW9uTGlzdFJlcGx5LnRvT2JqZWN0ID0gZnVuY3Rpb24gKGluY2x1ZGVJbnN0YW5jZSwgbXNnKSB7CiAgICB2YXIgZiwKICAgICAgICBvYmogPSB7CiAgICAgIHJlY29yZHNMaXN0OiBqc3BiLk1lc3NhZ2UudG9PYmplY3RMaXN0KG1zZy5nZXRSZWNvcmRzTGlzdCgpLCB1c2VydHlwZV9wYi5WaW9sYXRpb25SZWNvcmQudG9PYmplY3QsIGluY2x1ZGVJbnN0YW5jZSksCiAgICAgIHBhZ2VObzoganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQobXNnLCAyLCAwKSwKICAgICAgcGFnZVNpemU6IGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KG1zZywgMywgMCksCiAgICAgIHRvdGFsUGFnZToganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQobXNnLCA0LCAwKSwKICAgICAgdG90YWxDb3VudDoganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQobXNnLCA1LCAwKQogICAgfTsKCiAgICBpZiAoaW5jbHVkZUluc3RhbmNlKSB7CiAgICAgIG9iai4kanNwYk1lc3NhZ2VJbnN0YW5jZSA9IG1zZzsKICAgIH0KCiAgICByZXR1cm4gb2JqOwogIH07Cn0KLyoqCiAqIERlc2VyaWFsaXplcyBiaW5hcnkgZGF0YSAoaW4gcHJvdG9idWYgd2lyZSBmb3JtYXQpLgogKiBAcGFyYW0ge2pzcGIuQnl0ZVNvdXJjZX0gYnl0ZXMgVGhlIGJ5dGVzIHRvIGRlc2VyaWFsaXplLgogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLlZpb2xhdGlvbkxpc3RSZXBseX0KICovCgoKcHJvdG8ucGIuY21zLlZpb2xhdGlvbkxpc3RSZXBseS5kZXNlcmlhbGl6ZUJpbmFyeSA9IGZ1bmN0aW9uIChieXRlcykgewogIHZhciByZWFkZXIgPSBuZXcganNwYi5CaW5hcnlSZWFkZXIoYnl0ZXMpOwogIHZhciBtc2cgPSBuZXcgcHJvdG8ucGIuY21zLlZpb2xhdGlvbkxpc3RSZXBseSgpOwogIHJldHVybiBwcm90by5wYi5jbXMuVmlvbGF0aW9uTGlzdFJlcGx5LmRlc2VyaWFsaXplQmluYXJ5RnJvbVJlYWRlcihtc2csIHJlYWRlcik7Cn07Ci8qKgogKiBEZXNlcmlhbGl6ZXMgYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUgZm9ybWF0KSBmcm9tIHRoZQogKiBnaXZlbiByZWFkZXIgaW50byB0aGUgZ2l2ZW4gbWVzc2FnZSBvYmplY3QuCiAqIEBwYXJhbSB7IXByb3RvLnBiLmNtcy5WaW9sYXRpb25MaXN0UmVwbHl9IG1zZyBUaGUgbWVzc2FnZSBvYmplY3QgdG8gZGVzZXJpYWxpemUgaW50by4KICogQHBhcmFtIHshanNwYi5CaW5hcnlSZWFkZXJ9IHJlYWRlciBUaGUgQmluYXJ5UmVhZGVyIHRvIHVzZS4KICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5WaW9sYXRpb25MaXN0UmVwbHl9CiAqLwoKCnByb3RvLnBiLmNtcy5WaW9sYXRpb25MaXN0UmVwbHkuZGVzZXJpYWxpemVCaW5hcnlGcm9tUmVhZGVyID0gZnVuY3Rpb24gKG1zZywgcmVhZGVyKSB7CiAgd2hpbGUgKHJlYWRlci5uZXh0RmllbGQoKSkgewogICAgaWYgKHJlYWRlci5pc0VuZEdyb3VwKCkpIHsKICAgICAgYnJlYWs7CiAgICB9CgogICAgdmFyIGZpZWxkID0gcmVhZGVyLmdldEZpZWxkTnVtYmVyKCk7CgogICAgc3dpdGNoIChmaWVsZCkgewogICAgICBjYXNlIDE6CiAgICAgICAgdmFyIHZhbHVlID0gbmV3IHVzZXJ0eXBlX3BiLlZpb2xhdGlvblJlY29yZCgpOwogICAgICAgIHJlYWRlci5yZWFkTWVzc2FnZSh2YWx1ZSwgdXNlcnR5cGVfcGIuVmlvbGF0aW9uUmVjb3JkLmRlc2VyaWFsaXplQmluYXJ5RnJvbVJlYWRlcik7CiAgICAgICAgbXNnLmFkZFJlY29yZHModmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSAyOgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkVWludDMyKCk7CiAgICAgICAgbXNnLnNldFBhZ2VObyh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlIDM6CiAgICAgICAgdmFyIHZhbHVlID0gcmVhZGVyLnJlYWRVaW50MzIoKTsKICAgICAgICBtc2cuc2V0UGFnZVNpemUodmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSA0OgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkVWludDMyKCk7CiAgICAgICAgbXNnLnNldFRvdGFsUGFnZSh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlIDU6CiAgICAgICAgdmFyIHZhbHVlID0gcmVhZGVyLnJlYWRVaW50MzIoKTsKICAgICAgICBtc2cuc2V0VG90YWxDb3VudCh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBkZWZhdWx0OgogICAgICAgIHJlYWRlci5za2lwRmllbGQoKTsKICAgICAgICBicmVhazsKICAgIH0KICB9CgogIHJldHVybiBtc2c7Cn07Ci8qKgogKiBTZXJpYWxpemVzIHRoZSBtZXNzYWdlIHRvIGJpbmFyeSBkYXRhIChpbiBwcm90b2J1ZiB3aXJlIGZvcm1hdCkuCiAqIEByZXR1cm4geyFVaW50OEFycmF5fQogKi8KCgpwcm90by5wYi5jbXMuVmlvbGF0aW9uTGlzdFJlcGx5LnByb3RvdHlwZS5zZXJpYWxpemVCaW5hcnkgPSBmdW5jdGlvbiAoKSB7CiAgdmFyIHdyaXRlciA9IG5ldyBqc3BiLkJpbmFyeVdyaXRlcigpOwogIHByb3RvLnBiLmNtcy5WaW9sYXRpb25MaXN0UmVwbHkuc2VyaWFsaXplQmluYXJ5VG9Xcml0ZXIodGhpcywgd3JpdGVyKTsKICByZXR1cm4gd3JpdGVyLmdldFJlc3VsdEJ1ZmZlcigpOwp9OwovKioKICogU2VyaWFsaXplcyB0aGUgZ2l2ZW4gbWVzc2FnZSB0byBiaW5hcnkgZGF0YSAoaW4gcHJvdG9idWYgd2lyZQogKiBmb3JtYXQpLCB3cml0aW5nIHRvIHRoZSBnaXZlbiBCaW5hcnlXcml0ZXIuCiAqIEBwYXJhbSB7IXByb3RvLnBiLmNtcy5WaW9sYXRpb25MaXN0UmVwbHl9IG1lc3NhZ2UKICogQHBhcmFtIHshanNwYi5CaW5hcnlXcml0ZXJ9IHdyaXRlcgogKiBAc3VwcHJlc3Mge3VudXNlZExvY2FsVmFyaWFibGVzfSBmIGlzIG9ubHkgdXNlZCBmb3IgbmVzdGVkIG1lc3NhZ2VzCiAqLwoKCnByb3RvLnBiLmNtcy5WaW9sYXRpb25MaXN0UmVwbHkuc2VyaWFsaXplQmluYXJ5VG9Xcml0ZXIgPSBmdW5jdGlvbiAobWVzc2FnZSwgd3JpdGVyKSB7CiAgdmFyIGYgPSB1bmRlZmluZWQ7CiAgZiA9IG1lc3NhZ2UuZ2V0UmVjb3Jkc0xpc3QoKTsKCiAgaWYgKGYubGVuZ3RoID4gMCkgewogICAgd3JpdGVyLndyaXRlUmVwZWF0ZWRNZXNzYWdlKDEsIGYsIHVzZXJ0eXBlX3BiLlZpb2xhdGlvblJlY29yZC5zZXJpYWxpemVCaW5hcnlUb1dyaXRlcik7CiAgfQoKICBmID0gbWVzc2FnZS5nZXRQYWdlTm8oKTsKCiAgaWYgKGYgIT09IDApIHsKICAgIHdyaXRlci53cml0ZVVpbnQzMigyLCBmKTsKICB9CgogIGYgPSBtZXNzYWdlLmdldFBhZ2VTaXplKCk7CgogIGlmIChmICE9PSAwKSB7CiAgICB3cml0ZXIud3JpdGVVaW50MzIoMywgZik7CiAgfQoKICBmID0gbWVzc2FnZS5nZXRUb3RhbFBhZ2UoKTsKCiAgaWYgKGYgIT09IDApIHsKICAgIHdyaXRlci53cml0ZVVpbnQzMig0LCBmKTsKICB9CgogIGYgPSBtZXNzYWdlLmdldFRvdGFsQ291bnQoKTsKCiAgaWYgKGYgIT09IDApIHsKICAgIHdyaXRlci53cml0ZVVpbnQzMig1LCBmKTsKICB9Cn07Ci8qKgogKiByZXBlYXRlZCBwYi5WaW9sYXRpb25SZWNvcmQgcmVjb3JkcyA9IDE7CiAqIEByZXR1cm4geyFBcnJheTwhcHJvdG8ucGIuVmlvbGF0aW9uUmVjb3JkPn0KICovCgoKcHJvdG8ucGIuY21zLlZpb2xhdGlvbkxpc3RSZXBseS5wcm90b3R5cGUuZ2V0UmVjb3Jkc0xpc3QgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRSZXBlYXRlZFdyYXBwZXJGaWVsZCh0aGlzLCB1c2VydHlwZV9wYi5WaW9sYXRpb25SZWNvcmQsIDEpOwp9OwovKioKICogQHBhcmFtIHshQXJyYXk8IXByb3RvLnBiLlZpb2xhdGlvblJlY29yZD59IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuVmlvbGF0aW9uTGlzdFJlcGx5fSByZXR1cm5zIHRoaXMKKi8KCgpwcm90by5wYi5jbXMuVmlvbGF0aW9uTGlzdFJlcGx5LnByb3RvdHlwZS5zZXRSZWNvcmRzTGlzdCA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UmVwZWF0ZWRXcmFwcGVyRmllbGQodGhpcywgMSwgdmFsdWUpOwp9OwovKioKICogQHBhcmFtIHshcHJvdG8ucGIuVmlvbGF0aW9uUmVjb3JkPX0gb3B0X3ZhbHVlCiAqIEBwYXJhbSB7bnVtYmVyPX0gb3B0X2luZGV4CiAqIEByZXR1cm4geyFwcm90by5wYi5WaW9sYXRpb25SZWNvcmR9CiAqLwoKCnByb3RvLnBiLmNtcy5WaW9sYXRpb25MaXN0UmVwbHkucHJvdG90eXBlLmFkZFJlY29yZHMgPSBmdW5jdGlvbiAob3B0X3ZhbHVlLCBvcHRfaW5kZXgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmFkZFRvUmVwZWF0ZWRXcmFwcGVyRmllbGQodGhpcywgMSwgb3B0X3ZhbHVlLCBwcm90by5wYi5WaW9sYXRpb25SZWNvcmQsIG9wdF9pbmRleCk7Cn07Ci8qKgogKiBDbGVhcnMgdGhlIGxpc3QgbWFraW5nIGl0IGVtcHR5IGJ1dCBub24tbnVsbC4KICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5WaW9sYXRpb25MaXN0UmVwbHl9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuVmlvbGF0aW9uTGlzdFJlcGx5LnByb3RvdHlwZS5jbGVhclJlY29yZHNMaXN0ID0gZnVuY3Rpb24gKCkgewogIHJldHVybiB0aGlzLnNldFJlY29yZHNMaXN0KFtdKTsKfTsKLyoqCiAqIG9wdGlvbmFsIHVpbnQzMiBwYWdlX25vID0gMjsKICogQHJldHVybiB7bnVtYmVyfQogKi8KCgpwcm90by5wYi5jbXMuVmlvbGF0aW9uTGlzdFJlcGx5LnByb3RvdHlwZS5nZXRQYWdlTm8gPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDIsIDApOwp9OwovKioKICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuVmlvbGF0aW9uTGlzdFJlcGx5fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLlZpb2xhdGlvbkxpc3RSZXBseS5wcm90b3R5cGUuc2V0UGFnZU5vID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRQcm90bzNJbnRGaWVsZCh0aGlzLCAyLCB2YWx1ZSk7Cn07Ci8qKgogKiBvcHRpb25hbCB1aW50MzIgcGFnZV9zaXplID0gMzsKICogQHJldHVybiB7bnVtYmVyfQogKi8KCgpwcm90by5wYi5jbXMuVmlvbGF0aW9uTGlzdFJlcGx5LnByb3RvdHlwZS5nZXRQYWdlU2l6ZSA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQodGhpcywgMywgMCk7Cn07Ci8qKgogKiBAcGFyYW0ge251bWJlcn0gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5WaW9sYXRpb25MaXN0UmVwbHl9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuVmlvbGF0aW9uTGlzdFJlcGx5LnByb3RvdHlwZS5zZXRQYWdlU2l6ZSA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UHJvdG8zSW50RmllbGQodGhpcywgMywgdmFsdWUpOwp9OwovKioKICogb3B0aW9uYWwgdWludDMyIHRvdGFsX3BhZ2UgPSA0OwogKiBAcmV0dXJuIHtudW1iZXJ9CiAqLwoKCnByb3RvLnBiLmNtcy5WaW9sYXRpb25MaXN0UmVwbHkucHJvdG90eXBlLmdldFRvdGFsUGFnZSA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQodGhpcywgNCwgMCk7Cn07Ci8qKgogKiBAcGFyYW0ge251bWJlcn0gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5WaW9sYXRpb25MaXN0UmVwbHl9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuVmlvbGF0aW9uTGlzdFJlcGx5LnByb3RvdHlwZS5zZXRUb3RhbFBhZ2UgPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0ludEZpZWxkKHRoaXMsIDQsIHZhbHVlKTsKfTsKLyoqCiAqIG9wdGlvbmFsIHVpbnQzMiB0b3RhbF9jb3VudCA9IDU7CiAqIEByZXR1cm4ge251bWJlcn0KICovCgoKcHJvdG8ucGIuY21zLlZpb2xhdGlvbkxpc3RSZXBseS5wcm90b3R5cGUuZ2V0VG90YWxDb3VudCA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQodGhpcywgNSwgMCk7Cn07Ci8qKgogKiBAcGFyYW0ge251bWJlcn0gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5WaW9sYXRpb25MaXN0UmVwbHl9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuVmlvbGF0aW9uTGlzdFJlcGx5LnByb3RvdHlwZS5zZXRUb3RhbENvdW50ID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRQcm90bzNJbnRGaWVsZCh0aGlzLCA1LCB2YWx1ZSk7Cn07CgppZiAoanNwYi5NZXNzYWdlLkdFTkVSQVRFX1RPX09CSkVDVCkgewogIC8qKgogICAqIENyZWF0ZXMgYW4gb2JqZWN0IHJlcHJlc2VudGF0aW9uIG9mIHRoaXMgcHJvdG8uCiAgICogRmllbGQgbmFtZXMgdGhhdCBhcmUgcmVzZXJ2ZWQgaW4gSmF2YVNjcmlwdCBhbmQgd2lsbCBiZSByZW5hbWVkIHRvIHBiX25hbWUuCiAgICogT3B0aW9uYWwgZmllbGRzIHRoYXQgYXJlIG5vdCBzZXQgd2lsbCBiZSBzZXQgdG8gdW5kZWZpbmVkLgogICAqIFRvIGFjY2VzcyBhIHJlc2VydmVkIGZpZWxkIHVzZSwgZm9vLnBiXzxuYW1lPiwgZWcsIGZvby5wYl9kZWZhdWx0LgogICAqIEZvciB0aGUgbGlzdCBvZiByZXNlcnZlZCBuYW1lcyBwbGVhc2Ugc2VlOgogICAqICAgICBuZXQvcHJvdG8yL2NvbXBpbGVyL2pzL2ludGVybmFsL2dlbmVyYXRvci5jYyNrS2V5d29yZC4KICAgKiBAcGFyYW0ge2Jvb2xlYW49fSBvcHRfaW5jbHVkZUluc3RhbmNlIERlcHJlY2F0ZWQuIHdoZXRoZXIgdG8gaW5jbHVkZSB0aGUKICAgKiAgICAgSlNQQiBpbnN0YW5jZSBmb3IgdHJhbnNpdGlvbmFsIHNveSBwcm90byBzdXBwb3J0OgogICAqICAgICBodHRwOi8vZ290by9zb3ktcGFyYW0tbWlncmF0aW9uCiAgICogQHJldHVybiB7IU9iamVjdH0KICAgKi8KICBwcm90by5wYi5jbXMuUHJvY2Vzc1Zpb2xhdGlvblJlcXVlc3QucHJvdG90eXBlLnRvT2JqZWN0ID0gZnVuY3Rpb24gKG9wdF9pbmNsdWRlSW5zdGFuY2UpIHsKICAgIHJldHVybiBwcm90by5wYi5jbXMuUHJvY2Vzc1Zpb2xhdGlvblJlcXVlc3QudG9PYmplY3Qob3B0X2luY2x1ZGVJbnN0YW5jZSwgdGhpcyk7CiAgfTsKICAvKioKICAgKiBTdGF0aWMgdmVyc2lvbiBvZiB0aGUge0BzZWUgdG9PYmplY3R9IG1ldGhvZC4KICAgKiBAcGFyYW0ge2Jvb2xlYW58dW5kZWZpbmVkfSBpbmNsdWRlSW5zdGFuY2UgRGVwcmVjYXRlZC4gV2hldGhlciB0byBpbmNsdWRlCiAgICogICAgIHRoZSBKU1BCIGluc3RhbmNlIGZvciB0cmFuc2l0aW9uYWwgc295IHByb3RvIHN1cHBvcnQ6CiAgICogICAgIGh0dHA6Ly9nb3RvL3NveS1wYXJhbS1taWdyYXRpb24KICAgKiBAcGFyYW0geyFwcm90by5wYi5jbXMuUHJvY2Vzc1Zpb2xhdGlvblJlcXVlc3R9IG1zZyBUaGUgbXNnIGluc3RhbmNlIHRvIHRyYW5zZm9ybS4KICAgKiBAcmV0dXJuIHshT2JqZWN0fQogICAqIEBzdXBwcmVzcyB7dW51c2VkTG9jYWxWYXJpYWJsZXN9IGYgaXMgb25seSB1c2VkIGZvciBuZXN0ZWQgbWVzc2FnZXMKICAgKi8KCgogIHByb3RvLnBiLmNtcy5Qcm9jZXNzVmlvbGF0aW9uUmVxdWVzdC50b09iamVjdCA9IGZ1bmN0aW9uIChpbmNsdWRlSW5zdGFuY2UsIG1zZykgewogICAgdmFyIGYsCiAgICAgICAgb2JqID0gewogICAgICB2aW9sYXRpb25JZDoganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQobXNnLCAxLCAwKSwKICAgICAgZGVhbFN0YXR1czoganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQobXNnLCAyLCAwKSwKICAgICAgZGVhbE1lc3NhZ2U6IGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KG1zZywgMywgIiIpLAogICAgICBibG9ja0R1cmF0aW9uOiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdChtc2csIDQsIDApCiAgICB9OwoKICAgIGlmIChpbmNsdWRlSW5zdGFuY2UpIHsKICAgICAgb2JqLiRqc3BiTWVzc2FnZUluc3RhbmNlID0gbXNnOwogICAgfQoKICAgIHJldHVybiBvYmo7CiAgfTsKfQovKioKICogRGVzZXJpYWxpemVzIGJpbmFyeSBkYXRhIChpbiBwcm90b2J1ZiB3aXJlIGZvcm1hdCkuCiAqIEBwYXJhbSB7anNwYi5CeXRlU291cmNlfSBieXRlcyBUaGUgYnl0ZXMgdG8gZGVzZXJpYWxpemUuCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuUHJvY2Vzc1Zpb2xhdGlvblJlcXVlc3R9CiAqLwoKCnByb3RvLnBiLmNtcy5Qcm9jZXNzVmlvbGF0aW9uUmVxdWVzdC5kZXNlcmlhbGl6ZUJpbmFyeSA9IGZ1bmN0aW9uIChieXRlcykgewogIHZhciByZWFkZXIgPSBuZXcganNwYi5CaW5hcnlSZWFkZXIoYnl0ZXMpOwogIHZhciBtc2cgPSBuZXcgcHJvdG8ucGIuY21zLlByb2Nlc3NWaW9sYXRpb25SZXF1ZXN0KCk7CiAgcmV0dXJuIHByb3RvLnBiLmNtcy5Qcm9jZXNzVmlvbGF0aW9uUmVxdWVzdC5kZXNlcmlhbGl6ZUJpbmFyeUZyb21SZWFkZXIobXNnLCByZWFkZXIpOwp9OwovKioKICogRGVzZXJpYWxpemVzIGJpbmFyeSBkYXRhIChpbiBwcm90b2J1ZiB3aXJlIGZvcm1hdCkgZnJvbSB0aGUKICogZ2l2ZW4gcmVhZGVyIGludG8gdGhlIGdpdmVuIG1lc3NhZ2Ugb2JqZWN0LgogKiBAcGFyYW0geyFwcm90by5wYi5jbXMuUHJvY2Vzc1Zpb2xhdGlvblJlcXVlc3R9IG1zZyBUaGUgbWVzc2FnZSBvYmplY3QgdG8gZGVzZXJpYWxpemUgaW50by4KICogQHBhcmFtIHshanNwYi5CaW5hcnlSZWFkZXJ9IHJlYWRlciBUaGUgQmluYXJ5UmVhZGVyIHRvIHVzZS4KICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5Qcm9jZXNzVmlvbGF0aW9uUmVxdWVzdH0KICovCgoKcHJvdG8ucGIuY21zLlByb2Nlc3NWaW9sYXRpb25SZXF1ZXN0LmRlc2VyaWFsaXplQmluYXJ5RnJvbVJlYWRlciA9IGZ1bmN0aW9uIChtc2csIHJlYWRlcikgewogIHdoaWxlIChyZWFkZXIubmV4dEZpZWxkKCkpIHsKICAgIGlmIChyZWFkZXIuaXNFbmRHcm91cCgpKSB7CiAgICAgIGJyZWFrOwogICAgfQoKICAgIHZhciBmaWVsZCA9IHJlYWRlci5nZXRGaWVsZE51bWJlcigpOwoKICAgIHN3aXRjaCAoZmllbGQpIHsKICAgICAgY2FzZSAxOgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkVWludDY0KCk7CiAgICAgICAgbXNnLnNldFZpb2xhdGlvbklkKHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgMjoKICAgICAgICB2YXIgdmFsdWUgPSByZWFkZXIucmVhZEVudW0oKTsKICAgICAgICBtc2cuc2V0RGVhbFN0YXR1cyh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlIDM6CiAgICAgICAgdmFyIHZhbHVlID0gcmVhZGVyLnJlYWRTdHJpbmcoKTsKICAgICAgICBtc2cuc2V0RGVhbE1lc3NhZ2UodmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSA0OgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkVWludDMyKCk7CiAgICAgICAgbXNnLnNldEJsb2NrRHVyYXRpb24odmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgZGVmYXVsdDoKICAgICAgICByZWFkZXIuc2tpcEZpZWxkKCk7CiAgICAgICAgYnJlYWs7CiAgICB9CiAgfQoKICByZXR1cm4gbXNnOwp9OwovKioKICogU2VyaWFsaXplcyB0aGUgbWVzc2FnZSB0byBiaW5hcnkgZGF0YSAoaW4gcHJvdG9idWYgd2lyZSBmb3JtYXQpLgogKiBAcmV0dXJuIHshVWludDhBcnJheX0KICovCgoKcHJvdG8ucGIuY21zLlByb2Nlc3NWaW9sYXRpb25SZXF1ZXN0LnByb3RvdHlwZS5zZXJpYWxpemVCaW5hcnkgPSBmdW5jdGlvbiAoKSB7CiAgdmFyIHdyaXRlciA9IG5ldyBqc3BiLkJpbmFyeVdyaXRlcigpOwogIHByb3RvLnBiLmNtcy5Qcm9jZXNzVmlvbGF0aW9uUmVxdWVzdC5zZXJpYWxpemVCaW5hcnlUb1dyaXRlcih0aGlzLCB3cml0ZXIpOwogIHJldHVybiB3cml0ZXIuZ2V0UmVzdWx0QnVmZmVyKCk7Cn07Ci8qKgogKiBTZXJpYWxpemVzIHRoZSBnaXZlbiBtZXNzYWdlIHRvIGJpbmFyeSBkYXRhIChpbiBwcm90b2J1ZiB3aXJlCiAqIGZvcm1hdCksIHdyaXRpbmcgdG8gdGhlIGdpdmVuIEJpbmFyeVdyaXRlci4KICogQHBhcmFtIHshcHJvdG8ucGIuY21zLlByb2Nlc3NWaW9sYXRpb25SZXF1ZXN0fSBtZXNzYWdlCiAqIEBwYXJhbSB7IWpzcGIuQmluYXJ5V3JpdGVyfSB3cml0ZXIKICogQHN1cHByZXNzIHt1bnVzZWRMb2NhbFZhcmlhYmxlc30gZiBpcyBvbmx5IHVzZWQgZm9yIG5lc3RlZCBtZXNzYWdlcwogKi8KCgpwcm90by5wYi5jbXMuUHJvY2Vzc1Zpb2xhdGlvblJlcXVlc3Quc2VyaWFsaXplQmluYXJ5VG9Xcml0ZXIgPSBmdW5jdGlvbiAobWVzc2FnZSwgd3JpdGVyKSB7CiAgdmFyIGYgPSB1bmRlZmluZWQ7CiAgZiA9IG1lc3NhZ2UuZ2V0VmlvbGF0aW9uSWQoKTsKCiAgaWYgKGYgIT09IDApIHsKICAgIHdyaXRlci53cml0ZVVpbnQ2NCgxLCBmKTsKICB9CgogIGYgPSBtZXNzYWdlLmdldERlYWxTdGF0dXMoKTsKCiAgaWYgKGYgIT09IDAuMCkgewogICAgd3JpdGVyLndyaXRlRW51bSgyLCBmKTsKICB9CgogIGYgPSBtZXNzYWdlLmdldERlYWxNZXNzYWdlKCk7CgogIGlmIChmLmxlbmd0aCA+IDApIHsKICAgIHdyaXRlci53cml0ZVN0cmluZygzLCBmKTsKICB9CgogIGYgPSBtZXNzYWdlLmdldEJsb2NrRHVyYXRpb24oKTsKCiAgaWYgKGYgIT09IDApIHsKICAgIHdyaXRlci53cml0ZVVpbnQzMig0LCBmKTsKICB9Cn07Ci8qKgogKiBvcHRpb25hbCB1aW50NjQgdmlvbGF0aW9uX2lkID0gMTsKICogQHJldHVybiB7bnVtYmVyfQogKi8KCgpwcm90by5wYi5jbXMuUHJvY2Vzc1Zpb2xhdGlvblJlcXVlc3QucHJvdG90eXBlLmdldFZpb2xhdGlvbklkID0gZnVuY3Rpb24gKCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdCh0aGlzLCAxLCAwKTsKfTsKLyoqCiAqIEBwYXJhbSB7bnVtYmVyfSB2YWx1ZQogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLlByb2Nlc3NWaW9sYXRpb25SZXF1ZXN0fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLlByb2Nlc3NWaW9sYXRpb25SZXF1ZXN0LnByb3RvdHlwZS5zZXRWaW9sYXRpb25JZCA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UHJvdG8zSW50RmllbGQodGhpcywgMSwgdmFsdWUpOwp9OwovKioKICogb3B0aW9uYWwgcGIuQmxvY2tTdGF0dXMgZGVhbF9zdGF0dXMgPSAyOwogKiBAcmV0dXJuIHshcHJvdG8ucGIuQmxvY2tTdGF0dXN9CiAqLwoKCnByb3RvLnBiLmNtcy5Qcm9jZXNzVmlvbGF0aW9uUmVxdWVzdC5wcm90b3R5cGUuZ2V0RGVhbFN0YXR1cyA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQodGhpcywgMiwgMCk7Cn07Ci8qKgogKiBAcGFyYW0geyFwcm90by5wYi5CbG9ja1N0YXR1c30gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5Qcm9jZXNzVmlvbGF0aW9uUmVxdWVzdH0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5Qcm9jZXNzVmlvbGF0aW9uUmVxdWVzdC5wcm90b3R5cGUuc2V0RGVhbFN0YXR1cyA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UHJvdG8zRW51bUZpZWxkKHRoaXMsIDIsIHZhbHVlKTsKfTsKLyoqCiAqIG9wdGlvbmFsIHN0cmluZyBkZWFsX21lc3NhZ2UgPSAzOwogKiBAcmV0dXJuIHtzdHJpbmd9CiAqLwoKCnByb3RvLnBiLmNtcy5Qcm9jZXNzVmlvbGF0aW9uUmVxdWVzdC5wcm90b3R5cGUuZ2V0RGVhbE1lc3NhZ2UgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDMsICIiKTsKfTsKLyoqCiAqIEBwYXJhbSB7c3RyaW5nfSB2YWx1ZQogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLlByb2Nlc3NWaW9sYXRpb25SZXF1ZXN0fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLlByb2Nlc3NWaW9sYXRpb25SZXF1ZXN0LnByb3RvdHlwZS5zZXREZWFsTWVzc2FnZSA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UHJvdG8zU3RyaW5nRmllbGQodGhpcywgMywgdmFsdWUpOwp9OwovKioKICogb3B0aW9uYWwgdWludDMyIGJsb2NrX2R1cmF0aW9uID0gNDsKICogQHJldHVybiB7bnVtYmVyfQogKi8KCgpwcm90by5wYi5jbXMuUHJvY2Vzc1Zpb2xhdGlvblJlcXVlc3QucHJvdG90eXBlLmdldEJsb2NrRHVyYXRpb24gPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDQsIDApOwp9OwovKioKICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuUHJvY2Vzc1Zpb2xhdGlvblJlcXVlc3R9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuUHJvY2Vzc1Zpb2xhdGlvblJlcXVlc3QucHJvdG90eXBlLnNldEJsb2NrRHVyYXRpb24gPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0ludEZpZWxkKHRoaXMsIDQsIHZhbHVlKTsKfTsKCmlmIChqc3BiLk1lc3NhZ2UuR0VORVJBVEVfVE9fT0JKRUNUKSB7CiAgLyoqCiAgICogQ3JlYXRlcyBhbiBvYmplY3QgcmVwcmVzZW50YXRpb24gb2YgdGhpcyBwcm90by4KICAgKiBGaWVsZCBuYW1lcyB0aGF0IGFyZSByZXNlcnZlZCBpbiBKYXZhU2NyaXB0IGFuZCB3aWxsIGJlIHJlbmFtZWQgdG8gcGJfbmFtZS4KICAgKiBPcHRpb25hbCBmaWVsZHMgdGhhdCBhcmUgbm90IHNldCB3aWxsIGJlIHNldCB0byB1bmRlZmluZWQuCiAgICogVG8gYWNjZXNzIGEgcmVzZXJ2ZWQgZmllbGQgdXNlLCBmb28ucGJfPG5hbWU+LCBlZywgZm9vLnBiX2RlZmF1bHQuCiAgICogRm9yIHRoZSBsaXN0IG9mIHJlc2VydmVkIG5hbWVzIHBsZWFzZSBzZWU6CiAgICogICAgIG5ldC9wcm90bzIvY29tcGlsZXIvanMvaW50ZXJuYWwvZ2VuZXJhdG9yLmNjI2tLZXl3b3JkLgogICAqIEBwYXJhbSB7Ym9vbGVhbj19IG9wdF9pbmNsdWRlSW5zdGFuY2UgRGVwcmVjYXRlZC4gd2hldGhlciB0byBpbmNsdWRlIHRoZQogICAqICAgICBKU1BCIGluc3RhbmNlIGZvciB0cmFuc2l0aW9uYWwgc295IHByb3RvIHN1cHBvcnQ6CiAgICogICAgIGh0dHA6Ly9nb3RvL3NveS1wYXJhbS1taWdyYXRpb24KICAgKiBAcmV0dXJuIHshT2JqZWN0fQogICAqLwogIHByb3RvLnBiLmNtcy5MaXZlTGlzdFJlcXVlc3QucHJvdG90eXBlLnRvT2JqZWN0ID0gZnVuY3Rpb24gKG9wdF9pbmNsdWRlSW5zdGFuY2UpIHsKICAgIHJldHVybiBwcm90by5wYi5jbXMuTGl2ZUxpc3RSZXF1ZXN0LnRvT2JqZWN0KG9wdF9pbmNsdWRlSW5zdGFuY2UsIHRoaXMpOwogIH07CiAgLyoqCiAgICogU3RhdGljIHZlcnNpb24gb2YgdGhlIHtAc2VlIHRvT2JqZWN0fSBtZXRob2QuCiAgICogQHBhcmFtIHtib29sZWFufHVuZGVmaW5lZH0gaW5jbHVkZUluc3RhbmNlIERlcHJlY2F0ZWQuIFdoZXRoZXIgdG8gaW5jbHVkZQogICAqICAgICB0aGUgSlNQQiBpbnN0YW5jZSBmb3IgdHJhbnNpdGlvbmFsIHNveSBwcm90byBzdXBwb3J0OgogICAqICAgICBodHRwOi8vZ290by9zb3ktcGFyYW0tbWlncmF0aW9uCiAgICogQHBhcmFtIHshcHJvdG8ucGIuY21zLkxpdmVMaXN0UmVxdWVzdH0gbXNnIFRoZSBtc2cgaW5zdGFuY2UgdG8gdHJhbnNmb3JtLgogICAqIEByZXR1cm4geyFPYmplY3R9CiAgICogQHN1cHByZXNzIHt1bnVzZWRMb2NhbFZhcmlhYmxlc30gZiBpcyBvbmx5IHVzZWQgZm9yIG5lc3RlZCBtZXNzYWdlcwogICAqLwoKCiAgcHJvdG8ucGIuY21zLkxpdmVMaXN0UmVxdWVzdC50b09iamVjdCA9IGZ1bmN0aW9uIChpbmNsdWRlSW5zdGFuY2UsIG1zZykgewogICAgdmFyIGYsCiAgICAgICAgb2JqID0gewogICAgICBwYWdlTm86IGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KG1zZywgMSwgMCksCiAgICAgIHBhZ2VTaXplOiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdChtc2csIDIsIDApLAogICAgICBhcmVhSWQ6IGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KG1zZywgMywgMCksCiAgICAgIGFuY2hvcklkOiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdChtc2csIDQsIDApLAogICAgICBzdGF0dXM6IGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KG1zZywgNSwgMCksCiAgICAgIGNyZWF0ZWRTdGFydDoganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQobXNnLCA2LCAwKSwKICAgICAgY3JlYXRlZEVuZDoganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQobXNnLCA3LCAwKQogICAgfTsKCiAgICBpZiAoaW5jbHVkZUluc3RhbmNlKSB7CiAgICAgIG9iai4kanNwYk1lc3NhZ2VJbnN0YW5jZSA9IG1zZzsKICAgIH0KCiAgICByZXR1cm4gb2JqOwogIH07Cn0KLyoqCiAqIERlc2VyaWFsaXplcyBiaW5hcnkgZGF0YSAoaW4gcHJvdG9idWYgd2lyZSBmb3JtYXQpLgogKiBAcGFyYW0ge2pzcGIuQnl0ZVNvdXJjZX0gYnl0ZXMgVGhlIGJ5dGVzIHRvIGRlc2VyaWFsaXplLgogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLkxpdmVMaXN0UmVxdWVzdH0KICovCgoKcHJvdG8ucGIuY21zLkxpdmVMaXN0UmVxdWVzdC5kZXNlcmlhbGl6ZUJpbmFyeSA9IGZ1bmN0aW9uIChieXRlcykgewogIHZhciByZWFkZXIgPSBuZXcganNwYi5CaW5hcnlSZWFkZXIoYnl0ZXMpOwogIHZhciBtc2cgPSBuZXcgcHJvdG8ucGIuY21zLkxpdmVMaXN0UmVxdWVzdCgpOwogIHJldHVybiBwcm90by5wYi5jbXMuTGl2ZUxpc3RSZXF1ZXN0LmRlc2VyaWFsaXplQmluYXJ5RnJvbVJlYWRlcihtc2csIHJlYWRlcik7Cn07Ci8qKgogKiBEZXNlcmlhbGl6ZXMgYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUgZm9ybWF0KSBmcm9tIHRoZQogKiBnaXZlbiByZWFkZXIgaW50byB0aGUgZ2l2ZW4gbWVzc2FnZSBvYmplY3QuCiAqIEBwYXJhbSB7IXByb3RvLnBiLmNtcy5MaXZlTGlzdFJlcXVlc3R9IG1zZyBUaGUgbWVzc2FnZSBvYmplY3QgdG8gZGVzZXJpYWxpemUgaW50by4KICogQHBhcmFtIHshanNwYi5CaW5hcnlSZWFkZXJ9IHJlYWRlciBUaGUgQmluYXJ5UmVhZGVyIHRvIHVzZS4KICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5MaXZlTGlzdFJlcXVlc3R9CiAqLwoKCnByb3RvLnBiLmNtcy5MaXZlTGlzdFJlcXVlc3QuZGVzZXJpYWxpemVCaW5hcnlGcm9tUmVhZGVyID0gZnVuY3Rpb24gKG1zZywgcmVhZGVyKSB7CiAgd2hpbGUgKHJlYWRlci5uZXh0RmllbGQoKSkgewogICAgaWYgKHJlYWRlci5pc0VuZEdyb3VwKCkpIHsKICAgICAgYnJlYWs7CiAgICB9CgogICAgdmFyIGZpZWxkID0gcmVhZGVyLmdldEZpZWxkTnVtYmVyKCk7CgogICAgc3dpdGNoIChmaWVsZCkgewogICAgICBjYXNlIDE6CiAgICAgICAgdmFyIHZhbHVlID0gcmVhZGVyLnJlYWRVaW50MzIoKTsKICAgICAgICBtc2cuc2V0UGFnZU5vKHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgMjoKICAgICAgICB2YXIgdmFsdWUgPSByZWFkZXIucmVhZFVpbnQzMigpOwogICAgICAgIG1zZy5zZXRQYWdlU2l6ZSh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlIDM6CiAgICAgICAgdmFyIHZhbHVlID0gcmVhZGVyLnJlYWRVaW50MzIoKTsKICAgICAgICBtc2cuc2V0QXJlYUlkKHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgNDoKICAgICAgICB2YXIgdmFsdWUgPSByZWFkZXIucmVhZFVpbnQzMigpOwogICAgICAgIG1zZy5zZXRBbmNob3JJZCh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlIDU6CiAgICAgICAgdmFyIHZhbHVlID0gcmVhZGVyLnJlYWRFbnVtKCk7CiAgICAgICAgbXNnLnNldFN0YXR1cyh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlIDY6CiAgICAgICAgdmFyIHZhbHVlID0gcmVhZGVyLnJlYWRVaW50MzIoKTsKICAgICAgICBtc2cuc2V0Q3JlYXRlZFN0YXJ0KHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgNzoKICAgICAgICB2YXIgdmFsdWUgPSByZWFkZXIucmVhZFVpbnQzMigpOwogICAgICAgIG1zZy5zZXRDcmVhdGVkRW5kKHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGRlZmF1bHQ6CiAgICAgICAgcmVhZGVyLnNraXBGaWVsZCgpOwogICAgICAgIGJyZWFrOwogICAgfQogIH0KCiAgcmV0dXJuIG1zZzsKfTsKLyoqCiAqIFNlcmlhbGl6ZXMgdGhlIG1lc3NhZ2UgdG8gYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUgZm9ybWF0KS4KICogQHJldHVybiB7IVVpbnQ4QXJyYXl9CiAqLwoKCnByb3RvLnBiLmNtcy5MaXZlTGlzdFJlcXVlc3QucHJvdG90eXBlLnNlcmlhbGl6ZUJpbmFyeSA9IGZ1bmN0aW9uICgpIHsKICB2YXIgd3JpdGVyID0gbmV3IGpzcGIuQmluYXJ5V3JpdGVyKCk7CiAgcHJvdG8ucGIuY21zLkxpdmVMaXN0UmVxdWVzdC5zZXJpYWxpemVCaW5hcnlUb1dyaXRlcih0aGlzLCB3cml0ZXIpOwogIHJldHVybiB3cml0ZXIuZ2V0UmVzdWx0QnVmZmVyKCk7Cn07Ci8qKgogKiBTZXJpYWxpemVzIHRoZSBnaXZlbiBtZXNzYWdlIHRvIGJpbmFyeSBkYXRhIChpbiBwcm90b2J1ZiB3aXJlCiAqIGZvcm1hdCksIHdyaXRpbmcgdG8gdGhlIGdpdmVuIEJpbmFyeVdyaXRlci4KICogQHBhcmFtIHshcHJvdG8ucGIuY21zLkxpdmVMaXN0UmVxdWVzdH0gbWVzc2FnZQogKiBAcGFyYW0geyFqc3BiLkJpbmFyeVdyaXRlcn0gd3JpdGVyCiAqIEBzdXBwcmVzcyB7dW51c2VkTG9jYWxWYXJpYWJsZXN9IGYgaXMgb25seSB1c2VkIGZvciBuZXN0ZWQgbWVzc2FnZXMKICovCgoKcHJvdG8ucGIuY21zLkxpdmVMaXN0UmVxdWVzdC5zZXJpYWxpemVCaW5hcnlUb1dyaXRlciA9IGZ1bmN0aW9uIChtZXNzYWdlLCB3cml0ZXIpIHsKICB2YXIgZiA9IHVuZGVmaW5lZDsKICBmID0gbWVzc2FnZS5nZXRQYWdlTm8oKTsKCiAgaWYgKGYgIT09IDApIHsKICAgIHdyaXRlci53cml0ZVVpbnQzMigxLCBmKTsKICB9CgogIGYgPSBtZXNzYWdlLmdldFBhZ2VTaXplKCk7CgogIGlmIChmICE9PSAwKSB7CiAgICB3cml0ZXIud3JpdGVVaW50MzIoMiwgZik7CiAgfQoKICBmID0gbWVzc2FnZS5nZXRBcmVhSWQoKTsKCiAgaWYgKGYgIT09IDApIHsKICAgIHdyaXRlci53cml0ZVVpbnQzMigzLCBmKTsKICB9CgogIGYgPSBtZXNzYWdlLmdldEFuY2hvcklkKCk7CgogIGlmIChmICE9PSAwKSB7CiAgICB3cml0ZXIud3JpdGVVaW50MzIoNCwgZik7CiAgfQoKICBmID0gbWVzc2FnZS5nZXRTdGF0dXMoKTsKCiAgaWYgKGYgIT09IDAuMCkgewogICAgd3JpdGVyLndyaXRlRW51bSg1LCBmKTsKICB9CgogIGYgPSBtZXNzYWdlLmdldENyZWF0ZWRTdGFydCgpOwoKICBpZiAoZiAhPT0gMCkgewogICAgd3JpdGVyLndyaXRlVWludDMyKDYsIGYpOwogIH0KCiAgZiA9IG1lc3NhZ2UuZ2V0Q3JlYXRlZEVuZCgpOwoKICBpZiAoZiAhPT0gMCkgewogICAgd3JpdGVyLndyaXRlVWludDMyKDcsIGYpOwogIH0KfTsKLyoqCiAqIG9wdGlvbmFsIHVpbnQzMiBwYWdlX25vID0gMTsKICogQHJldHVybiB7bnVtYmVyfQogKi8KCgpwcm90by5wYi5jbXMuTGl2ZUxpc3RSZXF1ZXN0LnByb3RvdHlwZS5nZXRQYWdlTm8gPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDEsIDApOwp9OwovKioKICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuTGl2ZUxpc3RSZXF1ZXN0fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLkxpdmVMaXN0UmVxdWVzdC5wcm90b3R5cGUuc2V0UGFnZU5vID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRQcm90bzNJbnRGaWVsZCh0aGlzLCAxLCB2YWx1ZSk7Cn07Ci8qKgogKiBvcHRpb25hbCB1aW50MzIgcGFnZV9zaXplID0gMjsKICogQHJldHVybiB7bnVtYmVyfQogKi8KCgpwcm90by5wYi5jbXMuTGl2ZUxpc3RSZXF1ZXN0LnByb3RvdHlwZS5nZXRQYWdlU2l6ZSA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQodGhpcywgMiwgMCk7Cn07Ci8qKgogKiBAcGFyYW0ge251bWJlcn0gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5MaXZlTGlzdFJlcXVlc3R9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuTGl2ZUxpc3RSZXF1ZXN0LnByb3RvdHlwZS5zZXRQYWdlU2l6ZSA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UHJvdG8zSW50RmllbGQodGhpcywgMiwgdmFsdWUpOwp9OwovKioKICogb3B0aW9uYWwgdWludDMyIGFyZWFfaWQgPSAzOwogKiBAcmV0dXJuIHtudW1iZXJ9CiAqLwoKCnByb3RvLnBiLmNtcy5MaXZlTGlzdFJlcXVlc3QucHJvdG90eXBlLmdldEFyZWFJZCA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQodGhpcywgMywgMCk7Cn07Ci8qKgogKiBAcGFyYW0ge251bWJlcn0gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5MaXZlTGlzdFJlcXVlc3R9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuTGl2ZUxpc3RSZXF1ZXN0LnByb3RvdHlwZS5zZXRBcmVhSWQgPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0ludEZpZWxkKHRoaXMsIDMsIHZhbHVlKTsKfTsKLyoqCiAqIG9wdGlvbmFsIHVpbnQzMiBhbmNob3JfaWQgPSA0OwogKiBAcmV0dXJuIHtudW1iZXJ9CiAqLwoKCnByb3RvLnBiLmNtcy5MaXZlTGlzdFJlcXVlc3QucHJvdG90eXBlLmdldEFuY2hvcklkID0gZnVuY3Rpb24gKCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdCh0aGlzLCA0LCAwKTsKfTsKLyoqCiAqIEBwYXJhbSB7bnVtYmVyfSB2YWx1ZQogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLkxpdmVMaXN0UmVxdWVzdH0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5MaXZlTGlzdFJlcXVlc3QucHJvdG90eXBlLnNldEFuY2hvcklkID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRQcm90bzNJbnRGaWVsZCh0aGlzLCA0LCB2YWx1ZSk7Cn07Ci8qKgogKiBvcHRpb25hbCBwYi5SZXZpZXdTdGF0dXMgc3RhdHVzID0gNTsKICogQHJldHVybiB7IXByb3RvLnBiLlJldmlld1N0YXR1c30KICovCgoKcHJvdG8ucGIuY21zLkxpdmVMaXN0UmVxdWVzdC5wcm90b3R5cGUuZ2V0U3RhdHVzID0gZnVuY3Rpb24gKCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdCh0aGlzLCA1LCAwKTsKfTsKLyoqCiAqIEBwYXJhbSB7IXByb3RvLnBiLlJldmlld1N0YXR1c30gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5MaXZlTGlzdFJlcXVlc3R9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuTGl2ZUxpc3RSZXF1ZXN0LnByb3RvdHlwZS5zZXRTdGF0dXMgPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0VudW1GaWVsZCh0aGlzLCA1LCB2YWx1ZSk7Cn07Ci8qKgogKiBvcHRpb25hbCB1aW50MzIgY3JlYXRlZF9zdGFydCA9IDY7CiAqIEByZXR1cm4ge251bWJlcn0KICovCgoKcHJvdG8ucGIuY21zLkxpdmVMaXN0UmVxdWVzdC5wcm90b3R5cGUuZ2V0Q3JlYXRlZFN0YXJ0ID0gZnVuY3Rpb24gKCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdCh0aGlzLCA2LCAwKTsKfTsKLyoqCiAqIEBwYXJhbSB7bnVtYmVyfSB2YWx1ZQogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLkxpdmVMaXN0UmVxdWVzdH0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5MaXZlTGlzdFJlcXVlc3QucHJvdG90eXBlLnNldENyZWF0ZWRTdGFydCA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UHJvdG8zSW50RmllbGQodGhpcywgNiwgdmFsdWUpOwp9OwovKioKICogb3B0aW9uYWwgdWludDMyIGNyZWF0ZWRfZW5kID0gNzsKICogQHJldHVybiB7bnVtYmVyfQogKi8KCgpwcm90by5wYi5jbXMuTGl2ZUxpc3RSZXF1ZXN0LnByb3RvdHlwZS5nZXRDcmVhdGVkRW5kID0gZnVuY3Rpb24gKCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdCh0aGlzLCA3LCAwKTsKfTsKLyoqCiAqIEBwYXJhbSB7bnVtYmVyfSB2YWx1ZQogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLkxpdmVMaXN0UmVxdWVzdH0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5MaXZlTGlzdFJlcXVlc3QucHJvdG90eXBlLnNldENyZWF0ZWRFbmQgPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0ludEZpZWxkKHRoaXMsIDcsIHZhbHVlKTsKfTsKLyoqCiAqIExpc3Qgb2YgcmVwZWF0ZWQgZmllbGRzIHdpdGhpbiB0aGlzIG1lc3NhZ2UgdHlwZS4KICogQHByaXZhdGUgeyFBcnJheTxudW1iZXI+fQogKiBAY29uc3QKICovCgoKcHJvdG8ucGIuY21zLkxpdmVMaXN0UmVwbHkucmVwZWF0ZWRGaWVsZHNfID0gWzFdOwoKaWYgKGpzcGIuTWVzc2FnZS5HRU5FUkFURV9UT19PQkpFQ1QpIHsKICAvKioKICAgKiBDcmVhdGVzIGFuIG9iamVjdCByZXByZXNlbnRhdGlvbiBvZiB0aGlzIHByb3RvLgogICAqIEZpZWxkIG5hbWVzIHRoYXQgYXJlIHJlc2VydmVkIGluIEphdmFTY3JpcHQgYW5kIHdpbGwgYmUgcmVuYW1lZCB0byBwYl9uYW1lLgogICAqIE9wdGlvbmFsIGZpZWxkcyB0aGF0IGFyZSBub3Qgc2V0IHdpbGwgYmUgc2V0IHRvIHVuZGVmaW5lZC4KICAgKiBUbyBhY2Nlc3MgYSByZXNlcnZlZCBmaWVsZCB1c2UsIGZvby5wYl88bmFtZT4sIGVnLCBmb28ucGJfZGVmYXVsdC4KICAgKiBGb3IgdGhlIGxpc3Qgb2YgcmVzZXJ2ZWQgbmFtZXMgcGxlYXNlIHNlZToKICAgKiAgICAgbmV0L3Byb3RvMi9jb21waWxlci9qcy9pbnRlcm5hbC9nZW5lcmF0b3IuY2Mja0tleXdvcmQuCiAgICogQHBhcmFtIHtib29sZWFuPX0gb3B0X2luY2x1ZGVJbnN0YW5jZSBEZXByZWNhdGVkLiB3aGV0aGVyIHRvIGluY2x1ZGUgdGhlCiAgICogICAgIEpTUEIgaW5zdGFuY2UgZm9yIHRyYW5zaXRpb25hbCBzb3kgcHJvdG8gc3VwcG9ydDoKICAgKiAgICAgaHR0cDovL2dvdG8vc295LXBhcmFtLW1pZ3JhdGlvbgogICAqIEByZXR1cm4geyFPYmplY3R9CiAgICovCiAgcHJvdG8ucGIuY21zLkxpdmVMaXN0UmVwbHkucHJvdG90eXBlLnRvT2JqZWN0ID0gZnVuY3Rpb24gKG9wdF9pbmNsdWRlSW5zdGFuY2UpIHsKICAgIHJldHVybiBwcm90by5wYi5jbXMuTGl2ZUxpc3RSZXBseS50b09iamVjdChvcHRfaW5jbHVkZUluc3RhbmNlLCB0aGlzKTsKICB9OwogIC8qKgogICAqIFN0YXRpYyB2ZXJzaW9uIG9mIHRoZSB7QHNlZSB0b09iamVjdH0gbWV0aG9kLgogICAqIEBwYXJhbSB7Ym9vbGVhbnx1bmRlZmluZWR9IGluY2x1ZGVJbnN0YW5jZSBEZXByZWNhdGVkLiBXaGV0aGVyIHRvIGluY2x1ZGUKICAgKiAgICAgdGhlIEpTUEIgaW5zdGFuY2UgZm9yIHRyYW5zaXRpb25hbCBzb3kgcHJvdG8gc3VwcG9ydDoKICAgKiAgICAgaHR0cDovL2dvdG8vc295LXBhcmFtLW1pZ3JhdGlvbgogICAqIEBwYXJhbSB7IXByb3RvLnBiLmNtcy5MaXZlTGlzdFJlcGx5fSBtc2cgVGhlIG1zZyBpbnN0YW5jZSB0byB0cmFuc2Zvcm0uCiAgICogQHJldHVybiB7IU9iamVjdH0KICAgKiBAc3VwcHJlc3Mge3VudXNlZExvY2FsVmFyaWFibGVzfSBmIGlzIG9ubHkgdXNlZCBmb3IgbmVzdGVkIG1lc3NhZ2VzCiAgICovCgoKICBwcm90by5wYi5jbXMuTGl2ZUxpc3RSZXBseS50b09iamVjdCA9IGZ1bmN0aW9uIChpbmNsdWRlSW5zdGFuY2UsIG1zZykgewogICAgdmFyIGYsCiAgICAgICAgb2JqID0gewogICAgICByZWNvcmRzTGlzdDoganNwYi5NZXNzYWdlLnRvT2JqZWN0TGlzdChtc2cuZ2V0UmVjb3Jkc0xpc3QoKSwgdXNlcnR5cGVfcGIuRmlsZVJlY29yZC50b09iamVjdCwgaW5jbHVkZUluc3RhbmNlKSwKICAgICAgcGFnZU5vOiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdChtc2csIDIsIDApLAogICAgICBwYWdlU2l6ZToganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQobXNnLCAzLCAwKSwKICAgICAgdG90YWxQYWdlOiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdChtc2csIDQsIDApLAogICAgICB0b3RhbENvdW50OiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdChtc2csIDUsIDApCiAgICB9OwoKICAgIGlmIChpbmNsdWRlSW5zdGFuY2UpIHsKICAgICAgb2JqLiRqc3BiTWVzc2FnZUluc3RhbmNlID0gbXNnOwogICAgfQoKICAgIHJldHVybiBvYmo7CiAgfTsKfQovKioKICogRGVzZXJpYWxpemVzIGJpbmFyeSBkYXRhIChpbiBwcm90b2J1ZiB3aXJlIGZvcm1hdCkuCiAqIEBwYXJhbSB7anNwYi5CeXRlU291cmNlfSBieXRlcyBUaGUgYnl0ZXMgdG8gZGVzZXJpYWxpemUuCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuTGl2ZUxpc3RSZXBseX0KICovCgoKcHJvdG8ucGIuY21zLkxpdmVMaXN0UmVwbHkuZGVzZXJpYWxpemVCaW5hcnkgPSBmdW5jdGlvbiAoYnl0ZXMpIHsKICB2YXIgcmVhZGVyID0gbmV3IGpzcGIuQmluYXJ5UmVhZGVyKGJ5dGVzKTsKICB2YXIgbXNnID0gbmV3IHByb3RvLnBiLmNtcy5MaXZlTGlzdFJlcGx5KCk7CiAgcmV0dXJuIHByb3RvLnBiLmNtcy5MaXZlTGlzdFJlcGx5LmRlc2VyaWFsaXplQmluYXJ5RnJvbVJlYWRlcihtc2csIHJlYWRlcik7Cn07Ci8qKgogKiBEZXNlcmlhbGl6ZXMgYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUgZm9ybWF0KSBmcm9tIHRoZQogKiBnaXZlbiByZWFkZXIgaW50byB0aGUgZ2l2ZW4gbWVzc2FnZSBvYmplY3QuCiAqIEBwYXJhbSB7IXByb3RvLnBiLmNtcy5MaXZlTGlzdFJlcGx5fSBtc2cgVGhlIG1lc3NhZ2Ugb2JqZWN0IHRvIGRlc2VyaWFsaXplIGludG8uCiAqIEBwYXJhbSB7IWpzcGIuQmluYXJ5UmVhZGVyfSByZWFkZXIgVGhlIEJpbmFyeVJlYWRlciB0byB1c2UuCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuTGl2ZUxpc3RSZXBseX0KICovCgoKcHJvdG8ucGIuY21zLkxpdmVMaXN0UmVwbHkuZGVzZXJpYWxpemVCaW5hcnlGcm9tUmVhZGVyID0gZnVuY3Rpb24gKG1zZywgcmVhZGVyKSB7CiAgd2hpbGUgKHJlYWRlci5uZXh0RmllbGQoKSkgewogICAgaWYgKHJlYWRlci5pc0VuZEdyb3VwKCkpIHsKICAgICAgYnJlYWs7CiAgICB9CgogICAgdmFyIGZpZWxkID0gcmVhZGVyLmdldEZpZWxkTnVtYmVyKCk7CgogICAgc3dpdGNoIChmaWVsZCkgewogICAgICBjYXNlIDE6CiAgICAgICAgdmFyIHZhbHVlID0gbmV3IHVzZXJ0eXBlX3BiLkZpbGVSZWNvcmQoKTsKICAgICAgICByZWFkZXIucmVhZE1lc3NhZ2UodmFsdWUsIHVzZXJ0eXBlX3BiLkZpbGVSZWNvcmQuZGVzZXJpYWxpemVCaW5hcnlGcm9tUmVhZGVyKTsKICAgICAgICBtc2cuYWRkUmVjb3Jkcyh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlIDI6CiAgICAgICAgdmFyIHZhbHVlID0gcmVhZGVyLnJlYWRVaW50MzIoKTsKICAgICAgICBtc2cuc2V0UGFnZU5vKHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgMzoKICAgICAgICB2YXIgdmFsdWUgPSByZWFkZXIucmVhZFVpbnQzMigpOwogICAgICAgIG1zZy5zZXRQYWdlU2l6ZSh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlIDQ6CiAgICAgICAgdmFyIHZhbHVlID0gcmVhZGVyLnJlYWRVaW50MzIoKTsKICAgICAgICBtc2cuc2V0VG90YWxQYWdlKHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgNToKICAgICAgICB2YXIgdmFsdWUgPSByZWFkZXIucmVhZFVpbnQzMigpOwogICAgICAgIG1zZy5zZXRUb3RhbENvdW50KHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGRlZmF1bHQ6CiAgICAgICAgcmVhZGVyLnNraXBGaWVsZCgpOwogICAgICAgIGJyZWFrOwogICAgfQogIH0KCiAgcmV0dXJuIG1zZzsKfTsKLyoqCiAqIFNlcmlhbGl6ZXMgdGhlIG1lc3NhZ2UgdG8gYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUgZm9ybWF0KS4KICogQHJldHVybiB7IVVpbnQ4QXJyYXl9CiAqLwoKCnByb3RvLnBiLmNtcy5MaXZlTGlzdFJlcGx5LnByb3RvdHlwZS5zZXJpYWxpemVCaW5hcnkgPSBmdW5jdGlvbiAoKSB7CiAgdmFyIHdyaXRlciA9IG5ldyBqc3BiLkJpbmFyeVdyaXRlcigpOwogIHByb3RvLnBiLmNtcy5MaXZlTGlzdFJlcGx5LnNlcmlhbGl6ZUJpbmFyeVRvV3JpdGVyKHRoaXMsIHdyaXRlcik7CiAgcmV0dXJuIHdyaXRlci5nZXRSZXN1bHRCdWZmZXIoKTsKfTsKLyoqCiAqIFNlcmlhbGl6ZXMgdGhlIGdpdmVuIG1lc3NhZ2UgdG8gYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUKICogZm9ybWF0KSwgd3JpdGluZyB0byB0aGUgZ2l2ZW4gQmluYXJ5V3JpdGVyLgogKiBAcGFyYW0geyFwcm90by5wYi5jbXMuTGl2ZUxpc3RSZXBseX0gbWVzc2FnZQogKiBAcGFyYW0geyFqc3BiLkJpbmFyeVdyaXRlcn0gd3JpdGVyCiAqIEBzdXBwcmVzcyB7dW51c2VkTG9jYWxWYXJpYWJsZXN9IGYgaXMgb25seSB1c2VkIGZvciBuZXN0ZWQgbWVzc2FnZXMKICovCgoKcHJvdG8ucGIuY21zLkxpdmVMaXN0UmVwbHkuc2VyaWFsaXplQmluYXJ5VG9Xcml0ZXIgPSBmdW5jdGlvbiAobWVzc2FnZSwgd3JpdGVyKSB7CiAgdmFyIGYgPSB1bmRlZmluZWQ7CiAgZiA9IG1lc3NhZ2UuZ2V0UmVjb3Jkc0xpc3QoKTsKCiAgaWYgKGYubGVuZ3RoID4gMCkgewogICAgd3JpdGVyLndyaXRlUmVwZWF0ZWRNZXNzYWdlKDEsIGYsIHVzZXJ0eXBlX3BiLkZpbGVSZWNvcmQuc2VyaWFsaXplQmluYXJ5VG9Xcml0ZXIpOwogIH0KCiAgZiA9IG1lc3NhZ2UuZ2V0UGFnZU5vKCk7CgogIGlmIChmICE9PSAwKSB7CiAgICB3cml0ZXIud3JpdGVVaW50MzIoMiwgZik7CiAgfQoKICBmID0gbWVzc2FnZS5nZXRQYWdlU2l6ZSgpOwoKICBpZiAoZiAhPT0gMCkgewogICAgd3JpdGVyLndyaXRlVWludDMyKDMsIGYpOwogIH0KCiAgZiA9IG1lc3NhZ2UuZ2V0VG90YWxQYWdlKCk7CgogIGlmIChmICE9PSAwKSB7CiAgICB3cml0ZXIud3JpdGVVaW50MzIoNCwgZik7CiAgfQoKICBmID0gbWVzc2FnZS5nZXRUb3RhbENvdW50KCk7CgogIGlmIChmICE9PSAwKSB7CiAgICB3cml0ZXIud3JpdGVVaW50MzIoNSwgZik7CiAgfQp9OwovKioKICogcmVwZWF0ZWQgcGIuRmlsZVJlY29yZCByZWNvcmRzID0gMTsKICogQHJldHVybiB7IUFycmF5PCFwcm90by5wYi5GaWxlUmVjb3JkPn0KICovCgoKcHJvdG8ucGIuY21zLkxpdmVMaXN0UmVwbHkucHJvdG90eXBlLmdldFJlY29yZHNMaXN0ID0gZnVuY3Rpb24gKCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuZ2V0UmVwZWF0ZWRXcmFwcGVyRmllbGQodGhpcywgdXNlcnR5cGVfcGIuRmlsZVJlY29yZCwgMSk7Cn07Ci8qKgogKiBAcGFyYW0geyFBcnJheTwhcHJvdG8ucGIuRmlsZVJlY29yZD59IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuTGl2ZUxpc3RSZXBseX0gcmV0dXJucyB0aGlzCiovCgoKcHJvdG8ucGIuY21zLkxpdmVMaXN0UmVwbHkucHJvdG90eXBlLnNldFJlY29yZHNMaXN0ID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRSZXBlYXRlZFdyYXBwZXJGaWVsZCh0aGlzLCAxLCB2YWx1ZSk7Cn07Ci8qKgogKiBAcGFyYW0geyFwcm90by5wYi5GaWxlUmVjb3JkPX0gb3B0X3ZhbHVlCiAqIEBwYXJhbSB7bnVtYmVyPX0gb3B0X2luZGV4CiAqIEByZXR1cm4geyFwcm90by5wYi5GaWxlUmVjb3JkfQogKi8KCgpwcm90by5wYi5jbXMuTGl2ZUxpc3RSZXBseS5wcm90b3R5cGUuYWRkUmVjb3JkcyA9IGZ1bmN0aW9uIChvcHRfdmFsdWUsIG9wdF9pbmRleCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuYWRkVG9SZXBlYXRlZFdyYXBwZXJGaWVsZCh0aGlzLCAxLCBvcHRfdmFsdWUsIHByb3RvLnBiLkZpbGVSZWNvcmQsIG9wdF9pbmRleCk7Cn07Ci8qKgogKiBDbGVhcnMgdGhlIGxpc3QgbWFraW5nIGl0IGVtcHR5IGJ1dCBub24tbnVsbC4KICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5MaXZlTGlzdFJlcGx5fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLkxpdmVMaXN0UmVwbHkucHJvdG90eXBlLmNsZWFyUmVjb3Jkc0xpc3QgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIHRoaXMuc2V0UmVjb3Jkc0xpc3QoW10pOwp9OwovKioKICogb3B0aW9uYWwgdWludDMyIHBhZ2Vfbm8gPSAyOwogKiBAcmV0dXJuIHtudW1iZXJ9CiAqLwoKCnByb3RvLnBiLmNtcy5MaXZlTGlzdFJlcGx5LnByb3RvdHlwZS5nZXRQYWdlTm8gPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDIsIDApOwp9OwovKioKICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuTGl2ZUxpc3RSZXBseX0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5MaXZlTGlzdFJlcGx5LnByb3RvdHlwZS5zZXRQYWdlTm8gPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0ludEZpZWxkKHRoaXMsIDIsIHZhbHVlKTsKfTsKLyoqCiAqIG9wdGlvbmFsIHVpbnQzMiBwYWdlX3NpemUgPSAzOwogKiBAcmV0dXJuIHtudW1iZXJ9CiAqLwoKCnByb3RvLnBiLmNtcy5MaXZlTGlzdFJlcGx5LnByb3RvdHlwZS5nZXRQYWdlU2l6ZSA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQodGhpcywgMywgMCk7Cn07Ci8qKgogKiBAcGFyYW0ge251bWJlcn0gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5MaXZlTGlzdFJlcGx5fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLkxpdmVMaXN0UmVwbHkucHJvdG90eXBlLnNldFBhZ2VTaXplID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRQcm90bzNJbnRGaWVsZCh0aGlzLCAzLCB2YWx1ZSk7Cn07Ci8qKgogKiBvcHRpb25hbCB1aW50MzIgdG90YWxfcGFnZSA9IDQ7CiAqIEByZXR1cm4ge251bWJlcn0KICovCgoKcHJvdG8ucGIuY21zLkxpdmVMaXN0UmVwbHkucHJvdG90eXBlLmdldFRvdGFsUGFnZSA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQodGhpcywgNCwgMCk7Cn07Ci8qKgogKiBAcGFyYW0ge251bWJlcn0gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5MaXZlTGlzdFJlcGx5fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLkxpdmVMaXN0UmVwbHkucHJvdG90eXBlLnNldFRvdGFsUGFnZSA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UHJvdG8zSW50RmllbGQodGhpcywgNCwgdmFsdWUpOwp9OwovKioKICogb3B0aW9uYWwgdWludDMyIHRvdGFsX2NvdW50ID0gNTsKICogQHJldHVybiB7bnVtYmVyfQogKi8KCgpwcm90by5wYi5jbXMuTGl2ZUxpc3RSZXBseS5wcm90b3R5cGUuZ2V0VG90YWxDb3VudCA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQodGhpcywgNSwgMCk7Cn07Ci8qKgogKiBAcGFyYW0ge251bWJlcn0gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5MaXZlTGlzdFJlcGx5fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLkxpdmVMaXN0UmVwbHkucHJvdG90eXBlLnNldFRvdGFsQ291bnQgPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0ludEZpZWxkKHRoaXMsIDUsIHZhbHVlKTsKfTsKCmlmIChqc3BiLk1lc3NhZ2UuR0VORVJBVEVfVE9fT0JKRUNUKSB7CiAgLyoqCiAgICogQ3JlYXRlcyBhbiBvYmplY3QgcmVwcmVzZW50YXRpb24gb2YgdGhpcyBwcm90by4KICAgKiBGaWVsZCBuYW1lcyB0aGF0IGFyZSByZXNlcnZlZCBpbiBKYXZhU2NyaXB0IGFuZCB3aWxsIGJlIHJlbmFtZWQgdG8gcGJfbmFtZS4KICAgKiBPcHRpb25hbCBmaWVsZHMgdGhhdCBhcmUgbm90IHNldCB3aWxsIGJlIHNldCB0byB1bmRlZmluZWQuCiAgICogVG8gYWNjZXNzIGEgcmVzZXJ2ZWQgZmllbGQgdXNlLCBmb28ucGJfPG5hbWU+LCBlZywgZm9vLnBiX2RlZmF1bHQuCiAgICogRm9yIHRoZSBsaXN0IG9mIHJlc2VydmVkIG5hbWVzIHBsZWFzZSBzZWU6CiAgICogICAgIG5ldC9wcm90bzIvY29tcGlsZXIvanMvaW50ZXJuYWwvZ2VuZXJhdG9yLmNjI2tLZXl3b3JkLgogICAqIEBwYXJhbSB7Ym9vbGVhbj19IG9wdF9pbmNsdWRlSW5zdGFuY2UgRGVwcmVjYXRlZC4gd2hldGhlciB0byBpbmNsdWRlIHRoZQogICAqICAgICBKU1BCIGluc3RhbmNlIGZvciB0cmFuc2l0aW9uYWwgc295IHByb3RvIHN1cHBvcnQ6CiAgICogICAgIGh0dHA6Ly9nb3RvL3NveS1wYXJhbS1taWdyYXRpb24KICAgKiBAcmV0dXJuIHshT2JqZWN0fQogICAqLwogIHByb3RvLnBiLmNtcy5QYXlMaXN0UmVxdWVzdC5wcm90b3R5cGUudG9PYmplY3QgPSBmdW5jdGlvbiAob3B0X2luY2x1ZGVJbnN0YW5jZSkgewogICAgcmV0dXJuIHByb3RvLnBiLmNtcy5QYXlMaXN0UmVxdWVzdC50b09iamVjdChvcHRfaW5jbHVkZUluc3RhbmNlLCB0aGlzKTsKICB9OwogIC8qKgogICAqIFN0YXRpYyB2ZXJzaW9uIG9mIHRoZSB7QHNlZSB0b09iamVjdH0gbWV0aG9kLgogICAqIEBwYXJhbSB7Ym9vbGVhbnx1bmRlZmluZWR9IGluY2x1ZGVJbnN0YW5jZSBEZXByZWNhdGVkLiBXaGV0aGVyIHRvIGluY2x1ZGUKICAgKiAgICAgdGhlIEpTUEIgaW5zdGFuY2UgZm9yIHRyYW5zaXRpb25hbCBzb3kgcHJvdG8gc3VwcG9ydDoKICAgKiAgICAgaHR0cDovL2dvdG8vc295LXBhcmFtLW1pZ3JhdGlvbgogICAqIEBwYXJhbSB7IXByb3RvLnBiLmNtcy5QYXlMaXN0UmVxdWVzdH0gbXNnIFRoZSBtc2cgaW5zdGFuY2UgdG8gdHJhbnNmb3JtLgogICAqIEByZXR1cm4geyFPYmplY3R9CiAgICogQHN1cHByZXNzIHt1bnVzZWRMb2NhbFZhcmlhYmxlc30gZiBpcyBvbmx5IHVzZWQgZm9yIG5lc3RlZCBtZXNzYWdlcwogICAqLwoKCiAgcHJvdG8ucGIuY21zLlBheUxpc3RSZXF1ZXN0LnRvT2JqZWN0ID0gZnVuY3Rpb24gKGluY2x1ZGVJbnN0YW5jZSwgbXNnKSB7CiAgICB2YXIgZiwKICAgICAgICBvYmogPSB7CiAgICAgIHBhZ2VObzoganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQobXNnLCAxLCAwKSwKICAgICAgcGFnZVNpemU6IGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KG1zZywgMiwgMCksCiAgICAgIGFyZWFJZDoganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQobXNnLCAzLCAwKSwKICAgICAgYXBwSWQ6IGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KG1zZywgNCwgMCksCiAgICAgIHVzZXJJZDoganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQobXNnLCA1LCAwKSwKICAgICAgcmVjb3JkSWQ6IGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KG1zZywgNiwgMCksCiAgICAgIHN0YXR1czoganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQobXNnLCA3LCAwKSwKICAgICAgY3JlYXRlZFN0YXJ0OiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdChtc2csIDgsIDApLAogICAgICBjcmVhdGVkRW5kOiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdChtc2csIDksIDApCiAgICB9OwoKICAgIGlmIChpbmNsdWRlSW5zdGFuY2UpIHsKICAgICAgb2JqLiRqc3BiTWVzc2FnZUluc3RhbmNlID0gbXNnOwogICAgfQoKICAgIHJldHVybiBvYmo7CiAgfTsKfQovKioKICogRGVzZXJpYWxpemVzIGJpbmFyeSBkYXRhIChpbiBwcm90b2J1ZiB3aXJlIGZvcm1hdCkuCiAqIEBwYXJhbSB7anNwYi5CeXRlU291cmNlfSBieXRlcyBUaGUgYnl0ZXMgdG8gZGVzZXJpYWxpemUuCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuUGF5TGlzdFJlcXVlc3R9CiAqLwoKCnByb3RvLnBiLmNtcy5QYXlMaXN0UmVxdWVzdC5kZXNlcmlhbGl6ZUJpbmFyeSA9IGZ1bmN0aW9uIChieXRlcykgewogIHZhciByZWFkZXIgPSBuZXcganNwYi5CaW5hcnlSZWFkZXIoYnl0ZXMpOwogIHZhciBtc2cgPSBuZXcgcHJvdG8ucGIuY21zLlBheUxpc3RSZXF1ZXN0KCk7CiAgcmV0dXJuIHByb3RvLnBiLmNtcy5QYXlMaXN0UmVxdWVzdC5kZXNlcmlhbGl6ZUJpbmFyeUZyb21SZWFkZXIobXNnLCByZWFkZXIpOwp9OwovKioKICogRGVzZXJpYWxpemVzIGJpbmFyeSBkYXRhIChpbiBwcm90b2J1ZiB3aXJlIGZvcm1hdCkgZnJvbSB0aGUKICogZ2l2ZW4gcmVhZGVyIGludG8gdGhlIGdpdmVuIG1lc3NhZ2Ugb2JqZWN0LgogKiBAcGFyYW0geyFwcm90by5wYi5jbXMuUGF5TGlzdFJlcXVlc3R9IG1zZyBUaGUgbWVzc2FnZSBvYmplY3QgdG8gZGVzZXJpYWxpemUgaW50by4KICogQHBhcmFtIHshanNwYi5CaW5hcnlSZWFkZXJ9IHJlYWRlciBUaGUgQmluYXJ5UmVhZGVyIHRvIHVzZS4KICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5QYXlMaXN0UmVxdWVzdH0KICovCgoKcHJvdG8ucGIuY21zLlBheUxpc3RSZXF1ZXN0LmRlc2VyaWFsaXplQmluYXJ5RnJvbVJlYWRlciA9IGZ1bmN0aW9uIChtc2csIHJlYWRlcikgewogIHdoaWxlIChyZWFkZXIubmV4dEZpZWxkKCkpIHsKICAgIGlmIChyZWFkZXIuaXNFbmRHcm91cCgpKSB7CiAgICAgIGJyZWFrOwogICAgfQoKICAgIHZhciBmaWVsZCA9IHJlYWRlci5nZXRGaWVsZE51bWJlcigpOwoKICAgIHN3aXRjaCAoZmllbGQpIHsKICAgICAgY2FzZSAxOgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkVWludDMyKCk7CiAgICAgICAgbXNnLnNldFBhZ2VObyh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlIDI6CiAgICAgICAgdmFyIHZhbHVlID0gcmVhZGVyLnJlYWRVaW50MzIoKTsKICAgICAgICBtc2cuc2V0UGFnZVNpemUodmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSAzOgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkVWludDMyKCk7CiAgICAgICAgbXNnLnNldEFyZWFJZCh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlIDQ6CiAgICAgICAgdmFyIHZhbHVlID0gcmVhZGVyLnJlYWRVaW50MzIoKTsKICAgICAgICBtc2cuc2V0QXBwSWQodmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSA1OgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkVWludDMyKCk7CiAgICAgICAgbXNnLnNldFVzZXJJZCh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlIDY6CiAgICAgICAgdmFyIHZhbHVlID0gcmVhZGVyLnJlYWRVaW50NjQoKTsKICAgICAgICBtc2cuc2V0UmVjb3JkSWQodmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSA3OgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkRW51bSgpOwogICAgICAgIG1zZy5zZXRTdGF0dXModmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSA4OgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkVWludDMyKCk7CiAgICAgICAgbXNnLnNldENyZWF0ZWRTdGFydCh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlIDk6CiAgICAgICAgdmFyIHZhbHVlID0gcmVhZGVyLnJlYWRVaW50MzIoKTsKICAgICAgICBtc2cuc2V0Q3JlYXRlZEVuZCh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBkZWZhdWx0OgogICAgICAgIHJlYWRlci5za2lwRmllbGQoKTsKICAgICAgICBicmVhazsKICAgIH0KICB9CgogIHJldHVybiBtc2c7Cn07Ci8qKgogKiBTZXJpYWxpemVzIHRoZSBtZXNzYWdlIHRvIGJpbmFyeSBkYXRhIChpbiBwcm90b2J1ZiB3aXJlIGZvcm1hdCkuCiAqIEByZXR1cm4geyFVaW50OEFycmF5fQogKi8KCgpwcm90by5wYi5jbXMuUGF5TGlzdFJlcXVlc3QucHJvdG90eXBlLnNlcmlhbGl6ZUJpbmFyeSA9IGZ1bmN0aW9uICgpIHsKICB2YXIgd3JpdGVyID0gbmV3IGpzcGIuQmluYXJ5V3JpdGVyKCk7CiAgcHJvdG8ucGIuY21zLlBheUxpc3RSZXF1ZXN0LnNlcmlhbGl6ZUJpbmFyeVRvV3JpdGVyKHRoaXMsIHdyaXRlcik7CiAgcmV0dXJuIHdyaXRlci5nZXRSZXN1bHRCdWZmZXIoKTsKfTsKLyoqCiAqIFNlcmlhbGl6ZXMgdGhlIGdpdmVuIG1lc3NhZ2UgdG8gYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUKICogZm9ybWF0KSwgd3JpdGluZyB0byB0aGUgZ2l2ZW4gQmluYXJ5V3JpdGVyLgogKiBAcGFyYW0geyFwcm90by5wYi5jbXMuUGF5TGlzdFJlcXVlc3R9IG1lc3NhZ2UKICogQHBhcmFtIHshanNwYi5CaW5hcnlXcml0ZXJ9IHdyaXRlcgogKiBAc3VwcHJlc3Mge3VudXNlZExvY2FsVmFyaWFibGVzfSBmIGlzIG9ubHkgdXNlZCBmb3IgbmVzdGVkIG1lc3NhZ2VzCiAqLwoKCnByb3RvLnBiLmNtcy5QYXlMaXN0UmVxdWVzdC5zZXJpYWxpemVCaW5hcnlUb1dyaXRlciA9IGZ1bmN0aW9uIChtZXNzYWdlLCB3cml0ZXIpIHsKICB2YXIgZiA9IHVuZGVmaW5lZDsKICBmID0gbWVzc2FnZS5nZXRQYWdlTm8oKTsKCiAgaWYgKGYgIT09IDApIHsKICAgIHdyaXRlci53cml0ZVVpbnQzMigxLCBmKTsKICB9CgogIGYgPSBtZXNzYWdlLmdldFBhZ2VTaXplKCk7CgogIGlmIChmICE9PSAwKSB7CiAgICB3cml0ZXIud3JpdGVVaW50MzIoMiwgZik7CiAgfQoKICBmID0gbWVzc2FnZS5nZXRBcmVhSWQoKTsKCiAgaWYgKGYgIT09IDApIHsKICAgIHdyaXRlci53cml0ZVVpbnQzMigzLCBmKTsKICB9CgogIGYgPSBtZXNzYWdlLmdldEFwcElkKCk7CgogIGlmIChmICE9PSAwKSB7CiAgICB3cml0ZXIud3JpdGVVaW50MzIoNCwgZik7CiAgfQoKICBmID0gbWVzc2FnZS5nZXRVc2VySWQoKTsKCiAgaWYgKGYgIT09IDApIHsKICAgIHdyaXRlci53cml0ZVVpbnQzMig1LCBmKTsKICB9CgogIGYgPSBtZXNzYWdlLmdldFJlY29yZElkKCk7CgogIGlmIChmICE9PSAwKSB7CiAgICB3cml0ZXIud3JpdGVVaW50NjQoNiwgZik7CiAgfQoKICBmID0gbWVzc2FnZS5nZXRTdGF0dXMoKTsKCiAgaWYgKGYgIT09IDAuMCkgewogICAgd3JpdGVyLndyaXRlRW51bSg3LCBmKTsKICB9CgogIGYgPSBtZXNzYWdlLmdldENyZWF0ZWRTdGFydCgpOwoKICBpZiAoZiAhPT0gMCkgewogICAgd3JpdGVyLndyaXRlVWludDMyKDgsIGYpOwogIH0KCiAgZiA9IG1lc3NhZ2UuZ2V0Q3JlYXRlZEVuZCgpOwoKICBpZiAoZiAhPT0gMCkgewogICAgd3JpdGVyLndyaXRlVWludDMyKDksIGYpOwogIH0KfTsKLyoqCiAqIG9wdGlvbmFsIHVpbnQzMiBwYWdlX25vID0gMTsKICogQHJldHVybiB7bnVtYmVyfQogKi8KCgpwcm90by5wYi5jbXMuUGF5TGlzdFJlcXVlc3QucHJvdG90eXBlLmdldFBhZ2VObyA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQodGhpcywgMSwgMCk7Cn07Ci8qKgogKiBAcGFyYW0ge251bWJlcn0gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5QYXlMaXN0UmVxdWVzdH0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5QYXlMaXN0UmVxdWVzdC5wcm90b3R5cGUuc2V0UGFnZU5vID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRQcm90bzNJbnRGaWVsZCh0aGlzLCAxLCB2YWx1ZSk7Cn07Ci8qKgogKiBvcHRpb25hbCB1aW50MzIgcGFnZV9zaXplID0gMjsKICogQHJldHVybiB7bnVtYmVyfQogKi8KCgpwcm90by5wYi5jbXMuUGF5TGlzdFJlcXVlc3QucHJvdG90eXBlLmdldFBhZ2VTaXplID0gZnVuY3Rpb24gKCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdCh0aGlzLCAyLCAwKTsKfTsKLyoqCiAqIEBwYXJhbSB7bnVtYmVyfSB2YWx1ZQogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLlBheUxpc3RSZXF1ZXN0fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLlBheUxpc3RSZXF1ZXN0LnByb3RvdHlwZS5zZXRQYWdlU2l6ZSA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UHJvdG8zSW50RmllbGQodGhpcywgMiwgdmFsdWUpOwp9OwovKioKICogb3B0aW9uYWwgdWludDMyIGFyZWFfaWQgPSAzOwogKiBAcmV0dXJuIHtudW1iZXJ9CiAqLwoKCnByb3RvLnBiLmNtcy5QYXlMaXN0UmVxdWVzdC5wcm90b3R5cGUuZ2V0QXJlYUlkID0gZnVuY3Rpb24gKCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdCh0aGlzLCAzLCAwKTsKfTsKLyoqCiAqIEBwYXJhbSB7bnVtYmVyfSB2YWx1ZQogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLlBheUxpc3RSZXF1ZXN0fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLlBheUxpc3RSZXF1ZXN0LnByb3RvdHlwZS5zZXRBcmVhSWQgPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0ludEZpZWxkKHRoaXMsIDMsIHZhbHVlKTsKfTsKLyoqCiAqIG9wdGlvbmFsIHVpbnQzMiBhcHBfaWQgPSA0OwogKiBAcmV0dXJuIHtudW1iZXJ9CiAqLwoKCnByb3RvLnBiLmNtcy5QYXlMaXN0UmVxdWVzdC5wcm90b3R5cGUuZ2V0QXBwSWQgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDQsIDApOwp9OwovKioKICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuUGF5TGlzdFJlcXVlc3R9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuUGF5TGlzdFJlcXVlc3QucHJvdG90eXBlLnNldEFwcElkID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRQcm90bzNJbnRGaWVsZCh0aGlzLCA0LCB2YWx1ZSk7Cn07Ci8qKgogKiBvcHRpb25hbCB1aW50MzIgdXNlcl9pZCA9IDU7CiAqIEByZXR1cm4ge251bWJlcn0KICovCgoKcHJvdG8ucGIuY21zLlBheUxpc3RSZXF1ZXN0LnByb3RvdHlwZS5nZXRVc2VySWQgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDUsIDApOwp9OwovKioKICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuUGF5TGlzdFJlcXVlc3R9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuUGF5TGlzdFJlcXVlc3QucHJvdG90eXBlLnNldFVzZXJJZCA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UHJvdG8zSW50RmllbGQodGhpcywgNSwgdmFsdWUpOwp9OwovKioKICogb3B0aW9uYWwgdWludDY0IHJlY29yZF9pZCA9IDY7CiAqIEByZXR1cm4ge251bWJlcn0KICovCgoKcHJvdG8ucGIuY21zLlBheUxpc3RSZXF1ZXN0LnByb3RvdHlwZS5nZXRSZWNvcmRJZCA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQodGhpcywgNiwgMCk7Cn07Ci8qKgogKiBAcGFyYW0ge251bWJlcn0gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5QYXlMaXN0UmVxdWVzdH0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5QYXlMaXN0UmVxdWVzdC5wcm90b3R5cGUuc2V0UmVjb3JkSWQgPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0ludEZpZWxkKHRoaXMsIDYsIHZhbHVlKTsKfTsKLyoqCiAqIG9wdGlvbmFsIHBiLlBheVN0YXR1cyBzdGF0dXMgPSA3OwogKiBAcmV0dXJuIHshcHJvdG8ucGIuUGF5U3RhdHVzfQogKi8KCgpwcm90by5wYi5jbXMuUGF5TGlzdFJlcXVlc3QucHJvdG90eXBlLmdldFN0YXR1cyA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQodGhpcywgNywgMCk7Cn07Ci8qKgogKiBAcGFyYW0geyFwcm90by5wYi5QYXlTdGF0dXN9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuUGF5TGlzdFJlcXVlc3R9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuUGF5TGlzdFJlcXVlc3QucHJvdG90eXBlLnNldFN0YXR1cyA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UHJvdG8zRW51bUZpZWxkKHRoaXMsIDcsIHZhbHVlKTsKfTsKLyoqCiAqIG9wdGlvbmFsIHVpbnQzMiBjcmVhdGVkX3N0YXJ0ID0gODsKICogQHJldHVybiB7bnVtYmVyfQogKi8KCgpwcm90by5wYi5jbXMuUGF5TGlzdFJlcXVlc3QucHJvdG90eXBlLmdldENyZWF0ZWRTdGFydCA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQodGhpcywgOCwgMCk7Cn07Ci8qKgogKiBAcGFyYW0ge251bWJlcn0gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5QYXlMaXN0UmVxdWVzdH0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5QYXlMaXN0UmVxdWVzdC5wcm90b3R5cGUuc2V0Q3JlYXRlZFN0YXJ0ID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRQcm90bzNJbnRGaWVsZCh0aGlzLCA4LCB2YWx1ZSk7Cn07Ci8qKgogKiBvcHRpb25hbCB1aW50MzIgY3JlYXRlZF9lbmQgPSA5OwogKiBAcmV0dXJuIHtudW1iZXJ9CiAqLwoKCnByb3RvLnBiLmNtcy5QYXlMaXN0UmVxdWVzdC5wcm90b3R5cGUuZ2V0Q3JlYXRlZEVuZCA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQodGhpcywgOSwgMCk7Cn07Ci8qKgogKiBAcGFyYW0ge251bWJlcn0gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5QYXlMaXN0UmVxdWVzdH0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5QYXlMaXN0UmVxdWVzdC5wcm90b3R5cGUuc2V0Q3JlYXRlZEVuZCA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UHJvdG8zSW50RmllbGQodGhpcywgOSwgdmFsdWUpOwp9OwovKioKICogTGlzdCBvZiByZXBlYXRlZCBmaWVsZHMgd2l0aGluIHRoaXMgbWVzc2FnZSB0eXBlLgogKiBAcHJpdmF0ZSB7IUFycmF5PG51bWJlcj59CiAqIEBjb25zdAogKi8KCgpwcm90by5wYi5jbXMuUGF5TGlzdFJlcGx5LnJlcGVhdGVkRmllbGRzXyA9IFsxXTsKCmlmIChqc3BiLk1lc3NhZ2UuR0VORVJBVEVfVE9fT0JKRUNUKSB7CiAgLyoqCiAgICogQ3JlYXRlcyBhbiBvYmplY3QgcmVwcmVzZW50YXRpb24gb2YgdGhpcyBwcm90by4KICAgKiBGaWVsZCBuYW1lcyB0aGF0IGFyZSByZXNlcnZlZCBpbiBKYXZhU2NyaXB0IGFuZCB3aWxsIGJlIHJlbmFtZWQgdG8gcGJfbmFtZS4KICAgKiBPcHRpb25hbCBmaWVsZHMgdGhhdCBhcmUgbm90IHNldCB3aWxsIGJlIHNldCB0byB1bmRlZmluZWQuCiAgICogVG8gYWNjZXNzIGEgcmVzZXJ2ZWQgZmllbGQgdXNlLCBmb28ucGJfPG5hbWU+LCBlZywgZm9vLnBiX2RlZmF1bHQuCiAgICogRm9yIHRoZSBsaXN0IG9mIHJlc2VydmVkIG5hbWVzIHBsZWFzZSBzZWU6CiAgICogICAgIG5ldC9wcm90bzIvY29tcGlsZXIvanMvaW50ZXJuYWwvZ2VuZXJhdG9yLmNjI2tLZXl3b3JkLgogICAqIEBwYXJhbSB7Ym9vbGVhbj19IG9wdF9pbmNsdWRlSW5zdGFuY2UgRGVwcmVjYXRlZC4gd2hldGhlciB0byBpbmNsdWRlIHRoZQogICAqICAgICBKU1BCIGluc3RhbmNlIGZvciB0cmFuc2l0aW9uYWwgc295IHByb3RvIHN1cHBvcnQ6CiAgICogICAgIGh0dHA6Ly9nb3RvL3NveS1wYXJhbS1taWdyYXRpb24KICAgKiBAcmV0dXJuIHshT2JqZWN0fQogICAqLwogIHByb3RvLnBiLmNtcy5QYXlMaXN0UmVwbHkucHJvdG90eXBlLnRvT2JqZWN0ID0gZnVuY3Rpb24gKG9wdF9pbmNsdWRlSW5zdGFuY2UpIHsKICAgIHJldHVybiBwcm90by5wYi5jbXMuUGF5TGlzdFJlcGx5LnRvT2JqZWN0KG9wdF9pbmNsdWRlSW5zdGFuY2UsIHRoaXMpOwogIH07CiAgLyoqCiAgICogU3RhdGljIHZlcnNpb24gb2YgdGhlIHtAc2VlIHRvT2JqZWN0fSBtZXRob2QuCiAgICogQHBhcmFtIHtib29sZWFufHVuZGVmaW5lZH0gaW5jbHVkZUluc3RhbmNlIERlcHJlY2F0ZWQuIFdoZXRoZXIgdG8gaW5jbHVkZQogICAqICAgICB0aGUgSlNQQiBpbnN0YW5jZSBmb3IgdHJhbnNpdGlvbmFsIHNveSBwcm90byBzdXBwb3J0OgogICAqICAgICBodHRwOi8vZ290by9zb3ktcGFyYW0tbWlncmF0aW9uCiAgICogQHBhcmFtIHshcHJvdG8ucGIuY21zLlBheUxpc3RSZXBseX0gbXNnIFRoZSBtc2cgaW5zdGFuY2UgdG8gdHJhbnNmb3JtLgogICAqIEByZXR1cm4geyFPYmplY3R9CiAgICogQHN1cHByZXNzIHt1bnVzZWRMb2NhbFZhcmlhYmxlc30gZiBpcyBvbmx5IHVzZWQgZm9yIG5lc3RlZCBtZXNzYWdlcwogICAqLwoKCiAgcHJvdG8ucGIuY21zLlBheUxpc3RSZXBseS50b09iamVjdCA9IGZ1bmN0aW9uIChpbmNsdWRlSW5zdGFuY2UsIG1zZykgewogICAgdmFyIGYsCiAgICAgICAgb2JqID0gewogICAgICByZWNvcmRzTGlzdDoganNwYi5NZXNzYWdlLnRvT2JqZWN0TGlzdChtc2cuZ2V0UmVjb3Jkc0xpc3QoKSwgdXNlcnR5cGVfcGIuUGF5UmVjb3JkLnRvT2JqZWN0LCBpbmNsdWRlSW5zdGFuY2UpLAogICAgICBwYWdlTm86IGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KG1zZywgMiwgMCksCiAgICAgIHBhZ2VTaXplOiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdChtc2csIDMsIDApLAogICAgICB0b3RhbFBhZ2U6IGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KG1zZywgNCwgMCksCiAgICAgIHRvdGFsQ291bnQ6IGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KG1zZywgNSwgMCkKICAgIH07CgogICAgaWYgKGluY2x1ZGVJbnN0YW5jZSkgewogICAgICBvYmouJGpzcGJNZXNzYWdlSW5zdGFuY2UgPSBtc2c7CiAgICB9CgogICAgcmV0dXJuIG9iajsKICB9Owp9Ci8qKgogKiBEZXNlcmlhbGl6ZXMgYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUgZm9ybWF0KS4KICogQHBhcmFtIHtqc3BiLkJ5dGVTb3VyY2V9IGJ5dGVzIFRoZSBieXRlcyB0byBkZXNlcmlhbGl6ZS4KICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5QYXlMaXN0UmVwbHl9CiAqLwoKCnByb3RvLnBiLmNtcy5QYXlMaXN0UmVwbHkuZGVzZXJpYWxpemVCaW5hcnkgPSBmdW5jdGlvbiAoYnl0ZXMpIHsKICB2YXIgcmVhZGVyID0gbmV3IGpzcGIuQmluYXJ5UmVhZGVyKGJ5dGVzKTsKICB2YXIgbXNnID0gbmV3IHByb3RvLnBiLmNtcy5QYXlMaXN0UmVwbHkoKTsKICByZXR1cm4gcHJvdG8ucGIuY21zLlBheUxpc3RSZXBseS5kZXNlcmlhbGl6ZUJpbmFyeUZyb21SZWFkZXIobXNnLCByZWFkZXIpOwp9OwovKioKICogRGVzZXJpYWxpemVzIGJpbmFyeSBkYXRhIChpbiBwcm90b2J1ZiB3aXJlIGZvcm1hdCkgZnJvbSB0aGUKICogZ2l2ZW4gcmVhZGVyIGludG8gdGhlIGdpdmVuIG1lc3NhZ2Ugb2JqZWN0LgogKiBAcGFyYW0geyFwcm90by5wYi5jbXMuUGF5TGlzdFJlcGx5fSBtc2cgVGhlIG1lc3NhZ2Ugb2JqZWN0IHRvIGRlc2VyaWFsaXplIGludG8uCiAqIEBwYXJhbSB7IWpzcGIuQmluYXJ5UmVhZGVyfSByZWFkZXIgVGhlIEJpbmFyeVJlYWRlciB0byB1c2UuCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuUGF5TGlzdFJlcGx5fQogKi8KCgpwcm90by5wYi5jbXMuUGF5TGlzdFJlcGx5LmRlc2VyaWFsaXplQmluYXJ5RnJvbVJlYWRlciA9IGZ1bmN0aW9uIChtc2csIHJlYWRlcikgewogIHdoaWxlIChyZWFkZXIubmV4dEZpZWxkKCkpIHsKICAgIGlmIChyZWFkZXIuaXNFbmRHcm91cCgpKSB7CiAgICAgIGJyZWFrOwogICAgfQoKICAgIHZhciBmaWVsZCA9IHJlYWRlci5nZXRGaWVsZE51bWJlcigpOwoKICAgIHN3aXRjaCAoZmllbGQpIHsKICAgICAgY2FzZSAxOgogICAgICAgIHZhciB2YWx1ZSA9IG5ldyB1c2VydHlwZV9wYi5QYXlSZWNvcmQoKTsKICAgICAgICByZWFkZXIucmVhZE1lc3NhZ2UodmFsdWUsIHVzZXJ0eXBlX3BiLlBheVJlY29yZC5kZXNlcmlhbGl6ZUJpbmFyeUZyb21SZWFkZXIpOwogICAgICAgIG1zZy5hZGRSZWNvcmRzKHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgMjoKICAgICAgICB2YXIgdmFsdWUgPSByZWFkZXIucmVhZFVpbnQzMigpOwogICAgICAgIG1zZy5zZXRQYWdlTm8odmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSAzOgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkVWludDMyKCk7CiAgICAgICAgbXNnLnNldFBhZ2VTaXplKHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgNDoKICAgICAgICB2YXIgdmFsdWUgPSByZWFkZXIucmVhZFVpbnQzMigpOwogICAgICAgIG1zZy5zZXRUb3RhbFBhZ2UodmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSA1OgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkVWludDMyKCk7CiAgICAgICAgbXNnLnNldFRvdGFsQ291bnQodmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgZGVmYXVsdDoKICAgICAgICByZWFkZXIuc2tpcEZpZWxkKCk7CiAgICAgICAgYnJlYWs7CiAgICB9CiAgfQoKICByZXR1cm4gbXNnOwp9OwovKioKICogU2VyaWFsaXplcyB0aGUgbWVzc2FnZSB0byBiaW5hcnkgZGF0YSAoaW4gcHJvdG9idWYgd2lyZSBmb3JtYXQpLgogKiBAcmV0dXJuIHshVWludDhBcnJheX0KICovCgoKcHJvdG8ucGIuY21zLlBheUxpc3RSZXBseS5wcm90b3R5cGUuc2VyaWFsaXplQmluYXJ5ID0gZnVuY3Rpb24gKCkgewogIHZhciB3cml0ZXIgPSBuZXcganNwYi5CaW5hcnlXcml0ZXIoKTsKICBwcm90by5wYi5jbXMuUGF5TGlzdFJlcGx5LnNlcmlhbGl6ZUJpbmFyeVRvV3JpdGVyKHRoaXMsIHdyaXRlcik7CiAgcmV0dXJuIHdyaXRlci5nZXRSZXN1bHRCdWZmZXIoKTsKfTsKLyoqCiAqIFNlcmlhbGl6ZXMgdGhlIGdpdmVuIG1lc3NhZ2UgdG8gYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUKICogZm9ybWF0KSwgd3JpdGluZyB0byB0aGUgZ2l2ZW4gQmluYXJ5V3JpdGVyLgogKiBAcGFyYW0geyFwcm90by5wYi5jbXMuUGF5TGlzdFJlcGx5fSBtZXNzYWdlCiAqIEBwYXJhbSB7IWpzcGIuQmluYXJ5V3JpdGVyfSB3cml0ZXIKICogQHN1cHByZXNzIHt1bnVzZWRMb2NhbFZhcmlhYmxlc30gZiBpcyBvbmx5IHVzZWQgZm9yIG5lc3RlZCBtZXNzYWdlcwogKi8KCgpwcm90by5wYi5jbXMuUGF5TGlzdFJlcGx5LnNlcmlhbGl6ZUJpbmFyeVRvV3JpdGVyID0gZnVuY3Rpb24gKG1lc3NhZ2UsIHdyaXRlcikgewogIHZhciBmID0gdW5kZWZpbmVkOwogIGYgPSBtZXNzYWdlLmdldFJlY29yZHNMaXN0KCk7CgogIGlmIChmLmxlbmd0aCA+IDApIHsKICAgIHdyaXRlci53cml0ZVJlcGVhdGVkTWVzc2FnZSgxLCBmLCB1c2VydHlwZV9wYi5QYXlSZWNvcmQuc2VyaWFsaXplQmluYXJ5VG9Xcml0ZXIpOwogIH0KCiAgZiA9IG1lc3NhZ2UuZ2V0UGFnZU5vKCk7CgogIGlmIChmICE9PSAwKSB7CiAgICB3cml0ZXIud3JpdGVVaW50MzIoMiwgZik7CiAgfQoKICBmID0gbWVzc2FnZS5nZXRQYWdlU2l6ZSgpOwoKICBpZiAoZiAhPT0gMCkgewogICAgd3JpdGVyLndyaXRlVWludDMyKDMsIGYpOwogIH0KCiAgZiA9IG1lc3NhZ2UuZ2V0VG90YWxQYWdlKCk7CgogIGlmIChmICE9PSAwKSB7CiAgICB3cml0ZXIud3JpdGVVaW50MzIoNCwgZik7CiAgfQoKICBmID0gbWVzc2FnZS5nZXRUb3RhbENvdW50KCk7CgogIGlmIChmICE9PSAwKSB7CiAgICB3cml0ZXIud3JpdGVVaW50MzIoNSwgZik7CiAgfQp9OwovKioKICogcmVwZWF0ZWQgcGIuUGF5UmVjb3JkIHJlY29yZHMgPSAxOwogKiBAcmV0dXJuIHshQXJyYXk8IXByb3RvLnBiLlBheVJlY29yZD59CiAqLwoKCnByb3RvLnBiLmNtcy5QYXlMaXN0UmVwbHkucHJvdG90eXBlLmdldFJlY29yZHNMaXN0ID0gZnVuY3Rpb24gKCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuZ2V0UmVwZWF0ZWRXcmFwcGVyRmllbGQodGhpcywgdXNlcnR5cGVfcGIuUGF5UmVjb3JkLCAxKTsKfTsKLyoqCiAqIEBwYXJhbSB7IUFycmF5PCFwcm90by5wYi5QYXlSZWNvcmQ+fSB2YWx1ZQogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLlBheUxpc3RSZXBseX0gcmV0dXJucyB0aGlzCiovCgoKcHJvdG8ucGIuY21zLlBheUxpc3RSZXBseS5wcm90b3R5cGUuc2V0UmVjb3Jkc0xpc3QgPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFJlcGVhdGVkV3JhcHBlckZpZWxkKHRoaXMsIDEsIHZhbHVlKTsKfTsKLyoqCiAqIEBwYXJhbSB7IXByb3RvLnBiLlBheVJlY29yZD19IG9wdF92YWx1ZQogKiBAcGFyYW0ge251bWJlcj19IG9wdF9pbmRleAogKiBAcmV0dXJuIHshcHJvdG8ucGIuUGF5UmVjb3JkfQogKi8KCgpwcm90by5wYi5jbXMuUGF5TGlzdFJlcGx5LnByb3RvdHlwZS5hZGRSZWNvcmRzID0gZnVuY3Rpb24gKG9wdF92YWx1ZSwgb3B0X2luZGV4KSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5hZGRUb1JlcGVhdGVkV3JhcHBlckZpZWxkKHRoaXMsIDEsIG9wdF92YWx1ZSwgcHJvdG8ucGIuUGF5UmVjb3JkLCBvcHRfaW5kZXgpOwp9OwovKioKICogQ2xlYXJzIHRoZSBsaXN0IG1ha2luZyBpdCBlbXB0eSBidXQgbm9uLW51bGwuCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuUGF5TGlzdFJlcGx5fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLlBheUxpc3RSZXBseS5wcm90b3R5cGUuY2xlYXJSZWNvcmRzTGlzdCA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4gdGhpcy5zZXRSZWNvcmRzTGlzdChbXSk7Cn07Ci8qKgogKiBvcHRpb25hbCB1aW50MzIgcGFnZV9ubyA9IDI7CiAqIEByZXR1cm4ge251bWJlcn0KICovCgoKcHJvdG8ucGIuY21zLlBheUxpc3RSZXBseS5wcm90b3R5cGUuZ2V0UGFnZU5vID0gZnVuY3Rpb24gKCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdCh0aGlzLCAyLCAwKTsKfTsKLyoqCiAqIEBwYXJhbSB7bnVtYmVyfSB2YWx1ZQogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLlBheUxpc3RSZXBseX0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5QYXlMaXN0UmVwbHkucHJvdG90eXBlLnNldFBhZ2VObyA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UHJvdG8zSW50RmllbGQodGhpcywgMiwgdmFsdWUpOwp9OwovKioKICogb3B0aW9uYWwgdWludDMyIHBhZ2Vfc2l6ZSA9IDM7CiAqIEByZXR1cm4ge251bWJlcn0KICovCgoKcHJvdG8ucGIuY21zLlBheUxpc3RSZXBseS5wcm90b3R5cGUuZ2V0UGFnZVNpemUgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDMsIDApOwp9OwovKioKICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuUGF5TGlzdFJlcGx5fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLlBheUxpc3RSZXBseS5wcm90b3R5cGUuc2V0UGFnZVNpemUgPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0ludEZpZWxkKHRoaXMsIDMsIHZhbHVlKTsKfTsKLyoqCiAqIG9wdGlvbmFsIHVpbnQzMiB0b3RhbF9wYWdlID0gNDsKICogQHJldHVybiB7bnVtYmVyfQogKi8KCgpwcm90by5wYi5jbXMuUGF5TGlzdFJlcGx5LnByb3RvdHlwZS5nZXRUb3RhbFBhZ2UgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDQsIDApOwp9OwovKioKICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuUGF5TGlzdFJlcGx5fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLlBheUxpc3RSZXBseS5wcm90b3R5cGUuc2V0VG90YWxQYWdlID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRQcm90bzNJbnRGaWVsZCh0aGlzLCA0LCB2YWx1ZSk7Cn07Ci8qKgogKiBvcHRpb25hbCB1aW50MzIgdG90YWxfY291bnQgPSA1OwogKiBAcmV0dXJuIHtudW1iZXJ9CiAqLwoKCnByb3RvLnBiLmNtcy5QYXlMaXN0UmVwbHkucHJvdG90eXBlLmdldFRvdGFsQ291bnQgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDUsIDApOwp9OwovKioKICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuUGF5TGlzdFJlcGx5fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLlBheUxpc3RSZXBseS5wcm90b3R5cGUuc2V0VG90YWxDb3VudCA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UHJvdG8zSW50RmllbGQodGhpcywgNSwgdmFsdWUpOwp9OwoKaWYgKGpzcGIuTWVzc2FnZS5HRU5FUkFURV9UT19PQkpFQ1QpIHsKICAvKioKICAgKiBDcmVhdGVzIGFuIG9iamVjdCByZXByZXNlbnRhdGlvbiBvZiB0aGlzIHByb3RvLgogICAqIEZpZWxkIG5hbWVzIHRoYXQgYXJlIHJlc2VydmVkIGluIEphdmFTY3JpcHQgYW5kIHdpbGwgYmUgcmVuYW1lZCB0byBwYl9uYW1lLgogICAqIE9wdGlvbmFsIGZpZWxkcyB0aGF0IGFyZSBub3Qgc2V0IHdpbGwgYmUgc2V0IHRvIHVuZGVmaW5lZC4KICAgKiBUbyBhY2Nlc3MgYSByZXNlcnZlZCBmaWVsZCB1c2UsIGZvby5wYl88bmFtZT4sIGVnLCBmb28ucGJfZGVmYXVsdC4KICAgKiBGb3IgdGhlIGxpc3Qgb2YgcmVzZXJ2ZWQgbmFtZXMgcGxlYXNlIHNlZToKICAgKiAgICAgbmV0L3Byb3RvMi9jb21waWxlci9qcy9pbnRlcm5hbC9nZW5lcmF0b3IuY2Mja0tleXdvcmQuCiAgICogQHBhcmFtIHtib29sZWFuPX0gb3B0X2luY2x1ZGVJbnN0YW5jZSBEZXByZWNhdGVkLiB3aGV0aGVyIHRvIGluY2x1ZGUgdGhlCiAgICogICAgIEpTUEIgaW5zdGFuY2UgZm9yIHRyYW5zaXRpb25hbCBzb3kgcHJvdG8gc3VwcG9ydDoKICAgKiAgICAgaHR0cDovL2dvdG8vc295LXBhcmFtLW1pZ3JhdGlvbgogICAqIEByZXR1cm4geyFPYmplY3R9CiAgICovCiAgcHJvdG8ucGIuY21zLlJvYm90TGlzdFJlcXVlc3QucHJvdG90eXBlLnRvT2JqZWN0ID0gZnVuY3Rpb24gKG9wdF9pbmNsdWRlSW5zdGFuY2UpIHsKICAgIHJldHVybiBwcm90by5wYi5jbXMuUm9ib3RMaXN0UmVxdWVzdC50b09iamVjdChvcHRfaW5jbHVkZUluc3RhbmNlLCB0aGlzKTsKICB9OwogIC8qKgogICAqIFN0YXRpYyB2ZXJzaW9uIG9mIHRoZSB7QHNlZSB0b09iamVjdH0gbWV0aG9kLgogICAqIEBwYXJhbSB7Ym9vbGVhbnx1bmRlZmluZWR9IGluY2x1ZGVJbnN0YW5jZSBEZXByZWNhdGVkLiBXaGV0aGVyIHRvIGluY2x1ZGUKICAgKiAgICAgdGhlIEpTUEIgaW5zdGFuY2UgZm9yIHRyYW5zaXRpb25hbCBzb3kgcHJvdG8gc3VwcG9ydDoKICAgKiAgICAgaHR0cDovL2dvdG8vc295LXBhcmFtLW1pZ3JhdGlvbgogICAqIEBwYXJhbSB7IXByb3RvLnBiLmNtcy5Sb2JvdExpc3RSZXF1ZXN0fSBtc2cgVGhlIG1zZyBpbnN0YW5jZSB0byB0cmFuc2Zvcm0uCiAgICogQHJldHVybiB7IU9iamVjdH0KICAgKiBAc3VwcHJlc3Mge3VudXNlZExvY2FsVmFyaWFibGVzfSBmIGlzIG9ubHkgdXNlZCBmb3IgbmVzdGVkIG1lc3NhZ2VzCiAgICovCgoKICBwcm90by5wYi5jbXMuUm9ib3RMaXN0UmVxdWVzdC50b09iamVjdCA9IGZ1bmN0aW9uIChpbmNsdWRlSW5zdGFuY2UsIG1zZykgewogICAgdmFyIGYsCiAgICAgICAgb2JqID0gewogICAgICBwYWdlTm86IGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KG1zZywgMSwgMCksCiAgICAgIHBhZ2VTaXplOiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdChtc2csIDIsIDApLAogICAgICBhcmVhSWQ6IGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KG1zZywgMywgMCksCiAgICAgIGVuYWJsZToganNwYi5NZXNzYWdlLmdldEJvb2xlYW5GaWVsZFdpdGhEZWZhdWx0KG1zZywgNCwgZmFsc2UpLAogICAgICByb2JvdElkOiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdChtc2csIDUsIDApCiAgICB9OwoKICAgIGlmIChpbmNsdWRlSW5zdGFuY2UpIHsKICAgICAgb2JqLiRqc3BiTWVzc2FnZUluc3RhbmNlID0gbXNnOwogICAgfQoKICAgIHJldHVybiBvYmo7CiAgfTsKfQovKioKICogRGVzZXJpYWxpemVzIGJpbmFyeSBkYXRhIChpbiBwcm90b2J1ZiB3aXJlIGZvcm1hdCkuCiAqIEBwYXJhbSB7anNwYi5CeXRlU291cmNlfSBieXRlcyBUaGUgYnl0ZXMgdG8gZGVzZXJpYWxpemUuCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuUm9ib3RMaXN0UmVxdWVzdH0KICovCgoKcHJvdG8ucGIuY21zLlJvYm90TGlzdFJlcXVlc3QuZGVzZXJpYWxpemVCaW5hcnkgPSBmdW5jdGlvbiAoYnl0ZXMpIHsKICB2YXIgcmVhZGVyID0gbmV3IGpzcGIuQmluYXJ5UmVhZGVyKGJ5dGVzKTsKICB2YXIgbXNnID0gbmV3IHByb3RvLnBiLmNtcy5Sb2JvdExpc3RSZXF1ZXN0KCk7CiAgcmV0dXJuIHByb3RvLnBiLmNtcy5Sb2JvdExpc3RSZXF1ZXN0LmRlc2VyaWFsaXplQmluYXJ5RnJvbVJlYWRlcihtc2csIHJlYWRlcik7Cn07Ci8qKgogKiBEZXNlcmlhbGl6ZXMgYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUgZm9ybWF0KSBmcm9tIHRoZQogKiBnaXZlbiByZWFkZXIgaW50byB0aGUgZ2l2ZW4gbWVzc2FnZSBvYmplY3QuCiAqIEBwYXJhbSB7IXByb3RvLnBiLmNtcy5Sb2JvdExpc3RSZXF1ZXN0fSBtc2cgVGhlIG1lc3NhZ2Ugb2JqZWN0IHRvIGRlc2VyaWFsaXplIGludG8uCiAqIEBwYXJhbSB7IWpzcGIuQmluYXJ5UmVhZGVyfSByZWFkZXIgVGhlIEJpbmFyeVJlYWRlciB0byB1c2UuCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuUm9ib3RMaXN0UmVxdWVzdH0KICovCgoKcHJvdG8ucGIuY21zLlJvYm90TGlzdFJlcXVlc3QuZGVzZXJpYWxpemVCaW5hcnlGcm9tUmVhZGVyID0gZnVuY3Rpb24gKG1zZywgcmVhZGVyKSB7CiAgd2hpbGUgKHJlYWRlci5uZXh0RmllbGQoKSkgewogICAgaWYgKHJlYWRlci5pc0VuZEdyb3VwKCkpIHsKICAgICAgYnJlYWs7CiAgICB9CgogICAgdmFyIGZpZWxkID0gcmVhZGVyLmdldEZpZWxkTnVtYmVyKCk7CgogICAgc3dpdGNoIChmaWVsZCkgewogICAgICBjYXNlIDE6CiAgICAgICAgdmFyIHZhbHVlID0gcmVhZGVyLnJlYWRVaW50MzIoKTsKICAgICAgICBtc2cuc2V0UGFnZU5vKHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgMjoKICAgICAgICB2YXIgdmFsdWUgPSByZWFkZXIucmVhZFVpbnQzMigpOwogICAgICAgIG1zZy5zZXRQYWdlU2l6ZSh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlIDM6CiAgICAgICAgdmFyIHZhbHVlID0gcmVhZGVyLnJlYWRVaW50MzIoKTsKICAgICAgICBtc2cuc2V0QXJlYUlkKHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgNDoKICAgICAgICB2YXIgdmFsdWUgPSByZWFkZXIucmVhZEJvb2woKTsKICAgICAgICBtc2cuc2V0RW5hYmxlKHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgNToKICAgICAgICB2YXIgdmFsdWUgPSByZWFkZXIucmVhZFVpbnQzMigpOwogICAgICAgIG1zZy5zZXRSb2JvdElkKHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGRlZmF1bHQ6CiAgICAgICAgcmVhZGVyLnNraXBGaWVsZCgpOwogICAgICAgIGJyZWFrOwogICAgfQogIH0KCiAgcmV0dXJuIG1zZzsKfTsKLyoqCiAqIFNlcmlhbGl6ZXMgdGhlIG1lc3NhZ2UgdG8gYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUgZm9ybWF0KS4KICogQHJldHVybiB7IVVpbnQ4QXJyYXl9CiAqLwoKCnByb3RvLnBiLmNtcy5Sb2JvdExpc3RSZXF1ZXN0LnByb3RvdHlwZS5zZXJpYWxpemVCaW5hcnkgPSBmdW5jdGlvbiAoKSB7CiAgdmFyIHdyaXRlciA9IG5ldyBqc3BiLkJpbmFyeVdyaXRlcigpOwogIHByb3RvLnBiLmNtcy5Sb2JvdExpc3RSZXF1ZXN0LnNlcmlhbGl6ZUJpbmFyeVRvV3JpdGVyKHRoaXMsIHdyaXRlcik7CiAgcmV0dXJuIHdyaXRlci5nZXRSZXN1bHRCdWZmZXIoKTsKfTsKLyoqCiAqIFNlcmlhbGl6ZXMgdGhlIGdpdmVuIG1lc3NhZ2UgdG8gYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUKICogZm9ybWF0KSwgd3JpdGluZyB0byB0aGUgZ2l2ZW4gQmluYXJ5V3JpdGVyLgogKiBAcGFyYW0geyFwcm90by5wYi5jbXMuUm9ib3RMaXN0UmVxdWVzdH0gbWVzc2FnZQogKiBAcGFyYW0geyFqc3BiLkJpbmFyeVdyaXRlcn0gd3JpdGVyCiAqIEBzdXBwcmVzcyB7dW51c2VkTG9jYWxWYXJpYWJsZXN9IGYgaXMgb25seSB1c2VkIGZvciBuZXN0ZWQgbWVzc2FnZXMKICovCgoKcHJvdG8ucGIuY21zLlJvYm90TGlzdFJlcXVlc3Quc2VyaWFsaXplQmluYXJ5VG9Xcml0ZXIgPSBmdW5jdGlvbiAobWVzc2FnZSwgd3JpdGVyKSB7CiAgdmFyIGYgPSB1bmRlZmluZWQ7CiAgZiA9IG1lc3NhZ2UuZ2V0UGFnZU5vKCk7CgogIGlmIChmICE9PSAwKSB7CiAgICB3cml0ZXIud3JpdGVVaW50MzIoMSwgZik7CiAgfQoKICBmID0gbWVzc2FnZS5nZXRQYWdlU2l6ZSgpOwoKICBpZiAoZiAhPT0gMCkgewogICAgd3JpdGVyLndyaXRlVWludDMyKDIsIGYpOwogIH0KCiAgZiA9IG1lc3NhZ2UuZ2V0QXJlYUlkKCk7CgogIGlmIChmICE9PSAwKSB7CiAgICB3cml0ZXIud3JpdGVVaW50MzIoMywgZik7CiAgfQoKICBmID0gbWVzc2FnZS5nZXRFbmFibGUoKTsKCiAgaWYgKGYpIHsKICAgIHdyaXRlci53cml0ZUJvb2woNCwgZik7CiAgfQoKICBmID0gbWVzc2FnZS5nZXRSb2JvdElkKCk7CgogIGlmIChmICE9PSAwKSB7CiAgICB3cml0ZXIud3JpdGVVaW50MzIoNSwgZik7CiAgfQp9OwovKioKICogb3B0aW9uYWwgdWludDMyIHBhZ2Vfbm8gPSAxOwogKiBAcmV0dXJuIHtudW1iZXJ9CiAqLwoKCnByb3RvLnBiLmNtcy5Sb2JvdExpc3RSZXF1ZXN0LnByb3RvdHlwZS5nZXRQYWdlTm8gPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDEsIDApOwp9OwovKioKICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuUm9ib3RMaXN0UmVxdWVzdH0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5Sb2JvdExpc3RSZXF1ZXN0LnByb3RvdHlwZS5zZXRQYWdlTm8gPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0ludEZpZWxkKHRoaXMsIDEsIHZhbHVlKTsKfTsKLyoqCiAqIG9wdGlvbmFsIHVpbnQzMiBwYWdlX3NpemUgPSAyOwogKiBAcmV0dXJuIHtudW1iZXJ9CiAqLwoKCnByb3RvLnBiLmNtcy5Sb2JvdExpc3RSZXF1ZXN0LnByb3RvdHlwZS5nZXRQYWdlU2l6ZSA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQodGhpcywgMiwgMCk7Cn07Ci8qKgogKiBAcGFyYW0ge251bWJlcn0gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5Sb2JvdExpc3RSZXF1ZXN0fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLlJvYm90TGlzdFJlcXVlc3QucHJvdG90eXBlLnNldFBhZ2VTaXplID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRQcm90bzNJbnRGaWVsZCh0aGlzLCAyLCB2YWx1ZSk7Cn07Ci8qKgogKiBvcHRpb25hbCB1aW50MzIgYXJlYV9pZCA9IDM7CiAqIEByZXR1cm4ge251bWJlcn0KICovCgoKcHJvdG8ucGIuY21zLlJvYm90TGlzdFJlcXVlc3QucHJvdG90eXBlLmdldEFyZWFJZCA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQodGhpcywgMywgMCk7Cn07Ci8qKgogKiBAcGFyYW0ge251bWJlcn0gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5Sb2JvdExpc3RSZXF1ZXN0fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLlJvYm90TGlzdFJlcXVlc3QucHJvdG90eXBlLnNldEFyZWFJZCA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UHJvdG8zSW50RmllbGQodGhpcywgMywgdmFsdWUpOwp9OwovKioKICogb3B0aW9uYWwgYm9vbCBlbmFibGUgPSA0OwogKiBAcmV0dXJuIHtib29sZWFufQogKi8KCgpwcm90by5wYi5jbXMuUm9ib3RMaXN0UmVxdWVzdC5wcm90b3R5cGUuZ2V0RW5hYmxlID0gZnVuY3Rpb24gKCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuZ2V0Qm9vbGVhbkZpZWxkV2l0aERlZmF1bHQodGhpcywgNCwgZmFsc2UpOwp9OwovKioKICogQHBhcmFtIHtib29sZWFufSB2YWx1ZQogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLlJvYm90TGlzdFJlcXVlc3R9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuUm9ib3RMaXN0UmVxdWVzdC5wcm90b3R5cGUuc2V0RW5hYmxlID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRQcm90bzNCb29sZWFuRmllbGQodGhpcywgNCwgdmFsdWUpOwp9OwovKioKICogb3B0aW9uYWwgdWludDMyIHJvYm90X2lkID0gNTsKICogQHJldHVybiB7bnVtYmVyfQogKi8KCgpwcm90by5wYi5jbXMuUm9ib3RMaXN0UmVxdWVzdC5wcm90b3R5cGUuZ2V0Um9ib3RJZCA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQodGhpcywgNSwgMCk7Cn07Ci8qKgogKiBAcGFyYW0ge251bWJlcn0gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5Sb2JvdExpc3RSZXF1ZXN0fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLlJvYm90TGlzdFJlcXVlc3QucHJvdG90eXBlLnNldFJvYm90SWQgPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0ludEZpZWxkKHRoaXMsIDUsIHZhbHVlKTsKfTsKLyoqCiAqIExpc3Qgb2YgcmVwZWF0ZWQgZmllbGRzIHdpdGhpbiB0aGlzIG1lc3NhZ2UgdHlwZS4KICogQHByaXZhdGUgeyFBcnJheTxudW1iZXI+fQogKiBAY29uc3QKICovCgoKcHJvdG8ucGIuY21zLlJvYm90TGlzdFJlcGx5LnJlcGVhdGVkRmllbGRzXyA9IFsxXTsKCmlmIChqc3BiLk1lc3NhZ2UuR0VORVJBVEVfVE9fT0JKRUNUKSB7CiAgLyoqCiAgICogQ3JlYXRlcyBhbiBvYmplY3QgcmVwcmVzZW50YXRpb24gb2YgdGhpcyBwcm90by4KICAgKiBGaWVsZCBuYW1lcyB0aGF0IGFyZSByZXNlcnZlZCBpbiBKYXZhU2NyaXB0IGFuZCB3aWxsIGJlIHJlbmFtZWQgdG8gcGJfbmFtZS4KICAgKiBPcHRpb25hbCBmaWVsZHMgdGhhdCBhcmUgbm90IHNldCB3aWxsIGJlIHNldCB0byB1bmRlZmluZWQuCiAgICogVG8gYWNjZXNzIGEgcmVzZXJ2ZWQgZmllbGQgdXNlLCBmb28ucGJfPG5hbWU+LCBlZywgZm9vLnBiX2RlZmF1bHQuCiAgICogRm9yIHRoZSBsaXN0IG9mIHJlc2VydmVkIG5hbWVzIHBsZWFzZSBzZWU6CiAgICogICAgIG5ldC9wcm90bzIvY29tcGlsZXIvanMvaW50ZXJuYWwvZ2VuZXJhdG9yLmNjI2tLZXl3b3JkLgogICAqIEBwYXJhbSB7Ym9vbGVhbj19IG9wdF9pbmNsdWRlSW5zdGFuY2UgRGVwcmVjYXRlZC4gd2hldGhlciB0byBpbmNsdWRlIHRoZQogICAqICAgICBKU1BCIGluc3RhbmNlIGZvciB0cmFuc2l0aW9uYWwgc295IHByb3RvIHN1cHBvcnQ6CiAgICogICAgIGh0dHA6Ly9nb3RvL3NveS1wYXJhbS1taWdyYXRpb24KICAgKiBAcmV0dXJuIHshT2JqZWN0fQogICAqLwogIHByb3RvLnBiLmNtcy5Sb2JvdExpc3RSZXBseS5wcm90b3R5cGUudG9PYmplY3QgPSBmdW5jdGlvbiAob3B0X2luY2x1ZGVJbnN0YW5jZSkgewogICAgcmV0dXJuIHByb3RvLnBiLmNtcy5Sb2JvdExpc3RSZXBseS50b09iamVjdChvcHRfaW5jbHVkZUluc3RhbmNlLCB0aGlzKTsKICB9OwogIC8qKgogICAqIFN0YXRpYyB2ZXJzaW9uIG9mIHRoZSB7QHNlZSB0b09iamVjdH0gbWV0aG9kLgogICAqIEBwYXJhbSB7Ym9vbGVhbnx1bmRlZmluZWR9IGluY2x1ZGVJbnN0YW5jZSBEZXByZWNhdGVkLiBXaGV0aGVyIHRvIGluY2x1ZGUKICAgKiAgICAgdGhlIEpTUEIgaW5zdGFuY2UgZm9yIHRyYW5zaXRpb25hbCBzb3kgcHJvdG8gc3VwcG9ydDoKICAgKiAgICAgaHR0cDovL2dvdG8vc295LXBhcmFtLW1pZ3JhdGlvbgogICAqIEBwYXJhbSB7IXByb3RvLnBiLmNtcy5Sb2JvdExpc3RSZXBseX0gbXNnIFRoZSBtc2cgaW5zdGFuY2UgdG8gdHJhbnNmb3JtLgogICAqIEByZXR1cm4geyFPYmplY3R9CiAgICogQHN1cHByZXNzIHt1bnVzZWRMb2NhbFZhcmlhYmxlc30gZiBpcyBvbmx5IHVzZWQgZm9yIG5lc3RlZCBtZXNzYWdlcwogICAqLwoKCiAgcHJvdG8ucGIuY21zLlJvYm90TGlzdFJlcGx5LnRvT2JqZWN0ID0gZnVuY3Rpb24gKGluY2x1ZGVJbnN0YW5jZSwgbXNnKSB7CiAgICB2YXIgZiwKICAgICAgICBvYmogPSB7CiAgICAgIHJvYm90c0xpc3Q6IGpzcGIuTWVzc2FnZS50b09iamVjdExpc3QobXNnLmdldFJvYm90c0xpc3QoKSwgYW5jaG9ydHlwZV9wYi5BbmNob3JQcm9maWxlLnRvT2JqZWN0LCBpbmNsdWRlSW5zdGFuY2UpLAogICAgICBwYWdlTm86IGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KG1zZywgMiwgMCksCiAgICAgIHBhZ2VTaXplOiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdChtc2csIDMsIDApLAogICAgICB0b3RhbFBhZ2U6IGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KG1zZywgNCwgMCksCiAgICAgIHRvdGFsQ291bnQ6IGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KG1zZywgNSwgMCkKICAgIH07CgogICAgaWYgKGluY2x1ZGVJbnN0YW5jZSkgewogICAgICBvYmouJGpzcGJNZXNzYWdlSW5zdGFuY2UgPSBtc2c7CiAgICB9CgogICAgcmV0dXJuIG9iajsKICB9Owp9Ci8qKgogKiBEZXNlcmlhbGl6ZXMgYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUgZm9ybWF0KS4KICogQHBhcmFtIHtqc3BiLkJ5dGVTb3VyY2V9IGJ5dGVzIFRoZSBieXRlcyB0byBkZXNlcmlhbGl6ZS4KICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5Sb2JvdExpc3RSZXBseX0KICovCgoKcHJvdG8ucGIuY21zLlJvYm90TGlzdFJlcGx5LmRlc2VyaWFsaXplQmluYXJ5ID0gZnVuY3Rpb24gKGJ5dGVzKSB7CiAgdmFyIHJlYWRlciA9IG5ldyBqc3BiLkJpbmFyeVJlYWRlcihieXRlcyk7CiAgdmFyIG1zZyA9IG5ldyBwcm90by5wYi5jbXMuUm9ib3RMaXN0UmVwbHkoKTsKICByZXR1cm4gcHJvdG8ucGIuY21zLlJvYm90TGlzdFJlcGx5LmRlc2VyaWFsaXplQmluYXJ5RnJvbVJlYWRlcihtc2csIHJlYWRlcik7Cn07Ci8qKgogKiBEZXNlcmlhbGl6ZXMgYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUgZm9ybWF0KSBmcm9tIHRoZQogKiBnaXZlbiByZWFkZXIgaW50byB0aGUgZ2l2ZW4gbWVzc2FnZSBvYmplY3QuCiAqIEBwYXJhbSB7IXByb3RvLnBiLmNtcy5Sb2JvdExpc3RSZXBseX0gbXNnIFRoZSBtZXNzYWdlIG9iamVjdCB0byBkZXNlcmlhbGl6ZSBpbnRvLgogKiBAcGFyYW0geyFqc3BiLkJpbmFyeVJlYWRlcn0gcmVhZGVyIFRoZSBCaW5hcnlSZWFkZXIgdG8gdXNlLgogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLlJvYm90TGlzdFJlcGx5fQogKi8KCgpwcm90by5wYi5jbXMuUm9ib3RMaXN0UmVwbHkuZGVzZXJpYWxpemVCaW5hcnlGcm9tUmVhZGVyID0gZnVuY3Rpb24gKG1zZywgcmVhZGVyKSB7CiAgd2hpbGUgKHJlYWRlci5uZXh0RmllbGQoKSkgewogICAgaWYgKHJlYWRlci5pc0VuZEdyb3VwKCkpIHsKICAgICAgYnJlYWs7CiAgICB9CgogICAgdmFyIGZpZWxkID0gcmVhZGVyLmdldEZpZWxkTnVtYmVyKCk7CgogICAgc3dpdGNoIChmaWVsZCkgewogICAgICBjYXNlIDE6CiAgICAgICAgdmFyIHZhbHVlID0gbmV3IGFuY2hvcnR5cGVfcGIuQW5jaG9yUHJvZmlsZSgpOwogICAgICAgIHJlYWRlci5yZWFkTWVzc2FnZSh2YWx1ZSwgYW5jaG9ydHlwZV9wYi5BbmNob3JQcm9maWxlLmRlc2VyaWFsaXplQmluYXJ5RnJvbVJlYWRlcik7CiAgICAgICAgbXNnLmFkZFJvYm90cyh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlIDI6CiAgICAgICAgdmFyIHZhbHVlID0gcmVhZGVyLnJlYWRVaW50MzIoKTsKICAgICAgICBtc2cuc2V0UGFnZU5vKHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgMzoKICAgICAgICB2YXIgdmFsdWUgPSByZWFkZXIucmVhZFVpbnQzMigpOwogICAgICAgIG1zZy5zZXRQYWdlU2l6ZSh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlIDQ6CiAgICAgICAgdmFyIHZhbHVlID0gcmVhZGVyLnJlYWRVaW50MzIoKTsKICAgICAgICBtc2cuc2V0VG90YWxQYWdlKHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgNToKICAgICAgICB2YXIgdmFsdWUgPSByZWFkZXIucmVhZFVpbnQzMigpOwogICAgICAgIG1zZy5zZXRUb3RhbENvdW50KHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGRlZmF1bHQ6CiAgICAgICAgcmVhZGVyLnNraXBGaWVsZCgpOwogICAgICAgIGJyZWFrOwogICAgfQogIH0KCiAgcmV0dXJuIG1zZzsKfTsKLyoqCiAqIFNlcmlhbGl6ZXMgdGhlIG1lc3NhZ2UgdG8gYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUgZm9ybWF0KS4KICogQHJldHVybiB7IVVpbnQ4QXJyYXl9CiAqLwoKCnByb3RvLnBiLmNtcy5Sb2JvdExpc3RSZXBseS5wcm90b3R5cGUuc2VyaWFsaXplQmluYXJ5ID0gZnVuY3Rpb24gKCkgewogIHZhciB3cml0ZXIgPSBuZXcganNwYi5CaW5hcnlXcml0ZXIoKTsKICBwcm90by5wYi5jbXMuUm9ib3RMaXN0UmVwbHkuc2VyaWFsaXplQmluYXJ5VG9Xcml0ZXIodGhpcywgd3JpdGVyKTsKICByZXR1cm4gd3JpdGVyLmdldFJlc3VsdEJ1ZmZlcigpOwp9OwovKioKICogU2VyaWFsaXplcyB0aGUgZ2l2ZW4gbWVzc2FnZSB0byBiaW5hcnkgZGF0YSAoaW4gcHJvdG9idWYgd2lyZQogKiBmb3JtYXQpLCB3cml0aW5nIHRvIHRoZSBnaXZlbiBCaW5hcnlXcml0ZXIuCiAqIEBwYXJhbSB7IXByb3RvLnBiLmNtcy5Sb2JvdExpc3RSZXBseX0gbWVzc2FnZQogKiBAcGFyYW0geyFqc3BiLkJpbmFyeVdyaXRlcn0gd3JpdGVyCiAqIEBzdXBwcmVzcyB7dW51c2VkTG9jYWxWYXJpYWJsZXN9IGYgaXMgb25seSB1c2VkIGZvciBuZXN0ZWQgbWVzc2FnZXMKICovCgoKcHJvdG8ucGIuY21zLlJvYm90TGlzdFJlcGx5LnNlcmlhbGl6ZUJpbmFyeVRvV3JpdGVyID0gZnVuY3Rpb24gKG1lc3NhZ2UsIHdyaXRlcikgewogIHZhciBmID0gdW5kZWZpbmVkOwogIGYgPSBtZXNzYWdlLmdldFJvYm90c0xpc3QoKTsKCiAgaWYgKGYubGVuZ3RoID4gMCkgewogICAgd3JpdGVyLndyaXRlUmVwZWF0ZWRNZXNzYWdlKDEsIGYsIGFuY2hvcnR5cGVfcGIuQW5jaG9yUHJvZmlsZS5zZXJpYWxpemVCaW5hcnlUb1dyaXRlcik7CiAgfQoKICBmID0gbWVzc2FnZS5nZXRQYWdlTm8oKTsKCiAgaWYgKGYgIT09IDApIHsKICAgIHdyaXRlci53cml0ZVVpbnQzMigyLCBmKTsKICB9CgogIGYgPSBtZXNzYWdlLmdldFBhZ2VTaXplKCk7CgogIGlmIChmICE9PSAwKSB7CiAgICB3cml0ZXIud3JpdGVVaW50MzIoMywgZik7CiAgfQoKICBmID0gbWVzc2FnZS5nZXRUb3RhbFBhZ2UoKTsKCiAgaWYgKGYgIT09IDApIHsKICAgIHdyaXRlci53cml0ZVVpbnQzMig0LCBmKTsKICB9CgogIGYgPSBtZXNzYWdlLmdldFRvdGFsQ291bnQoKTsKCiAgaWYgKGYgIT09IDApIHsKICAgIHdyaXRlci53cml0ZVVpbnQzMig1LCBmKTsKICB9Cn07Ci8qKgogKiByZXBlYXRlZCBwYi5BbmNob3JQcm9maWxlIHJvYm90cyA9IDE7CiAqIEByZXR1cm4geyFBcnJheTwhcHJvdG8ucGIuQW5jaG9yUHJvZmlsZT59CiAqLwoKCnByb3RvLnBiLmNtcy5Sb2JvdExpc3RSZXBseS5wcm90b3R5cGUuZ2V0Um9ib3RzTGlzdCA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldFJlcGVhdGVkV3JhcHBlckZpZWxkKHRoaXMsIGFuY2hvcnR5cGVfcGIuQW5jaG9yUHJvZmlsZSwgMSk7Cn07Ci8qKgogKiBAcGFyYW0geyFBcnJheTwhcHJvdG8ucGIuQW5jaG9yUHJvZmlsZT59IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuUm9ib3RMaXN0UmVwbHl9IHJldHVybnMgdGhpcwoqLwoKCnByb3RvLnBiLmNtcy5Sb2JvdExpc3RSZXBseS5wcm90b3R5cGUuc2V0Um9ib3RzTGlzdCA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UmVwZWF0ZWRXcmFwcGVyRmllbGQodGhpcywgMSwgdmFsdWUpOwp9OwovKioKICogQHBhcmFtIHshcHJvdG8ucGIuQW5jaG9yUHJvZmlsZT19IG9wdF92YWx1ZQogKiBAcGFyYW0ge251bWJlcj19IG9wdF9pbmRleAogKiBAcmV0dXJuIHshcHJvdG8ucGIuQW5jaG9yUHJvZmlsZX0KICovCgoKcHJvdG8ucGIuY21zLlJvYm90TGlzdFJlcGx5LnByb3RvdHlwZS5hZGRSb2JvdHMgPSBmdW5jdGlvbiAob3B0X3ZhbHVlLCBvcHRfaW5kZXgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmFkZFRvUmVwZWF0ZWRXcmFwcGVyRmllbGQodGhpcywgMSwgb3B0X3ZhbHVlLCBwcm90by5wYi5BbmNob3JQcm9maWxlLCBvcHRfaW5kZXgpOwp9OwovKioKICogQ2xlYXJzIHRoZSBsaXN0IG1ha2luZyBpdCBlbXB0eSBidXQgbm9uLW51bGwuCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuUm9ib3RMaXN0UmVwbHl9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuUm9ib3RMaXN0UmVwbHkucHJvdG90eXBlLmNsZWFyUm9ib3RzTGlzdCA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4gdGhpcy5zZXRSb2JvdHNMaXN0KFtdKTsKfTsKLyoqCiAqIG9wdGlvbmFsIHVpbnQzMiBwYWdlX25vID0gMjsKICogQHJldHVybiB7bnVtYmVyfQogKi8KCgpwcm90by5wYi5jbXMuUm9ib3RMaXN0UmVwbHkucHJvdG90eXBlLmdldFBhZ2VObyA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQodGhpcywgMiwgMCk7Cn07Ci8qKgogKiBAcGFyYW0ge251bWJlcn0gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5Sb2JvdExpc3RSZXBseX0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5Sb2JvdExpc3RSZXBseS5wcm90b3R5cGUuc2V0UGFnZU5vID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRQcm90bzNJbnRGaWVsZCh0aGlzLCAyLCB2YWx1ZSk7Cn07Ci8qKgogKiBvcHRpb25hbCB1aW50MzIgcGFnZV9zaXplID0gMzsKICogQHJldHVybiB7bnVtYmVyfQogKi8KCgpwcm90by5wYi5jbXMuUm9ib3RMaXN0UmVwbHkucHJvdG90eXBlLmdldFBhZ2VTaXplID0gZnVuY3Rpb24gKCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdCh0aGlzLCAzLCAwKTsKfTsKLyoqCiAqIEBwYXJhbSB7bnVtYmVyfSB2YWx1ZQogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLlJvYm90TGlzdFJlcGx5fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLlJvYm90TGlzdFJlcGx5LnByb3RvdHlwZS5zZXRQYWdlU2l6ZSA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UHJvdG8zSW50RmllbGQodGhpcywgMywgdmFsdWUpOwp9OwovKioKICogb3B0aW9uYWwgdWludDMyIHRvdGFsX3BhZ2UgPSA0OwogKiBAcmV0dXJuIHtudW1iZXJ9CiAqLwoKCnByb3RvLnBiLmNtcy5Sb2JvdExpc3RSZXBseS5wcm90b3R5cGUuZ2V0VG90YWxQYWdlID0gZnVuY3Rpb24gKCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdCh0aGlzLCA0LCAwKTsKfTsKLyoqCiAqIEBwYXJhbSB7bnVtYmVyfSB2YWx1ZQogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLlJvYm90TGlzdFJlcGx5fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLlJvYm90TGlzdFJlcGx5LnByb3RvdHlwZS5zZXRUb3RhbFBhZ2UgPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0ludEZpZWxkKHRoaXMsIDQsIHZhbHVlKTsKfTsKLyoqCiAqIG9wdGlvbmFsIHVpbnQzMiB0b3RhbF9jb3VudCA9IDU7CiAqIEByZXR1cm4ge251bWJlcn0KICovCgoKcHJvdG8ucGIuY21zLlJvYm90TGlzdFJlcGx5LnByb3RvdHlwZS5nZXRUb3RhbENvdW50ID0gZnVuY3Rpb24gKCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdCh0aGlzLCA1LCAwKTsKfTsKLyoqCiAqIEBwYXJhbSB7bnVtYmVyfSB2YWx1ZQogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLlJvYm90TGlzdFJlcGx5fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLlJvYm90TGlzdFJlcGx5LnByb3RvdHlwZS5zZXRUb3RhbENvdW50ID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRQcm90bzNJbnRGaWVsZCh0aGlzLCA1LCB2YWx1ZSk7Cn07CgppZiAoanNwYi5NZXNzYWdlLkdFTkVSQVRFX1RPX09CSkVDVCkgewogIC8qKgogICAqIENyZWF0ZXMgYW4gb2JqZWN0IHJlcHJlc2VudGF0aW9uIG9mIHRoaXMgcHJvdG8uCiAgICogRmllbGQgbmFtZXMgdGhhdCBhcmUgcmVzZXJ2ZWQgaW4gSmF2YVNjcmlwdCBhbmQgd2lsbCBiZSByZW5hbWVkIHRvIHBiX25hbWUuCiAgICogT3B0aW9uYWwgZmllbGRzIHRoYXQgYXJlIG5vdCBzZXQgd2lsbCBiZSBzZXQgdG8gdW5kZWZpbmVkLgogICAqIFRvIGFjY2VzcyBhIHJlc2VydmVkIGZpZWxkIHVzZSwgZm9vLnBiXzxuYW1lPiwgZWcsIGZvby5wYl9kZWZhdWx0LgogICAqIEZvciB0aGUgbGlzdCBvZiByZXNlcnZlZCBuYW1lcyBwbGVhc2Ugc2VlOgogICAqICAgICBuZXQvcHJvdG8yL2NvbXBpbGVyL2pzL2ludGVybmFsL2dlbmVyYXRvci5jYyNrS2V5d29yZC4KICAgKiBAcGFyYW0ge2Jvb2xlYW49fSBvcHRfaW5jbHVkZUluc3RhbmNlIERlcHJlY2F0ZWQuIHdoZXRoZXIgdG8gaW5jbHVkZSB0aGUKICAgKiAgICAgSlNQQiBpbnN0YW5jZSBmb3IgdHJhbnNpdGlvbmFsIHNveSBwcm90byBzdXBwb3J0OgogICAqICAgICBodHRwOi8vZ290by9zb3ktcGFyYW0tbWlncmF0aW9uCiAgICogQHJldHVybiB7IU9iamVjdH0KICAgKi8KICBwcm90by5wYi5jbXMuUm9ib3RNZXNzYWdlTGlzdFJlcXVlc3QucHJvdG90eXBlLnRvT2JqZWN0ID0gZnVuY3Rpb24gKG9wdF9pbmNsdWRlSW5zdGFuY2UpIHsKICAgIHJldHVybiBwcm90by5wYi5jbXMuUm9ib3RNZXNzYWdlTGlzdFJlcXVlc3QudG9PYmplY3Qob3B0X2luY2x1ZGVJbnN0YW5jZSwgdGhpcyk7CiAgfTsKICAvKioKICAgKiBTdGF0aWMgdmVyc2lvbiBvZiB0aGUge0BzZWUgdG9PYmplY3R9IG1ldGhvZC4KICAgKiBAcGFyYW0ge2Jvb2xlYW58dW5kZWZpbmVkfSBpbmNsdWRlSW5zdGFuY2UgRGVwcmVjYXRlZC4gV2hldGhlciB0byBpbmNsdWRlCiAgICogICAgIHRoZSBKU1BCIGluc3RhbmNlIGZvciB0cmFuc2l0aW9uYWwgc295IHByb3RvIHN1cHBvcnQ6CiAgICogICAgIGh0dHA6Ly9nb3RvL3NveS1wYXJhbS1taWdyYXRpb24KICAgKiBAcGFyYW0geyFwcm90by5wYi5jbXMuUm9ib3RNZXNzYWdlTGlzdFJlcXVlc3R9IG1zZyBUaGUgbXNnIGluc3RhbmNlIHRvIHRyYW5zZm9ybS4KICAgKiBAcmV0dXJuIHshT2JqZWN0fQogICAqIEBzdXBwcmVzcyB7dW51c2VkTG9jYWxWYXJpYWJsZXN9IGYgaXMgb25seSB1c2VkIGZvciBuZXN0ZWQgbWVzc2FnZXMKICAgKi8KCgogIHByb3RvLnBiLmNtcy5Sb2JvdE1lc3NhZ2VMaXN0UmVxdWVzdC50b09iamVjdCA9IGZ1bmN0aW9uIChpbmNsdWRlSW5zdGFuY2UsIG1zZykgewogICAgdmFyIGYsCiAgICAgICAgb2JqID0gewogICAgICByb2JvdElkOiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdChtc2csIDEsIDApCiAgICB9OwoKICAgIGlmIChpbmNsdWRlSW5zdGFuY2UpIHsKICAgICAgb2JqLiRqc3BiTWVzc2FnZUluc3RhbmNlID0gbXNnOwogICAgfQoKICAgIHJldHVybiBvYmo7CiAgfTsKfQovKioKICogRGVzZXJpYWxpemVzIGJpbmFyeSBkYXRhIChpbiBwcm90b2J1ZiB3aXJlIGZvcm1hdCkuCiAqIEBwYXJhbSB7anNwYi5CeXRlU291cmNlfSBieXRlcyBUaGUgYnl0ZXMgdG8gZGVzZXJpYWxpemUuCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuUm9ib3RNZXNzYWdlTGlzdFJlcXVlc3R9CiAqLwoKCnByb3RvLnBiLmNtcy5Sb2JvdE1lc3NhZ2VMaXN0UmVxdWVzdC5kZXNlcmlhbGl6ZUJpbmFyeSA9IGZ1bmN0aW9uIChieXRlcykgewogIHZhciByZWFkZXIgPSBuZXcganNwYi5CaW5hcnlSZWFkZXIoYnl0ZXMpOwogIHZhciBtc2cgPSBuZXcgcHJvdG8ucGIuY21zLlJvYm90TWVzc2FnZUxpc3RSZXF1ZXN0KCk7CiAgcmV0dXJuIHByb3RvLnBiLmNtcy5Sb2JvdE1lc3NhZ2VMaXN0UmVxdWVzdC5kZXNlcmlhbGl6ZUJpbmFyeUZyb21SZWFkZXIobXNnLCByZWFkZXIpOwp9OwovKioKICogRGVzZXJpYWxpemVzIGJpbmFyeSBkYXRhIChpbiBwcm90b2J1ZiB3aXJlIGZvcm1hdCkgZnJvbSB0aGUKICogZ2l2ZW4gcmVhZGVyIGludG8gdGhlIGdpdmVuIG1lc3NhZ2Ugb2JqZWN0LgogKiBAcGFyYW0geyFwcm90by5wYi5jbXMuUm9ib3RNZXNzYWdlTGlzdFJlcXVlc3R9IG1zZyBUaGUgbWVzc2FnZSBvYmplY3QgdG8gZGVzZXJpYWxpemUgaW50by4KICogQHBhcmFtIHshanNwYi5CaW5hcnlSZWFkZXJ9IHJlYWRlciBUaGUgQmluYXJ5UmVhZGVyIHRvIHVzZS4KICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5Sb2JvdE1lc3NhZ2VMaXN0UmVxdWVzdH0KICovCgoKcHJvdG8ucGIuY21zLlJvYm90TWVzc2FnZUxpc3RSZXF1ZXN0LmRlc2VyaWFsaXplQmluYXJ5RnJvbVJlYWRlciA9IGZ1bmN0aW9uIChtc2csIHJlYWRlcikgewogIHdoaWxlIChyZWFkZXIubmV4dEZpZWxkKCkpIHsKICAgIGlmIChyZWFkZXIuaXNFbmRHcm91cCgpKSB7CiAgICAgIGJyZWFrOwogICAgfQoKICAgIHZhciBmaWVsZCA9IHJlYWRlci5nZXRGaWVsZE51bWJlcigpOwoKICAgIHN3aXRjaCAoZmllbGQpIHsKICAgICAgY2FzZSAxOgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkVWludDMyKCk7CiAgICAgICAgbXNnLnNldFJvYm90SWQodmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgZGVmYXVsdDoKICAgICAgICByZWFkZXIuc2tpcEZpZWxkKCk7CiAgICAgICAgYnJlYWs7CiAgICB9CiAgfQoKICByZXR1cm4gbXNnOwp9OwovKioKICogU2VyaWFsaXplcyB0aGUgbWVzc2FnZSB0byBiaW5hcnkgZGF0YSAoaW4gcHJvdG9idWYgd2lyZSBmb3JtYXQpLgogKiBAcmV0dXJuIHshVWludDhBcnJheX0KICovCgoKcHJvdG8ucGIuY21zLlJvYm90TWVzc2FnZUxpc3RSZXF1ZXN0LnByb3RvdHlwZS5zZXJpYWxpemVCaW5hcnkgPSBmdW5jdGlvbiAoKSB7CiAgdmFyIHdyaXRlciA9IG5ldyBqc3BiLkJpbmFyeVdyaXRlcigpOwogIHByb3RvLnBiLmNtcy5Sb2JvdE1lc3NhZ2VMaXN0UmVxdWVzdC5zZXJpYWxpemVCaW5hcnlUb1dyaXRlcih0aGlzLCB3cml0ZXIpOwogIHJldHVybiB3cml0ZXIuZ2V0UmVzdWx0QnVmZmVyKCk7Cn07Ci8qKgogKiBTZXJpYWxpemVzIHRoZSBnaXZlbiBtZXNzYWdlIHRvIGJpbmFyeSBkYXRhIChpbiBwcm90b2J1ZiB3aXJlCiAqIGZvcm1hdCksIHdyaXRpbmcgdG8gdGhlIGdpdmVuIEJpbmFyeVdyaXRlci4KICogQHBhcmFtIHshcHJvdG8ucGIuY21zLlJvYm90TWVzc2FnZUxpc3RSZXF1ZXN0fSBtZXNzYWdlCiAqIEBwYXJhbSB7IWpzcGIuQmluYXJ5V3JpdGVyfSB3cml0ZXIKICogQHN1cHByZXNzIHt1bnVzZWRMb2NhbFZhcmlhYmxlc30gZiBpcyBvbmx5IHVzZWQgZm9yIG5lc3RlZCBtZXNzYWdlcwogKi8KCgpwcm90by5wYi5jbXMuUm9ib3RNZXNzYWdlTGlzdFJlcXVlc3Quc2VyaWFsaXplQmluYXJ5VG9Xcml0ZXIgPSBmdW5jdGlvbiAobWVzc2FnZSwgd3JpdGVyKSB7CiAgdmFyIGYgPSB1bmRlZmluZWQ7CiAgZiA9IG1lc3NhZ2UuZ2V0Um9ib3RJZCgpOwoKICBpZiAoZiAhPT0gMCkgewogICAgd3JpdGVyLndyaXRlVWludDMyKDEsIGYpOwogIH0KfTsKLyoqCiAqIG9wdGlvbmFsIHVpbnQzMiByb2JvdF9pZCA9IDE7CiAqIEByZXR1cm4ge251bWJlcn0KICovCgoKcHJvdG8ucGIuY21zLlJvYm90TWVzc2FnZUxpc3RSZXF1ZXN0LnByb3RvdHlwZS5nZXRSb2JvdElkID0gZnVuY3Rpb24gKCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdCh0aGlzLCAxLCAwKTsKfTsKLyoqCiAqIEBwYXJhbSB7bnVtYmVyfSB2YWx1ZQogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLlJvYm90TWVzc2FnZUxpc3RSZXF1ZXN0fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLlJvYm90TWVzc2FnZUxpc3RSZXF1ZXN0LnByb3RvdHlwZS5zZXRSb2JvdElkID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRQcm90bzNJbnRGaWVsZCh0aGlzLCAxLCB2YWx1ZSk7Cn07Ci8qKgogKiBMaXN0IG9mIHJlcGVhdGVkIGZpZWxkcyB3aXRoaW4gdGhpcyBtZXNzYWdlIHR5cGUuCiAqIEBwcml2YXRlIHshQXJyYXk8bnVtYmVyPn0KICogQGNvbnN0CiAqLwoKCnByb3RvLnBiLmNtcy5Sb2JvdE1lc3NhZ2VMaXN0UmVwbHkucmVwZWF0ZWRGaWVsZHNfID0gWzFdOwoKaWYgKGpzcGIuTWVzc2FnZS5HRU5FUkFURV9UT19PQkpFQ1QpIHsKICAvKioKICAgKiBDcmVhdGVzIGFuIG9iamVjdCByZXByZXNlbnRhdGlvbiBvZiB0aGlzIHByb3RvLgogICAqIEZpZWxkIG5hbWVzIHRoYXQgYXJlIHJlc2VydmVkIGluIEphdmFTY3JpcHQgYW5kIHdpbGwgYmUgcmVuYW1lZCB0byBwYl9uYW1lLgogICAqIE9wdGlvbmFsIGZpZWxkcyB0aGF0IGFyZSBub3Qgc2V0IHdpbGwgYmUgc2V0IHRvIHVuZGVmaW5lZC4KICAgKiBUbyBhY2Nlc3MgYSByZXNlcnZlZCBmaWVsZCB1c2UsIGZvby5wYl88bmFtZT4sIGVnLCBmb28ucGJfZGVmYXVsdC4KICAgKiBGb3IgdGhlIGxpc3Qgb2YgcmVzZXJ2ZWQgbmFtZXMgcGxlYXNlIHNlZToKICAgKiAgICAgbmV0L3Byb3RvMi9jb21waWxlci9qcy9pbnRlcm5hbC9nZW5lcmF0b3IuY2Mja0tleXdvcmQuCiAgICogQHBhcmFtIHtib29sZWFuPX0gb3B0X2luY2x1ZGVJbnN0YW5jZSBEZXByZWNhdGVkLiB3aGV0aGVyIHRvIGluY2x1ZGUgdGhlCiAgICogICAgIEpTUEIgaW5zdGFuY2UgZm9yIHRyYW5zaXRpb25hbCBzb3kgcHJvdG8gc3VwcG9ydDoKICAgKiAgICAgaHR0cDovL2dvdG8vc295LXBhcmFtLW1pZ3JhdGlvbgogICAqIEByZXR1cm4geyFPYmplY3R9CiAgICovCiAgcHJvdG8ucGIuY21zLlJvYm90TWVzc2FnZUxpc3RSZXBseS5wcm90b3R5cGUudG9PYmplY3QgPSBmdW5jdGlvbiAob3B0X2luY2x1ZGVJbnN0YW5jZSkgewogICAgcmV0dXJuIHByb3RvLnBiLmNtcy5Sb2JvdE1lc3NhZ2VMaXN0UmVwbHkudG9PYmplY3Qob3B0X2luY2x1ZGVJbnN0YW5jZSwgdGhpcyk7CiAgfTsKICAvKioKICAgKiBTdGF0aWMgdmVyc2lvbiBvZiB0aGUge0BzZWUgdG9PYmplY3R9IG1ldGhvZC4KICAgKiBAcGFyYW0ge2Jvb2xlYW58dW5kZWZpbmVkfSBpbmNsdWRlSW5zdGFuY2UgRGVwcmVjYXRlZC4gV2hldGhlciB0byBpbmNsdWRlCiAgICogICAgIHRoZSBKU1BCIGluc3RhbmNlIGZvciB0cmFuc2l0aW9uYWwgc295IHByb3RvIHN1cHBvcnQ6CiAgICogICAgIGh0dHA6Ly9nb3RvL3NveS1wYXJhbS1taWdyYXRpb24KICAgKiBAcGFyYW0geyFwcm90by5wYi5jbXMuUm9ib3RNZXNzYWdlTGlzdFJlcGx5fSBtc2cgVGhlIG1zZyBpbnN0YW5jZSB0byB0cmFuc2Zvcm0uCiAgICogQHJldHVybiB7IU9iamVjdH0KICAgKiBAc3VwcHJlc3Mge3VudXNlZExvY2FsVmFyaWFibGVzfSBmIGlzIG9ubHkgdXNlZCBmb3IgbmVzdGVkIG1lc3NhZ2VzCiAgICovCgoKICBwcm90by5wYi5jbXMuUm9ib3RNZXNzYWdlTGlzdFJlcGx5LnRvT2JqZWN0ID0gZnVuY3Rpb24gKGluY2x1ZGVJbnN0YW5jZSwgbXNnKSB7CiAgICB2YXIgZiwKICAgICAgICBvYmogPSB7CiAgICAgIG1lc3NhZ2VzTGlzdDoganNwYi5NZXNzYWdlLnRvT2JqZWN0TGlzdChtc2cuZ2V0TWVzc2FnZXNMaXN0KCksIGNtc3R5cGVfcGIuUm9ib3RNZXNzYWdlLnRvT2JqZWN0LCBpbmNsdWRlSW5zdGFuY2UpCiAgICB9OwoKICAgIGlmIChpbmNsdWRlSW5zdGFuY2UpIHsKICAgICAgb2JqLiRqc3BiTWVzc2FnZUluc3RhbmNlID0gbXNnOwogICAgfQoKICAgIHJldHVybiBvYmo7CiAgfTsKfQovKioKICogRGVzZXJpYWxpemVzIGJpbmFyeSBkYXRhIChpbiBwcm90b2J1ZiB3aXJlIGZvcm1hdCkuCiAqIEBwYXJhbSB7anNwYi5CeXRlU291cmNlfSBieXRlcyBUaGUgYnl0ZXMgdG8gZGVzZXJpYWxpemUuCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuUm9ib3RNZXNzYWdlTGlzdFJlcGx5fQogKi8KCgpwcm90by5wYi5jbXMuUm9ib3RNZXNzYWdlTGlzdFJlcGx5LmRlc2VyaWFsaXplQmluYXJ5ID0gZnVuY3Rpb24gKGJ5dGVzKSB7CiAgdmFyIHJlYWRlciA9IG5ldyBqc3BiLkJpbmFyeVJlYWRlcihieXRlcyk7CiAgdmFyIG1zZyA9IG5ldyBwcm90by5wYi5jbXMuUm9ib3RNZXNzYWdlTGlzdFJlcGx5KCk7CiAgcmV0dXJuIHByb3RvLnBiLmNtcy5Sb2JvdE1lc3NhZ2VMaXN0UmVwbHkuZGVzZXJpYWxpemVCaW5hcnlGcm9tUmVhZGVyKG1zZywgcmVhZGVyKTsKfTsKLyoqCiAqIERlc2VyaWFsaXplcyBiaW5hcnkgZGF0YSAoaW4gcHJvdG9idWYgd2lyZSBmb3JtYXQpIGZyb20gdGhlCiAqIGdpdmVuIHJlYWRlciBpbnRvIHRoZSBnaXZlbiBtZXNzYWdlIG9iamVjdC4KICogQHBhcmFtIHshcHJvdG8ucGIuY21zLlJvYm90TWVzc2FnZUxpc3RSZXBseX0gbXNnIFRoZSBtZXNzYWdlIG9iamVjdCB0byBkZXNlcmlhbGl6ZSBpbnRvLgogKiBAcGFyYW0geyFqc3BiLkJpbmFyeVJlYWRlcn0gcmVhZGVyIFRoZSBCaW5hcnlSZWFkZXIgdG8gdXNlLgogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLlJvYm90TWVzc2FnZUxpc3RSZXBseX0KICovCgoKcHJvdG8ucGIuY21zLlJvYm90TWVzc2FnZUxpc3RSZXBseS5kZXNlcmlhbGl6ZUJpbmFyeUZyb21SZWFkZXIgPSBmdW5jdGlvbiAobXNnLCByZWFkZXIpIHsKICB3aGlsZSAocmVhZGVyLm5leHRGaWVsZCgpKSB7CiAgICBpZiAocmVhZGVyLmlzRW5kR3JvdXAoKSkgewogICAgICBicmVhazsKICAgIH0KCiAgICB2YXIgZmllbGQgPSByZWFkZXIuZ2V0RmllbGROdW1iZXIoKTsKCiAgICBzd2l0Y2ggKGZpZWxkKSB7CiAgICAgIGNhc2UgMToKICAgICAgICB2YXIgdmFsdWUgPSBuZXcgY21zdHlwZV9wYi5Sb2JvdE1lc3NhZ2UoKTsKICAgICAgICByZWFkZXIucmVhZE1lc3NhZ2UodmFsdWUsIGNtc3R5cGVfcGIuUm9ib3RNZXNzYWdlLmRlc2VyaWFsaXplQmluYXJ5RnJvbVJlYWRlcik7CiAgICAgICAgbXNnLmFkZE1lc3NhZ2VzKHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGRlZmF1bHQ6CiAgICAgICAgcmVhZGVyLnNraXBGaWVsZCgpOwogICAgICAgIGJyZWFrOwogICAgfQogIH0KCiAgcmV0dXJuIG1zZzsKfTsKLyoqCiAqIFNlcmlhbGl6ZXMgdGhlIG1lc3NhZ2UgdG8gYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUgZm9ybWF0KS4KICogQHJldHVybiB7IVVpbnQ4QXJyYXl9CiAqLwoKCnByb3RvLnBiLmNtcy5Sb2JvdE1lc3NhZ2VMaXN0UmVwbHkucHJvdG90eXBlLnNlcmlhbGl6ZUJpbmFyeSA9IGZ1bmN0aW9uICgpIHsKICB2YXIgd3JpdGVyID0gbmV3IGpzcGIuQmluYXJ5V3JpdGVyKCk7CiAgcHJvdG8ucGIuY21zLlJvYm90TWVzc2FnZUxpc3RSZXBseS5zZXJpYWxpemVCaW5hcnlUb1dyaXRlcih0aGlzLCB3cml0ZXIpOwogIHJldHVybiB3cml0ZXIuZ2V0UmVzdWx0QnVmZmVyKCk7Cn07Ci8qKgogKiBTZXJpYWxpemVzIHRoZSBnaXZlbiBtZXNzYWdlIHRvIGJpbmFyeSBkYXRhIChpbiBwcm90b2J1ZiB3aXJlCiAqIGZvcm1hdCksIHdyaXRpbmcgdG8gdGhlIGdpdmVuIEJpbmFyeVdyaXRlci4KICogQHBhcmFtIHshcHJvdG8ucGIuY21zLlJvYm90TWVzc2FnZUxpc3RSZXBseX0gbWVzc2FnZQogKiBAcGFyYW0geyFqc3BiLkJpbmFyeVdyaXRlcn0gd3JpdGVyCiAqIEBzdXBwcmVzcyB7dW51c2VkTG9jYWxWYXJpYWJsZXN9IGYgaXMgb25seSB1c2VkIGZvciBuZXN0ZWQgbWVzc2FnZXMKICovCgoKcHJvdG8ucGIuY21zLlJvYm90TWVzc2FnZUxpc3RSZXBseS5zZXJpYWxpemVCaW5hcnlUb1dyaXRlciA9IGZ1bmN0aW9uIChtZXNzYWdlLCB3cml0ZXIpIHsKICB2YXIgZiA9IHVuZGVmaW5lZDsKICBmID0gbWVzc2FnZS5nZXRNZXNzYWdlc0xpc3QoKTsKCiAgaWYgKGYubGVuZ3RoID4gMCkgewogICAgd3JpdGVyLndyaXRlUmVwZWF0ZWRNZXNzYWdlKDEsIGYsIGNtc3R5cGVfcGIuUm9ib3RNZXNzYWdlLnNlcmlhbGl6ZUJpbmFyeVRvV3JpdGVyKTsKICB9Cn07Ci8qKgogKiByZXBlYXRlZCBwYi5Sb2JvdE1lc3NhZ2UgbWVzc2FnZXMgPSAxOwogKiBAcmV0dXJuIHshQXJyYXk8IXByb3RvLnBiLlJvYm90TWVzc2FnZT59CiAqLwoKCnByb3RvLnBiLmNtcy5Sb2JvdE1lc3NhZ2VMaXN0UmVwbHkucHJvdG90eXBlLmdldE1lc3NhZ2VzTGlzdCA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldFJlcGVhdGVkV3JhcHBlckZpZWxkKHRoaXMsIGNtc3R5cGVfcGIuUm9ib3RNZXNzYWdlLCAxKTsKfTsKLyoqCiAqIEBwYXJhbSB7IUFycmF5PCFwcm90by5wYi5Sb2JvdE1lc3NhZ2U+fSB2YWx1ZQogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLlJvYm90TWVzc2FnZUxpc3RSZXBseX0gcmV0dXJucyB0aGlzCiovCgoKcHJvdG8ucGIuY21zLlJvYm90TWVzc2FnZUxpc3RSZXBseS5wcm90b3R5cGUuc2V0TWVzc2FnZXNMaXN0ID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRSZXBlYXRlZFdyYXBwZXJGaWVsZCh0aGlzLCAxLCB2YWx1ZSk7Cn07Ci8qKgogKiBAcGFyYW0geyFwcm90by5wYi5Sb2JvdE1lc3NhZ2U9fSBvcHRfdmFsdWUKICogQHBhcmFtIHtudW1iZXI9fSBvcHRfaW5kZXgKICogQHJldHVybiB7IXByb3RvLnBiLlJvYm90TWVzc2FnZX0KICovCgoKcHJvdG8ucGIuY21zLlJvYm90TWVzc2FnZUxpc3RSZXBseS5wcm90b3R5cGUuYWRkTWVzc2FnZXMgPSBmdW5jdGlvbiAob3B0X3ZhbHVlLCBvcHRfaW5kZXgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmFkZFRvUmVwZWF0ZWRXcmFwcGVyRmllbGQodGhpcywgMSwgb3B0X3ZhbHVlLCBwcm90by5wYi5Sb2JvdE1lc3NhZ2UsIG9wdF9pbmRleCk7Cn07Ci8qKgogKiBDbGVhcnMgdGhlIGxpc3QgbWFraW5nIGl0IGVtcHR5IGJ1dCBub24tbnVsbC4KICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5Sb2JvdE1lc3NhZ2VMaXN0UmVwbHl9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuUm9ib3RNZXNzYWdlTGlzdFJlcGx5LnByb3RvdHlwZS5jbGVhck1lc3NhZ2VzTGlzdCA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4gdGhpcy5zZXRNZXNzYWdlc0xpc3QoW10pOwp9OwoKaWYgKGpzcGIuTWVzc2FnZS5HRU5FUkFURV9UT19PQkpFQ1QpIHsKICAvKioKICAgKiBDcmVhdGVzIGFuIG9iamVjdCByZXByZXNlbnRhdGlvbiBvZiB0aGlzIHByb3RvLgogICAqIEZpZWxkIG5hbWVzIHRoYXQgYXJlIHJlc2VydmVkIGluIEphdmFTY3JpcHQgYW5kIHdpbGwgYmUgcmVuYW1lZCB0byBwYl9uYW1lLgogICAqIE9wdGlvbmFsIGZpZWxkcyB0aGF0IGFyZSBub3Qgc2V0IHdpbGwgYmUgc2V0IHRvIHVuZGVmaW5lZC4KICAgKiBUbyBhY2Nlc3MgYSByZXNlcnZlZCBmaWVsZCB1c2UsIGZvby5wYl88bmFtZT4sIGVnLCBmb28ucGJfZGVmYXVsdC4KICAgKiBGb3IgdGhlIGxpc3Qgb2YgcmVzZXJ2ZWQgbmFtZXMgcGxlYXNlIHNlZToKICAgKiAgICAgbmV0L3Byb3RvMi9jb21waWxlci9qcy9pbnRlcm5hbC9nZW5lcmF0b3IuY2Mja0tleXdvcmQuCiAgICogQHBhcmFtIHtib29sZWFuPX0gb3B0X2luY2x1ZGVJbnN0YW5jZSBEZXByZWNhdGVkLiB3aGV0aGVyIHRvIGluY2x1ZGUgdGhlCiAgICogICAgIEpTUEIgaW5zdGFuY2UgZm9yIHRyYW5zaXRpb25hbCBzb3kgcHJvdG8gc3VwcG9ydDoKICAgKiAgICAgaHR0cDovL2dvdG8vc295LXBhcmFtLW1pZ3JhdGlvbgogICAqIEByZXR1cm4geyFPYmplY3R9CiAgICovCiAgcHJvdG8ucGIuY21zLk1vbWVudExpc3RSZXF1ZXN0LnByb3RvdHlwZS50b09iamVjdCA9IGZ1bmN0aW9uIChvcHRfaW5jbHVkZUluc3RhbmNlKSB7CiAgICByZXR1cm4gcHJvdG8ucGIuY21zLk1vbWVudExpc3RSZXF1ZXN0LnRvT2JqZWN0KG9wdF9pbmNsdWRlSW5zdGFuY2UsIHRoaXMpOwogIH07CiAgLyoqCiAgICogU3RhdGljIHZlcnNpb24gb2YgdGhlIHtAc2VlIHRvT2JqZWN0fSBtZXRob2QuCiAgICogQHBhcmFtIHtib29sZWFufHVuZGVmaW5lZH0gaW5jbHVkZUluc3RhbmNlIERlcHJlY2F0ZWQuIFdoZXRoZXIgdG8gaW5jbHVkZQogICAqICAgICB0aGUgSlNQQiBpbnN0YW5jZSBmb3IgdHJhbnNpdGlvbmFsIHNveSBwcm90byBzdXBwb3J0OgogICAqICAgICBodHRwOi8vZ290by9zb3ktcGFyYW0tbWlncmF0aW9uCiAgICogQHBhcmFtIHshcHJvdG8ucGIuY21zLk1vbWVudExpc3RSZXF1ZXN0fSBtc2cgVGhlIG1zZyBpbnN0YW5jZSB0byB0cmFuc2Zvcm0uCiAgICogQHJldHVybiB7IU9iamVjdH0KICAgKiBAc3VwcHJlc3Mge3VudXNlZExvY2FsVmFyaWFibGVzfSBmIGlzIG9ubHkgdXNlZCBmb3IgbmVzdGVkIG1lc3NhZ2VzCiAgICovCgoKICBwcm90by5wYi5jbXMuTW9tZW50TGlzdFJlcXVlc3QudG9PYmplY3QgPSBmdW5jdGlvbiAoaW5jbHVkZUluc3RhbmNlLCBtc2cpIHsKICAgIHZhciBmLAogICAgICAgIG9iaiA9IHsKICAgICAgZW50aXR5VHlwZToganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQobXNnLCAxLCAwKSwKICAgICAgZW50aXR5SWQ6IGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KG1zZywgMiwgMCkKICAgIH07CgogICAgaWYgKGluY2x1ZGVJbnN0YW5jZSkgewogICAgICBvYmouJGpzcGJNZXNzYWdlSW5zdGFuY2UgPSBtc2c7CiAgICB9CgogICAgcmV0dXJuIG9iajsKICB9Owp9Ci8qKgogKiBEZXNlcmlhbGl6ZXMgYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUgZm9ybWF0KS4KICogQHBhcmFtIHtqc3BiLkJ5dGVTb3VyY2V9IGJ5dGVzIFRoZSBieXRlcyB0byBkZXNlcmlhbGl6ZS4KICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5Nb21lbnRMaXN0UmVxdWVzdH0KICovCgoKcHJvdG8ucGIuY21zLk1vbWVudExpc3RSZXF1ZXN0LmRlc2VyaWFsaXplQmluYXJ5ID0gZnVuY3Rpb24gKGJ5dGVzKSB7CiAgdmFyIHJlYWRlciA9IG5ldyBqc3BiLkJpbmFyeVJlYWRlcihieXRlcyk7CiAgdmFyIG1zZyA9IG5ldyBwcm90by5wYi5jbXMuTW9tZW50TGlzdFJlcXVlc3QoKTsKICByZXR1cm4gcHJvdG8ucGIuY21zLk1vbWVudExpc3RSZXF1ZXN0LmRlc2VyaWFsaXplQmluYXJ5RnJvbVJlYWRlcihtc2csIHJlYWRlcik7Cn07Ci8qKgogKiBEZXNlcmlhbGl6ZXMgYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUgZm9ybWF0KSBmcm9tIHRoZQogKiBnaXZlbiByZWFkZXIgaW50byB0aGUgZ2l2ZW4gbWVzc2FnZSBvYmplY3QuCiAqIEBwYXJhbSB7IXByb3RvLnBiLmNtcy5Nb21lbnRMaXN0UmVxdWVzdH0gbXNnIFRoZSBtZXNzYWdlIG9iamVjdCB0byBkZXNlcmlhbGl6ZSBpbnRvLgogKiBAcGFyYW0geyFqc3BiLkJpbmFyeVJlYWRlcn0gcmVhZGVyIFRoZSBCaW5hcnlSZWFkZXIgdG8gdXNlLgogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLk1vbWVudExpc3RSZXF1ZXN0fQogKi8KCgpwcm90by5wYi5jbXMuTW9tZW50TGlzdFJlcXVlc3QuZGVzZXJpYWxpemVCaW5hcnlGcm9tUmVhZGVyID0gZnVuY3Rpb24gKG1zZywgcmVhZGVyKSB7CiAgd2hpbGUgKHJlYWRlci5uZXh0RmllbGQoKSkgewogICAgaWYgKHJlYWRlci5pc0VuZEdyb3VwKCkpIHsKICAgICAgYnJlYWs7CiAgICB9CgogICAgdmFyIGZpZWxkID0gcmVhZGVyLmdldEZpZWxkTnVtYmVyKCk7CgogICAgc3dpdGNoIChmaWVsZCkgewogICAgICBjYXNlIDE6CiAgICAgICAgdmFyIHZhbHVlID0gcmVhZGVyLnJlYWRFbnVtKCk7CiAgICAgICAgbXNnLnNldEVudGl0eVR5cGUodmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSAyOgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkVWludDMyKCk7CiAgICAgICAgbXNnLnNldEVudGl0eUlkKHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGRlZmF1bHQ6CiAgICAgICAgcmVhZGVyLnNraXBGaWVsZCgpOwogICAgICAgIGJyZWFrOwogICAgfQogIH0KCiAgcmV0dXJuIG1zZzsKfTsKLyoqCiAqIFNlcmlhbGl6ZXMgdGhlIG1lc3NhZ2UgdG8gYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUgZm9ybWF0KS4KICogQHJldHVybiB7IVVpbnQ4QXJyYXl9CiAqLwoKCnByb3RvLnBiLmNtcy5Nb21lbnRMaXN0UmVxdWVzdC5wcm90b3R5cGUuc2VyaWFsaXplQmluYXJ5ID0gZnVuY3Rpb24gKCkgewogIHZhciB3cml0ZXIgPSBuZXcganNwYi5CaW5hcnlXcml0ZXIoKTsKICBwcm90by5wYi5jbXMuTW9tZW50TGlzdFJlcXVlc3Quc2VyaWFsaXplQmluYXJ5VG9Xcml0ZXIodGhpcywgd3JpdGVyKTsKICByZXR1cm4gd3JpdGVyLmdldFJlc3VsdEJ1ZmZlcigpOwp9OwovKioKICogU2VyaWFsaXplcyB0aGUgZ2l2ZW4gbWVzc2FnZSB0byBiaW5hcnkgZGF0YSAoaW4gcHJvdG9idWYgd2lyZQogKiBmb3JtYXQpLCB3cml0aW5nIHRvIHRoZSBnaXZlbiBCaW5hcnlXcml0ZXIuCiAqIEBwYXJhbSB7IXByb3RvLnBiLmNtcy5Nb21lbnRMaXN0UmVxdWVzdH0gbWVzc2FnZQogKiBAcGFyYW0geyFqc3BiLkJpbmFyeVdyaXRlcn0gd3JpdGVyCiAqIEBzdXBwcmVzcyB7dW51c2VkTG9jYWxWYXJpYWJsZXN9IGYgaXMgb25seSB1c2VkIGZvciBuZXN0ZWQgbWVzc2FnZXMKICovCgoKcHJvdG8ucGIuY21zLk1vbWVudExpc3RSZXF1ZXN0LnNlcmlhbGl6ZUJpbmFyeVRvV3JpdGVyID0gZnVuY3Rpb24gKG1lc3NhZ2UsIHdyaXRlcikgewogIHZhciBmID0gdW5kZWZpbmVkOwogIGYgPSBtZXNzYWdlLmdldEVudGl0eVR5cGUoKTsKCiAgaWYgKGYgIT09IDAuMCkgewogICAgd3JpdGVyLndyaXRlRW51bSgxLCBmKTsKICB9CgogIGYgPSBtZXNzYWdlLmdldEVudGl0eUlkKCk7CgogIGlmIChmICE9PSAwKSB7CiAgICB3cml0ZXIud3JpdGVVaW50MzIoMiwgZik7CiAgfQp9OwovKioKICogb3B0aW9uYWwgcGIuRW50aXR5VHlwZSBlbnRpdHlfdHlwZSA9IDE7CiAqIEByZXR1cm4geyFwcm90by5wYi5FbnRpdHlUeXBlfQogKi8KCgpwcm90by5wYi5jbXMuTW9tZW50TGlzdFJlcXVlc3QucHJvdG90eXBlLmdldEVudGl0eVR5cGUgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDEsIDApOwp9OwovKioKICogQHBhcmFtIHshcHJvdG8ucGIuRW50aXR5VHlwZX0gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5Nb21lbnRMaXN0UmVxdWVzdH0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5Nb21lbnRMaXN0UmVxdWVzdC5wcm90b3R5cGUuc2V0RW50aXR5VHlwZSA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UHJvdG8zRW51bUZpZWxkKHRoaXMsIDEsIHZhbHVlKTsKfTsKLyoqCiAqIG9wdGlvbmFsIHVpbnQzMiBlbnRpdHlfaWQgPSAyOwogKiBAcmV0dXJuIHtudW1iZXJ9CiAqLwoKCnByb3RvLnBiLmNtcy5Nb21lbnRMaXN0UmVxdWVzdC5wcm90b3R5cGUuZ2V0RW50aXR5SWQgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDIsIDApOwp9OwovKioKICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuTW9tZW50TGlzdFJlcXVlc3R9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuTW9tZW50TGlzdFJlcXVlc3QucHJvdG90eXBlLnNldEVudGl0eUlkID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRQcm90bzNJbnRGaWVsZCh0aGlzLCAyLCB2YWx1ZSk7Cn07Ci8qKgogKiBMaXN0IG9mIHJlcGVhdGVkIGZpZWxkcyB3aXRoaW4gdGhpcyBtZXNzYWdlIHR5cGUuCiAqIEBwcml2YXRlIHshQXJyYXk8bnVtYmVyPn0KICogQGNvbnN0CiAqLwoKCnByb3RvLnBiLmNtcy5Nb21lbnRMaXN0UmVwbHkucmVwZWF0ZWRGaWVsZHNfID0gWzFdOwoKaWYgKGpzcGIuTWVzc2FnZS5HRU5FUkFURV9UT19PQkpFQ1QpIHsKICAvKioKICAgKiBDcmVhdGVzIGFuIG9iamVjdCByZXByZXNlbnRhdGlvbiBvZiB0aGlzIHByb3RvLgogICAqIEZpZWxkIG5hbWVzIHRoYXQgYXJlIHJlc2VydmVkIGluIEphdmFTY3JpcHQgYW5kIHdpbGwgYmUgcmVuYW1lZCB0byBwYl9uYW1lLgogICAqIE9wdGlvbmFsIGZpZWxkcyB0aGF0IGFyZSBub3Qgc2V0IHdpbGwgYmUgc2V0IHRvIHVuZGVmaW5lZC4KICAgKiBUbyBhY2Nlc3MgYSByZXNlcnZlZCBmaWVsZCB1c2UsIGZvby5wYl88bmFtZT4sIGVnLCBmb28ucGJfZGVmYXVsdC4KICAgKiBGb3IgdGhlIGxpc3Qgb2YgcmVzZXJ2ZWQgbmFtZXMgcGxlYXNlIHNlZToKICAgKiAgICAgbmV0L3Byb3RvMi9jb21waWxlci9qcy9pbnRlcm5hbC9nZW5lcmF0b3IuY2Mja0tleXdvcmQuCiAgICogQHBhcmFtIHtib29sZWFuPX0gb3B0X2luY2x1ZGVJbnN0YW5jZSBEZXByZWNhdGVkLiB3aGV0aGVyIHRvIGluY2x1ZGUgdGhlCiAgICogICAgIEpTUEIgaW5zdGFuY2UgZm9yIHRyYW5zaXRpb25hbCBzb3kgcHJvdG8gc3VwcG9ydDoKICAgKiAgICAgaHR0cDovL2dvdG8vc295LXBhcmFtLW1pZ3JhdGlvbgogICAqIEByZXR1cm4geyFPYmplY3R9CiAgICovCiAgcHJvdG8ucGIuY21zLk1vbWVudExpc3RSZXBseS5wcm90b3R5cGUudG9PYmplY3QgPSBmdW5jdGlvbiAob3B0X2luY2x1ZGVJbnN0YW5jZSkgewogICAgcmV0dXJuIHByb3RvLnBiLmNtcy5Nb21lbnRMaXN0UmVwbHkudG9PYmplY3Qob3B0X2luY2x1ZGVJbnN0YW5jZSwgdGhpcyk7CiAgfTsKICAvKioKICAgKiBTdGF0aWMgdmVyc2lvbiBvZiB0aGUge0BzZWUgdG9PYmplY3R9IG1ldGhvZC4KICAgKiBAcGFyYW0ge2Jvb2xlYW58dW5kZWZpbmVkfSBpbmNsdWRlSW5zdGFuY2UgRGVwcmVjYXRlZC4gV2hldGhlciB0byBpbmNsdWRlCiAgICogICAgIHRoZSBKU1BCIGluc3RhbmNlIGZvciB0cmFuc2l0aW9uYWwgc295IHByb3RvIHN1cHBvcnQ6CiAgICogICAgIGh0dHA6Ly9nb3RvL3NveS1wYXJhbS1taWdyYXRpb24KICAgKiBAcGFyYW0geyFwcm90by5wYi5jbXMuTW9tZW50TGlzdFJlcGx5fSBtc2cgVGhlIG1zZyBpbnN0YW5jZSB0byB0cmFuc2Zvcm0uCiAgICogQHJldHVybiB7IU9iamVjdH0KICAgKiBAc3VwcHJlc3Mge3VudXNlZExvY2FsVmFyaWFibGVzfSBmIGlzIG9ubHkgdXNlZCBmb3IgbmVzdGVkIG1lc3NhZ2VzCiAgICovCgoKICBwcm90by5wYi5jbXMuTW9tZW50TGlzdFJlcGx5LnRvT2JqZWN0ID0gZnVuY3Rpb24gKGluY2x1ZGVJbnN0YW5jZSwgbXNnKSB7CiAgICB2YXIgZiwKICAgICAgICBvYmogPSB7CiAgICAgIG1vbWVudHNMaXN0OiBqc3BiLk1lc3NhZ2UudG9PYmplY3RMaXN0KG1zZy5nZXRNb21lbnRzTGlzdCgpLCB1c2VydHlwZV9wYi5Nb21lbnQudG9PYmplY3QsIGluY2x1ZGVJbnN0YW5jZSkKICAgIH07CgogICAgaWYgKGluY2x1ZGVJbnN0YW5jZSkgewogICAgICBvYmouJGpzcGJNZXNzYWdlSW5zdGFuY2UgPSBtc2c7CiAgICB9CgogICAgcmV0dXJuIG9iajsKICB9Owp9Ci8qKgogKiBEZXNlcmlhbGl6ZXMgYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUgZm9ybWF0KS4KICogQHBhcmFtIHtqc3BiLkJ5dGVTb3VyY2V9IGJ5dGVzIFRoZSBieXRlcyB0byBkZXNlcmlhbGl6ZS4KICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5Nb21lbnRMaXN0UmVwbHl9CiAqLwoKCnByb3RvLnBiLmNtcy5Nb21lbnRMaXN0UmVwbHkuZGVzZXJpYWxpemVCaW5hcnkgPSBmdW5jdGlvbiAoYnl0ZXMpIHsKICB2YXIgcmVhZGVyID0gbmV3IGpzcGIuQmluYXJ5UmVhZGVyKGJ5dGVzKTsKICB2YXIgbXNnID0gbmV3IHByb3RvLnBiLmNtcy5Nb21lbnRMaXN0UmVwbHkoKTsKICByZXR1cm4gcHJvdG8ucGIuY21zLk1vbWVudExpc3RSZXBseS5kZXNlcmlhbGl6ZUJpbmFyeUZyb21SZWFkZXIobXNnLCByZWFkZXIpOwp9OwovKioKICogRGVzZXJpYWxpemVzIGJpbmFyeSBkYXRhIChpbiBwcm90b2J1ZiB3aXJlIGZvcm1hdCkgZnJvbSB0aGUKICogZ2l2ZW4gcmVhZGVyIGludG8gdGhlIGdpdmVuIG1lc3NhZ2Ugb2JqZWN0LgogKiBAcGFyYW0geyFwcm90by5wYi5jbXMuTW9tZW50TGlzdFJlcGx5fSBtc2cgVGhlIG1lc3NhZ2Ugb2JqZWN0IHRvIGRlc2VyaWFsaXplIGludG8uCiAqIEBwYXJhbSB7IWpzcGIuQmluYXJ5UmVhZGVyfSByZWFkZXIgVGhlIEJpbmFyeVJlYWRlciB0byB1c2UuCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuTW9tZW50TGlzdFJlcGx5fQogKi8KCgpwcm90by5wYi5jbXMuTW9tZW50TGlzdFJlcGx5LmRlc2VyaWFsaXplQmluYXJ5RnJvbVJlYWRlciA9IGZ1bmN0aW9uIChtc2csIHJlYWRlcikgewogIHdoaWxlIChyZWFkZXIubmV4dEZpZWxkKCkpIHsKICAgIGlmIChyZWFkZXIuaXNFbmRHcm91cCgpKSB7CiAgICAgIGJyZWFrOwogICAgfQoKICAgIHZhciBmaWVsZCA9IHJlYWRlci5nZXRGaWVsZE51bWJlcigpOwoKICAgIHN3aXRjaCAoZmllbGQpIHsKICAgICAgY2FzZSAxOgogICAgICAgIHZhciB2YWx1ZSA9IG5ldyB1c2VydHlwZV9wYi5Nb21lbnQoKTsKICAgICAgICByZWFkZXIucmVhZE1lc3NhZ2UodmFsdWUsIHVzZXJ0eXBlX3BiLk1vbWVudC5kZXNlcmlhbGl6ZUJpbmFyeUZyb21SZWFkZXIpOwogICAgICAgIG1zZy5hZGRNb21lbnRzKHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGRlZmF1bHQ6CiAgICAgICAgcmVhZGVyLnNraXBGaWVsZCgpOwogICAgICAgIGJyZWFrOwogICAgfQogIH0KCiAgcmV0dXJuIG1zZzsKfTsKLyoqCiAqIFNlcmlhbGl6ZXMgdGhlIG1lc3NhZ2UgdG8gYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUgZm9ybWF0KS4KICogQHJldHVybiB7IVVpbnQ4QXJyYXl9CiAqLwoKCnByb3RvLnBiLmNtcy5Nb21lbnRMaXN0UmVwbHkucHJvdG90eXBlLnNlcmlhbGl6ZUJpbmFyeSA9IGZ1bmN0aW9uICgpIHsKICB2YXIgd3JpdGVyID0gbmV3IGpzcGIuQmluYXJ5V3JpdGVyKCk7CiAgcHJvdG8ucGIuY21zLk1vbWVudExpc3RSZXBseS5zZXJpYWxpemVCaW5hcnlUb1dyaXRlcih0aGlzLCB3cml0ZXIpOwogIHJldHVybiB3cml0ZXIuZ2V0UmVzdWx0QnVmZmVyKCk7Cn07Ci8qKgogKiBTZXJpYWxpemVzIHRoZSBnaXZlbiBtZXNzYWdlIHRvIGJpbmFyeSBkYXRhIChpbiBwcm90b2J1ZiB3aXJlCiAqIGZvcm1hdCksIHdyaXRpbmcgdG8gdGhlIGdpdmVuIEJpbmFyeVdyaXRlci4KICogQHBhcmFtIHshcHJvdG8ucGIuY21zLk1vbWVudExpc3RSZXBseX0gbWVzc2FnZQogKiBAcGFyYW0geyFqc3BiLkJpbmFyeVdyaXRlcn0gd3JpdGVyCiAqIEBzdXBwcmVzcyB7dW51c2VkTG9jYWxWYXJpYWJsZXN9IGYgaXMgb25seSB1c2VkIGZvciBuZXN0ZWQgbWVzc2FnZXMKICovCgoKcHJvdG8ucGIuY21zLk1vbWVudExpc3RSZXBseS5zZXJpYWxpemVCaW5hcnlUb1dyaXRlciA9IGZ1bmN0aW9uIChtZXNzYWdlLCB3cml0ZXIpIHsKICB2YXIgZiA9IHVuZGVmaW5lZDsKICBmID0gbWVzc2FnZS5nZXRNb21lbnRzTGlzdCgpOwoKICBpZiAoZi5sZW5ndGggPiAwKSB7CiAgICB3cml0ZXIud3JpdGVSZXBlYXRlZE1lc3NhZ2UoMSwgZiwgdXNlcnR5cGVfcGIuTW9tZW50LnNlcmlhbGl6ZUJpbmFyeVRvV3JpdGVyKTsKICB9Cn07Ci8qKgogKiByZXBlYXRlZCBwYi5Nb21lbnQgbW9tZW50cyA9IDE7CiAqIEByZXR1cm4geyFBcnJheTwhcHJvdG8ucGIuTW9tZW50Pn0KICovCgoKcHJvdG8ucGIuY21zLk1vbWVudExpc3RSZXBseS5wcm90b3R5cGUuZ2V0TW9tZW50c0xpc3QgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRSZXBlYXRlZFdyYXBwZXJGaWVsZCh0aGlzLCB1c2VydHlwZV9wYi5Nb21lbnQsIDEpOwp9OwovKioKICogQHBhcmFtIHshQXJyYXk8IXByb3RvLnBiLk1vbWVudD59IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuTW9tZW50TGlzdFJlcGx5fSByZXR1cm5zIHRoaXMKKi8KCgpwcm90by5wYi5jbXMuTW9tZW50TGlzdFJlcGx5LnByb3RvdHlwZS5zZXRNb21lbnRzTGlzdCA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UmVwZWF0ZWRXcmFwcGVyRmllbGQodGhpcywgMSwgdmFsdWUpOwp9OwovKioKICogQHBhcmFtIHshcHJvdG8ucGIuTW9tZW50PX0gb3B0X3ZhbHVlCiAqIEBwYXJhbSB7bnVtYmVyPX0gb3B0X2luZGV4CiAqIEByZXR1cm4geyFwcm90by5wYi5Nb21lbnR9CiAqLwoKCnByb3RvLnBiLmNtcy5Nb21lbnRMaXN0UmVwbHkucHJvdG90eXBlLmFkZE1vbWVudHMgPSBmdW5jdGlvbiAob3B0X3ZhbHVlLCBvcHRfaW5kZXgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmFkZFRvUmVwZWF0ZWRXcmFwcGVyRmllbGQodGhpcywgMSwgb3B0X3ZhbHVlLCBwcm90by5wYi5Nb21lbnQsIG9wdF9pbmRleCk7Cn07Ci8qKgogKiBDbGVhcnMgdGhlIGxpc3QgbWFraW5nIGl0IGVtcHR5IGJ1dCBub24tbnVsbC4KICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5Nb21lbnRMaXN0UmVwbHl9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuTW9tZW50TGlzdFJlcGx5LnByb3RvdHlwZS5jbGVhck1vbWVudHNMaXN0ID0gZnVuY3Rpb24gKCkgewogIHJldHVybiB0aGlzLnNldE1vbWVudHNMaXN0KFtdKTsKfTsKCmlmIChqc3BiLk1lc3NhZ2UuR0VORVJBVEVfVE9fT0JKRUNUKSB7CiAgLyoqCiAgICogQ3JlYXRlcyBhbiBvYmplY3QgcmVwcmVzZW50YXRpb24gb2YgdGhpcyBwcm90by4KICAgKiBGaWVsZCBuYW1lcyB0aGF0IGFyZSByZXNlcnZlZCBpbiBKYXZhU2NyaXB0IGFuZCB3aWxsIGJlIHJlbmFtZWQgdG8gcGJfbmFtZS4KICAgKiBPcHRpb25hbCBmaWVsZHMgdGhhdCBhcmUgbm90IHNldCB3aWxsIGJlIHNldCB0byB1bmRlZmluZWQuCiAgICogVG8gYWNjZXNzIGEgcmVzZXJ2ZWQgZmllbGQgdXNlLCBmb28ucGJfPG5hbWU+LCBlZywgZm9vLnBiX2RlZmF1bHQuCiAgICogRm9yIHRoZSBsaXN0IG9mIHJlc2VydmVkIG5hbWVzIHBsZWFzZSBzZWU6CiAgICogICAgIG5ldC9wcm90bzIvY29tcGlsZXIvanMvaW50ZXJuYWwvZ2VuZXJhdG9yLmNjI2tLZXl3b3JkLgogICAqIEBwYXJhbSB7Ym9vbGVhbj19IG9wdF9pbmNsdWRlSW5zdGFuY2UgRGVwcmVjYXRlZC4gd2hldGhlciB0byBpbmNsdWRlIHRoZQogICAqICAgICBKU1BCIGluc3RhbmNlIGZvciB0cmFuc2l0aW9uYWwgc295IHByb3RvIHN1cHBvcnQ6CiAgICogICAgIGh0dHA6Ly9nb3RvL3NveS1wYXJhbS1taWdyYXRpb24KICAgKiBAcmV0dXJuIHshT2JqZWN0fQogICAqLwogIHByb3RvLnBiLmNtcy5BdXRvTWVzc2FnZUxpc3RSZXF1ZXN0LnByb3RvdHlwZS50b09iamVjdCA9IGZ1bmN0aW9uIChvcHRfaW5jbHVkZUluc3RhbmNlKSB7CiAgICByZXR1cm4gcHJvdG8ucGIuY21zLkF1dG9NZXNzYWdlTGlzdFJlcXVlc3QudG9PYmplY3Qob3B0X2luY2x1ZGVJbnN0YW5jZSwgdGhpcyk7CiAgfTsKICAvKioKICAgKiBTdGF0aWMgdmVyc2lvbiBvZiB0aGUge0BzZWUgdG9PYmplY3R9IG1ldGhvZC4KICAgKiBAcGFyYW0ge2Jvb2xlYW58dW5kZWZpbmVkfSBpbmNsdWRlSW5zdGFuY2UgRGVwcmVjYXRlZC4gV2hldGhlciB0byBpbmNsdWRlCiAgICogICAgIHRoZSBKU1BCIGluc3RhbmNlIGZvciB0cmFuc2l0aW9uYWwgc295IHByb3RvIHN1cHBvcnQ6CiAgICogICAgIGh0dHA6Ly9nb3RvL3NveS1wYXJhbS1taWdyYXRpb24KICAgKiBAcGFyYW0geyFwcm90by5wYi5jbXMuQXV0b01lc3NhZ2VMaXN0UmVxdWVzdH0gbXNnIFRoZSBtc2cgaW5zdGFuY2UgdG8gdHJhbnNmb3JtLgogICAqIEByZXR1cm4geyFPYmplY3R9CiAgICogQHN1cHByZXNzIHt1bnVzZWRMb2NhbFZhcmlhYmxlc30gZiBpcyBvbmx5IHVzZWQgZm9yIG5lc3RlZCBtZXNzYWdlcwogICAqLwoKCiAgcHJvdG8ucGIuY21zLkF1dG9NZXNzYWdlTGlzdFJlcXVlc3QudG9PYmplY3QgPSBmdW5jdGlvbiAoaW5jbHVkZUluc3RhbmNlLCBtc2cpIHsKICAgIHZhciBmLAogICAgICAgIG9iaiA9IHsKICAgICAgcGFnZU5vOiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdChtc2csIDEsIDApLAogICAgICBwYWdlU2l6ZToganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQobXNnLCAyLCAwKSwKICAgICAgYXJlYUlkOiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdChtc2csIDMsIDApLAogICAgICBlbmFibGU6IGpzcGIuTWVzc2FnZS5nZXRCb29sZWFuRmllbGRXaXRoRGVmYXVsdChtc2csIDQsIGZhbHNlKSwKICAgICAgYWN0aW9uOiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdChtc2csIDUsIDApCiAgICB9OwoKICAgIGlmIChpbmNsdWRlSW5zdGFuY2UpIHsKICAgICAgb2JqLiRqc3BiTWVzc2FnZUluc3RhbmNlID0gbXNnOwogICAgfQoKICAgIHJldHVybiBvYmo7CiAgfTsKfQovKioKICogRGVzZXJpYWxpemVzIGJpbmFyeSBkYXRhIChpbiBwcm90b2J1ZiB3aXJlIGZvcm1hdCkuCiAqIEBwYXJhbSB7anNwYi5CeXRlU291cmNlfSBieXRlcyBUaGUgYnl0ZXMgdG8gZGVzZXJpYWxpemUuCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuQXV0b01lc3NhZ2VMaXN0UmVxdWVzdH0KICovCgoKcHJvdG8ucGIuY21zLkF1dG9NZXNzYWdlTGlzdFJlcXVlc3QuZGVzZXJpYWxpemVCaW5hcnkgPSBmdW5jdGlvbiAoYnl0ZXMpIHsKICB2YXIgcmVhZGVyID0gbmV3IGpzcGIuQmluYXJ5UmVhZGVyKGJ5dGVzKTsKICB2YXIgbXNnID0gbmV3IHByb3RvLnBiLmNtcy5BdXRvTWVzc2FnZUxpc3RSZXF1ZXN0KCk7CiAgcmV0dXJuIHByb3RvLnBiLmNtcy5BdXRvTWVzc2FnZUxpc3RSZXF1ZXN0LmRlc2VyaWFsaXplQmluYXJ5RnJvbVJlYWRlcihtc2csIHJlYWRlcik7Cn07Ci8qKgogKiBEZXNlcmlhbGl6ZXMgYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUgZm9ybWF0KSBmcm9tIHRoZQogKiBnaXZlbiByZWFkZXIgaW50byB0aGUgZ2l2ZW4gbWVzc2FnZSBvYmplY3QuCiAqIEBwYXJhbSB7IXByb3RvLnBiLmNtcy5BdXRvTWVzc2FnZUxpc3RSZXF1ZXN0fSBtc2cgVGhlIG1lc3NhZ2Ugb2JqZWN0IHRvIGRlc2VyaWFsaXplIGludG8uCiAqIEBwYXJhbSB7IWpzcGIuQmluYXJ5UmVhZGVyfSByZWFkZXIgVGhlIEJpbmFyeVJlYWRlciB0byB1c2UuCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuQXV0b01lc3NhZ2VMaXN0UmVxdWVzdH0KICovCgoKcHJvdG8ucGIuY21zLkF1dG9NZXNzYWdlTGlzdFJlcXVlc3QuZGVzZXJpYWxpemVCaW5hcnlGcm9tUmVhZGVyID0gZnVuY3Rpb24gKG1zZywgcmVhZGVyKSB7CiAgd2hpbGUgKHJlYWRlci5uZXh0RmllbGQoKSkgewogICAgaWYgKHJlYWRlci5pc0VuZEdyb3VwKCkpIHsKICAgICAgYnJlYWs7CiAgICB9CgogICAgdmFyIGZpZWxkID0gcmVhZGVyLmdldEZpZWxkTnVtYmVyKCk7CgogICAgc3dpdGNoIChmaWVsZCkgewogICAgICBjYXNlIDE6CiAgICAgICAgdmFyIHZhbHVlID0gcmVhZGVyLnJlYWRVaW50MzIoKTsKICAgICAgICBtc2cuc2V0UGFnZU5vKHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgMjoKICAgICAgICB2YXIgdmFsdWUgPSByZWFkZXIucmVhZFVpbnQzMigpOwogICAgICAgIG1zZy5zZXRQYWdlU2l6ZSh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlIDM6CiAgICAgICAgdmFyIHZhbHVlID0gcmVhZGVyLnJlYWRVaW50MzIoKTsKICAgICAgICBtc2cuc2V0QXJlYUlkKHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgNDoKICAgICAgICB2YXIgdmFsdWUgPSByZWFkZXIucmVhZEJvb2woKTsKICAgICAgICBtc2cuc2V0RW5hYmxlKHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgNToKICAgICAgICB2YXIgdmFsdWUgPSByZWFkZXIucmVhZEVudW0oKTsKICAgICAgICBtc2cuc2V0QWN0aW9uKHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGRlZmF1bHQ6CiAgICAgICAgcmVhZGVyLnNraXBGaWVsZCgpOwogICAgICAgIGJyZWFrOwogICAgfQogIH0KCiAgcmV0dXJuIG1zZzsKfTsKLyoqCiAqIFNlcmlhbGl6ZXMgdGhlIG1lc3NhZ2UgdG8gYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUgZm9ybWF0KS4KICogQHJldHVybiB7IVVpbnQ4QXJyYXl9CiAqLwoKCnByb3RvLnBiLmNtcy5BdXRvTWVzc2FnZUxpc3RSZXF1ZXN0LnByb3RvdHlwZS5zZXJpYWxpemVCaW5hcnkgPSBmdW5jdGlvbiAoKSB7CiAgdmFyIHdyaXRlciA9IG5ldyBqc3BiLkJpbmFyeVdyaXRlcigpOwogIHByb3RvLnBiLmNtcy5BdXRvTWVzc2FnZUxpc3RSZXF1ZXN0LnNlcmlhbGl6ZUJpbmFyeVRvV3JpdGVyKHRoaXMsIHdyaXRlcik7CiAgcmV0dXJuIHdyaXRlci5nZXRSZXN1bHRCdWZmZXIoKTsKfTsKLyoqCiAqIFNlcmlhbGl6ZXMgdGhlIGdpdmVuIG1lc3NhZ2UgdG8gYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUKICogZm9ybWF0KSwgd3JpdGluZyB0byB0aGUgZ2l2ZW4gQmluYXJ5V3JpdGVyLgogKiBAcGFyYW0geyFwcm90by5wYi5jbXMuQXV0b01lc3NhZ2VMaXN0UmVxdWVzdH0gbWVzc2FnZQogKiBAcGFyYW0geyFqc3BiLkJpbmFyeVdyaXRlcn0gd3JpdGVyCiAqIEBzdXBwcmVzcyB7dW51c2VkTG9jYWxWYXJpYWJsZXN9IGYgaXMgb25seSB1c2VkIGZvciBuZXN0ZWQgbWVzc2FnZXMKICovCgoKcHJvdG8ucGIuY21zLkF1dG9NZXNzYWdlTGlzdFJlcXVlc3Quc2VyaWFsaXplQmluYXJ5VG9Xcml0ZXIgPSBmdW5jdGlvbiAobWVzc2FnZSwgd3JpdGVyKSB7CiAgdmFyIGYgPSB1bmRlZmluZWQ7CiAgZiA9IG1lc3NhZ2UuZ2V0UGFnZU5vKCk7CgogIGlmIChmICE9PSAwKSB7CiAgICB3cml0ZXIud3JpdGVVaW50MzIoMSwgZik7CiAgfQoKICBmID0gbWVzc2FnZS5nZXRQYWdlU2l6ZSgpOwoKICBpZiAoZiAhPT0gMCkgewogICAgd3JpdGVyLndyaXRlVWludDMyKDIsIGYpOwogIH0KCiAgZiA9IG1lc3NhZ2UuZ2V0QXJlYUlkKCk7CgogIGlmIChmICE9PSAwKSB7CiAgICB3cml0ZXIud3JpdGVVaW50MzIoMywgZik7CiAgfQoKICBmID0gbWVzc2FnZS5nZXRFbmFibGUoKTsKCiAgaWYgKGYpIHsKICAgIHdyaXRlci53cml0ZUJvb2woNCwgZik7CiAgfQoKICBmID0gbWVzc2FnZS5nZXRBY3Rpb24oKTsKCiAgaWYgKGYgIT09IDAuMCkgewogICAgd3JpdGVyLndyaXRlRW51bSg1LCBmKTsKICB9Cn07Ci8qKgogKiBvcHRpb25hbCB1aW50MzIgcGFnZV9ubyA9IDE7CiAqIEByZXR1cm4ge251bWJlcn0KICovCgoKcHJvdG8ucGIuY21zLkF1dG9NZXNzYWdlTGlzdFJlcXVlc3QucHJvdG90eXBlLmdldFBhZ2VObyA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQodGhpcywgMSwgMCk7Cn07Ci8qKgogKiBAcGFyYW0ge251bWJlcn0gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5BdXRvTWVzc2FnZUxpc3RSZXF1ZXN0fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLkF1dG9NZXNzYWdlTGlzdFJlcXVlc3QucHJvdG90eXBlLnNldFBhZ2VObyA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UHJvdG8zSW50RmllbGQodGhpcywgMSwgdmFsdWUpOwp9OwovKioKICogb3B0aW9uYWwgdWludDMyIHBhZ2Vfc2l6ZSA9IDI7CiAqIEByZXR1cm4ge251bWJlcn0KICovCgoKcHJvdG8ucGIuY21zLkF1dG9NZXNzYWdlTGlzdFJlcXVlc3QucHJvdG90eXBlLmdldFBhZ2VTaXplID0gZnVuY3Rpb24gKCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdCh0aGlzLCAyLCAwKTsKfTsKLyoqCiAqIEBwYXJhbSB7bnVtYmVyfSB2YWx1ZQogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLkF1dG9NZXNzYWdlTGlzdFJlcXVlc3R9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuQXV0b01lc3NhZ2VMaXN0UmVxdWVzdC5wcm90b3R5cGUuc2V0UGFnZVNpemUgPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0ludEZpZWxkKHRoaXMsIDIsIHZhbHVlKTsKfTsKLyoqCiAqIG9wdGlvbmFsIHVpbnQzMiBhcmVhX2lkID0gMzsKICogQHJldHVybiB7bnVtYmVyfQogKi8KCgpwcm90by5wYi5jbXMuQXV0b01lc3NhZ2VMaXN0UmVxdWVzdC5wcm90b3R5cGUuZ2V0QXJlYUlkID0gZnVuY3Rpb24gKCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdCh0aGlzLCAzLCAwKTsKfTsKLyoqCiAqIEBwYXJhbSB7bnVtYmVyfSB2YWx1ZQogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLkF1dG9NZXNzYWdlTGlzdFJlcXVlc3R9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuQXV0b01lc3NhZ2VMaXN0UmVxdWVzdC5wcm90b3R5cGUuc2V0QXJlYUlkID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRQcm90bzNJbnRGaWVsZCh0aGlzLCAzLCB2YWx1ZSk7Cn07Ci8qKgogKiBvcHRpb25hbCBib29sIGVuYWJsZSA9IDQ7CiAqIEByZXR1cm4ge2Jvb2xlYW59CiAqLwoKCnByb3RvLnBiLmNtcy5BdXRvTWVzc2FnZUxpc3RSZXF1ZXN0LnByb3RvdHlwZS5nZXRFbmFibGUgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRCb29sZWFuRmllbGRXaXRoRGVmYXVsdCh0aGlzLCA0LCBmYWxzZSk7Cn07Ci8qKgogKiBAcGFyYW0ge2Jvb2xlYW59IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuQXV0b01lc3NhZ2VMaXN0UmVxdWVzdH0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5BdXRvTWVzc2FnZUxpc3RSZXF1ZXN0LnByb3RvdHlwZS5zZXRFbmFibGUgPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0Jvb2xlYW5GaWVsZCh0aGlzLCA0LCB2YWx1ZSk7Cn07Ci8qKgogKiBvcHRpb25hbCBwYi5BY3Rpb25UeXBlIGFjdGlvbiA9IDU7CiAqIEByZXR1cm4geyFwcm90by5wYi5BY3Rpb25UeXBlfQogKi8KCgpwcm90by5wYi5jbXMuQXV0b01lc3NhZ2VMaXN0UmVxdWVzdC5wcm90b3R5cGUuZ2V0QWN0aW9uID0gZnVuY3Rpb24gKCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdCh0aGlzLCA1LCAwKTsKfTsKLyoqCiAqIEBwYXJhbSB7IXByb3RvLnBiLkFjdGlvblR5cGV9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuQXV0b01lc3NhZ2VMaXN0UmVxdWVzdH0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5BdXRvTWVzc2FnZUxpc3RSZXF1ZXN0LnByb3RvdHlwZS5zZXRBY3Rpb24gPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0VudW1GaWVsZCh0aGlzLCA1LCB2YWx1ZSk7Cn07Ci8qKgogKiBMaXN0IG9mIHJlcGVhdGVkIGZpZWxkcyB3aXRoaW4gdGhpcyBtZXNzYWdlIHR5cGUuCiAqIEBwcml2YXRlIHshQXJyYXk8bnVtYmVyPn0KICogQGNvbnN0CiAqLwoKCnByb3RvLnBiLmNtcy5BdXRvTWVzc2FnZUxpc3RSZXBseS5yZXBlYXRlZEZpZWxkc18gPSBbMV07CgppZiAoanNwYi5NZXNzYWdlLkdFTkVSQVRFX1RPX09CSkVDVCkgewogIC8qKgogICAqIENyZWF0ZXMgYW4gb2JqZWN0IHJlcHJlc2VudGF0aW9uIG9mIHRoaXMgcHJvdG8uCiAgICogRmllbGQgbmFtZXMgdGhhdCBhcmUgcmVzZXJ2ZWQgaW4gSmF2YVNjcmlwdCBhbmQgd2lsbCBiZSByZW5hbWVkIHRvIHBiX25hbWUuCiAgICogT3B0aW9uYWwgZmllbGRzIHRoYXQgYXJlIG5vdCBzZXQgd2lsbCBiZSBzZXQgdG8gdW5kZWZpbmVkLgogICAqIFRvIGFjY2VzcyBhIHJlc2VydmVkIGZpZWxkIHVzZSwgZm9vLnBiXzxuYW1lPiwgZWcsIGZvby5wYl9kZWZhdWx0LgogICAqIEZvciB0aGUgbGlzdCBvZiByZXNlcnZlZCBuYW1lcyBwbGVhc2Ugc2VlOgogICAqICAgICBuZXQvcHJvdG8yL2NvbXBpbGVyL2pzL2ludGVybmFsL2dlbmVyYXRvci5jYyNrS2V5d29yZC4KICAgKiBAcGFyYW0ge2Jvb2xlYW49fSBvcHRfaW5jbHVkZUluc3RhbmNlIERlcHJlY2F0ZWQuIHdoZXRoZXIgdG8gaW5jbHVkZSB0aGUKICAgKiAgICAgSlNQQiBpbnN0YW5jZSBmb3IgdHJhbnNpdGlvbmFsIHNveSBwcm90byBzdXBwb3J0OgogICAqICAgICBodHRwOi8vZ290by9zb3ktcGFyYW0tbWlncmF0aW9uCiAgICogQHJldHVybiB7IU9iamVjdH0KICAgKi8KICBwcm90by5wYi5jbXMuQXV0b01lc3NhZ2VMaXN0UmVwbHkucHJvdG90eXBlLnRvT2JqZWN0ID0gZnVuY3Rpb24gKG9wdF9pbmNsdWRlSW5zdGFuY2UpIHsKICAgIHJldHVybiBwcm90by5wYi5jbXMuQXV0b01lc3NhZ2VMaXN0UmVwbHkudG9PYmplY3Qob3B0X2luY2x1ZGVJbnN0YW5jZSwgdGhpcyk7CiAgfTsKICAvKioKICAgKiBTdGF0aWMgdmVyc2lvbiBvZiB0aGUge0BzZWUgdG9PYmplY3R9IG1ldGhvZC4KICAgKiBAcGFyYW0ge2Jvb2xlYW58dW5kZWZpbmVkfSBpbmNsdWRlSW5zdGFuY2UgRGVwcmVjYXRlZC4gV2hldGhlciB0byBpbmNsdWRlCiAgICogICAgIHRoZSBKU1BCIGluc3RhbmNlIGZvciB0cmFuc2l0aW9uYWwgc295IHByb3RvIHN1cHBvcnQ6CiAgICogICAgIGh0dHA6Ly9nb3RvL3NveS1wYXJhbS1taWdyYXRpb24KICAgKiBAcGFyYW0geyFwcm90by5wYi5jbXMuQXV0b01lc3NhZ2VMaXN0UmVwbHl9IG1zZyBUaGUgbXNnIGluc3RhbmNlIHRvIHRyYW5zZm9ybS4KICAgKiBAcmV0dXJuIHshT2JqZWN0fQogICAqIEBzdXBwcmVzcyB7dW51c2VkTG9jYWxWYXJpYWJsZXN9IGYgaXMgb25seSB1c2VkIGZvciBuZXN0ZWQgbWVzc2FnZXMKICAgKi8KCgogIHByb3RvLnBiLmNtcy5BdXRvTWVzc2FnZUxpc3RSZXBseS50b09iamVjdCA9IGZ1bmN0aW9uIChpbmNsdWRlSW5zdGFuY2UsIG1zZykgewogICAgdmFyIGYsCiAgICAgICAgb2JqID0gewogICAgICBtZXNzYWdlc0xpc3Q6IGpzcGIuTWVzc2FnZS50b09iamVjdExpc3QobXNnLmdldE1lc3NhZ2VzTGlzdCgpLCBjbXN0eXBlX3BiLkF1dG9NZXNzYWdlLnRvT2JqZWN0LCBpbmNsdWRlSW5zdGFuY2UpLAogICAgICBwYWdlTm86IGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KG1zZywgMiwgMCksCiAgICAgIHBhZ2VTaXplOiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdChtc2csIDMsIDApLAogICAgICB0b3RhbFBhZ2U6IGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KG1zZywgNCwgMCksCiAgICAgIHRvdGFsQ291bnQ6IGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KG1zZywgNSwgMCkKICAgIH07CgogICAgaWYgKGluY2x1ZGVJbnN0YW5jZSkgewogICAgICBvYmouJGpzcGJNZXNzYWdlSW5zdGFuY2UgPSBtc2c7CiAgICB9CgogICAgcmV0dXJuIG9iajsKICB9Owp9Ci8qKgogKiBEZXNlcmlhbGl6ZXMgYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUgZm9ybWF0KS4KICogQHBhcmFtIHtqc3BiLkJ5dGVTb3VyY2V9IGJ5dGVzIFRoZSBieXRlcyB0byBkZXNlcmlhbGl6ZS4KICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5BdXRvTWVzc2FnZUxpc3RSZXBseX0KICovCgoKcHJvdG8ucGIuY21zLkF1dG9NZXNzYWdlTGlzdFJlcGx5LmRlc2VyaWFsaXplQmluYXJ5ID0gZnVuY3Rpb24gKGJ5dGVzKSB7CiAgdmFyIHJlYWRlciA9IG5ldyBqc3BiLkJpbmFyeVJlYWRlcihieXRlcyk7CiAgdmFyIG1zZyA9IG5ldyBwcm90by5wYi5jbXMuQXV0b01lc3NhZ2VMaXN0UmVwbHkoKTsKICByZXR1cm4gcHJvdG8ucGIuY21zLkF1dG9NZXNzYWdlTGlzdFJlcGx5LmRlc2VyaWFsaXplQmluYXJ5RnJvbVJlYWRlcihtc2csIHJlYWRlcik7Cn07Ci8qKgogKiBEZXNlcmlhbGl6ZXMgYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUgZm9ybWF0KSBmcm9tIHRoZQogKiBnaXZlbiByZWFkZXIgaW50byB0aGUgZ2l2ZW4gbWVzc2FnZSBvYmplY3QuCiAqIEBwYXJhbSB7IXByb3RvLnBiLmNtcy5BdXRvTWVzc2FnZUxpc3RSZXBseX0gbXNnIFRoZSBtZXNzYWdlIG9iamVjdCB0byBkZXNlcmlhbGl6ZSBpbnRvLgogKiBAcGFyYW0geyFqc3BiLkJpbmFyeVJlYWRlcn0gcmVhZGVyIFRoZSBCaW5hcnlSZWFkZXIgdG8gdXNlLgogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLkF1dG9NZXNzYWdlTGlzdFJlcGx5fQogKi8KCgpwcm90by5wYi5jbXMuQXV0b01lc3NhZ2VMaXN0UmVwbHkuZGVzZXJpYWxpemVCaW5hcnlGcm9tUmVhZGVyID0gZnVuY3Rpb24gKG1zZywgcmVhZGVyKSB7CiAgd2hpbGUgKHJlYWRlci5uZXh0RmllbGQoKSkgewogICAgaWYgKHJlYWRlci5pc0VuZEdyb3VwKCkpIHsKICAgICAgYnJlYWs7CiAgICB9CgogICAgdmFyIGZpZWxkID0gcmVhZGVyLmdldEZpZWxkTnVtYmVyKCk7CgogICAgc3dpdGNoIChmaWVsZCkgewogICAgICBjYXNlIDE6CiAgICAgICAgdmFyIHZhbHVlID0gbmV3IGNtc3R5cGVfcGIuQXV0b01lc3NhZ2UoKTsKICAgICAgICByZWFkZXIucmVhZE1lc3NhZ2UodmFsdWUsIGNtc3R5cGVfcGIuQXV0b01lc3NhZ2UuZGVzZXJpYWxpemVCaW5hcnlGcm9tUmVhZGVyKTsKICAgICAgICBtc2cuYWRkTWVzc2FnZXModmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSAyOgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkVWludDMyKCk7CiAgICAgICAgbXNnLnNldFBhZ2VObyh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlIDM6CiAgICAgICAgdmFyIHZhbHVlID0gcmVhZGVyLnJlYWRVaW50MzIoKTsKICAgICAgICBtc2cuc2V0UGFnZVNpemUodmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSA0OgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkVWludDMyKCk7CiAgICAgICAgbXNnLnNldFRvdGFsUGFnZSh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlIDU6CiAgICAgICAgdmFyIHZhbHVlID0gcmVhZGVyLnJlYWRVaW50MzIoKTsKICAgICAgICBtc2cuc2V0VG90YWxDb3VudCh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBkZWZhdWx0OgogICAgICAgIHJlYWRlci5za2lwRmllbGQoKTsKICAgICAgICBicmVhazsKICAgIH0KICB9CgogIHJldHVybiBtc2c7Cn07Ci8qKgogKiBTZXJpYWxpemVzIHRoZSBtZXNzYWdlIHRvIGJpbmFyeSBkYXRhIChpbiBwcm90b2J1ZiB3aXJlIGZvcm1hdCkuCiAqIEByZXR1cm4geyFVaW50OEFycmF5fQogKi8KCgpwcm90by5wYi5jbXMuQXV0b01lc3NhZ2VMaXN0UmVwbHkucHJvdG90eXBlLnNlcmlhbGl6ZUJpbmFyeSA9IGZ1bmN0aW9uICgpIHsKICB2YXIgd3JpdGVyID0gbmV3IGpzcGIuQmluYXJ5V3JpdGVyKCk7CiAgcHJvdG8ucGIuY21zLkF1dG9NZXNzYWdlTGlzdFJlcGx5LnNlcmlhbGl6ZUJpbmFyeVRvV3JpdGVyKHRoaXMsIHdyaXRlcik7CiAgcmV0dXJuIHdyaXRlci5nZXRSZXN1bHRCdWZmZXIoKTsKfTsKLyoqCiAqIFNlcmlhbGl6ZXMgdGhlIGdpdmVuIG1lc3NhZ2UgdG8gYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUKICogZm9ybWF0KSwgd3JpdGluZyB0byB0aGUgZ2l2ZW4gQmluYXJ5V3JpdGVyLgogKiBAcGFyYW0geyFwcm90by5wYi5jbXMuQXV0b01lc3NhZ2VMaXN0UmVwbHl9IG1lc3NhZ2UKICogQHBhcmFtIHshanNwYi5CaW5hcnlXcml0ZXJ9IHdyaXRlcgogKiBAc3VwcHJlc3Mge3VudXNlZExvY2FsVmFyaWFibGVzfSBmIGlzIG9ubHkgdXNlZCBmb3IgbmVzdGVkIG1lc3NhZ2VzCiAqLwoKCnByb3RvLnBiLmNtcy5BdXRvTWVzc2FnZUxpc3RSZXBseS5zZXJpYWxpemVCaW5hcnlUb1dyaXRlciA9IGZ1bmN0aW9uIChtZXNzYWdlLCB3cml0ZXIpIHsKICB2YXIgZiA9IHVuZGVmaW5lZDsKICBmID0gbWVzc2FnZS5nZXRNZXNzYWdlc0xpc3QoKTsKCiAgaWYgKGYubGVuZ3RoID4gMCkgewogICAgd3JpdGVyLndyaXRlUmVwZWF0ZWRNZXNzYWdlKDEsIGYsIGNtc3R5cGVfcGIuQXV0b01lc3NhZ2Uuc2VyaWFsaXplQmluYXJ5VG9Xcml0ZXIpOwogIH0KCiAgZiA9IG1lc3NhZ2UuZ2V0UGFnZU5vKCk7CgogIGlmIChmICE9PSAwKSB7CiAgICB3cml0ZXIud3JpdGVVaW50MzIoMiwgZik7CiAgfQoKICBmID0gbWVzc2FnZS5nZXRQYWdlU2l6ZSgpOwoKICBpZiAoZiAhPT0gMCkgewogICAgd3JpdGVyLndyaXRlVWludDMyKDMsIGYpOwogIH0KCiAgZiA9IG1lc3NhZ2UuZ2V0VG90YWxQYWdlKCk7CgogIGlmIChmICE9PSAwKSB7CiAgICB3cml0ZXIud3JpdGVVaW50MzIoNCwgZik7CiAgfQoKICBmID0gbWVzc2FnZS5nZXRUb3RhbENvdW50KCk7CgogIGlmIChmICE9PSAwKSB7CiAgICB3cml0ZXIud3JpdGVVaW50MzIoNSwgZik7CiAgfQp9OwovKioKICogcmVwZWF0ZWQgcGIuQXV0b01lc3NhZ2UgbWVzc2FnZXMgPSAxOwogKiBAcmV0dXJuIHshQXJyYXk8IXByb3RvLnBiLkF1dG9NZXNzYWdlPn0KICovCgoKcHJvdG8ucGIuY21zLkF1dG9NZXNzYWdlTGlzdFJlcGx5LnByb3RvdHlwZS5nZXRNZXNzYWdlc0xpc3QgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRSZXBlYXRlZFdyYXBwZXJGaWVsZCh0aGlzLCBjbXN0eXBlX3BiLkF1dG9NZXNzYWdlLCAxKTsKfTsKLyoqCiAqIEBwYXJhbSB7IUFycmF5PCFwcm90by5wYi5BdXRvTWVzc2FnZT59IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuQXV0b01lc3NhZ2VMaXN0UmVwbHl9IHJldHVybnMgdGhpcwoqLwoKCnByb3RvLnBiLmNtcy5BdXRvTWVzc2FnZUxpc3RSZXBseS5wcm90b3R5cGUuc2V0TWVzc2FnZXNMaXN0ID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRSZXBlYXRlZFdyYXBwZXJGaWVsZCh0aGlzLCAxLCB2YWx1ZSk7Cn07Ci8qKgogKiBAcGFyYW0geyFwcm90by5wYi5BdXRvTWVzc2FnZT19IG9wdF92YWx1ZQogKiBAcGFyYW0ge251bWJlcj19IG9wdF9pbmRleAogKiBAcmV0dXJuIHshcHJvdG8ucGIuQXV0b01lc3NhZ2V9CiAqLwoKCnByb3RvLnBiLmNtcy5BdXRvTWVzc2FnZUxpc3RSZXBseS5wcm90b3R5cGUuYWRkTWVzc2FnZXMgPSBmdW5jdGlvbiAob3B0X3ZhbHVlLCBvcHRfaW5kZXgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmFkZFRvUmVwZWF0ZWRXcmFwcGVyRmllbGQodGhpcywgMSwgb3B0X3ZhbHVlLCBwcm90by5wYi5BdXRvTWVzc2FnZSwgb3B0X2luZGV4KTsKfTsKLyoqCiAqIENsZWFycyB0aGUgbGlzdCBtYWtpbmcgaXQgZW1wdHkgYnV0IG5vbi1udWxsLgogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLkF1dG9NZXNzYWdlTGlzdFJlcGx5fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLkF1dG9NZXNzYWdlTGlzdFJlcGx5LnByb3RvdHlwZS5jbGVhck1lc3NhZ2VzTGlzdCA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4gdGhpcy5zZXRNZXNzYWdlc0xpc3QoW10pOwp9OwovKioKICogb3B0aW9uYWwgdWludDMyIHBhZ2Vfbm8gPSAyOwogKiBAcmV0dXJuIHtudW1iZXJ9CiAqLwoKCnByb3RvLnBiLmNtcy5BdXRvTWVzc2FnZUxpc3RSZXBseS5wcm90b3R5cGUuZ2V0UGFnZU5vID0gZnVuY3Rpb24gKCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdCh0aGlzLCAyLCAwKTsKfTsKLyoqCiAqIEBwYXJhbSB7bnVtYmVyfSB2YWx1ZQogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLkF1dG9NZXNzYWdlTGlzdFJlcGx5fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLkF1dG9NZXNzYWdlTGlzdFJlcGx5LnByb3RvdHlwZS5zZXRQYWdlTm8gPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0ludEZpZWxkKHRoaXMsIDIsIHZhbHVlKTsKfTsKLyoqCiAqIG9wdGlvbmFsIHVpbnQzMiBwYWdlX3NpemUgPSAzOwogKiBAcmV0dXJuIHtudW1iZXJ9CiAqLwoKCnByb3RvLnBiLmNtcy5BdXRvTWVzc2FnZUxpc3RSZXBseS5wcm90b3R5cGUuZ2V0UGFnZVNpemUgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDMsIDApOwp9OwovKioKICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuQXV0b01lc3NhZ2VMaXN0UmVwbHl9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuQXV0b01lc3NhZ2VMaXN0UmVwbHkucHJvdG90eXBlLnNldFBhZ2VTaXplID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRQcm90bzNJbnRGaWVsZCh0aGlzLCAzLCB2YWx1ZSk7Cn07Ci8qKgogKiBvcHRpb25hbCB1aW50MzIgdG90YWxfcGFnZSA9IDQ7CiAqIEByZXR1cm4ge251bWJlcn0KICovCgoKcHJvdG8ucGIuY21zLkF1dG9NZXNzYWdlTGlzdFJlcGx5LnByb3RvdHlwZS5nZXRUb3RhbFBhZ2UgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDQsIDApOwp9OwovKioKICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuQXV0b01lc3NhZ2VMaXN0UmVwbHl9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuQXV0b01lc3NhZ2VMaXN0UmVwbHkucHJvdG90eXBlLnNldFRvdGFsUGFnZSA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UHJvdG8zSW50RmllbGQodGhpcywgNCwgdmFsdWUpOwp9OwovKioKICogb3B0aW9uYWwgdWludDMyIHRvdGFsX2NvdW50ID0gNTsKICogQHJldHVybiB7bnVtYmVyfQogKi8KCgpwcm90by5wYi5jbXMuQXV0b01lc3NhZ2VMaXN0UmVwbHkucHJvdG90eXBlLmdldFRvdGFsQ291bnQgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDUsIDApOwp9OwovKioKICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuQXV0b01lc3NhZ2VMaXN0UmVwbHl9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuQXV0b01lc3NhZ2VMaXN0UmVwbHkucHJvdG90eXBlLnNldFRvdGFsQ291bnQgPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0ludEZpZWxkKHRoaXMsIDUsIHZhbHVlKTsKfTsKCmlmIChqc3BiLk1lc3NhZ2UuR0VORVJBVEVfVE9fT0JKRUNUKSB7CiAgLyoqCiAgICogQ3JlYXRlcyBhbiBvYmplY3QgcmVwcmVzZW50YXRpb24gb2YgdGhpcyBwcm90by4KICAgKiBGaWVsZCBuYW1lcyB0aGF0IGFyZSByZXNlcnZlZCBpbiBKYXZhU2NyaXB0IGFuZCB3aWxsIGJlIHJlbmFtZWQgdG8gcGJfbmFtZS4KICAgKiBPcHRpb25hbCBmaWVsZHMgdGhhdCBhcmUgbm90IHNldCB3aWxsIGJlIHNldCB0byB1bmRlZmluZWQuCiAgICogVG8gYWNjZXNzIGEgcmVzZXJ2ZWQgZmllbGQgdXNlLCBmb28ucGJfPG5hbWU+LCBlZywgZm9vLnBiX2RlZmF1bHQuCiAgICogRm9yIHRoZSBsaXN0IG9mIHJlc2VydmVkIG5hbWVzIHBsZWFzZSBzZWU6CiAgICogICAgIG5ldC9wcm90bzIvY29tcGlsZXIvanMvaW50ZXJuYWwvZ2VuZXJhdG9yLmNjI2tLZXl3b3JkLgogICAqIEBwYXJhbSB7Ym9vbGVhbj19IG9wdF9pbmNsdWRlSW5zdGFuY2UgRGVwcmVjYXRlZC4gd2hldGhlciB0byBpbmNsdWRlIHRoZQogICAqICAgICBKU1BCIGluc3RhbmNlIGZvciB0cmFuc2l0aW9uYWwgc295IHByb3RvIHN1cHBvcnQ6CiAgICogICAgIGh0dHA6Ly9nb3RvL3NveS1wYXJhbS1taWdyYXRpb24KICAgKiBAcmV0dXJuIHshT2JqZWN0fQogICAqLwogIHByb3RvLnBiLmNtcy5DaGF0TWVzc2FnZUxpc3RSZXF1ZXN0LnByb3RvdHlwZS50b09iamVjdCA9IGZ1bmN0aW9uIChvcHRfaW5jbHVkZUluc3RhbmNlKSB7CiAgICByZXR1cm4gcHJvdG8ucGIuY21zLkNoYXRNZXNzYWdlTGlzdFJlcXVlc3QudG9PYmplY3Qob3B0X2luY2x1ZGVJbnN0YW5jZSwgdGhpcyk7CiAgfTsKICAvKioKICAgKiBTdGF0aWMgdmVyc2lvbiBvZiB0aGUge0BzZWUgdG9PYmplY3R9IG1ldGhvZC4KICAgKiBAcGFyYW0ge2Jvb2xlYW58dW5kZWZpbmVkfSBpbmNsdWRlSW5zdGFuY2UgRGVwcmVjYXRlZC4gV2hldGhlciB0byBpbmNsdWRlCiAgICogICAgIHRoZSBKU1BCIGluc3RhbmNlIGZvciB0cmFuc2l0aW9uYWwgc295IHByb3RvIHN1cHBvcnQ6CiAgICogICAgIGh0dHA6Ly9nb3RvL3NveS1wYXJhbS1taWdyYXRpb24KICAgKiBAcGFyYW0geyFwcm90by5wYi5jbXMuQ2hhdE1lc3NhZ2VMaXN0UmVxdWVzdH0gbXNnIFRoZSBtc2cgaW5zdGFuY2UgdG8gdHJhbnNmb3JtLgogICAqIEByZXR1cm4geyFPYmplY3R9CiAgICogQHN1cHByZXNzIHt1bnVzZWRMb2NhbFZhcmlhYmxlc30gZiBpcyBvbmx5IHVzZWQgZm9yIG5lc3RlZCBtZXNzYWdlcwogICAqLwoKCiAgcHJvdG8ucGIuY21zLkNoYXRNZXNzYWdlTGlzdFJlcXVlc3QudG9PYmplY3QgPSBmdW5jdGlvbiAoaW5jbHVkZUluc3RhbmNlLCBtc2cpIHsKICAgIHZhciBmLAogICAgICAgIG9iaiA9IHsKICAgICAgcGFnZU5vOiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdChtc2csIDEsIDApLAogICAgICBwYWdlU2l6ZToganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQobXNnLCAyLCAwKSwKICAgICAgYXJlYUlkOiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdChtc2csIDMsIDApLAogICAgICBhcHBJZDoganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQobXNnLCA0LCAwKSwKICAgICAgdXNlcklkOiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdChtc2csIDUsIDApLAogICAgICBhbmNob3JJZDoganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQobXNnLCA2LCAwKSwKICAgICAgZGlyZWN0aW9uOiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdChtc2csIDcsIDApLAogICAgICB0eXBlOiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdChtc2csIDgsIDApLAogICAgICBrZXl3b3JkOiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdChtc2csIDksICIiKSwKICAgICAgY3JlYXRlZFN0YXJ0OiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdChtc2csIDEwLCAwKSwKICAgICAgY3JlYXRlZEVuZDoganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQobXNnLCAxMSwgMCkKICAgIH07CgogICAgaWYgKGluY2x1ZGVJbnN0YW5jZSkgewogICAgICBvYmouJGpzcGJNZXNzYWdlSW5zdGFuY2UgPSBtc2c7CiAgICB9CgogICAgcmV0dXJuIG9iajsKICB9Owp9Ci8qKgogKiBEZXNlcmlhbGl6ZXMgYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUgZm9ybWF0KS4KICogQHBhcmFtIHtqc3BiLkJ5dGVTb3VyY2V9IGJ5dGVzIFRoZSBieXRlcyB0byBkZXNlcmlhbGl6ZS4KICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5DaGF0TWVzc2FnZUxpc3RSZXF1ZXN0fQogKi8KCgpwcm90by5wYi5jbXMuQ2hhdE1lc3NhZ2VMaXN0UmVxdWVzdC5kZXNlcmlhbGl6ZUJpbmFyeSA9IGZ1bmN0aW9uIChieXRlcykgewogIHZhciByZWFkZXIgPSBuZXcganNwYi5CaW5hcnlSZWFkZXIoYnl0ZXMpOwogIHZhciBtc2cgPSBuZXcgcHJvdG8ucGIuY21zLkNoYXRNZXNzYWdlTGlzdFJlcXVlc3QoKTsKICByZXR1cm4gcHJvdG8ucGIuY21zLkNoYXRNZXNzYWdlTGlzdFJlcXVlc3QuZGVzZXJpYWxpemVCaW5hcnlGcm9tUmVhZGVyKG1zZywgcmVhZGVyKTsKfTsKLyoqCiAqIERlc2VyaWFsaXplcyBiaW5hcnkgZGF0YSAoaW4gcHJvdG9idWYgd2lyZSBmb3JtYXQpIGZyb20gdGhlCiAqIGdpdmVuIHJlYWRlciBpbnRvIHRoZSBnaXZlbiBtZXNzYWdlIG9iamVjdC4KICogQHBhcmFtIHshcHJvdG8ucGIuY21zLkNoYXRNZXNzYWdlTGlzdFJlcXVlc3R9IG1zZyBUaGUgbWVzc2FnZSBvYmplY3QgdG8gZGVzZXJpYWxpemUgaW50by4KICogQHBhcmFtIHshanNwYi5CaW5hcnlSZWFkZXJ9IHJlYWRlciBUaGUgQmluYXJ5UmVhZGVyIHRvIHVzZS4KICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5DaGF0TWVzc2FnZUxpc3RSZXF1ZXN0fQogKi8KCgpwcm90by5wYi5jbXMuQ2hhdE1lc3NhZ2VMaXN0UmVxdWVzdC5kZXNlcmlhbGl6ZUJpbmFyeUZyb21SZWFkZXIgPSBmdW5jdGlvbiAobXNnLCByZWFkZXIpIHsKICB3aGlsZSAocmVhZGVyLm5leHRGaWVsZCgpKSB7CiAgICBpZiAocmVhZGVyLmlzRW5kR3JvdXAoKSkgewogICAgICBicmVhazsKICAgIH0KCiAgICB2YXIgZmllbGQgPSByZWFkZXIuZ2V0RmllbGROdW1iZXIoKTsKCiAgICBzd2l0Y2ggKGZpZWxkKSB7CiAgICAgIGNhc2UgMToKICAgICAgICB2YXIgdmFsdWUgPSByZWFkZXIucmVhZFVpbnQzMigpOwogICAgICAgIG1zZy5zZXRQYWdlTm8odmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSAyOgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkVWludDMyKCk7CiAgICAgICAgbXNnLnNldFBhZ2VTaXplKHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgMzoKICAgICAgICB2YXIgdmFsdWUgPSByZWFkZXIucmVhZFVpbnQzMigpOwogICAgICAgIG1zZy5zZXRBcmVhSWQodmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSA0OgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkVWludDMyKCk7CiAgICAgICAgbXNnLnNldEFwcElkKHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgNToKICAgICAgICB2YXIgdmFsdWUgPSByZWFkZXIucmVhZFVpbnQzMigpOwogICAgICAgIG1zZy5zZXRVc2VySWQodmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSA2OgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkVWludDMyKCk7CiAgICAgICAgbXNnLnNldEFuY2hvcklkKHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgNzoKICAgICAgICB2YXIgdmFsdWUgPSByZWFkZXIucmVhZEVudW0oKTsKICAgICAgICBtc2cuc2V0RGlyZWN0aW9uKHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgODoKICAgICAgICB2YXIgdmFsdWUgPSByZWFkZXIucmVhZEVudW0oKTsKICAgICAgICBtc2cuc2V0VHlwZSh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlIDk6CiAgICAgICAgdmFyIHZhbHVlID0gcmVhZGVyLnJlYWRTdHJpbmcoKTsKICAgICAgICBtc2cuc2V0S2V5d29yZCh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlIDEwOgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkVWludDMyKCk7CiAgICAgICAgbXNnLnNldENyZWF0ZWRTdGFydCh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlIDExOgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkVWludDMyKCk7CiAgICAgICAgbXNnLnNldENyZWF0ZWRFbmQodmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgZGVmYXVsdDoKICAgICAgICByZWFkZXIuc2tpcEZpZWxkKCk7CiAgICAgICAgYnJlYWs7CiAgICB9CiAgfQoKICByZXR1cm4gbXNnOwp9OwovKioKICogU2VyaWFsaXplcyB0aGUgbWVzc2FnZSB0byBiaW5hcnkgZGF0YSAoaW4gcHJvdG9idWYgd2lyZSBmb3JtYXQpLgogKiBAcmV0dXJuIHshVWludDhBcnJheX0KICovCgoKcHJvdG8ucGIuY21zLkNoYXRNZXNzYWdlTGlzdFJlcXVlc3QucHJvdG90eXBlLnNlcmlhbGl6ZUJpbmFyeSA9IGZ1bmN0aW9uICgpIHsKICB2YXIgd3JpdGVyID0gbmV3IGpzcGIuQmluYXJ5V3JpdGVyKCk7CiAgcHJvdG8ucGIuY21zLkNoYXRNZXNzYWdlTGlzdFJlcXVlc3Quc2VyaWFsaXplQmluYXJ5VG9Xcml0ZXIodGhpcywgd3JpdGVyKTsKICByZXR1cm4gd3JpdGVyLmdldFJlc3VsdEJ1ZmZlcigpOwp9OwovKioKICogU2VyaWFsaXplcyB0aGUgZ2l2ZW4gbWVzc2FnZSB0byBiaW5hcnkgZGF0YSAoaW4gcHJvdG9idWYgd2lyZQogKiBmb3JtYXQpLCB3cml0aW5nIHRvIHRoZSBnaXZlbiBCaW5hcnlXcml0ZXIuCiAqIEBwYXJhbSB7IXByb3RvLnBiLmNtcy5DaGF0TWVzc2FnZUxpc3RSZXF1ZXN0fSBtZXNzYWdlCiAqIEBwYXJhbSB7IWpzcGIuQmluYXJ5V3JpdGVyfSB3cml0ZXIKICogQHN1cHByZXNzIHt1bnVzZWRMb2NhbFZhcmlhYmxlc30gZiBpcyBvbmx5IHVzZWQgZm9yIG5lc3RlZCBtZXNzYWdlcwogKi8KCgpwcm90by5wYi5jbXMuQ2hhdE1lc3NhZ2VMaXN0UmVxdWVzdC5zZXJpYWxpemVCaW5hcnlUb1dyaXRlciA9IGZ1bmN0aW9uIChtZXNzYWdlLCB3cml0ZXIpIHsKICB2YXIgZiA9IHVuZGVmaW5lZDsKICBmID0gbWVzc2FnZS5nZXRQYWdlTm8oKTsKCiAgaWYgKGYgIT09IDApIHsKICAgIHdyaXRlci53cml0ZVVpbnQzMigxLCBmKTsKICB9CgogIGYgPSBtZXNzYWdlLmdldFBhZ2VTaXplKCk7CgogIGlmIChmICE9PSAwKSB7CiAgICB3cml0ZXIud3JpdGVVaW50MzIoMiwgZik7CiAgfQoKICBmID0gbWVzc2FnZS5nZXRBcmVhSWQoKTsKCiAgaWYgKGYgIT09IDApIHsKICAgIHdyaXRlci53cml0ZVVpbnQzMigzLCBmKTsKICB9CgogIGYgPSBtZXNzYWdlLmdldEFwcElkKCk7CgogIGlmIChmICE9PSAwKSB7CiAgICB3cml0ZXIud3JpdGVVaW50MzIoNCwgZik7CiAgfQoKICBmID0gbWVzc2FnZS5nZXRVc2VySWQoKTsKCiAgaWYgKGYgIT09IDApIHsKICAgIHdyaXRlci53cml0ZVVpbnQzMig1LCBmKTsKICB9CgogIGYgPSBtZXNzYWdlLmdldEFuY2hvcklkKCk7CgogIGlmIChmICE9PSAwKSB7CiAgICB3cml0ZXIud3JpdGVVaW50MzIoNiwgZik7CiAgfQoKICBmID0gbWVzc2FnZS5nZXREaXJlY3Rpb24oKTsKCiAgaWYgKGYgIT09IDAuMCkgewogICAgd3JpdGVyLndyaXRlRW51bSg3LCBmKTsKICB9CgogIGYgPSBtZXNzYWdlLmdldFR5cGUoKTsKCiAgaWYgKGYgIT09IDAuMCkgewogICAgd3JpdGVyLndyaXRlRW51bSg4LCBmKTsKICB9CgogIGYgPSBtZXNzYWdlLmdldEtleXdvcmQoKTsKCiAgaWYgKGYubGVuZ3RoID4gMCkgewogICAgd3JpdGVyLndyaXRlU3RyaW5nKDksIGYpOwogIH0KCiAgZiA9IG1lc3NhZ2UuZ2V0Q3JlYXRlZFN0YXJ0KCk7CgogIGlmIChmICE9PSAwKSB7CiAgICB3cml0ZXIud3JpdGVVaW50MzIoMTAsIGYpOwogIH0KCiAgZiA9IG1lc3NhZ2UuZ2V0Q3JlYXRlZEVuZCgpOwoKICBpZiAoZiAhPT0gMCkgewogICAgd3JpdGVyLndyaXRlVWludDMyKDExLCBmKTsKICB9Cn07Ci8qKgogKiBvcHRpb25hbCB1aW50MzIgcGFnZV9ubyA9IDE7CiAqIEByZXR1cm4ge251bWJlcn0KICovCgoKcHJvdG8ucGIuY21zLkNoYXRNZXNzYWdlTGlzdFJlcXVlc3QucHJvdG90eXBlLmdldFBhZ2VObyA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQodGhpcywgMSwgMCk7Cn07Ci8qKgogKiBAcGFyYW0ge251bWJlcn0gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5DaGF0TWVzc2FnZUxpc3RSZXF1ZXN0fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLkNoYXRNZXNzYWdlTGlzdFJlcXVlc3QucHJvdG90eXBlLnNldFBhZ2VObyA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UHJvdG8zSW50RmllbGQodGhpcywgMSwgdmFsdWUpOwp9OwovKioKICogb3B0aW9uYWwgdWludDMyIHBhZ2Vfc2l6ZSA9IDI7CiAqIEByZXR1cm4ge251bWJlcn0KICovCgoKcHJvdG8ucGIuY21zLkNoYXRNZXNzYWdlTGlzdFJlcXVlc3QucHJvdG90eXBlLmdldFBhZ2VTaXplID0gZnVuY3Rpb24gKCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdCh0aGlzLCAyLCAwKTsKfTsKLyoqCiAqIEBwYXJhbSB7bnVtYmVyfSB2YWx1ZQogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLkNoYXRNZXNzYWdlTGlzdFJlcXVlc3R9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuQ2hhdE1lc3NhZ2VMaXN0UmVxdWVzdC5wcm90b3R5cGUuc2V0UGFnZVNpemUgPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0ludEZpZWxkKHRoaXMsIDIsIHZhbHVlKTsKfTsKLyoqCiAqIG9wdGlvbmFsIHVpbnQzMiBhcmVhX2lkID0gMzsKICogQHJldHVybiB7bnVtYmVyfQogKi8KCgpwcm90by5wYi5jbXMuQ2hhdE1lc3NhZ2VMaXN0UmVxdWVzdC5wcm90b3R5cGUuZ2V0QXJlYUlkID0gZnVuY3Rpb24gKCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdCh0aGlzLCAzLCAwKTsKfTsKLyoqCiAqIEBwYXJhbSB7bnVtYmVyfSB2YWx1ZQogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLkNoYXRNZXNzYWdlTGlzdFJlcXVlc3R9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuQ2hhdE1lc3NhZ2VMaXN0UmVxdWVzdC5wcm90b3R5cGUuc2V0QXJlYUlkID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRQcm90bzNJbnRGaWVsZCh0aGlzLCAzLCB2YWx1ZSk7Cn07Ci8qKgogKiBvcHRpb25hbCB1aW50MzIgYXBwX2lkID0gNDsKICogQHJldHVybiB7bnVtYmVyfQogKi8KCgpwcm90by5wYi5jbXMuQ2hhdE1lc3NhZ2VMaXN0UmVxdWVzdC5wcm90b3R5cGUuZ2V0QXBwSWQgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDQsIDApOwp9OwovKioKICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuQ2hhdE1lc3NhZ2VMaXN0UmVxdWVzdH0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5DaGF0TWVzc2FnZUxpc3RSZXF1ZXN0LnByb3RvdHlwZS5zZXRBcHBJZCA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UHJvdG8zSW50RmllbGQodGhpcywgNCwgdmFsdWUpOwp9OwovKioKICogb3B0aW9uYWwgdWludDMyIHVzZXJfaWQgPSA1OwogKiBAcmV0dXJuIHtudW1iZXJ9CiAqLwoKCnByb3RvLnBiLmNtcy5DaGF0TWVzc2FnZUxpc3RSZXF1ZXN0LnByb3RvdHlwZS5nZXRVc2VySWQgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDUsIDApOwp9OwovKioKICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuQ2hhdE1lc3NhZ2VMaXN0UmVxdWVzdH0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5DaGF0TWVzc2FnZUxpc3RSZXF1ZXN0LnByb3RvdHlwZS5zZXRVc2VySWQgPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0ludEZpZWxkKHRoaXMsIDUsIHZhbHVlKTsKfTsKLyoqCiAqIG9wdGlvbmFsIHVpbnQzMiBhbmNob3JfaWQgPSA2OwogKiBAcmV0dXJuIHtudW1iZXJ9CiAqLwoKCnByb3RvLnBiLmNtcy5DaGF0TWVzc2FnZUxpc3RSZXF1ZXN0LnByb3RvdHlwZS5nZXRBbmNob3JJZCA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQodGhpcywgNiwgMCk7Cn07Ci8qKgogKiBAcGFyYW0ge251bWJlcn0gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5DaGF0TWVzc2FnZUxpc3RSZXF1ZXN0fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLkNoYXRNZXNzYWdlTGlzdFJlcXVlc3QucHJvdG90eXBlLnNldEFuY2hvcklkID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRQcm90bzNJbnRGaWVsZCh0aGlzLCA2LCB2YWx1ZSk7Cn07Ci8qKgogKiBvcHRpb25hbCBwYi5NZXNzYWdlRGlyZWN0aW9uIGRpcmVjdGlvbiA9IDc7CiAqIEByZXR1cm4geyFwcm90by5wYi5NZXNzYWdlRGlyZWN0aW9ufQogKi8KCgpwcm90by5wYi5jbXMuQ2hhdE1lc3NhZ2VMaXN0UmVxdWVzdC5wcm90b3R5cGUuZ2V0RGlyZWN0aW9uID0gZnVuY3Rpb24gKCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdCh0aGlzLCA3LCAwKTsKfTsKLyoqCiAqIEBwYXJhbSB7IXByb3RvLnBiLk1lc3NhZ2VEaXJlY3Rpb259IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuQ2hhdE1lc3NhZ2VMaXN0UmVxdWVzdH0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5DaGF0TWVzc2FnZUxpc3RSZXF1ZXN0LnByb3RvdHlwZS5zZXREaXJlY3Rpb24gPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0VudW1GaWVsZCh0aGlzLCA3LCB2YWx1ZSk7Cn07Ci8qKgogKiBvcHRpb25hbCBwYi5NZXNzYWdlVHlwZSB0eXBlID0gODsKICogQHJldHVybiB7IXByb3RvLnBiLk1lc3NhZ2VUeXBlfQogKi8KCgpwcm90by5wYi5jbXMuQ2hhdE1lc3NhZ2VMaXN0UmVxdWVzdC5wcm90b3R5cGUuZ2V0VHlwZSA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQodGhpcywgOCwgMCk7Cn07Ci8qKgogKiBAcGFyYW0geyFwcm90by5wYi5NZXNzYWdlVHlwZX0gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5DaGF0TWVzc2FnZUxpc3RSZXF1ZXN0fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLkNoYXRNZXNzYWdlTGlzdFJlcXVlc3QucHJvdG90eXBlLnNldFR5cGUgPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0VudW1GaWVsZCh0aGlzLCA4LCB2YWx1ZSk7Cn07Ci8qKgogKiBvcHRpb25hbCBzdHJpbmcga2V5d29yZCA9IDk7CiAqIEByZXR1cm4ge3N0cmluZ30KICovCgoKcHJvdG8ucGIuY21zLkNoYXRNZXNzYWdlTGlzdFJlcXVlc3QucHJvdG90eXBlLmdldEtleXdvcmQgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDksICIiKTsKfTsKLyoqCiAqIEBwYXJhbSB7c3RyaW5nfSB2YWx1ZQogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLkNoYXRNZXNzYWdlTGlzdFJlcXVlc3R9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuQ2hhdE1lc3NhZ2VMaXN0UmVxdWVzdC5wcm90b3R5cGUuc2V0S2V5d29yZCA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UHJvdG8zU3RyaW5nRmllbGQodGhpcywgOSwgdmFsdWUpOwp9OwovKioKICogb3B0aW9uYWwgdWludDMyIGNyZWF0ZWRfc3RhcnQgPSAxMDsKICogQHJldHVybiB7bnVtYmVyfQogKi8KCgpwcm90by5wYi5jbXMuQ2hhdE1lc3NhZ2VMaXN0UmVxdWVzdC5wcm90b3R5cGUuZ2V0Q3JlYXRlZFN0YXJ0ID0gZnVuY3Rpb24gKCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdCh0aGlzLCAxMCwgMCk7Cn07Ci8qKgogKiBAcGFyYW0ge251bWJlcn0gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5DaGF0TWVzc2FnZUxpc3RSZXF1ZXN0fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLkNoYXRNZXNzYWdlTGlzdFJlcXVlc3QucHJvdG90eXBlLnNldENyZWF0ZWRTdGFydCA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UHJvdG8zSW50RmllbGQodGhpcywgMTAsIHZhbHVlKTsKfTsKLyoqCiAqIG9wdGlvbmFsIHVpbnQzMiBjcmVhdGVkX2VuZCA9IDExOwogKiBAcmV0dXJuIHtudW1iZXJ9CiAqLwoKCnByb3RvLnBiLmNtcy5DaGF0TWVzc2FnZUxpc3RSZXF1ZXN0LnByb3RvdHlwZS5nZXRDcmVhdGVkRW5kID0gZnVuY3Rpb24gKCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdCh0aGlzLCAxMSwgMCk7Cn07Ci8qKgogKiBAcGFyYW0ge251bWJlcn0gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5DaGF0TWVzc2FnZUxpc3RSZXF1ZXN0fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLkNoYXRNZXNzYWdlTGlzdFJlcXVlc3QucHJvdG90eXBlLnNldENyZWF0ZWRFbmQgPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0ludEZpZWxkKHRoaXMsIDExLCB2YWx1ZSk7Cn07Ci8qKgogKiBMaXN0IG9mIHJlcGVhdGVkIGZpZWxkcyB3aXRoaW4gdGhpcyBtZXNzYWdlIHR5cGUuCiAqIEBwcml2YXRlIHshQXJyYXk8bnVtYmVyPn0KICogQGNvbnN0CiAqLwoKCnByb3RvLnBiLmNtcy5DaGF0TWVzc2FnZUxpc3RSZXBseS5yZXBlYXRlZEZpZWxkc18gPSBbMV07CgppZiAoanNwYi5NZXNzYWdlLkdFTkVSQVRFX1RPX09CSkVDVCkgewogIC8qKgogICAqIENyZWF0ZXMgYW4gb2JqZWN0IHJlcHJlc2VudGF0aW9uIG9mIHRoaXMgcHJvdG8uCiAgICogRmllbGQgbmFtZXMgdGhhdCBhcmUgcmVzZXJ2ZWQgaW4gSmF2YVNjcmlwdCBhbmQgd2lsbCBiZSByZW5hbWVkIHRvIHBiX25hbWUuCiAgICogT3B0aW9uYWwgZmllbGRzIHRoYXQgYXJlIG5vdCBzZXQgd2lsbCBiZSBzZXQgdG8gdW5kZWZpbmVkLgogICAqIFRvIGFjY2VzcyBhIHJlc2VydmVkIGZpZWxkIHVzZSwgZm9vLnBiXzxuYW1lPiwgZWcsIGZvby5wYl9kZWZhdWx0LgogICAqIEZvciB0aGUgbGlzdCBvZiByZXNlcnZlZCBuYW1lcyBwbGVhc2Ugc2VlOgogICAqICAgICBuZXQvcHJvdG8yL2NvbXBpbGVyL2pzL2ludGVybmFsL2dlbmVyYXRvci5jYyNrS2V5d29yZC4KICAgKiBAcGFyYW0ge2Jvb2xlYW49fSBvcHRfaW5jbHVkZUluc3RhbmNlIERlcHJlY2F0ZWQuIHdoZXRoZXIgdG8gaW5jbHVkZSB0aGUKICAgKiAgICAgSlNQQiBpbnN0YW5jZSBmb3IgdHJhbnNpdGlvbmFsIHNveSBwcm90byBzdXBwb3J0OgogICAqICAgICBodHRwOi8vZ290by9zb3ktcGFyYW0tbWlncmF0aW9uCiAgICogQHJldHVybiB7IU9iamVjdH0KICAgKi8KICBwcm90by5wYi5jbXMuQ2hhdE1lc3NhZ2VMaXN0UmVwbHkucHJvdG90eXBlLnRvT2JqZWN0ID0gZnVuY3Rpb24gKG9wdF9pbmNsdWRlSW5zdGFuY2UpIHsKICAgIHJldHVybiBwcm90by5wYi5jbXMuQ2hhdE1lc3NhZ2VMaXN0UmVwbHkudG9PYmplY3Qob3B0X2luY2x1ZGVJbnN0YW5jZSwgdGhpcyk7CiAgfTsKICAvKioKICAgKiBTdGF0aWMgdmVyc2lvbiBvZiB0aGUge0BzZWUgdG9PYmplY3R9IG1ldGhvZC4KICAgKiBAcGFyYW0ge2Jvb2xlYW58dW5kZWZpbmVkfSBpbmNsdWRlSW5zdGFuY2UgRGVwcmVjYXRlZC4gV2hldGhlciB0byBpbmNsdWRlCiAgICogICAgIHRoZSBKU1BCIGluc3RhbmNlIGZvciB0cmFuc2l0aW9uYWwgc295IHByb3RvIHN1cHBvcnQ6CiAgICogICAgIGh0dHA6Ly9nb3RvL3NveS1wYXJhbS1taWdyYXRpb24KICAgKiBAcGFyYW0geyFwcm90by5wYi5jbXMuQ2hhdE1lc3NhZ2VMaXN0UmVwbHl9IG1zZyBUaGUgbXNnIGluc3RhbmNlIHRvIHRyYW5zZm9ybS4KICAgKiBAcmV0dXJuIHshT2JqZWN0fQogICAqIEBzdXBwcmVzcyB7dW51c2VkTG9jYWxWYXJpYWJsZXN9IGYgaXMgb25seSB1c2VkIGZvciBuZXN0ZWQgbWVzc2FnZXMKICAgKi8KCgogIHByb3RvLnBiLmNtcy5DaGF0TWVzc2FnZUxpc3RSZXBseS50b09iamVjdCA9IGZ1bmN0aW9uIChpbmNsdWRlSW5zdGFuY2UsIG1zZykgewogICAgdmFyIGYsCiAgICAgICAgb2JqID0gewogICAgICBtZXNzYWdlc0xpc3Q6IGpzcGIuTWVzc2FnZS50b09iamVjdExpc3QobXNnLmdldE1lc3NhZ2VzTGlzdCgpLCBjbXN0eXBlX3BiLkNoYXRNZXNzYWdlLnRvT2JqZWN0LCBpbmNsdWRlSW5zdGFuY2UpLAogICAgICBwYWdlTm86IGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KG1zZywgMiwgMCksCiAgICAgIHBhZ2VTaXplOiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdChtc2csIDMsIDApLAogICAgICB0b3RhbFBhZ2U6IGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KG1zZywgNCwgMCksCiAgICAgIHRvdGFsQ291bnQ6IGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KG1zZywgNSwgMCkKICAgIH07CgogICAgaWYgKGluY2x1ZGVJbnN0YW5jZSkgewogICAgICBvYmouJGpzcGJNZXNzYWdlSW5zdGFuY2UgPSBtc2c7CiAgICB9CgogICAgcmV0dXJuIG9iajsKICB9Owp9Ci8qKgogKiBEZXNlcmlhbGl6ZXMgYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUgZm9ybWF0KS4KICogQHBhcmFtIHtqc3BiLkJ5dGVTb3VyY2V9IGJ5dGVzIFRoZSBieXRlcyB0byBkZXNlcmlhbGl6ZS4KICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5DaGF0TWVzc2FnZUxpc3RSZXBseX0KICovCgoKcHJvdG8ucGIuY21zLkNoYXRNZXNzYWdlTGlzdFJlcGx5LmRlc2VyaWFsaXplQmluYXJ5ID0gZnVuY3Rpb24gKGJ5dGVzKSB7CiAgdmFyIHJlYWRlciA9IG5ldyBqc3BiLkJpbmFyeVJlYWRlcihieXRlcyk7CiAgdmFyIG1zZyA9IG5ldyBwcm90by5wYi5jbXMuQ2hhdE1lc3NhZ2VMaXN0UmVwbHkoKTsKICByZXR1cm4gcHJvdG8ucGIuY21zLkNoYXRNZXNzYWdlTGlzdFJlcGx5LmRlc2VyaWFsaXplQmluYXJ5RnJvbVJlYWRlcihtc2csIHJlYWRlcik7Cn07Ci8qKgogKiBEZXNlcmlhbGl6ZXMgYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUgZm9ybWF0KSBmcm9tIHRoZQogKiBnaXZlbiByZWFkZXIgaW50byB0aGUgZ2l2ZW4gbWVzc2FnZSBvYmplY3QuCiAqIEBwYXJhbSB7IXByb3RvLnBiLmNtcy5DaGF0TWVzc2FnZUxpc3RSZXBseX0gbXNnIFRoZSBtZXNzYWdlIG9iamVjdCB0byBkZXNlcmlhbGl6ZSBpbnRvLgogKiBAcGFyYW0geyFqc3BiLkJpbmFyeVJlYWRlcn0gcmVhZGVyIFRoZSBCaW5hcnlSZWFkZXIgdG8gdXNlLgogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLkNoYXRNZXNzYWdlTGlzdFJlcGx5fQogKi8KCgpwcm90by5wYi5jbXMuQ2hhdE1lc3NhZ2VMaXN0UmVwbHkuZGVzZXJpYWxpemVCaW5hcnlGcm9tUmVhZGVyID0gZnVuY3Rpb24gKG1zZywgcmVhZGVyKSB7CiAgd2hpbGUgKHJlYWRlci5uZXh0RmllbGQoKSkgewogICAgaWYgKHJlYWRlci5pc0VuZEdyb3VwKCkpIHsKICAgICAgYnJlYWs7CiAgICB9CgogICAgdmFyIGZpZWxkID0gcmVhZGVyLmdldEZpZWxkTnVtYmVyKCk7CgogICAgc3dpdGNoIChmaWVsZCkgewogICAgICBjYXNlIDE6CiAgICAgICAgdmFyIHZhbHVlID0gbmV3IGNtc3R5cGVfcGIuQ2hhdE1lc3NhZ2UoKTsKICAgICAgICByZWFkZXIucmVhZE1lc3NhZ2UodmFsdWUsIGNtc3R5cGVfcGIuQ2hhdE1lc3NhZ2UuZGVzZXJpYWxpemVCaW5hcnlGcm9tUmVhZGVyKTsKICAgICAgICBtc2cuYWRkTWVzc2FnZXModmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSAyOgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkVWludDMyKCk7CiAgICAgICAgbXNnLnNldFBhZ2VObyh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlIDM6CiAgICAgICAgdmFyIHZhbHVlID0gcmVhZGVyLnJlYWRVaW50MzIoKTsKICAgICAgICBtc2cuc2V0UGFnZVNpemUodmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSA0OgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkVWludDMyKCk7CiAgICAgICAgbXNnLnNldFRvdGFsUGFnZSh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlIDU6CiAgICAgICAgdmFyIHZhbHVlID0gcmVhZGVyLnJlYWRVaW50MzIoKTsKICAgICAgICBtc2cuc2V0VG90YWxDb3VudCh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBkZWZhdWx0OgogICAgICAgIHJlYWRlci5za2lwRmllbGQoKTsKICAgICAgICBicmVhazsKICAgIH0KICB9CgogIHJldHVybiBtc2c7Cn07Ci8qKgogKiBTZXJpYWxpemVzIHRoZSBtZXNzYWdlIHRvIGJpbmFyeSBkYXRhIChpbiBwcm90b2J1ZiB3aXJlIGZvcm1hdCkuCiAqIEByZXR1cm4geyFVaW50OEFycmF5fQogKi8KCgpwcm90by5wYi5jbXMuQ2hhdE1lc3NhZ2VMaXN0UmVwbHkucHJvdG90eXBlLnNlcmlhbGl6ZUJpbmFyeSA9IGZ1bmN0aW9uICgpIHsKICB2YXIgd3JpdGVyID0gbmV3IGpzcGIuQmluYXJ5V3JpdGVyKCk7CiAgcHJvdG8ucGIuY21zLkNoYXRNZXNzYWdlTGlzdFJlcGx5LnNlcmlhbGl6ZUJpbmFyeVRvV3JpdGVyKHRoaXMsIHdyaXRlcik7CiAgcmV0dXJuIHdyaXRlci5nZXRSZXN1bHRCdWZmZXIoKTsKfTsKLyoqCiAqIFNlcmlhbGl6ZXMgdGhlIGdpdmVuIG1lc3NhZ2UgdG8gYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUKICogZm9ybWF0KSwgd3JpdGluZyB0byB0aGUgZ2l2ZW4gQmluYXJ5V3JpdGVyLgogKiBAcGFyYW0geyFwcm90by5wYi5jbXMuQ2hhdE1lc3NhZ2VMaXN0UmVwbHl9IG1lc3NhZ2UKICogQHBhcmFtIHshanNwYi5CaW5hcnlXcml0ZXJ9IHdyaXRlcgogKiBAc3VwcHJlc3Mge3VudXNlZExvY2FsVmFyaWFibGVzfSBmIGlzIG9ubHkgdXNlZCBmb3IgbmVzdGVkIG1lc3NhZ2VzCiAqLwoKCnByb3RvLnBiLmNtcy5DaGF0TWVzc2FnZUxpc3RSZXBseS5zZXJpYWxpemVCaW5hcnlUb1dyaXRlciA9IGZ1bmN0aW9uIChtZXNzYWdlLCB3cml0ZXIpIHsKICB2YXIgZiA9IHVuZGVmaW5lZDsKICBmID0gbWVzc2FnZS5nZXRNZXNzYWdlc0xpc3QoKTsKCiAgaWYgKGYubGVuZ3RoID4gMCkgewogICAgd3JpdGVyLndyaXRlUmVwZWF0ZWRNZXNzYWdlKDEsIGYsIGNtc3R5cGVfcGIuQ2hhdE1lc3NhZ2Uuc2VyaWFsaXplQmluYXJ5VG9Xcml0ZXIpOwogIH0KCiAgZiA9IG1lc3NhZ2UuZ2V0UGFnZU5vKCk7CgogIGlmIChmICE9PSAwKSB7CiAgICB3cml0ZXIud3JpdGVVaW50MzIoMiwgZik7CiAgfQoKICBmID0gbWVzc2FnZS5nZXRQYWdlU2l6ZSgpOwoKICBpZiAoZiAhPT0gMCkgewogICAgd3JpdGVyLndyaXRlVWludDMyKDMsIGYpOwogIH0KCiAgZiA9IG1lc3NhZ2UuZ2V0VG90YWxQYWdlKCk7CgogIGlmIChmICE9PSAwKSB7CiAgICB3cml0ZXIud3JpdGVVaW50MzIoNCwgZik7CiAgfQoKICBmID0gbWVzc2FnZS5nZXRUb3RhbENvdW50KCk7CgogIGlmIChmICE9PSAwKSB7CiAgICB3cml0ZXIud3JpdGVVaW50MzIoNSwgZik7CiAgfQp9OwovKioKICogcmVwZWF0ZWQgcGIuQ2hhdE1lc3NhZ2UgbWVzc2FnZXMgPSAxOwogKiBAcmV0dXJuIHshQXJyYXk8IXByb3RvLnBiLkNoYXRNZXNzYWdlPn0KICovCgoKcHJvdG8ucGIuY21zLkNoYXRNZXNzYWdlTGlzdFJlcGx5LnByb3RvdHlwZS5nZXRNZXNzYWdlc0xpc3QgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRSZXBlYXRlZFdyYXBwZXJGaWVsZCh0aGlzLCBjbXN0eXBlX3BiLkNoYXRNZXNzYWdlLCAxKTsKfTsKLyoqCiAqIEBwYXJhbSB7IUFycmF5PCFwcm90by5wYi5DaGF0TWVzc2FnZT59IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuQ2hhdE1lc3NhZ2VMaXN0UmVwbHl9IHJldHVybnMgdGhpcwoqLwoKCnByb3RvLnBiLmNtcy5DaGF0TWVzc2FnZUxpc3RSZXBseS5wcm90b3R5cGUuc2V0TWVzc2FnZXNMaXN0ID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRSZXBlYXRlZFdyYXBwZXJGaWVsZCh0aGlzLCAxLCB2YWx1ZSk7Cn07Ci8qKgogKiBAcGFyYW0geyFwcm90by5wYi5DaGF0TWVzc2FnZT19IG9wdF92YWx1ZQogKiBAcGFyYW0ge251bWJlcj19IG9wdF9pbmRleAogKiBAcmV0dXJuIHshcHJvdG8ucGIuQ2hhdE1lc3NhZ2V9CiAqLwoKCnByb3RvLnBiLmNtcy5DaGF0TWVzc2FnZUxpc3RSZXBseS5wcm90b3R5cGUuYWRkTWVzc2FnZXMgPSBmdW5jdGlvbiAob3B0X3ZhbHVlLCBvcHRfaW5kZXgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmFkZFRvUmVwZWF0ZWRXcmFwcGVyRmllbGQodGhpcywgMSwgb3B0X3ZhbHVlLCBwcm90by5wYi5DaGF0TWVzc2FnZSwgb3B0X2luZGV4KTsKfTsKLyoqCiAqIENsZWFycyB0aGUgbGlzdCBtYWtpbmcgaXQgZW1wdHkgYnV0IG5vbi1udWxsLgogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLkNoYXRNZXNzYWdlTGlzdFJlcGx5fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLkNoYXRNZXNzYWdlTGlzdFJlcGx5LnByb3RvdHlwZS5jbGVhck1lc3NhZ2VzTGlzdCA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4gdGhpcy5zZXRNZXNzYWdlc0xpc3QoW10pOwp9OwovKioKICogb3B0aW9uYWwgdWludDMyIHBhZ2Vfbm8gPSAyOwogKiBAcmV0dXJuIHtudW1iZXJ9CiAqLwoKCnByb3RvLnBiLmNtcy5DaGF0TWVzc2FnZUxpc3RSZXBseS5wcm90b3R5cGUuZ2V0UGFnZU5vID0gZnVuY3Rpb24gKCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdCh0aGlzLCAyLCAwKTsKfTsKLyoqCiAqIEBwYXJhbSB7bnVtYmVyfSB2YWx1ZQogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLkNoYXRNZXNzYWdlTGlzdFJlcGx5fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLkNoYXRNZXNzYWdlTGlzdFJlcGx5LnByb3RvdHlwZS5zZXRQYWdlTm8gPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0ludEZpZWxkKHRoaXMsIDIsIHZhbHVlKTsKfTsKLyoqCiAqIG9wdGlvbmFsIHVpbnQzMiBwYWdlX3NpemUgPSAzOwogKiBAcmV0dXJuIHtudW1iZXJ9CiAqLwoKCnByb3RvLnBiLmNtcy5DaGF0TWVzc2FnZUxpc3RSZXBseS5wcm90b3R5cGUuZ2V0UGFnZVNpemUgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDMsIDApOwp9OwovKioKICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuQ2hhdE1lc3NhZ2VMaXN0UmVwbHl9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuQ2hhdE1lc3NhZ2VMaXN0UmVwbHkucHJvdG90eXBlLnNldFBhZ2VTaXplID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRQcm90bzNJbnRGaWVsZCh0aGlzLCAzLCB2YWx1ZSk7Cn07Ci8qKgogKiBvcHRpb25hbCB1aW50MzIgdG90YWxfcGFnZSA9IDQ7CiAqIEByZXR1cm4ge251bWJlcn0KICovCgoKcHJvdG8ucGIuY21zLkNoYXRNZXNzYWdlTGlzdFJlcGx5LnByb3RvdHlwZS5nZXRUb3RhbFBhZ2UgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDQsIDApOwp9OwovKioKICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuQ2hhdE1lc3NhZ2VMaXN0UmVwbHl9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuQ2hhdE1lc3NhZ2VMaXN0UmVwbHkucHJvdG90eXBlLnNldFRvdGFsUGFnZSA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UHJvdG8zSW50RmllbGQodGhpcywgNCwgdmFsdWUpOwp9OwovKioKICogb3B0aW9uYWwgdWludDMyIHRvdGFsX2NvdW50ID0gNTsKICogQHJldHVybiB7bnVtYmVyfQogKi8KCgpwcm90by5wYi5jbXMuQ2hhdE1lc3NhZ2VMaXN0UmVwbHkucHJvdG90eXBlLmdldFRvdGFsQ291bnQgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDUsIDApOwp9OwovKioKICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuQ2hhdE1lc3NhZ2VMaXN0UmVwbHl9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuQ2hhdE1lc3NhZ2VMaXN0UmVwbHkucHJvdG90eXBlLnNldFRvdGFsQ291bnQgPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0ludEZpZWxkKHRoaXMsIDUsIHZhbHVlKTsKfTsKCmlmIChqc3BiLk1lc3NhZ2UuR0VORVJBVEVfVE9fT0JKRUNUKSB7CiAgLyoqCiAgICogQ3JlYXRlcyBhbiBvYmplY3QgcmVwcmVzZW50YXRpb24gb2YgdGhpcyBwcm90by4KICAgKiBGaWVsZCBuYW1lcyB0aGF0IGFyZSByZXNlcnZlZCBpbiBKYXZhU2NyaXB0IGFuZCB3aWxsIGJlIHJlbmFtZWQgdG8gcGJfbmFtZS4KICAgKiBPcHRpb25hbCBmaWVsZHMgdGhhdCBhcmUgbm90IHNldCB3aWxsIGJlIHNldCB0byB1bmRlZmluZWQuCiAgICogVG8gYWNjZXNzIGEgcmVzZXJ2ZWQgZmllbGQgdXNlLCBmb28ucGJfPG5hbWU+LCBlZywgZm9vLnBiX2RlZmF1bHQuCiAgICogRm9yIHRoZSBsaXN0IG9mIHJlc2VydmVkIG5hbWVzIHBsZWFzZSBzZWU6CiAgICogICAgIG5ldC9wcm90bzIvY29tcGlsZXIvanMvaW50ZXJuYWwvZ2VuZXJhdG9yLmNjI2tLZXl3b3JkLgogICAqIEBwYXJhbSB7Ym9vbGVhbj19IG9wdF9pbmNsdWRlSW5zdGFuY2UgRGVwcmVjYXRlZC4gd2hldGhlciB0byBpbmNsdWRlIHRoZQogICAqICAgICBKU1BCIGluc3RhbmNlIGZvciB0cmFuc2l0aW9uYWwgc295IHByb3RvIHN1cHBvcnQ6CiAgICogICAgIGh0dHA6Ly9nb3RvL3NveS1wYXJhbS1taWdyYXRpb24KICAgKiBAcmV0dXJuIHshT2JqZWN0fQogICAqLwogIHByb3RvLnBiLmNtcy5DYWxsTGlzdFJlcXVlc3QucHJvdG90eXBlLnRvT2JqZWN0ID0gZnVuY3Rpb24gKG9wdF9pbmNsdWRlSW5zdGFuY2UpIHsKICAgIHJldHVybiBwcm90by5wYi5jbXMuQ2FsbExpc3RSZXF1ZXN0LnRvT2JqZWN0KG9wdF9pbmNsdWRlSW5zdGFuY2UsIHRoaXMpOwogIH07CiAgLyoqCiAgICogU3RhdGljIHZlcnNpb24gb2YgdGhlIHtAc2VlIHRvT2JqZWN0fSBtZXRob2QuCiAgICogQHBhcmFtIHtib29sZWFufHVuZGVmaW5lZH0gaW5jbHVkZUluc3RhbmNlIERlcHJlY2F0ZWQuIFdoZXRoZXIgdG8gaW5jbHVkZQogICAqICAgICB0aGUgSlNQQiBpbnN0YW5jZSBmb3IgdHJhbnNpdGlvbmFsIHNveSBwcm90byBzdXBwb3J0OgogICAqICAgICBodHRwOi8vZ290by9zb3ktcGFyYW0tbWlncmF0aW9uCiAgICogQHBhcmFtIHshcHJvdG8ucGIuY21zLkNhbGxMaXN0UmVxdWVzdH0gbXNnIFRoZSBtc2cgaW5zdGFuY2UgdG8gdHJhbnNmb3JtLgogICAqIEByZXR1cm4geyFPYmplY3R9CiAgICogQHN1cHByZXNzIHt1bnVzZWRMb2NhbFZhcmlhYmxlc30gZiBpcyBvbmx5IHVzZWQgZm9yIG5lc3RlZCBtZXNzYWdlcwogICAqLwoKCiAgcHJvdG8ucGIuY21zLkNhbGxMaXN0UmVxdWVzdC50b09iamVjdCA9IGZ1bmN0aW9uIChpbmNsdWRlSW5zdGFuY2UsIG1zZykgewogICAgdmFyIGYsCiAgICAgICAgb2JqID0gewogICAgICBwYWdlTm86IGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KG1zZywgMSwgMCksCiAgICAgIHBhZ2VTaXplOiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdChtc2csIDIsIDApLAogICAgICBhcmVhSWQ6IGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KG1zZywgMywgMCksCiAgICAgIGFwcElkOiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdChtc2csIDQsIDApLAogICAgICB1c2VySWQ6IGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KG1zZywgNSwgMCksCiAgICAgIGFuY2hvcklkOiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdChtc2csIDYsIDApLAogICAgICBjYWxsVHlwZToganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQobXNnLCA3LCAwKSwKICAgICAgaGFuZ1R5cGU6IGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KG1zZywgOCwgMCksCiAgICAgIHN0YXR1czoganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQobXNnLCA5LCAwKSwKICAgICAgbWluRHVyYXRpb246IGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KG1zZywgMTAsIDApLAogICAgICBtYXhEdXJhdGlvbjoganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQobXNnLCAxMSwgMCksCiAgICAgIGNyZWF0ZWRTdGFydDoganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQobXNnLCAxMiwgMCksCiAgICAgIGNyZWF0ZWRFbmQ6IGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KG1zZywgMTMsIDApCiAgICB9OwoKICAgIGlmIChpbmNsdWRlSW5zdGFuY2UpIHsKICAgICAgb2JqLiRqc3BiTWVzc2FnZUluc3RhbmNlID0gbXNnOwogICAgfQoKICAgIHJldHVybiBvYmo7CiAgfTsKfQovKioKICogRGVzZXJpYWxpemVzIGJpbmFyeSBkYXRhIChpbiBwcm90b2J1ZiB3aXJlIGZvcm1hdCkuCiAqIEBwYXJhbSB7anNwYi5CeXRlU291cmNlfSBieXRlcyBUaGUgYnl0ZXMgdG8gZGVzZXJpYWxpemUuCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuQ2FsbExpc3RSZXF1ZXN0fQogKi8KCgpwcm90by5wYi5jbXMuQ2FsbExpc3RSZXF1ZXN0LmRlc2VyaWFsaXplQmluYXJ5ID0gZnVuY3Rpb24gKGJ5dGVzKSB7CiAgdmFyIHJlYWRlciA9IG5ldyBqc3BiLkJpbmFyeVJlYWRlcihieXRlcyk7CiAgdmFyIG1zZyA9IG5ldyBwcm90by5wYi5jbXMuQ2FsbExpc3RSZXF1ZXN0KCk7CiAgcmV0dXJuIHByb3RvLnBiLmNtcy5DYWxsTGlzdFJlcXVlc3QuZGVzZXJpYWxpemVCaW5hcnlGcm9tUmVhZGVyKG1zZywgcmVhZGVyKTsKfTsKLyoqCiAqIERlc2VyaWFsaXplcyBiaW5hcnkgZGF0YSAoaW4gcHJvdG9idWYgd2lyZSBmb3JtYXQpIGZyb20gdGhlCiAqIGdpdmVuIHJlYWRlciBpbnRvIHRoZSBnaXZlbiBtZXNzYWdlIG9iamVjdC4KICogQHBhcmFtIHshcHJvdG8ucGIuY21zLkNhbGxMaXN0UmVxdWVzdH0gbXNnIFRoZSBtZXNzYWdlIG9iamVjdCB0byBkZXNlcmlhbGl6ZSBpbnRvLgogKiBAcGFyYW0geyFqc3BiLkJpbmFyeVJlYWRlcn0gcmVhZGVyIFRoZSBCaW5hcnlSZWFkZXIgdG8gdXNlLgogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLkNhbGxMaXN0UmVxdWVzdH0KICovCgoKcHJvdG8ucGIuY21zLkNhbGxMaXN0UmVxdWVzdC5kZXNlcmlhbGl6ZUJpbmFyeUZyb21SZWFkZXIgPSBmdW5jdGlvbiAobXNnLCByZWFkZXIpIHsKICB3aGlsZSAocmVhZGVyLm5leHRGaWVsZCgpKSB7CiAgICBpZiAocmVhZGVyLmlzRW5kR3JvdXAoKSkgewogICAgICBicmVhazsKICAgIH0KCiAgICB2YXIgZmllbGQgPSByZWFkZXIuZ2V0RmllbGROdW1iZXIoKTsKCiAgICBzd2l0Y2ggKGZpZWxkKSB7CiAgICAgIGNhc2UgMToKICAgICAgICB2YXIgdmFsdWUgPSByZWFkZXIucmVhZFVpbnQzMigpOwogICAgICAgIG1zZy5zZXRQYWdlTm8odmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSAyOgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkVWludDMyKCk7CiAgICAgICAgbXNnLnNldFBhZ2VTaXplKHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgMzoKICAgICAgICB2YXIgdmFsdWUgPSByZWFkZXIucmVhZFVpbnQzMigpOwogICAgICAgIG1zZy5zZXRBcmVhSWQodmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSA0OgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkVWludDMyKCk7CiAgICAgICAgbXNnLnNldEFwcElkKHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgNToKICAgICAgICB2YXIgdmFsdWUgPSByZWFkZXIucmVhZFVpbnQzMigpOwogICAgICAgIG1zZy5zZXRVc2VySWQodmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSA2OgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkVWludDMyKCk7CiAgICAgICAgbXNnLnNldEFuY2hvcklkKHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgNzoKICAgICAgICB2YXIgdmFsdWUgPSByZWFkZXIucmVhZEVudW0oKTsKICAgICAgICBtc2cuc2V0Q2FsbFR5cGUodmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSA4OgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkRW51bSgpOwogICAgICAgIG1zZy5zZXRIYW5nVHlwZSh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlIDk6CiAgICAgICAgdmFyIHZhbHVlID0gcmVhZGVyLnJlYWRFbnVtKCk7CiAgICAgICAgbXNnLnNldFN0YXR1cyh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlIDEwOgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkVWludDMyKCk7CiAgICAgICAgbXNnLnNldE1pbkR1cmF0aW9uKHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgMTE6CiAgICAgICAgdmFyIHZhbHVlID0gcmVhZGVyLnJlYWRVaW50MzIoKTsKICAgICAgICBtc2cuc2V0TWF4RHVyYXRpb24odmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSAxMjoKICAgICAgICB2YXIgdmFsdWUgPSByZWFkZXIucmVhZFVpbnQzMigpOwogICAgICAgIG1zZy5zZXRDcmVhdGVkU3RhcnQodmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSAxMzoKICAgICAgICB2YXIgdmFsdWUgPSByZWFkZXIucmVhZFVpbnQzMigpOwogICAgICAgIG1zZy5zZXRDcmVhdGVkRW5kKHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGRlZmF1bHQ6CiAgICAgICAgcmVhZGVyLnNraXBGaWVsZCgpOwogICAgICAgIGJyZWFrOwogICAgfQogIH0KCiAgcmV0dXJuIG1zZzsKfTsKLyoqCiAqIFNlcmlhbGl6ZXMgdGhlIG1lc3NhZ2UgdG8gYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUgZm9ybWF0KS4KICogQHJldHVybiB7IVVpbnQ4QXJyYXl9CiAqLwoKCnByb3RvLnBiLmNtcy5DYWxsTGlzdFJlcXVlc3QucHJvdG90eXBlLnNlcmlhbGl6ZUJpbmFyeSA9IGZ1bmN0aW9uICgpIHsKICB2YXIgd3JpdGVyID0gbmV3IGpzcGIuQmluYXJ5V3JpdGVyKCk7CiAgcHJvdG8ucGIuY21zLkNhbGxMaXN0UmVxdWVzdC5zZXJpYWxpemVCaW5hcnlUb1dyaXRlcih0aGlzLCB3cml0ZXIpOwogIHJldHVybiB3cml0ZXIuZ2V0UmVzdWx0QnVmZmVyKCk7Cn07Ci8qKgogKiBTZXJpYWxpemVzIHRoZSBnaXZlbiBtZXNzYWdlIHRvIGJpbmFyeSBkYXRhIChpbiBwcm90b2J1ZiB3aXJlCiAqIGZvcm1hdCksIHdyaXRpbmcgdG8gdGhlIGdpdmVuIEJpbmFyeVdyaXRlci4KICogQHBhcmFtIHshcHJvdG8ucGIuY21zLkNhbGxMaXN0UmVxdWVzdH0gbWVzc2FnZQogKiBAcGFyYW0geyFqc3BiLkJpbmFyeVdyaXRlcn0gd3JpdGVyCiAqIEBzdXBwcmVzcyB7dW51c2VkTG9jYWxWYXJpYWJsZXN9IGYgaXMgb25seSB1c2VkIGZvciBuZXN0ZWQgbWVzc2FnZXMKICovCgoKcHJvdG8ucGIuY21zLkNhbGxMaXN0UmVxdWVzdC5zZXJpYWxpemVCaW5hcnlUb1dyaXRlciA9IGZ1bmN0aW9uIChtZXNzYWdlLCB3cml0ZXIpIHsKICB2YXIgZiA9IHVuZGVmaW5lZDsKICBmID0gbWVzc2FnZS5nZXRQYWdlTm8oKTsKCiAgaWYgKGYgIT09IDApIHsKICAgIHdyaXRlci53cml0ZVVpbnQzMigxLCBmKTsKICB9CgogIGYgPSBtZXNzYWdlLmdldFBhZ2VTaXplKCk7CgogIGlmIChmICE9PSAwKSB7CiAgICB3cml0ZXIud3JpdGVVaW50MzIoMiwgZik7CiAgfQoKICBmID0gbWVzc2FnZS5nZXRBcmVhSWQoKTsKCiAgaWYgKGYgIT09IDApIHsKICAgIHdyaXRlci53cml0ZVVpbnQzMigzLCBmKTsKICB9CgogIGYgPSBtZXNzYWdlLmdldEFwcElkKCk7CgogIGlmIChmICE9PSAwKSB7CiAgICB3cml0ZXIud3JpdGVVaW50MzIoNCwgZik7CiAgfQoKICBmID0gbWVzc2FnZS5nZXRVc2VySWQoKTsKCiAgaWYgKGYgIT09IDApIHsKICAgIHdyaXRlci53cml0ZVVpbnQzMig1LCBmKTsKICB9CgogIGYgPSBtZXNzYWdlLmdldEFuY2hvcklkKCk7CgogIGlmIChmICE9PSAwKSB7CiAgICB3cml0ZXIud3JpdGVVaW50MzIoNiwgZik7CiAgfQoKICBmID0gbWVzc2FnZS5nZXRDYWxsVHlwZSgpOwoKICBpZiAoZiAhPT0gMC4wKSB7CiAgICB3cml0ZXIud3JpdGVFbnVtKDcsIGYpOwogIH0KCiAgZiA9IG1lc3NhZ2UuZ2V0SGFuZ1R5cGUoKTsKCiAgaWYgKGYgIT09IDAuMCkgewogICAgd3JpdGVyLndyaXRlRW51bSg4LCBmKTsKICB9CgogIGYgPSBtZXNzYWdlLmdldFN0YXR1cygpOwoKICBpZiAoZiAhPT0gMC4wKSB7CiAgICB3cml0ZXIud3JpdGVFbnVtKDksIGYpOwogIH0KCiAgZiA9IG1lc3NhZ2UuZ2V0TWluRHVyYXRpb24oKTsKCiAgaWYgKGYgIT09IDApIHsKICAgIHdyaXRlci53cml0ZVVpbnQzMigxMCwgZik7CiAgfQoKICBmID0gbWVzc2FnZS5nZXRNYXhEdXJhdGlvbigpOwoKICBpZiAoZiAhPT0gMCkgewogICAgd3JpdGVyLndyaXRlVWludDMyKDExLCBmKTsKICB9CgogIGYgPSBtZXNzYWdlLmdldENyZWF0ZWRTdGFydCgpOwoKICBpZiAoZiAhPT0gMCkgewogICAgd3JpdGVyLndyaXRlVWludDMyKDEyLCBmKTsKICB9CgogIGYgPSBtZXNzYWdlLmdldENyZWF0ZWRFbmQoKTsKCiAgaWYgKGYgIT09IDApIHsKICAgIHdyaXRlci53cml0ZVVpbnQzMigxMywgZik7CiAgfQp9OwovKioKICogb3B0aW9uYWwgdWludDMyIHBhZ2Vfbm8gPSAxOwogKiBAcmV0dXJuIHtudW1iZXJ9CiAqLwoKCnByb3RvLnBiLmNtcy5DYWxsTGlzdFJlcXVlc3QucHJvdG90eXBlLmdldFBhZ2VObyA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQodGhpcywgMSwgMCk7Cn07Ci8qKgogKiBAcGFyYW0ge251bWJlcn0gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5DYWxsTGlzdFJlcXVlc3R9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuQ2FsbExpc3RSZXF1ZXN0LnByb3RvdHlwZS5zZXRQYWdlTm8gPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0ludEZpZWxkKHRoaXMsIDEsIHZhbHVlKTsKfTsKLyoqCiAqIG9wdGlvbmFsIHVpbnQzMiBwYWdlX3NpemUgPSAyOwogKiBAcmV0dXJuIHtudW1iZXJ9CiAqLwoKCnByb3RvLnBiLmNtcy5DYWxsTGlzdFJlcXVlc3QucHJvdG90eXBlLmdldFBhZ2VTaXplID0gZnVuY3Rpb24gKCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdCh0aGlzLCAyLCAwKTsKfTsKLyoqCiAqIEBwYXJhbSB7bnVtYmVyfSB2YWx1ZQogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLkNhbGxMaXN0UmVxdWVzdH0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5DYWxsTGlzdFJlcXVlc3QucHJvdG90eXBlLnNldFBhZ2VTaXplID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRQcm90bzNJbnRGaWVsZCh0aGlzLCAyLCB2YWx1ZSk7Cn07Ci8qKgogKiBvcHRpb25hbCB1aW50MzIgYXJlYV9pZCA9IDM7CiAqIEByZXR1cm4ge251bWJlcn0KICovCgoKcHJvdG8ucGIuY21zLkNhbGxMaXN0UmVxdWVzdC5wcm90b3R5cGUuZ2V0QXJlYUlkID0gZnVuY3Rpb24gKCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdCh0aGlzLCAzLCAwKTsKfTsKLyoqCiAqIEBwYXJhbSB7bnVtYmVyfSB2YWx1ZQogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLkNhbGxMaXN0UmVxdWVzdH0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5DYWxsTGlzdFJlcXVlc3QucHJvdG90eXBlLnNldEFyZWFJZCA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UHJvdG8zSW50RmllbGQodGhpcywgMywgdmFsdWUpOwp9OwovKioKICogb3B0aW9uYWwgdWludDMyIGFwcF9pZCA9IDQ7CiAqIEByZXR1cm4ge251bWJlcn0KICovCgoKcHJvdG8ucGIuY21zLkNhbGxMaXN0UmVxdWVzdC5wcm90b3R5cGUuZ2V0QXBwSWQgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDQsIDApOwp9OwovKioKICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuQ2FsbExpc3RSZXF1ZXN0fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLkNhbGxMaXN0UmVxdWVzdC5wcm90b3R5cGUuc2V0QXBwSWQgPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0ludEZpZWxkKHRoaXMsIDQsIHZhbHVlKTsKfTsKLyoqCiAqIG9wdGlvbmFsIHVpbnQzMiB1c2VyX2lkID0gNTsKICogQHJldHVybiB7bnVtYmVyfQogKi8KCgpwcm90by5wYi5jbXMuQ2FsbExpc3RSZXF1ZXN0LnByb3RvdHlwZS5nZXRVc2VySWQgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDUsIDApOwp9OwovKioKICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuQ2FsbExpc3RSZXF1ZXN0fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLkNhbGxMaXN0UmVxdWVzdC5wcm90b3R5cGUuc2V0VXNlcklkID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRQcm90bzNJbnRGaWVsZCh0aGlzLCA1LCB2YWx1ZSk7Cn07Ci8qKgogKiBvcHRpb25hbCB1aW50MzIgYW5jaG9yX2lkID0gNjsKICogQHJldHVybiB7bnVtYmVyfQogKi8KCgpwcm90by5wYi5jbXMuQ2FsbExpc3RSZXF1ZXN0LnByb3RvdHlwZS5nZXRBbmNob3JJZCA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQodGhpcywgNiwgMCk7Cn07Ci8qKgogKiBAcGFyYW0ge251bWJlcn0gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5DYWxsTGlzdFJlcXVlc3R9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuQ2FsbExpc3RSZXF1ZXN0LnByb3RvdHlwZS5zZXRBbmNob3JJZCA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UHJvdG8zSW50RmllbGQodGhpcywgNiwgdmFsdWUpOwp9OwovKioKICogb3B0aW9uYWwgcGIuQ2FsbFR5cGUgY2FsbF90eXBlID0gNzsKICogQHJldHVybiB7IXByb3RvLnBiLkNhbGxUeXBlfQogKi8KCgpwcm90by5wYi5jbXMuQ2FsbExpc3RSZXF1ZXN0LnByb3RvdHlwZS5nZXRDYWxsVHlwZSA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQodGhpcywgNywgMCk7Cn07Ci8qKgogKiBAcGFyYW0geyFwcm90by5wYi5DYWxsVHlwZX0gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5DYWxsTGlzdFJlcXVlc3R9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuQ2FsbExpc3RSZXF1ZXN0LnByb3RvdHlwZS5zZXRDYWxsVHlwZSA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UHJvdG8zRW51bUZpZWxkKHRoaXMsIDcsIHZhbHVlKTsKfTsKLyoqCiAqIG9wdGlvbmFsIHBiLkhhbmdUeXBlIGhhbmdfdHlwZSA9IDg7CiAqIEByZXR1cm4geyFwcm90by5wYi5IYW5nVHlwZX0KICovCgoKcHJvdG8ucGIuY21zLkNhbGxMaXN0UmVxdWVzdC5wcm90b3R5cGUuZ2V0SGFuZ1R5cGUgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDgsIDApOwp9OwovKioKICogQHBhcmFtIHshcHJvdG8ucGIuSGFuZ1R5cGV9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuQ2FsbExpc3RSZXF1ZXN0fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLkNhbGxMaXN0UmVxdWVzdC5wcm90b3R5cGUuc2V0SGFuZ1R5cGUgPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0VudW1GaWVsZCh0aGlzLCA4LCB2YWx1ZSk7Cn07Ci8qKgogKiBvcHRpb25hbCBwYi5DYWxsU3RhdHVzIHN0YXR1cyA9IDk7CiAqIEByZXR1cm4geyFwcm90by5wYi5DYWxsU3RhdHVzfQogKi8KCgpwcm90by5wYi5jbXMuQ2FsbExpc3RSZXF1ZXN0LnByb3RvdHlwZS5nZXRTdGF0dXMgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDksIDApOwp9OwovKioKICogQHBhcmFtIHshcHJvdG8ucGIuQ2FsbFN0YXR1c30gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5DYWxsTGlzdFJlcXVlc3R9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuQ2FsbExpc3RSZXF1ZXN0LnByb3RvdHlwZS5zZXRTdGF0dXMgPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0VudW1GaWVsZCh0aGlzLCA5LCB2YWx1ZSk7Cn07Ci8qKgogKiBvcHRpb25hbCB1aW50MzIgbWluX2R1cmF0aW9uID0gMTA7CiAqIEByZXR1cm4ge251bWJlcn0KICovCgoKcHJvdG8ucGIuY21zLkNhbGxMaXN0UmVxdWVzdC5wcm90b3R5cGUuZ2V0TWluRHVyYXRpb24gPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDEwLCAwKTsKfTsKLyoqCiAqIEBwYXJhbSB7bnVtYmVyfSB2YWx1ZQogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLkNhbGxMaXN0UmVxdWVzdH0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5DYWxsTGlzdFJlcXVlc3QucHJvdG90eXBlLnNldE1pbkR1cmF0aW9uID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRQcm90bzNJbnRGaWVsZCh0aGlzLCAxMCwgdmFsdWUpOwp9OwovKioKICogb3B0aW9uYWwgdWludDMyIG1heF9kdXJhdGlvbiA9IDExOwogKiBAcmV0dXJuIHtudW1iZXJ9CiAqLwoKCnByb3RvLnBiLmNtcy5DYWxsTGlzdFJlcXVlc3QucHJvdG90eXBlLmdldE1heER1cmF0aW9uID0gZnVuY3Rpb24gKCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdCh0aGlzLCAxMSwgMCk7Cn07Ci8qKgogKiBAcGFyYW0ge251bWJlcn0gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5DYWxsTGlzdFJlcXVlc3R9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuQ2FsbExpc3RSZXF1ZXN0LnByb3RvdHlwZS5zZXRNYXhEdXJhdGlvbiA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UHJvdG8zSW50RmllbGQodGhpcywgMTEsIHZhbHVlKTsKfTsKLyoqCiAqIG9wdGlvbmFsIHVpbnQzMiBjcmVhdGVkX3N0YXJ0ID0gMTI7CiAqIEByZXR1cm4ge251bWJlcn0KICovCgoKcHJvdG8ucGIuY21zLkNhbGxMaXN0UmVxdWVzdC5wcm90b3R5cGUuZ2V0Q3JlYXRlZFN0YXJ0ID0gZnVuY3Rpb24gKCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdCh0aGlzLCAxMiwgMCk7Cn07Ci8qKgogKiBAcGFyYW0ge251bWJlcn0gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5DYWxsTGlzdFJlcXVlc3R9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuQ2FsbExpc3RSZXF1ZXN0LnByb3RvdHlwZS5zZXRDcmVhdGVkU3RhcnQgPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0ludEZpZWxkKHRoaXMsIDEyLCB2YWx1ZSk7Cn07Ci8qKgogKiBvcHRpb25hbCB1aW50MzIgY3JlYXRlZF9lbmQgPSAxMzsKICogQHJldHVybiB7bnVtYmVyfQogKi8KCgpwcm90by5wYi5jbXMuQ2FsbExpc3RSZXF1ZXN0LnByb3RvdHlwZS5nZXRDcmVhdGVkRW5kID0gZnVuY3Rpb24gKCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdCh0aGlzLCAxMywgMCk7Cn07Ci8qKgogKiBAcGFyYW0ge251bWJlcn0gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5DYWxsTGlzdFJlcXVlc3R9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuQ2FsbExpc3RSZXF1ZXN0LnByb3RvdHlwZS5zZXRDcmVhdGVkRW5kID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRQcm90bzNJbnRGaWVsZCh0aGlzLCAxMywgdmFsdWUpOwp9OwovKioKICogTGlzdCBvZiByZXBlYXRlZCBmaWVsZHMgd2l0aGluIHRoaXMgbWVzc2FnZSB0eXBlLgogKiBAcHJpdmF0ZSB7IUFycmF5PG51bWJlcj59CiAqIEBjb25zdAogKi8KCgpwcm90by5wYi5jbXMuQ2FsbExpc3RSZXBseS5yZXBlYXRlZEZpZWxkc18gPSBbMV07CgppZiAoanNwYi5NZXNzYWdlLkdFTkVSQVRFX1RPX09CSkVDVCkgewogIC8qKgogICAqIENyZWF0ZXMgYW4gb2JqZWN0IHJlcHJlc2VudGF0aW9uIG9mIHRoaXMgcHJvdG8uCiAgICogRmllbGQgbmFtZXMgdGhhdCBhcmUgcmVzZXJ2ZWQgaW4gSmF2YVNjcmlwdCBhbmQgd2lsbCBiZSByZW5hbWVkIHRvIHBiX25hbWUuCiAgICogT3B0aW9uYWwgZmllbGRzIHRoYXQgYXJlIG5vdCBzZXQgd2lsbCBiZSBzZXQgdG8gdW5kZWZpbmVkLgogICAqIFRvIGFjY2VzcyBhIHJlc2VydmVkIGZpZWxkIHVzZSwgZm9vLnBiXzxuYW1lPiwgZWcsIGZvby5wYl9kZWZhdWx0LgogICAqIEZvciB0aGUgbGlzdCBvZiByZXNlcnZlZCBuYW1lcyBwbGVhc2Ugc2VlOgogICAqICAgICBuZXQvcHJvdG8yL2NvbXBpbGVyL2pzL2ludGVybmFsL2dlbmVyYXRvci5jYyNrS2V5d29yZC4KICAgKiBAcGFyYW0ge2Jvb2xlYW49fSBvcHRfaW5jbHVkZUluc3RhbmNlIERlcHJlY2F0ZWQuIHdoZXRoZXIgdG8gaW5jbHVkZSB0aGUKICAgKiAgICAgSlNQQiBpbnN0YW5jZSBmb3IgdHJhbnNpdGlvbmFsIHNveSBwcm90byBzdXBwb3J0OgogICAqICAgICBodHRwOi8vZ290by9zb3ktcGFyYW0tbWlncmF0aW9uCiAgICogQHJldHVybiB7IU9iamVjdH0KICAgKi8KICBwcm90by5wYi5jbXMuQ2FsbExpc3RSZXBseS5wcm90b3R5cGUudG9PYmplY3QgPSBmdW5jdGlvbiAob3B0X2luY2x1ZGVJbnN0YW5jZSkgewogICAgcmV0dXJuIHByb3RvLnBiLmNtcy5DYWxsTGlzdFJlcGx5LnRvT2JqZWN0KG9wdF9pbmNsdWRlSW5zdGFuY2UsIHRoaXMpOwogIH07CiAgLyoqCiAgICogU3RhdGljIHZlcnNpb24gb2YgdGhlIHtAc2VlIHRvT2JqZWN0fSBtZXRob2QuCiAgICogQHBhcmFtIHtib29sZWFufHVuZGVmaW5lZH0gaW5jbHVkZUluc3RhbmNlIERlcHJlY2F0ZWQuIFdoZXRoZXIgdG8gaW5jbHVkZQogICAqICAgICB0aGUgSlNQQiBpbnN0YW5jZSBmb3IgdHJhbnNpdGlvbmFsIHNveSBwcm90byBzdXBwb3J0OgogICAqICAgICBodHRwOi8vZ290by9zb3ktcGFyYW0tbWlncmF0aW9uCiAgICogQHBhcmFtIHshcHJvdG8ucGIuY21zLkNhbGxMaXN0UmVwbHl9IG1zZyBUaGUgbXNnIGluc3RhbmNlIHRvIHRyYW5zZm9ybS4KICAgKiBAcmV0dXJuIHshT2JqZWN0fQogICAqIEBzdXBwcmVzcyB7dW51c2VkTG9jYWxWYXJpYWJsZXN9IGYgaXMgb25seSB1c2VkIGZvciBuZXN0ZWQgbWVzc2FnZXMKICAgKi8KCgogIHByb3RvLnBiLmNtcy5DYWxsTGlzdFJlcGx5LnRvT2JqZWN0ID0gZnVuY3Rpb24gKGluY2x1ZGVJbnN0YW5jZSwgbXNnKSB7CiAgICB2YXIgZiwKICAgICAgICBvYmogPSB7CiAgICAgIGNhbGxzTGlzdDoganNwYi5NZXNzYWdlLnRvT2JqZWN0TGlzdChtc2cuZ2V0Q2FsbHNMaXN0KCksIHVzZXJ0eXBlX3BiLkNhbGxSZWNvcmQudG9PYmplY3QsIGluY2x1ZGVJbnN0YW5jZSksCiAgICAgIHBhZ2VObzoganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQobXNnLCAyLCAwKSwKICAgICAgcGFnZVNpemU6IGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KG1zZywgMywgMCksCiAgICAgIHRvdGFsUGFnZToganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQobXNnLCA0LCAwKSwKICAgICAgdG90YWxDb3VudDoganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQobXNnLCA1LCAwKQogICAgfTsKCiAgICBpZiAoaW5jbHVkZUluc3RhbmNlKSB7CiAgICAgIG9iai4kanNwYk1lc3NhZ2VJbnN0YW5jZSA9IG1zZzsKICAgIH0KCiAgICByZXR1cm4gb2JqOwogIH07Cn0KLyoqCiAqIERlc2VyaWFsaXplcyBiaW5hcnkgZGF0YSAoaW4gcHJvdG9idWYgd2lyZSBmb3JtYXQpLgogKiBAcGFyYW0ge2pzcGIuQnl0ZVNvdXJjZX0gYnl0ZXMgVGhlIGJ5dGVzIHRvIGRlc2VyaWFsaXplLgogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLkNhbGxMaXN0UmVwbHl9CiAqLwoKCnByb3RvLnBiLmNtcy5DYWxsTGlzdFJlcGx5LmRlc2VyaWFsaXplQmluYXJ5ID0gZnVuY3Rpb24gKGJ5dGVzKSB7CiAgdmFyIHJlYWRlciA9IG5ldyBqc3BiLkJpbmFyeVJlYWRlcihieXRlcyk7CiAgdmFyIG1zZyA9IG5ldyBwcm90by5wYi5jbXMuQ2FsbExpc3RSZXBseSgpOwogIHJldHVybiBwcm90by5wYi5jbXMuQ2FsbExpc3RSZXBseS5kZXNlcmlhbGl6ZUJpbmFyeUZyb21SZWFkZXIobXNnLCByZWFkZXIpOwp9OwovKioKICogRGVzZXJpYWxpemVzIGJpbmFyeSBkYXRhIChpbiBwcm90b2J1ZiB3aXJlIGZvcm1hdCkgZnJvbSB0aGUKICogZ2l2ZW4gcmVhZGVyIGludG8gdGhlIGdpdmVuIG1lc3NhZ2Ugb2JqZWN0LgogKiBAcGFyYW0geyFwcm90by5wYi5jbXMuQ2FsbExpc3RSZXBseX0gbXNnIFRoZSBtZXNzYWdlIG9iamVjdCB0byBkZXNlcmlhbGl6ZSBpbnRvLgogKiBAcGFyYW0geyFqc3BiLkJpbmFyeVJlYWRlcn0gcmVhZGVyIFRoZSBCaW5hcnlSZWFkZXIgdG8gdXNlLgogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLkNhbGxMaXN0UmVwbHl9CiAqLwoKCnByb3RvLnBiLmNtcy5DYWxsTGlzdFJlcGx5LmRlc2VyaWFsaXplQmluYXJ5RnJvbVJlYWRlciA9IGZ1bmN0aW9uIChtc2csIHJlYWRlcikgewogIHdoaWxlIChyZWFkZXIubmV4dEZpZWxkKCkpIHsKICAgIGlmIChyZWFkZXIuaXNFbmRHcm91cCgpKSB7CiAgICAgIGJyZWFrOwogICAgfQoKICAgIHZhciBmaWVsZCA9IHJlYWRlci5nZXRGaWVsZE51bWJlcigpOwoKICAgIHN3aXRjaCAoZmllbGQpIHsKICAgICAgY2FzZSAxOgogICAgICAgIHZhciB2YWx1ZSA9IG5ldyB1c2VydHlwZV9wYi5DYWxsUmVjb3JkKCk7CiAgICAgICAgcmVhZGVyLnJlYWRNZXNzYWdlKHZhbHVlLCB1c2VydHlwZV9wYi5DYWxsUmVjb3JkLmRlc2VyaWFsaXplQmluYXJ5RnJvbVJlYWRlcik7CiAgICAgICAgbXNnLmFkZENhbGxzKHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgMjoKICAgICAgICB2YXIgdmFsdWUgPSByZWFkZXIucmVhZFVpbnQzMigpOwogICAgICAgIG1zZy5zZXRQYWdlTm8odmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSAzOgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkVWludDMyKCk7CiAgICAgICAgbXNnLnNldFBhZ2VTaXplKHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgNDoKICAgICAgICB2YXIgdmFsdWUgPSByZWFkZXIucmVhZFVpbnQzMigpOwogICAgICAgIG1zZy5zZXRUb3RhbFBhZ2UodmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSA1OgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkVWludDMyKCk7CiAgICAgICAgbXNnLnNldFRvdGFsQ291bnQodmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgZGVmYXVsdDoKICAgICAgICByZWFkZXIuc2tpcEZpZWxkKCk7CiAgICAgICAgYnJlYWs7CiAgICB9CiAgfQoKICByZXR1cm4gbXNnOwp9OwovKioKICogU2VyaWFsaXplcyB0aGUgbWVzc2FnZSB0byBiaW5hcnkgZGF0YSAoaW4gcHJvdG9idWYgd2lyZSBmb3JtYXQpLgogKiBAcmV0dXJuIHshVWludDhBcnJheX0KICovCgoKcHJvdG8ucGIuY21zLkNhbGxMaXN0UmVwbHkucHJvdG90eXBlLnNlcmlhbGl6ZUJpbmFyeSA9IGZ1bmN0aW9uICgpIHsKICB2YXIgd3JpdGVyID0gbmV3IGpzcGIuQmluYXJ5V3JpdGVyKCk7CiAgcHJvdG8ucGIuY21zLkNhbGxMaXN0UmVwbHkuc2VyaWFsaXplQmluYXJ5VG9Xcml0ZXIodGhpcywgd3JpdGVyKTsKICByZXR1cm4gd3JpdGVyLmdldFJlc3VsdEJ1ZmZlcigpOwp9OwovKioKICogU2VyaWFsaXplcyB0aGUgZ2l2ZW4gbWVzc2FnZSB0byBiaW5hcnkgZGF0YSAoaW4gcHJvdG9idWYgd2lyZQogKiBmb3JtYXQpLCB3cml0aW5nIHRvIHRoZSBnaXZlbiBCaW5hcnlXcml0ZXIuCiAqIEBwYXJhbSB7IXByb3RvLnBiLmNtcy5DYWxsTGlzdFJlcGx5fSBtZXNzYWdlCiAqIEBwYXJhbSB7IWpzcGIuQmluYXJ5V3JpdGVyfSB3cml0ZXIKICogQHN1cHByZXNzIHt1bnVzZWRMb2NhbFZhcmlhYmxlc30gZiBpcyBvbmx5IHVzZWQgZm9yIG5lc3RlZCBtZXNzYWdlcwogKi8KCgpwcm90by5wYi5jbXMuQ2FsbExpc3RSZXBseS5zZXJpYWxpemVCaW5hcnlUb1dyaXRlciA9IGZ1bmN0aW9uIChtZXNzYWdlLCB3cml0ZXIpIHsKICB2YXIgZiA9IHVuZGVmaW5lZDsKICBmID0gbWVzc2FnZS5nZXRDYWxsc0xpc3QoKTsKCiAgaWYgKGYubGVuZ3RoID4gMCkgewogICAgd3JpdGVyLndyaXRlUmVwZWF0ZWRNZXNzYWdlKDEsIGYsIHVzZXJ0eXBlX3BiLkNhbGxSZWNvcmQuc2VyaWFsaXplQmluYXJ5VG9Xcml0ZXIpOwogIH0KCiAgZiA9IG1lc3NhZ2UuZ2V0UGFnZU5vKCk7CgogIGlmIChmICE9PSAwKSB7CiAgICB3cml0ZXIud3JpdGVVaW50MzIoMiwgZik7CiAgfQoKICBmID0gbWVzc2FnZS5nZXRQYWdlU2l6ZSgpOwoKICBpZiAoZiAhPT0gMCkgewogICAgd3JpdGVyLndyaXRlVWludDMyKDMsIGYpOwogIH0KCiAgZiA9IG1lc3NhZ2UuZ2V0VG90YWxQYWdlKCk7CgogIGlmIChmICE9PSAwKSB7CiAgICB3cml0ZXIud3JpdGVVaW50MzIoNCwgZik7CiAgfQoKICBmID0gbWVzc2FnZS5nZXRUb3RhbENvdW50KCk7CgogIGlmIChmICE9PSAwKSB7CiAgICB3cml0ZXIud3JpdGVVaW50MzIoNSwgZik7CiAgfQp9OwovKioKICogcmVwZWF0ZWQgcGIuQ2FsbFJlY29yZCBjYWxscyA9IDE7CiAqIEByZXR1cm4geyFBcnJheTwhcHJvdG8ucGIuQ2FsbFJlY29yZD59CiAqLwoKCnByb3RvLnBiLmNtcy5DYWxsTGlzdFJlcGx5LnByb3RvdHlwZS5nZXRDYWxsc0xpc3QgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRSZXBlYXRlZFdyYXBwZXJGaWVsZCh0aGlzLCB1c2VydHlwZV9wYi5DYWxsUmVjb3JkLCAxKTsKfTsKLyoqCiAqIEBwYXJhbSB7IUFycmF5PCFwcm90by5wYi5DYWxsUmVjb3JkPn0gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5DYWxsTGlzdFJlcGx5fSByZXR1cm5zIHRoaXMKKi8KCgpwcm90by5wYi5jbXMuQ2FsbExpc3RSZXBseS5wcm90b3R5cGUuc2V0Q2FsbHNMaXN0ID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRSZXBlYXRlZFdyYXBwZXJGaWVsZCh0aGlzLCAxLCB2YWx1ZSk7Cn07Ci8qKgogKiBAcGFyYW0geyFwcm90by5wYi5DYWxsUmVjb3JkPX0gb3B0X3ZhbHVlCiAqIEBwYXJhbSB7bnVtYmVyPX0gb3B0X2luZGV4CiAqIEByZXR1cm4geyFwcm90by5wYi5DYWxsUmVjb3JkfQogKi8KCgpwcm90by5wYi5jbXMuQ2FsbExpc3RSZXBseS5wcm90b3R5cGUuYWRkQ2FsbHMgPSBmdW5jdGlvbiAob3B0X3ZhbHVlLCBvcHRfaW5kZXgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmFkZFRvUmVwZWF0ZWRXcmFwcGVyRmllbGQodGhpcywgMSwgb3B0X3ZhbHVlLCBwcm90by5wYi5DYWxsUmVjb3JkLCBvcHRfaW5kZXgpOwp9OwovKioKICogQ2xlYXJzIHRoZSBsaXN0IG1ha2luZyBpdCBlbXB0eSBidXQgbm9uLW51bGwuCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuQ2FsbExpc3RSZXBseX0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5DYWxsTGlzdFJlcGx5LnByb3RvdHlwZS5jbGVhckNhbGxzTGlzdCA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4gdGhpcy5zZXRDYWxsc0xpc3QoW10pOwp9OwovKioKICogb3B0aW9uYWwgdWludDMyIHBhZ2Vfbm8gPSAyOwogKiBAcmV0dXJuIHtudW1iZXJ9CiAqLwoKCnByb3RvLnBiLmNtcy5DYWxsTGlzdFJlcGx5LnByb3RvdHlwZS5nZXRQYWdlTm8gPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDIsIDApOwp9OwovKioKICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuQ2FsbExpc3RSZXBseX0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5DYWxsTGlzdFJlcGx5LnByb3RvdHlwZS5zZXRQYWdlTm8gPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0ludEZpZWxkKHRoaXMsIDIsIHZhbHVlKTsKfTsKLyoqCiAqIG9wdGlvbmFsIHVpbnQzMiBwYWdlX3NpemUgPSAzOwogKiBAcmV0dXJuIHtudW1iZXJ9CiAqLwoKCnByb3RvLnBiLmNtcy5DYWxsTGlzdFJlcGx5LnByb3RvdHlwZS5nZXRQYWdlU2l6ZSA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQodGhpcywgMywgMCk7Cn07Ci8qKgogKiBAcGFyYW0ge251bWJlcn0gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5DYWxsTGlzdFJlcGx5fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLkNhbGxMaXN0UmVwbHkucHJvdG90eXBlLnNldFBhZ2VTaXplID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRQcm90bzNJbnRGaWVsZCh0aGlzLCAzLCB2YWx1ZSk7Cn07Ci8qKgogKiBvcHRpb25hbCB1aW50MzIgdG90YWxfcGFnZSA9IDQ7CiAqIEByZXR1cm4ge251bWJlcn0KICovCgoKcHJvdG8ucGIuY21zLkNhbGxMaXN0UmVwbHkucHJvdG90eXBlLmdldFRvdGFsUGFnZSA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQodGhpcywgNCwgMCk7Cn07Ci8qKgogKiBAcGFyYW0ge251bWJlcn0gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5DYWxsTGlzdFJlcGx5fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLkNhbGxMaXN0UmVwbHkucHJvdG90eXBlLnNldFRvdGFsUGFnZSA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UHJvdG8zSW50RmllbGQodGhpcywgNCwgdmFsdWUpOwp9OwovKioKICogb3B0aW9uYWwgdWludDMyIHRvdGFsX2NvdW50ID0gNTsKICogQHJldHVybiB7bnVtYmVyfQogKi8KCgpwcm90by5wYi5jbXMuQ2FsbExpc3RSZXBseS5wcm90b3R5cGUuZ2V0VG90YWxDb3VudCA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQodGhpcywgNSwgMCk7Cn07Ci8qKgogKiBAcGFyYW0ge251bWJlcn0gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5DYWxsTGlzdFJlcGx5fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLkNhbGxMaXN0UmVwbHkucHJvdG90eXBlLnNldFRvdGFsQ291bnQgPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0ludEZpZWxkKHRoaXMsIDUsIHZhbHVlKTsKfTsKCmlmIChqc3BiLk1lc3NhZ2UuR0VORVJBVEVfVE9fT0JKRUNUKSB7CiAgLyoqCiAgICogQ3JlYXRlcyBhbiBvYmplY3QgcmVwcmVzZW50YXRpb24gb2YgdGhpcyBwcm90by4KICAgKiBGaWVsZCBuYW1lcyB0aGF0IGFyZSByZXNlcnZlZCBpbiBKYXZhU2NyaXB0IGFuZCB3aWxsIGJlIHJlbmFtZWQgdG8gcGJfbmFtZS4KICAgKiBPcHRpb25hbCBmaWVsZHMgdGhhdCBhcmUgbm90IHNldCB3aWxsIGJlIHNldCB0byB1bmRlZmluZWQuCiAgICogVG8gYWNjZXNzIGEgcmVzZXJ2ZWQgZmllbGQgdXNlLCBmb28ucGJfPG5hbWU+LCBlZywgZm9vLnBiX2RlZmF1bHQuCiAgICogRm9yIHRoZSBsaXN0IG9mIHJlc2VydmVkIG5hbWVzIHBsZWFzZSBzZWU6CiAgICogICAgIG5ldC9wcm90bzIvY29tcGlsZXIvanMvaW50ZXJuYWwvZ2VuZXJhdG9yLmNjI2tLZXl3b3JkLgogICAqIEBwYXJhbSB7Ym9vbGVhbj19IG9wdF9pbmNsdWRlSW5zdGFuY2UgRGVwcmVjYXRlZC4gd2hldGhlciB0byBpbmNsdWRlIHRoZQogICAqICAgICBKU1BCIGluc3RhbmNlIGZvciB0cmFuc2l0aW9uYWwgc295IHByb3RvIHN1cHBvcnQ6CiAgICogICAgIGh0dHA6Ly9nb3RvL3NveS1wYXJhbS1taWdyYXRpb24KICAgKiBAcmV0dXJuIHshT2JqZWN0fQogICAqLwogIHByb3RvLnBiLmNtcy5UcmFuc2FjdGlvbkxpc3RSZXF1ZXN0LnByb3RvdHlwZS50b09iamVjdCA9IGZ1bmN0aW9uIChvcHRfaW5jbHVkZUluc3RhbmNlKSB7CiAgICByZXR1cm4gcHJvdG8ucGIuY21zLlRyYW5zYWN0aW9uTGlzdFJlcXVlc3QudG9PYmplY3Qob3B0X2luY2x1ZGVJbnN0YW5jZSwgdGhpcyk7CiAgfTsKICAvKioKICAgKiBTdGF0aWMgdmVyc2lvbiBvZiB0aGUge0BzZWUgdG9PYmplY3R9IG1ldGhvZC4KICAgKiBAcGFyYW0ge2Jvb2xlYW58dW5kZWZpbmVkfSBpbmNsdWRlSW5zdGFuY2UgRGVwcmVjYXRlZC4gV2hldGhlciB0byBpbmNsdWRlCiAgICogICAgIHRoZSBKU1BCIGluc3RhbmNlIGZvciB0cmFuc2l0aW9uYWwgc295IHByb3RvIHN1cHBvcnQ6CiAgICogICAgIGh0dHA6Ly9nb3RvL3NveS1wYXJhbS1taWdyYXRpb24KICAgKiBAcGFyYW0geyFwcm90by5wYi5jbXMuVHJhbnNhY3Rpb25MaXN0UmVxdWVzdH0gbXNnIFRoZSBtc2cgaW5zdGFuY2UgdG8gdHJhbnNmb3JtLgogICAqIEByZXR1cm4geyFPYmplY3R9CiAgICogQHN1cHByZXNzIHt1bnVzZWRMb2NhbFZhcmlhYmxlc30gZiBpcyBvbmx5IHVzZWQgZm9yIG5lc3RlZCBtZXNzYWdlcwogICAqLwoKCiAgcHJvdG8ucGIuY21zLlRyYW5zYWN0aW9uTGlzdFJlcXVlc3QudG9PYmplY3QgPSBmdW5jdGlvbiAoaW5jbHVkZUluc3RhbmNlLCBtc2cpIHsKICAgIHZhciBmLAogICAgICAgIG9iaiA9IHsKICAgICAgcGFnZU5vOiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdChtc2csIDEsIDApLAogICAgICBwYWdlU2l6ZToganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQobXNnLCAyLCAwKSwKICAgICAgYXJlYUlkOiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdChtc2csIDMsIDApLAogICAgICBhcHBJZDoganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQobXNnLCA0LCAwKSwKICAgICAgdHJhZGVyVHlwZToganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQobXNnLCA1LCAwKSwKICAgICAgdHJhZGVySWQ6IGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KG1zZywgNiwgMCksCiAgICAgIHNvdXJjZVR5cGU6IGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KG1zZywgNywgMCksCiAgICAgIGNyZWF0ZWRTdGFydDoganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQobXNnLCA4LCAwKSwKICAgICAgY3JlYXRlZEVuZDoganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQobXNnLCA5LCAwKQogICAgfTsKCiAgICBpZiAoaW5jbHVkZUluc3RhbmNlKSB7CiAgICAgIG9iai4kanNwYk1lc3NhZ2VJbnN0YW5jZSA9IG1zZzsKICAgIH0KCiAgICByZXR1cm4gb2JqOwogIH07Cn0KLyoqCiAqIERlc2VyaWFsaXplcyBiaW5hcnkgZGF0YSAoaW4gcHJvdG9idWYgd2lyZSBmb3JtYXQpLgogKiBAcGFyYW0ge2pzcGIuQnl0ZVNvdXJjZX0gYnl0ZXMgVGhlIGJ5dGVzIHRvIGRlc2VyaWFsaXplLgogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLlRyYW5zYWN0aW9uTGlzdFJlcXVlc3R9CiAqLwoKCnByb3RvLnBiLmNtcy5UcmFuc2FjdGlvbkxpc3RSZXF1ZXN0LmRlc2VyaWFsaXplQmluYXJ5ID0gZnVuY3Rpb24gKGJ5dGVzKSB7CiAgdmFyIHJlYWRlciA9IG5ldyBqc3BiLkJpbmFyeVJlYWRlcihieXRlcyk7CiAgdmFyIG1zZyA9IG5ldyBwcm90by5wYi5jbXMuVHJhbnNhY3Rpb25MaXN0UmVxdWVzdCgpOwogIHJldHVybiBwcm90by5wYi5jbXMuVHJhbnNhY3Rpb25MaXN0UmVxdWVzdC5kZXNlcmlhbGl6ZUJpbmFyeUZyb21SZWFkZXIobXNnLCByZWFkZXIpOwp9OwovKioKICogRGVzZXJpYWxpemVzIGJpbmFyeSBkYXRhIChpbiBwcm90b2J1ZiB3aXJlIGZvcm1hdCkgZnJvbSB0aGUKICogZ2l2ZW4gcmVhZGVyIGludG8gdGhlIGdpdmVuIG1lc3NhZ2Ugb2JqZWN0LgogKiBAcGFyYW0geyFwcm90by5wYi5jbXMuVHJhbnNhY3Rpb25MaXN0UmVxdWVzdH0gbXNnIFRoZSBtZXNzYWdlIG9iamVjdCB0byBkZXNlcmlhbGl6ZSBpbnRvLgogKiBAcGFyYW0geyFqc3BiLkJpbmFyeVJlYWRlcn0gcmVhZGVyIFRoZSBCaW5hcnlSZWFkZXIgdG8gdXNlLgogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLlRyYW5zYWN0aW9uTGlzdFJlcXVlc3R9CiAqLwoKCnByb3RvLnBiLmNtcy5UcmFuc2FjdGlvbkxpc3RSZXF1ZXN0LmRlc2VyaWFsaXplQmluYXJ5RnJvbVJlYWRlciA9IGZ1bmN0aW9uIChtc2csIHJlYWRlcikgewogIHdoaWxlIChyZWFkZXIubmV4dEZpZWxkKCkpIHsKICAgIGlmIChyZWFkZXIuaXNFbmRHcm91cCgpKSB7CiAgICAgIGJyZWFrOwogICAgfQoKICAgIHZhciBmaWVsZCA9IHJlYWRlci5nZXRGaWVsZE51bWJlcigpOwoKICAgIHN3aXRjaCAoZmllbGQpIHsKICAgICAgY2FzZSAxOgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkVWludDMyKCk7CiAgICAgICAgbXNnLnNldFBhZ2VObyh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlIDI6CiAgICAgICAgdmFyIHZhbHVlID0gcmVhZGVyLnJlYWRVaW50MzIoKTsKICAgICAgICBtc2cuc2V0UGFnZVNpemUodmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSAzOgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkVWludDMyKCk7CiAgICAgICAgbXNnLnNldEFyZWFJZCh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlIDQ6CiAgICAgICAgdmFyIHZhbHVlID0gcmVhZGVyLnJlYWRVaW50MzIoKTsKICAgICAgICBtc2cuc2V0QXBwSWQodmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSA1OgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkRW51bSgpOwogICAgICAgIG1zZy5zZXRUcmFkZXJUeXBlKHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgNjoKICAgICAgICB2YXIgdmFsdWUgPSByZWFkZXIucmVhZFVpbnQzMigpOwogICAgICAgIG1zZy5zZXRUcmFkZXJJZCh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlIDc6CiAgICAgICAgdmFyIHZhbHVlID0gcmVhZGVyLnJlYWRFbnVtKCk7CiAgICAgICAgbXNnLnNldFNvdXJjZVR5cGUodmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSA4OgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkVWludDMyKCk7CiAgICAgICAgbXNnLnNldENyZWF0ZWRTdGFydCh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlIDk6CiAgICAgICAgdmFyIHZhbHVlID0gcmVhZGVyLnJlYWRVaW50MzIoKTsKICAgICAgICBtc2cuc2V0Q3JlYXRlZEVuZCh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBkZWZhdWx0OgogICAgICAgIHJlYWRlci5za2lwRmllbGQoKTsKICAgICAgICBicmVhazsKICAgIH0KICB9CgogIHJldHVybiBtc2c7Cn07Ci8qKgogKiBTZXJpYWxpemVzIHRoZSBtZXNzYWdlIHRvIGJpbmFyeSBkYXRhIChpbiBwcm90b2J1ZiB3aXJlIGZvcm1hdCkuCiAqIEByZXR1cm4geyFVaW50OEFycmF5fQogKi8KCgpwcm90by5wYi5jbXMuVHJhbnNhY3Rpb25MaXN0UmVxdWVzdC5wcm90b3R5cGUuc2VyaWFsaXplQmluYXJ5ID0gZnVuY3Rpb24gKCkgewogIHZhciB3cml0ZXIgPSBuZXcganNwYi5CaW5hcnlXcml0ZXIoKTsKICBwcm90by5wYi5jbXMuVHJhbnNhY3Rpb25MaXN0UmVxdWVzdC5zZXJpYWxpemVCaW5hcnlUb1dyaXRlcih0aGlzLCB3cml0ZXIpOwogIHJldHVybiB3cml0ZXIuZ2V0UmVzdWx0QnVmZmVyKCk7Cn07Ci8qKgogKiBTZXJpYWxpemVzIHRoZSBnaXZlbiBtZXNzYWdlIHRvIGJpbmFyeSBkYXRhIChpbiBwcm90b2J1ZiB3aXJlCiAqIGZvcm1hdCksIHdyaXRpbmcgdG8gdGhlIGdpdmVuIEJpbmFyeVdyaXRlci4KICogQHBhcmFtIHshcHJvdG8ucGIuY21zLlRyYW5zYWN0aW9uTGlzdFJlcXVlc3R9IG1lc3NhZ2UKICogQHBhcmFtIHshanNwYi5CaW5hcnlXcml0ZXJ9IHdyaXRlcgogKiBAc3VwcHJlc3Mge3VudXNlZExvY2FsVmFyaWFibGVzfSBmIGlzIG9ubHkgdXNlZCBmb3IgbmVzdGVkIG1lc3NhZ2VzCiAqLwoKCnByb3RvLnBiLmNtcy5UcmFuc2FjdGlvbkxpc3RSZXF1ZXN0LnNlcmlhbGl6ZUJpbmFyeVRvV3JpdGVyID0gZnVuY3Rpb24gKG1lc3NhZ2UsIHdyaXRlcikgewogIHZhciBmID0gdW5kZWZpbmVkOwogIGYgPSBtZXNzYWdlLmdldFBhZ2VObygpOwoKICBpZiAoZiAhPT0gMCkgewogICAgd3JpdGVyLndyaXRlVWludDMyKDEsIGYpOwogIH0KCiAgZiA9IG1lc3NhZ2UuZ2V0UGFnZVNpemUoKTsKCiAgaWYgKGYgIT09IDApIHsKICAgIHdyaXRlci53cml0ZVVpbnQzMigyLCBmKTsKICB9CgogIGYgPSBtZXNzYWdlLmdldEFyZWFJZCgpOwoKICBpZiAoZiAhPT0gMCkgewogICAgd3JpdGVyLndyaXRlVWludDMyKDMsIGYpOwogIH0KCiAgZiA9IG1lc3NhZ2UuZ2V0QXBwSWQoKTsKCiAgaWYgKGYgIT09IDApIHsKICAgIHdyaXRlci53cml0ZVVpbnQzMig0LCBmKTsKICB9CgogIGYgPSBtZXNzYWdlLmdldFRyYWRlclR5cGUoKTsKCiAgaWYgKGYgIT09IDAuMCkgewogICAgd3JpdGVyLndyaXRlRW51bSg1LCBmKTsKICB9CgogIGYgPSBtZXNzYWdlLmdldFRyYWRlcklkKCk7CgogIGlmIChmICE9PSAwKSB7CiAgICB3cml0ZXIud3JpdGVVaW50MzIoNiwgZik7CiAgfQoKICBmID0gbWVzc2FnZS5nZXRTb3VyY2VUeXBlKCk7CgogIGlmIChmICE9PSAwLjApIHsKICAgIHdyaXRlci53cml0ZUVudW0oNywgZik7CiAgfQoKICBmID0gbWVzc2FnZS5nZXRDcmVhdGVkU3RhcnQoKTsKCiAgaWYgKGYgIT09IDApIHsKICAgIHdyaXRlci53cml0ZVVpbnQzMig4LCBmKTsKICB9CgogIGYgPSBtZXNzYWdlLmdldENyZWF0ZWRFbmQoKTsKCiAgaWYgKGYgIT09IDApIHsKICAgIHdyaXRlci53cml0ZVVpbnQzMig5LCBmKTsKICB9Cn07Ci8qKgogKiBvcHRpb25hbCB1aW50MzIgcGFnZV9ubyA9IDE7CiAqIEByZXR1cm4ge251bWJlcn0KICovCgoKcHJvdG8ucGIuY21zLlRyYW5zYWN0aW9uTGlzdFJlcXVlc3QucHJvdG90eXBlLmdldFBhZ2VObyA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQodGhpcywgMSwgMCk7Cn07Ci8qKgogKiBAcGFyYW0ge251bWJlcn0gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5UcmFuc2FjdGlvbkxpc3RSZXF1ZXN0fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLlRyYW5zYWN0aW9uTGlzdFJlcXVlc3QucHJvdG90eXBlLnNldFBhZ2VObyA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UHJvdG8zSW50RmllbGQodGhpcywgMSwgdmFsdWUpOwp9OwovKioKICogb3B0aW9uYWwgdWludDMyIHBhZ2Vfc2l6ZSA9IDI7CiAqIEByZXR1cm4ge251bWJlcn0KICovCgoKcHJvdG8ucGIuY21zLlRyYW5zYWN0aW9uTGlzdFJlcXVlc3QucHJvdG90eXBlLmdldFBhZ2VTaXplID0gZnVuY3Rpb24gKCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdCh0aGlzLCAyLCAwKTsKfTsKLyoqCiAqIEBwYXJhbSB7bnVtYmVyfSB2YWx1ZQogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLlRyYW5zYWN0aW9uTGlzdFJlcXVlc3R9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuVHJhbnNhY3Rpb25MaXN0UmVxdWVzdC5wcm90b3R5cGUuc2V0UGFnZVNpemUgPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0ludEZpZWxkKHRoaXMsIDIsIHZhbHVlKTsKfTsKLyoqCiAqIG9wdGlvbmFsIHVpbnQzMiBhcmVhX2lkID0gMzsKICogQHJldHVybiB7bnVtYmVyfQogKi8KCgpwcm90by5wYi5jbXMuVHJhbnNhY3Rpb25MaXN0UmVxdWVzdC5wcm90b3R5cGUuZ2V0QXJlYUlkID0gZnVuY3Rpb24gKCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdCh0aGlzLCAzLCAwKTsKfTsKLyoqCiAqIEBwYXJhbSB7bnVtYmVyfSB2YWx1ZQogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLlRyYW5zYWN0aW9uTGlzdFJlcXVlc3R9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuVHJhbnNhY3Rpb25MaXN0UmVxdWVzdC5wcm90b3R5cGUuc2V0QXJlYUlkID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRQcm90bzNJbnRGaWVsZCh0aGlzLCAzLCB2YWx1ZSk7Cn07Ci8qKgogKiBvcHRpb25hbCB1aW50MzIgYXBwX2lkID0gNDsKICogQHJldHVybiB7bnVtYmVyfQogKi8KCgpwcm90by5wYi5jbXMuVHJhbnNhY3Rpb25MaXN0UmVxdWVzdC5wcm90b3R5cGUuZ2V0QXBwSWQgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDQsIDApOwp9OwovKioKICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuVHJhbnNhY3Rpb25MaXN0UmVxdWVzdH0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5UcmFuc2FjdGlvbkxpc3RSZXF1ZXN0LnByb3RvdHlwZS5zZXRBcHBJZCA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UHJvdG8zSW50RmllbGQodGhpcywgNCwgdmFsdWUpOwp9OwovKioKICogb3B0aW9uYWwgcGIuRW50aXR5VHlwZSB0cmFkZXJfdHlwZSA9IDU7CiAqIEByZXR1cm4geyFwcm90by5wYi5FbnRpdHlUeXBlfQogKi8KCgpwcm90by5wYi5jbXMuVHJhbnNhY3Rpb25MaXN0UmVxdWVzdC5wcm90b3R5cGUuZ2V0VHJhZGVyVHlwZSA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQodGhpcywgNSwgMCk7Cn07Ci8qKgogKiBAcGFyYW0geyFwcm90by5wYi5FbnRpdHlUeXBlfSB2YWx1ZQogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLlRyYW5zYWN0aW9uTGlzdFJlcXVlc3R9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuVHJhbnNhY3Rpb25MaXN0UmVxdWVzdC5wcm90b3R5cGUuc2V0VHJhZGVyVHlwZSA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UHJvdG8zRW51bUZpZWxkKHRoaXMsIDUsIHZhbHVlKTsKfTsKLyoqCiAqIG9wdGlvbmFsIHVpbnQzMiB0cmFkZXJfaWQgPSA2OwogKiBAcmV0dXJuIHtudW1iZXJ9CiAqLwoKCnByb3RvLnBiLmNtcy5UcmFuc2FjdGlvbkxpc3RSZXF1ZXN0LnByb3RvdHlwZS5nZXRUcmFkZXJJZCA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQodGhpcywgNiwgMCk7Cn07Ci8qKgogKiBAcGFyYW0ge251bWJlcn0gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5UcmFuc2FjdGlvbkxpc3RSZXF1ZXN0fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLlRyYW5zYWN0aW9uTGlzdFJlcXVlc3QucHJvdG90eXBlLnNldFRyYWRlcklkID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRQcm90bzNJbnRGaWVsZCh0aGlzLCA2LCB2YWx1ZSk7Cn07Ci8qKgogKiBvcHRpb25hbCBwYi5FbnRpdHlUeXBlIHNvdXJjZV90eXBlID0gNzsKICogQHJldHVybiB7IXByb3RvLnBiLkVudGl0eVR5cGV9CiAqLwoKCnByb3RvLnBiLmNtcy5UcmFuc2FjdGlvbkxpc3RSZXF1ZXN0LnByb3RvdHlwZS5nZXRTb3VyY2VUeXBlID0gZnVuY3Rpb24gKCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdCh0aGlzLCA3LCAwKTsKfTsKLyoqCiAqIEBwYXJhbSB7IXByb3RvLnBiLkVudGl0eVR5cGV9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuVHJhbnNhY3Rpb25MaXN0UmVxdWVzdH0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5UcmFuc2FjdGlvbkxpc3RSZXF1ZXN0LnByb3RvdHlwZS5zZXRTb3VyY2VUeXBlID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRQcm90bzNFbnVtRmllbGQodGhpcywgNywgdmFsdWUpOwp9OwovKioKICogb3B0aW9uYWwgdWludDMyIGNyZWF0ZWRfc3RhcnQgPSA4OwogKiBAcmV0dXJuIHtudW1iZXJ9CiAqLwoKCnByb3RvLnBiLmNtcy5UcmFuc2FjdGlvbkxpc3RSZXF1ZXN0LnByb3RvdHlwZS5nZXRDcmVhdGVkU3RhcnQgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDgsIDApOwp9OwovKioKICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuVHJhbnNhY3Rpb25MaXN0UmVxdWVzdH0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5UcmFuc2FjdGlvbkxpc3RSZXF1ZXN0LnByb3RvdHlwZS5zZXRDcmVhdGVkU3RhcnQgPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0ludEZpZWxkKHRoaXMsIDgsIHZhbHVlKTsKfTsKLyoqCiAqIG9wdGlvbmFsIHVpbnQzMiBjcmVhdGVkX2VuZCA9IDk7CiAqIEByZXR1cm4ge251bWJlcn0KICovCgoKcHJvdG8ucGIuY21zLlRyYW5zYWN0aW9uTGlzdFJlcXVlc3QucHJvdG90eXBlLmdldENyZWF0ZWRFbmQgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDksIDApOwp9OwovKioKICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuVHJhbnNhY3Rpb25MaXN0UmVxdWVzdH0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5UcmFuc2FjdGlvbkxpc3RSZXF1ZXN0LnByb3RvdHlwZS5zZXRDcmVhdGVkRW5kID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRQcm90bzNJbnRGaWVsZCh0aGlzLCA5LCB2YWx1ZSk7Cn07Ci8qKgogKiBMaXN0IG9mIHJlcGVhdGVkIGZpZWxkcyB3aXRoaW4gdGhpcyBtZXNzYWdlIHR5cGUuCiAqIEBwcml2YXRlIHshQXJyYXk8bnVtYmVyPn0KICogQGNvbnN0CiAqLwoKCnByb3RvLnBiLmNtcy5UcmFuc2FjdGlvbkxpc3RSZXBseS5yZXBlYXRlZEZpZWxkc18gPSBbMV07CgppZiAoanNwYi5NZXNzYWdlLkdFTkVSQVRFX1RPX09CSkVDVCkgewogIC8qKgogICAqIENyZWF0ZXMgYW4gb2JqZWN0IHJlcHJlc2VudGF0aW9uIG9mIHRoaXMgcHJvdG8uCiAgICogRmllbGQgbmFtZXMgdGhhdCBhcmUgcmVzZXJ2ZWQgaW4gSmF2YVNjcmlwdCBhbmQgd2lsbCBiZSByZW5hbWVkIHRvIHBiX25hbWUuCiAgICogT3B0aW9uYWwgZmllbGRzIHRoYXQgYXJlIG5vdCBzZXQgd2lsbCBiZSBzZXQgdG8gdW5kZWZpbmVkLgogICAqIFRvIGFjY2VzcyBhIHJlc2VydmVkIGZpZWxkIHVzZSwgZm9vLnBiXzxuYW1lPiwgZWcsIGZvby5wYl9kZWZhdWx0LgogICAqIEZvciB0aGUgbGlzdCBvZiByZXNlcnZlZCBuYW1lcyBwbGVhc2Ugc2VlOgogICAqICAgICBuZXQvcHJvdG8yL2NvbXBpbGVyL2pzL2ludGVybmFsL2dlbmVyYXRvci5jYyNrS2V5d29yZC4KICAgKiBAcGFyYW0ge2Jvb2xlYW49fSBvcHRfaW5jbHVkZUluc3RhbmNlIERlcHJlY2F0ZWQuIHdoZXRoZXIgdG8gaW5jbHVkZSB0aGUKICAgKiAgICAgSlNQQiBpbnN0YW5jZSBmb3IgdHJhbnNpdGlvbmFsIHNveSBwcm90byBzdXBwb3J0OgogICAqICAgICBodHRwOi8vZ290by9zb3ktcGFyYW0tbWlncmF0aW9uCiAgICogQHJldHVybiB7IU9iamVjdH0KICAgKi8KICBwcm90by5wYi5jbXMuVHJhbnNhY3Rpb25MaXN0UmVwbHkucHJvdG90eXBlLnRvT2JqZWN0ID0gZnVuY3Rpb24gKG9wdF9pbmNsdWRlSW5zdGFuY2UpIHsKICAgIHJldHVybiBwcm90by5wYi5jbXMuVHJhbnNhY3Rpb25MaXN0UmVwbHkudG9PYmplY3Qob3B0X2luY2x1ZGVJbnN0YW5jZSwgdGhpcyk7CiAgfTsKICAvKioKICAgKiBTdGF0aWMgdmVyc2lvbiBvZiB0aGUge0BzZWUgdG9PYmplY3R9IG1ldGhvZC4KICAgKiBAcGFyYW0ge2Jvb2xlYW58dW5kZWZpbmVkfSBpbmNsdWRlSW5zdGFuY2UgRGVwcmVjYXRlZC4gV2hldGhlciB0byBpbmNsdWRlCiAgICogICAgIHRoZSBKU1BCIGluc3RhbmNlIGZvciB0cmFuc2l0aW9uYWwgc295IHByb3RvIHN1cHBvcnQ6CiAgICogICAgIGh0dHA6Ly9nb3RvL3NveS1wYXJhbS1taWdyYXRpb24KICAgKiBAcGFyYW0geyFwcm90by5wYi5jbXMuVHJhbnNhY3Rpb25MaXN0UmVwbHl9IG1zZyBUaGUgbXNnIGluc3RhbmNlIHRvIHRyYW5zZm9ybS4KICAgKiBAcmV0dXJuIHshT2JqZWN0fQogICAqIEBzdXBwcmVzcyB7dW51c2VkTG9jYWxWYXJpYWJsZXN9IGYgaXMgb25seSB1c2VkIGZvciBuZXN0ZWQgbWVzc2FnZXMKICAgKi8KCgogIHByb3RvLnBiLmNtcy5UcmFuc2FjdGlvbkxpc3RSZXBseS50b09iamVjdCA9IGZ1bmN0aW9uIChpbmNsdWRlSW5zdGFuY2UsIG1zZykgewogICAgdmFyIGYsCiAgICAgICAgb2JqID0gewogICAgICB0cmFuc2FjdGlvbnNMaXN0OiBqc3BiLk1lc3NhZ2UudG9PYmplY3RMaXN0KG1zZy5nZXRUcmFuc2FjdGlvbnNMaXN0KCksIHVzZXJ0eXBlX3BiLlRyYW5zYWN0aW9uLnRvT2JqZWN0LCBpbmNsdWRlSW5zdGFuY2UpLAogICAgICBwYWdlTm86IGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KG1zZywgMiwgMCksCiAgICAgIHBhZ2VTaXplOiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdChtc2csIDMsIDApLAogICAgICB0b3RhbFBhZ2U6IGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KG1zZywgNCwgMCksCiAgICAgIHRvdGFsQ291bnQ6IGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KG1zZywgNSwgMCkKICAgIH07CgogICAgaWYgKGluY2x1ZGVJbnN0YW5jZSkgewogICAgICBvYmouJGpzcGJNZXNzYWdlSW5zdGFuY2UgPSBtc2c7CiAgICB9CgogICAgcmV0dXJuIG9iajsKICB9Owp9Ci8qKgogKiBEZXNlcmlhbGl6ZXMgYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUgZm9ybWF0KS4KICogQHBhcmFtIHtqc3BiLkJ5dGVTb3VyY2V9IGJ5dGVzIFRoZSBieXRlcyB0byBkZXNlcmlhbGl6ZS4KICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5UcmFuc2FjdGlvbkxpc3RSZXBseX0KICovCgoKcHJvdG8ucGIuY21zLlRyYW5zYWN0aW9uTGlzdFJlcGx5LmRlc2VyaWFsaXplQmluYXJ5ID0gZnVuY3Rpb24gKGJ5dGVzKSB7CiAgdmFyIHJlYWRlciA9IG5ldyBqc3BiLkJpbmFyeVJlYWRlcihieXRlcyk7CiAgdmFyIG1zZyA9IG5ldyBwcm90by5wYi5jbXMuVHJhbnNhY3Rpb25MaXN0UmVwbHkoKTsKICByZXR1cm4gcHJvdG8ucGIuY21zLlRyYW5zYWN0aW9uTGlzdFJlcGx5LmRlc2VyaWFsaXplQmluYXJ5RnJvbVJlYWRlcihtc2csIHJlYWRlcik7Cn07Ci8qKgogKiBEZXNlcmlhbGl6ZXMgYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUgZm9ybWF0KSBmcm9tIHRoZQogKiBnaXZlbiByZWFkZXIgaW50byB0aGUgZ2l2ZW4gbWVzc2FnZSBvYmplY3QuCiAqIEBwYXJhbSB7IXByb3RvLnBiLmNtcy5UcmFuc2FjdGlvbkxpc3RSZXBseX0gbXNnIFRoZSBtZXNzYWdlIG9iamVjdCB0byBkZXNlcmlhbGl6ZSBpbnRvLgogKiBAcGFyYW0geyFqc3BiLkJpbmFyeVJlYWRlcn0gcmVhZGVyIFRoZSBCaW5hcnlSZWFkZXIgdG8gdXNlLgogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLlRyYW5zYWN0aW9uTGlzdFJlcGx5fQogKi8KCgpwcm90by5wYi5jbXMuVHJhbnNhY3Rpb25MaXN0UmVwbHkuZGVzZXJpYWxpemVCaW5hcnlGcm9tUmVhZGVyID0gZnVuY3Rpb24gKG1zZywgcmVhZGVyKSB7CiAgd2hpbGUgKHJlYWRlci5uZXh0RmllbGQoKSkgewogICAgaWYgKHJlYWRlci5pc0VuZEdyb3VwKCkpIHsKICAgICAgYnJlYWs7CiAgICB9CgogICAgdmFyIGZpZWxkID0gcmVhZGVyLmdldEZpZWxkTnVtYmVyKCk7CgogICAgc3dpdGNoIChmaWVsZCkgewogICAgICBjYXNlIDE6CiAgICAgICAgdmFyIHZhbHVlID0gbmV3IHVzZXJ0eXBlX3BiLlRyYW5zYWN0aW9uKCk7CiAgICAgICAgcmVhZGVyLnJlYWRNZXNzYWdlKHZhbHVlLCB1c2VydHlwZV9wYi5UcmFuc2FjdGlvbi5kZXNlcmlhbGl6ZUJpbmFyeUZyb21SZWFkZXIpOwogICAgICAgIG1zZy5hZGRUcmFuc2FjdGlvbnModmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSAyOgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkVWludDMyKCk7CiAgICAgICAgbXNnLnNldFBhZ2VObyh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlIDM6CiAgICAgICAgdmFyIHZhbHVlID0gcmVhZGVyLnJlYWRVaW50MzIoKTsKICAgICAgICBtc2cuc2V0UGFnZVNpemUodmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSA0OgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkVWludDMyKCk7CiAgICAgICAgbXNnLnNldFRvdGFsUGFnZSh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlIDU6CiAgICAgICAgdmFyIHZhbHVlID0gcmVhZGVyLnJlYWRVaW50MzIoKTsKICAgICAgICBtc2cuc2V0VG90YWxDb3VudCh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBkZWZhdWx0OgogICAgICAgIHJlYWRlci5za2lwRmllbGQoKTsKICAgICAgICBicmVhazsKICAgIH0KICB9CgogIHJldHVybiBtc2c7Cn07Ci8qKgogKiBTZXJpYWxpemVzIHRoZSBtZXNzYWdlIHRvIGJpbmFyeSBkYXRhIChpbiBwcm90b2J1ZiB3aXJlIGZvcm1hdCkuCiAqIEByZXR1cm4geyFVaW50OEFycmF5fQogKi8KCgpwcm90by5wYi5jbXMuVHJhbnNhY3Rpb25MaXN0UmVwbHkucHJvdG90eXBlLnNlcmlhbGl6ZUJpbmFyeSA9IGZ1bmN0aW9uICgpIHsKICB2YXIgd3JpdGVyID0gbmV3IGpzcGIuQmluYXJ5V3JpdGVyKCk7CiAgcHJvdG8ucGIuY21zLlRyYW5zYWN0aW9uTGlzdFJlcGx5LnNlcmlhbGl6ZUJpbmFyeVRvV3JpdGVyKHRoaXMsIHdyaXRlcik7CiAgcmV0dXJuIHdyaXRlci5nZXRSZXN1bHRCdWZmZXIoKTsKfTsKLyoqCiAqIFNlcmlhbGl6ZXMgdGhlIGdpdmVuIG1lc3NhZ2UgdG8gYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUKICogZm9ybWF0KSwgd3JpdGluZyB0byB0aGUgZ2l2ZW4gQmluYXJ5V3JpdGVyLgogKiBAcGFyYW0geyFwcm90by5wYi5jbXMuVHJhbnNhY3Rpb25MaXN0UmVwbHl9IG1lc3NhZ2UKICogQHBhcmFtIHshanNwYi5CaW5hcnlXcml0ZXJ9IHdyaXRlcgogKiBAc3VwcHJlc3Mge3VudXNlZExvY2FsVmFyaWFibGVzfSBmIGlzIG9ubHkgdXNlZCBmb3IgbmVzdGVkIG1lc3NhZ2VzCiAqLwoKCnByb3RvLnBiLmNtcy5UcmFuc2FjdGlvbkxpc3RSZXBseS5zZXJpYWxpemVCaW5hcnlUb1dyaXRlciA9IGZ1bmN0aW9uIChtZXNzYWdlLCB3cml0ZXIpIHsKICB2YXIgZiA9IHVuZGVmaW5lZDsKICBmID0gbWVzc2FnZS5nZXRUcmFuc2FjdGlvbnNMaXN0KCk7CgogIGlmIChmLmxlbmd0aCA+IDApIHsKICAgIHdyaXRlci53cml0ZVJlcGVhdGVkTWVzc2FnZSgxLCBmLCB1c2VydHlwZV9wYi5UcmFuc2FjdGlvbi5zZXJpYWxpemVCaW5hcnlUb1dyaXRlcik7CiAgfQoKICBmID0gbWVzc2FnZS5nZXRQYWdlTm8oKTsKCiAgaWYgKGYgIT09IDApIHsKICAgIHdyaXRlci53cml0ZVVpbnQzMigyLCBmKTsKICB9CgogIGYgPSBtZXNzYWdlLmdldFBhZ2VTaXplKCk7CgogIGlmIChmICE9PSAwKSB7CiAgICB3cml0ZXIud3JpdGVVaW50MzIoMywgZik7CiAgfQoKICBmID0gbWVzc2FnZS5nZXRUb3RhbFBhZ2UoKTsKCiAgaWYgKGYgIT09IDApIHsKICAgIHdyaXRlci53cml0ZVVpbnQzMig0LCBmKTsKICB9CgogIGYgPSBtZXNzYWdlLmdldFRvdGFsQ291bnQoKTsKCiAgaWYgKGYgIT09IDApIHsKICAgIHdyaXRlci53cml0ZVVpbnQzMig1LCBmKTsKICB9Cn07Ci8qKgogKiByZXBlYXRlZCBwYi5UcmFuc2FjdGlvbiB0cmFuc2FjdGlvbnMgPSAxOwogKiBAcmV0dXJuIHshQXJyYXk8IXByb3RvLnBiLlRyYW5zYWN0aW9uPn0KICovCgoKcHJvdG8ucGIuY21zLlRyYW5zYWN0aW9uTGlzdFJlcGx5LnByb3RvdHlwZS5nZXRUcmFuc2FjdGlvbnNMaXN0ID0gZnVuY3Rpb24gKCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuZ2V0UmVwZWF0ZWRXcmFwcGVyRmllbGQodGhpcywgdXNlcnR5cGVfcGIuVHJhbnNhY3Rpb24sIDEpOwp9OwovKioKICogQHBhcmFtIHshQXJyYXk8IXByb3RvLnBiLlRyYW5zYWN0aW9uPn0gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5UcmFuc2FjdGlvbkxpc3RSZXBseX0gcmV0dXJucyB0aGlzCiovCgoKcHJvdG8ucGIuY21zLlRyYW5zYWN0aW9uTGlzdFJlcGx5LnByb3RvdHlwZS5zZXRUcmFuc2FjdGlvbnNMaXN0ID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRSZXBlYXRlZFdyYXBwZXJGaWVsZCh0aGlzLCAxLCB2YWx1ZSk7Cn07Ci8qKgogKiBAcGFyYW0geyFwcm90by5wYi5UcmFuc2FjdGlvbj19IG9wdF92YWx1ZQogKiBAcGFyYW0ge251bWJlcj19IG9wdF9pbmRleAogKiBAcmV0dXJuIHshcHJvdG8ucGIuVHJhbnNhY3Rpb259CiAqLwoKCnByb3RvLnBiLmNtcy5UcmFuc2FjdGlvbkxpc3RSZXBseS5wcm90b3R5cGUuYWRkVHJhbnNhY3Rpb25zID0gZnVuY3Rpb24gKG9wdF92YWx1ZSwgb3B0X2luZGV4KSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5hZGRUb1JlcGVhdGVkV3JhcHBlckZpZWxkKHRoaXMsIDEsIG9wdF92YWx1ZSwgcHJvdG8ucGIuVHJhbnNhY3Rpb24sIG9wdF9pbmRleCk7Cn07Ci8qKgogKiBDbGVhcnMgdGhlIGxpc3QgbWFraW5nIGl0IGVtcHR5IGJ1dCBub24tbnVsbC4KICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5UcmFuc2FjdGlvbkxpc3RSZXBseX0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5UcmFuc2FjdGlvbkxpc3RSZXBseS5wcm90b3R5cGUuY2xlYXJUcmFuc2FjdGlvbnNMaXN0ID0gZnVuY3Rpb24gKCkgewogIHJldHVybiB0aGlzLnNldFRyYW5zYWN0aW9uc0xpc3QoW10pOwp9OwovKioKICogb3B0aW9uYWwgdWludDMyIHBhZ2Vfbm8gPSAyOwogKiBAcmV0dXJuIHtudW1iZXJ9CiAqLwoKCnByb3RvLnBiLmNtcy5UcmFuc2FjdGlvbkxpc3RSZXBseS5wcm90b3R5cGUuZ2V0UGFnZU5vID0gZnVuY3Rpb24gKCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdCh0aGlzLCAyLCAwKTsKfTsKLyoqCiAqIEBwYXJhbSB7bnVtYmVyfSB2YWx1ZQogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLlRyYW5zYWN0aW9uTGlzdFJlcGx5fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLlRyYW5zYWN0aW9uTGlzdFJlcGx5LnByb3RvdHlwZS5zZXRQYWdlTm8gPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0ludEZpZWxkKHRoaXMsIDIsIHZhbHVlKTsKfTsKLyoqCiAqIG9wdGlvbmFsIHVpbnQzMiBwYWdlX3NpemUgPSAzOwogKiBAcmV0dXJuIHtudW1iZXJ9CiAqLwoKCnByb3RvLnBiLmNtcy5UcmFuc2FjdGlvbkxpc3RSZXBseS5wcm90b3R5cGUuZ2V0UGFnZVNpemUgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDMsIDApOwp9OwovKioKICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuVHJhbnNhY3Rpb25MaXN0UmVwbHl9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuVHJhbnNhY3Rpb25MaXN0UmVwbHkucHJvdG90eXBlLnNldFBhZ2VTaXplID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRQcm90bzNJbnRGaWVsZCh0aGlzLCAzLCB2YWx1ZSk7Cn07Ci8qKgogKiBvcHRpb25hbCB1aW50MzIgdG90YWxfcGFnZSA9IDQ7CiAqIEByZXR1cm4ge251bWJlcn0KICovCgoKcHJvdG8ucGIuY21zLlRyYW5zYWN0aW9uTGlzdFJlcGx5LnByb3RvdHlwZS5nZXRUb3RhbFBhZ2UgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDQsIDApOwp9OwovKioKICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuVHJhbnNhY3Rpb25MaXN0UmVwbHl9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuVHJhbnNhY3Rpb25MaXN0UmVwbHkucHJvdG90eXBlLnNldFRvdGFsUGFnZSA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UHJvdG8zSW50RmllbGQodGhpcywgNCwgdmFsdWUpOwp9OwovKioKICogb3B0aW9uYWwgdWludDMyIHRvdGFsX2NvdW50ID0gNTsKICogQHJldHVybiB7bnVtYmVyfQogKi8KCgpwcm90by5wYi5jbXMuVHJhbnNhY3Rpb25MaXN0UmVwbHkucHJvdG90eXBlLmdldFRvdGFsQ291bnQgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDUsIDApOwp9OwovKioKICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuVHJhbnNhY3Rpb25MaXN0UmVwbHl9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuVHJhbnNhY3Rpb25MaXN0UmVwbHkucHJvdG90eXBlLnNldFRvdGFsQ291bnQgPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0ludEZpZWxkKHRoaXMsIDUsIHZhbHVlKTsKfTsKCmlmIChqc3BiLk1lc3NhZ2UuR0VORVJBVEVfVE9fT0JKRUNUKSB7CiAgLyoqCiAgICogQ3JlYXRlcyBhbiBvYmplY3QgcmVwcmVzZW50YXRpb24gb2YgdGhpcyBwcm90by4KICAgKiBGaWVsZCBuYW1lcyB0aGF0IGFyZSByZXNlcnZlZCBpbiBKYXZhU2NyaXB0IGFuZCB3aWxsIGJlIHJlbmFtZWQgdG8gcGJfbmFtZS4KICAgKiBPcHRpb25hbCBmaWVsZHMgdGhhdCBhcmUgbm90IHNldCB3aWxsIGJlIHNldCB0byB1bmRlZmluZWQuCiAgICogVG8gYWNjZXNzIGEgcmVzZXJ2ZWQgZmllbGQgdXNlLCBmb28ucGJfPG5hbWU+LCBlZywgZm9vLnBiX2RlZmF1bHQuCiAgICogRm9yIHRoZSBsaXN0IG9mIHJlc2VydmVkIG5hbWVzIHBsZWFzZSBzZWU6CiAgICogICAgIG5ldC9wcm90bzIvY29tcGlsZXIvanMvaW50ZXJuYWwvZ2VuZXJhdG9yLmNjI2tLZXl3b3JkLgogICAqIEBwYXJhbSB7Ym9vbGVhbj19IG9wdF9pbmNsdWRlSW5zdGFuY2UgRGVwcmVjYXRlZC4gd2hldGhlciB0byBpbmNsdWRlIHRoZQogICAqICAgICBKU1BCIGluc3RhbmNlIGZvciB0cmFuc2l0aW9uYWwgc295IHByb3RvIHN1cHBvcnQ6CiAgICogICAgIGh0dHA6Ly9nb3RvL3NveS1wYXJhbS1taWdyYXRpb24KICAgKiBAcmV0dXJuIHshT2JqZWN0fQogICAqLwogIHByb3RvLnBiLmNtcy5DcmVhdGVTZXR0bGVSZXF1ZXN0LnByb3RvdHlwZS50b09iamVjdCA9IGZ1bmN0aW9uIChvcHRfaW5jbHVkZUluc3RhbmNlKSB7CiAgICByZXR1cm4gcHJvdG8ucGIuY21zLkNyZWF0ZVNldHRsZVJlcXVlc3QudG9PYmplY3Qob3B0X2luY2x1ZGVJbnN0YW5jZSwgdGhpcyk7CiAgfTsKICAvKioKICAgKiBTdGF0aWMgdmVyc2lvbiBvZiB0aGUge0BzZWUgdG9PYmplY3R9IG1ldGhvZC4KICAgKiBAcGFyYW0ge2Jvb2xlYW58dW5kZWZpbmVkfSBpbmNsdWRlSW5zdGFuY2UgRGVwcmVjYXRlZC4gV2hldGhlciB0byBpbmNsdWRlCiAgICogICAgIHRoZSBKU1BCIGluc3RhbmNlIGZvciB0cmFuc2l0aW9uYWwgc295IHByb3RvIHN1cHBvcnQ6CiAgICogICAgIGh0dHA6Ly9nb3RvL3NveS1wYXJhbS1taWdyYXRpb24KICAgKiBAcGFyYW0geyFwcm90by5wYi5jbXMuQ3JlYXRlU2V0dGxlUmVxdWVzdH0gbXNnIFRoZSBtc2cgaW5zdGFuY2UgdG8gdHJhbnNmb3JtLgogICAqIEByZXR1cm4geyFPYmplY3R9CiAgICogQHN1cHByZXNzIHt1bnVzZWRMb2NhbFZhcmlhYmxlc30gZiBpcyBvbmx5IHVzZWQgZm9yIG5lc3RlZCBtZXNzYWdlcwogICAqLwoKCiAgcHJvdG8ucGIuY21zLkNyZWF0ZVNldHRsZVJlcXVlc3QudG9PYmplY3QgPSBmdW5jdGlvbiAoaW5jbHVkZUluc3RhbmNlLCBtc2cpIHsKICAgIHZhciBmLAogICAgICAgIG9iaiA9IHsKICAgICAgYXJlYUlkOiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdChtc2csIDEsIDApLAogICAgICBzZXR0bGVBdDoganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQobXNnLCAyLCAwKSwKICAgICAgbWluQmFsYW5jZToganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQobXNnLCAzLCAwKQogICAgfTsKCiAgICBpZiAoaW5jbHVkZUluc3RhbmNlKSB7CiAgICAgIG9iai4kanNwYk1lc3NhZ2VJbnN0YW5jZSA9IG1zZzsKICAgIH0KCiAgICByZXR1cm4gb2JqOwogIH07Cn0KLyoqCiAqIERlc2VyaWFsaXplcyBiaW5hcnkgZGF0YSAoaW4gcHJvdG9idWYgd2lyZSBmb3JtYXQpLgogKiBAcGFyYW0ge2pzcGIuQnl0ZVNvdXJjZX0gYnl0ZXMgVGhlIGJ5dGVzIHRvIGRlc2VyaWFsaXplLgogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLkNyZWF0ZVNldHRsZVJlcXVlc3R9CiAqLwoKCnByb3RvLnBiLmNtcy5DcmVhdGVTZXR0bGVSZXF1ZXN0LmRlc2VyaWFsaXplQmluYXJ5ID0gZnVuY3Rpb24gKGJ5dGVzKSB7CiAgdmFyIHJlYWRlciA9IG5ldyBqc3BiLkJpbmFyeVJlYWRlcihieXRlcyk7CiAgdmFyIG1zZyA9IG5ldyBwcm90by5wYi5jbXMuQ3JlYXRlU2V0dGxlUmVxdWVzdCgpOwogIHJldHVybiBwcm90by5wYi5jbXMuQ3JlYXRlU2V0dGxlUmVxdWVzdC5kZXNlcmlhbGl6ZUJpbmFyeUZyb21SZWFkZXIobXNnLCByZWFkZXIpOwp9OwovKioKICogRGVzZXJpYWxpemVzIGJpbmFyeSBkYXRhIChpbiBwcm90b2J1ZiB3aXJlIGZvcm1hdCkgZnJvbSB0aGUKICogZ2l2ZW4gcmVhZGVyIGludG8gdGhlIGdpdmVuIG1lc3NhZ2Ugb2JqZWN0LgogKiBAcGFyYW0geyFwcm90by5wYi5jbXMuQ3JlYXRlU2V0dGxlUmVxdWVzdH0gbXNnIFRoZSBtZXNzYWdlIG9iamVjdCB0byBkZXNlcmlhbGl6ZSBpbnRvLgogKiBAcGFyYW0geyFqc3BiLkJpbmFyeVJlYWRlcn0gcmVhZGVyIFRoZSBCaW5hcnlSZWFkZXIgdG8gdXNlLgogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLkNyZWF0ZVNldHRsZVJlcXVlc3R9CiAqLwoKCnByb3RvLnBiLmNtcy5DcmVhdGVTZXR0bGVSZXF1ZXN0LmRlc2VyaWFsaXplQmluYXJ5RnJvbVJlYWRlciA9IGZ1bmN0aW9uIChtc2csIHJlYWRlcikgewogIHdoaWxlIChyZWFkZXIubmV4dEZpZWxkKCkpIHsKICAgIGlmIChyZWFkZXIuaXNFbmRHcm91cCgpKSB7CiAgICAgIGJyZWFrOwogICAgfQoKICAgIHZhciBmaWVsZCA9IHJlYWRlci5nZXRGaWVsZE51bWJlcigpOwoKICAgIHN3aXRjaCAoZmllbGQpIHsKICAgICAgY2FzZSAxOgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkVWludDMyKCk7CiAgICAgICAgbXNnLnNldEFyZWFJZCh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlIDI6CiAgICAgICAgdmFyIHZhbHVlID0gcmVhZGVyLnJlYWRVaW50MzIoKTsKICAgICAgICBtc2cuc2V0U2V0dGxlQXQodmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSAzOgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkVWludDMyKCk7CiAgICAgICAgbXNnLnNldE1pbkJhbGFuY2UodmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgZGVmYXVsdDoKICAgICAgICByZWFkZXIuc2tpcEZpZWxkKCk7CiAgICAgICAgYnJlYWs7CiAgICB9CiAgfQoKICByZXR1cm4gbXNnOwp9OwovKioKICogU2VyaWFsaXplcyB0aGUgbWVzc2FnZSB0byBiaW5hcnkgZGF0YSAoaW4gcHJvdG9idWYgd2lyZSBmb3JtYXQpLgogKiBAcmV0dXJuIHshVWludDhBcnJheX0KICovCgoKcHJvdG8ucGIuY21zLkNyZWF0ZVNldHRsZVJlcXVlc3QucHJvdG90eXBlLnNlcmlhbGl6ZUJpbmFyeSA9IGZ1bmN0aW9uICgpIHsKICB2YXIgd3JpdGVyID0gbmV3IGpzcGIuQmluYXJ5V3JpdGVyKCk7CiAgcHJvdG8ucGIuY21zLkNyZWF0ZVNldHRsZVJlcXVlc3Quc2VyaWFsaXplQmluYXJ5VG9Xcml0ZXIodGhpcywgd3JpdGVyKTsKICByZXR1cm4gd3JpdGVyLmdldFJlc3VsdEJ1ZmZlcigpOwp9OwovKioKICogU2VyaWFsaXplcyB0aGUgZ2l2ZW4gbWVzc2FnZSB0byBiaW5hcnkgZGF0YSAoaW4gcHJvdG9idWYgd2lyZQogKiBmb3JtYXQpLCB3cml0aW5nIHRvIHRoZSBnaXZlbiBCaW5hcnlXcml0ZXIuCiAqIEBwYXJhbSB7IXByb3RvLnBiLmNtcy5DcmVhdGVTZXR0bGVSZXF1ZXN0fSBtZXNzYWdlCiAqIEBwYXJhbSB7IWpzcGIuQmluYXJ5V3JpdGVyfSB3cml0ZXIKICogQHN1cHByZXNzIHt1bnVzZWRMb2NhbFZhcmlhYmxlc30gZiBpcyBvbmx5IHVzZWQgZm9yIG5lc3RlZCBtZXNzYWdlcwogKi8KCgpwcm90by5wYi5jbXMuQ3JlYXRlU2V0dGxlUmVxdWVzdC5zZXJpYWxpemVCaW5hcnlUb1dyaXRlciA9IGZ1bmN0aW9uIChtZXNzYWdlLCB3cml0ZXIpIHsKICB2YXIgZiA9IHVuZGVmaW5lZDsKICBmID0gbWVzc2FnZS5nZXRBcmVhSWQoKTsKCiAgaWYgKGYgIT09IDApIHsKICAgIHdyaXRlci53cml0ZVVpbnQzMigxLCBmKTsKICB9CgogIGYgPSBtZXNzYWdlLmdldFNldHRsZUF0KCk7CgogIGlmIChmICE9PSAwKSB7CiAgICB3cml0ZXIud3JpdGVVaW50MzIoMiwgZik7CiAgfQoKICBmID0gbWVzc2FnZS5nZXRNaW5CYWxhbmNlKCk7CgogIGlmIChmICE9PSAwKSB7CiAgICB3cml0ZXIud3JpdGVVaW50MzIoMywgZik7CiAgfQp9OwovKioKICogb3B0aW9uYWwgdWludDMyIGFyZWFfaWQgPSAxOwogKiBAcmV0dXJuIHtudW1iZXJ9CiAqLwoKCnByb3RvLnBiLmNtcy5DcmVhdGVTZXR0bGVSZXF1ZXN0LnByb3RvdHlwZS5nZXRBcmVhSWQgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDEsIDApOwp9OwovKioKICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuQ3JlYXRlU2V0dGxlUmVxdWVzdH0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5DcmVhdGVTZXR0bGVSZXF1ZXN0LnByb3RvdHlwZS5zZXRBcmVhSWQgPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0ludEZpZWxkKHRoaXMsIDEsIHZhbHVlKTsKfTsKLyoqCiAqIG9wdGlvbmFsIHVpbnQzMiBzZXR0bGVfYXQgPSAyOwogKiBAcmV0dXJuIHtudW1iZXJ9CiAqLwoKCnByb3RvLnBiLmNtcy5DcmVhdGVTZXR0bGVSZXF1ZXN0LnByb3RvdHlwZS5nZXRTZXR0bGVBdCA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQodGhpcywgMiwgMCk7Cn07Ci8qKgogKiBAcGFyYW0ge251bWJlcn0gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5DcmVhdGVTZXR0bGVSZXF1ZXN0fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLkNyZWF0ZVNldHRsZVJlcXVlc3QucHJvdG90eXBlLnNldFNldHRsZUF0ID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRQcm90bzNJbnRGaWVsZCh0aGlzLCAyLCB2YWx1ZSk7Cn07Ci8qKgogKiBvcHRpb25hbCB1aW50MzIgbWluX2JhbGFuY2UgPSAzOwogKiBAcmV0dXJuIHtudW1iZXJ9CiAqLwoKCnByb3RvLnBiLmNtcy5DcmVhdGVTZXR0bGVSZXF1ZXN0LnByb3RvdHlwZS5nZXRNaW5CYWxhbmNlID0gZnVuY3Rpb24gKCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdCh0aGlzLCAzLCAwKTsKfTsKLyoqCiAqIEBwYXJhbSB7bnVtYmVyfSB2YWx1ZQogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLkNyZWF0ZVNldHRsZVJlcXVlc3R9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuQ3JlYXRlU2V0dGxlUmVxdWVzdC5wcm90b3R5cGUuc2V0TWluQmFsYW5jZSA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UHJvdG8zSW50RmllbGQodGhpcywgMywgdmFsdWUpOwp9OwovKioKICogTGlzdCBvZiByZXBlYXRlZCBmaWVsZHMgd2l0aGluIHRoaXMgbWVzc2FnZSB0eXBlLgogKiBAcHJpdmF0ZSB7IUFycmF5PG51bWJlcj59CiAqIEBjb25zdAogKi8KCgpwcm90by5wYi5jbXMuU3VibWl0U2V0dGxlUmVxdWVzdC5yZXBlYXRlZEZpZWxkc18gPSBbMl07CgppZiAoanNwYi5NZXNzYWdlLkdFTkVSQVRFX1RPX09CSkVDVCkgewogIC8qKgogICAqIENyZWF0ZXMgYW4gb2JqZWN0IHJlcHJlc2VudGF0aW9uIG9mIHRoaXMgcHJvdG8uCiAgICogRmllbGQgbmFtZXMgdGhhdCBhcmUgcmVzZXJ2ZWQgaW4gSmF2YVNjcmlwdCBhbmQgd2lsbCBiZSByZW5hbWVkIHRvIHBiX25hbWUuCiAgICogT3B0aW9uYWwgZmllbGRzIHRoYXQgYXJlIG5vdCBzZXQgd2lsbCBiZSBzZXQgdG8gdW5kZWZpbmVkLgogICAqIFRvIGFjY2VzcyBhIHJlc2VydmVkIGZpZWxkIHVzZSwgZm9vLnBiXzxuYW1lPiwgZWcsIGZvby5wYl9kZWZhdWx0LgogICAqIEZvciB0aGUgbGlzdCBvZiByZXNlcnZlZCBuYW1lcyBwbGVhc2Ugc2VlOgogICAqICAgICBuZXQvcHJvdG8yL2NvbXBpbGVyL2pzL2ludGVybmFsL2dlbmVyYXRvci5jYyNrS2V5d29yZC4KICAgKiBAcGFyYW0ge2Jvb2xlYW49fSBvcHRfaW5jbHVkZUluc3RhbmNlIERlcHJlY2F0ZWQuIHdoZXRoZXIgdG8gaW5jbHVkZSB0aGUKICAgKiAgICAgSlNQQiBpbnN0YW5jZSBmb3IgdHJhbnNpdGlvbmFsIHNveSBwcm90byBzdXBwb3J0OgogICAqICAgICBodHRwOi8vZ290by9zb3ktcGFyYW0tbWlncmF0aW9uCiAgICogQHJldHVybiB7IU9iamVjdH0KICAgKi8KICBwcm90by5wYi5jbXMuU3VibWl0U2V0dGxlUmVxdWVzdC5wcm90b3R5cGUudG9PYmplY3QgPSBmdW5jdGlvbiAob3B0X2luY2x1ZGVJbnN0YW5jZSkgewogICAgcmV0dXJuIHByb3RvLnBiLmNtcy5TdWJtaXRTZXR0bGVSZXF1ZXN0LnRvT2JqZWN0KG9wdF9pbmNsdWRlSW5zdGFuY2UsIHRoaXMpOwogIH07CiAgLyoqCiAgICogU3RhdGljIHZlcnNpb24gb2YgdGhlIHtAc2VlIHRvT2JqZWN0fSBtZXRob2QuCiAgICogQHBhcmFtIHtib29sZWFufHVuZGVmaW5lZH0gaW5jbHVkZUluc3RhbmNlIERlcHJlY2F0ZWQuIFdoZXRoZXIgdG8gaW5jbHVkZQogICAqICAgICB0aGUgSlNQQiBpbnN0YW5jZSBmb3IgdHJhbnNpdGlvbmFsIHNveSBwcm90byBzdXBwb3J0OgogICAqICAgICBodHRwOi8vZ290by9zb3ktcGFyYW0tbWlncmF0aW9uCiAgICogQHBhcmFtIHshcHJvdG8ucGIuY21zLlN1Ym1pdFNldHRsZVJlcXVlc3R9IG1zZyBUaGUgbXNnIGluc3RhbmNlIHRvIHRyYW5zZm9ybS4KICAgKiBAcmV0dXJuIHshT2JqZWN0fQogICAqIEBzdXBwcmVzcyB7dW51c2VkTG9jYWxWYXJpYWJsZXN9IGYgaXMgb25seSB1c2VkIGZvciBuZXN0ZWQgbWVzc2FnZXMKICAgKi8KCgogIHByb3RvLnBiLmNtcy5TdWJtaXRTZXR0bGVSZXF1ZXN0LnRvT2JqZWN0ID0gZnVuY3Rpb24gKGluY2x1ZGVJbnN0YW5jZSwgbXNnKSB7CiAgICB2YXIgZiwKICAgICAgICBvYmogPSB7CiAgICAgIGFyZWFJZDoganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQobXNnLCAxLCAwKSwKICAgICAgcmVjb3Jkc0xpc3Q6IGpzcGIuTWVzc2FnZS50b09iamVjdExpc3QobXNnLmdldFJlY29yZHNMaXN0KCksIGFuY2hvcnR5cGVfcGIuU2V0dGxlUmVjb3JkLnRvT2JqZWN0LCBpbmNsdWRlSW5zdGFuY2UpCiAgICB9OwoKICAgIGlmIChpbmNsdWRlSW5zdGFuY2UpIHsKICAgICAgb2JqLiRqc3BiTWVzc2FnZUluc3RhbmNlID0gbXNnOwogICAgfQoKICAgIHJldHVybiBvYmo7CiAgfTsKfQovKioKICogRGVzZXJpYWxpemVzIGJpbmFyeSBkYXRhIChpbiBwcm90b2J1ZiB3aXJlIGZvcm1hdCkuCiAqIEBwYXJhbSB7anNwYi5CeXRlU291cmNlfSBieXRlcyBUaGUgYnl0ZXMgdG8gZGVzZXJpYWxpemUuCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuU3VibWl0U2V0dGxlUmVxdWVzdH0KICovCgoKcHJvdG8ucGIuY21zLlN1Ym1pdFNldHRsZVJlcXVlc3QuZGVzZXJpYWxpemVCaW5hcnkgPSBmdW5jdGlvbiAoYnl0ZXMpIHsKICB2YXIgcmVhZGVyID0gbmV3IGpzcGIuQmluYXJ5UmVhZGVyKGJ5dGVzKTsKICB2YXIgbXNnID0gbmV3IHByb3RvLnBiLmNtcy5TdWJtaXRTZXR0bGVSZXF1ZXN0KCk7CiAgcmV0dXJuIHByb3RvLnBiLmNtcy5TdWJtaXRTZXR0bGVSZXF1ZXN0LmRlc2VyaWFsaXplQmluYXJ5RnJvbVJlYWRlcihtc2csIHJlYWRlcik7Cn07Ci8qKgogKiBEZXNlcmlhbGl6ZXMgYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUgZm9ybWF0KSBmcm9tIHRoZQogKiBnaXZlbiByZWFkZXIgaW50byB0aGUgZ2l2ZW4gbWVzc2FnZSBvYmplY3QuCiAqIEBwYXJhbSB7IXByb3RvLnBiLmNtcy5TdWJtaXRTZXR0bGVSZXF1ZXN0fSBtc2cgVGhlIG1lc3NhZ2Ugb2JqZWN0IHRvIGRlc2VyaWFsaXplIGludG8uCiAqIEBwYXJhbSB7IWpzcGIuQmluYXJ5UmVhZGVyfSByZWFkZXIgVGhlIEJpbmFyeVJlYWRlciB0byB1c2UuCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuU3VibWl0U2V0dGxlUmVxdWVzdH0KICovCgoKcHJvdG8ucGIuY21zLlN1Ym1pdFNldHRsZVJlcXVlc3QuZGVzZXJpYWxpemVCaW5hcnlGcm9tUmVhZGVyID0gZnVuY3Rpb24gKG1zZywgcmVhZGVyKSB7CiAgd2hpbGUgKHJlYWRlci5uZXh0RmllbGQoKSkgewogICAgaWYgKHJlYWRlci5pc0VuZEdyb3VwKCkpIHsKICAgICAgYnJlYWs7CiAgICB9CgogICAgdmFyIGZpZWxkID0gcmVhZGVyLmdldEZpZWxkTnVtYmVyKCk7CgogICAgc3dpdGNoIChmaWVsZCkgewogICAgICBjYXNlIDE6CiAgICAgICAgdmFyIHZhbHVlID0gcmVhZGVyLnJlYWRVaW50MzIoKTsKICAgICAgICBtc2cuc2V0QXJlYUlkKHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgMjoKICAgICAgICB2YXIgdmFsdWUgPSBuZXcgYW5jaG9ydHlwZV9wYi5TZXR0bGVSZWNvcmQoKTsKICAgICAgICByZWFkZXIucmVhZE1lc3NhZ2UodmFsdWUsIGFuY2hvcnR5cGVfcGIuU2V0dGxlUmVjb3JkLmRlc2VyaWFsaXplQmluYXJ5RnJvbVJlYWRlcik7CiAgICAgICAgbXNnLmFkZFJlY29yZHModmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgZGVmYXVsdDoKICAgICAgICByZWFkZXIuc2tpcEZpZWxkKCk7CiAgICAgICAgYnJlYWs7CiAgICB9CiAgfQoKICByZXR1cm4gbXNnOwp9OwovKioKICogU2VyaWFsaXplcyB0aGUgbWVzc2FnZSB0byBiaW5hcnkgZGF0YSAoaW4gcHJvdG9idWYgd2lyZSBmb3JtYXQpLgogKiBAcmV0dXJuIHshVWludDhBcnJheX0KICovCgoKcHJvdG8ucGIuY21zLlN1Ym1pdFNldHRsZVJlcXVlc3QucHJvdG90eXBlLnNlcmlhbGl6ZUJpbmFyeSA9IGZ1bmN0aW9uICgpIHsKICB2YXIgd3JpdGVyID0gbmV3IGpzcGIuQmluYXJ5V3JpdGVyKCk7CiAgcHJvdG8ucGIuY21zLlN1Ym1pdFNldHRsZVJlcXVlc3Quc2VyaWFsaXplQmluYXJ5VG9Xcml0ZXIodGhpcywgd3JpdGVyKTsKICByZXR1cm4gd3JpdGVyLmdldFJlc3VsdEJ1ZmZlcigpOwp9OwovKioKICogU2VyaWFsaXplcyB0aGUgZ2l2ZW4gbWVzc2FnZSB0byBiaW5hcnkgZGF0YSAoaW4gcHJvdG9idWYgd2lyZQogKiBmb3JtYXQpLCB3cml0aW5nIHRvIHRoZSBnaXZlbiBCaW5hcnlXcml0ZXIuCiAqIEBwYXJhbSB7IXByb3RvLnBiLmNtcy5TdWJtaXRTZXR0bGVSZXF1ZXN0fSBtZXNzYWdlCiAqIEBwYXJhbSB7IWpzcGIuQmluYXJ5V3JpdGVyfSB3cml0ZXIKICogQHN1cHByZXNzIHt1bnVzZWRMb2NhbFZhcmlhYmxlc30gZiBpcyBvbmx5IHVzZWQgZm9yIG5lc3RlZCBtZXNzYWdlcwogKi8KCgpwcm90by5wYi5jbXMuU3VibWl0U2V0dGxlUmVxdWVzdC5zZXJpYWxpemVCaW5hcnlUb1dyaXRlciA9IGZ1bmN0aW9uIChtZXNzYWdlLCB3cml0ZXIpIHsKICB2YXIgZiA9IHVuZGVmaW5lZDsKICBmID0gbWVzc2FnZS5nZXRBcmVhSWQoKTsKCiAgaWYgKGYgIT09IDApIHsKICAgIHdyaXRlci53cml0ZVVpbnQzMigxLCBmKTsKICB9CgogIGYgPSBtZXNzYWdlLmdldFJlY29yZHNMaXN0KCk7CgogIGlmIChmLmxlbmd0aCA+IDApIHsKICAgIHdyaXRlci53cml0ZVJlcGVhdGVkTWVzc2FnZSgyLCBmLCBhbmNob3J0eXBlX3BiLlNldHRsZVJlY29yZC5zZXJpYWxpemVCaW5hcnlUb1dyaXRlcik7CiAgfQp9OwovKioKICogb3B0aW9uYWwgdWludDMyIGFyZWFfaWQgPSAxOwogKiBAcmV0dXJuIHtudW1iZXJ9CiAqLwoKCnByb3RvLnBiLmNtcy5TdWJtaXRTZXR0bGVSZXF1ZXN0LnByb3RvdHlwZS5nZXRBcmVhSWQgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDEsIDApOwp9OwovKioKICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuU3VibWl0U2V0dGxlUmVxdWVzdH0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5TdWJtaXRTZXR0bGVSZXF1ZXN0LnByb3RvdHlwZS5zZXRBcmVhSWQgPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0ludEZpZWxkKHRoaXMsIDEsIHZhbHVlKTsKfTsKLyoqCiAqIHJlcGVhdGVkIHBiLlNldHRsZVJlY29yZCByZWNvcmRzID0gMjsKICogQHJldHVybiB7IUFycmF5PCFwcm90by5wYi5TZXR0bGVSZWNvcmQ+fQogKi8KCgpwcm90by5wYi5jbXMuU3VibWl0U2V0dGxlUmVxdWVzdC5wcm90b3R5cGUuZ2V0UmVjb3Jkc0xpc3QgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRSZXBlYXRlZFdyYXBwZXJGaWVsZCh0aGlzLCBhbmNob3J0eXBlX3BiLlNldHRsZVJlY29yZCwgMik7Cn07Ci8qKgogKiBAcGFyYW0geyFBcnJheTwhcHJvdG8ucGIuU2V0dGxlUmVjb3JkPn0gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5TdWJtaXRTZXR0bGVSZXF1ZXN0fSByZXR1cm5zIHRoaXMKKi8KCgpwcm90by5wYi5jbXMuU3VibWl0U2V0dGxlUmVxdWVzdC5wcm90b3R5cGUuc2V0UmVjb3Jkc0xpc3QgPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFJlcGVhdGVkV3JhcHBlckZpZWxkKHRoaXMsIDIsIHZhbHVlKTsKfTsKLyoqCiAqIEBwYXJhbSB7IXByb3RvLnBiLlNldHRsZVJlY29yZD19IG9wdF92YWx1ZQogKiBAcGFyYW0ge251bWJlcj19IG9wdF9pbmRleAogKiBAcmV0dXJuIHshcHJvdG8ucGIuU2V0dGxlUmVjb3JkfQogKi8KCgpwcm90by5wYi5jbXMuU3VibWl0U2V0dGxlUmVxdWVzdC5wcm90b3R5cGUuYWRkUmVjb3JkcyA9IGZ1bmN0aW9uIChvcHRfdmFsdWUsIG9wdF9pbmRleCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuYWRkVG9SZXBlYXRlZFdyYXBwZXJGaWVsZCh0aGlzLCAyLCBvcHRfdmFsdWUsIHByb3RvLnBiLlNldHRsZVJlY29yZCwgb3B0X2luZGV4KTsKfTsKLyoqCiAqIENsZWFycyB0aGUgbGlzdCBtYWtpbmcgaXQgZW1wdHkgYnV0IG5vbi1udWxsLgogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLlN1Ym1pdFNldHRsZVJlcXVlc3R9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuU3VibWl0U2V0dGxlUmVxdWVzdC5wcm90b3R5cGUuY2xlYXJSZWNvcmRzTGlzdCA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4gdGhpcy5zZXRSZWNvcmRzTGlzdChbXSk7Cn07CgppZiAoanNwYi5NZXNzYWdlLkdFTkVSQVRFX1RPX09CSkVDVCkgewogIC8qKgogICAqIENyZWF0ZXMgYW4gb2JqZWN0IHJlcHJlc2VudGF0aW9uIG9mIHRoaXMgcHJvdG8uCiAgICogRmllbGQgbmFtZXMgdGhhdCBhcmUgcmVzZXJ2ZWQgaW4gSmF2YVNjcmlwdCBhbmQgd2lsbCBiZSByZW5hbWVkIHRvIHBiX25hbWUuCiAgICogT3B0aW9uYWwgZmllbGRzIHRoYXQgYXJlIG5vdCBzZXQgd2lsbCBiZSBzZXQgdG8gdW5kZWZpbmVkLgogICAqIFRvIGFjY2VzcyBhIHJlc2VydmVkIGZpZWxkIHVzZSwgZm9vLnBiXzxuYW1lPiwgZWcsIGZvby5wYl9kZWZhdWx0LgogICAqIEZvciB0aGUgbGlzdCBvZiByZXNlcnZlZCBuYW1lcyBwbGVhc2Ugc2VlOgogICAqICAgICBuZXQvcHJvdG8yL2NvbXBpbGVyL2pzL2ludGVybmFsL2dlbmVyYXRvci5jYyNrS2V5d29yZC4KICAgKiBAcGFyYW0ge2Jvb2xlYW49fSBvcHRfaW5jbHVkZUluc3RhbmNlIERlcHJlY2F0ZWQuIHdoZXRoZXIgdG8gaW5jbHVkZSB0aGUKICAgKiAgICAgSlNQQiBpbnN0YW5jZSBmb3IgdHJhbnNpdGlvbmFsIHNveSBwcm90byBzdXBwb3J0OgogICAqICAgICBodHRwOi8vZ290by9zb3ktcGFyYW0tbWlncmF0aW9uCiAgICogQHJldHVybiB7IU9iamVjdH0KICAgKi8KICBwcm90by5wYi5jbXMuU2V0dGxlUHJvZ3Jlc3NSZXF1ZXN0LnByb3RvdHlwZS50b09iamVjdCA9IGZ1bmN0aW9uIChvcHRfaW5jbHVkZUluc3RhbmNlKSB7CiAgICByZXR1cm4gcHJvdG8ucGIuY21zLlNldHRsZVByb2dyZXNzUmVxdWVzdC50b09iamVjdChvcHRfaW5jbHVkZUluc3RhbmNlLCB0aGlzKTsKICB9OwogIC8qKgogICAqIFN0YXRpYyB2ZXJzaW9uIG9mIHRoZSB7QHNlZSB0b09iamVjdH0gbWV0aG9kLgogICAqIEBwYXJhbSB7Ym9vbGVhbnx1bmRlZmluZWR9IGluY2x1ZGVJbnN0YW5jZSBEZXByZWNhdGVkLiBXaGV0aGVyIHRvIGluY2x1ZGUKICAgKiAgICAgdGhlIEpTUEIgaW5zdGFuY2UgZm9yIHRyYW5zaXRpb25hbCBzb3kgcHJvdG8gc3VwcG9ydDoKICAgKiAgICAgaHR0cDovL2dvdG8vc295LXBhcmFtLW1pZ3JhdGlvbgogICAqIEBwYXJhbSB7IXByb3RvLnBiLmNtcy5TZXR0bGVQcm9ncmVzc1JlcXVlc3R9IG1zZyBUaGUgbXNnIGluc3RhbmNlIHRvIHRyYW5zZm9ybS4KICAgKiBAcmV0dXJuIHshT2JqZWN0fQogICAqIEBzdXBwcmVzcyB7dW51c2VkTG9jYWxWYXJpYWJsZXN9IGYgaXMgb25seSB1c2VkIGZvciBuZXN0ZWQgbWVzc2FnZXMKICAgKi8KCgogIHByb3RvLnBiLmNtcy5TZXR0bGVQcm9ncmVzc1JlcXVlc3QudG9PYmplY3QgPSBmdW5jdGlvbiAoaW5jbHVkZUluc3RhbmNlLCBtc2cpIHsKICAgIHZhciBmLAogICAgICAgIG9iaiA9IHsKICAgICAgYXJlYUlkOiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdChtc2csIDEsIDApCiAgICB9OwoKICAgIGlmIChpbmNsdWRlSW5zdGFuY2UpIHsKICAgICAgb2JqLiRqc3BiTWVzc2FnZUluc3RhbmNlID0gbXNnOwogICAgfQoKICAgIHJldHVybiBvYmo7CiAgfTsKfQovKioKICogRGVzZXJpYWxpemVzIGJpbmFyeSBkYXRhIChpbiBwcm90b2J1ZiB3aXJlIGZvcm1hdCkuCiAqIEBwYXJhbSB7anNwYi5CeXRlU291cmNlfSBieXRlcyBUaGUgYnl0ZXMgdG8gZGVzZXJpYWxpemUuCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuU2V0dGxlUHJvZ3Jlc3NSZXF1ZXN0fQogKi8KCgpwcm90by5wYi5jbXMuU2V0dGxlUHJvZ3Jlc3NSZXF1ZXN0LmRlc2VyaWFsaXplQmluYXJ5ID0gZnVuY3Rpb24gKGJ5dGVzKSB7CiAgdmFyIHJlYWRlciA9IG5ldyBqc3BiLkJpbmFyeVJlYWRlcihieXRlcyk7CiAgdmFyIG1zZyA9IG5ldyBwcm90by5wYi5jbXMuU2V0dGxlUHJvZ3Jlc3NSZXF1ZXN0KCk7CiAgcmV0dXJuIHByb3RvLnBiLmNtcy5TZXR0bGVQcm9ncmVzc1JlcXVlc3QuZGVzZXJpYWxpemVCaW5hcnlGcm9tUmVhZGVyKG1zZywgcmVhZGVyKTsKfTsKLyoqCiAqIERlc2VyaWFsaXplcyBiaW5hcnkgZGF0YSAoaW4gcHJvdG9idWYgd2lyZSBmb3JtYXQpIGZyb20gdGhlCiAqIGdpdmVuIHJlYWRlciBpbnRvIHRoZSBnaXZlbiBtZXNzYWdlIG9iamVjdC4KICogQHBhcmFtIHshcHJvdG8ucGIuY21zLlNldHRsZVByb2dyZXNzUmVxdWVzdH0gbXNnIFRoZSBtZXNzYWdlIG9iamVjdCB0byBkZXNlcmlhbGl6ZSBpbnRvLgogKiBAcGFyYW0geyFqc3BiLkJpbmFyeVJlYWRlcn0gcmVhZGVyIFRoZSBCaW5hcnlSZWFkZXIgdG8gdXNlLgogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLlNldHRsZVByb2dyZXNzUmVxdWVzdH0KICovCgoKcHJvdG8ucGIuY21zLlNldHRsZVByb2dyZXNzUmVxdWVzdC5kZXNlcmlhbGl6ZUJpbmFyeUZyb21SZWFkZXIgPSBmdW5jdGlvbiAobXNnLCByZWFkZXIpIHsKICB3aGlsZSAocmVhZGVyLm5leHRGaWVsZCgpKSB7CiAgICBpZiAocmVhZGVyLmlzRW5kR3JvdXAoKSkgewogICAgICBicmVhazsKICAgIH0KCiAgICB2YXIgZmllbGQgPSByZWFkZXIuZ2V0RmllbGROdW1iZXIoKTsKCiAgICBzd2l0Y2ggKGZpZWxkKSB7CiAgICAgIGNhc2UgMToKICAgICAgICB2YXIgdmFsdWUgPSByZWFkZXIucmVhZFVpbnQzMigpOwogICAgICAgIG1zZy5zZXRBcmVhSWQodmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgZGVmYXVsdDoKICAgICAgICByZWFkZXIuc2tpcEZpZWxkKCk7CiAgICAgICAgYnJlYWs7CiAgICB9CiAgfQoKICByZXR1cm4gbXNnOwp9OwovKioKICogU2VyaWFsaXplcyB0aGUgbWVzc2FnZSB0byBiaW5hcnkgZGF0YSAoaW4gcHJvdG9idWYgd2lyZSBmb3JtYXQpLgogKiBAcmV0dXJuIHshVWludDhBcnJheX0KICovCgoKcHJvdG8ucGIuY21zLlNldHRsZVByb2dyZXNzUmVxdWVzdC5wcm90b3R5cGUuc2VyaWFsaXplQmluYXJ5ID0gZnVuY3Rpb24gKCkgewogIHZhciB3cml0ZXIgPSBuZXcganNwYi5CaW5hcnlXcml0ZXIoKTsKICBwcm90by5wYi5jbXMuU2V0dGxlUHJvZ3Jlc3NSZXF1ZXN0LnNlcmlhbGl6ZUJpbmFyeVRvV3JpdGVyKHRoaXMsIHdyaXRlcik7CiAgcmV0dXJuIHdyaXRlci5nZXRSZXN1bHRCdWZmZXIoKTsKfTsKLyoqCiAqIFNlcmlhbGl6ZXMgdGhlIGdpdmVuIG1lc3NhZ2UgdG8gYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUKICogZm9ybWF0KSwgd3JpdGluZyB0byB0aGUgZ2l2ZW4gQmluYXJ5V3JpdGVyLgogKiBAcGFyYW0geyFwcm90by5wYi5jbXMuU2V0dGxlUHJvZ3Jlc3NSZXF1ZXN0fSBtZXNzYWdlCiAqIEBwYXJhbSB7IWpzcGIuQmluYXJ5V3JpdGVyfSB3cml0ZXIKICogQHN1cHByZXNzIHt1bnVzZWRMb2NhbFZhcmlhYmxlc30gZiBpcyBvbmx5IHVzZWQgZm9yIG5lc3RlZCBtZXNzYWdlcwogKi8KCgpwcm90by5wYi5jbXMuU2V0dGxlUHJvZ3Jlc3NSZXF1ZXN0LnNlcmlhbGl6ZUJpbmFyeVRvV3JpdGVyID0gZnVuY3Rpb24gKG1lc3NhZ2UsIHdyaXRlcikgewogIHZhciBmID0gdW5kZWZpbmVkOwogIGYgPSBtZXNzYWdlLmdldEFyZWFJZCgpOwoKICBpZiAoZiAhPT0gMCkgewogICAgd3JpdGVyLndyaXRlVWludDMyKDEsIGYpOwogIH0KfTsKLyoqCiAqIG9wdGlvbmFsIHVpbnQzMiBhcmVhX2lkID0gMTsKICogQHJldHVybiB7bnVtYmVyfQogKi8KCgpwcm90by5wYi5jbXMuU2V0dGxlUHJvZ3Jlc3NSZXF1ZXN0LnByb3RvdHlwZS5nZXRBcmVhSWQgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDEsIDApOwp9OwovKioKICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuU2V0dGxlUHJvZ3Jlc3NSZXF1ZXN0fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLlNldHRsZVByb2dyZXNzUmVxdWVzdC5wcm90b3R5cGUuc2V0QXJlYUlkID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRQcm90bzNJbnRGaWVsZCh0aGlzLCAxLCB2YWx1ZSk7Cn07CgppZiAoanNwYi5NZXNzYWdlLkdFTkVSQVRFX1RPX09CSkVDVCkgewogIC8qKgogICAqIENyZWF0ZXMgYW4gb2JqZWN0IHJlcHJlc2VudGF0aW9uIG9mIHRoaXMgcHJvdG8uCiAgICogRmllbGQgbmFtZXMgdGhhdCBhcmUgcmVzZXJ2ZWQgaW4gSmF2YVNjcmlwdCBhbmQgd2lsbCBiZSByZW5hbWVkIHRvIHBiX25hbWUuCiAgICogT3B0aW9uYWwgZmllbGRzIHRoYXQgYXJlIG5vdCBzZXQgd2lsbCBiZSBzZXQgdG8gdW5kZWZpbmVkLgogICAqIFRvIGFjY2VzcyBhIHJlc2VydmVkIGZpZWxkIHVzZSwgZm9vLnBiXzxuYW1lPiwgZWcsIGZvby5wYl9kZWZhdWx0LgogICAqIEZvciB0aGUgbGlzdCBvZiByZXNlcnZlZCBuYW1lcyBwbGVhc2Ugc2VlOgogICAqICAgICBuZXQvcHJvdG8yL2NvbXBpbGVyL2pzL2ludGVybmFsL2dlbmVyYXRvci5jYyNrS2V5d29yZC4KICAgKiBAcGFyYW0ge2Jvb2xlYW49fSBvcHRfaW5jbHVkZUluc3RhbmNlIERlcHJlY2F0ZWQuIHdoZXRoZXIgdG8gaW5jbHVkZSB0aGUKICAgKiAgICAgSlNQQiBpbnN0YW5jZSBmb3IgdHJhbnNpdGlvbmFsIHNveSBwcm90byBzdXBwb3J0OgogICAqICAgICBodHRwOi8vZ290by9zb3ktcGFyYW0tbWlncmF0aW9uCiAgICogQHJldHVybiB7IU9iamVjdH0KICAgKi8KICBwcm90by5wYi5jbXMuU2V0dGxlUHJvZ3Jlc3NSZXBseS5wcm90b3R5cGUudG9PYmplY3QgPSBmdW5jdGlvbiAob3B0X2luY2x1ZGVJbnN0YW5jZSkgewogICAgcmV0dXJuIHByb3RvLnBiLmNtcy5TZXR0bGVQcm9ncmVzc1JlcGx5LnRvT2JqZWN0KG9wdF9pbmNsdWRlSW5zdGFuY2UsIHRoaXMpOwogIH07CiAgLyoqCiAgICogU3RhdGljIHZlcnNpb24gb2YgdGhlIHtAc2VlIHRvT2JqZWN0fSBtZXRob2QuCiAgICogQHBhcmFtIHtib29sZWFufHVuZGVmaW5lZH0gaW5jbHVkZUluc3RhbmNlIERlcHJlY2F0ZWQuIFdoZXRoZXIgdG8gaW5jbHVkZQogICAqICAgICB0aGUgSlNQQiBpbnN0YW5jZSBmb3IgdHJhbnNpdGlvbmFsIHNveSBwcm90byBzdXBwb3J0OgogICAqICAgICBodHRwOi8vZ290by9zb3ktcGFyYW0tbWlncmF0aW9uCiAgICogQHBhcmFtIHshcHJvdG8ucGIuY21zLlNldHRsZVByb2dyZXNzUmVwbHl9IG1zZyBUaGUgbXNnIGluc3RhbmNlIHRvIHRyYW5zZm9ybS4KICAgKiBAcmV0dXJuIHshT2JqZWN0fQogICAqIEBzdXBwcmVzcyB7dW51c2VkTG9jYWxWYXJpYWJsZXN9IGYgaXMgb25seSB1c2VkIGZvciBuZXN0ZWQgbWVzc2FnZXMKICAgKi8KCgogIHByb3RvLnBiLmNtcy5TZXR0bGVQcm9ncmVzc1JlcGx5LnRvT2JqZWN0ID0gZnVuY3Rpb24gKGluY2x1ZGVJbnN0YW5jZSwgbXNnKSB7CiAgICB2YXIgZiwKICAgICAgICBvYmogPSB7CiAgICAgIHByb2dyZXNzOiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdChtc2csIDEsIDApCiAgICB9OwoKICAgIGlmIChpbmNsdWRlSW5zdGFuY2UpIHsKICAgICAgb2JqLiRqc3BiTWVzc2FnZUluc3RhbmNlID0gbXNnOwogICAgfQoKICAgIHJldHVybiBvYmo7CiAgfTsKfQovKioKICogRGVzZXJpYWxpemVzIGJpbmFyeSBkYXRhIChpbiBwcm90b2J1ZiB3aXJlIGZvcm1hdCkuCiAqIEBwYXJhbSB7anNwYi5CeXRlU291cmNlfSBieXRlcyBUaGUgYnl0ZXMgdG8gZGVzZXJpYWxpemUuCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuU2V0dGxlUHJvZ3Jlc3NSZXBseX0KICovCgoKcHJvdG8ucGIuY21zLlNldHRsZVByb2dyZXNzUmVwbHkuZGVzZXJpYWxpemVCaW5hcnkgPSBmdW5jdGlvbiAoYnl0ZXMpIHsKICB2YXIgcmVhZGVyID0gbmV3IGpzcGIuQmluYXJ5UmVhZGVyKGJ5dGVzKTsKICB2YXIgbXNnID0gbmV3IHByb3RvLnBiLmNtcy5TZXR0bGVQcm9ncmVzc1JlcGx5KCk7CiAgcmV0dXJuIHByb3RvLnBiLmNtcy5TZXR0bGVQcm9ncmVzc1JlcGx5LmRlc2VyaWFsaXplQmluYXJ5RnJvbVJlYWRlcihtc2csIHJlYWRlcik7Cn07Ci8qKgogKiBEZXNlcmlhbGl6ZXMgYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUgZm9ybWF0KSBmcm9tIHRoZQogKiBnaXZlbiByZWFkZXIgaW50byB0aGUgZ2l2ZW4gbWVzc2FnZSBvYmplY3QuCiAqIEBwYXJhbSB7IXByb3RvLnBiLmNtcy5TZXR0bGVQcm9ncmVzc1JlcGx5fSBtc2cgVGhlIG1lc3NhZ2Ugb2JqZWN0IHRvIGRlc2VyaWFsaXplIGludG8uCiAqIEBwYXJhbSB7IWpzcGIuQmluYXJ5UmVhZGVyfSByZWFkZXIgVGhlIEJpbmFyeVJlYWRlciB0byB1c2UuCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuU2V0dGxlUHJvZ3Jlc3NSZXBseX0KICovCgoKcHJvdG8ucGIuY21zLlNldHRsZVByb2dyZXNzUmVwbHkuZGVzZXJpYWxpemVCaW5hcnlGcm9tUmVhZGVyID0gZnVuY3Rpb24gKG1zZywgcmVhZGVyKSB7CiAgd2hpbGUgKHJlYWRlci5uZXh0RmllbGQoKSkgewogICAgaWYgKHJlYWRlci5pc0VuZEdyb3VwKCkpIHsKICAgICAgYnJlYWs7CiAgICB9CgogICAgdmFyIGZpZWxkID0gcmVhZGVyLmdldEZpZWxkTnVtYmVyKCk7CgogICAgc3dpdGNoIChmaWVsZCkgewogICAgICBjYXNlIDE6CiAgICAgICAgdmFyIHZhbHVlID0gcmVhZGVyLnJlYWRVaW50MzIoKTsKICAgICAgICBtc2cuc2V0UHJvZ3Jlc3ModmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgZGVmYXVsdDoKICAgICAgICByZWFkZXIuc2tpcEZpZWxkKCk7CiAgICAgICAgYnJlYWs7CiAgICB9CiAgfQoKICByZXR1cm4gbXNnOwp9OwovKioKICogU2VyaWFsaXplcyB0aGUgbWVzc2FnZSB0byBiaW5hcnkgZGF0YSAoaW4gcHJvdG9idWYgd2lyZSBmb3JtYXQpLgogKiBAcmV0dXJuIHshVWludDhBcnJheX0KICovCgoKcHJvdG8ucGIuY21zLlNldHRsZVByb2dyZXNzUmVwbHkucHJvdG90eXBlLnNlcmlhbGl6ZUJpbmFyeSA9IGZ1bmN0aW9uICgpIHsKICB2YXIgd3JpdGVyID0gbmV3IGpzcGIuQmluYXJ5V3JpdGVyKCk7CiAgcHJvdG8ucGIuY21zLlNldHRsZVByb2dyZXNzUmVwbHkuc2VyaWFsaXplQmluYXJ5VG9Xcml0ZXIodGhpcywgd3JpdGVyKTsKICByZXR1cm4gd3JpdGVyLmdldFJlc3VsdEJ1ZmZlcigpOwp9OwovKioKICogU2VyaWFsaXplcyB0aGUgZ2l2ZW4gbWVzc2FnZSB0byBiaW5hcnkgZGF0YSAoaW4gcHJvdG9idWYgd2lyZQogKiBmb3JtYXQpLCB3cml0aW5nIHRvIHRoZSBnaXZlbiBCaW5hcnlXcml0ZXIuCiAqIEBwYXJhbSB7IXByb3RvLnBiLmNtcy5TZXR0bGVQcm9ncmVzc1JlcGx5fSBtZXNzYWdlCiAqIEBwYXJhbSB7IWpzcGIuQmluYXJ5V3JpdGVyfSB3cml0ZXIKICogQHN1cHByZXNzIHt1bnVzZWRMb2NhbFZhcmlhYmxlc30gZiBpcyBvbmx5IHVzZWQgZm9yIG5lc3RlZCBtZXNzYWdlcwogKi8KCgpwcm90by5wYi5jbXMuU2V0dGxlUHJvZ3Jlc3NSZXBseS5zZXJpYWxpemVCaW5hcnlUb1dyaXRlciA9IGZ1bmN0aW9uIChtZXNzYWdlLCB3cml0ZXIpIHsKICB2YXIgZiA9IHVuZGVmaW5lZDsKICBmID0gbWVzc2FnZS5nZXRQcm9ncmVzcygpOwoKICBpZiAoZiAhPT0gMCkgewogICAgd3JpdGVyLndyaXRlVWludDMyKDEsIGYpOwogIH0KfTsKLyoqCiAqIG9wdGlvbmFsIHVpbnQzMiBwcm9ncmVzcyA9IDE7CiAqIEByZXR1cm4ge251bWJlcn0KICovCgoKcHJvdG8ucGIuY21zLlNldHRsZVByb2dyZXNzUmVwbHkucHJvdG90eXBlLmdldFByb2dyZXNzID0gZnVuY3Rpb24gKCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdCh0aGlzLCAxLCAwKTsKfTsKLyoqCiAqIEBwYXJhbSB7bnVtYmVyfSB2YWx1ZQogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLlNldHRsZVByb2dyZXNzUmVwbHl9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuU2V0dGxlUHJvZ3Jlc3NSZXBseS5wcm90b3R5cGUuc2V0UHJvZ3Jlc3MgPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0ludEZpZWxkKHRoaXMsIDEsIHZhbHVlKTsKfTsKCmlmIChqc3BiLk1lc3NhZ2UuR0VORVJBVEVfVE9fT0JKRUNUKSB7CiAgLyoqCiAgICogQ3JlYXRlcyBhbiBvYmplY3QgcmVwcmVzZW50YXRpb24gb2YgdGhpcyBwcm90by4KICAgKiBGaWVsZCBuYW1lcyB0aGF0IGFyZSByZXNlcnZlZCBpbiBKYXZhU2NyaXB0IGFuZCB3aWxsIGJlIHJlbmFtZWQgdG8gcGJfbmFtZS4KICAgKiBPcHRpb25hbCBmaWVsZHMgdGhhdCBhcmUgbm90IHNldCB3aWxsIGJlIHNldCB0byB1bmRlZmluZWQuCiAgICogVG8gYWNjZXNzIGEgcmVzZXJ2ZWQgZmllbGQgdXNlLCBmb28ucGJfPG5hbWU+LCBlZywgZm9vLnBiX2RlZmF1bHQuCiAgICogRm9yIHRoZSBsaXN0IG9mIHJlc2VydmVkIG5hbWVzIHBsZWFzZSBzZWU6CiAgICogICAgIG5ldC9wcm90bzIvY29tcGlsZXIvanMvaW50ZXJuYWwvZ2VuZXJhdG9yLmNjI2tLZXl3b3JkLgogICAqIEBwYXJhbSB7Ym9vbGVhbj19IG9wdF9pbmNsdWRlSW5zdGFuY2UgRGVwcmVjYXRlZC4gd2hldGhlciB0byBpbmNsdWRlIHRoZQogICAqICAgICBKU1BCIGluc3RhbmNlIGZvciB0cmFuc2l0aW9uYWwgc295IHByb3RvIHN1cHBvcnQ6CiAgICogICAgIGh0dHA6Ly9nb3RvL3NveS1wYXJhbS1taWdyYXRpb24KICAgKiBAcmV0dXJuIHshT2JqZWN0fQogICAqLwogIHByb3RvLnBiLmNtcy5TZXR0bGVMaXN0UmVxdWVzdC5wcm90b3R5cGUudG9PYmplY3QgPSBmdW5jdGlvbiAob3B0X2luY2x1ZGVJbnN0YW5jZSkgewogICAgcmV0dXJuIHByb3RvLnBiLmNtcy5TZXR0bGVMaXN0UmVxdWVzdC50b09iamVjdChvcHRfaW5jbHVkZUluc3RhbmNlLCB0aGlzKTsKICB9OwogIC8qKgogICAqIFN0YXRpYyB2ZXJzaW9uIG9mIHRoZSB7QHNlZSB0b09iamVjdH0gbWV0aG9kLgogICAqIEBwYXJhbSB7Ym9vbGVhbnx1bmRlZmluZWR9IGluY2x1ZGVJbnN0YW5jZSBEZXByZWNhdGVkLiBXaGV0aGVyIHRvIGluY2x1ZGUKICAgKiAgICAgdGhlIEpTUEIgaW5zdGFuY2UgZm9yIHRyYW5zaXRpb25hbCBzb3kgcHJvdG8gc3VwcG9ydDoKICAgKiAgICAgaHR0cDovL2dvdG8vc295LXBhcmFtLW1pZ3JhdGlvbgogICAqIEBwYXJhbSB7IXByb3RvLnBiLmNtcy5TZXR0bGVMaXN0UmVxdWVzdH0gbXNnIFRoZSBtc2cgaW5zdGFuY2UgdG8gdHJhbnNmb3JtLgogICAqIEByZXR1cm4geyFPYmplY3R9CiAgICogQHN1cHByZXNzIHt1bnVzZWRMb2NhbFZhcmlhYmxlc30gZiBpcyBvbmx5IHVzZWQgZm9yIG5lc3RlZCBtZXNzYWdlcwogICAqLwoKCiAgcHJvdG8ucGIuY21zLlNldHRsZUxpc3RSZXF1ZXN0LnRvT2JqZWN0ID0gZnVuY3Rpb24gKGluY2x1ZGVJbnN0YW5jZSwgbXNnKSB7CiAgICB2YXIgZiwKICAgICAgICBvYmogPSB7CiAgICAgIGFyZWFJZDoganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQobXNnLCAxLCAwKSwKICAgICAgZ3VpbGRJZDoganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQobXNnLCAyLCAwKSwKICAgICAgYW5jaG9ySWQ6IGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KG1zZywgMywgMCksCiAgICAgIHNldHRsZUF0OiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdChtc2csIDQsIDApLAogICAgICBzdGF0dXM6IGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KG1zZywgNSwgMCkKICAgIH07CgogICAgaWYgKGluY2x1ZGVJbnN0YW5jZSkgewogICAgICBvYmouJGpzcGJNZXNzYWdlSW5zdGFuY2UgPSBtc2c7CiAgICB9CgogICAgcmV0dXJuIG9iajsKICB9Owp9Ci8qKgogKiBEZXNlcmlhbGl6ZXMgYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUgZm9ybWF0KS4KICogQHBhcmFtIHtqc3BiLkJ5dGVTb3VyY2V9IGJ5dGVzIFRoZSBieXRlcyB0byBkZXNlcmlhbGl6ZS4KICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5TZXR0bGVMaXN0UmVxdWVzdH0KICovCgoKcHJvdG8ucGIuY21zLlNldHRsZUxpc3RSZXF1ZXN0LmRlc2VyaWFsaXplQmluYXJ5ID0gZnVuY3Rpb24gKGJ5dGVzKSB7CiAgdmFyIHJlYWRlciA9IG5ldyBqc3BiLkJpbmFyeVJlYWRlcihieXRlcyk7CiAgdmFyIG1zZyA9IG5ldyBwcm90by5wYi5jbXMuU2V0dGxlTGlzdFJlcXVlc3QoKTsKICByZXR1cm4gcHJvdG8ucGIuY21zLlNldHRsZUxpc3RSZXF1ZXN0LmRlc2VyaWFsaXplQmluYXJ5RnJvbVJlYWRlcihtc2csIHJlYWRlcik7Cn07Ci8qKgogKiBEZXNlcmlhbGl6ZXMgYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUgZm9ybWF0KSBmcm9tIHRoZQogKiBnaXZlbiByZWFkZXIgaW50byB0aGUgZ2l2ZW4gbWVzc2FnZSBvYmplY3QuCiAqIEBwYXJhbSB7IXByb3RvLnBiLmNtcy5TZXR0bGVMaXN0UmVxdWVzdH0gbXNnIFRoZSBtZXNzYWdlIG9iamVjdCB0byBkZXNlcmlhbGl6ZSBpbnRvLgogKiBAcGFyYW0geyFqc3BiLkJpbmFyeVJlYWRlcn0gcmVhZGVyIFRoZSBCaW5hcnlSZWFkZXIgdG8gdXNlLgogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLlNldHRsZUxpc3RSZXF1ZXN0fQogKi8KCgpwcm90by5wYi5jbXMuU2V0dGxlTGlzdFJlcXVlc3QuZGVzZXJpYWxpemVCaW5hcnlGcm9tUmVhZGVyID0gZnVuY3Rpb24gKG1zZywgcmVhZGVyKSB7CiAgd2hpbGUgKHJlYWRlci5uZXh0RmllbGQoKSkgewogICAgaWYgKHJlYWRlci5pc0VuZEdyb3VwKCkpIHsKICAgICAgYnJlYWs7CiAgICB9CgogICAgdmFyIGZpZWxkID0gcmVhZGVyLmdldEZpZWxkTnVtYmVyKCk7CgogICAgc3dpdGNoIChmaWVsZCkgewogICAgICBjYXNlIDE6CiAgICAgICAgdmFyIHZhbHVlID0gcmVhZGVyLnJlYWRVaW50MzIoKTsKICAgICAgICBtc2cuc2V0QXJlYUlkKHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgMjoKICAgICAgICB2YXIgdmFsdWUgPSByZWFkZXIucmVhZFVpbnQzMigpOwogICAgICAgIG1zZy5zZXRHdWlsZElkKHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgMzoKICAgICAgICB2YXIgdmFsdWUgPSByZWFkZXIucmVhZFVpbnQzMigpOwogICAgICAgIG1zZy5zZXRBbmNob3JJZCh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlIDQ6CiAgICAgICAgdmFyIHZhbHVlID0gcmVhZGVyLnJlYWRVaW50MzIoKTsKICAgICAgICBtc2cuc2V0U2V0dGxlQXQodmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSA1OgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkRW51bSgpOwogICAgICAgIG1zZy5zZXRTdGF0dXModmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgZGVmYXVsdDoKICAgICAgICByZWFkZXIuc2tpcEZpZWxkKCk7CiAgICAgICAgYnJlYWs7CiAgICB9CiAgfQoKICByZXR1cm4gbXNnOwp9OwovKioKICogU2VyaWFsaXplcyB0aGUgbWVzc2FnZSB0byBiaW5hcnkgZGF0YSAoaW4gcHJvdG9idWYgd2lyZSBmb3JtYXQpLgogKiBAcmV0dXJuIHshVWludDhBcnJheX0KICovCgoKcHJvdG8ucGIuY21zLlNldHRsZUxpc3RSZXF1ZXN0LnByb3RvdHlwZS5zZXJpYWxpemVCaW5hcnkgPSBmdW5jdGlvbiAoKSB7CiAgdmFyIHdyaXRlciA9IG5ldyBqc3BiLkJpbmFyeVdyaXRlcigpOwogIHByb3RvLnBiLmNtcy5TZXR0bGVMaXN0UmVxdWVzdC5zZXJpYWxpemVCaW5hcnlUb1dyaXRlcih0aGlzLCB3cml0ZXIpOwogIHJldHVybiB3cml0ZXIuZ2V0UmVzdWx0QnVmZmVyKCk7Cn07Ci8qKgogKiBTZXJpYWxpemVzIHRoZSBnaXZlbiBtZXNzYWdlIHRvIGJpbmFyeSBkYXRhIChpbiBwcm90b2J1ZiB3aXJlCiAqIGZvcm1hdCksIHdyaXRpbmcgdG8gdGhlIGdpdmVuIEJpbmFyeVdyaXRlci4KICogQHBhcmFtIHshcHJvdG8ucGIuY21zLlNldHRsZUxpc3RSZXF1ZXN0fSBtZXNzYWdlCiAqIEBwYXJhbSB7IWpzcGIuQmluYXJ5V3JpdGVyfSB3cml0ZXIKICogQHN1cHByZXNzIHt1bnVzZWRMb2NhbFZhcmlhYmxlc30gZiBpcyBvbmx5IHVzZWQgZm9yIG5lc3RlZCBtZXNzYWdlcwogKi8KCgpwcm90by5wYi5jbXMuU2V0dGxlTGlzdFJlcXVlc3Quc2VyaWFsaXplQmluYXJ5VG9Xcml0ZXIgPSBmdW5jdGlvbiAobWVzc2FnZSwgd3JpdGVyKSB7CiAgdmFyIGYgPSB1bmRlZmluZWQ7CiAgZiA9IG1lc3NhZ2UuZ2V0QXJlYUlkKCk7CgogIGlmIChmICE9PSAwKSB7CiAgICB3cml0ZXIud3JpdGVVaW50MzIoMSwgZik7CiAgfQoKICBmID0gbWVzc2FnZS5nZXRHdWlsZElkKCk7CgogIGlmIChmICE9PSAwKSB7CiAgICB3cml0ZXIud3JpdGVVaW50MzIoMiwgZik7CiAgfQoKICBmID0gbWVzc2FnZS5nZXRBbmNob3JJZCgpOwoKICBpZiAoZiAhPT0gMCkgewogICAgd3JpdGVyLndyaXRlVWludDMyKDMsIGYpOwogIH0KCiAgZiA9IG1lc3NhZ2UuZ2V0U2V0dGxlQXQoKTsKCiAgaWYgKGYgIT09IDApIHsKICAgIHdyaXRlci53cml0ZVVpbnQzMig0LCBmKTsKICB9CgogIGYgPSBtZXNzYWdlLmdldFN0YXR1cygpOwoKICBpZiAoZiAhPT0gMC4wKSB7CiAgICB3cml0ZXIud3JpdGVFbnVtKDUsIGYpOwogIH0KfTsKLyoqCiAqIG9wdGlvbmFsIHVpbnQzMiBhcmVhX2lkID0gMTsKICogQHJldHVybiB7bnVtYmVyfQogKi8KCgpwcm90by5wYi5jbXMuU2V0dGxlTGlzdFJlcXVlc3QucHJvdG90eXBlLmdldEFyZWFJZCA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQodGhpcywgMSwgMCk7Cn07Ci8qKgogKiBAcGFyYW0ge251bWJlcn0gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5TZXR0bGVMaXN0UmVxdWVzdH0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5TZXR0bGVMaXN0UmVxdWVzdC5wcm90b3R5cGUuc2V0QXJlYUlkID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRQcm90bzNJbnRGaWVsZCh0aGlzLCAxLCB2YWx1ZSk7Cn07Ci8qKgogKiBvcHRpb25hbCB1aW50MzIgZ3VpbGRfaWQgPSAyOwogKiBAcmV0dXJuIHtudW1iZXJ9CiAqLwoKCnByb3RvLnBiLmNtcy5TZXR0bGVMaXN0UmVxdWVzdC5wcm90b3R5cGUuZ2V0R3VpbGRJZCA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQodGhpcywgMiwgMCk7Cn07Ci8qKgogKiBAcGFyYW0ge251bWJlcn0gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5TZXR0bGVMaXN0UmVxdWVzdH0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5TZXR0bGVMaXN0UmVxdWVzdC5wcm90b3R5cGUuc2V0R3VpbGRJZCA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UHJvdG8zSW50RmllbGQodGhpcywgMiwgdmFsdWUpOwp9OwovKioKICogb3B0aW9uYWwgdWludDMyIGFuY2hvcl9pZCA9IDM7CiAqIEByZXR1cm4ge251bWJlcn0KICovCgoKcHJvdG8ucGIuY21zLlNldHRsZUxpc3RSZXF1ZXN0LnByb3RvdHlwZS5nZXRBbmNob3JJZCA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQodGhpcywgMywgMCk7Cn07Ci8qKgogKiBAcGFyYW0ge251bWJlcn0gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5TZXR0bGVMaXN0UmVxdWVzdH0gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5TZXR0bGVMaXN0UmVxdWVzdC5wcm90b3R5cGUuc2V0QW5jaG9ySWQgPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0ludEZpZWxkKHRoaXMsIDMsIHZhbHVlKTsKfTsKLyoqCiAqIG9wdGlvbmFsIHVpbnQzMiBzZXR0bGVfYXQgPSA0OwogKiBAcmV0dXJuIHtudW1iZXJ9CiAqLwoKCnByb3RvLnBiLmNtcy5TZXR0bGVMaXN0UmVxdWVzdC5wcm90b3R5cGUuZ2V0U2V0dGxlQXQgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDQsIDApOwp9OwovKioKICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuU2V0dGxlTGlzdFJlcXVlc3R9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuU2V0dGxlTGlzdFJlcXVlc3QucHJvdG90eXBlLnNldFNldHRsZUF0ID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRQcm90bzNJbnRGaWVsZCh0aGlzLCA0LCB2YWx1ZSk7Cn07Ci8qKgogKiBvcHRpb25hbCBwYi5TZXR0bGVTdGF0dXMgc3RhdHVzID0gNTsKICogQHJldHVybiB7IXByb3RvLnBiLlNldHRsZVN0YXR1c30KICovCgoKcHJvdG8ucGIuY21zLlNldHRsZUxpc3RSZXF1ZXN0LnByb3RvdHlwZS5nZXRTdGF0dXMgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDUsIDApOwp9OwovKioKICogQHBhcmFtIHshcHJvdG8ucGIuU2V0dGxlU3RhdHVzfSB2YWx1ZQogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLlNldHRsZUxpc3RSZXF1ZXN0fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLlNldHRsZUxpc3RSZXF1ZXN0LnByb3RvdHlwZS5zZXRTdGF0dXMgPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0VudW1GaWVsZCh0aGlzLCA1LCB2YWx1ZSk7Cn07Ci8qKgogKiBMaXN0IG9mIHJlcGVhdGVkIGZpZWxkcyB3aXRoaW4gdGhpcyBtZXNzYWdlIHR5cGUuCiAqIEBwcml2YXRlIHshQXJyYXk8bnVtYmVyPn0KICogQGNvbnN0CiAqLwoKCnByb3RvLnBiLmNtcy5TZXR0bGVMaXN0UmVwbHkucmVwZWF0ZWRGaWVsZHNfID0gWzFdOwoKaWYgKGpzcGIuTWVzc2FnZS5HRU5FUkFURV9UT19PQkpFQ1QpIHsKICAvKioKICAgKiBDcmVhdGVzIGFuIG9iamVjdCByZXByZXNlbnRhdGlvbiBvZiB0aGlzIHByb3RvLgogICAqIEZpZWxkIG5hbWVzIHRoYXQgYXJlIHJlc2VydmVkIGluIEphdmFTY3JpcHQgYW5kIHdpbGwgYmUgcmVuYW1lZCB0byBwYl9uYW1lLgogICAqIE9wdGlvbmFsIGZpZWxkcyB0aGF0IGFyZSBub3Qgc2V0IHdpbGwgYmUgc2V0IHRvIHVuZGVmaW5lZC4KICAgKiBUbyBhY2Nlc3MgYSByZXNlcnZlZCBmaWVsZCB1c2UsIGZvby5wYl88bmFtZT4sIGVnLCBmb28ucGJfZGVmYXVsdC4KICAgKiBGb3IgdGhlIGxpc3Qgb2YgcmVzZXJ2ZWQgbmFtZXMgcGxlYXNlIHNlZToKICAgKiAgICAgbmV0L3Byb3RvMi9jb21waWxlci9qcy9pbnRlcm5hbC9nZW5lcmF0b3IuY2Mja0tleXdvcmQuCiAgICogQHBhcmFtIHtib29sZWFuPX0gb3B0X2luY2x1ZGVJbnN0YW5jZSBEZXByZWNhdGVkLiB3aGV0aGVyIHRvIGluY2x1ZGUgdGhlCiAgICogICAgIEpTUEIgaW5zdGFuY2UgZm9yIHRyYW5zaXRpb25hbCBzb3kgcHJvdG8gc3VwcG9ydDoKICAgKiAgICAgaHR0cDovL2dvdG8vc295LXBhcmFtLW1pZ3JhdGlvbgogICAqIEByZXR1cm4geyFPYmplY3R9CiAgICovCiAgcHJvdG8ucGIuY21zLlNldHRsZUxpc3RSZXBseS5wcm90b3R5cGUudG9PYmplY3QgPSBmdW5jdGlvbiAob3B0X2luY2x1ZGVJbnN0YW5jZSkgewogICAgcmV0dXJuIHByb3RvLnBiLmNtcy5TZXR0bGVMaXN0UmVwbHkudG9PYmplY3Qob3B0X2luY2x1ZGVJbnN0YW5jZSwgdGhpcyk7CiAgfTsKICAvKioKICAgKiBTdGF0aWMgdmVyc2lvbiBvZiB0aGUge0BzZWUgdG9PYmplY3R9IG1ldGhvZC4KICAgKiBAcGFyYW0ge2Jvb2xlYW58dW5kZWZpbmVkfSBpbmNsdWRlSW5zdGFuY2UgRGVwcmVjYXRlZC4gV2hldGhlciB0byBpbmNsdWRlCiAgICogICAgIHRoZSBKU1BCIGluc3RhbmNlIGZvciB0cmFuc2l0aW9uYWwgc295IHByb3RvIHN1cHBvcnQ6CiAgICogICAgIGh0dHA6Ly9nb3RvL3NveS1wYXJhbS1taWdyYXRpb24KICAgKiBAcGFyYW0geyFwcm90by5wYi5jbXMuU2V0dGxlTGlzdFJlcGx5fSBtc2cgVGhlIG1zZyBpbnN0YW5jZSB0byB0cmFuc2Zvcm0uCiAgICogQHJldHVybiB7IU9iamVjdH0KICAgKiBAc3VwcHJlc3Mge3VudXNlZExvY2FsVmFyaWFibGVzfSBmIGlzIG9ubHkgdXNlZCBmb3IgbmVzdGVkIG1lc3NhZ2VzCiAgICovCgoKICBwcm90by5wYi5jbXMuU2V0dGxlTGlzdFJlcGx5LnRvT2JqZWN0ID0gZnVuY3Rpb24gKGluY2x1ZGVJbnN0YW5jZSwgbXNnKSB7CiAgICB2YXIgZiwKICAgICAgICBvYmogPSB7CiAgICAgIHJlY29yZHNMaXN0OiBqc3BiLk1lc3NhZ2UudG9PYmplY3RMaXN0KG1zZy5nZXRSZWNvcmRzTGlzdCgpLCBhbmNob3J0eXBlX3BiLlNldHRsZVJlY29yZC50b09iamVjdCwgaW5jbHVkZUluc3RhbmNlKQogICAgfTsKCiAgICBpZiAoaW5jbHVkZUluc3RhbmNlKSB7CiAgICAgIG9iai4kanNwYk1lc3NhZ2VJbnN0YW5jZSA9IG1zZzsKICAgIH0KCiAgICByZXR1cm4gb2JqOwogIH07Cn0KLyoqCiAqIERlc2VyaWFsaXplcyBiaW5hcnkgZGF0YSAoaW4gcHJvdG9idWYgd2lyZSBmb3JtYXQpLgogKiBAcGFyYW0ge2pzcGIuQnl0ZVNvdXJjZX0gYnl0ZXMgVGhlIGJ5dGVzIHRvIGRlc2VyaWFsaXplLgogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLlNldHRsZUxpc3RSZXBseX0KICovCgoKcHJvdG8ucGIuY21zLlNldHRsZUxpc3RSZXBseS5kZXNlcmlhbGl6ZUJpbmFyeSA9IGZ1bmN0aW9uIChieXRlcykgewogIHZhciByZWFkZXIgPSBuZXcganNwYi5CaW5hcnlSZWFkZXIoYnl0ZXMpOwogIHZhciBtc2cgPSBuZXcgcHJvdG8ucGIuY21zLlNldHRsZUxpc3RSZXBseSgpOwogIHJldHVybiBwcm90by5wYi5jbXMuU2V0dGxlTGlzdFJlcGx5LmRlc2VyaWFsaXplQmluYXJ5RnJvbVJlYWRlcihtc2csIHJlYWRlcik7Cn07Ci8qKgogKiBEZXNlcmlhbGl6ZXMgYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUgZm9ybWF0KSBmcm9tIHRoZQogKiBnaXZlbiByZWFkZXIgaW50byB0aGUgZ2l2ZW4gbWVzc2FnZSBvYmplY3QuCiAqIEBwYXJhbSB7IXByb3RvLnBiLmNtcy5TZXR0bGVMaXN0UmVwbHl9IG1zZyBUaGUgbWVzc2FnZSBvYmplY3QgdG8gZGVzZXJpYWxpemUgaW50by4KICogQHBhcmFtIHshanNwYi5CaW5hcnlSZWFkZXJ9IHJlYWRlciBUaGUgQmluYXJ5UmVhZGVyIHRvIHVzZS4KICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5TZXR0bGVMaXN0UmVwbHl9CiAqLwoKCnByb3RvLnBiLmNtcy5TZXR0bGVMaXN0UmVwbHkuZGVzZXJpYWxpemVCaW5hcnlGcm9tUmVhZGVyID0gZnVuY3Rpb24gKG1zZywgcmVhZGVyKSB7CiAgd2hpbGUgKHJlYWRlci5uZXh0RmllbGQoKSkgewogICAgaWYgKHJlYWRlci5pc0VuZEdyb3VwKCkpIHsKICAgICAgYnJlYWs7CiAgICB9CgogICAgdmFyIGZpZWxkID0gcmVhZGVyLmdldEZpZWxkTnVtYmVyKCk7CgogICAgc3dpdGNoIChmaWVsZCkgewogICAgICBjYXNlIDE6CiAgICAgICAgdmFyIHZhbHVlID0gbmV3IGFuY2hvcnR5cGVfcGIuU2V0dGxlUmVjb3JkKCk7CiAgICAgICAgcmVhZGVyLnJlYWRNZXNzYWdlKHZhbHVlLCBhbmNob3J0eXBlX3BiLlNldHRsZVJlY29yZC5kZXNlcmlhbGl6ZUJpbmFyeUZyb21SZWFkZXIpOwogICAgICAgIG1zZy5hZGRSZWNvcmRzKHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGRlZmF1bHQ6CiAgICAgICAgcmVhZGVyLnNraXBGaWVsZCgpOwogICAgICAgIGJyZWFrOwogICAgfQogIH0KCiAgcmV0dXJuIG1zZzsKfTsKLyoqCiAqIFNlcmlhbGl6ZXMgdGhlIG1lc3NhZ2UgdG8gYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUgZm9ybWF0KS4KICogQHJldHVybiB7IVVpbnQ4QXJyYXl9CiAqLwoKCnByb3RvLnBiLmNtcy5TZXR0bGVMaXN0UmVwbHkucHJvdG90eXBlLnNlcmlhbGl6ZUJpbmFyeSA9IGZ1bmN0aW9uICgpIHsKICB2YXIgd3JpdGVyID0gbmV3IGpzcGIuQmluYXJ5V3JpdGVyKCk7CiAgcHJvdG8ucGIuY21zLlNldHRsZUxpc3RSZXBseS5zZXJpYWxpemVCaW5hcnlUb1dyaXRlcih0aGlzLCB3cml0ZXIpOwogIHJldHVybiB3cml0ZXIuZ2V0UmVzdWx0QnVmZmVyKCk7Cn07Ci8qKgogKiBTZXJpYWxpemVzIHRoZSBnaXZlbiBtZXNzYWdlIHRvIGJpbmFyeSBkYXRhIChpbiBwcm90b2J1ZiB3aXJlCiAqIGZvcm1hdCksIHdyaXRpbmcgdG8gdGhlIGdpdmVuIEJpbmFyeVdyaXRlci4KICogQHBhcmFtIHshcHJvdG8ucGIuY21zLlNldHRsZUxpc3RSZXBseX0gbWVzc2FnZQogKiBAcGFyYW0geyFqc3BiLkJpbmFyeVdyaXRlcn0gd3JpdGVyCiAqIEBzdXBwcmVzcyB7dW51c2VkTG9jYWxWYXJpYWJsZXN9IGYgaXMgb25seSB1c2VkIGZvciBuZXN0ZWQgbWVzc2FnZXMKICovCgoKcHJvdG8ucGIuY21zLlNldHRsZUxpc3RSZXBseS5zZXJpYWxpemVCaW5hcnlUb1dyaXRlciA9IGZ1bmN0aW9uIChtZXNzYWdlLCB3cml0ZXIpIHsKICB2YXIgZiA9IHVuZGVmaW5lZDsKICBmID0gbWVzc2FnZS5nZXRSZWNvcmRzTGlzdCgpOwoKICBpZiAoZi5sZW5ndGggPiAwKSB7CiAgICB3cml0ZXIud3JpdGVSZXBlYXRlZE1lc3NhZ2UoMSwgZiwgYW5jaG9ydHlwZV9wYi5TZXR0bGVSZWNvcmQuc2VyaWFsaXplQmluYXJ5VG9Xcml0ZXIpOwogIH0KfTsKLyoqCiAqIHJlcGVhdGVkIHBiLlNldHRsZVJlY29yZCByZWNvcmRzID0gMTsKICogQHJldHVybiB7IUFycmF5PCFwcm90by5wYi5TZXR0bGVSZWNvcmQ+fQogKi8KCgpwcm90by5wYi5jbXMuU2V0dGxlTGlzdFJlcGx5LnByb3RvdHlwZS5nZXRSZWNvcmRzTGlzdCA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldFJlcGVhdGVkV3JhcHBlckZpZWxkKHRoaXMsIGFuY2hvcnR5cGVfcGIuU2V0dGxlUmVjb3JkLCAxKTsKfTsKLyoqCiAqIEBwYXJhbSB7IUFycmF5PCFwcm90by5wYi5TZXR0bGVSZWNvcmQ+fSB2YWx1ZQogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLlNldHRsZUxpc3RSZXBseX0gcmV0dXJucyB0aGlzCiovCgoKcHJvdG8ucGIuY21zLlNldHRsZUxpc3RSZXBseS5wcm90b3R5cGUuc2V0UmVjb3Jkc0xpc3QgPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFJlcGVhdGVkV3JhcHBlckZpZWxkKHRoaXMsIDEsIHZhbHVlKTsKfTsKLyoqCiAqIEBwYXJhbSB7IXByb3RvLnBiLlNldHRsZVJlY29yZD19IG9wdF92YWx1ZQogKiBAcGFyYW0ge251bWJlcj19IG9wdF9pbmRleAogKiBAcmV0dXJuIHshcHJvdG8ucGIuU2V0dGxlUmVjb3JkfQogKi8KCgpwcm90by5wYi5jbXMuU2V0dGxlTGlzdFJlcGx5LnByb3RvdHlwZS5hZGRSZWNvcmRzID0gZnVuY3Rpb24gKG9wdF92YWx1ZSwgb3B0X2luZGV4KSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5hZGRUb1JlcGVhdGVkV3JhcHBlckZpZWxkKHRoaXMsIDEsIG9wdF92YWx1ZSwgcHJvdG8ucGIuU2V0dGxlUmVjb3JkLCBvcHRfaW5kZXgpOwp9OwovKioKICogQ2xlYXJzIHRoZSBsaXN0IG1ha2luZyBpdCBlbXB0eSBidXQgbm9uLW51bGwuCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuU2V0dGxlTGlzdFJlcGx5fSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLlNldHRsZUxpc3RSZXBseS5wcm90b3R5cGUuY2xlYXJSZWNvcmRzTGlzdCA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4gdGhpcy5zZXRSZWNvcmRzTGlzdChbXSk7Cn07CgppZiAoanNwYi5NZXNzYWdlLkdFTkVSQVRFX1RPX09CSkVDVCkgewogIC8qKgogICAqIENyZWF0ZXMgYW4gb2JqZWN0IHJlcHJlc2VudGF0aW9uIG9mIHRoaXMgcHJvdG8uCiAgICogRmllbGQgbmFtZXMgdGhhdCBhcmUgcmVzZXJ2ZWQgaW4gSmF2YVNjcmlwdCBhbmQgd2lsbCBiZSByZW5hbWVkIHRvIHBiX25hbWUuCiAgICogT3B0aW9uYWwgZmllbGRzIHRoYXQgYXJlIG5vdCBzZXQgd2lsbCBiZSBzZXQgdG8gdW5kZWZpbmVkLgogICAqIFRvIGFjY2VzcyBhIHJlc2VydmVkIGZpZWxkIHVzZSwgZm9vLnBiXzxuYW1lPiwgZWcsIGZvby5wYl9kZWZhdWx0LgogICAqIEZvciB0aGUgbGlzdCBvZiByZXNlcnZlZCBuYW1lcyBwbGVhc2Ugc2VlOgogICAqICAgICBuZXQvcHJvdG8yL2NvbXBpbGVyL2pzL2ludGVybmFsL2dlbmVyYXRvci5jYyNrS2V5d29yZC4KICAgKiBAcGFyYW0ge2Jvb2xlYW49fSBvcHRfaW5jbHVkZUluc3RhbmNlIERlcHJlY2F0ZWQuIHdoZXRoZXIgdG8gaW5jbHVkZSB0aGUKICAgKiAgICAgSlNQQiBpbnN0YW5jZSBmb3IgdHJhbnNpdGlvbmFsIHNveSBwcm90byBzdXBwb3J0OgogICAqICAgICBodHRwOi8vZ290by9zb3ktcGFyYW0tbWlncmF0aW9uCiAgICogQHJldHVybiB7IU9iamVjdH0KICAgKi8KICBwcm90by5wYi5jbXMuQWRtaW5GaWxlQ2h1bmsucHJvdG90eXBlLnRvT2JqZWN0ID0gZnVuY3Rpb24gKG9wdF9pbmNsdWRlSW5zdGFuY2UpIHsKICAgIHJldHVybiBwcm90by5wYi5jbXMuQWRtaW5GaWxlQ2h1bmsudG9PYmplY3Qob3B0X2luY2x1ZGVJbnN0YW5jZSwgdGhpcyk7CiAgfTsKICAvKioKICAgKiBTdGF0aWMgdmVyc2lvbiBvZiB0aGUge0BzZWUgdG9PYmplY3R9IG1ldGhvZC4KICAgKiBAcGFyYW0ge2Jvb2xlYW58dW5kZWZpbmVkfSBpbmNsdWRlSW5zdGFuY2UgRGVwcmVjYXRlZC4gV2hldGhlciB0byBpbmNsdWRlCiAgICogICAgIHRoZSBKU1BCIGluc3RhbmNlIGZvciB0cmFuc2l0aW9uYWwgc295IHByb3RvIHN1cHBvcnQ6CiAgICogICAgIGh0dHA6Ly9nb3RvL3NveS1wYXJhbS1taWdyYXRpb24KICAgKiBAcGFyYW0geyFwcm90by5wYi5jbXMuQWRtaW5GaWxlQ2h1bmt9IG1zZyBUaGUgbXNnIGluc3RhbmNlIHRvIHRyYW5zZm9ybS4KICAgKiBAcmV0dXJuIHshT2JqZWN0fQogICAqIEBzdXBwcmVzcyB7dW51c2VkTG9jYWxWYXJpYWJsZXN9IGYgaXMgb25seSB1c2VkIGZvciBuZXN0ZWQgbWVzc2FnZXMKICAgKi8KCgogIHByb3RvLnBiLmNtcy5BZG1pbkZpbGVDaHVuay50b09iamVjdCA9IGZ1bmN0aW9uIChpbmNsdWRlSW5zdGFuY2UsIG1zZykgewogICAgdmFyIGYsCiAgICAgICAgb2JqID0gewogICAgICBvZmZzZXQ6IGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KG1zZywgMSwgMCksCiAgICAgIGZpbGVuYW1lOiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdChtc2csIDIsICIiKSwKICAgICAgdHlwZToganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQobXNnLCAzLCAwKSwKICAgICAgY29udGVudDogbXNnLmdldENvbnRlbnRfYXNCNjQoKSwKICAgICAgYXJlYUlkOiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdChtc2csIDUsIDApCiAgICB9OwoKICAgIGlmIChpbmNsdWRlSW5zdGFuY2UpIHsKICAgICAgb2JqLiRqc3BiTWVzc2FnZUluc3RhbmNlID0gbXNnOwogICAgfQoKICAgIHJldHVybiBvYmo7CiAgfTsKfQovKioKICogRGVzZXJpYWxpemVzIGJpbmFyeSBkYXRhIChpbiBwcm90b2J1ZiB3aXJlIGZvcm1hdCkuCiAqIEBwYXJhbSB7anNwYi5CeXRlU291cmNlfSBieXRlcyBUaGUgYnl0ZXMgdG8gZGVzZXJpYWxpemUuCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuQWRtaW5GaWxlQ2h1bmt9CiAqLwoKCnByb3RvLnBiLmNtcy5BZG1pbkZpbGVDaHVuay5kZXNlcmlhbGl6ZUJpbmFyeSA9IGZ1bmN0aW9uIChieXRlcykgewogIHZhciByZWFkZXIgPSBuZXcganNwYi5CaW5hcnlSZWFkZXIoYnl0ZXMpOwogIHZhciBtc2cgPSBuZXcgcHJvdG8ucGIuY21zLkFkbWluRmlsZUNodW5rKCk7CiAgcmV0dXJuIHByb3RvLnBiLmNtcy5BZG1pbkZpbGVDaHVuay5kZXNlcmlhbGl6ZUJpbmFyeUZyb21SZWFkZXIobXNnLCByZWFkZXIpOwp9OwovKioKICogRGVzZXJpYWxpemVzIGJpbmFyeSBkYXRhIChpbiBwcm90b2J1ZiB3aXJlIGZvcm1hdCkgZnJvbSB0aGUKICogZ2l2ZW4gcmVhZGVyIGludG8gdGhlIGdpdmVuIG1lc3NhZ2Ugb2JqZWN0LgogKiBAcGFyYW0geyFwcm90by5wYi5jbXMuQWRtaW5GaWxlQ2h1bmt9IG1zZyBUaGUgbWVzc2FnZSBvYmplY3QgdG8gZGVzZXJpYWxpemUgaW50by4KICogQHBhcmFtIHshanNwYi5CaW5hcnlSZWFkZXJ9IHJlYWRlciBUaGUgQmluYXJ5UmVhZGVyIHRvIHVzZS4KICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5BZG1pbkZpbGVDaHVua30KICovCgoKcHJvdG8ucGIuY21zLkFkbWluRmlsZUNodW5rLmRlc2VyaWFsaXplQmluYXJ5RnJvbVJlYWRlciA9IGZ1bmN0aW9uIChtc2csIHJlYWRlcikgewogIHdoaWxlIChyZWFkZXIubmV4dEZpZWxkKCkpIHsKICAgIGlmIChyZWFkZXIuaXNFbmRHcm91cCgpKSB7CiAgICAgIGJyZWFrOwogICAgfQoKICAgIHZhciBmaWVsZCA9IHJlYWRlci5nZXRGaWVsZE51bWJlcigpOwoKICAgIHN3aXRjaCAoZmllbGQpIHsKICAgICAgY2FzZSAxOgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkVWludDMyKCk7CiAgICAgICAgbXNnLnNldE9mZnNldCh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlIDI6CiAgICAgICAgdmFyIHZhbHVlID0gcmVhZGVyLnJlYWRTdHJpbmcoKTsKICAgICAgICBtc2cuc2V0RmlsZW5hbWUodmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSAzOgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkRW51bSgpOwogICAgICAgIG1zZy5zZXRUeXBlKHZhbHVlKTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgNDoKICAgICAgICB2YXIgdmFsdWUgPSByZWFkZXIucmVhZEJ5dGVzKCk7CiAgICAgICAgbXNnLnNldENvbnRlbnQodmFsdWUpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSA1OgogICAgICAgIHZhciB2YWx1ZSA9IHJlYWRlci5yZWFkVWludDMyKCk7CiAgICAgICAgbXNnLnNldEFyZWFJZCh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CgogICAgICBkZWZhdWx0OgogICAgICAgIHJlYWRlci5za2lwRmllbGQoKTsKICAgICAgICBicmVhazsKICAgIH0KICB9CgogIHJldHVybiBtc2c7Cn07Ci8qKgogKiBTZXJpYWxpemVzIHRoZSBtZXNzYWdlIHRvIGJpbmFyeSBkYXRhIChpbiBwcm90b2J1ZiB3aXJlIGZvcm1hdCkuCiAqIEByZXR1cm4geyFVaW50OEFycmF5fQogKi8KCgpwcm90by5wYi5jbXMuQWRtaW5GaWxlQ2h1bmsucHJvdG90eXBlLnNlcmlhbGl6ZUJpbmFyeSA9IGZ1bmN0aW9uICgpIHsKICB2YXIgd3JpdGVyID0gbmV3IGpzcGIuQmluYXJ5V3JpdGVyKCk7CiAgcHJvdG8ucGIuY21zLkFkbWluRmlsZUNodW5rLnNlcmlhbGl6ZUJpbmFyeVRvV3JpdGVyKHRoaXMsIHdyaXRlcik7CiAgcmV0dXJuIHdyaXRlci5nZXRSZXN1bHRCdWZmZXIoKTsKfTsKLyoqCiAqIFNlcmlhbGl6ZXMgdGhlIGdpdmVuIG1lc3NhZ2UgdG8gYmluYXJ5IGRhdGEgKGluIHByb3RvYnVmIHdpcmUKICogZm9ybWF0KSwgd3JpdGluZyB0byB0aGUgZ2l2ZW4gQmluYXJ5V3JpdGVyLgogKiBAcGFyYW0geyFwcm90by5wYi5jbXMuQWRtaW5GaWxlQ2h1bmt9IG1lc3NhZ2UKICogQHBhcmFtIHshanNwYi5CaW5hcnlXcml0ZXJ9IHdyaXRlcgogKiBAc3VwcHJlc3Mge3VudXNlZExvY2FsVmFyaWFibGVzfSBmIGlzIG9ubHkgdXNlZCBmb3IgbmVzdGVkIG1lc3NhZ2VzCiAqLwoKCnByb3RvLnBiLmNtcy5BZG1pbkZpbGVDaHVuay5zZXJpYWxpemVCaW5hcnlUb1dyaXRlciA9IGZ1bmN0aW9uIChtZXNzYWdlLCB3cml0ZXIpIHsKICB2YXIgZiA9IHVuZGVmaW5lZDsKICBmID0gbWVzc2FnZS5nZXRPZmZzZXQoKTsKCiAgaWYgKGYgIT09IDApIHsKICAgIHdyaXRlci53cml0ZVVpbnQzMigxLCBmKTsKICB9CgogIGYgPSBtZXNzYWdlLmdldEZpbGVuYW1lKCk7CgogIGlmIChmLmxlbmd0aCA+IDApIHsKICAgIHdyaXRlci53cml0ZVN0cmluZygyLCBmKTsKICB9CgogIGYgPSBtZXNzYWdlLmdldFR5cGUoKTsKCiAgaWYgKGYgIT09IDAuMCkgewogICAgd3JpdGVyLndyaXRlRW51bSgzLCBmKTsKICB9CgogIGYgPSBtZXNzYWdlLmdldENvbnRlbnRfYXNVOCgpOwoKICBpZiAoZi5sZW5ndGggPiAwKSB7CiAgICB3cml0ZXIud3JpdGVCeXRlcyg0LCBmKTsKICB9CgogIGYgPSBtZXNzYWdlLmdldEFyZWFJZCgpOwoKICBpZiAoZiAhPT0gMCkgewogICAgd3JpdGVyLndyaXRlVWludDMyKDUsIGYpOwogIH0KfTsKLyoqCiAqIG9wdGlvbmFsIHVpbnQzMiBvZmZzZXQgPSAxOwogKiBAcmV0dXJuIHtudW1iZXJ9CiAqLwoKCnByb3RvLnBiLmNtcy5BZG1pbkZpbGVDaHVuay5wcm90b3R5cGUuZ2V0T2Zmc2V0ID0gZnVuY3Rpb24gKCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuZ2V0RmllbGRXaXRoRGVmYXVsdCh0aGlzLCAxLCAwKTsKfTsKLyoqCiAqIEBwYXJhbSB7bnVtYmVyfSB2YWx1ZQogKiBAcmV0dXJuIHshcHJvdG8ucGIuY21zLkFkbWluRmlsZUNodW5rfSByZXR1cm5zIHRoaXMKICovCgoKcHJvdG8ucGIuY21zLkFkbWluRmlsZUNodW5rLnByb3RvdHlwZS5zZXRPZmZzZXQgPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0ludEZpZWxkKHRoaXMsIDEsIHZhbHVlKTsKfTsKLyoqCiAqIG9wdGlvbmFsIHN0cmluZyBmaWxlbmFtZSA9IDI7CiAqIEByZXR1cm4ge3N0cmluZ30KICovCgoKcHJvdG8ucGIuY21zLkFkbWluRmlsZUNodW5rLnByb3RvdHlwZS5nZXRGaWxlbmFtZSA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLmdldEZpZWxkV2l0aERlZmF1bHQodGhpcywgMiwgIiIpOwp9OwovKioKICogQHBhcmFtIHtzdHJpbmd9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuQWRtaW5GaWxlQ2h1bmt9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuQWRtaW5GaWxlQ2h1bmsucHJvdG90eXBlLnNldEZpbGVuYW1lID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5zZXRQcm90bzNTdHJpbmdGaWVsZCh0aGlzLCAyLCB2YWx1ZSk7Cn07Ci8qKgogKiBvcHRpb25hbCBwYi5GaWxlVHlwZSB0eXBlID0gMzsKICogQHJldHVybiB7IXByb3RvLnBiLkZpbGVUeXBlfQogKi8KCgpwcm90by5wYi5jbXMuQWRtaW5GaWxlQ2h1bmsucHJvdG90eXBlLmdldFR5cGUgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDMsIDApOwp9OwovKioKICogQHBhcmFtIHshcHJvdG8ucGIuRmlsZVR5cGV9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuQWRtaW5GaWxlQ2h1bmt9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuQWRtaW5GaWxlQ2h1bmsucHJvdG90eXBlLnNldFR5cGUgPSBmdW5jdGlvbiAodmFsdWUpIHsKICByZXR1cm4ganNwYi5NZXNzYWdlLnNldFByb3RvM0VudW1GaWVsZCh0aGlzLCAzLCB2YWx1ZSk7Cn07Ci8qKgogKiBvcHRpb25hbCBieXRlcyBjb250ZW50ID0gNDsKICogQHJldHVybiB7c3RyaW5nfQogKi8KCgpwcm90by5wYi5jbXMuQWRtaW5GaWxlQ2h1bmsucHJvdG90eXBlLmdldENvbnRlbnQgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDQsICIiKTsKfTsKLyoqCiAqIG9wdGlvbmFsIGJ5dGVzIGNvbnRlbnQgPSA0OwogKiBUaGlzIGlzIGEgdHlwZS1jb252ZXJzaW9uIHdyYXBwZXIgYXJvdW5kIGBnZXRDb250ZW50KClgCiAqIEByZXR1cm4ge3N0cmluZ30KICovCgoKcHJvdG8ucGIuY21zLkFkbWluRmlsZUNodW5rLnByb3RvdHlwZS5nZXRDb250ZW50X2FzQjY0ID0gZnVuY3Rpb24gKCkgewogIHJldHVybiBqc3BiLk1lc3NhZ2UuYnl0ZXNBc0I2NCh0aGlzLmdldENvbnRlbnQoKSk7Cn07Ci8qKgogKiBvcHRpb25hbCBieXRlcyBjb250ZW50ID0gNDsKICogTm90ZSB0aGF0IFVpbnQ4QXJyYXkgaXMgbm90IHN1cHBvcnRlZCBvbiBhbGwgYnJvd3NlcnMuCiAqIEBzZWUgaHR0cDovL2Nhbml1c2UuY29tL1VpbnQ4QXJyYXkKICogVGhpcyBpcyBhIHR5cGUtY29udmVyc2lvbiB3cmFwcGVyIGFyb3VuZCBgZ2V0Q29udGVudCgpYAogKiBAcmV0dXJuIHshVWludDhBcnJheX0KICovCgoKcHJvdG8ucGIuY21zLkFkbWluRmlsZUNodW5rLnByb3RvdHlwZS5nZXRDb250ZW50X2FzVTggPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5ieXRlc0FzVTgodGhpcy5nZXRDb250ZW50KCkpOwp9OwovKioKICogQHBhcmFtIHshKHN0cmluZ3xVaW50OEFycmF5KX0gdmFsdWUKICogQHJldHVybiB7IXByb3RvLnBiLmNtcy5BZG1pbkZpbGVDaHVua30gcmV0dXJucyB0aGlzCiAqLwoKCnByb3RvLnBiLmNtcy5BZG1pbkZpbGVDaHVuay5wcm90b3R5cGUuc2V0Q29udGVudCA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UHJvdG8zQnl0ZXNGaWVsZCh0aGlzLCA0LCB2YWx1ZSk7Cn07Ci8qKgogKiBvcHRpb25hbCB1aW50MzIgYXJlYV9pZCA9IDU7CiAqIEByZXR1cm4ge251bWJlcn0KICovCgoKcHJvdG8ucGIuY21zLkFkbWluRmlsZUNodW5rLnByb3RvdHlwZS5nZXRBcmVhSWQgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGpzcGIuTWVzc2FnZS5nZXRGaWVsZFdpdGhEZWZhdWx0KHRoaXMsIDUsIDApOwp9OwovKioKICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlCiAqIEByZXR1cm4geyFwcm90by5wYi5jbXMuQWRtaW5GaWxlQ2h1bmt9IHJldHVybnMgdGhpcwogKi8KCgpwcm90by5wYi5jbXMuQWRtaW5GaWxlQ2h1bmsucHJvdG90eXBlLnNldEFyZWFJZCA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiBqc3BiLk1lc3NhZ2Uuc2V0UHJvdG8zSW50RmllbGQodGhpcywgNSwgdmFsdWUpOwp9OwoKZ29vZy5vYmplY3QuZXh0ZW5kKGV4cG9ydHMsIHByb3RvLnBiLmNtcyk7"},null]}